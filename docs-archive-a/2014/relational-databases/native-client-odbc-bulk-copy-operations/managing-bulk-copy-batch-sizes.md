---
title: Gerenciando tamanhos de lote de cópia em massa | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- SQL Server Native Client ODBC driver, bulk copy
- ODBC, bulk copy operations
- batches [ODBC]
- bulk copy [ODBC], batch sizes
ms.assetid: 4b24139f-788b-45a6-86dc-ae835435d737
author: rothja
ms.author: jroth
ms.openlocfilehash: 1f24ece176cbb834e4162f9e516ff23013fd256a
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87576353"
---
# <a name="managing-bulk-copy-batch-sizes"></a><span data-ttu-id="ca4cd-102">Gerenciando tamanhos de lote para cópia em massa</span><span class="sxs-lookup"><span data-stu-id="ca4cd-102">Managing Bulk Copy Batch Sizes</span></span>
  <span data-ttu-id="ca4cd-103">A principal finalidade de um lote em operações de cópia em massa é definir o escopo de uma transação.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-103">The primary purpose of a batch in bulk copy operations is to define the scope of a transaction.</span></span> <span data-ttu-id="ca4cd-104">Se o tamanho de um lote não for definido, as funções de cópia em massa irão considerar uma cópia em massa inteira como uma única transação.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-104">If a batch size is not set, then bulk copy functions consider an entire bulk copy to be one transaction.</span></span> <span data-ttu-id="ca4cd-105">Se o tamanho do lote for definido, cada lote constituirá uma transação que será confirmada quando o lote terminar.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-105">If a batch size is set, then each batch constitutes a transaction that is committed when the batch finishes.</span></span>  
  
 <span data-ttu-id="ca4cd-106">Se uma cópia em massa for executada sem tamanho de lote especificado e um erro for retornado, a cópia em massa inteira será revertida.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-106">If a bulk copy is performed with no batch size specified and an error is encountered, the entire bulk copy is rolled back.</span></span> <span data-ttu-id="ca4cd-107">A recuperação de uma cópia em massa longa pode levar muito tempo.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-107">The recovery of a long-running bulk copy can take a long time.</span></span> <span data-ttu-id="ca4cd-108">Quando um tamanho de lote é definido, a cópia em massa considera cada lote uma transação e confirma cada lote.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-108">When a batch size is set, bulk copy considers each batch a transaction and commits each batch.</span></span> <span data-ttu-id="ca4cd-109">Se um erro for encontrado, apenas o último lote pendente precisará ser revertido.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-109">If an error is encountered, only the last outstanding batch needs to be rolled back.</span></span>  
  
 <span data-ttu-id="ca4cd-110">O tamanho do lote também pode afetar a sobrecarga de bloqueios.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-110">The batch size can also affect locking overhead.</span></span> <span data-ttu-id="ca4cd-111">Ao executar uma cópia em massa no [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , a dica TABLOCK pode ser especificada usando [bcp_control](../native-client-odbc-extensions-bulk-copy-functions/bcp-control.md) para adquirir um bloqueio de tabela em vez de bloqueios de linha.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-111">When performing a bulk copy against [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], the TABLOCK hint can be specified using [bcp_control](../native-client-odbc-extensions-bulk-copy-functions/bcp-control.md) to acquire a table lock instead of row locks.</span></span> <span data-ttu-id="ca4cd-112">É possível manter um bloqueio de tabela com sobrecarga mínima para uma operação de cópia em massa inteira.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-112">The single table lock can be held with minimal overhead for an entire bulk copy operation.</span></span> <span data-ttu-id="ca4cd-113">Se TABLOCK não for especificada, os bloqueios serão mantidos em filas individuais e a sobrecarga da manutenção de todos os bloqueios durante a cópia em massa poderá prejudicar o desempenho.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-113">If TABLOCK is not specified then locks are held on individual rows and the overhead of maintaining all the locks for the duration of the bulk copy can slow performance.</span></span> <span data-ttu-id="ca4cd-114">Pelo fato de os bloqueios só serem mantidos durante o tempo de uma transação, a especificação do tamanho de um lote trata esse problema gerando periodicamente uma confirmação que libera os bloqueios mantidos.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-114">Because locks are only held for the length of a transaction, specifying a batch size addresses this problem by periodically generating a commit that frees the locks currently held.</span></span>  
  
 <span data-ttu-id="ca4cd-115">O número de linhas que compõem um lote pode ter efeitos significativos no desempenho quando a operação de cópia em massa é feita em um grande número de linhas.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-115">The number of rows making up a batch can have significant performance effects when bulk copying a large number of rows.</span></span> <span data-ttu-id="ca4cd-116">As recomendações de tamanho de lote dependem do tipo de cópia em massa que está sendo executada.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-116">The recommendations for batch size depend on the type of bulk copy being performed.</span></span>  
  
-   <span data-ttu-id="ca4cd-117">Ao fazer uma cópia em massa no [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], especifique a dica de cópia em massa TABLOCK e defina um tamanho de lote grande.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-117">When bulk copying to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], specify the TABLOCK bulk copy hint and set a large batch size.</span></span>  
  
-   <span data-ttu-id="ca4cd-118">Quando TABLOCK não é especificada, limite os tamanhos de lote para menos de 1.000 linhas.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-118">When TABLOCK is not specified, limit batch sizes to less than 1,000 rows.</span></span>  
  
 <span data-ttu-id="ca4cd-119">Ao copiar em massa de um arquivo de dados, o tamanho do lote é especificado chamando **bcp_control** com a opção BCPBATCH antes de chamar [bcp_exec](../native-client-odbc-extensions-bulk-copy-functions/bcp-exec.md).</span><span class="sxs-lookup"><span data-stu-id="ca4cd-119">When bulk copying in from a data file, the batch size is specified by calling **bcp_control** with the BCPBATCH option before calling [bcp_exec](../native-client-odbc-extensions-bulk-copy-functions/bcp-exec.md).</span></span> <span data-ttu-id="ca4cd-120">Ao copiar em massa de variáveis de programa usando [bcp_bind](../native-client-odbc-extensions-bulk-copy-functions/bcp-bind.md) e [bcp_sendrow](../native-client-odbc-extensions-bulk-copy-functions/bcp-sendrow.md), o tamanho do lote é controlado chamando [bcp_batch](../native-client-odbc-extensions-bulk-copy-functions/bcp-batch.md) depois de chamar [bcp_sendrow](../native-client-odbc-extensions-bulk-copy-functions/bcp-sendrow.md) *x* vezes, em que *x* é o número de linhas em um lote.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-120">When bulk copying from program variables using [bcp_bind](../native-client-odbc-extensions-bulk-copy-functions/bcp-bind.md) and [bcp_sendrow](../native-client-odbc-extensions-bulk-copy-functions/bcp-sendrow.md), the batch size is controlled by calling [bcp_batch](../native-client-odbc-extensions-bulk-copy-functions/bcp-batch.md) after calling [bcp_sendrow](../native-client-odbc-extensions-bulk-copy-functions/bcp-sendrow.md) *x* times, where *x* is the number of rows in a batch.</span></span>  
  
 <span data-ttu-id="ca4cd-121">Além de especificar o tamanho de uma transação, os lotes também controlam quando serão enviadas linhas ao servidor através da rede.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-121">In addition to specifying the size of a transaction, batches also affect when rows are sent across the network to the server.</span></span> <span data-ttu-id="ca4cd-122">As funções de cópia em massa normalmente armazenam em cache as linhas de **bcp_sendrow** até que um pacote de rede seja preenchido e, em seguida, envie o pacote completo para o servidor.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-122">Bulk copy functions normally cache the rows from **bcp_sendrow** until a network packet is filled, and then send the full packet to the server.</span></span> <span data-ttu-id="ca4cd-123">Quando um aplicativo chama **bcp_batch**, no entanto, o pacote atual é enviado ao servidor, independentemente de ele ter sido preenchido.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-123">When an application calls **bcp_batch**, however, the current packet is sent to the server regardless of whether it has been filled.</span></span> <span data-ttu-id="ca4cd-124">O uso de um tamanho de lote muito baixo pode prejudicar o desempenho se resultar no envio de muitos pacotes parcialmente preenchidos para o servidor.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-124">Using a very low batch size can slow performance if it results in sending many partially filled packets to the server.</span></span> <span data-ttu-id="ca4cd-125">Por exemplo, chamar **bcp_batch** depois de cada **bcp_sendrow** faz com que cada linha seja enviada em um pacote separado e, a menos que as linhas sejam muito grandes, desperdiça espaço em cada pacote.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-125">For example, calling **bcp_batch** after every **bcp_sendrow** causes each row to be sent in a separate packet and, unless the rows are very large, wastes space in each packet.</span></span> <span data-ttu-id="ca4cd-126">O tamanho padrão dos pacotes de rede para SQL Server é de 4 KB, embora um aplicativo possa alterar o tamanho chamando [SQLSetConnectAttr](../native-client-odbc-api/sqlsetconnectattr.md) especificando o atributo SQL_ATTR_PACKET_SIZE.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-126">The default size of network packets for SQL Server is 4 KB, although an application can change the size by calling [SQLSetConnectAttr](../native-client-odbc-api/sqlsetconnectattr.md) specifying the SQL_ATTR_PACKET_SIZE attribute.</span></span>  
  
 <span data-ttu-id="ca4cd-127">Outro efeito colateral dos lotes é que cada lote é considerado um conjunto de resultados pendentes até que seja concluído com **bcp_batch**.</span><span class="sxs-lookup"><span data-stu-id="ca4cd-127">Another side effect of batches is that each batch is considered an outstanding result set until it is completed with **bcp_batch**.</span></span> <span data-ttu-id="ca4cd-128">Se qualquer outra operação for tentada em um identificador de conexão enquanto um lote estiver pendente, o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] driver ODBC do Native Client emitirá um erro com SQLSTATE = "HY000" e uma cadeia de caracteres de mensagem de erro:</span><span class="sxs-lookup"><span data-stu-id="ca4cd-128">If any other operations are attempted on a connection handle while a batch is outstanding, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client ODBC driver issues an error with SQLState = "HY000" and an error message string of:</span></span>  
  
```  
"[Microsoft][SQL Server Native Client] Connection is busy with  
results for another hstmt."  
```  
  
## <a name="see-also"></a><span data-ttu-id="ca4cd-129">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="ca4cd-129">See Also</span></span>  
 <span data-ttu-id="ca4cd-130">[Executando operações de cópia em massa &#40;&#41;ODBC](performing-bulk-copy-operations-odbc.md) </span><span class="sxs-lookup"><span data-stu-id="ca4cd-130">[Performing Bulk Copy Operations &#40;ODBC&#41;](performing-bulk-copy-operations-odbc.md) </span></span>  
 [<span data-ttu-id="ca4cd-131">Importação e exportação em massa de dados &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="ca4cd-131">Bulk Import and Export of Data &#40;SQL Server&#41;</span></span>](../import-export/bulk-import-and-export-of-data-sql-server.md)  
  
  
