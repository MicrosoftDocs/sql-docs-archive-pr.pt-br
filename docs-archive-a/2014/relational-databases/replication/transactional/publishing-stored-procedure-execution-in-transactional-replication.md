---
title: Publicando a execução de procedimento armazenado na replicação transacional | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- publishing [SQL Server replication], stored procedure execution
- articles [SQL Server replication], stored procedures and
- transactional replication, publishing stored procedure execution
ms.assetid: f4686f6f-c224-4f07-a7cb-92f4dd483158
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 0fb5c40db46772cabcb5d1df19e03aced749e1c6
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87684149"
---
# <a name="publishing-stored-procedure-execution-in-transactional-replication"></a><span data-ttu-id="7b60c-102">Publicando execução de procedimento armazenado em replicação transacional</span><span class="sxs-lookup"><span data-stu-id="7b60c-102">Publishing Stored Procedure Execution in Transactional Replication</span></span>
  <span data-ttu-id="7b60c-103">Caso haja um ou mais procedimentos armazenados executados no Publicador e que afetem as tabelas publicadas, considere excluir esses procedimentos armazenados na publicação como artigos de execução de procedimentos armazenados.</span><span class="sxs-lookup"><span data-stu-id="7b60c-103">If you have one or more stored procedures that execute at the Publisher and affect published tables, consider including those stored procedures in your publication as stored procedure execution articles.</span></span> <span data-ttu-id="7b60c-104">A definição do procedimento (instrução CREATE PROCEDURE) será replicada para o Assinante quando a inscrição for inicializada. Quando o procedimento armazenado for executado no Publicador, a replicação executará o procedimento correspondente no Assinante.</span><span class="sxs-lookup"><span data-stu-id="7b60c-104">The definition of the procedure (the CREATE PROCEDURE statement) is replicated to the Subscriber when the subscription is initialized; when the procedure is executed at the Publisher, replication executes the corresponding procedure at the Subscriber.</span></span> <span data-ttu-id="7b60c-105">Isso pode fornecer um desempenho significativamente melhor nos casos em que são executadas grandes operações em lote, pois apenas a execução do procedimento é replicada, ignorando-se a necessidade de replicar as alterações individuais de cada linha.</span><span class="sxs-lookup"><span data-stu-id="7b60c-105">This can provide significantly better performance for cases where large batch operations are performed, because only the procedure execution is replicated, bypassing the need to replicate the individual changes for each row.</span></span> <span data-ttu-id="7b60c-106">Por exemplo, supondo que o procedimento armazenado a seguir seja criado no banco de dados de publicação:</span><span class="sxs-lookup"><span data-stu-id="7b60c-106">For example, assume you create the following stored procedure in the publication database:</span></span>  
  
```  
CREATE PROC give_raise AS  
UPDATE EMPLOYEES SET salary = salary * 1.10  
```  
  
 <span data-ttu-id="7b60c-107">Esse procedimento dá a cada um dos 10.000 funcionários da empresa um aumento salarial de 10 por cento.</span><span class="sxs-lookup"><span data-stu-id="7b60c-107">This procedure gives each of the 10,000 employees in your company a 10 percent pay increase.</span></span> <span data-ttu-id="7b60c-108">Quando executado no Publicador, esse procedimento armazenado atualiza o salário de todos os funcionários.</span><span class="sxs-lookup"><span data-stu-id="7b60c-108">When you execute this stored procedure at the Publisher, it updates the salary for each employee.</span></span> <span data-ttu-id="7b60c-109">Sem a replicação de execução de procedimento armazenado, a atualização seria enviada aos Assinantes como uma transação extensa e de várias etapas:</span><span class="sxs-lookup"><span data-stu-id="7b60c-109">Without the replication of stored procedure execution, the update would be sent to Subscribers as a large, multi-step transaction:</span></span>  
  
```  
BEGIN TRAN  
UPDATE EMPLOYEES SET salary = salary * 1.10 WHERE PK = 'emp 1'  
UPDATE EMPLOYEES SET salary = salary * 1.10 WHERE PK = 'emp 2'  
```  
  
 <span data-ttu-id="7b60c-110">E isto se repetiria em 10.000 atualizações.</span><span class="sxs-lookup"><span data-stu-id="7b60c-110">And this repeats for 10,000 updates.</span></span>  
  
 <span data-ttu-id="7b60c-111">Com a execução de procedimento armazenado, a replicação envia apenas o comando para execução do procedimento armazenado do Assinante, em vez de gravar todas as atualizações no banco de dados de distribuição, enviando-as em seguida ao Assinante, pela rede:</span><span class="sxs-lookup"><span data-stu-id="7b60c-111">With the replication of stored procedure execution, replication sends only the command to execute the stored procedure at the Subscriber, rather than writing all the updates to the distribution database and then sending them over the network to the Subscriber:</span></span>  
  
```  
EXEC give_raise  
```  
  
> [!IMPORTANT]  
>  <span data-ttu-id="7b60c-112">A replicação de procedimento armazenado não é apropriada para todos os aplicativos.</span><span class="sxs-lookup"><span data-stu-id="7b60c-112">Stored procedure replication is not appropriate for all applications.</span></span> <span data-ttu-id="7b60c-113">Se um artigo for filtrado horizontalmente, de modo que os conjuntos de linhas do Publicador sejam diferentes do Assinante, a execução do mesmo procedimento armazenado em ambos retornará diferentes resultados.</span><span class="sxs-lookup"><span data-stu-id="7b60c-113">If an article is filtered horizontally, so that there are different sets of rows at the Publisher than at the Subscriber, executing the same stored procedure at both returns different results.</span></span> <span data-ttu-id="7b60c-114">De forma similar, quando uma atualização é baseada em uma subconsulta de outra tabela não replicada, a execução do mesmo procedimento armazenado no Publicador e no Assinante retornará diferentes resultados.</span><span class="sxs-lookup"><span data-stu-id="7b60c-114">Similarly, if an update is based on a subquery of another, nonreplicated table, executing the same stored procedure at both the Publisher and Subscriber returns different results.</span></span>  
  
 <span data-ttu-id="7b60c-115">**Para publicar a execução de um procedimento armazenado**</span><span class="sxs-lookup"><span data-stu-id="7b60c-115">**To publish the execution of a stored procedure**</span></span>  
  
-   <span data-ttu-id="7b60c-116">SQL Server Management Studio: [Publicar a execução de um procedimento armazenado em uma publicação transacional &#40;SQL Server Management Studio&#41;](../publish/publish-execution-of-stored-procedure-in-transactional-publication.md)</span><span class="sxs-lookup"><span data-stu-id="7b60c-116">SQL Server Management Studio: [Publish the Execution of a Stored Procedure in a Transactional Publication &#40;SQL Server Management Studio&#41;](../publish/publish-execution-of-stored-procedure-in-transactional-publication.md)</span></span>  
  
-   <span data-ttu-id="7b60c-117">Programação Transact-SQL de replicação: execute [sp_addarticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql) e especifique o valor “serializable proc exec” (recomendado) ou “proc exec” para o parâmetro **@type**.</span><span class="sxs-lookup"><span data-stu-id="7b60c-117">Replication Transact-SQL Programming: execute [sp_addarticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql) and specify a value of 'serializable proc exec' (recommended) or 'proc exec' for the parameter **@type**.</span></span> <span data-ttu-id="7b60c-118">Para obter mais informações sobre como definir artigos, consulte [Definir um artigo](../publish/define-an-article.md).</span><span class="sxs-lookup"><span data-stu-id="7b60c-118">For more information about defining articles, see [Define an Article](../publish/define-an-article.md).</span></span>  
  
## <a name="modifying-the-procedure-at-the-subscriber"></a><span data-ttu-id="7b60c-119">Modificando o procedimento no Assinante</span><span class="sxs-lookup"><span data-stu-id="7b60c-119">Modifying the Procedure at the Subscriber</span></span>  
 <span data-ttu-id="7b60c-120">Por padrão, a definição de procedimento armazenado no Publicador é propagada para todos os Assinantes.</span><span class="sxs-lookup"><span data-stu-id="7b60c-120">By default, the stored procedure definition at the Publisher is propagated to each Subscriber.</span></span> <span data-ttu-id="7b60c-121">Porém, é igualmente possível modificar o procedimento armazenado no Assinante.</span><span class="sxs-lookup"><span data-stu-id="7b60c-121">However, you can also modify the stored procedure at the Subscriber.</span></span> <span data-ttu-id="7b60c-122">Isso será útil para executar lógicas diferentes no Publicador e no Assinante.</span><span class="sxs-lookup"><span data-stu-id="7b60c-122">This is useful if you want different logic to be executed at the Publisher and Subscriber.</span></span> <span data-ttu-id="7b60c-123">Por exemplo, considere **sp_big_delete**, um procedimento armazenado do Publicador que tem duas funções: exclui 1.000.000 linhas da tabela replicada **big_table1** e atualiza a tabela não replicada **big_table2**.</span><span class="sxs-lookup"><span data-stu-id="7b60c-123">For example, consider **sp_big_delete**, a stored procedure at the Publisher that has two functions: it deletes 1,000,000 rows from the replicated table **big_table1** and updates the nonreplicated table **big_table2**.</span></span> <span data-ttu-id="7b60c-124">Para reduzir a demanda por recursos de rede, propague a exclusão de 1 milhão de linhas como procedimento armazenado publicando **sp_big_delete**.</span><span class="sxs-lookup"><span data-stu-id="7b60c-124">To reduce the demand on network resources, you should propagate the 1 million row delete as a stored procedure by publishing **sp_big_delete**.</span></span> <span data-ttu-id="7b60c-125">No Assinante, modifique **sp_big_delete** para excluir apenas o 1 milhão de linhas e não realizar a atualização subsequente em **big_table2**.</span><span class="sxs-lookup"><span data-stu-id="7b60c-125">At the Subscriber, you can modify **sp_big_delete** to delete only the 1 million rows and not perform the subsequent update to **big_table2**.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7b60c-126">Por padrão, todas as alterações feitas com ALTER PROCEDURE, no Publicador, são propagadas para o Assinante.</span><span class="sxs-lookup"><span data-stu-id="7b60c-126">By default, any changes made using ALTER PROCEDURE at the Publisher are propagated to the Subscriber.</span></span> <span data-ttu-id="7b60c-127">Para impedir isso, desative a propagação de alterações de esquema antes de executar ALTER PROCEDURE.</span><span class="sxs-lookup"><span data-stu-id="7b60c-127">To prevent this, disable the propagation of schema changes before executing ALTER PROCEDURE.</span></span> <span data-ttu-id="7b60c-128">Para obter informações sobre alterações de esquema, consulte [Fazer alterações de esquema em bancos de dados de publicação](../publish/make-schema-changes-on-publication-databases.md).</span><span class="sxs-lookup"><span data-stu-id="7b60c-128">For information about schema changes, see [Make Schema Changes on Publication Databases](../publish/make-schema-changes-on-publication-databases.md).</span></span>  
  
## <a name="types-of-stored-procedure-execution-articles"></a><span data-ttu-id="7b60c-129">Tipos de artigos de execução de procedimento armazenado</span><span class="sxs-lookup"><span data-stu-id="7b60c-129">Types of Stored Procedure Execution Articles</span></span>  
 <span data-ttu-id="7b60c-130">Há duas formas diferentes pelas quais a execução de um procedimento armazenado pode ser publicada: artigo de execução de procedimento serializável e artigo de execução de procedimento.</span><span class="sxs-lookup"><span data-stu-id="7b60c-130">There are two different ways in which the execution of a stored procedure can be published: serializable procedure execution article and procedure execution article.</span></span>  
  
-   <span data-ttu-id="7b60c-131">A opção serializável é recomendada uma vez que ela replica a execução do procedimento apenas se o procedimento for executado no contexto de uma transação serializável.</span><span class="sxs-lookup"><span data-stu-id="7b60c-131">The serializable option is recommended because it replicates the procedure execution only if the procedure is executed within the context of a serializable transaction.</span></span> <span data-ttu-id="7b60c-132">Se o procedimento armazenado for executado fora de uma transação serializável, as alterações dos dados nas tabelas publicadas serão replicadas como uma série de instruções DML.</span><span class="sxs-lookup"><span data-stu-id="7b60c-132">If the stored procedure is executed from outside a serializable transaction, changes to data in published tables are replicated as a series of DML statements.</span></span> <span data-ttu-id="7b60c-133">Esse comportamento contribui para tornar os dados do Assinante consistentes com os dados do Publicador.</span><span class="sxs-lookup"><span data-stu-id="7b60c-133">This behavior contributes to making data at the Subscriber consistent with data at the Publisher.</span></span> <span data-ttu-id="7b60c-134">Isso é especialmente útil para operações em lote, como grandes operações de limpeza.</span><span class="sxs-lookup"><span data-stu-id="7b60c-134">This is especially useful for batch operations, such as large cleanup operations.</span></span>  
  
-   <span data-ttu-id="7b60c-135">Com a opção de execução de procedimento, é possível que a execução seja replicada para todos os Assinantes, quer as instruções individuais no procedimento armazenado tenham sido bem-sucedidas ou não.</span><span class="sxs-lookup"><span data-stu-id="7b60c-135">With the procedure execution option, it is possible that execution could be replicated to all Subscribers regardless of whether individual statements in the stored procedure were successful.</span></span> <span data-ttu-id="7b60c-136">Acima de tudo, como é possível que as alterações feitas nos dados pelo procedimento armazenado ocorram em várias transações, talvez os dados dos Assinantes não estejam consistentes com os dados do Publicador.</span><span class="sxs-lookup"><span data-stu-id="7b60c-136">Furthermore, because changes made to data by the stored procedure can occur within multiple transactions, data at the Subscribers might not be consistent with data at the Publisher.</span></span> <span data-ttu-id="7b60c-137">Para resolver esses problemas, é necessário que os Assinantes sejam somente leitura e que você use um nível de isolamento superior ao de leitura não confirmado.</span><span class="sxs-lookup"><span data-stu-id="7b60c-137">To address these issues, it is required that Subscribers are read-only and that you use an isolation level greater than read uncommitted.</span></span> <span data-ttu-id="7b60c-138">Se você usar a leitura não confirmada, as alterações aos dados em tabelas publicadas serão replicadas como uma série de instruções DML.</span><span class="sxs-lookup"><span data-stu-id="7b60c-138">If you use read uncommitted, changes to data in published tables are replicated as a series of DML statements.</span></span>  
  
 <span data-ttu-id="7b60c-139">O exemplo a seguir ilustra por que é recomendado definir a replicação de procedimentos como artigos de procedimento serializáveis.</span><span class="sxs-lookup"><span data-stu-id="7b60c-139">The following example illustrates why it is recommended that you set up replication of procedures as serializable procedure articles.</span></span>  
  
```  
BEGIN TRANSACTION T1  
SELECT @var = max(col1) FROM tableA  
UPDATE tableA SET col2 = <value>   
   WHERE col1 = @var   
  
BEGIN TRANSACTION T2  
INSERT tableA VALUES <values>  
COMMIT TRANSACTION T2  
```  
  
 <span data-ttu-id="7b60c-140">No exemplo anterior, supôs-se que SELECT na transação T1 ocorre antes de INSERT na transação T2.</span><span class="sxs-lookup"><span data-stu-id="7b60c-140">In the previous example, it is assumed that the SELECT in transaction T1 happens before the INSERT in transaction T2.</span></span>  
  
 <span data-ttu-id="7b60c-141">Se o procedimento não for executado na transação serializável (com o nível de isolamento definido como SERIALIZABLE), a transação T2 não terá permissão para inserir uma nova linha no intervalo da instrução SELECT em T1 e será confirmada antes de T1.</span><span class="sxs-lookup"><span data-stu-id="7b60c-141">If the procedure is not executed within a serializable transaction (with isolation level set to SERIALIZABLE), transaction T2 will be allowed to insert a new row within the range of the SELECT statement in T1 and it will commit before T1.</span></span> <span data-ttu-id="7b60c-142">Isto também significa que ela será aplicada ao Assinante antes de T1.</span><span class="sxs-lookup"><span data-stu-id="7b60c-142">This also means that it will be applied at the Subscriber before T1.</span></span> <span data-ttu-id="7b60c-143">Quando T1 é aplicada ao Assinante, SELECT pode retornar potencialmente um valor diferente do valor do Publicador e poderá ser convertido em um resultado diferente de UPDATE.</span><span class="sxs-lookup"><span data-stu-id="7b60c-143">When T1 is applied at the Subscriber, the SELECT can potentially return a different value than at the Publisher and can result in a different outcome from the UPDATE.</span></span>  
  
 <span data-ttu-id="7b60c-144">Se o procedimento for executado em uma transação serializável, a transação T2 não terá permissão para ser inserida no intervalo coberto pela instrução SELECT em T2.</span><span class="sxs-lookup"><span data-stu-id="7b60c-144">If the procedure is executed within a serializable transaction, transaction T2 will not be allowed to insert within the range covered by the SELECT statement in T2.</span></span> <span data-ttu-id="7b60c-145">Ele será bloqueado até que T1 seja confirmada, assegurando os mesmos resultados no Assinante.</span><span class="sxs-lookup"><span data-stu-id="7b60c-145">It will be blocked until T1 commits ensuring the same results at the Subscriber.</span></span>  
  
 <span data-ttu-id="7b60c-146">Os bloqueios serão mantidos por mais tempo quando esse procedimento for executado em uma transação serializável e poderá resultar em redução de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="7b60c-146">Locks will be held longer when you execute the procedure within a serializable transaction and may result in reduced concurrency.</span></span>  
  
## <a name="the-xact_abort-setting"></a><span data-ttu-id="7b60c-147">A configuração XACT_ABORT</span><span class="sxs-lookup"><span data-stu-id="7b60c-147">The XACT_ABORT Setting</span></span>  
 <span data-ttu-id="7b60c-148">Ao replicar a execução de procedimento armazenado, a configuração da sessão que executa o procedimento armazenado deve especificar XACT_ABORT ON.</span><span class="sxs-lookup"><span data-stu-id="7b60c-148">When replicating stored procedure execution, the setting for the session executing the stored procedure should specify XACT_ABORT ON.</span></span> <span data-ttu-id="7b60c-149">Se XACT_ABORT estiver definida como OFF e ocorrer um erro na execução do procedimento, no Publicador, o mesmo erro ocorrerá no Assinante, causando falha do Agente de Distribuição.</span><span class="sxs-lookup"><span data-stu-id="7b60c-149">If XACT_ABORT is set to OFF, and an error occurs during execution of the procedure at the Publisher, the same error will occur at the Subscriber, causing the Distribution Agent to fail.</span></span> <span data-ttu-id="7b60c-150">Especificar XACT_ABORT ON assegura que nenhum erro encontrado durante a execução, no Publicador, cause a reversão total da execução, evitando falha do Agente de Distribuição.</span><span class="sxs-lookup"><span data-stu-id="7b60c-150">Specifying XACT_ABORT ON ensures that any errors encountered during execution at the Publisher cause the entire execution to be rolled back, avoiding the Distribution Agent failure.</span></span> <span data-ttu-id="7b60c-151">Para obter mais informações sobre como configurar XACT_ABORT, consulte [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="7b60c-151">For more information about setting XACT_ABORT, see [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span></span>  
  
 <span data-ttu-id="7b60c-152">Se a configuração de XACT_ABORT OFF for necessária, especifique o parâmetro **-SkipErrors** do Agente de Distribuição.</span><span class="sxs-lookup"><span data-stu-id="7b60c-152">If you require a setting of XACT_ABORT OFF, specify the **-SkipErrors** parameter for the Distribution Agent.</span></span> <span data-ttu-id="7b60c-153">Isto permitirá que o agente continue a aplicar alterações no Assinante, ainda que um erro seja encontrado.</span><span class="sxs-lookup"><span data-stu-id="7b60c-153">This allows the agent to continue applying changes at the Subscriber even if an error is encountered.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="7b60c-154">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="7b60c-154">See Also</span></span>  
 [<span data-ttu-id="7b60c-155">Article Options for Transactional Replication</span><span class="sxs-lookup"><span data-stu-id="7b60c-155">Article Options for Transactional Replication</span></span>](article-options-for-transactional-replication.md)  
  
  
