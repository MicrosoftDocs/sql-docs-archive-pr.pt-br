---
title: Práticas recomendadas para filtros de linha com base em hora | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- best practices
ms.assetid: 773c5c62-fd44-44ab-9c6b-4257dbf8ffdb
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: ccaafe71d4137fd4b31eec412c1e35595861bdd0
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87568506"
---
# <a name="best-practices-for-time-based-row-filters"></a><span data-ttu-id="45827-102">Práticas recomendadas para filtros de linha baseados em tempo</span><span class="sxs-lookup"><span data-stu-id="45827-102">Best Practices for Time-Based Row Filters</span></span>
  <span data-ttu-id="45827-103">Usuários de aplicativos requerem frequentemente um subconjunto de dados baseados no tempo de uma tabela.</span><span class="sxs-lookup"><span data-stu-id="45827-103">Users of applications often require a time-based subset of data from a table.</span></span> <span data-ttu-id="45827-104">Por exemplo, um vendedor pode requisitar dados de pedidos da semana passada ou um organizador de eventos pode requisitar dados para os eventos da semana seguinte.</span><span class="sxs-lookup"><span data-stu-id="45827-104">For instance, a salesperson might require data for orders in the last week, or an event planner might require data for events in the upcoming week.</span></span> <span data-ttu-id="45827-105">Em muitos casos, os aplicativos usam consultas que contêm a função `GETDATE()` para realizar isso.</span><span class="sxs-lookup"><span data-stu-id="45827-105">In many cases, applications use queries containing the `GETDATE()` function to accomplish this.</span></span> <span data-ttu-id="45827-106">Considere a seguinte instrução de filtro de linha:</span><span class="sxs-lookup"><span data-stu-id="45827-106">Consider the following row filter statement:</span></span>  
  
```  
WHERE SalesPersonID = CONVERT(INT,HOST_NAME()) AND OrderDate >= (GETDATE()-6)  
```  
  
 <span data-ttu-id="45827-107">Com um filtro desse tipo, é normalmente presumido que duas coisas sempre ocorram quando o Merge Agent é executado: as linhas que satisfazem esse filtro são replicadas aos Assinantes; e linhas que não mais satisfazem esse filtro, são limpas nos Assinantes.</span><span class="sxs-lookup"><span data-stu-id="45827-107">With a filter of this type, it is usually assumed that two things always occur when the Merge Agent runs: rows that satisfy this filter are replicated to Subscribers; and rows that no longer satisfy this filter are cleaned up at Subscribers.</span></span> <span data-ttu-id="45827-108">(Para obter mais informações sobre filtragem com o `HOST_NAME()` , consulte [filtros de linha com parâmetros](parameterized-filters-parameterized-row-filters.md).) No entanto, a replicação de mesclagem só Replica e limpa os dados que foram alterados desde a última sincronização, independentemente de como você define um filtro de linha para esses dados.</span><span class="sxs-lookup"><span data-stu-id="45827-108">(For more information about filtering with `HOST_NAME()`, see [Parameterized Row Filters](parameterized-filters-parameterized-row-filters.md).) However, merge replication only replicates and cleans up data that has changed since the last synchronization, regardless of how you define a row filter for that data.</span></span>  
  
 <span data-ttu-id="45827-109">Para a replicação de mesclagem processar uma linha, os dados na linha devem satisfazer o filtro de linha e devem ter sido alterados desde a última sincronização.</span><span class="sxs-lookup"><span data-stu-id="45827-109">For merge replication to process a row, the data in the row must satisfy the row filter, and it must have changed since the last synchronization.</span></span> <span data-ttu-id="45827-110">No caso da tabela **SalesOrderHeader** , é inserido **OrderDate** quando uma linha é inserida.</span><span class="sxs-lookup"><span data-stu-id="45827-110">In the case of the **SalesOrderHeader** table, **OrderDate** is entered when a row is inserted.</span></span> <span data-ttu-id="45827-111">As linhas são replicadas ao Assinante como esperado porque a inserção é uma alteração de dados.</span><span class="sxs-lookup"><span data-stu-id="45827-111">Rows are replicated to the Subscriber as expected because the insert is a data change.</span></span> <span data-ttu-id="45827-112">Entretanto, se houver linhas no Assinante que não mais satisfazem o filtro (são para pedidos anteriores a sete dias), elas não serão removidas do Assinante a menos que tenham sido atualizadas por algum outro motivo.</span><span class="sxs-lookup"><span data-stu-id="45827-112">However, if there are rows at the Subscriber that no longer satisfy the filter (they are for orders older than seven days), they are not removed from the Subscriber unless they were updated for some other reason.</span></span>  
  
 <span data-ttu-id="45827-113">O caso do organizador de eventos destaca mais o assunto com este tipo de filtragem.</span><span class="sxs-lookup"><span data-stu-id="45827-113">The case of the event planner further highlights the issue with this type of filtering.</span></span> <span data-ttu-id="45827-114">Considere o seguinte filtro para uma tabela **Eventos** :</span><span class="sxs-lookup"><span data-stu-id="45827-114">Consider the following filter for an **Events** table:</span></span>  
  
```  
WHERE EventCoordID = CONVERT(INT,HOST_NAME()) AND EventDate <= (GETDATE()+6)  
```  
  
 <span data-ttu-id="45827-115">Para uma tabela que contém eventos, inserções poderiam ser feitas bem antes da data de evento.</span><span class="sxs-lookup"><span data-stu-id="45827-115">For a table that contains events, inserts might be made well ahead of the event date.</span></span> <span data-ttu-id="45827-116">Se uma inserção para um evento na próxima semana foi feita um mês atrás e a linha não foi atualizada por algum outro motivo, a linha não será replicada ao Assinante mesmo se satisfizer o filtro de linha.</span><span class="sxs-lookup"><span data-stu-id="45827-116">If the insert for an event in the coming week was made a month ago and the row was not updated for another reason, the row is not replicated to the Subscriber even if it satisfies the row filter.</span></span>  
  
 <span data-ttu-id="45827-117">Além disso, dependendo de como a publicação é configurada, a replicação de mesclagem avalia filtros em momentos diferentes:</span><span class="sxs-lookup"><span data-stu-id="45827-117">In addition, depending on how the publication is configured, merge replication evaluates filters at different times:</span></span>  
  
-   <span data-ttu-id="45827-118">Se uma publicação usar partições pré-computadas (o padrão), os filtros serão avaliados quando uma linha for inserida ou atualizada.</span><span class="sxs-lookup"><span data-stu-id="45827-118">If a publication uses precomputed partitions (the default), filters are evaluated when a row is inserted or updated.</span></span>  
  
-   <span data-ttu-id="45827-119">Se a publicação não usar partições pré-computadas, os filtros serão avaliados quando o Merge Agent for executado.</span><span class="sxs-lookup"><span data-stu-id="45827-119">If the publication does not use precomputed partitions, filters are evaluated when the Merge Agent runs.</span></span>  
  
 <span data-ttu-id="45827-120">Para obter mais informações sobre partições pré-computadas, consulte [Otimizar o desempenho de filtro com parâmetros com partições pré-computadas](parameterized-filters-optimize-for-precomputed-partitions.md).</span><span class="sxs-lookup"><span data-stu-id="45827-120">For more information about precomputed partitions, see [Optimize Parameterized Filter Performance with Precomputed Partitions](parameterized-filters-optimize-for-precomputed-partitions.md).</span></span> <span data-ttu-id="45827-121">A hora em que o filtro é avaliado afeta quais dados satisfazem o filtro.</span><span class="sxs-lookup"><span data-stu-id="45827-121">The time at which the filter is evaluated affects what data satisfies the filter.</span></span> <span data-ttu-id="45827-122">Por exemplo, se uma publicação usa partições pré-computadas, e você sincronizar os dados a cada dois dias, o subconjunto de dados para o vendedor poderia incluir linhas dois dias antes do esperado.</span><span class="sxs-lookup"><span data-stu-id="45827-122">For example, if a publication uses precomputed partitions, and you synchronize data every two days, the subset of data for the salesperson could include rows up to two days older than expected.</span></span>  
  
## <a name="recommendations-for-using-time-based-row-filters"></a><span data-ttu-id="45827-123">Recomendações para usar filtros de linha baseados em tempo</span><span class="sxs-lookup"><span data-stu-id="45827-123">Recommendations for Using Time-Based Row Filters</span></span>  
 <span data-ttu-id="45827-124">O método seguinte fornece uma abordagem robusta e direta para filtragem baseada em tempo:</span><span class="sxs-lookup"><span data-stu-id="45827-124">The following method provides a robust and straightforward approach to filtering based on time:</span></span>  
  
-   <span data-ttu-id="45827-125">Adicione uma coluna à tabela de tipo de dados de `bit`.</span><span class="sxs-lookup"><span data-stu-id="45827-125">Add a column to the table of data type `bit`.</span></span> <span data-ttu-id="45827-126">Esta coluna é usada para indicar se uma linha deveria ser replicada.</span><span class="sxs-lookup"><span data-stu-id="45827-126">This column is used to indicate whether a row should be replicated.</span></span>  
  
-   <span data-ttu-id="45827-127">Use um filtro de linha que faz referência à nova coluna em lugar de uma coluna baseada no tempo.</span><span class="sxs-lookup"><span data-stu-id="45827-127">Use a row filter that references the new column rather than a time-based column.</span></span>  
  
-   <span data-ttu-id="45827-128">Crie um trabalho do SQL Server Agent (ou um trabalho agendada por algum outro mecanismo) que atualiza a coluna antes do agendamento para a execução do Merge Agent.</span><span class="sxs-lookup"><span data-stu-id="45827-128">Create a SQL Server Agent job (or a job scheduled through another mechanism) that updates the column before the Merge Agent is scheduled to run.</span></span>  
  
 <span data-ttu-id="45827-129">Essa abordagem trata das falhas ao usar `GETDATE()` ou outro método baseado em tempo e evita o problema em determinar quando os filtros são avaliados por partições.</span><span class="sxs-lookup"><span data-stu-id="45827-129">This approach addresses the shortcomings of using `GETDATE()` or another time-based method and avoids the problem of having to determine when filters are evaluated for partitions.</span></span> <span data-ttu-id="45827-130">Considere o seguinte exemplo para uma tabela **Eventos** :</span><span class="sxs-lookup"><span data-stu-id="45827-130">Consider the following example of an **Events** table:</span></span>  
  
|<span data-ttu-id="45827-131">**EventID**</span><span class="sxs-lookup"><span data-stu-id="45827-131">**EventID**</span></span>|<span data-ttu-id="45827-132">**EventName**</span><span class="sxs-lookup"><span data-stu-id="45827-132">**EventName**</span></span>|<span data-ttu-id="45827-133">**EventCoordID**</span><span class="sxs-lookup"><span data-stu-id="45827-133">**EventCoordID**</span></span>|<span data-ttu-id="45827-134">**EventDate**</span><span class="sxs-lookup"><span data-stu-id="45827-134">**EventDate**</span></span>|<span data-ttu-id="45827-135">**Replicar**</span><span class="sxs-lookup"><span data-stu-id="45827-135">**Replicate**</span></span>|  
|-----------------|-------------------|----------------------|-------------------|-------------------|  
|<span data-ttu-id="45827-136">1</span><span class="sxs-lookup"><span data-stu-id="45827-136">1</span></span>|<span data-ttu-id="45827-137">Recepção</span><span class="sxs-lookup"><span data-stu-id="45827-137">Reception</span></span>|<span data-ttu-id="45827-138">112</span><span class="sxs-lookup"><span data-stu-id="45827-138">112</span></span>|<span data-ttu-id="45827-139">2006-10-04</span><span class="sxs-lookup"><span data-stu-id="45827-139">2006-10-04</span></span>|<span data-ttu-id="45827-140">1</span><span class="sxs-lookup"><span data-stu-id="45827-140">1</span></span>|  
|<span data-ttu-id="45827-141">2</span><span class="sxs-lookup"><span data-stu-id="45827-141">2</span></span>|<span data-ttu-id="45827-142">Refeição</span><span class="sxs-lookup"><span data-stu-id="45827-142">Dinner</span></span>|<span data-ttu-id="45827-143">112</span><span class="sxs-lookup"><span data-stu-id="45827-143">112</span></span>|<span data-ttu-id="45827-144">2006-10-10</span><span class="sxs-lookup"><span data-stu-id="45827-144">2006-10-10</span></span>|<span data-ttu-id="45827-145">0</span><span class="sxs-lookup"><span data-stu-id="45827-145">0</span></span>|  
|<span data-ttu-id="45827-146">3</span><span class="sxs-lookup"><span data-stu-id="45827-146">3</span></span>|<span data-ttu-id="45827-147">Festa</span><span class="sxs-lookup"><span data-stu-id="45827-147">Party</span></span>|<span data-ttu-id="45827-148">112</span><span class="sxs-lookup"><span data-stu-id="45827-148">112</span></span>|<span data-ttu-id="45827-149">2006-10-11</span><span class="sxs-lookup"><span data-stu-id="45827-149">2006-10-11</span></span>|<span data-ttu-id="45827-150">0</span><span class="sxs-lookup"><span data-stu-id="45827-150">0</span></span>|  
|<span data-ttu-id="45827-151">4</span><span class="sxs-lookup"><span data-stu-id="45827-151">4</span></span>|<span data-ttu-id="45827-152">Casamento</span><span class="sxs-lookup"><span data-stu-id="45827-152">Wedding</span></span>|<span data-ttu-id="45827-153">112</span><span class="sxs-lookup"><span data-stu-id="45827-153">112</span></span>|<span data-ttu-id="45827-154">2006-10-12</span><span class="sxs-lookup"><span data-stu-id="45827-154">2006-10-12</span></span>|<span data-ttu-id="45827-155">0</span><span class="sxs-lookup"><span data-stu-id="45827-155">0</span></span>|  
  
 <span data-ttu-id="45827-156">O filtro de linha para esta tabela teria essa aparência:</span><span class="sxs-lookup"><span data-stu-id="45827-156">The row filter for this table would then look like this:</span></span>  
  
```  
WHERE EventCoordID = CONVERT(INT,HOST_NAME()) AND Replicate = 1  
```  
  
 <span data-ttu-id="45827-157">O trabalho do SQL Server Agent poderia executar instruções [!INCLUDE[tsql](../../../includes/tsql-md.md)] semelhante para o próximo antes de cada execução do Merge Agent:</span><span class="sxs-lookup"><span data-stu-id="45827-157">The SQL Server Agent job could execute [!INCLUDE[tsql](../../../includes/tsql-md.md)] statements similar to the following before each Merge Agent run:</span></span>  
  
```  
UPDATE Events SET Replicate = 0 WHERE Replicate = 1  
GO  
UPDATE Events SET Replicate = 1 WHERE EventDate <= GETDATE()+6  
GO  
```  
  
 <span data-ttu-id="45827-158">A primeira linha redefine a coluna **Replicar** para **0**, e a segunda linha define a coluna para **1** para eventos que ocorram nos próximos sete dias.</span><span class="sxs-lookup"><span data-stu-id="45827-158">The first line resets the **Replicate** column to **0**, and the second line sets the column to **1** for events that occur in the next seven days.</span></span> <span data-ttu-id="45827-159">Se esta instrução [!INCLUDE[tsql](../../../includes/tsql-md.md)] for executada em 10/07/2006, a tabela será atualizada para:</span><span class="sxs-lookup"><span data-stu-id="45827-159">If this [!INCLUDE[tsql](../../../includes/tsql-md.md)] statement runs on 10/07/2006, the table is updated to:</span></span>  
  
|<span data-ttu-id="45827-160">**EventID**</span><span class="sxs-lookup"><span data-stu-id="45827-160">**EventID**</span></span>|<span data-ttu-id="45827-161">**EventName**</span><span class="sxs-lookup"><span data-stu-id="45827-161">**EventName**</span></span>|<span data-ttu-id="45827-162">**EventCoordID**</span><span class="sxs-lookup"><span data-stu-id="45827-162">**EventCoordID**</span></span>|<span data-ttu-id="45827-163">**EventDate**</span><span class="sxs-lookup"><span data-stu-id="45827-163">**EventDate**</span></span>|<span data-ttu-id="45827-164">**Replicar**</span><span class="sxs-lookup"><span data-stu-id="45827-164">**Replicate**</span></span>|  
|-----------------|-------------------|----------------------|-------------------|-------------------|  
|<span data-ttu-id="45827-165">1</span><span class="sxs-lookup"><span data-stu-id="45827-165">1</span></span>|<span data-ttu-id="45827-166">Recepção</span><span class="sxs-lookup"><span data-stu-id="45827-166">Reception</span></span>|<span data-ttu-id="45827-167">112</span><span class="sxs-lookup"><span data-stu-id="45827-167">112</span></span>|<span data-ttu-id="45827-168">2006-10-04</span><span class="sxs-lookup"><span data-stu-id="45827-168">2006-10-04</span></span>|<span data-ttu-id="45827-169">0</span><span class="sxs-lookup"><span data-stu-id="45827-169">0</span></span>|  
|<span data-ttu-id="45827-170">2</span><span class="sxs-lookup"><span data-stu-id="45827-170">2</span></span>|<span data-ttu-id="45827-171">Refeição</span><span class="sxs-lookup"><span data-stu-id="45827-171">Dinner</span></span>|<span data-ttu-id="45827-172">112</span><span class="sxs-lookup"><span data-stu-id="45827-172">112</span></span>|<span data-ttu-id="45827-173">2006-10-10</span><span class="sxs-lookup"><span data-stu-id="45827-173">2006-10-10</span></span>|<span data-ttu-id="45827-174">1</span><span class="sxs-lookup"><span data-stu-id="45827-174">1</span></span>|  
|<span data-ttu-id="45827-175">3</span><span class="sxs-lookup"><span data-stu-id="45827-175">3</span></span>|<span data-ttu-id="45827-176">Festa</span><span class="sxs-lookup"><span data-stu-id="45827-176">Party</span></span>|<span data-ttu-id="45827-177">112</span><span class="sxs-lookup"><span data-stu-id="45827-177">112</span></span>|<span data-ttu-id="45827-178">2006-10-11</span><span class="sxs-lookup"><span data-stu-id="45827-178">2006-10-11</span></span>|<span data-ttu-id="45827-179">1</span><span class="sxs-lookup"><span data-stu-id="45827-179">1</span></span>|  
|<span data-ttu-id="45827-180">4</span><span class="sxs-lookup"><span data-stu-id="45827-180">4</span></span>|<span data-ttu-id="45827-181">Casamento</span><span class="sxs-lookup"><span data-stu-id="45827-181">Wedding</span></span>|<span data-ttu-id="45827-182">112</span><span class="sxs-lookup"><span data-stu-id="45827-182">112</span></span>|<span data-ttu-id="45827-183">2006-10-12</span><span class="sxs-lookup"><span data-stu-id="45827-183">2006-10-12</span></span>|<span data-ttu-id="45827-184">1</span><span class="sxs-lookup"><span data-stu-id="45827-184">1</span></span>|  
  
 <span data-ttu-id="45827-185">Os eventos para a próxima semana estão sinalizados agora como estando prontos para serem replicados.</span><span class="sxs-lookup"><span data-stu-id="45827-185">The events for the next week are now flagged as being ready to replicate.</span></span> <span data-ttu-id="45827-186">A próxima vez que o Merge Agent for executado para a assinatura que o coordenador de eventos 112 usa, as linhas 2,3 e 4 serão baixadas para o Assinante e a linha 1 será removida do Assinante.</span><span class="sxs-lookup"><span data-stu-id="45827-186">The next time the Merge Agent runs for the subscription that event coordinator 112 uses, rows 2, 3, and 4 will be downloaded to the Subscriber and row 1 will be removed from the Subscriber.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="45827-187">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="45827-187">See Also</span></span>  
 <span data-ttu-id="45827-188">[GETDATE &#40;Transact-SQL&#41;](/sql/t-sql/functions/getdate-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="45827-188">[GETDATE &#40;Transact-SQL&#41;](/sql/t-sql/functions/getdate-transact-sql) </span></span>  
 <span data-ttu-id="45827-189">[Implementar trabalhos](../../../ssms/agent/implement-jobs.md) </span><span class="sxs-lookup"><span data-stu-id="45827-189">[Implement Jobs](../../../ssms/agent/implement-jobs.md) </span></span>  
 [<span data-ttu-id="45827-190">Parameterized Row Filters</span><span class="sxs-lookup"><span data-stu-id="45827-190">Parameterized Row Filters</span></span>](parameterized-filters-parameterized-row-filters.md)  
  
  
