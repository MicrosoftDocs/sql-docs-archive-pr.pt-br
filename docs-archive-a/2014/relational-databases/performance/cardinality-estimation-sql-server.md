---
title: Estimativa de cardinalidade (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 11/24/2015
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: performance
ms.topic: conceptual
helpviewer_keywords:
- cardinality estimator
- CE (cardinality estimator)
- estimating cardinality
ms.assetid: baa8a304-5713-4cfe-a699-345e819ce6df
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: aa56127f649d71bfcc8825322f8bf729175d41df
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87583564"
---
# <a name="cardinality-estimation-sql-server"></a><span data-ttu-id="38146-102">Estimativa de cardinalidade (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="38146-102">Cardinality Estimation (SQL Server)</span></span>
  <span data-ttu-id="38146-103">A lógica de estimativa de cardinalidade, chamada de avaliador de cardinalidade, foi reformulada no [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] para melhorar a qualidade dos planos de consulta e, consequentemente, melhorar o desempenho de consulta.</span><span class="sxs-lookup"><span data-stu-id="38146-103">The cardinality estimation logic, called the cardinality estimator, is re-designed in [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] to improve the quality of query plans, and therefore to improve query performance.</span></span> <span data-ttu-id="38146-104">O novo avaliador de cardinalidade incorpora as suposições e os algoritmos que funcionam bem em OLTP moderno e em cargas de trabalho de data warehouse.</span><span class="sxs-lookup"><span data-stu-id="38146-104">The new cardinality estimator incorporates assumptions and algorithms that work well on modern OLTP and data warehousing workloads.</span></span> <span data-ttu-id="38146-105">Ele se baseia na pesquisa detalhada da estimativa de cardinalidade em cargas de trabalho modernas, bem como em nosso aprendizado nos últimos 15 anos de aperfeiçoamento do avaliador de cardinalidade do SQL Server.</span><span class="sxs-lookup"><span data-stu-id="38146-105">It is based on in-depth cardinality estimation research on modern workloads, and our learnings over the past 15 years of improving the SQL Server cardinality estimator.</span></span> <span data-ttu-id="38146-106">Os comentários dos clientes mostram que, apesar de a maioria das consultas se beneficiarem da alteração ou permanecerem inalteradas, poucas mostram regressões em comparação ao avaliador de cardinalidade anterior.</span><span class="sxs-lookup"><span data-stu-id="38146-106">Feedback from customers shows that while most queries will benefit from the change or remain unchanged, a small number might show regressions compared to the previous cardinality estimator.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="38146-107">As estimativas de cardinalidade são uma previsão do número de linhas no resultado da consulta.</span><span class="sxs-lookup"><span data-stu-id="38146-107">Cardinality estimates are a prediction of the number of rows in the query result.</span></span> <span data-ttu-id="38146-108">O otimizador de consulta usa essas estimativas para escolher um plano para executar a consulta.</span><span class="sxs-lookup"><span data-stu-id="38146-108">The query optimizer uses these estimates to choose a plan for executing the query.</span></span> <span data-ttu-id="38146-109">A qualidade do plano de consulta tem um impacto direto sobre a melhoria no desempenho da consulta.</span><span class="sxs-lookup"><span data-stu-id="38146-109">The quality of the query plan has a direct impact on improving query performance.</span></span>  
  
## <a name="performance-testing-and-tuning-recommendations"></a><span data-ttu-id="38146-110">Teste de desempenho e recomendações de ajuste</span><span class="sxs-lookup"><span data-stu-id="38146-110">Performance Testing and Tuning Recommendations</span></span>  
 <span data-ttu-id="38146-111">O novo avaliador de cardinalidade é habilitado para todos os novos bancos de dados criados no [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)].</span><span class="sxs-lookup"><span data-stu-id="38146-111">The new cardinality estimator is enabled for all new databases created in [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)].</span></span> <span data-ttu-id="38146-112">Porém, a atualização para o [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] não habilita o novo avaliador de cardinalidade em bancos de dados existentes.</span><span class="sxs-lookup"><span data-stu-id="38146-112">However, upgrading to [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] does not enable the new cardinality estimator on existing databases.</span></span>  
  
 <span data-ttu-id="38146-113">Para garantir um melhor desempenho de consulta, use essas recomendações para testar sua carga de trabalho com o novo avaliador de cardinalidade antes de habilitá-lo em seu sistema de produção.</span><span class="sxs-lookup"><span data-stu-id="38146-113">To ensure the best query performance, use these recommendations to test your workload with the new cardinality estimator before enabling it on your production system.</span></span>  
  
1.  <span data-ttu-id="38146-114">Atualize todos os bancos de dados existentes para usar o novo avaliador de cardinalidade.</span><span class="sxs-lookup"><span data-stu-id="38146-114">Upgrade all existing databases to use the new cardinality estimator.</span></span> <span data-ttu-id="38146-115">Para fazer isso, use o [nível de compatibilidade ALTER DATABASE &#40;&#41;Transact-SQL](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) para definir o nível de compatibilidade do banco de dados como 120.</span><span class="sxs-lookup"><span data-stu-id="38146-115">To do this, use [ALTER DATABASE Compatibility Level &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) to set the database compatibility level to 120.</span></span>  
  
2.  <span data-ttu-id="38146-116">Execute sua carga de trabalho de teste com o novo avaliador de cardinalidade e, em seguida, solucione qualquer novo problema de desempenho da mesma forma que soluciona os problemas de desempenho atuais.</span><span class="sxs-lookup"><span data-stu-id="38146-116">Run your test workload with the new cardinality estimator, and then troubleshoot any new performance issues in the same manner you currently troubleshoot performance issues.</span></span>  
  
3.  <span data-ttu-id="38146-117">Quando sua carga de trabalho está em execução com o novo avaliador de cardinalidade (nível de compatibilidade de banco de dados (SQL Server 2014) 120), e uma consulta específica já foi retornada, você pode executar a consulta com o sinalizador de rastreamento 9481 para usar a versão do avaliador de cardinalidade usado em [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] e versões anteriores.</span><span class="sxs-lookup"><span data-stu-id="38146-117">Once your workload is running with the new cardinality estimator (database compatibility level 120 (SQL Server 2014)), and a specific query has regressed, you can run the query with trace flag 9481 to use the version of the cardinality estimator used in [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] and earlier.</span></span> <span data-ttu-id="38146-118">Para executar uma consulta com um sinalizador de rastreamento, consulte o artigo de banco de dados [Habilitar o comportamento do otimizador de consulta do SQL Server que afeta o plano e pode ser controlado por diferentes sinalizadores de rastreamento em um nível de consulta específico](https://support.microsoft.com/kb/2801413)</span><span class="sxs-lookup"><span data-stu-id="38146-118">To run a query with a trace flag, see the KB article [Enable plan-affecting SQL Server query optimizer behavior that can be controlled by different trace flags on a specific-query level](https://support.microsoft.com/kb/2801413).</span></span>  
  
4.  <span data-ttu-id="38146-119">Se você não puder alterar todos os bancos de dados ao mesmo tempo para usar o novo avaliador de cardinalidade, poderá usar o estimador de cardinalidade anterior para todos os bancos de dados usando o [nível de compatibilidade ALTER DATABASE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) para definir o nível de compatibilidade do banco de dados como 110.</span><span class="sxs-lookup"><span data-stu-id="38146-119">If you cannot change all of the databases at once to use the new cardinality estimator, you can use the former cardinality estimator for all databases by using [ALTER DATABASE Compatibility Level &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) to set the database compatibility level to 110.</span></span>  
  
5.  <span data-ttu-id="38146-120">Se a carga de trabalho está em execução com o nível de compatibilidade 110 do banco de dados, e você deseja testar ou executar uma consulta específica com o novo avaliador de cardinalidade, pode executar a consulta com o sinalizador de rastreamento 2312 para usar a versão 2014 do SQL Server do avaliador de cardinalidade.</span><span class="sxs-lookup"><span data-stu-id="38146-120">If your workload is running with database compatibility level 110 and you want to test or run a specific query with the new cardinality estimator, you can run the query with trace flag 2312 to use the SQL Server 2014 version of the cardinality estimator.</span></span>  <span data-ttu-id="38146-121">Para executar uma consulta com um sinalizador de rastreamento, consulte o artigo de banco de dados [Habilitar o comportamento do otimizador de consulta do SQL Server que afeta o plano e pode ser controlado por diferentes sinalizadores de rastreamento em um nível de consulta específico](https://support.microsoft.com/kb/2801413)</span><span class="sxs-lookup"><span data-stu-id="38146-121">To run a query with a trace flag, see the KB article [Enable plan-affecting SQL Server query optimizer behavior that can be controlled by different trace flags on a specific-query level](https://support.microsoft.com/kb/2801413).</span></span>  
  
## <a name="new-xevents"></a><span data-ttu-id="38146-122">Novos XEvents</span><span class="sxs-lookup"><span data-stu-id="38146-122">New XEvents</span></span>  
 <span data-ttu-id="38146-123">Há dois novos XEvents query_optimizer_estimate_cardinality para dar suporte aos novos planos de consulta.</span><span class="sxs-lookup"><span data-stu-id="38146-123">There are two new query_optimizer_estimate_cardinality XEvents to support the new query plans.</span></span>  
  
-   <span data-ttu-id="38146-124">*query_optimizer_estimate_cardinality* ocorre quando o otimizador de consulta calcula a cardinalidade em uma expressão relacional.</span><span class="sxs-lookup"><span data-stu-id="38146-124">*query_optimizer_estimate_cardinality* occurs when the query optimizer estimates the cardinality on a relational expression.</span></span>  
  
-   <span data-ttu-id="38146-125">*query_optimizer_force_both_cardinality_estimation*_behaviors ocorre quando ambos os sinalizadores de rastreamento 2312 e 9481 estão habilitados, tentando forçar ao mesmo tempo os comportamentos anterior e novo da estimativa de cardinalidade.</span><span class="sxs-lookup"><span data-stu-id="38146-125">*query_optimizer_force_both_cardinality_estimation*_behaviors occurs when both traceflags 2312 and 9481 are enabled, attempting to force both old and new cardinality estimation behavior at the same time.</span></span>  
  
## <a name="examples"></a><span data-ttu-id="38146-126">Exemplos</span><span class="sxs-lookup"><span data-stu-id="38146-126">Examples</span></span>  
 <span data-ttu-id="38146-127">Os exemplos a seguir mostram algumas das alterações nas novas estimativas de cardinalidade.</span><span class="sxs-lookup"><span data-stu-id="38146-127">The following examples show some of the changes in the new cardinality estimates.</span></span> <span data-ttu-id="38146-128">O código para calcular a cardinalidade foi recriado.</span><span class="sxs-lookup"><span data-stu-id="38146-128">The code for estimating cardinality has been rewritten.</span></span> <span data-ttu-id="38146-129">A lógica é complexa e não é possível fornecer uma lista completa de todas as alterações.</span><span class="sxs-lookup"><span data-stu-id="38146-129">The logic is complex and it is not possible to provide an exhaustive list of all changes.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="38146-130">Esses exemplos são fornecidos como informações conceituais.</span><span class="sxs-lookup"><span data-stu-id="38146-130">These examples are provided as conceptual information.</span></span> <span data-ttu-id="38146-131">Nenhuma ação é necessária de sua parte para alterar o modo como cria bancos de dados e consultas.</span><span class="sxs-lookup"><span data-stu-id="38146-131">No action is required on your part to change the way you design databases and queries.</span></span>  
  
### <a name="example-a-new-cardinality-estimates-use-an-average-cardinality-for-recently-added-ascending-data"></a><span data-ttu-id="38146-132">Exemplo A. As novas estimativas de cardinalidade usam uma cardinalidade média dos dados mais recentes em ordem crescente</span><span class="sxs-lookup"><span data-stu-id="38146-132">Example A. New cardinality estimates use an average cardinality for recently added ascending data</span></span>  
 <span data-ttu-id="38146-133">Este exemplo demonstra como o novo avaliador de cardinalidade pode melhorar estimativas de cardinalidade para dados em ordem crescente que excedem o valor máximo na tabela durante a atualização das estatísticas mais recentes.</span><span class="sxs-lookup"><span data-stu-id="38146-133">This example demonstrates how the new cardinality estimator can improve cardinality estimates for ascending data that exceeds the maximum value in the table during the most recent statistics update.</span></span>  
  
```  
SELECT item, category, amount FROM dbo.Sales AS s WHERE Date = '2013-12-19';  
```  
  
 <span data-ttu-id="38146-134">Neste exemplo, novas linhas são adicionadas à tabela Sales diariamente, a consulta solicita vendas ocorridas em 19/12/2013, e as estatísticas foram atualizadas pela última vez em 18/12/2013.</span><span class="sxs-lookup"><span data-stu-id="38146-134">In this example, new rows are added to the Sales table each day, the query asks for sales that occurred on 12/19/2013, and statistics were last updated on 12/18/2013.</span></span> <span data-ttu-id="38146-135">O avaliador de cardinalidade anterior supõe que os valores de 19/12/2013 não existem, pois a data excede a data máxima e as estatísticas não foram atualizadas para incluir os valores de 19/12/2013.</span><span class="sxs-lookup"><span data-stu-id="38146-135">The previous cardinality estimator assumes the 12/19/2013 values do not exist since the date exceeds the maximum date and statistics have not been updated to include the 12/19/2013 values.</span></span> <span data-ttu-id="38146-136">Essa situação, conhecida como o problema de chave crescente, ocorrerá se você carregar dados durante o dia e, depois, executar consultas nos dados antes da atualização de estatísticas.</span><span class="sxs-lookup"><span data-stu-id="38146-136">This situation, known as the ascending key problem, will occur if you load data during the day, and then run queries against the data before statistics are updated.</span></span>  
  
 <span data-ttu-id="38146-137">Esse comportamento foi alterado.</span><span class="sxs-lookup"><span data-stu-id="38146-137">This behavior has changed.</span></span> <span data-ttu-id="38146-138">Agora, mesmo se as estatísticas não foram atualizadas para os dados mais recentes em ordem crescente, adicionados desde a última atualização das estatísticas, o novo avaliador de cardinalidade suporá que os valores existem e usará a cardinalidade média para cada valor na coluna como a estimativa de cardinalidade.</span><span class="sxs-lookup"><span data-stu-id="38146-138">Now, even if statistics have not been updated for the most recent ascending data that is added since the last statistics update, the new cardinality estimator assumes the values exist and uses the average cardinality for each value in the column as the cardinality estimate.</span></span>  
  
### <a name="example-b-new-cardinality-estimates-assume-filtered-predicates-on-the-same-table-have-some-correlation"></a><span data-ttu-id="38146-139">Exemplo B. As novas estimativas de cardinalidade consideram que predicados filtrados na mesma tabela têm alguma correlação</span><span class="sxs-lookup"><span data-stu-id="38146-139">Example B. New cardinality estimates assume filtered predicates on the same table have some correlation</span></span>  
 <span data-ttu-id="38146-140">Para este exemplo, suponha que a tabela Cars tem 1000 linhas, Make tem 200 correspondências para 'Honda”, Model tem 50 correspondências para 'Civic', e que todos os carros Civic são Honda.</span><span class="sxs-lookup"><span data-stu-id="38146-140">For this example, assume the table Cars as 1000 rows, Make has 200 matches for 'Honda', Model has 50 matches for 'Civic', and that all of the Civics are Hondas.</span></span> <span data-ttu-id="38146-141">Consequentemente, 20% dos valores na coluna Make são 'Honda', 5% dos valores na coluna Model são 'Civic', e o número real de carros Civic da Honda é 50.</span><span class="sxs-lookup"><span data-stu-id="38146-141">Therefore, 20% of the values in the Make column are 'Honda', 5% of the values in the Model column are 'Civic', and the actual number of Honda Civics is 50.</span></span> <span data-ttu-id="38146-142">As estimativas de cardinalidade anteriores consideram que os valores nas colunas Make e Model são independentes.</span><span class="sxs-lookup"><span data-stu-id="38146-142">The previous cardinality estimates assume the values in the Make and the Model columns are independent of each other.</span></span> <span data-ttu-id="38146-143">As estimativas anteriores do otimizador de consulta são 10 Honda cívicos (. 05 \* .20 \* 1000 linhas = 10 linhas).</span><span class="sxs-lookup"><span data-stu-id="38146-143">The previous query optimizer estimates there are 10 Honda Civics (.05 \* .20 \* 1000 rows = 10 rows).</span></span>  
  
```  
SELECT year, purchase_price FROM dbo.Cars WHERE Make = 'Honda' AND Model = 'Civic';  
```  
  
 <span data-ttu-id="38146-144">Esse comportamento foi alterado.</span><span class="sxs-lookup"><span data-stu-id="38146-144">This behavior has changed.</span></span> <span data-ttu-id="38146-145">Agora, as novas estimativas de cardinalidade supõem que as colunas Make e Model têm *alguma* correlação.</span><span class="sxs-lookup"><span data-stu-id="38146-145">Now, the new cardinality estimates assume the Make and Model columns have *some* correlation.</span></span> <span data-ttu-id="38146-146">O otimizador de consulta calcula uma cardinalidade superior, adicionando um componente exponencial à equação de avaliação.</span><span class="sxs-lookup"><span data-stu-id="38146-146">The query optimizer estimates a higher cardinality by adding an exponential component to the estimation equation.</span></span> <span data-ttu-id="38146-147">O otimizador de consulta agora estima que 22,36 linhas (0,05 \* SQRT (. 20) \* 1000 linhas = 22,36 linhas) correspondem ao predicado.</span><span class="sxs-lookup"><span data-stu-id="38146-147">The query optimizer now estimates that 22.36 rows ( .05 \* SQRT(.20) \* 1000 rows = 22.36 rows ) match the predicate.</span></span> <span data-ttu-id="38146-148">Para este cenário e a distribuição de dados específica, o valor de 22,36 linhas está mais próximo de 50 linhas reais que a consulta retornará.</span><span class="sxs-lookup"><span data-stu-id="38146-148">For this scenario and specific data distribution, 22.36 rows is closer to the actual 50 rows that the query will return.</span></span>  
  
 <span data-ttu-id="38146-149">Observe que a nova lógica do avaliador de cardinalidade classifica as seletividades de predicado e aumenta o expoente.</span><span class="sxs-lookup"><span data-stu-id="38146-149">Note, the new cardinality estimator logic sorts the predicate selectivities and increases the exponent.</span></span> <span data-ttu-id="38146-150">Por exemplo, se o predicado seletividades fosse 0,05, .20 e 0,25, a estimativa de cardinalidade seria (. 05 \* SQRT (. 20) \* sqrt (sqrt (. 25))).</span><span class="sxs-lookup"><span data-stu-id="38146-150">For example, if the predicate selectivities were .05, .20, and .25, the cardinality estimate would be (.05 \* SQRT(.20) \* SQRT(SQRT(.25)) ).</span></span>  
  
### <a name="example-c-new-cardinality-estimates-assume-filtered-predicates-on-different-tables-are-independent"></a><span data-ttu-id="38146-151">Exemplo C. As novas estimativas de cardinalidade supõem que predicados filtrados em tabelas diferentes são independentes</span><span class="sxs-lookup"><span data-stu-id="38146-151">Example C. New cardinality estimates assume filtered predicates on different tables are independent</span></span>  
 <span data-ttu-id="38146-152">Para este exemplo, o avaliador de cardinalidade anterior considera que os filtros de predicado s.type e r.date estão correlacionados.</span><span class="sxs-lookup"><span data-stu-id="38146-152">For this example, the previous cardinality estimator assumes that the predicate filters s.type and r.date are correlated.</span></span> <span data-ttu-id="38146-153">No entanto, os resultados de testes em cargas de trabalho modernas mostraram que os filtros de predicado em colunas em tabelas diferentes não costumam estar correlacionados.</span><span class="sxs-lookup"><span data-stu-id="38146-153">However, test results on modern workloads showed that predicate filters on columns in different tables are usually not correlated with each other.</span></span>  
  
```  
SELECT s.ticket, s.customer, r.store FROM dbo.Sales AS s CROSS JOIN dbo.Returns AS r  
WHERE s.ticket = r.ticket AND s.type = 'toy' AND r.date = '2013-12-19';  
```  
  
 <span data-ttu-id="38146-154">Esse comportamento foi alterado.</span><span class="sxs-lookup"><span data-stu-id="38146-154">This behavior has changed.</span></span> <span data-ttu-id="38146-155">Agora, a nova lógica de avaliador de cardinalidade supõe que s.type não está correlacionado com r.date.</span><span class="sxs-lookup"><span data-stu-id="38146-155">Now, the new cardinality estimator logic assumes that s.type is not correlated with r.date.</span></span> <span data-ttu-id="38146-156">Em termos práticos, a suposição é que toys são retornados diariamente, e não apenas em um dia específico.</span><span class="sxs-lookup"><span data-stu-id="38146-156">In practical terms, the assumption is that toys are returned every day and not only on a specific day.</span></span> <span data-ttu-id="38146-157">Neste caso, o valor das novas estimativas de cardinalidade será menor do que o das estimativas de cardinalidade anteriores.</span><span class="sxs-lookup"><span data-stu-id="38146-157">In this case, the new cardinality estimates will be a smaller number than the previous cardinality estimates.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="38146-158">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="38146-158">See Also</span></span>  
 [<span data-ttu-id="38146-159">Monitorar e ajustar o desempenho</span><span class="sxs-lookup"><span data-stu-id="38146-159">Monitor and Tune for Performance</span></span>](monitor-and-tune-for-performance.md)  
  
  
