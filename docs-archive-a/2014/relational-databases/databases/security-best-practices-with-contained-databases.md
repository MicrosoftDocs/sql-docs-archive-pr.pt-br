---
title: Práticas recomendadas de segurança com bancos de dados independentes | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: security
ms.topic: conceptual
helpviewer_keywords:
- contained database, threats
ms.assetid: 026ca5fc-95da-46b6-b882-fa20f765b51d
author: stevestein
ms.author: sstein
ms.openlocfilehash: 8a4a933b99090d29f38156c56c9efa56b73af5a1
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87678785"
---
# <a name="security-best-practices-with-contained-databases"></a><span data-ttu-id="29b33-102">Práticas recomendadas de segurança com bancos de dados independentes</span><span class="sxs-lookup"><span data-stu-id="29b33-102">Security Best Practices with Contained Databases</span></span>
  <span data-ttu-id="29b33-103">Bancos de dados independentes têm algumas ameaças exclusivas que devem ser entendidas e mitigadas pelos administradores do [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="29b33-103">Contained databases have some unique threats that should be understood and mitigated by [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] administrators.</span></span> <span data-ttu-id="29b33-104">A maioria das ameaças está relacionada ao processo de autenticação `USER WITH PASSWORD` que move o limite de autenticação do nível do [!INCLUDE[ssDE](../../includes/ssde-md.md)] para o nível do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="29b33-104">Most of the threats are related to the `USER WITH PASSWORD` authentication process, which moves the authentication boundary from the [!INCLUDE[ssDE](../../includes/ssde-md.md)] level to the database level.</span></span>  
  
## <a name="threats-related-to-users"></a><span data-ttu-id="29b33-105">Ameaças relacionadas a usuários</span><span class="sxs-lookup"><span data-stu-id="29b33-105">Threats Related to Users</span></span>  
 <span data-ttu-id="29b33-106">Os usuários em um banco de dados independente que têm a `ALTER ANY USER` permissão, como membros do **db_owner** e **db_securityadmin** funções de banco de dados fixas, podem conceder acesso ao banco de dados sem o conhecimento ou a permissão se o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] administrador.</span><span class="sxs-lookup"><span data-stu-id="29b33-106">Users in a contained database that have the `ALTER ANY USER` permission, such as members of the **db_owner** and **db_securityadmin** fixed database roles, can grant access to the database without the knowledge or permission if the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] administrator.</span></span> <span data-ttu-id="29b33-107">A concessão de acesso a um banco de dados independente a usuários aumenta a área da superfície de ataque potencial contra toda a instância do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="29b33-107">Granting users access to a contained database increases the potential attack surface area against the whole [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance.</span></span> <span data-ttu-id="29b33-108">Os administradores devem entender essa delegação de controle de acesso e ter muito cuidado ao conceder permissão `ALTER ANY USER` aos usuários no banco de dados independente.</span><span class="sxs-lookup"><span data-stu-id="29b33-108">Administrators should understand this delegation of access control, and be very careful about granting users in the contained database the `ALTER ANY USER` permission.</span></span> <span data-ttu-id="29b33-109">Todos os proprietários de banco de dados têm a permissão `ALTER ANY USER`.</span><span class="sxs-lookup"><span data-stu-id="29b33-109">All database owners have the `ALTER ANY USER` permission.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="29b33-110">auditar os usuários periodicamente em um banco de dados independente.</span><span class="sxs-lookup"><span data-stu-id="29b33-110">administrators should periodically audit the users in a contained database.</span></span>  
  
### <a name="accessing-other-databases-using-the-guest-account"></a><span data-ttu-id="29b33-111">Acessando outros bancos de dados que usam a conta Convidado</span><span class="sxs-lookup"><span data-stu-id="29b33-111">Accessing Other Databases Using the guest Account</span></span>  
 <span data-ttu-id="29b33-112">Os proprietários e os usuários de banco de dados com a permissão `ALTER ANY USER` podem criar usuários de banco de dados independente.</span><span class="sxs-lookup"><span data-stu-id="29b33-112">Database owners and database users with the `ALTER ANY USER` permission can create contained database users.</span></span> <span data-ttu-id="29b33-113">Após conectar-se a um banco de dados independente em uma instância do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], um usuário de banco de dados independente poderá acessar outros bancos de dados no [!INCLUDE[ssDE](../../includes/ssde-md.md)], caso os outros bancos de dados tenham habilitado a conta de **convidado** .</span><span class="sxs-lookup"><span data-stu-id="29b33-113">After connecting to a contained database on an instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], a contained database user can access other databases on the [!INCLUDE[ssDE](../../includes/ssde-md.md)], if the other databases have enabled the **guest** account.</span></span>  
  
### <a name="creating-a-duplicate-user-in-another-database"></a><span data-ttu-id="29b33-114">Criando um usuário duplicado em outro banco de dados</span><span class="sxs-lookup"><span data-stu-id="29b33-114">Creating a Duplicate User in Another Database</span></span>  
 <span data-ttu-id="29b33-115">Alguns aplicativos podem exigir que um usuário tenha acesso a mais de um banco de dados.</span><span class="sxs-lookup"><span data-stu-id="29b33-115">Some applications might require that a user to have access to more than one database.</span></span> <span data-ttu-id="29b33-116">Isso pode ser feito por meio da criação de usuários de banco de dados independente idênticos em cada banco de dados.</span><span class="sxs-lookup"><span data-stu-id="29b33-116">This can be done by creating identical contained database users in each database.</span></span> <span data-ttu-id="29b33-117">Use a opção de SID ao criar o segundo usuário com a senha.</span><span class="sxs-lookup"><span data-stu-id="29b33-117">Use the SID option when creating the second user with password.</span></span> <span data-ttu-id="29b33-118">O exemplo a seguir cria dois usuários idênticos em dois bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="29b33-118">The following example creates two identical users in two databases.</span></span>  
  
```  
USE DB1;  
GO  
CREATE USER Carlo WITH PASSWORD = '<strong password>';   
-- Return the SID of the user  
SELECT SID FROM sys.database_principals WHERE name = 'Carlo';  
  
-- Change to the second database  
USE DB2;  
GO  
CREATE USER Carlo WITH PASSWORD = '<same password>', SID = <SID from DB1>;  
GO  
```  
  
 <span data-ttu-id="29b33-119">Para executar uma consulta de bancos de dados cruzado, você deve definir a opção `TRUSTWORTHY` no banco de dados de chamada.</span><span class="sxs-lookup"><span data-stu-id="29b33-119">To execute a cross-database query, you must set the `TRUSTWORTHY` option on the calling database.</span></span> <span data-ttu-id="29b33-120">Por exemplo se o usuário (Carlo) definida acima estiver em DB1, para executar `SELECT * FROM db2.dbo.Table1;`, a configuração `TRUSTWORTHY` deve estar ativada para o banco de dados DB1.</span><span class="sxs-lookup"><span data-stu-id="29b33-120">For example if the user (Carlo) defined above is in DB1, to execute `SELECT * FROM db2.dbo.Table1;` then the `TRUSTWORTHY` setting must be on for database DB1.</span></span> <span data-ttu-id="29b33-121">Execute o código a seguir para ativar a configuração `TRUSTWORHTY`.</span><span class="sxs-lookup"><span data-stu-id="29b33-121">Execute the following code to set the `TRUSTWORHTY` setting on.</span></span>  
  
```  
ALTER DATABASE DB1 SET TRUSTWORTHY ON;  
```  
  
### <a name="creating-a-user-that-duplicates-a-login"></a><span data-ttu-id="29b33-122">Criando um usuário que duplica um logon</span><span class="sxs-lookup"><span data-stu-id="29b33-122">Creating a User that Duplicates a Login</span></span>  
 <span data-ttu-id="29b33-123">Se um usuário de banco de dados independente com senha for criado com o mesmo nome de um logon do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] e se o logon do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] se conectar especificando o banco de dados independente como catálogo inicial, o logon do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] não poderá se conectar.</span><span class="sxs-lookup"><span data-stu-id="29b33-123">If a contained database user with password is created, using the same name as a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login, and if the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login connects specifying the contained database as the initial catalog, then the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login will be unable to connect.</span></span> <span data-ttu-id="29b33-124">A conexão será avaliada como a entidade do usuário com senha no banco de dados independente em vez de como um usuário baseado no logon do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="29b33-124">The connection will be evaluated as the contained database user with password principal on the contained database instead of as a user based on the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login.</span></span> <span data-ttu-id="29b33-125">Isso pode provocar uma negação intencional ou acidental do serviço para o logon do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="29b33-125">This could cause an intentional or accidental denial of service for the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login.</span></span>  
  
-   <span data-ttu-id="29b33-126">Como uma prática recomendada, membros da função de servidor fixa **sysadmin** devem sempre considerar conectar-se com o uso da opção de catálogo inicial.</span><span class="sxs-lookup"><span data-stu-id="29b33-126">As a best practice, members of the **sysadmin** fixed server role should consider always connecting without using the initial catalog option.</span></span> <span data-ttu-id="29b33-127">Isso conecta o logon ao banco de dados mestre e evita qualquer tentativa de um proprietário de banco de dados usar indevidamente a tentativa de logon.</span><span class="sxs-lookup"><span data-stu-id="29b33-127">This connects the login to the master database and avoids any attempts by a database owner to misuse the login attempt.</span></span> <span data-ttu-id="29b33-128">Em seguida, o administrador pode alterar para o banco de dados independente usando a `USE` *\<database>* instrução.</span><span class="sxs-lookup"><span data-stu-id="29b33-128">Then the administrator can change to the contained database by using the `USE`*\<database>* statement.</span></span> <span data-ttu-id="29b33-129">Também é possível definir o banco de dados padrão do logon para o banco de dados independente, o que conclui o logon no **mestre**e, em seguida, transfere o logon para o banco de dados independente.</span><span class="sxs-lookup"><span data-stu-id="29b33-129">You can also set the default database of the login to the contained database, which completes the login to **master**, and then transfers the login to the contained database.</span></span>  
  
-   <span data-ttu-id="29b33-130">Como uma prática recomendada, não crie usuários de banco de dados independente com senhas que tenham o mesmo nome que logons do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="29b33-130">As a best practice, do not create contained database users with passwords who have the same name as [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] logins.</span></span>  
  
-   <span data-ttu-id="29b33-131">Se o logon duplicado existir, conecte-se ao banco de dados **mestre** sem especificar um catálogo inicial e execute o `USE` comando para alterar para o banco de dados independente.</span><span class="sxs-lookup"><span data-stu-id="29b33-131">If the duplicate login exists, connect to the **master** database without specifying an initial catalog, and then execute the `USE` command to change to the contained database.</span></span>  
  
-   <span data-ttu-id="29b33-132">Quando os bancos de dados independentes estiverem presentes, os usuários de bancos de dados dependentes devem se conectar ao [!INCLUDE[ssDE](../../includes/ssde-md.md)] sem usar um catálogo inicial ou especificando o nome de um banco de dados dependente como catálogo inicial.</span><span class="sxs-lookup"><span data-stu-id="29b33-132">When contained databases are present, users of databases that are not contained databases should connect to the [!INCLUDE[ssDE](../../includes/ssde-md.md)] without using an initial catalog or by specifying the database name of a non-contained database as the initial catalog.</span></span> <span data-ttu-id="29b33-133">Isso evita a conexão ao banco de dados independente que está sob controle menos direto pelos administradores do [!INCLUDE[ssDE](../../includes/ssde-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="29b33-133">This avoids connecting to the contained database which is under less direct control by the [!INCLUDE[ssDE](../../includes/ssde-md.md)] administrators.</span></span>  
  
### <a name="increasing-access-by-changing-the-containment-status-of-a-database"></a><span data-ttu-id="29b33-134">Aumentando o acesso por meio da alteração do status de contenção de um banco de dados</span><span class="sxs-lookup"><span data-stu-id="29b33-134">Increasing Access by Changing the Containment Status of a Database</span></span>  
 <span data-ttu-id="29b33-135">Os logons que têm a `ALTER ANY DATABASE` permissão, como membros da função de servidor fixa **dbcreator** , e os usuários em um banco de dados dependente que têm a `CONTROL DATABASE` permissão, como membros da função de banco de dados fixa **db_owner** , podem alterar a configuração de contenção de um banco de dados.</span><span class="sxs-lookup"><span data-stu-id="29b33-135">Logins that have the `ALTER ANY DATABASE` permission, such as members of the **dbcreator** fixed server role, and users in a non-contained database that have the `CONTROL DATABASE` permission, such as members of the **db_owner** fixed database role, can change the containment setting of a database.</span></span> <span data-ttu-id="29b33-136">Se a configuração de contenção de um banco de dados for alterada de `NONE` para `PARTIAL` ou `FULL`, o acesso de usuários poderá ser concedido por meio da criação de usuários de banco de dados independente com senhas.</span><span class="sxs-lookup"><span data-stu-id="29b33-136">If the containment setting of a database is changed from `NONE` to either `PARTIAL` or `FULL`, then user access can be granted by creating contained database users with passwords.</span></span> <span data-ttu-id="29b33-137">Isso pode fornecer acesso sem o conhecimento ou consentimento dos administradores do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="29b33-137">This could provide access without the knowledge or consent of the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] administrators.</span></span> <span data-ttu-id="29b33-138">Para impedir que todos os bancos de dados sejam contidos, defina a [!INCLUDE[ssDE](../../includes/ssde-md.md)] `contained database authentication` opção como 0.</span><span class="sxs-lookup"><span data-stu-id="29b33-138">To prevent any databases from being contained, set the [!INCLUDE[ssDE](../../includes/ssde-md.md)]`contained database authentication` option to 0.</span></span> <span data-ttu-id="29b33-139">Para impedir conexões por usuários de banco de dados independente com senhas em bancos de dados independentes selecionados, use gatilhos de logon para cancelar tentativas de logon por usuários de banco de dados independente com senhas.</span><span class="sxs-lookup"><span data-stu-id="29b33-139">To prevent connections by contained database users with passwords on selected contained databases, use login triggers to cancel login attempts by contained database users with passwords.</span></span>  
  
### <a name="attaching-a-contained-database"></a><span data-ttu-id="29b33-140">Anexando um banco de dados independente</span><span class="sxs-lookup"><span data-stu-id="29b33-140">Attaching a Contained Database</span></span>  
 <span data-ttu-id="29b33-141">Por meio da anexação de um banco de dados independente, um administrador pode dar acesso não desejado de usuários à instância do [!INCLUDE[ssDE](../../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="29b33-141">By attaching a contained database, an administrator could give unwanted users access to the instance of the [!INCLUDE[ssDE](../../includes/ssde-md.md)].</span></span> <span data-ttu-id="29b33-142">Um administrador preocupado com esse risco pode colocar o banco de dados online em modo `RESTRICTED_USER`, o que impede a autenticação para usuários de bancos de dados independentes com senha.</span><span class="sxs-lookup"><span data-stu-id="29b33-142">An administrator concerned about this risk can bring the database online in `RESTRICTED_USER` mode, which prevents authentication for contained database users with passwords.</span></span> <span data-ttu-id="29b33-143">Apenas entidades autorizadas por meio de logon poderão acessar o [!INCLUDE[ssDE](../../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="29b33-143">Only principals authorized through logins will be able to access the [!INCLUDE[ssDE](../../includes/ssde-md.md)].</span></span>  
  
 <span data-ttu-id="29b33-144">Os usuários são criados com o uso dos requisitos de senha em vigor no momento em que são criados, e as senhas não são verificadas novamente quando um banco de dados é anexado.</span><span class="sxs-lookup"><span data-stu-id="29b33-144">Users are created using the password requirements in effect at the time that they are created and passwords are not rechecked when a database is attached.</span></span> <span data-ttu-id="29b33-145">Com a anexação de um banco de dados independente que permite senhas fracas a um sistema com uma política de senha mais rígida, um administrador pode permitir senhas que não atendam à política de senha atual no [!INCLUDE[ssDE](../../includes/ssde-md.md)]de anexação.</span><span class="sxs-lookup"><span data-stu-id="29b33-145">By attaching a contained database which allowed weak passwords to a system with a stricter password policy, an administrator could permit passwords that do not meet the current password policy on the attaching [!INCLUDE[ssDE](../../includes/ssde-md.md)].</span></span> <span data-ttu-id="29b33-146">Os administradores podem evitar a contenção de senhas fracas com a exigência de que todas as senhas sejam redefinidas para o banco de dados anexado.</span><span class="sxs-lookup"><span data-stu-id="29b33-146">Administrators can avoid retaining the weak passwords by requiring that all passwords be reset for the attached database.</span></span>  
  
### <a name="password-policies"></a><span data-ttu-id="29b33-147">Políticas de senha</span><span class="sxs-lookup"><span data-stu-id="29b33-147">Password Policies</span></span>  
 <span data-ttu-id="29b33-148">É possível exigir senhas fortes em um banco de dados, mas não é possível protegê-las com políticas de senha robusta.</span><span class="sxs-lookup"><span data-stu-id="29b33-148">Passwords in a database can be required to be strong passwords, but cannot be protected by robust password policies.</span></span> <span data-ttu-id="29b33-149">Use a Autenticação do Windows sempre que possível para tirar proveito das políticas de senha mais extensivas disponíveis no Windows.</span><span class="sxs-lookup"><span data-stu-id="29b33-149">Use Windows Authentication whenever possible to take advantage of the more extensive password policies available from Windows.</span></span>  
  
### <a name="kerberos-authentication"></a><span data-ttu-id="29b33-150">Autenticação Kerberos</span><span class="sxs-lookup"><span data-stu-id="29b33-150">Kerberos Authentication</span></span>  
 <span data-ttu-id="29b33-151">Usuários de bancos de dados independentes com senhas não podem usar a Autenticação Kerberos.</span><span class="sxs-lookup"><span data-stu-id="29b33-151">Contained database users with passwords cannot use Kerberos Authentication.</span></span> <span data-ttu-id="29b33-152">Quando possível, use a Autenticação do Windows para tirar proveito dos recursos do Windows, como o Kerberos.</span><span class="sxs-lookup"><span data-stu-id="29b33-152">When possible, use Windows Authentication to take advantage of Windows features such as Kerberos.</span></span>  
  
### <a name="offline-dictionary-attack"></a><span data-ttu-id="29b33-153">Ataque de dicionário offline</span><span class="sxs-lookup"><span data-stu-id="29b33-153">Offline Dictionary Attack</span></span>  
 <span data-ttu-id="29b33-154">Os hashes de senha de usuários de banco de dados independente com senhas são armazenados no banco de dados independente.</span><span class="sxs-lookup"><span data-stu-id="29b33-154">The password hashes for contained database users with passwords are stored in the contained database.</span></span> <span data-ttu-id="29b33-155">Qualquer usuário com acesso aos arquivos de banco de dados pode executar um ataque de dicionário contra os usuários de banco de dados independente com senhas em um sistema não auditado.</span><span class="sxs-lookup"><span data-stu-id="29b33-155">Anyone with access to the database files could perform a dictionary attack against the contained database users with passwords on an unaudited system.</span></span> <span data-ttu-id="29b33-156">Para mitigar essa ameaça, restrinja o acesso aos arquivos de banco de dados, ou apenas permita conexões ao bancos de dados contido por meio da Autenticação do Windows.</span><span class="sxs-lookup"><span data-stu-id="29b33-156">To mitigate this threat, restrict access to the database files, or only permit connections to contained databases by using Windows Authentication.</span></span>  
  
## <a name="escaping-a-contained-database"></a><span data-ttu-id="29b33-157">Escape de um banco de dados independente</span><span class="sxs-lookup"><span data-stu-id="29b33-157">Escaping a Contained Database</span></span>  
 <span data-ttu-id="29b33-158">Se um banco de dados for parcialmente contido, os administradores do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] deverão auditar os recursos dos usuários e módulos periodicamente em bancos de dados independentes.</span><span class="sxs-lookup"><span data-stu-id="29b33-158">If a database is partially contained, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] administrators should periodically audit the capabilities of the users and modules in contained databases.</span></span>  
  
## <a name="denial-of-service-through-auto_close"></a><span data-ttu-id="29b33-159">Negação de serviço por meio de AUTO_CLOSE</span><span class="sxs-lookup"><span data-stu-id="29b33-159">Denial of Service Through AUTO_CLOSE</span></span>  
 <span data-ttu-id="29b33-160">Não configure bancos de dados independentes como fechamento automático.</span><span class="sxs-lookup"><span data-stu-id="29b33-160">Do not configure contained databases to auto close.</span></span> <span data-ttu-id="29b33-161">Se fechado, a abertura do banco de dados para autenticar um usuário consumirá recursos adicionais e poderá contribuir para um ataque de negação de serviço.</span><span class="sxs-lookup"><span data-stu-id="29b33-161">If closed, opening the database to authenticate a user consumes additional resources and could contribute to a denial of service attack.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="29b33-162">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="29b33-162">See Also</span></span>  
 <span data-ttu-id="29b33-163">[Bancos de dados independentes](contained-databases.md) </span><span class="sxs-lookup"><span data-stu-id="29b33-163">[Contained Databases](contained-databases.md) </span></span>  
 [<span data-ttu-id="29b33-164">Migrar para um banco de dados parcialmente independente</span><span class="sxs-lookup"><span data-stu-id="29b33-164">Migrate to a Partially Contained Database</span></span>](migrate-to-a-partially-contained-database.md)  
  
  
