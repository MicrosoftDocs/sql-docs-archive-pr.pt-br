---
title: Estatísticas para tabelas com otimização de memória | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
ms.assetid: e644766d-1d1c-43d7-83ff-8ccfe4f3af9f
author: rothja
ms.author: jroth
ms.openlocfilehash: 0ae09d76c2642e23c56afcdd5ae4e1e468ef5883
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87685143"
---
# <a name="statistics-for-memory-optimized-tables"></a><span data-ttu-id="29299-102">Estatísticas para tabelas com otimização de memória</span><span class="sxs-lookup"><span data-stu-id="29299-102">Statistics for Memory-Optimized Tables</span></span>
  <span data-ttu-id="29299-103">O otimizador de consulta usa estatísticas sobre colunas para criar planos de consulta que melhoram o desempenho das consultas.</span><span class="sxs-lookup"><span data-stu-id="29299-103">The query optimizer uses statistics about columns to create query plans that improve query performance.</span></span> <span data-ttu-id="29299-104">As estatísticas são coletadas de tabelas no banco de dados e armazenadas nos metadados do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="29299-104">Statistics are collected from the tables in the database and stored in the database metadata.</span></span>  
  
 <span data-ttu-id="29299-105">As estatísticas são criadas automaticamente, mas também podem ser criadas manualmente.</span><span class="sxs-lookup"><span data-stu-id="29299-105">Statistics are created automatically, but can also be created manually.</span></span> <span data-ttu-id="29299-106">Por exemplo, as estatísticas são criadas automaticamente para colunas de chave de índice durante a criação do índice.</span><span class="sxs-lookup"><span data-stu-id="29299-106">For example, statistics are created automatically for index key columns when the index is created.</span></span> <span data-ttu-id="29299-107">Para obter mais informações sobre como criar estatísticas, consulte [Statistics](../statistics/statistics.md).</span><span class="sxs-lookup"><span data-stu-id="29299-107">For more information about creating statistics see [Statistics](../statistics/statistics.md).</span></span>  
  
 <span data-ttu-id="29299-108">Geralmente, os dados de tabela são alterados com o tempo, à medida que linhas são inseridas, atualizadas e excluídas.</span><span class="sxs-lookup"><span data-stu-id="29299-108">Table data typically changes over time as rows are inserted, updated, and deleted.</span></span> <span data-ttu-id="29299-109">Isso significa que as estatísticas precisam ser atualizadas periodicamente.</span><span class="sxs-lookup"><span data-stu-id="29299-109">This means statistics need to be updated periodically.</span></span> <span data-ttu-id="29299-110">Por padrão, as estatísticas em tabelas baseadas em disco são atualizadas automaticamente quando o otimizador determina que elas podem estar desatualizadas.</span><span class="sxs-lookup"><span data-stu-id="29299-110">By default, statistics on disk-based tables are updated automatically when the optimizer determines they might be out of date.</span></span>  
  
 <span data-ttu-id="29299-111">As estatísticas sobre tabelas com otimização de memória não são atualizadas por padrão.</span><span class="sxs-lookup"><span data-stu-id="29299-111">Statistics on memory-optimized tables are not updated by default.</span></span> <span data-ttu-id="29299-112">É preciso atualizá-las manualmente.</span><span class="sxs-lookup"><span data-stu-id="29299-112">Instead, you need to update them manually.</span></span> <span data-ttu-id="29299-113">Use [Update statistics &#40;&#41;Transact-SQL](/sql/t-sql/statements/update-statistics-transact-sql) para colunas individuais, índices ou tabelas.</span><span class="sxs-lookup"><span data-stu-id="29299-113">Use [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql) for individual columns, indexes, or tables.</span></span> <span data-ttu-id="29299-114">Use [sp_updatestats &#40;&#41;Transact-SQL](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) para atualizar as estatísticas de todas as tabelas de usuário e internas no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="29299-114">Use [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) to update statistics for all user and internal tables in the database.</span></span>  
  
 <span data-ttu-id="29299-115">Ao usar [Create statistics &#40;Transact-sql&#41;](/sql/t-sql/statements/create-statistics-transact-sql) ou [atualizar estatísticas &#40;&#41;Transact-SQL ](/sql/t-sql/statements/update-statistics-transact-sql), você deve especificar `NORECOMPUTE` para desabilitar a atualização automática de estatísticas para tabelas com otimização de memória.</span><span class="sxs-lookup"><span data-stu-id="29299-115">When using [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql) or [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql), you must specify `NORECOMPUTE` to disable automatic statistics update for memory-optimized tables.</span></span> <span data-ttu-id="29299-116">Para tabelas baseadas em disco, [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) atualiza apenas as estatísticas se a tabela tiver sido modificada desde o último [Sp_updatestats &#40;&#41;Transact-SQL ](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="29299-116">For disk based tables, [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) only updates statistics if the table has been modified since the last [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span></span> <span data-ttu-id="29299-117">Para tabelas com otimização de memória, [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) sempre gera estatísticas atualizadas.</span><span class="sxs-lookup"><span data-stu-id="29299-117">For memory-optimized tables, [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) always generates updated statistics.</span></span> <span data-ttu-id="29299-118">[sp_updatestats &#40;&#41;Transact-SQL](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) é uma boa opção para tabelas com otimização de memória; caso contrário, você precisa saber quais tabelas têm alterações significativas para poder atualizar estatísticas individualmente.</span><span class="sxs-lookup"><span data-stu-id="29299-118">[sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) is a good option for memory-optimized tables; otherwise you need to know which tables have significant changes so you can update statistics individually.</span></span>  
  
 <span data-ttu-id="29299-119">As estatísticas podem ser geradas pela amostragem dos dados ou executando um exame completo.</span><span class="sxs-lookup"><span data-stu-id="29299-119">Statistics can either be generated by either sampling the data or performing a full scan.</span></span> <span data-ttu-id="29299-120">As estatísticas por amostra usam apenas uma amostra dos dados da tabela para estimar a distribuição de dados.</span><span class="sxs-lookup"><span data-stu-id="29299-120">Sampled statistics only use a sample of the table data to estimate the data distribution.</span></span> <span data-ttu-id="29299-121">As estatísticas por exame completo verificam a tabela inteira para determinar a distribuição de dados.</span><span class="sxs-lookup"><span data-stu-id="29299-121">Fullscan statistics scan the entire table to determine the data distribution.</span></span> <span data-ttu-id="29299-122">As estatísticas por exame completo geralmente são mais precisas, mas levam mais tempo para serem calculadas.</span><span class="sxs-lookup"><span data-stu-id="29299-122">Fullscan statistics are usually more accurate but take longer to compute.</span></span> <span data-ttu-id="29299-123">As estatísticas por amostra podem ser coletadas mais rapidamente.</span><span class="sxs-lookup"><span data-stu-id="29299-123">Sampled statistics can be collected faster.</span></span>  
  
 <span data-ttu-id="29299-124">As tabelas baseadas em disco usam estatísticas por amostra, por padrão.</span><span class="sxs-lookup"><span data-stu-id="29299-124">Disk-based tables use sampled statistics by default.</span></span> <span data-ttu-id="29299-125">As tabelas com otimização de memória oferecem suporte apenas às estatísticas por exame completo.</span><span class="sxs-lookup"><span data-stu-id="29299-125">Memory-optimized tables only support fullscan statistics.</span></span> <span data-ttu-id="29299-126">Ao usar [Create statistics &#40;Transact-sql&#41;](/sql/t-sql/statements/create-statistics-transact-sql) ou [atualizar estatísticas &#40;&#41;do Transact-SQL ](/sql/t-sql/statements/update-statistics-transact-sql), você deve especificar a `FULLSCAN` opção para tabelas com otimização de memória.</span><span class="sxs-lookup"><span data-stu-id="29299-126">When using [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql) or [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql), you must specify the `FULLSCAN` option for memory-optimized tables.</span></span>  
  
 <span data-ttu-id="29299-127">Considerações adicionais para estatísticas em tabelas com otimização de memória:</span><span class="sxs-lookup"><span data-stu-id="29299-127">Additional considerations for statistics on memory-optimized tables:</span></span>  
  
-   <span data-ttu-id="29299-128">Os índices nas tabelas com otimização de memória são criados com a tabela.</span><span class="sxs-lookup"><span data-stu-id="29299-128">Indexes on memory-optimized tables are created with the table.</span></span> <span data-ttu-id="29299-129">As estatísticas nas colunas de chave de índice são criadas quando a tabela está vazia.</span><span class="sxs-lookup"><span data-stu-id="29299-129">The statistics on the index key columns are created when the table is empty.</span></span> <span data-ttu-id="29299-130">Desse modo, essas estatísticas precisam ser atualizadas depois que os dados são isolados na tabela.</span><span class="sxs-lookup"><span data-stu-id="29299-130">Therefore, these statistics need to be updated after data is loaded into the table.</span></span>  
  
-   <span data-ttu-id="29299-131">Para procedimentos armazenados compilados nativamente, os planos de execução para consultas no procedimento são otimizados quando o procedimento é compilado.</span><span class="sxs-lookup"><span data-stu-id="29299-131">For natively compiled stored procedures, execution plans for queries in the procedure are optimized when the procedure is compiled.</span></span> <span data-ttu-id="29299-132">Isso acontece somente quando o procedimento é criado e quando o servidor é reiniciado, e não quando as estatísticas são atualizadas.</span><span class="sxs-lookup"><span data-stu-id="29299-132">This happens only when the procedure is created and when the server restarts, not when statistics are updated.</span></span> <span data-ttu-id="29299-133">Consequentemente, as tabelas precisam conter um conjunto de dados representativo, e as estatísticas precisam ser atualizadas antes que os procedimentos sejam criados.</span><span class="sxs-lookup"><span data-stu-id="29299-133">Therefore, the tables need to contain a representative set of data and statistics need to be up-to-date before the procedures are created.</span></span> <span data-ttu-id="29299-134">(Os procedimentos armazenados compilados nativamente serão recompilados se o banco de dados ficar offline e voltar a ficar online ou se houver uma reinicialização do servidor.)</span><span class="sxs-lookup"><span data-stu-id="29299-134">(Natively compiled stored procedures are recompiled if the database is taken offline and brought back online, or if there is a server restart.)</span></span>  
  
## <a name="guidelines-for-statistics-when-deploying-memory-optimized-tables"></a><span data-ttu-id="29299-135">Diretrizes para estatísticas ao implantar tabelas com otimização de memória</span><span class="sxs-lookup"><span data-stu-id="29299-135">Guidelines for Statistics When Deploying Memory-Optimized Tables</span></span>  
 <span data-ttu-id="29299-136">Para garantir que o otimizador de consulta tenha estatísticas atualizadas durante a criação de planos de consulta, implante tabelas com otimização de memória usando estas cinco etapas:</span><span class="sxs-lookup"><span data-stu-id="29299-136">To ensure that the query optimizer has up-to-date statistics when creating query plans, deploy memory-optimized tables using these five steps:</span></span>  
  
1.  <span data-ttu-id="29299-137">Crie tabelas e índices.</span><span class="sxs-lookup"><span data-stu-id="29299-137">Create tables and indexes.</span></span> <span data-ttu-id="29299-138">Os índices são especificados em linha nas instruções `CREATE TABLE`.</span><span class="sxs-lookup"><span data-stu-id="29299-138">Indexes are specified inline in the `CREATE TABLE` statements.</span></span>  
  
2.  <span data-ttu-id="29299-139">Carregue dados nas tabelas.</span><span class="sxs-lookup"><span data-stu-id="29299-139">Load data into the tables.</span></span>  
  
3.  <span data-ttu-id="29299-140">Atualize as estatísticas nas tabelas.</span><span class="sxs-lookup"><span data-stu-id="29299-140">Update statistics on the tables.</span></span>  
  
4.  <span data-ttu-id="29299-141">Crie procedimentos armazenados que acessam as tabelas.</span><span class="sxs-lookup"><span data-stu-id="29299-141">Create stored procedures that access the tables.</span></span>  
  
5.  <span data-ttu-id="29299-142">Execute a carga de trabalho, que pode conter uma mistura de procedimentos armazenados [!INCLUDE[tsql](../../../includes/tsql-md.md)] interpretado e compilados nativamente, bem como lotes ad hoc.</span><span class="sxs-lookup"><span data-stu-id="29299-142">Run the workload, which can contain a mix of natively compiled and interpreted [!INCLUDE[tsql](../../../includes/tsql-md.md)] stored procedures, as well as ad hoc batches.</span></span>  
  
 <span data-ttu-id="29299-143">A criação de procedimentos armazenados compilados nativamente após o carregamento dos dados e a atualização das estatísticas garante que o otimizador tenha estatísticas disponíveis para as tabelas com otimização de memória.</span><span class="sxs-lookup"><span data-stu-id="29299-143">Creating natively compiled stored procedures after you load the data and update the statistics ensures that the optimizer has statistics available for the memory-optimized tables.</span></span> <span data-ttu-id="29299-144">Isso garantirá planos de consulta eficientes quando o procedimento for compilado.</span><span class="sxs-lookup"><span data-stu-id="29299-144">This will ensure efficient query plans when the procedure is compiled.</span></span>  
  
## <a name="guidelines-for-maintaining-statistics-on-memory-optimized-tables"></a><span data-ttu-id="29299-145">Diretrizes para manter estatísticas em tabelas com otimização de memória</span><span class="sxs-lookup"><span data-stu-id="29299-145">Guidelines for Maintaining Statistics on Memory-Optimized Tables</span></span>  
 <span data-ttu-id="29299-146">Para manter as estatísticas atualizadas, atualize-as regularmente nas tabelas com otimização de memória.</span><span class="sxs-lookup"><span data-stu-id="29299-146">To keep statistics up-to-date, regularly update the statistics on memory-optimized tables.</span></span>  
  
 <span data-ttu-id="29299-147">Se os dados são alterados frequentemente, você deve atualizar as estatísticas com frequência.</span><span class="sxs-lookup"><span data-stu-id="29299-147">If data changes frequently, you should update statistics frequently.</span></span> <span data-ttu-id="29299-148">Por exemplo, atualize as estatísticas da tabelas após uma atualização do lote.</span><span class="sxs-lookup"><span data-stu-id="29299-148">For example, update table statistics after a batch update.</span></span> <span data-ttu-id="29299-149">Depois de atualizar as estatísticas, descarte e recrie os procedimentos armazenados compilados nativamente para que eles possam se beneficiar das estatísticas atualizadas.</span><span class="sxs-lookup"><span data-stu-id="29299-149">After you update statistics, drop and recreate natively compiled stored procedures so they can benefit from the updated statistics.</span></span>  
  
 <span data-ttu-id="29299-150">.</span><span class="sxs-lookup"><span data-stu-id="29299-150">.</span></span>  
  
 <span data-ttu-id="29299-151">Não atualize as estatísticas durante picos de carga de trabalho.</span><span class="sxs-lookup"><span data-stu-id="29299-151">Do not update statistics during peak workload.</span></span>  
  
 <span data-ttu-id="29299-152">Para atualizar estatísticas:</span><span class="sxs-lookup"><span data-stu-id="29299-152">To update statistics:</span></span>  
  
-   <span data-ttu-id="29299-153">Use [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] para [Create a Maintenance Plan](../maintenance-plans/create-a-maintenance-plan.md) com uma [Tarefa de Atualização de Estatísticas](../maintenance-plans/update-statistics-task-maintenance-plan.md)</span><span class="sxs-lookup"><span data-stu-id="29299-153">Use [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] to [Create a Maintenance Plan](../maintenance-plans/create-a-maintenance-plan.md) with an [Update Statistic Task](../maintenance-plans/update-statistics-task-maintenance-plan.md)</span></span>  
  
-   <span data-ttu-id="29299-154">Ou atualize estatísticas usando um script [!INCLUDE[tsql](../../../includes/tsql-md.md)] , conforme discutido abaixo.</span><span class="sxs-lookup"><span data-stu-id="29299-154">Or, update statistics through a [!INCLUDE[tsql](../../../includes/tsql-md.md)] script, as discussed below.</span></span>  
  
 <span data-ttu-id="29299-155">Para atualizar as estatísticas de uma única tabela com otimização de memória (*myschema*.</span><span class="sxs-lookup"><span data-stu-id="29299-155">To update the statistics for a single memory-optimized table (*myschema*.</span></span> <span data-ttu-id="29299-156">*Mytable*), execute o seguinte script:</span><span class="sxs-lookup"><span data-stu-id="29299-156">*Mytable*), run the following script:</span></span>  
  
```  
UPDATE STATISTICS myschema.Mytable WITH FULLSCAN, NORECOMPUTE  
```  
  
 <span data-ttu-id="29299-157">Para atualizar estatísticas de todas as tabelas com otimização de memória no banco de dados atual, execute o seguinte script:</span><span class="sxs-lookup"><span data-stu-id="29299-157">To update statistics for all memory-optimized tables in the current database, run the following script:</span></span>  
  
```sql  
DECLARE @sql NVARCHAR(MAX) = N''  
  
SELECT @sql += N'  
   UPDATE STATISTICS ' + quotename(schema_name(schema_id)) + N'.' + quotename(name) + N' WITH FULLSCAN, NORECOMPUTE'  
FROM sys.tables WHERE is_memory_optimized=1  
  
EXEC sp_executesql @sql  
```  
  
 <span data-ttu-id="29299-158">Para atualizar as estatísticas de todas as tabelas no banco de dados, execute [sp_updatestats &#40;&#41;Transact-SQL ](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="29299-158">To update statistics for all tables in the database, run [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span></span>  
  
 <span data-ttu-id="29299-159">O exemplo a seguir relata quando as estatísticas em tabelas com otimização de memória foram atualizadas pela última vez.</span><span class="sxs-lookup"><span data-stu-id="29299-159">The following sample reports when the statistics on memory-optimized tables were last updated.</span></span> <span data-ttu-id="29299-160">Essas informações podem ajudá-lo a decidir se você precisar atualizar as estatísticas.</span><span class="sxs-lookup"><span data-stu-id="29299-160">This information can help you decide if you need to update the statistics.</span></span>  
  
```sql  
select t.object_id, t.name, sp.last_updated as 'stats_last_updated'  
from sys.tables t join sys.stats s on t.object_id=s.object_id cross apply sys.dm_db_stats_properties(t.object_id, s.stats_id) sp  
where t.is_memory_optimized=1  
```  
  
## <a name="see-also"></a><span data-ttu-id="29299-161">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="29299-161">See Also</span></span>  
 [<span data-ttu-id="29299-162">Memory-Optimized Tables</span><span class="sxs-lookup"><span data-stu-id="29299-162">Memory-Optimized Tables</span></span>](memory-optimized-tables.md)  
  
  
