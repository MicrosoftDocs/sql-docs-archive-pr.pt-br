---
title: Restauração e recuperação de tabelas com otimização de memória | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
ms.assetid: 294975b7-e7d1-491b-b66a-fdb1100d2acc
author: CarlRabeler
ms.author: carlrab
ms.openlocfilehash: 5e702798ea68745a038407fb65af7726a5c5d50e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87576377"
---
# <a name="restore-and-recovery-of-memory-optimized-tables"></a><span data-ttu-id="90ea3-102">Restauração e recuperação de tabelas com otimização de memória</span><span class="sxs-lookup"><span data-stu-id="90ea3-102">Restore and Recovery of Memory-Optimized Tables</span></span>
  <span data-ttu-id="90ea3-103">O mecanismo básico para recuperar ou restaurar um banco de dados com tabelas com otimização de memória é semelhante a bancos de dados com apenas tabelas baseadas em disco.</span><span class="sxs-lookup"><span data-stu-id="90ea3-103">The basic mechanism to recover or restore a database with memory-optimized tables is similar to databases with only disk-based tables.</span></span> <span data-ttu-id="90ea3-104">Mas, de modo diferente das tabelas baseadas em disco, as tabelas com otimização de memória devem ser carregadas na memória antes que o banco de dados seja disponibilizado para o acesso de usuários.</span><span class="sxs-lookup"><span data-stu-id="90ea3-104">But unlike disk-based tables, memory-optimized tables must be loaded into memory before database is available for user access.</span></span> <span data-ttu-id="90ea3-105">Isso adiciona uma nova etapa na recuperação do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="90ea3-105">This adds a new step in the database recovery.</span></span> <span data-ttu-id="90ea3-106">As etapas modificadas na recuperação do banco de dados são alteradas como segue:</span><span class="sxs-lookup"><span data-stu-id="90ea3-106">The modified steps in database recovery are changed as follows:</span></span>

 <span data-ttu-id="90ea3-107">Quando o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] é reiniciado, cada banco de dados passa por uma fase de recuperação que consiste em três fases:</span><span class="sxs-lookup"><span data-stu-id="90ea3-107">When the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] restarts, each database goes through a recovery phase that consists of the following three phases:</span></span>

1.  <span data-ttu-id="90ea3-108">A fase de análise.</span><span class="sxs-lookup"><span data-stu-id="90ea3-108">The analysis phase.</span></span> <span data-ttu-id="90ea3-109">Durante essa fase, verificam-se os logs de transações ativas para detectar transações confirmadas e não confirmadas.</span><span class="sxs-lookup"><span data-stu-id="90ea3-109">During this phase, a pass is made on the active transaction logs to detect committed and uncommitted transactions.</span></span> <span data-ttu-id="90ea3-110">O mecanismo de OLTP na memória identifica o ponto de verificação para carregamento e pré-carrega suas entradas de log da tabela do sistema.</span><span class="sxs-lookup"><span data-stu-id="90ea3-110">The In-Memory OLTP engine identifies the checkpoint to load and preloads its system table log entries.</span></span> <span data-ttu-id="90ea3-111">Ele também processa alguns registros de log de alocação de arquivo.</span><span class="sxs-lookup"><span data-stu-id="90ea3-111">It will also process some file allocation log records.</span></span>

2.  <span data-ttu-id="90ea3-112">A fase refazer.</span><span class="sxs-lookup"><span data-stu-id="90ea3-112">The redo phase.</span></span> <span data-ttu-id="90ea3-113">Essa fase é executada simultaneamente em tabelas baseadas em disco e com otimização de memória.</span><span class="sxs-lookup"><span data-stu-id="90ea3-113">This phase is run concurrently on both disk-based and memory-optimized tables.</span></span>

     <span data-ttu-id="90ea3-114">Para tabelas baseadas em disco, o banco de dados é movido para o momento atual e adquire bloqueios usados por transações não confirmadas.</span><span class="sxs-lookup"><span data-stu-id="90ea3-114">For disk-based tables, the database is moved to the current point in time and acquires locks taken by uncommitted transactions.</span></span>

     <span data-ttu-id="90ea3-115">Para tabelas com otimização de memória, os dados dos pares de arquivos de dados e delta são carregados na memória. Depois, eles atualizam os dados com o log de transações ativas baseado no último ponto de verificação durável.</span><span class="sxs-lookup"><span data-stu-id="90ea3-115">For memory-optimized tables, data from the data and delta file pairs are loaded into memory and then update the data with the active transaction log based on the last durable checkpoint.</span></span>

     <span data-ttu-id="90ea3-116">Quando as operações acima em tabelas baseadas em disco e com otimização de memória são concluídas, o banco de dados está disponível para acesso.</span><span class="sxs-lookup"><span data-stu-id="90ea3-116">When the above operations on disk-based and memory-optimized tables are complete, the database is available for access.</span></span>

3.  <span data-ttu-id="90ea3-117">A fase desfazer.</span><span class="sxs-lookup"><span data-stu-id="90ea3-117">The undo phase.</span></span> <span data-ttu-id="90ea3-118">Nessa fase, as transações não confirmadas são revertidas.</span><span class="sxs-lookup"><span data-stu-id="90ea3-118">In this phase, the uncommitted transactions are rolled back.</span></span>

 <span data-ttu-id="90ea3-119">Carregar tabelas com otimização de memória na memória pode afetar o desempenho do RTO (objetivo de tempo de recuperação).</span><span class="sxs-lookup"><span data-stu-id="90ea3-119">Loading memory-optimized tables into memory can affect performance of the recovery time objective (RTO).</span></span> <span data-ttu-id="90ea3-120">Para melhorar o tempo de carregamento dos dados com otimização de memória em arquivos de dados e delta, o mecanismo OLTP na memória carrega os arquivos de dados/delta em paralelo desta forma:</span><span class="sxs-lookup"><span data-stu-id="90ea3-120">To improve the load time of memory-optimized data from data and delta files, the In-Memory OLTP engine loads the data/delta files in parallel as follows:</span></span>

-   <span data-ttu-id="90ea3-121">Criando um filtro de mapa delta.</span><span class="sxs-lookup"><span data-stu-id="90ea3-121">Creating a Delta Map Filter.</span></span> <span data-ttu-id="90ea3-122">Referências de repositórios de arquivos delta para as linhas excluídas.</span><span class="sxs-lookup"><span data-stu-id="90ea3-122">Delta files store references to the deleted rows.</span></span> <span data-ttu-id="90ea3-123">Um thread por contêiner lê os arquivos delta e cria um filtro de mapa delta.</span><span class="sxs-lookup"><span data-stu-id="90ea3-123">One thread per container reads the delta files and creates a delta map filter.</span></span> <span data-ttu-id="90ea3-124">(Um grupo de arquivos de dados com otimização de memória pode ter um ou mais contêineres.)</span><span class="sxs-lookup"><span data-stu-id="90ea3-124">(A memory optimized data filegroup can have one or more containers.)</span></span>

-   <span data-ttu-id="90ea3-125">Transmitindo os arquivos de dados.</span><span class="sxs-lookup"><span data-stu-id="90ea3-125">Streaming the data files.</span></span>  <span data-ttu-id="90ea3-126">Após a criação do filtro de mapa de delta, os arquivos de dados são lidos usando o número de threads que corresponde às CPUs lógicas existentes.</span><span class="sxs-lookup"><span data-stu-id="90ea3-126">Once the delta-map filter is created, data files are read using as many threads as there are logical CPUs.</span></span> <span data-ttu-id="90ea3-127">Cada thread que lê o arquivo de dados lê as linhas de dados, verifica o mapa delta associado, e só insere a linha na tabela se essa linha não foi marcada como excluída.</span><span class="sxs-lookup"><span data-stu-id="90ea3-127">Each thread reading the data file reads the data rows, checks the associated delta map and only inserts the row into table if this row has not been marked deleted.</span></span> <span data-ttu-id="90ea3-128">Esta parte da recuperação pode estar associada à CPU em alguns casos, conforme observado a seguir.</span><span class="sxs-lookup"><span data-stu-id="90ea3-128">This part of recovery can be CPU bound in some cases as noted below.</span></span>

 <span data-ttu-id="90ea3-129">![Tabelas com otimização de memória.](../../database-engine/media/memory-optimized-tables.gif "Tabelas com otimização de memória.")</span><span class="sxs-lookup"><span data-stu-id="90ea3-129">![Memory-optimized tables.](../../database-engine/media/memory-optimized-tables.gif "Memory-optimized tables.")</span></span>

 <span data-ttu-id="90ea3-130">As tabelas com otimização de memória normalmente podem ser carregadas na memória na velocidade de E/S, mas, em alguns casos, o carregamento de linhas de dados será mais lento.</span><span class="sxs-lookup"><span data-stu-id="90ea3-130">Memory-optimized tables can generally be loaded into memory at the speed of I/O but there are cases when loading data rows into memory will be slower.</span></span> <span data-ttu-id="90ea3-131">Os casos específicos são:</span><span class="sxs-lookup"><span data-stu-id="90ea3-131">Specific cases are:</span></span>

-   <span data-ttu-id="90ea3-132">O baixo número de buckets para o índice de hash pode levar à colisão excessiva, causando lentidão nas inserções de linhas de dados.</span><span class="sxs-lookup"><span data-stu-id="90ea3-132">Low bucket count for hash index can lead to excessive collision causing data row inserts to be slower.</span></span> <span data-ttu-id="90ea3-133">Em geral, isso resulta na alta utilização da CPU como um todo, especialmente no final da recuperação.</span><span class="sxs-lookup"><span data-stu-id="90ea3-133">This generally results in very high CPU utilization throughout, and especially towards the end of recovery.</span></span> <span data-ttu-id="90ea3-134">Se você configurou o índice de hash corretamente, ele não deve afetar o tempo de recuperação.</span><span class="sxs-lookup"><span data-stu-id="90ea3-134">If you configured the hash index correctly, it should not impact the recovery time.</span></span>

-   <span data-ttu-id="90ea3-135">Tabelas grandes com otimização de memória, com um ou mais índices não clusterizados, são diferentes de um índice de hash cujo número de buckets é dimensionado no momento de criação. Os índices não clusterizados crescem dinamicamente, resultando na alta utilização da CPU.</span><span class="sxs-lookup"><span data-stu-id="90ea3-135">Large memory-optimized tables with one or more nonclustered indexes, unlike a hash index whose bucket count is sized at create time, the nonclustered indexes grow dynamically, resulting in high CPU utilization.</span></span>

## <a name="restoring-a-database-with-memory-optimized-tables"></a><span data-ttu-id="90ea3-136">Restaurando um Banco de dados com tabelas com otimização de memória</span><span class="sxs-lookup"><span data-stu-id="90ea3-136">Restoring a Database with Memory-optimized tables</span></span>
 <span data-ttu-id="90ea3-137">Você sabe que tem memória suficiente no servidor para restaurar um banco de dados, mas há um requisito de memória necessária para o banco de dados que é contabilizada como parte de um Pool de recursos existente.</span><span class="sxs-lookup"><span data-stu-id="90ea3-137">You know that you have sufficient memory on the server to restore a database, but there's a requirement  that the memory needed by the database is accounted for as part of an existing Resource Pool.</span></span>  <span data-ttu-id="90ea3-138">Você sabe que não é possível criar a associação ao pool de recursos antes de o banco de dados existir, para que você execute a restauração WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="90ea3-138">You know that you cannot create the binding to the resource pool before the database exists, so you perform the restore WITH NORECOVERY.</span></span>  <span data-ttu-id="90ea3-139">Isso faz com que a imagem de disco do banco de dados seja restaurada e o banco de dados seja criado, mas nenhuma memória de OLTP na memória é consumida, porque o banco de dados não é colocado online.</span><span class="sxs-lookup"><span data-stu-id="90ea3-139">This causes the disk image of the database to be restored and the database to be created, but no In-Memory OLTP memory is consumed because the database is not brought online.</span></span>

 <span data-ttu-id="90ea3-140">Neste ponto, você pode criar o Pool de Recursos fazendo a associação do Banco de dados e, em seguida, usar RESTORE WITH RECOVERY para colocar o banco de dados restaurado online.</span><span class="sxs-lookup"><span data-stu-id="90ea3-140">At this point, you can create the Resource Pool to Database binding, and then use RESTORE WITH RECOVERY to bring the restored database online.</span></span>  <span data-ttu-id="90ea3-141">Assim que a associação estiver em vigor, antes de o banco de dados ser colocado online, o seu consumo de memória do OLTP na memória é contabilizado corretamente.</span><span class="sxs-lookup"><span data-stu-id="90ea3-141">Since the binding is in place before the database is brought online, its In-Memory OLTP memory consumption is properly accounted for.</span></span> <span data-ttu-id="90ea3-142">Isso requer que o banco de dados seja restaurado apenas uma vez.</span><span class="sxs-lookup"><span data-stu-id="90ea3-142">This requires restoring the database only once.</span></span> <span data-ttu-id="90ea3-143">O primeiro comando RESTORE é um comando informativo que lê apenas o cabeçalho do backup e o último comando simplesmente aciona a recuperação sem, de fato, restaurar qualquer bit.</span><span class="sxs-lookup"><span data-stu-id="90ea3-143">The first RESTORE command is an informational command that only reads the backup header, and the last command simply triggers recovery without actually restoring any bits.</span></span>

## <a name="see-also"></a><span data-ttu-id="90ea3-144">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="90ea3-144">See Also</span></span>
 [<span data-ttu-id="90ea3-145">Backup, restauração e recuperação de tabelas com otimização de memória</span><span class="sxs-lookup"><span data-stu-id="90ea3-145">Backup, Restore, and Recovery of Memory-Optimized Tables</span></span>](memory-optimized-tables.md)


