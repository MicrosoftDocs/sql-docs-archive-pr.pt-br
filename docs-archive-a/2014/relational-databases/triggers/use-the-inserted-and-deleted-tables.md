---
title: Usar as tabelas inseridas e excluídas | Microsoft
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- inserted tables
- UPDATE statement [SQL Server], DML triggers
- DELETE statement [SQL Server], DML triggers
- INSTEAD OF triggers
- deleted tables
- INSERT statement [SQL Server], DML triggers
- DML triggers, deleted or inserted tables
ms.assetid: ed84567f-7b91-4b44-b5b2-c400bda4590d
author: rothja
ms.author: jroth
ms.openlocfilehash: facc534177113bd93e56e50fca3ae14c3e6b2cfc
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87582859"
---
# <a name="use-the-inserted-and-deleted-tables"></a><span data-ttu-id="80cd9-102">Usar as tabelas inseridas e excluídas</span><span class="sxs-lookup"><span data-stu-id="80cd9-102">Use the inserted and deleted Tables</span></span>
  <span data-ttu-id="80cd9-103">As instruções de gatilho DML usam duas tabelas especiais: a tabela excluída e as tabelas inseridas.</span><span class="sxs-lookup"><span data-stu-id="80cd9-103">DML trigger statements use two special tables: the deleted table and the inserted tables.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="80cd9-104">cria e gerencia automaticamente essas tabelas.</span><span class="sxs-lookup"><span data-stu-id="80cd9-104">automatically creates and manages these tables.</span></span> <span data-ttu-id="80cd9-105">É possível usar essas tabelas temporárias, residentes na memória, para testar os efeitos de algumas modificações de dados e para definir critérios para ações de gatilhos DML.</span><span class="sxs-lookup"><span data-stu-id="80cd9-105">You can use these temporary, memory-resident tables to test the effects of certain data modifications and to set conditions for DML trigger actions.</span></span> <span data-ttu-id="80cd9-106">Você não pode modificar diretamente os dados nas tabelas nem executar operações DDL (linguagem de definição de dados) nas tabelas, como CREATE INDEX.</span><span class="sxs-lookup"><span data-stu-id="80cd9-106">You cannot directly modify the data in the tables or perform data definition language (DDL) operations on the tables, such as CREATE INDEX.</span></span>  
  
 <span data-ttu-id="80cd9-107">Nos gatilhos DML, as tabelas inseridas e excluídas são usadas principalmente para executar o seguinte:</span><span class="sxs-lookup"><span data-stu-id="80cd9-107">In DML triggers, the inserted and deleted tables are primarily used to perform the following:</span></span>  
  
-   <span data-ttu-id="80cd9-108">Estender a integridade referencial entre as tabelas.</span><span class="sxs-lookup"><span data-stu-id="80cd9-108">Extend referential integrity between tables.</span></span>  
  
-   <span data-ttu-id="80cd9-109">Inserir ou atualizar dados nas tabelas adjacentes da exibição.</span><span class="sxs-lookup"><span data-stu-id="80cd9-109">Insert or update data in base tables underlying a view.</span></span>  
  
-   <span data-ttu-id="80cd9-110">Testar quanto a erros e aplicar as ações com base no erro.</span><span class="sxs-lookup"><span data-stu-id="80cd9-110">Test for errors and take action based on the error.</span></span>  
  
-   <span data-ttu-id="80cd9-111">Identificar a diferença entre o estado de uma tabela antes e depois da modificação dos dados e executar ações com base nessa diferença.</span><span class="sxs-lookup"><span data-stu-id="80cd9-111">Find the difference between the state of a table before and after a data modification and take actions based on that difference.</span></span>  
  
 <span data-ttu-id="80cd9-112">A tabela excluída armazena cópias das linhas afetadas durante as instruções DELETE e UPDATE.</span><span class="sxs-lookup"><span data-stu-id="80cd9-112">The deleted table stores copies of the affected rows during DELETE and UPDATE statements.</span></span> <span data-ttu-id="80cd9-113">Durante a execução da instrução DELETE ou UPDATE, as linhas são excluídas da tabela de gatilhos e transferidas para a tabela excluída.</span><span class="sxs-lookup"><span data-stu-id="80cd9-113">During the execution of a DELETE or UPDATE statement, rows are deleted from the trigger table and transferred to the deleted table.</span></span> <span data-ttu-id="80cd9-114">A tabela excluída e a tabela de gatilhos geralmente não têm nenhuma linha em comum.</span><span class="sxs-lookup"><span data-stu-id="80cd9-114">The deleted table and the trigger table ordinarily have no rows in common.</span></span>  
  
 <span data-ttu-id="80cd9-115">A tabela inserida armazena cópias das linhas afetadas durante as instruções INSERT e UPDATE.</span><span class="sxs-lookup"><span data-stu-id="80cd9-115">The inserted table stores copies of the affected rows during INSERT and UPDATE statements.</span></span> <span data-ttu-id="80cd9-116">Durante uma transação de inserção ou de atualização, novas linhas são adicionadas à tabela inserida e à tabela de gatilho.</span><span class="sxs-lookup"><span data-stu-id="80cd9-116">During an insert or update transaction, new rows are added to both the inserted table and the trigger table.</span></span> <span data-ttu-id="80cd9-117">As linhas na tabela inserida são cópias das novas linhas na tabela de gatilhos.</span><span class="sxs-lookup"><span data-stu-id="80cd9-117">The rows in the inserted table are copies of the new rows in the trigger table.</span></span>  
  
 <span data-ttu-id="80cd9-118">Uma transação de atualização é semelhante à operação de exclusão seguida por uma operação de inserção, as linhas antigas são copiadas primeiro na tabela excluída e, em seguida, as novas linhas são copiadas na tabela de gatilhos e na tabela inserida.</span><span class="sxs-lookup"><span data-stu-id="80cd9-118">An update transaction is similar to a delete operation followed by an insert operation; the old rows are copied to the deleted table first, and then the new rows are copied to the trigger table and to the inserted table.</span></span>  
  
 <span data-ttu-id="80cd9-119">Quando você definir os critérios para o gatilho, use adequadamente as tabelas inseridas e excluídas para a ação que acionou o gatilho.</span><span class="sxs-lookup"><span data-stu-id="80cd9-119">When you set trigger conditions, use the inserted and deleted tables appropriately for the action that fired the trigger.</span></span> <span data-ttu-id="80cd9-120">Embora referenciando a tabela excluída quando testar INSERT ou a tabela inserida quando testar DELETE não cause qualquer erro, essas tabelas de teste de gatilhos não contêm nenhuma linha nesses casos.</span><span class="sxs-lookup"><span data-stu-id="80cd9-120">Although referencing the deleted table when testing an INSERT or the inserted table when testing a DELETE does not cause any errors, these trigger test tables do not contain any rows in these cases.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="80cd9-121">Se as ações de gatilhos dependem do número de linhas que uma modificação de dados afeta, use os testes (como um exame de @@ROWCOUNT) para modificações de dados em várias linhas (uma instrução INSERT, DELETE ou UPDATE com base em uma instrução SELECT) e execute as ações apropriadas.</span><span class="sxs-lookup"><span data-stu-id="80cd9-121">If trigger actions depend on the number of rows a data modification effects, use tests (such as an examination of @@ROWCOUNT) for multirow data modifications (an INSERT, DELETE, or UPDATE based on a SELECT statement), and take appropriate actions.</span></span>  
  
 <span data-ttu-id="80cd9-122">O [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] não permite referências de coluna de `text`, `ntext` ou `image` nas tabelas inseridas e excluídas para gatilhos AFTER.</span><span class="sxs-lookup"><span data-stu-id="80cd9-122">[!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] does not allow for `text`, `ntext`, or `image` column references in the inserted and deleted tables for AFTER triggers.</span></span> <span data-ttu-id="80cd9-123">Entretanto, esses tipos de dados são incluídos somente para fins de compatibilidade com versões anteriores.</span><span class="sxs-lookup"><span data-stu-id="80cd9-123">However, these data types are included for backward compatibility purposes only.</span></span> <span data-ttu-id="80cd9-124">É preferível armazenar dados grandes usando os tipos de dados `varchar(max)`, `nvarchar(max)` e `varbinary(max)`.</span><span class="sxs-lookup"><span data-stu-id="80cd9-124">The preferred storage for large data is to use the `varchar(max)`, `nvarchar(max)`, and `varbinary(max)` data types.</span></span> <span data-ttu-id="80cd9-125">Os gatilhos AFTER e INSTEAD OF oferecem suporte aos dados `varchar(max)`, `nvarchar(max)` e `varbinary(max)` nas tabelas inseridas e excluídas.</span><span class="sxs-lookup"><span data-stu-id="80cd9-125">Both AFTER and INSTEAD OF triggers support `varchar(max)`, `nvarchar(max)`, and `varbinary(max)` data in the inserted and deleted tables.</span></span> <span data-ttu-id="80cd9-126">Para obter mais informações, veja [CREATE TRIGGER &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-trigger-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="80cd9-126">For more information, see [CREATE TRIGGER &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-trigger-transact-sql).</span></span>  
  
 <span data-ttu-id="80cd9-127">**Um exemplo do uso de tabela inserida em um gatilho para impor regras de negócio**</span><span class="sxs-lookup"><span data-stu-id="80cd9-127">**An Example of Using the inserted Table in a Trigger to Enforce Business Rules**</span></span>  
  
 <span data-ttu-id="80cd9-128">Como as restrições CHECK só podem referenciar as colunas nas quais a restrição de nível de coluna ou de nível de tabela é definida, qualquer restrição de tabela cruzada (neste caso, as regras de negócio) deverá ser definida como gatilho.</span><span class="sxs-lookup"><span data-stu-id="80cd9-128">Because CHECK constraints can reference only the columns on which the column-level or table-level constraint is defined, any cross-table constraints (in this case, business rules) must be defined as triggers.</span></span>  
  
 <span data-ttu-id="80cd9-129">O exemplo a seguir cria um gatilho DML.</span><span class="sxs-lookup"><span data-stu-id="80cd9-129">The following example creates a DML trigger.</span></span> <span data-ttu-id="80cd9-130">Esse gatilho realiza uma verificação para ter certeza de que a avaliação de crédito do fornecedor é satisfatória quando for efetuar uma tentativa para inserir uma nova ordem de compra na tabela `PurchaseOrderHeader` .</span><span class="sxs-lookup"><span data-stu-id="80cd9-130">This trigger checks to make sure the credit rating for the vendor is good when an attempt is made to insert a new purchase order into the `PurchaseOrderHeader` table.</span></span> <span data-ttu-id="80cd9-131">Para obter a avaliação de crédito do fornecedor correspondente à ordem de compra que acaba de ser inserida, a tabela `Vendor` deve ser referenciada e associada a uma tabela inserida.</span><span class="sxs-lookup"><span data-stu-id="80cd9-131">To obtain the credit rating of the vendor corresponding to the purchase order that was just inserted, the `Vendor` table must be referenced and joined with the inserted table.</span></span> <span data-ttu-id="80cd9-132">Se a classificação de crédito for muito baixa, uma mensagem será exibida e a inserção não será executada.</span><span class="sxs-lookup"><span data-stu-id="80cd9-132">If the credit rating is too low, a message is displayed and the insertion does not execute.</span></span> <span data-ttu-id="80cd9-133">Observe que este exemplo não permite modificações de dados de multilinha.</span><span class="sxs-lookup"><span data-stu-id="80cd9-133">Note that this example does not allow for multirow data modifications.</span></span> <span data-ttu-id="80cd9-134">Para obter mais informações, veja [Criar gatilhos DML para tratar várias linhas de dados](../triggers/create-dml-triggers-to-handle-multiple-rows-of-data.md).</span><span class="sxs-lookup"><span data-stu-id="80cd9-134">For more information, see [Create DML Triggers to Handle Multiple Rows of Data](../triggers/create-dml-triggers-to-handle-multiple-rows-of-data.md).</span></span>  
  
 [!code-sql[TriggerDDL#CreateTrigger3](../../snippets/tsql/SQL14/tsql/triggerddl/transact-sql/snippet_create_alter_drop_trigger.sql#createtrigger3)]  
  
## <a name="using-the-inserted-and-deleted-tables-in-instead-of-triggers"></a><span data-ttu-id="80cd9-135">Usando as tabelas inseridas e excluídas em gatilhos INSTEAD OF</span><span class="sxs-lookup"><span data-stu-id="80cd9-135">Using the inserted and deleted Tables in INSTEAD OF Triggers</span></span>  
 <span data-ttu-id="80cd9-136">As tabelas inseridas e excluídas passadas para os gatilhos INSTEAD OF definidos nas tabelas seguem as mesmas regras das tabelas inseridas e excluídas passadas para os gatilhos AFTER.</span><span class="sxs-lookup"><span data-stu-id="80cd9-136">The inserted and deleted tables passed to INSTEAD OF triggers defined on tables follow the same rules as the inserted and deleted tables passed to AFTER triggers.</span></span> <span data-ttu-id="80cd9-137">O formato das tabelas inseridas e excluídas é o mesmo do formato da tabela na qual o gatilho INSTEAD OF está definido.</span><span class="sxs-lookup"><span data-stu-id="80cd9-137">The format of the inserted and deleted tables is the same as the format of the table on which the INSTEAD OF trigger is defined.</span></span> <span data-ttu-id="80cd9-138">Cada coluna das tabelas inseridas e excluídas é mapeada diretamente para uma coluna na tabela base.</span><span class="sxs-lookup"><span data-stu-id="80cd9-138">Each column in the inserted and deleted tables maps directly to a column in the base table.</span></span>  
  
 <span data-ttu-id="80cd9-139">As regras a seguir, relativas a quando uma instrução INSERT ou UPDATE, que faz referência a uma tabela com um gatilho INSTEAD OF, deve fornecer valores para colunas, são as mesmas, como se a tabela não tivesse um gatilho INSTEAD OF:</span><span class="sxs-lookup"><span data-stu-id="80cd9-139">The following rules regarding when an INSERT or UPDATE statement referencing a table with an INSTEAD OF trigger must supply values for columns are the same as if the table did not have an INSTEAD OF trigger:</span></span>  
  
-   <span data-ttu-id="80cd9-140">Valores não podem ser especificados para colunas computadas ou colunas com tipo de dados `timestamp`.</span><span class="sxs-lookup"><span data-stu-id="80cd9-140">Values cannot be specified for computed columns or columns with a `timestamp` data type.</span></span>  
  
-   <span data-ttu-id="80cd9-141">Valores não podem ser especificados com uma propriedade IDENTITY, a menos que IDENTITY_INSERT seja ON para aquela tabela.</span><span class="sxs-lookup"><span data-stu-id="80cd9-141">Values cannot be specified for columns with an IDENTITY property, unless IDENTITY_INSERT is ON for that table.</span></span> <span data-ttu-id="80cd9-142">Quando IDENTITY_INSERT for ON, as instruções INSERT devem fornecer um valor.</span><span class="sxs-lookup"><span data-stu-id="80cd9-142">When IDENTITY_INSERT is ON, INSERT statements must supply a value.</span></span>  
  
-   <span data-ttu-id="80cd9-143">As instruções INSERT devem fornecer valores para todas as colunas NOT NULL que não têm restrições DEFAULT.</span><span class="sxs-lookup"><span data-stu-id="80cd9-143">INSERT statements must supply values for all NOT NULL columns that do not have DEFAULT constraints.</span></span>  
  
-   <span data-ttu-id="80cd9-144">Para qualquer coluna exceto computada, identidade ou colunas `timestamp`, os valores são opcionais para qualquer coluna que permita nulos ou qualquer coluna NOT NULL que tenha uma definição DEFAULT.</span><span class="sxs-lookup"><span data-stu-id="80cd9-144">For any columns except computed, identity, or `timestamp` columns, values are optional for any column that allows nulls, or any NOT NULL column that has a DEFAULT definition.</span></span>  
  
 <span data-ttu-id="80cd9-145">Quando uma instrução INSERT, UPDATE ou DELETE faz referência a uma exibição que tenha um gatilho INSTEAD OF, o [!INCLUDE[ssDE](../../includes/ssde-md.md)] chama o gatilho em vez de tomar qualquer ação direta contra qualquer tabela.</span><span class="sxs-lookup"><span data-stu-id="80cd9-145">When an INSERT, UPDATE, or DELETE statement references a view that has an INSTEAD OF trigger, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] calls the trigger instead of taking any direct action against any table.</span></span> <span data-ttu-id="80cd9-146">O gatilho deve usar as informações apresentadas nas tabelas inseridas e excluídas para construir as instruções necessárias para implementar a ação solicitada nas tabelas base, mesmo quando o formato das informações nas tabelas inseridas e excluídas construído para a exibição for diferente do formato dos dados nas tabelas base.</span><span class="sxs-lookup"><span data-stu-id="80cd9-146">The trigger must use the information presented in the inserted and deleted tables to build any statements required to implement the requested action in the base tables, even when the format of the information in the inserted and deleted tables built for the view is different from the format of the data in the base tables.</span></span>  
  
 <span data-ttu-id="80cd9-147">O formato das tabelas inseridas e excluídas passadas para o gatilho INSTEAD OF definido em uma exibição corresponde à lista de seleção da instrução SELECT definida para exibição.</span><span class="sxs-lookup"><span data-stu-id="80cd9-147">The format of the inserted and deleted tables passed to an INSTEAD OF trigger defined on a view matches the select list of the SELECT statement defined for the view.</span></span> <span data-ttu-id="80cd9-148">Por exemplo: </span><span class="sxs-lookup"><span data-stu-id="80cd9-148">For example:</span></span>  
  
```  
USE AdventureWorks2012;  
GO  
CREATE VIEW dbo.EmployeeNames (BusinessEntityID, LName, FName)  
AS  
SELECT e.BusinessEntityID, p.LastName, p.FirstName  
FROM HumanResources.Employee AS e   
JOIN Person.Person AS p  
ON e.BusinessEntityID = p.BusinessEntityID;  
```  
  
 <span data-ttu-id="80cd9-149">O conjunto de resultados desta exibição tem três colunas: uma coluna `int` e duas colunas `nvarchar`.</span><span class="sxs-lookup"><span data-stu-id="80cd9-149">The result set for this view has three columns: an `int` column and two `nvarchar` columns.</span></span> <span data-ttu-id="80cd9-150">As tabelas inseridas e excluídas passadas para um gatilho INSTEAD OF definido em uma exibição têm também uma coluna `int` denominada `BusinessEntityID`, uma coluna `nvarchar` denominada `LName` e uma coluna `nvarchar` denominada `FName`.</span><span class="sxs-lookup"><span data-stu-id="80cd9-150">The inserted and deleted tables passed to an INSTEAD OF trigger defined on the view also have an `int` column named `BusinessEntityID`, an `nvarchar` column named `LName`, and an `nvarchar` column named `FName`.</span></span>  
  
 <span data-ttu-id="80cd9-151">A lista de seleção de uma exibição pode também conter expressões que não mapeiam diretamente uma única coluna com base em tabelas.</span><span class="sxs-lookup"><span data-stu-id="80cd9-151">The select list of a view can also contain expressions that do not directly map to a single base-table column.</span></span> <span data-ttu-id="80cd9-152">Algumas expressões de exibição, como um chamado de função ou de constante, podem não fazer referência a nenhuma coluna e podem ser ignoradas.</span><span class="sxs-lookup"><span data-stu-id="80cd9-152">Some view expressions, such as a constant or function invocation, may not reference any columns and can be ignored.</span></span> <span data-ttu-id="80cd9-153">Expressões complexas podem referenciar várias colunas, mesmo assim as colunas inseridas e excluídas têm apenas um valor para cada linha inserida.</span><span class="sxs-lookup"><span data-stu-id="80cd9-153">Complex expressions can reference multiple columns, yet the inserted and deleted tables have only one value for each inserted row.</span></span> <span data-ttu-id="80cd9-154">As mesmas questões se aplicam às expressões simples em uma exibição, caso elas façam referência a uma coluna computada que tenha uma expressão complexa.</span><span class="sxs-lookup"><span data-stu-id="80cd9-154">The same issues apply to simple expressions in a view if they reference a computed column that has a complex expression.</span></span> <span data-ttu-id="80cd9-155">Um gatilho INSTEAD OF na exibição deve tratar desses tipos de expressões.</span><span class="sxs-lookup"><span data-stu-id="80cd9-155">An INSTEAD OF trigger on the view must handle these types of expressions.</span></span>  
  
  
