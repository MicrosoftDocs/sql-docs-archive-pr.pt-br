---
title: Gatilhos de logon | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
f1_keywords:
- logon triggers
- login triggers
helpviewer_keywords:
- triggers [SQL Server], logon
ms.assetid: 2f0ebb2f-de10-482d-9806-1a5de5b312b8
author: rothja
ms.author: jroth
ms.openlocfilehash: cda0be25f07ed2ee283b9707884041e7c6e4692f
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87582865"
---
# <a name="logon-triggers"></a><span data-ttu-id="fcd9c-102">Gatilhos de logon</span><span class="sxs-lookup"><span data-stu-id="fcd9c-102">Logon Triggers</span></span>
  <span data-ttu-id="fcd9c-103">Os gatilhos de logon acionam procedimentos armazenados em resposta a um evento LOGON.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-103">Logon triggers fire stored procedures in response to a LOGON event.</span></span> <span data-ttu-id="fcd9c-104">Esse evento ocorre quando é estabelecida uma sessão de usuário com uma instância do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="fcd9c-104">This event is raised when a user session is established with an instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="fcd9c-105">Os gatilhos de logon são acionados após o término da fase de autenticação, mas antes da sessão de usuário ser realmente estabelecida.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-105">Logon triggers fire after the authentication phase of logging in finishes, but before the user session is actually established.</span></span> <span data-ttu-id="fcd9c-106">Logo, todas as mensagens originadas no gatilho que chegariam, normalmente, ao usuário, como mensagens de erro e mensagens da instrução PRINT, são desviadas para o log de erros do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="fcd9c-106">Therefore, all messages originating inside the trigger that would typically reach the user, such as error messages and messages from the PRINT statement, are diverted to the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log.</span></span> <span data-ttu-id="fcd9c-107">Os gatilhos de logon não são acionados quando a autenticação falha.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-107">Logon triggers do not fire if authentication fails.</span></span>  
  
 <span data-ttu-id="fcd9c-108">Você pode usar gatilhos de logon para auditar e controlar sessões do servidor, por exemplo, rastreando a atividade de logon, restringindo os logons ao [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]ou limitando o número de sessões para um logon específico.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-108">You can use logon triggers to audit and control server sessions, such as by tracking login activity, restricting logins to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], or limiting the number of sessions for a specific login.</span></span> <span data-ttu-id="fcd9c-109">Por exemplo, no código abaixo, o gatilho de logon negará as tentativas de logon no [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] iniciadas por *login_test* se já houver três sessões de usuário criadas pelo logon em questão.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-109">For example, in the following code, the logon trigger denies log in attempts to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] initiated by login *login_test* if there are already three user sessions created by that login.</span></span>  
  
 [!code-sql[TriggerDDL#LogonTrigger1](../../snippets/tsql/SQL14/tsql/triggerddl/transact-sql/snippet_create_alter_drop_trigger.sql#logontrigger1)]  
  
 <span data-ttu-id="fcd9c-110">Observe que o evento LOGON corresponde ao evento AUDIT_LOGIN do Rastreamento do SQL, que pode ser usado em [Notificações de Eventos](../service-broker/event-notifications.md).</span><span class="sxs-lookup"><span data-stu-id="fcd9c-110">Note that the LOGON event corresponds to the AUDIT_LOGIN SQL Trace event, which can be used in [Event Notifications](../service-broker/event-notifications.md).</span></span> <span data-ttu-id="fcd9c-111">A principal diferença entre gatilhos e notificações de evento é que os primeiros ocorrem de maneira síncrona com os eventos, ao passo que os últimos são assíncronos.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-111">The primary difference between triggers and event notifications is that triggers are raised synchronously with events, whereas event notifications are asynchronous.</span></span> <span data-ttu-id="fcd9c-112">Isso significa, por exemplo, que se quiser interromper o estabelecimento de uma sessão, você deve usar um gatilho de logon.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-112">This means, for example, that if you want to stop a session from being established, you must use a logon trigger.</span></span> <span data-ttu-id="fcd9c-113">Uma notificação de evento em um evento AUDIT_LOGIN não pode ser usada para esse fim.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-113">An event notification on an AUDIT_LOGIN event cannot be used for this purpose.</span></span>  
  
## <a name="specifying-first-and-last-trigger"></a><span data-ttu-id="fcd9c-114">Especificando o primeiro e o último gatilhos</span><span class="sxs-lookup"><span data-stu-id="fcd9c-114">Specifying First and Last Trigger</span></span>  
 <span data-ttu-id="fcd9c-115">Vários gatilhos podem ser definidos no evento LOGON.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-115">Multiple triggers can be defined on the LOGON event.</span></span> <span data-ttu-id="fcd9c-116">Qualquer um deles pode ser designado como o primeiro ou último gatilho a ser disparado mediante em um evento por meio do procedimento armazenado do sistema [sp_settriggerorder](/sql/relational-databases/system-stored-procedures/sp-settriggerorder-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="fcd9c-116">Any one of these triggers can be designated the first or last trigger to be fired on an event by using the [sp_settriggerorder](/sql/relational-databases/system-stored-procedures/sp-settriggerorder-transact-sql) system stored procedure.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="fcd9c-117">não garante a ordem de execução dos gatilhos restantes.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-117">does not guarantee the execution order of the remaining triggers.</span></span>  
  
## <a name="managing-transactions"></a><span data-ttu-id="fcd9c-118">Gerenciando transações</span><span class="sxs-lookup"><span data-stu-id="fcd9c-118">Managing Transactions</span></span>  
 <span data-ttu-id="fcd9c-119">Antes de o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] disparar um gatilho de logon, o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] cria uma transação implícita independente de qualquer transação de usuário.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-119">Before [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] fires a logon trigger, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] creates an implicit transaction that is independent from any user transaction.</span></span> <span data-ttu-id="fcd9c-120">Assim, quando o primeiro gatilho de logon é acionado, a contagem de transações é 1.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-120">Therefore, when the first logon trigger starts firing, the transaction count is 1.</span></span> <span data-ttu-id="fcd9c-121">Terminada a execução de todos os gatilhos de logon, a transação é confirmada.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-121">After all the logon triggers finish executing, the transaction commits.</span></span> <span data-ttu-id="fcd9c-122">Como em outros tipos de gatilhos, o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] retornará um erro se o gatilho de logon terminar a execução com uma contagem de transações de 0.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-122">As with other types of triggers, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] returns an error if a logon trigger finishes execution with a transaction count of 0.</span></span> <span data-ttu-id="fcd9c-123">A instrução ROLLBACK TRANSACTION zera a contagem de transações, mesmo quando é emitida dentro de uma transação aninhada.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-123">The ROLLBACK TRANSACTION statement resets the transaction count to 0, even if the statement is issued inside a nested transaction.</span></span> <span data-ttu-id="fcd9c-124">COMMIT TRANSACTION pode decrementar a contagem de transações para 0.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-124">COMMIT TRANSACTION might decrement the transaction count to 0.</span></span> <span data-ttu-id="fcd9c-125">Logo, nós não aconselhamos emitir instruções COMMIT TRANSACTION dentro de gatilhos de logon.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-125">Therefore, we advise against issuing COMMIT TRANSACTION statements inside logon triggers.</span></span>  
  
 <span data-ttu-id="fcd9c-126">Considere o seguinte ao usar uma instrução ROLLBACK TRANSACTION dentro de gatilhos de logon:</span><span class="sxs-lookup"><span data-stu-id="fcd9c-126">Consider the following when you are using a ROLLBACK TRANSACTION statement inside logon triggers:</span></span>  
  
-   <span data-ttu-id="fcd9c-127">Toda modificação de dados efetuada até o ponto de ROLLBACK TRANSACTION é revertida.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-127">Any data modifications made up to the point of ROLLBACK TRANSACTION are rolled back.</span></span> <span data-ttu-id="fcd9c-128">Isso inclui modificações feitas pelo gatilho atual e por gatilhos anteriores executados no mesmo evento.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-128">These modifications include those made by the current trigger and those made by previous triggers that executed on the same event.</span></span> <span data-ttu-id="fcd9c-129">Quaisquer gatilhos restantes para o evento específico não são executados.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-129">Any remaining triggers for the specific event are not executed.</span></span>  
  
-   <span data-ttu-id="fcd9c-130">O gatilho atual continua a executar todas as instruções restantes que apareçam depois da instrução ROLLBACK.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-130">The current trigger continues to execute any remaining statements that appear after the ROLLBACK statement.</span></span> <span data-ttu-id="fcd9c-131">Se alguma dessas instruções modificar dados, as modificações não serão revertidas.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-131">If any of these statements modify data, the modifications are not rolled back.</span></span>  
  
 <span data-ttu-id="fcd9c-132">Não será estabelecida uma sessão de usuário se ocorrer uma das seguintes condições durante a execução de um gatilho em um evento LOGON:</span><span class="sxs-lookup"><span data-stu-id="fcd9c-132">A user session is not established if any one of the following conditions occur during execution of a trigger on a LOGON event:</span></span>  
  
-   <span data-ttu-id="fcd9c-133">A transação implícita original é revertida ou falha.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-133">The original implicit transaction is rolled back or fails.</span></span>  
  
-   <span data-ttu-id="fcd9c-134">Um erro com severidade maior que 20 é emitido dentro do corpo do gatilho.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-134">An error that has severity greater than 20 is raised inside the trigger body.</span></span>  
  
## <a name="disabling-a-logon-trigger"></a><span data-ttu-id="fcd9c-135">Desabilitando um gatilho de logon</span><span class="sxs-lookup"><span data-stu-id="fcd9c-135">Disabling a Logon Trigger</span></span>  
 <span data-ttu-id="fcd9c-136">Um gatilho de logon pode, efetivamente, impedir conexões com o [!INCLUDE[ssDE](../../../includes/ssde-md.md)] para todos os usuários, incluindo membros da função de servidor fixa `sysadmin`.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-136">A logon trigger can effectively prevent successful connections to the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] for all users, including members of the `sysadmin` fixed server role.</span></span> <span data-ttu-id="fcd9c-137">Quando um gatilho de logon está impedindo conexões, os membros da função de servidor fixa `sysadmin` podem se conectar usando a conexão de administrador dedicada ou iniciando o [!INCLUDE[ssDE](../../../includes/ssde-md.md)] no modo de configuração mínima (-f).</span><span class="sxs-lookup"><span data-stu-id="fcd9c-137">When a logon trigger is preventing connections, members of the `sysadmin` fixed server role can connect by using the dedicated administrator connection, or by starting the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] in minimal configuration mode (-f).</span></span> <span data-ttu-id="fcd9c-138">Para obter mais informações, consulte [Opções de inicialização do serviço Mecanismo de Banco de Dados](../../database-engine/configure-windows/database-engine-service-startup-options.md).</span><span class="sxs-lookup"><span data-stu-id="fcd9c-138">For more information, see [Database Engine Service Startup Options](../../database-engine/configure-windows/database-engine-service-startup-options.md).</span></span>  
  
## <a name="related-tasks"></a><span data-ttu-id="fcd9c-139">Related Tasks</span><span class="sxs-lookup"><span data-stu-id="fcd9c-139">Related Tasks</span></span>  
  
|<span data-ttu-id="fcd9c-140">Tarefa</span><span class="sxs-lookup"><span data-stu-id="fcd9c-140">Task</span></span>|<span data-ttu-id="fcd9c-141">Tópico</span><span class="sxs-lookup"><span data-stu-id="fcd9c-141">Topic</span></span>|  
|----------|-----------|  
|<span data-ttu-id="fcd9c-142">Descreve como criar gatilhos de logon.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-142">Describes how to create logon triggers.</span></span> <span data-ttu-id="fcd9c-143">Os gatilhos de logon podem ser criados a partir de qualquer banco de dados, mas são registrados no nível do servidor e residem no banco de dados **mestre** .</span><span class="sxs-lookup"><span data-stu-id="fcd9c-143">Logon triggers can be created from any database, but are registered at the server level and reside in the **master** database.</span></span>|[<span data-ttu-id="fcd9c-144">CREATE TRIGGER &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="fcd9c-144">CREATE TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/create-trigger-transact-sql)|  
|<span data-ttu-id="fcd9c-145">Descreve como modificar gatilhos de logon.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-145">Describes how to modify logon triggers.</span></span>|[<span data-ttu-id="fcd9c-146">ALTER TRIGGER &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="fcd9c-146">ALTER TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/alter-trigger-transact-sql)|  
|<span data-ttu-id="fcd9c-147">Descreve como excluir gatilhos de logon.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-147">Describes how to delete logon triggers.</span></span>|[<span data-ttu-id="fcd9c-148">DROP TRIGGER &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="fcd9c-148">DROP TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/drop-trigger-transact-sql)|  
|<span data-ttu-id="fcd9c-149">Descreve como retornar informações sobre gatilhos de logon.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-149">Describes how to return information about logon triggers.</span></span>|[<span data-ttu-id="fcd9c-150">sys.server_triggers &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="fcd9c-150">sys.server_triggers &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-catalog-views/sys-server-triggers-transact-sql)<br /><br /> [<span data-ttu-id="fcd9c-151">sys.server_trigger_events &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="fcd9c-151">sys.server_trigger_events &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-catalog-views/sys-server-trigger-events-transact-sql)|  
|<span data-ttu-id="fcd9c-152">Descreve como capturar dados de evento do gatilho de logon.</span><span class="sxs-lookup"><span data-stu-id="fcd9c-152">Describes how to capture logon trigger event data.</span></span>||  
  
## <a name="see-also"></a><span data-ttu-id="fcd9c-153">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="fcd9c-153">See Also</span></span>  
 [<span data-ttu-id="fcd9c-154">Gatilhos DDL</span><span class="sxs-lookup"><span data-stu-id="fcd9c-154">DDL Triggers</span></span>](../triggers/ddl-triggers.md)  
  
  
