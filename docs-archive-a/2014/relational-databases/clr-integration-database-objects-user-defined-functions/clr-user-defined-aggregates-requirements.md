---
title: Requisitos para agregações CLR definidas pelo usuário | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: clr
ms.topic: reference
helpviewer_keywords:
- aggregate functions [CLR integration]
- user-defined types [CLR integration], user-defined aggregates
- CREATE AGGREGATE statement
- SqlUserDefinedAggregate attribute
- aggregate methods [CLR integration]
- assemblies [CLR integration], user-defined aggregate functions
- custom aggregates [CLR integration]
- user-defined functions [CLR integration]
- UDTs [CLR integration], user-defined aggregates
ms.assetid: dbf9eb5a-bd99-42f7-b275-556d0def045d
author: rothja
ms.author: jroth
ms.openlocfilehash: 8123f8324d43212007857dbb596a4fc61872bd2e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87574734"
---
# <a name="requirements-for-clr-user-defined-aggregates"></a><span data-ttu-id="cb128-102">Requisitos para agregações CLR definidas pelo usuário</span><span class="sxs-lookup"><span data-stu-id="cb128-102">Requirements for CLR User-Defined Aggregates</span></span>
  <span data-ttu-id="cb128-103">Um tipo em um assembly do CLR pode ser registrado como uma função de agregação definida pelo usuário, desde que implemente o contrato de agregação necessário.</span><span class="sxs-lookup"><span data-stu-id="cb128-103">A type in a common language runtime (CLR) assembly can be registered as a user-defined aggregate function, as long as it implements the required aggregation contract.</span></span> <span data-ttu-id="cb128-104">Esse contrato consiste no atributo `SqlUserDefinedAggregate` e os métodos de contrato de agregação.</span><span class="sxs-lookup"><span data-stu-id="cb128-104">This contract consists of the `SqlUserDefinedAggregate` attribute and the aggregation contract methods.</span></span> <span data-ttu-id="cb128-105">O contrato de agregação inclui o mecanismo para salvar o estado intermediário da agregação e o mecanismo para acumular novos valores, o qual consiste em quatro métodos: `Init`, `Accumulate`, `Merge` e `Terminate`.</span><span class="sxs-lookup"><span data-stu-id="cb128-105">The aggregation contract includes the mechanism to save the intermediate state of the aggregation, and the mechanism to accumulate new values, which consists of four methods: `Init`, `Accumulate`, `Merge`, and `Terminate`.</span></span> <span data-ttu-id="cb128-106">Quando atender a esses requisitos, você poderá aproveitar ao máximo as agregações definidas pelo usuário no [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="cb128-106">When you have met these requirements, you will be able to take full advantage of user-defined aggregates in [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="cb128-107">As seguintes seções deste tópico fornecem detalhes adicionais sobre como criar e trabalhar com agregações definidas pelo usuário.</span><span class="sxs-lookup"><span data-stu-id="cb128-107">The following sections of this topic provide additional details about how to create and work with user-defined aggregates.</span></span> <span data-ttu-id="cb128-108">Para obter um exemplo, consulte [invocando funções de agregação definidas pelo usuário CLR](clr-user-defined-aggregate-invoking-functions.md).</span><span class="sxs-lookup"><span data-stu-id="cb128-108">For an example, see [Invoking CLR User-Defined Aggregate Functions](clr-user-defined-aggregate-invoking-functions.md).</span></span>  
  
## <a name="sqluserdefinedaggregate"></a><span data-ttu-id="cb128-109">SqlUserDefinedAggregate</span><span class="sxs-lookup"><span data-stu-id="cb128-109">SqlUserDefinedAggregate</span></span>  
 <span data-ttu-id="cb128-110">Para obter mais informações, consulte [SqlUserDefinedAggregateAttribute](https://go.microsoft.com/fwlink/?LinkId=124626).</span><span class="sxs-lookup"><span data-stu-id="cb128-110">For more information, see [SqlUserDefinedAggregateAttribute](https://go.microsoft.com/fwlink/?LinkId=124626).</span></span>  
  
## <a name="aggregation-methods"></a><span data-ttu-id="cb128-111">Métodos de agregação</span><span class="sxs-lookup"><span data-stu-id="cb128-111">Aggregation Methods</span></span>  
 <span data-ttu-id="cb128-112">A classe registrada como uma agregação definida pelo usuário deve dar suporte aos seguintes métodos de instância.</span><span class="sxs-lookup"><span data-stu-id="cb128-112">The class registered as a user-defined aggregate should support the following instance methods.</span></span> <span data-ttu-id="cb128-113">Eles são os métodos que o processador de consultas usa para computar a agregação:</span><span class="sxs-lookup"><span data-stu-id="cb128-113">These are the methods that the query processor uses to compute the aggregation:</span></span>  
  
|<span data-ttu-id="cb128-114">Método</span><span class="sxs-lookup"><span data-stu-id="cb128-114">Method</span></span>|<span data-ttu-id="cb128-115">Sintaxe</span><span class="sxs-lookup"><span data-stu-id="cb128-115">Syntax</span></span>|<span data-ttu-id="cb128-116">Descrição</span><span class="sxs-lookup"><span data-stu-id="cb128-116">Description</span></span>|  
|------------|------------|-----------------|  
|`Init`|<span data-ttu-id="cb128-117">public void init ();</span><span class="sxs-lookup"><span data-stu-id="cb128-117">public void Init();</span></span>|<span data-ttu-id="cb128-118">O processador de consultas usa esse método para inicializar a computação da agregação.</span><span class="sxs-lookup"><span data-stu-id="cb128-118">The query processor uses this method to initialize the computation of the aggregation.</span></span> <span data-ttu-id="cb128-119">Ele é invocado uma vez para cada grupo que o processador de consultas está agregando.</span><span class="sxs-lookup"><span data-stu-id="cb128-119">This method is invoked once for each group that the query processor is aggregating.</span></span> <span data-ttu-id="cb128-120">O processador de consultas pode optar por reutilizar a mesma instância da classe de agregação para computar agregações de grupos vários.</span><span class="sxs-lookup"><span data-stu-id="cb128-120">The query processor may choose to reuse the same instance of the aggregate class for computing aggregates of multiple groups.</span></span> <span data-ttu-id="cb128-121">O método `Init` deve executar qualquer limpeza, conforme necessário, de usos anteriores desta instância e habilitá-la para que uma nova computação de agregação seja reiniciada.</span><span class="sxs-lookup"><span data-stu-id="cb128-121">The `Init` method should perform any clean-up as necessary from previous uses of this instance, and enable it to re-start a new aggregate computation.</span></span>|  
|`Accumulate`|<span data-ttu-id="cb128-122">public void Accumulate (valor de tipo de entrada [, valor de tipo de entrada,...]);</span><span class="sxs-lookup"><span data-stu-id="cb128-122">public void Accumulate ( input-type value[, input-type value, ...]);</span></span>|<span data-ttu-id="cb128-123">Um ou mais parâmetros que representam os parâmetros da função.</span><span class="sxs-lookup"><span data-stu-id="cb128-123">One or more parameters representing the parameters of the function.</span></span> <span data-ttu-id="cb128-124">*input_type* deve ser o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] tipo de dados gerenciado equivalente ao [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] tipo de dados nativo especificado por *input_sqltype* na `CREATE AGGREGATE` instrução.</span><span class="sxs-lookup"><span data-stu-id="cb128-124">*input_type* should be the managed [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type equivalent to the native [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type specified by *input_sqltype* in the `CREATE AGGREGATE` statement.</span></span> <span data-ttu-id="cb128-125">Para obter mais informações, consulte [mapeando dados de parâmetro CLR](../clr-integration-database-objects-types-net-framework/mapping-clr-parameter-data.md).</span><span class="sxs-lookup"><span data-stu-id="cb128-125">For more information, see [Mapping CLR Parameter Data](../clr-integration-database-objects-types-net-framework/mapping-clr-parameter-data.md).</span></span><br /><br /> <span data-ttu-id="cb128-126">Para UDTs (tipos definidos pelo usuário), o tipo de entrada é o mesmo que o tipo do UDT.</span><span class="sxs-lookup"><span data-stu-id="cb128-126">For user-defined types (UDTs), the input-type is the same as the UDT type.</span></span> <span data-ttu-id="cb128-127">O processador de consultas usa esse método para acumular os valores de agregação.</span><span class="sxs-lookup"><span data-stu-id="cb128-127">The query processor uses this method to accumulate the aggregate values.</span></span> <span data-ttu-id="cb128-128">Ele é invocado uma vez para obter cada valor no grupo que está sendo agregado.</span><span class="sxs-lookup"><span data-stu-id="cb128-128">This is invoked once for each value in the group that is being aggregated.</span></span> <span data-ttu-id="cb128-129">O processador de consultas o chama somente depois de chamar o método `Init` na instância determinada da classe de agregação.</span><span class="sxs-lookup"><span data-stu-id="cb128-129">The query processor always calls this only after calling the `Init` method on the given instance of the aggregate-class.</span></span> <span data-ttu-id="cb128-130">A implementação desse método deve atualizar o estado da instância para refletir o acúmulo do valor do argumento que é passado.</span><span class="sxs-lookup"><span data-stu-id="cb128-130">The implementation of this method should update the state of the instance to reflect the accumulation of the argument value being passed in.</span></span>|  
|`Merge`|<span data-ttu-id="cb128-131">particular void Merge (valor de udagg_class);</span><span class="sxs-lookup"><span data-stu-id="cb128-131">public void Merge( udagg_class value);</span></span>|<span data-ttu-id="cb128-132">Esse método pode ser usado para mesclar outra instância desta classe de agregação com a instância atual.</span><span class="sxs-lookup"><span data-stu-id="cb128-132">This method can be used to merge another instance of this aggregate class with the current instance.</span></span> <span data-ttu-id="cb128-133">O processador de consultas usa esse método para mesclar várias computações parciais de uma agregação.</span><span class="sxs-lookup"><span data-stu-id="cb128-133">The query processor uses this method to merge multiple partial computations of an aggregation.</span></span>|  
|`Terminate`|<span data-ttu-id="cb128-134">return_type pública terminar ();</span><span class="sxs-lookup"><span data-stu-id="cb128-134">public return_type Terminate();</span></span>|<span data-ttu-id="cb128-135">Esse método completa a computação de agregações e retorna o resultado da agregação.</span><span class="sxs-lookup"><span data-stu-id="cb128-135">This method completes the aggregate computation and returns the result of the aggregation.</span></span> <span data-ttu-id="cb128-136">O *return_type* deve ser um [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] tipo de dados gerenciado que seja o equivalente gerenciado de *return_sqltype* especificado na `CREATE AGGREGATE` instrução.</span><span class="sxs-lookup"><span data-stu-id="cb128-136">The *return_type* should be a managed [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type that is the managed equivalent of *return_sqltype* specified in the `CREATE AGGREGATE` statement.</span></span> <span data-ttu-id="cb128-137">O *return_type* também pode ser um tipo definido pelo usuário.</span><span class="sxs-lookup"><span data-stu-id="cb128-137">The *return_type* can also be a user-defined type.</span></span>|  
  
### <a name="table-valued-parameters"></a><span data-ttu-id="cb128-138">Parâmetros de valores de tabela</span><span class="sxs-lookup"><span data-stu-id="cb128-138">Table-Valued Parameters</span></span>  
 <span data-ttu-id="cb128-139">Os TVPs (parâmetros com valor de tabela), ou seja, tipos de tabela definidos pelo usuário transmitidos para um procedimento ou uma função, oferecem uma maneira eficiente de passar várias linhas de dados para o servidor.</span><span class="sxs-lookup"><span data-stu-id="cb128-139">Table-valued parameters (TVPs), user-defined table types that are passed into a procedure or function, provide an efficient way to pass multiple rows of data to the server.</span></span> <span data-ttu-id="cb128-140">Os TVPs proporcionam funcionalidade semelhante para matrizes de parâmetro, porém com maior flexibilidade e integração com [!INCLUDE[tsql](../../includes/tsql-md.md)].</span><span class="sxs-lookup"><span data-stu-id="cb128-140">TVPs provide similar functionality to parameter arrays, but offer greater flexibility and closer integration with [!INCLUDE[tsql](../../includes/tsql-md.md)].</span></span> <span data-ttu-id="cb128-141">Eles também fornecem o potencial para melhor desempenho.</span><span class="sxs-lookup"><span data-stu-id="cb128-141">They also provide the potential for better performance.</span></span> <span data-ttu-id="cb128-142">Os TVPs também ajudam a reduzir o número de viagens de ida e volta para o servidor.</span><span class="sxs-lookup"><span data-stu-id="cb128-142">TVPs also help reduce the number of round trips to the server.</span></span> <span data-ttu-id="cb128-143">Em vez de enviar várias solicitações ao servidor, como com uma lista de parâmetros escalares, os dados podem ser enviados ao servidor como um TVP.</span><span class="sxs-lookup"><span data-stu-id="cb128-143">Instead of sending multiple requests to the server, such as with a list of scalar parameters, data can be sent to the server as a TVP.</span></span> <span data-ttu-id="cb128-144">Um tipo de tabela definido pelo usuário não pode ser passado como um parâmetro com valor de tabela para, ou ser retornado de, um procedimento armazenado ou uma função gerenciada(o) que é executada(o) no processo do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="cb128-144">A user-defined table type cannot be passed as a table-valued parameter to, or be returned from, a managed stored procedure or function executing in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] process.</span></span> <span data-ttu-id="cb128-145">Além disso, TVPs não podem ser usados dentro do escopo de uma conexão de contexto.</span><span class="sxs-lookup"><span data-stu-id="cb128-145">Also, TVPs cannot be used within the scope of a context connection.</span></span> <span data-ttu-id="cb128-146">Entretanto, um TVP pode ser usado com o SqlClient nos procedimentos armazenados gerenciados ou nas funções em execução no processo do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], se for usado em uma conexão que não seja de contexto.</span><span class="sxs-lookup"><span data-stu-id="cb128-146">However, a TVP can be used with SqlClient in managed stored procedures or functions executing in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] process, if it is used in a connection that is not a context connection.</span></span> <span data-ttu-id="cb128-147">A conexão pode ser com o mesmo servidor que está executando o procedimento ou função gerenciada.</span><span class="sxs-lookup"><span data-stu-id="cb128-147">The connection can be to the same server that is executing the managed procedure or function.</span></span> <span data-ttu-id="cb128-148">Para obter mais informações sobre TVPs, consulte [usar parâmetros com valor de tabela &#40;Mecanismo de Banco de Dados&#41;](../tables/use-table-valued-parameters-database-engine.md).</span><span class="sxs-lookup"><span data-stu-id="cb128-148">For more information about TVPs, see [Use Table-Valued Parameters &#40;Database Engine&#41;](../tables/use-table-valued-parameters-database-engine.md).</span></span>  
  
## <a name="change-history"></a><span data-ttu-id="cb128-149">Histórico de alterações</span><span class="sxs-lookup"><span data-stu-id="cb128-149">Change History</span></span>  
  
|<span data-ttu-id="cb128-150">Conteúdo atualizado</span><span class="sxs-lookup"><span data-stu-id="cb128-150">Updated content</span></span>|  
|---------------------|  
|<span data-ttu-id="cb128-151">Atualizada a descrição do método `Accumulate`; agora ele aceita mais de um parâmetro.</span><span class="sxs-lookup"><span data-stu-id="cb128-151">Updated the description of the `Accumulate` method; it now accepts more than one parameter.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="cb128-152">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="cb128-152">See Also</span></span>  
 <span data-ttu-id="cb128-153">[Tipos definidos pelo usuário de CLR](../clr-integration-database-objects-user-defined-types/clr-user-defined-types.md) </span><span class="sxs-lookup"><span data-stu-id="cb128-153">[CLR User-Defined Types](../clr-integration-database-objects-user-defined-types/clr-user-defined-types.md) </span></span>  
 [<span data-ttu-id="cb128-154">Invocando funções de agregação CLR definidas pelo usuário</span><span class="sxs-lookup"><span data-stu-id="cb128-154">Invoking CLR User-Defined Aggregate Functions</span></span>](clr-user-defined-aggregate-invoking-functions.md)  
  
  
