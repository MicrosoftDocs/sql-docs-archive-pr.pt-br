---
title: Administrar e monitorar a captura de dados de alteração (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- change data capture [SQL Server], monitoring
- change data capture [SQL Server], administering
- change data capture [SQL Server], jobs
ms.assetid: 23bda497-67b2-4e7b-8e4d-f1f9a2236685
author: rothja
ms.author: jroth
ms.openlocfilehash: 8d97929ead145d1b0de1a1f83becb15ade397683
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87575691"
---
# <a name="administer-and-monitor-change-data-capture-sql-server"></a><span data-ttu-id="6fa5f-102">Administrar e monitorar a captura de dados de alteração (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="6fa5f-102">Administer and Monitor Change Data Capture (SQL Server)</span></span>
  <span data-ttu-id="6fa5f-103">Este tópico descreve como administrar e monitorar a captura de dados de alterações.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-103">This topic describes how to administer and monitor change data capture.</span></span>  
  
##  <a name="capture-job"></a><a name="Capture"></a> <span data-ttu-id="6fa5f-104">Trabalho de captura</span><span class="sxs-lookup"><span data-stu-id="6fa5f-104">Capture Job</span></span>  
 <span data-ttu-id="6fa5f-105">O trabalho de captura é iniciado com a execução do procedimento armazenado sem-parâmetros `sp_MScdc_capture_job`.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-105">The capture job is initiated by running the parameterless stored procedure `sp_MScdc_capture_job`.</span></span> <span data-ttu-id="6fa5f-106">Esse procedimento armazenado é iniciado com a extração de valores configurados para *maxtrans*, *maxscans*, *continuous*e *pollinginterval* para o trabalho de captura de msdb.dbo.cdc_jobs.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-106">This stored procedure starts by extracting the configured values for *maxtrans*, *maxscans*, *continuous*, and *pollinginterval* for the capture job from msdb.dbo.cdc_jobs.</span></span> <span data-ttu-id="6fa5f-107">Estes valores configurados são passados como parâmetros ao procedimento armazenado `sp_cdc_scan`.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-107">These configured values are then passed as parameters to the stored procedure `sp_cdc_scan`.</span></span> <span data-ttu-id="6fa5f-108">Ele é usado para invocar `sp_replcmds` para executar a verificação de log.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-108">This is used to invoke `sp_replcmds` to perform the log scan.</span></span>  
  
### <a name="capture-job-parameters"></a><span data-ttu-id="6fa5f-109">Capturar parâmetros de trabalho</span><span class="sxs-lookup"><span data-stu-id="6fa5f-109">Capture Job Parameters</span></span>  
 <span data-ttu-id="6fa5f-110">Para entender o comportamento do trabalho de captura, você deve entender como os parâmetros configuráveis são usados pelo `sp_cdc_scan`.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-110">To understand capture job behavior, you must understand how the configurable parameters are used by `sp_cdc_scan`.</span></span>  
  
#### <a name="maxtrans-parameter"></a><span data-ttu-id="6fa5f-111">Parâmetro maxtrans</span><span class="sxs-lookup"><span data-stu-id="6fa5f-111">maxtrans Parameter</span></span>  
 <span data-ttu-id="6fa5f-112">O parâmetro *maxtrans* especifica o número máximo de transações que podem ser processadas em um único ciclo de verificação do log.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-112">The *maxtrans* parameter specifies the maximum number of transactions that can be processed in a single scan cycle of the log.</span></span> <span data-ttu-id="6fa5f-113">Se, durante a verificação, o número de transações a serem processadas alcançar esse limite, nenhuma transação adicional será incluída na verificação atual.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-113">If, during the scan, the number of transactions to be processed reaches this limit, no additional transactions are included in the current scan.</span></span> <span data-ttu-id="6fa5f-114">Após a conclusão de um ciclo de verificação, o número de transações que foram processadas sempre será menor ou igual ao *maxtrans*.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-114">After a scan cycle is complete, the number of transactions that were processed will always be less than or equal to *maxtrans*.</span></span>  
  
#### <a name="maxscans-parameter"></a><span data-ttu-id="6fa5f-115">Parâmetro maxscans</span><span class="sxs-lookup"><span data-stu-id="6fa5f-115">maxscans Parameter</span></span>  
 <span data-ttu-id="6fa5f-116">O parâmetro *maxscans* especifica o número máximo de ciclos de verificação que tentaram esgotar o log antes de retornar (continuous = 0) ou executar waitfor (continuous = 1).</span><span class="sxs-lookup"><span data-stu-id="6fa5f-116">The *maxscans* parameter specifies the maximum number of scan cycles that are attempted to drain the log before either returning (continuous = 0) or executing a waitfor (continuous = 1).</span></span>  
  
#### <a name="continuous-parameter"></a><span data-ttu-id="6fa5f-117">Parâmetro continuous</span><span class="sxs-lookup"><span data-stu-id="6fa5f-117">continuous Parameter</span></span>  
 <span data-ttu-id="6fa5f-118">O parâmetro *Continuous* controla se o `sp_cdc_scan` controle deve ser esgotado depois de descarregar o log ou executar o número máximo de ciclos de verificação (modo de uma imagem).</span><span class="sxs-lookup"><span data-stu-id="6fa5f-118">The *continuous* parameter controls whether `sp_cdc_scan` relinquishes control in after either draining the log or executing the maximum number of scan cycles (one shot mode).</span></span> <span data-ttu-id="6fa5f-119">Também controla se `sp_cdc_scan` continua sendo executado até ser explicitamente interrompido (modo contínuo).</span><span class="sxs-lookup"><span data-stu-id="6fa5f-119">It also controles whether `sp_cdc_scan` continues to run until explicitly stopped (continuous mode).</span></span>  
  
##### <a name="one-shot-mode"></a><span data-ttu-id="6fa5f-120">Modo mono estável</span><span class="sxs-lookup"><span data-stu-id="6fa5f-120">One Shot Mode</span></span>  
 <span data-ttu-id="6fa5f-121">No modo One shot, o trabalho de captura solicita a `sp_cdc_scan` execução de até *maxtrans* verificações para tentar drenar o log e retornar.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-121">In one shot mode, the capture job requests `sp_cdc_scan` to perform up to *maxtrans* scans to try to drain the log and return.</span></span> <span data-ttu-id="6fa5f-122">Qualquer transação além de *maxtrans* presente no log será processada nas verificações posteriores.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-122">Any transactions in addition to *maxtrans* that are present in the log will be processed in later scans.</span></span>  
  
 <span data-ttu-id="6fa5f-123">O modo monoestável é usado em testes controlados, nos quais o volume de transações a serem processadas é conhecido e há vantagens no fato de o trabalho fechar automaticamente quando concluído.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-123">One shot mode is used in controlled tests, where the volume of transactions to be processed is known, and there are advantages to the fact that the job closes automatically on when it is finished.</span></span> <span data-ttu-id="6fa5f-124">O modo monoestável não é recomendado para uso de produção.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-124">One shot mode is not recommended for production use.</span></span> <span data-ttu-id="6fa5f-125">Isso ocorre porque ele depende da agenda de trabalho para gerenciar a frequência com que o ciclo de verificação é executado.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-125">This is because t relies on the job schedule to manage how frequently the scan cycle is run.</span></span>  
  
 <span data-ttu-id="6fa5f-126">Ao executar no modo monoestável, você pode calcular uma associação superior na taxa de transferência esperada do trabalho de captura, expressa nas transações por segundo usando o seguinte cálculo:</span><span class="sxs-lookup"><span data-stu-id="6fa5f-126">When running in one shot mode, you can compute an upper bound on expected throughput of the capture job, expressed in transactions per second by using the following computation:</span></span>  
  
 `(maxtrans * maxscans) / number of seconds between scans`  
  
 <span data-ttu-id="6fa5f-127">Mesmo que o tempo necessário para verificar o log e preencher as tabelas de alteração não seja significativamente diferente de 0, a taxa de transferência média do trabalho não deve exceder o valor obtido pela divisão do máximo de transações permitidas por uma verificação única multiplicada pelo máximo de transações permitidas pelo número de segundos entre o processamento do log.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-127">Even if the time that is required to scan the log and populate the change tables were not significantly different from 0, the average throughput of the job could not exceed the value obtained by dividing the maximum allowed transactions for a single scan multiplied by the maximum allowed scans by the number of seconds separating log processing.</span></span>  
  
 <span data-ttu-id="6fa5f-128">Se o modo monoestável foi usado para verificação de log regular, o número de segundos entre o processamento de log deverá ser regido pela agenda do trabalho.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-128">If one shot mode were to be used to regulate log scanning, the number of seconds between log processing would have to be governed by the job schedule.</span></span> <span data-ttu-id="6fa5f-129">Quando esse tipo de comportamento é desejado, executar o trabalho de captura no modo contínuo é um método melhor de gerenciar a reagenda da verificação de log.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-129">When this kind of behavior is desired, running the capture job in continuous mode is a better way to manage rescheduling the log scan.</span></span>  
  
##### <a name="continuous-mode-and-the-polling-interval"></a><span data-ttu-id="6fa5f-130">Modo contínuo e intervalo de sondagem</span><span class="sxs-lookup"><span data-stu-id="6fa5f-130">Continuous Mode and the Polling Interval</span></span>  
 <span data-ttu-id="6fa5f-131">No modo contínuo, o trabalho de captura solicita a execução contínua de `sp_cdc_scan`.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-131">In continuous mode, the capture job requests that `sp_cdc_scan` run continuously.</span></span> <span data-ttu-id="6fa5f-132">Isso permite que o procedimento armazenado gerencie seu próprio loop de espera fornecendo não só maxtrans e maxscans, como também um valor para o número de segundos entre o processamento de log (o intervalo de sondagem).</span><span class="sxs-lookup"><span data-stu-id="6fa5f-132">This lets the stored procedure manage its own wait loop by providing not only for maxtrans and maxscans but also a value for the number of seconds between log processing (the polling interval).</span></span> <span data-ttu-id="6fa5f-133">Quando executado nesse modo, o trabalho de captura permanece ativo, executando uma verificação entre logs `WAITFOR`.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-133">Running in this mode, the capture job remains active, executing a `WAITFOR` between log scanning.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6fa5f-134">Quando o valor do intervalo de sondagem é maior que 0, o mesmo limite superior na taxa de transferência do trabalho monoestável recorrente também se aplica à operação do trabalho no modo contínuo.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-134">When the value of the polling interval is greater than 0, the same upper limit on throughput for the recurring one shot job also applies to the job operation in continuous mode.</span></span> <span data-ttu-id="6fa5f-135">Isto é, (*maxtrans* \* *maxscans*) dividido por um intervalo de sondagem diferente de zero colocará uma associação superior no número médio de transações que podem ser processadas pelo trabalho de captura.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-135">That is, (*maxtrans* \* *maxscans*) divided by a nonzero polling interval will put an upper bound on the average number of transactions that can be processed by the capture job.</span></span>  
  
### <a name="capture-job-customization"></a><span data-ttu-id="6fa5f-136">Personalização do trabalho de captura</span><span class="sxs-lookup"><span data-stu-id="6fa5f-136">Capture Job Customization</span></span>  
 <span data-ttu-id="6fa5f-137">Para o trabalho de captura, você pode aplicar lógica adicional para determinar se uma nova verificação é iniciada imediatamente ou se um estado suspenso é imposto antes do início de uma nova verificação, em vez de depender de um intervalo de sondagem fixo.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-137">For the capture job, you can apply additional logic to determine whether a new scan begins immediately or whether a sleep is imposed before it starts a new scan instead of rely on a fixed polling interval.</span></span> <span data-ttu-id="6fa5f-138">A opção pode se basear simplesmente na hora do dia, talvez impondo estados suspensos muito longos durante horários de pico de atividade e até mudando para um intervalo de sondagem de 0 no fechamento do dia quando é importante concluir o processamento dos dias e preparar-se para as execuções noturnas.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-138">The choice could be based merely on time of the day, perhaps enforcing very long sleeps during peak activity times, and even moving to a polling interval of 0 at close of day when it is important to complete the days processing and prepare for nightly runs.</span></span> <span data-ttu-id="6fa5f-139">Também foi possível monitorar o andamento do processo de captura para determinar quando todas as transações confirmadas até meia-noite foram verificadas e depositadas em tabelas de alterações.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-139">Capture process progress could also be monitored to determine when all transactions committed by mid-night had been scanned and deposited in change tables.</span></span> <span data-ttu-id="6fa5f-140">Isso permite a reinicialização do trabalho de captura por uma reinicialização diária agendada após seu término.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-140">This lets the capture job end, to be restarted by a scheduled daily restart.</span></span> <span data-ttu-id="6fa5f-141">Ao substituir a etapa de trabalho entregue chamando `sp_cdc_scan` por uma chamada a um invólucro de usuário gravado para `sp_cdc_scan`, é possível obter comportamento altamente personalizado com pouco esforço adicional.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-141">By replacing the delivered job step calling `sp_cdc_scan` with a call to a user written wrapper for `sp_cdc_scan`, highly customized behavior can be obtained with little additional effort.</span></span>  
  
##  <a name="cleanup-job"></a><a name="Cleanup"></a> <span data-ttu-id="6fa5f-142">Trabalho de limpeza</span><span class="sxs-lookup"><span data-stu-id="6fa5f-142">Cleanup Job</span></span>  
 <span data-ttu-id="6fa5f-143">Esta seção fornece informações sobre como o trabalho de limpeza do Change Data Capture funciona.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-143">This section provides information about how the change data capture cleanup job works.</span></span>  
  
### <a name="structure-of-the-cleanup-job"></a><span data-ttu-id="6fa5f-144">Estrutura do trabalho de limpeza</span><span class="sxs-lookup"><span data-stu-id="6fa5f-144">Structure of the Cleanup Job</span></span>  
 <span data-ttu-id="6fa5f-145">O Change Data Capture usa uma retenção com base na estratégia de limpeza para gerenciar o tamanho da tabela de alterações.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-145">Change data capture uses a retention based cleanup strategy to manage change table size.</span></span> <span data-ttu-id="6fa5f-146">O mecanismo de limpeza consiste em um trabalho do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent [!INCLUDE[tsql](../../includes/tsql-md.md)] criado quando a primeira tabela de banco de dados é habilitada.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-146">The cleanup mechanism consists of a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent [!INCLUDE[tsql](../../includes/tsql-md.md)] job that is created when the first database table is enabled.</span></span> <span data-ttu-id="6fa5f-147">Um único trabalho de limpeza trata da limpeza de todas as tabelas de alterações de bancos de dados e aplica o mesmo valor de retenção a todas as instâncias de captura definidas.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-147">A single cleanup job handles cleanup for all database change tables and applies the same retention value to all defined capture instances.</span></span>  
  
 <span data-ttu-id="6fa5f-148">O trabalho de limpeza é iniciado com a execução do procedimento armazenado sem-parâmetros `sp_MScdc_cleanup_job`.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-148">The cleanup job is initiated by running the parameterless stored procedure `sp_MScdc_cleanup_job`.</span></span> <span data-ttu-id="6fa5f-149">Este procedimento armazenado começa extraindo a retenção configurada e os valores de limite do trabalho de limpeza de `msdb.dbo.cdc_jobs`.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-149">This stored procedure starts by extracting the configured retention and threshold values for the cleanup job from `msdb.dbo.cdc_jobs`.</span></span> <span data-ttu-id="6fa5f-150">O valor de retenção é usado para calcular uma nova marca d'água baixa para as tabelas de alterações.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-150">The retention value is used to compute a new low watermark for the change tables.</span></span> <span data-ttu-id="6fa5f-151">O número de minutos especificado é subtraído do valor máximo *tran_end_time* da `cdc.lsn_time_mapping` tabela para obter a nova marca d' água inferior expressa como um valor DateTime.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-151">The specified number of minutes is subtracted from the maximum *tran_end_time* value from the `cdc.lsn_time_mapping` table to obtain the new low water mark expressed as a datetime value.</span></span> <span data-ttu-id="6fa5f-152">A tabela CDC.lsn_time_mapping é usada para converter esse valor de data e hora em um valor correspondente de `lsn`.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-152">The CDC.lsn_time_mapping table is then used to convert this datetime value to a corresponding `lsn` value.</span></span> <span data-ttu-id="6fa5f-153">Se a mesma hora de confirmação for compartilhada por várias entradas na tabela, o `lsn` que corresponde à entrada com o menor `lsn` é escolhida como a nova marca d'água baixa.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-153">If the same commit time is shared by multiple entries in the table, the `lsn` that corresponds to the entry that has the smallest `lsn` is chosen as the new low watermark.</span></span> <span data-ttu-id="6fa5f-154">Esse valor de `lsn` é passado para `sp_cdc_cleanup_change_tables` para remover entradas da tabela de alterações de tabelas de alterações do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-154">This `lsn` value is passed to `sp_cdc_cleanup_change_tables` to remove change table entries from the database change tables.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6fa5f-155">A vantagem de usar a hora de confirmação da transação recente como base do cálculo da nova marca d'água baixa é que isso permite que as alterações permaneçam nas tabelas de alterações pelo tempo especificado.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-155">The advantage of using the commit time of the recent transaction as the base for computing the new low watermark is that it lets the changes remain in change tables for the specified time.</span></span> <span data-ttu-id="6fa5f-156">Isto ocorre até mesmo quando o processo de captura está sendo executado em segundo plano.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-156">This happens even when the capture process is running behind.</span></span> <span data-ttu-id="6fa5f-157">Todas as entradas com a mesma hora de confirmação que a marca d'água baixa continuam sendo representadas nas tabelas de alterações pela escolha do menor `lsn` que tem a hora de confirmação compartilhada da marca d'água baixa.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-157">All entries that have the same commit time as the current low watermark continue to be represented within the change tables by choosing the smallest `lsn` that has the shared commit time for the actual low watermark.</span></span>  
  
 <span data-ttu-id="6fa5f-158">Quando uma limpeza é executada, a marca d'água baixa para todas as instâncias de captura é atualizada inicialmente em uma única transação.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-158">When a cleanup is performed, the low watermark for all capture instances is initially updated in a single transaction.</span></span> <span data-ttu-id="6fa5f-159">Ela tenta remover entradas obsoletas das tabelas de alterações e da tabela cdc.lsn_time_mapping.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-159">It then tries to remove obsolete entries from the change tables and the cdc.lsn_time_mapping table.</span></span> <span data-ttu-id="6fa5f-160">O valor limite configurável restringe a quantidade de entradas excluídas em qualquer instrução única.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-160">The configurable threshold value limits how many entries are deleted in any single statement.</span></span> <span data-ttu-id="6fa5f-161">A não execução da exclusão de qualquer tabela individual não impedirá a tentativa de operação nas tabelas restantes.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-161">Failure to perform the delete on any individual table will not prevent the operation from being attempted on the remaining tables.</span></span>  
  
### <a name="cleanup-job-customization"></a><span data-ttu-id="6fa5f-162">Personalização do trabalho de limpeza</span><span class="sxs-lookup"><span data-stu-id="6fa5f-162">Cleanup Job Customization</span></span>  
 <span data-ttu-id="6fa5f-163">Para o trabalho de limpeza, a possibilidade personalização está na estratégia usada para determinar quais entradas da tabela de alterações devem ser descartadas.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-163">For the cleanup job, the possibility for customization is in the strategy used to determine which change table entries are to be discarded.</span></span> <span data-ttu-id="6fa5f-164">A única estratégia com suporte no trabalho de limpeza entregue baseia-se na hora.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-164">The only supported strategy in the delivered cleanup job is a time-based one.</span></span> <span data-ttu-id="6fa5f-165">Nessa situação, a nova marca d'água baixa é calculada pela subtração do período de retenção permitido da hora de confirmação da última transação processada.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-165">In that situation, the new low watermark is computed by subtracting the allowed retention period from the commit time of the last transaction processed.</span></span> <span data-ttu-id="6fa5f-166">Como os procedimentos de limpeza subjacentes se baseiam no `lsn`, em vez da hora, qualquer número de estratégias pode ser usado para determinar o menor `lsn` a ser mantido nas tabelas de alterações.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-166">Because the underlying cleanup procedures are based on `lsn` instead of time, any number of strategies can be used to determine the smallest `lsn` to keep in the change tables.</span></span> <span data-ttu-id="6fa5f-167">Somente alguns deles são estritamente baseados na hora.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-167">Only some of these are strictly time-based.</span></span> <span data-ttu-id="6fa5f-168">O conhecimento sobre os clientes, por exemplo, pode ser usado para fornecer um mecanismo seguro se não for possível executar os processos de downstream que requerem acesso às tabelas de alterações.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-168">Knowledge about the clients, for example, could be used to provide a failsafe if downstream processes that require access to the change tables cannot run.</span></span> <span data-ttu-id="6fa5f-169">Além disso, embora a estratégia padrão seja aplicável ao mesmo `lsn` para limpar todas as tabelas de alterações do banco de dados, o procedimento de limpeza subjacente também pode ser chamado para limpar no nível de captura da instância.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-169">Also, although the default strategy applies the same `lsn` to clean up all the databases' change tables, the underlying cleanup procedure, can also be called to clean up at the capture instance level.</span></span>  
  
##  <a name="monitor-the-change-data-capture-process"></a><a name="Monitor"></a> <span data-ttu-id="6fa5f-170">Monitorar o processo de captura de dados de alterações</span><span class="sxs-lookup"><span data-stu-id="6fa5f-170">Monitor the Change Data Capture Process</span></span>  
 <span data-ttu-id="6fa5f-171">O monitoramento do processo de captura de dados de alteração permite determinar se as alterações estão sendo gravadas corretamente e com latência razoável nas tabelas de alteração.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-171">Monitoring the change data capture process lets you determine if changes are being written correctly and with a reasonable latency to the change tables.</span></span> <span data-ttu-id="6fa5f-172">O monitoramento também pode ajudar a identificar os erros que podem ocorrer.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-172">Monitoring can also help you to identify any errors that might occur.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="6fa5f-173">contém duas exibições de gerenciamento dinâmico para ajudar a monitorar a captura de dados de alterações: [sys.dm_cdc_log_scan_sessions](../native-client-ole-db-data-source-objects/sessions.md) e [sys.dm_cdc_errors](../native-client-ole-db-errors/errors.md).</span><span class="sxs-lookup"><span data-stu-id="6fa5f-173">includes two dynamic management views to help you monitor change data capture: [sys.dm_cdc_log_scan_sessions](../native-client-ole-db-data-source-objects/sessions.md) and [sys.dm_cdc_errors](../native-client-ole-db-errors/errors.md).</span></span>  
  
### <a name="identify-sessions-with-empty-result-sets"></a><span data-ttu-id="6fa5f-174">Identificar sessões com conjuntos de resultados vazios</span><span class="sxs-lookup"><span data-stu-id="6fa5f-174">Identify Sessions with Empty Result Sets</span></span>  
 <span data-ttu-id="6fa5f-175">Cada linha da exibição de gerenciamento sys.dm_cdc_log_scan_sessions representa uma sessão de verificação de log (exceto a linha que tem uma ID 0).</span><span class="sxs-lookup"><span data-stu-id="6fa5f-175">Every row in sys.dm_cdc_log_scan_sessions represents a log scan session (except the row with an ID of 0).</span></span> <span data-ttu-id="6fa5f-176">Uma sessão de verificação de log é equivalente a uma execução de [sp_cdc_scan](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-scan-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="6fa5f-176">A log scan session is equivalent to one execution of [sp_cdc_scan](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-scan-transact-sql).</span></span> <span data-ttu-id="6fa5f-177">Durante uma sessão, a verificação pode retornar alterações ou um resultado vazio.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-177">During a session, the scan can either return changes or return an empty result.</span></span> <span data-ttu-id="6fa5f-178">Se o conjunto de resultados for vazio, a coluna empty_scan_count em sys.dm_cdc_log_scan_sessions será definida como 1.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-178">If the result set is empty, the empty_scan_count column in sys.dm_cdc_log_scan_sessions is set to 1.</span></span> <span data-ttu-id="6fa5f-179">Se houver conjuntos de resultados vazios consecutivos, como se o trabalho de captura estivesse sendo executado continuamente, a coluna empty_scan_count na última linha existente será incrementada.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-179">If there are consecutive empty result sets, such as if the capture job is running continuously, the empty_scan_count in the last existing row is incremented.</span></span> <span data-ttu-id="6fa5f-180">Por exemplo, se sys.dm_cdc_log_scan_sessions já contém 10 linhas para verificações que retornaram alterações e se existem cinco conjuntos de resultados vazios em sequência, a exibição conterá 11 linhas.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-180">For example, if sys.dm_cdc_log_scan_sessions already contains 10 rows for scans that returned changes and there are five empty results in a row, the view contains 11 rows.</span></span> <span data-ttu-id="6fa5f-181">A última linha tem um valor de 5 na coluna empty_scan_count.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-181">The last row has a value of 5 in the empty_scan_count column.</span></span> <span data-ttu-id="6fa5f-182">Para determinar sessões que tiveram uma verificação vazia, execute a seguinte consulta:</span><span class="sxs-lookup"><span data-stu-id="6fa5f-182">To determine sessions that had an empty scan, run the following query:</span></span>  
  
```sql
SELECT * from sys.dm_cdc_log_scan_sessions where empty_scan_count <> 0
```
  
### <a name="determine-latency"></a><span data-ttu-id="6fa5f-183">Determinar a latência</span><span class="sxs-lookup"><span data-stu-id="6fa5f-183">Determine Latency</span></span>  
 <span data-ttu-id="6fa5f-184">A exibição de gerenciamento sys.dm_cdc_log_scan_sessions inclui uma coluna que registra a latência de cada sessão de captura.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-184">The sys.dm_cdc_log_scan_sessions management view includes a column that records the latency for each capture session.</span></span> <span data-ttu-id="6fa5f-185">Latência é definida como o tempo decorrido entre uma transação que está sendo confirmada em uma tabela de origem e a última transação capturada que está sendo confirmada na tabela de alteração.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-185">Latency is defined as the elapsed time between a transaction being committed on a source table and the last captured transaction being committed on the change table.</span></span> <span data-ttu-id="6fa5f-186">A coluna de latência só é preenchida para sessões ativas.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-186">The latency column is populated only for active sessions.</span></span> <span data-ttu-id="6fa5f-187">Para sessões com um valor maior que 0 na coluna empty_scan_count, a coluna de latência é definida como 0.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-187">For sessions with a value greater than 0 in the empty_scan_count column, the latency column is set to 0.</span></span> <span data-ttu-id="6fa5f-188">A seguinte consulta retorna a latência média das sessões mais recentes:</span><span class="sxs-lookup"><span data-stu-id="6fa5f-188">The following query returns the average latency for the most recent sessions:</span></span>  
  
```sql
SELECT latency FROM sys.dm_cdc_log_scan_sessions WHERE session_id = 0
```
  
 <span data-ttu-id="6fa5f-189">Você pode usar dados de latência para determinar a velocidade com que o processo de captura está processando as transações.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-189">You can use latency data to determine how fast or slow the capture process is processing transactions.</span></span> <span data-ttu-id="6fa5f-190">Esses dados são muito úteis quando o processo de captura é executado continuamente.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-190">This data is most useful when the capture process is running continuously.</span></span> <span data-ttu-id="6fa5f-191">Se o processo de captura for executado segundo uma agenda, a latência poderá ser alta devido ao atraso entre a confirmação das transações na tabela de origem e a execução do processo de captura no horário agendado.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-191">If the capture process is running on a schedule, latency can be high because of the lag between transactions being committed on the source table and the capture process running at its scheduled time.</span></span>  
  
 <span data-ttu-id="6fa5f-192">Outra medida importante que avalia a eficiência do processo de captura é a taxa de transferência.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-192">Another important measure of capture process efficiency is throughput.</span></span> <span data-ttu-id="6fa5f-193">Representa o número médio de comandos por segundo que são processados durante cada sessão.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-193">This is the average number of commands per second that are processed during each session.</span></span> <span data-ttu-id="6fa5f-194">Para determinar a taxa de transferência de uma sessão, divida o valor da coluna command_count pelo valor da coluna de duração.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-194">To determine the throughput of a session, divide the value in the command_count column by the value in the duration column.</span></span> <span data-ttu-id="6fa5f-195">A seguinte consulta retorna a taxa de transferência média das sessões mais recentes:</span><span class="sxs-lookup"><span data-stu-id="6fa5f-195">The following query returns the average throughput for the most recent sessions:</span></span>  
  
```sql
SELECT command_count/duration AS [Throughput] FROM sys.dm_cdc_log_scan_sessions WHERE session_id = 0
```
  
### <a name="use-data-collector-to-collect-sampling-data"></a><span data-ttu-id="6fa5f-196">Usar o coletor de dados para coletar dados de amostragem</span><span class="sxs-lookup"><span data-stu-id="6fa5f-196">Use Data Collector to Collect Sampling Data</span></span>  
 <span data-ttu-id="6fa5f-197">O coletor de dados do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] permite coletar instantâneos de dados de qualquer tabela ou exibição de gerenciamento dinâmico e criar um data warehouse de desempenho.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-197">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data collector lets you collect snapshots of data from any table or dynamic management view and build a performance data warehouse.</span></span> <span data-ttu-id="6fa5f-198">Quando a captura de dados de alteração está habilitada em um banco de dados, ela é útil para obter instantâneos das exibições sys.dm_cdc_log_scan_sessions e sys.dm_cdc_errors em intervalos regulares para análise posterior.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-198">When change data capture is enabled on a database, it is useful to take snapshots of the sys.dm_cdc_log_scan_sessions view and the sys.dm_cdc_errors view at regular intervals for later analysis.</span></span> <span data-ttu-id="6fa5f-199">O procedimento a seguir configura um coletor de dados para coletar dados de amostra da exibição de gerenciamento sys.dm_cdc_log_scan_sessions.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-199">The following procedure sets up a data collector for collecting sample data from the sys.dm_cdc_log_scan_sessions management view.</span></span>  
  
 <span data-ttu-id="6fa5f-200">**Configurando a coleta de dados**</span><span class="sxs-lookup"><span data-stu-id="6fa5f-200">**Configuring Data Collection**</span></span>  
  
1.  <span data-ttu-id="6fa5f-201">Habilite o coletor de dados e configure um data warehouse de gerenciamento.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-201">Enable data collector and configure a management data warehouse.</span></span> <span data-ttu-id="6fa5f-202">Para obter mais informações, consulte [Gerenciar coleta de dados](../data-collection/data-collection.md).</span><span class="sxs-lookup"><span data-stu-id="6fa5f-202">For more information, see [Manage Data Collection](../data-collection/data-collection.md).</span></span>  
  
2.  <span data-ttu-id="6fa5f-203">Execute o código a seguir para criar um coletor personalizado para captura de dados de alteração.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-203">Execute the following code to create a custom collector for change data capture.</span></span>  
  
    ```sql  
    USE msdb;  
  
    DECLARE @schedule_uid uniqueidentifier;  
  
    -- Collect and upload data every 5 minutes  
    SELECT @schedule_uid = (  
    SELECT schedule_uid from sysschedules_localserver_view   
    WHERE name = N'CollectorSchedule_Every_5min')  
  
    DECLARE @collection_set_id int;  
  
    EXEC dbo.sp_syscollector_create_collection_set  
    @name = N' CDC Performance Data Collector',  
    @schedule_uid = @schedule_uid,          
    @collection_mode = 0,                   
    @days_until_expiration = 30,                
    @description = N'This collection set collects CDC metadata',  
    @collection_set_id = @collection_set_id output;  
  
    -- Create a collection item using statistics from   
    -- the change data capture dynamic management view.  
    DECLARE @parameters xml;  
    DECLARE @collection_item_id int;  
  
    SELECT @parameters = CONVERT(xml,   
        N'<TSQLQueryCollector>  
            <Query>  
              <Value>SELECT * FROM sys.dm_cdc_log_scan_sessions</Value>  
              <OutputTable>cdc_log_scan_data</OutputTable>  
            </Query>  
          </TSQLQueryCollector>');  
  
    EXEC dbo.sp_syscollector_create_collection_item  
    @collection_set_id = @collection_set_id,  
    @collector_type_uid = N'302E93D1-3424-4BE7-AA8E-84813ECF2419',  
    @name = ' CDC Performance Data Collector',  
    @frequency = 5,   
    @parameters = @parameters,  
    @collection_item_id = @collection_item_id output;  
  
    GO  
    ```  
  
3.  <span data-ttu-id="6fa5f-204">No [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], expanda **Gerenciamento**e, em seguida, **Coleta de Dados**.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-204">In [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], expand **Management**, and then expand **Data Collection**.</span></span> <span data-ttu-id="6fa5f-205">Clique com o botão direito do mouse em **Coletor de Dados de Desempenho de CDC**e clique em **Iniciar Conjunto de Coleta de Dados**.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-205">Right click **CDC Performance Data Collector**, and then click **Start Data Collection Set**.</span></span>  
  
4.  <span data-ttu-id="6fa5f-206">No data warehouse configurado na etapa 1, localize a tabela custom_snapshots.cdc_log_scan_data.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-206">In the data warehouse you configured in step 1, locate the table custom_snapshots.cdc_log_scan_data.</span></span> <span data-ttu-id="6fa5f-207">Essa tabela fornece um instantâneo histórico dos dados das sessões de verificação de log.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-207">This table provides a historical snapshot of data from log scan sessions.</span></span> <span data-ttu-id="6fa5f-208">Esses dados podem ser usados para analisar a latência, a taxa de transferência e outras medidas de desempenho ao longo do tempo.</span><span class="sxs-lookup"><span data-stu-id="6fa5f-208">This data can be used to analyze latency, throughput, and other performance measures over time.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="6fa5f-209">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="6fa5f-209">See Also</span></span>  
 <span data-ttu-id="6fa5f-210">[Controle de alterações de dados &#40;SQL Server&#41;](track-data-changes-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="6fa5f-210">[Track Data Changes &#40;SQL Server&#41;](track-data-changes-sql-server.md) </span></span>  
 <span data-ttu-id="6fa5f-211">[Sobre a captura de dados de alterações &#40;SQL Server&#41;](../track-changes/about-change-data-capture-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="6fa5f-211">[About Change Data Capture &#40;SQL Server&#41;](../track-changes/about-change-data-capture-sql-server.md) </span></span>  
 <span data-ttu-id="6fa5f-212">[Habilitar e desabilitar a captura de dados de alterações &#40;SQL Server&#41;](enable-and-disable-change-data-capture-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="6fa5f-212">[Enable and Disable Change Data Capture &#40;SQL Server&#41;](enable-and-disable-change-data-capture-sql-server.md) </span></span>  
 [<span data-ttu-id="6fa5f-213">Trabalhar com dados de alterações &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="6fa5f-213">Work with Change Data &#40;SQL Server&#41;</span></span>](work-with-change-data-sql-server.md)  
  
  
