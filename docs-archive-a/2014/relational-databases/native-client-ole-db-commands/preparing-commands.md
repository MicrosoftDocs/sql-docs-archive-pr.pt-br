---
title: Como preparar comandos | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- SQL Server Native Client OLE DB provider, commands
- prepared statements [SQL Server Native Client]
- commands [OLE DB]
- command preparation [SQL Server Native Client]
ms.assetid: 09ec0c6c-0a44-4766-b9b7-5092f676ee54
author: rothja
ms.author: jroth
ms.openlocfilehash: e06e6afab622953452a00751e3a55d49fc7b8ec7
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87679354"
---
# <a name="preparing-commands"></a><span data-ttu-id="62560-102">Preparando comandos</span><span class="sxs-lookup"><span data-stu-id="62560-102">Preparing Commands</span></span>
  <span data-ttu-id="62560-103">O provedor de dados OLE DB do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client oferece suporte à preparação de comando tendo em vista várias execuções de um único comando. No entanto, ela gera sobrecarga, e um cliente não precisa preparar um comando para ser executado mais de uma vez.</span><span class="sxs-lookup"><span data-stu-id="62560-103">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports command preparation for optimized multiple execution of a single command; however, command preparation generates overhead, and a consumer does not need to prepare a command to execute it more than once.</span></span> <span data-ttu-id="62560-104">Em geral, um comando deverá ser preparado se for executado mais de três vezes.</span><span class="sxs-lookup"><span data-stu-id="62560-104">In general, a command should be prepared if it will be executed more than three times.</span></span>  
  
 <span data-ttu-id="62560-105">Por razões de desempenho, a preparação é adiada até que o comando seja executado.</span><span class="sxs-lookup"><span data-stu-id="62560-105">For performance reasons, the command preparation is deferred until the command is executed.</span></span> <span data-ttu-id="62560-106">Esse é o comportamento padrão.</span><span class="sxs-lookup"><span data-stu-id="62560-106">This is the default behavior.</span></span> <span data-ttu-id="62560-107">Não são conhecidos erros no comando que está sendo preparada até que ele seja executado ou uma operação de metapropriedade seja executada.</span><span class="sxs-lookup"><span data-stu-id="62560-107">Any errors in the command being prepared are not known until the command is executed or a metaproperty operation is performed.</span></span> <span data-ttu-id="62560-108">Definir a propriedade SSPROP_DEFERPREPARE do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] como FALSE pode desativar esse comportamento padrão.</span><span class="sxs-lookup"><span data-stu-id="62560-108">Setting the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] property SSPROP_DEFERPREPARE to FALSE can turn off this default behavior.</span></span>  
  
 <span data-ttu-id="62560-109">No [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], quando um comando é executado diretamente (sem prepará-lo primeiro), um plano de execução é criado e armazenado em cache.</span><span class="sxs-lookup"><span data-stu-id="62560-109">In [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], when a command is executed directly (without preparing it first), an execution plan is created and cached.</span></span> <span data-ttu-id="62560-110">Caso a instrução SQL seja executada novamente, o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] conta com um algoritmo eficiente que compara a nova instrução com o plano de execução existente no cache e reutiliza o plano nessa instrução.</span><span class="sxs-lookup"><span data-stu-id="62560-110">If the SQL statement is executed again, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] has an efficient algorithm to match the new statement with the existing execution plan in the cache, and reuses the execution plan for that statement.</span></span>  
  
 <span data-ttu-id="62560-111">Em comandos preparados, o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] fornece suporte nativo à preparação e à execução das instruções de comando.</span><span class="sxs-lookup"><span data-stu-id="62560-111">For prepared commands, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] provides native support for preparing and executing command statements.</span></span> <span data-ttu-id="62560-112">Quando você prepara uma instrução, o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] cria um plano de execução, o armazena em cache e retorna um identificador desse plano para o provedor.</span><span class="sxs-lookup"><span data-stu-id="62560-112">When you prepare a statement, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] creates an execution plan, caches it, and returns a handle to this execution plan to the provider.</span></span> <span data-ttu-id="62560-113">Em seguida, o provedor usa esse identificador para executar a instrução repetidamente.</span><span class="sxs-lookup"><span data-stu-id="62560-113">The provider then uses this handle to execute the statement repeatedly.</span></span> <span data-ttu-id="62560-114">Não é criado nenhum procedimento armazenado.</span><span class="sxs-lookup"><span data-stu-id="62560-114">No stored procedures are created.</span></span> <span data-ttu-id="62560-115">Como o identificador aponta diretamente o plano de execução de uma instrução SQL, e não a correspondência entre a instrução e o plano de execução no cache (como acontece com a execução direta), é mais eficiente preparar uma instrução do que executá-la diretamente, caso você saiba que ela será executada mais de uma vez.</span><span class="sxs-lookup"><span data-stu-id="62560-115">Because the handle directly identifies the execution plan for an SQL statement instead of matching the statement to the execution plan in the cache (as is the case for direct execution), it is more efficient to prepare a statement than to execute it directly, if you know the statement will be executed more than a few times.</span></span>  
  
 <span data-ttu-id="62560-116">No [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], as instruções preparadas não podem ser usadas para criar objetos temporários e referenciar procedimentos armazenados do sistema que criam objetos temporários, como tabelas temporárias.</span><span class="sxs-lookup"><span data-stu-id="62560-116">In [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], the prepared statements cannot be used to create temporary objects and cannot reference system stored procedures that create temporary objects, such as temporary tables.</span></span> <span data-ttu-id="62560-117">Esses procedimentos devem ser executados diretamente.</span><span class="sxs-lookup"><span data-stu-id="62560-117">These procedures must be executed directly.</span></span>  
  
 <span data-ttu-id="62560-118">Alguns comandos jamais devem ser preparados.</span><span class="sxs-lookup"><span data-stu-id="62560-118">Some commands should never be prepared.</span></span> <span data-ttu-id="62560-119">Por exemplo, os comandos que especificam a execução de procedimento armazenado ou incluem texto tendo em vista a criação do procedimento armazenado do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] jamais devem ser preparados.</span><span class="sxs-lookup"><span data-stu-id="62560-119">For example, commands that specify stored procedure execution or include invalid text for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] stored procedure creation should not be prepared.</span></span>  
  
 <span data-ttu-id="62560-120">Caso um procedimento armazenado temporário seja criado, o provedor OLE DB do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client o executa, retornando resultados como se a instrução propriamente dita fosse executada.</span><span class="sxs-lookup"><span data-stu-id="62560-120">If a temporary stored procedure is created, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider executes the temporary stored procedure, returning results as if the statement itself was executed.</span></span>  
  
 <span data-ttu-id="62560-121">A criação de procedimento armazenado temporário é controlada pela propriedade de inicialização SSPROP_INIT_USEPROCFORPREP, específica do provedor OLE DB do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client.</span><span class="sxs-lookup"><span data-stu-id="62560-121">Temporary stored procedure creation is controlled by the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider -specific initialization property SSPROP_INIT_USEPROCFORPREP.</span></span> <span data-ttu-id="62560-122">Caso o valor de propriedade seja SSPROPVAL_USEPROCFORPREP_ON ou SSPROPVAL_USEPROCFORPREP_ON_DROP, o provedor OLE DB do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client tenta criar um procedimento armazenado durante a preparação de um comando.</span><span class="sxs-lookup"><span data-stu-id="62560-122">If the property value is either SSPROPVAL_USEPROCFORPREP_ON or SSPROPVAL_USEPROCFORPREP_ON_DROP, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider attempts to create a stored procedure when a command is prepared.</span></span> <span data-ttu-id="62560-123">A criação do procedimento armazenado tem êxito caso o usuário do aplicativo tenha permissões suficientes no [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="62560-123">Stored procedure creation succeeds if the application user has sufficient [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] permissions.</span></span>  
  
 <span data-ttu-id="62560-124">Para clientes que não costumam se desconectar, a criação de procedimentos armazenados temporários pode exigir recursos significativos de **tempdb**, o banco de dados do sistema do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], no qual os objetos temporários são criados.</span><span class="sxs-lookup"><span data-stu-id="62560-124">For consumers that infrequently disconnect, creation of temporary stored procedures can require significant resources of **tempdb**, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] system database in which temporary objects are created.</span></span> <span data-ttu-id="62560-125">Quando o valor SSPROP_INIT_USEPROCFORPREP é SSPROPVAL_USEPROCFORPREP_ ON, os procedimentos armazenados temporários criados pelo provedor de dados OLE DB do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client só são descartados quando a sessão que criou o comando perde a conexão com a instância do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="62560-125">When the value of SSPROP_INIT_USEPROCFORPREP is SSPROPVAL_USEPROCFORPREP_ ON, temporary stored procedures created by the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider are dropped only when the session that created the command loses its connection to the instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="62560-126">Caso essa conexão seja a padrão criada na inicialização da fonte de dados, o procedimento armazenado temporário só é descartado quando a fonte de dados deixa de ser inicializada.</span><span class="sxs-lookup"><span data-stu-id="62560-126">If that connection is the default connection created on data source initialization, the temporary stored procedure is dropped only when the data source becomes uninitialized.</span></span>  
  
 <span data-ttu-id="62560-127">Quando o valor de SSPROP_INIT_USEPROCFORPREP é SSPROPVAL_USEPROCFORPREP_ON_DROP, os procedimentos armazenados temporários do provedor OLE DB do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client são descartados quando ocorre uma das seguintes condições:</span><span class="sxs-lookup"><span data-stu-id="62560-127">When the value of SSPROP_INIT_USEPROCFORPREP is SSPROPVAL_USEPROCFORPREP_ON_DROP, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider temporary stored procedures are dropped when one of the following occurs:</span></span>  
  
-   <span data-ttu-id="62560-128">O consumidor usa **ICommandText::SetCommandText** para indicar um novo comando.</span><span class="sxs-lookup"><span data-stu-id="62560-128">The consumer uses **ICommandText::SetCommandText** to indicate a new command.</span></span>  
  
-   <span data-ttu-id="62560-129">O consumidor usa **ICommandPrepare::Unprepare** para indicar que deixou de exigir o texto de comando.</span><span class="sxs-lookup"><span data-stu-id="62560-129">The consumer uses **ICommandPrepare::Unprepare** to indicate that it no longer requires the command text.</span></span>  
  
-   <span data-ttu-id="62560-130">O consumidor libera todas as referências ao objeto de comando que usa o procedimento armazenado temporário.</span><span class="sxs-lookup"><span data-stu-id="62560-130">The consumer releases all references to the command object using the temporary stored procedure.</span></span>  
  
 <span data-ttu-id="62560-131">Um objeto de comando tem, no máximo, um procedimento armazenado temporário em **tempdb**.</span><span class="sxs-lookup"><span data-stu-id="62560-131">A command object has at most one temporary stored procedure in **tempdb**.</span></span> <span data-ttu-id="62560-132">Qualquer procedimento armazenado temporário existente representa o texto de comando atual de um objeto de comando específico.</span><span class="sxs-lookup"><span data-stu-id="62560-132">Any existing temporary stored procedure represents the current command text of a specific command object.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="62560-133">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="62560-133">See Also</span></span>  
 [<span data-ttu-id="62560-134">Comandos</span><span class="sxs-lookup"><span data-stu-id="62560-134">Commands</span></span>](commands.md)  
  
  
