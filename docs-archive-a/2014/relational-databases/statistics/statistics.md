---
title: Estatísticas | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: performance
ms.topic: conceptual
helpviewer_keywords:
- statistical information [SQL Server], query optimization
- query performance [SQL Server], statistics
- query optimization statistics [SQL Server]
- statistical information [SQL Server], database options
- query optimization statistics [SQL Server], about query optimization statistics
- statistical information [SQL Server], guidelines
- statistical information [SQL Server]
- using statistics [SQL Server]
- statistical information [SQL Server], indexes
- index statistics [SQL Server]
- query optimizer [SQL Server], statistics
- statistics [SQL Server]
ms.assetid: b86a88ba-4f7c-4e19-9fbd-2f8bcd3be14a
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 0f0950e48245bed53581d2f91b120ab9555aa562
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87582358"
---
# <a name="statistics"></a><span data-ttu-id="a54ec-102">Estatísticas</span><span class="sxs-lookup"><span data-stu-id="a54ec-102">Statistics</span></span>
  <span data-ttu-id="a54ec-103">O otimizador de consulta utiliza estatísticas para criar planos de consulta que melhoram o desempenho das consultas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-103">The query optimizer uses statistics to create query plans that improve query performance.</span></span> <span data-ttu-id="a54ec-104">Para a maioria das consultas, o otimizador de consulta já gera as estatísticas necessárias para um plano de consulta de alta qualidade; em alguns casos, é necessário criar estatísticas adicionais ou modificar o design da consulta para obter melhores resultados.</span><span class="sxs-lookup"><span data-stu-id="a54ec-104">For most queries, the query optimizer already generates the necessary statistics for a high quality query plan; in a few cases, you need to create additional statistics or modify the query design for best results.</span></span> <span data-ttu-id="a54ec-105">Este tópico aborda os conceitos de estatísticas e fornece diretrizes para o uso eficiente de estatísticas de otimização de consultas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-105">This topic discusses statistics concepts and provides guidelines for using query optimization statistics effectively.</span></span>  
  
##  <a name="components-and-concepts"></a><a name="DefinitionQOStatistics"></a> <span data-ttu-id="a54ec-106">Componentes e conceitos</span><span class="sxs-lookup"><span data-stu-id="a54ec-106">Components and Concepts</span></span>  
 <span data-ttu-id="a54ec-107">Estatísticas</span><span class="sxs-lookup"><span data-stu-id="a54ec-107">Statistics</span></span>  
 <span data-ttu-id="a54ec-108">As estatísticas de otimização de consulta são objetos que contêm informações estatísticas sobre a distribuição de valores em uma ou mais colunas de uma tabela ou exibição indexada.</span><span class="sxs-lookup"><span data-stu-id="a54ec-108">Statistics for query optimization are objects that contain statistical information about the distribution of values in one or more columns of a table or indexed view.</span></span> <span data-ttu-id="a54ec-109">O otimizador de consulta usa essas estatísticas para estimar a *cardinalidade*ou o número de linhas no resultado da consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-109">The query optimizer uses these statistics to estimate the *cardinality*, or number of rows, in the query result.</span></span> <span data-ttu-id="a54ec-110">Essas *estimativas de cardinalidade* permitem que o otimizador de consulta crie um plano de consulta de alta qualidade.</span><span class="sxs-lookup"><span data-stu-id="a54ec-110">These *cardinality estimates* enable the query optimizer to create a high-quality query plan.</span></span> <span data-ttu-id="a54ec-111">Por exemplo, o otimizador de consulta pode usar estimativas de cardinalidade para escolher o operador index seek em vez do operador index scan, que utiliza mais recursos, e, assim, melhorar o desempenho das consultas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-111">For example, the query optimizer could use cardinality estimates to choose the index seek operator instead of the more resource-intensive index scan operator, and in doing so improve query performance.</span></span>  
  
 <span data-ttu-id="a54ec-112">Cada objeto de estatísticas é criado em uma lista de uma ou mais colunas de tabela e inclui um histograma que exibe a distribuição de valores na primeira coluna.</span><span class="sxs-lookup"><span data-stu-id="a54ec-112">Each statistics object is created on a list of one or more table columns and includes a histogram displaying the distribution of values in the first column.</span></span> <span data-ttu-id="a54ec-113">Os objetos de estatísticas em várias colunas também armazenam informações estatísticas sobre a correlação de valores entre as colunas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-113">Statistics objects on multiple columns also store statistical information about the correlation of values among the columns.</span></span> <span data-ttu-id="a54ec-114">Essas estatísticas de correlação, ou *densidades*, são derivadas do número de linhas distintas de valores de coluna.</span><span class="sxs-lookup"><span data-stu-id="a54ec-114">These correlation statistics, or *densities*, are derived from the number of distinct rows of column values.</span></span> <span data-ttu-id="a54ec-115">Para obter mais informações sobre objetos de estatísticas, veja [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a54ec-115">For more information about statistics objects, see [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span></span>  
  
 <span data-ttu-id="a54ec-116">Estatísticas filtradas</span><span class="sxs-lookup"><span data-stu-id="a54ec-116">Filtered Statistics</span></span>  
 <span data-ttu-id="a54ec-117">As estatísticas filtradas podem melhorar o desempenho de consultas selecionadas em subconjuntos bem definidos de dados.</span><span class="sxs-lookup"><span data-stu-id="a54ec-117">Filtered statistics can improve query performance for queries that select from well-defined subsets of data.</span></span> <span data-ttu-id="a54ec-118">As estatísticas filtradas usam um predicado do filtro para selecionar o subconjunto de dados incluído nas estatísticas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-118">Filtered statistics use a filter predicate to select the subset of data that is included in the statistics.</span></span> <span data-ttu-id="a54ec-119">Estatísticas filtradas bem projetadas podem aprimorar o plano de execução de consultas em comparação com as estatísticas de tabela completa.</span><span class="sxs-lookup"><span data-stu-id="a54ec-119">Well-designed filtered statistics can improve the query execution plan compared with full-table statistics.</span></span> <span data-ttu-id="a54ec-120">Para obter mais informações sobre o predicado de filtro, veja [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a54ec-120">For more information about the filter predicate, see [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql).</span></span> <span data-ttu-id="a54ec-121">Para obter mais informações sobre quando criar estatísticas filtradas, consulte a seção [Quando criar estatísticas](#UpdateStatistics) neste tópico.</span><span class="sxs-lookup"><span data-stu-id="a54ec-121">For more information about when to create filtered statistics, see the [When to Create Statistics](#UpdateStatistics) section in this topic.</span></span> <span data-ttu-id="a54ec-122">Para um estudo de caso, consulte a entrada de blog, [Usando estatísticas filtradas com tabelas particionadas](https://go.microsoft.com/fwlink/?LinkId=178505), no site do SQLCAT.</span><span class="sxs-lookup"><span data-stu-id="a54ec-122">For a case study, see the blog entry, [Using Filtered Statistics with Partitioned Tables](https://go.microsoft.com/fwlink/?LinkId=178505), on the SQLCAT Web site.</span></span>  
  
 <span data-ttu-id="a54ec-123">Opções de estatísticas</span><span class="sxs-lookup"><span data-stu-id="a54ec-123">Statistics Options</span></span>  
 <span data-ttu-id="a54ec-124">Há três opções que você pode definir que afetam quando e como as estatísticas são criadas e atualizadas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-124">There are three options that you can set that affect when and how statistics are created and updated.</span></span> <span data-ttu-id="a54ec-125">Estas opções são definidas no nível do banco de dados somente.</span><span class="sxs-lookup"><span data-stu-id="a54ec-125">These options are set at the database level only.</span></span>  
  
 <span data-ttu-id="a54ec-126">Opção AUTO_CREATE_STATISTICS</span><span class="sxs-lookup"><span data-stu-id="a54ec-126">AUTO_CREATE_STATISTICS Option</span></span>  
 <span data-ttu-id="a54ec-127">Quando a opção de criação automática de estatísticas, AUTO_CREATE_STATISTICS, está ativada, o otimizador de consulta cria estatísticas em colunas individuais no predicado de consulta, conforme necessário, a fim de melhorar as estimativas de cardinalidade do plano de consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-127">When the automatic create statistics option, AUTO_CREATE_STATISTICS, is on, the query optimizer creates statistics on individual columns in the query predicate, as necessary, to improve cardinality estimates for the query plan.</span></span> <span data-ttu-id="a54ec-128">Essas estatísticas de coluna única são criadas em colunas que ainda não têm um histograma em um objeto de estatísticas existente.</span><span class="sxs-lookup"><span data-stu-id="a54ec-128">These single-column statistics are created on columns that do not already have a histogram in an existing statistics object.</span></span> <span data-ttu-id="a54ec-129">A opção AUTO_CREATE_STATISTICS não determina se são criadas estatísticas para índices.</span><span class="sxs-lookup"><span data-stu-id="a54ec-129">The AUTO_CREATE_STATISTICS option does not determine whether statistics get created for indexes.</span></span> <span data-ttu-id="a54ec-130">Essa opção também não gera estatísticas filtradas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-130">This option also does not generate filtered statistics.</span></span> <span data-ttu-id="a54ec-131">Ela se aplica estritamente a estatísticas de coluna única para a tabela completa.</span><span class="sxs-lookup"><span data-stu-id="a54ec-131">It applies strictly to single-column statistics for the full table.</span></span>  
  
 <span data-ttu-id="a54ec-132">Quando o otimizador de consulta cria estatísticas como resultado do uso da opção AUTO_CREATE_STATISTICS, os nomes das estatísticas iniciam com `_WA`.</span><span class="sxs-lookup"><span data-stu-id="a54ec-132">When the query optimizer creates statistics as a result of using the AUTO_CREATE_STATISTICS option, the statistics name starts with `_WA`.</span></span> <span data-ttu-id="a54ec-133">Você pode usar a consulta a seguir para determinar se o otimizador de consulta criou estatísticas para uma coluna de predicado de consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-133">You can use the following query to determine if the query optimizer has created statistics for a query predicate column.</span></span>  
  
```  
SELECT OBJECT_NAME(s.object_id) AS object_name,  
    COL_NAME(sc.object_id, sc.column_id) AS column_name,  
    s.name AS statistics_name  
FROM sys.stats AS s JOIN sys.stats_columns AS sc  
    ON s.stats_id = sc.stats_id AND s.object_id = sc.object_id  
WHERE s.name like '_WA%'  
ORDER BY s.name;  
```  
  
 <span data-ttu-id="a54ec-134">Opção AUTO_UPDATE_STATISTICS</span><span class="sxs-lookup"><span data-stu-id="a54ec-134">AUTO_UPDATE_STATISTICS Option</span></span>  
 <span data-ttu-id="a54ec-135">Quando a opção de atualização automática de estatísticas, AUTO_UPDATE_STATISTICS, está ativada, o otimizador de consulta determina quando as estatísticas podem estar desatualizadas e as atualiza quando são usadas por uma consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-135">When the automatic update statistics option, AUTO_UPDATE_STATISTICS, is on, the query optimizer determines when statistics might be out-of-date and then updates them when they are used by a query.</span></span> <span data-ttu-id="a54ec-136">As estatísticas ficam desatualizadas depois que operações de inserção, atualização, exclusão ou mesclagem alteram a distribuição de dados na tabela ou na exibição indexada.</span><span class="sxs-lookup"><span data-stu-id="a54ec-136">Statistics become out-of-date after insert, update, delete, or merge operations change the data distribution in the table or indexed view.</span></span> <span data-ttu-id="a54ec-137">O otimizador de consulta determina quando estatísticas podem estar desatualizadas contando o número de modificações de dados desde a última atualização das estatísticas e comparando o número de modificações a um limite.</span><span class="sxs-lookup"><span data-stu-id="a54ec-137">The query optimizer determines when statistics might be out-of-date by counting the number of data modifications since the last statistics update and comparing the number of modifications to a threshold.</span></span> <span data-ttu-id="a54ec-138">O limite se baseia no número de linhas na tabela ou na exibição indexada.</span><span class="sxs-lookup"><span data-stu-id="a54ec-138">The threshold is based on the number of rows in the table or indexed view.</span></span>  
  
 <span data-ttu-id="a54ec-139">O otimizador de consulta procura estatísticas desatualizadas antes de compilar uma consulta e antes de executar um plano de consulta em cache.</span><span class="sxs-lookup"><span data-stu-id="a54ec-139">The query optimizer checks for out-of-date statistics before compiling a query and before executing a cached query plan.</span></span> <span data-ttu-id="a54ec-140">Antes de compilar uma consulta, o otimizador de consulta usa as colunas, tabelas e exibições indexadas no predicado de consulta para determinar quais estatísticas podem estar desatualizadas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-140">Before compiling a query, the query optimizer uses the columns, tables, and indexed views in the query predicate to determine which statistics might be out-of-date.</span></span> <span data-ttu-id="a54ec-141">Antes de executar um plano de consulta em cache, o [!INCLUDE[ssDE](../../../includes/ssde-md.md)] verifica se o plano de consulta faz referência a estatísticas atualizadas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-141">Before executing a cached query plan, the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] verifies that the query plan references up-to-date statistics.</span></span>  
  
 <span data-ttu-id="a54ec-142">A opção AUTO_UPDATE_STATISTICS se aplica a objetos de estatísticas criados para índices, colunas únicas em predicados de consulta e estatísticas criadas com a instrução [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="a54ec-142">The AUTO_UPDATE_STATISTICS option applies to statistics objects created for indexes, single-columns in query predicates, and statistics created with the [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) statement.</span></span> <span data-ttu-id="a54ec-143">Essa opção também se aplica a estatísticas filtradas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-143">This option also applies to filtered statistics.</span></span>  
  
 <span data-ttu-id="a54ec-144">AUTO_UPDATE_STATISTICS_ASYNC</span><span class="sxs-lookup"><span data-stu-id="a54ec-144">AUTO_UPDATE_STATISTICS_ASYNC</span></span>  
 <span data-ttu-id="a54ec-145">A opção de atualização de estatísticas assíncrona, AUTO_UPDATE_STATISTICS_ASYNC, determina se o otimizador de consulta usa atualizações de estatísticas síncronas ou assíncronas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-145">The asynchronous statistics update option, AUTO_UPDATE_STATISTICS_ASYNC, determines whether the query optimizer uses synchronous or asynchronous statistics updates.</span></span> <span data-ttu-id="a54ec-146">Por padrão, a opção de atualização de estatísticas assíncrona está desativada e o otimizador de consulta atualiza estatísticas de forma síncrona.</span><span class="sxs-lookup"><span data-stu-id="a54ec-146">By default, the asynchronous statistics update option is off, and the query optimizer updates statistics synchronously.</span></span> <span data-ttu-id="a54ec-147">A opção AUTO_UPDATE_STATISTICS_ASYNC se aplica a objetos de estatísticas criados para índices, colunas únicas em predicados de consulta e estatísticas criadas com a instrução [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="a54ec-147">The AUTO_UPDATE_STATISTICS_ASYNC option applies to statistics objects created for indexes, single columns in query predicates, and statistics created with the [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) statement.</span></span>  
  
 <span data-ttu-id="a54ec-148">As atualizações de estatísticas podem ser síncronas (o padrão) ou assíncronas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-148">Statistics updates can be either synchronous (the default) or asynchronous.</span></span> <span data-ttu-id="a54ec-149">Com as atualizações de estatísticas síncronas, as consultas são sempre compiladas e executadas com estatísticas atualizadas. Quando as estatísticas estão desatualizadas, o otimizador de consulta aguarda estatísticas atualizadas antes de compilar e executar a consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-149">With synchronous statistics updates, queries always compile and execute with up-to-date statistics; When statistics are out-of-date, the query optimizer waits for updated statistics before compiling and executing the query.</span></span> <span data-ttu-id="a54ec-150">Com as atualizações de estatísticas assíncronas, as consultas são compiladas com estatísticas existentes, mesmo que elas estejam desatualizas. O otimizador de consulta poderá escolher um plano de consulta com qualidade inferior se as estatísticas estiverem desatualizadas na compilação da consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-150">With asynchronous statistics updates, queries compile with existing statistics even if the existing statistics are out-of-date; The query optimizer could choose a suboptimal query plan if statistics are out-of-date when the query compiles.</span></span> <span data-ttu-id="a54ec-151">As consultas compiladas após a conclusão das atualizações assíncronas serão beneficiadas por usarem estatísticas atualizadas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-151">Queries that compile after the asynchronous updates have completed will benefit from using the updated statistics.</span></span>  
  
 <span data-ttu-id="a54ec-152">Considere o uso de estatísticas síncronas ao executar operações que alteram a distribuição de dados, como truncar uma tabela ou executar uma atualização em massa de uma porcentagem grande das linhas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-152">Consider using synchronous statistics when you perform operations that change the distribution of data, such as truncating a table or performing a bulk update of a large percentage of the rows.</span></span> <span data-ttu-id="a54ec-153">Se você não atualizar as estatísticas depois de concluir a operação, o uso de estatísticas síncronas garantirá que as estatísticas sejam atualizadas antes de executar consultas nos dados alterados.</span><span class="sxs-lookup"><span data-stu-id="a54ec-153">If you do not update the statistics after completing the operation, using synchronous statistics will ensure statistics are up-to-date before executing queries on the changed data.</span></span>  
  
 <span data-ttu-id="a54ec-154">Considere o uso de estatísticas assíncronas para obter tempos de resposta de consulta mais previsíveis para os seguintes cenários:</span><span class="sxs-lookup"><span data-stu-id="a54ec-154">Consider using asynchronous statistics to achieve more predictable query response times for the following scenarios:</span></span>  
  
-   <span data-ttu-id="a54ec-155">Seu aplicativo executa frequentemente a mesma consulta, consultas semelhantes ou planos de consulta em cache semelhantes.</span><span class="sxs-lookup"><span data-stu-id="a54ec-155">Your application frequently executes the same query, similar queries, or similar cached query plans.</span></span> <span data-ttu-id="a54ec-156">Os tempos de resposta de consulta podem ser mais previsíveis com atualizações de estatísticas assíncronas do que com atualizações de estatísticas síncronas, pois o otimizador de consulta pode executar consultas de entrada sem aguardar estatísticas atualizadas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-156">Your query response times might be more predictable with asynchronous statistics updates than with synchronous statistics updates because the query optimizer can execute incoming queries without waiting for up-to-date statistics.</span></span> <span data-ttu-id="a54ec-157">Isso evita o atraso de algumas consultas e não de outras.</span><span class="sxs-lookup"><span data-stu-id="a54ec-157">This avoids delaying some queries and not others.</span></span>  
  
-   <span data-ttu-id="a54ec-158">Seu aplicativo excedeu o tempo limite de solicitações do cliente pelo fato de uma ou mais consultas estarem aguardando a atualização de estatísticas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-158">Your application has experienced client request time outs caused by one or more queries waiting for updated statistics.</span></span> <span data-ttu-id="a54ec-159">Em alguns casos, a espera por estatísticas síncronas pode gerar falhas em aplicativos com tempo limite restrito.</span><span class="sxs-lookup"><span data-stu-id="a54ec-159">In some cases, waiting for synchronous statistics could cause applications with aggressive time outs to fail.</span></span>  
  
 <span data-ttu-id="a54ec-160">INCREMENTAL STATS</span><span class="sxs-lookup"><span data-stu-id="a54ec-160">INCREMENTAL STATS</span></span>  
 <span data-ttu-id="a54ec-161">Quando estiver ON, as estatísticas serão criadas por estatísticas de partição.</span><span class="sxs-lookup"><span data-stu-id="a54ec-161">When ON, the statistics created are per partition statistics.</span></span> <span data-ttu-id="a54ec-162">Quando estiver OFF, a árvore de estatísticas será ignorada e o [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] recomputará as estatísticas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-162">When OFF, the statistics tree is dropped and [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] re-computes the statistics.</span></span> <span data-ttu-id="a54ec-163">O padrão é OFF.</span><span class="sxs-lookup"><span data-stu-id="a54ec-163">The default is OFF.</span></span> <span data-ttu-id="a54ec-164">Essa configuração substitui a propriedade INCREMENTAL de nível de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="a54ec-164">This setting overrides the database level INCREMENTAL property.</span></span>  
  
 <span data-ttu-id="a54ec-165">Quando as novas partições são adicionados a uma tabela grande, as estatísticas devem ser atualizadas para incluir as novas partições.</span><span class="sxs-lookup"><span data-stu-id="a54ec-165">When new partitions are added to a large table, statistics should be updated to include the new partitions.</span></span> <span data-ttu-id="a54ec-166">No entanto, o tempo necessário para digitalizar a tabela inteira (opção FULLSCAN ou SAMPLE) podem ser muito longos.</span><span class="sxs-lookup"><span data-stu-id="a54ec-166">However the time required to scan the entire table (FULLSCAN or SAMPLE option) might be quite long.</span></span> <span data-ttu-id="a54ec-167">Além disso, digitalizar a tabela inteira não é necessário porque somente as estatísticas nas novas partições podem ser necessárias.</span><span class="sxs-lookup"><span data-stu-id="a54ec-167">Also, scanning the entire table isn't necessary because only the statistics on the new partitions might be needed.</span></span> <span data-ttu-id="a54ec-168">A opção incremental cria e armazena estatísticas por partição e, quando atualizada, somente atualiza estatísticas nessas partições que precisam de novas estatísticas</span><span class="sxs-lookup"><span data-stu-id="a54ec-168">The incremental option creates and stores statistics on a per partition basis, and when updated, only refreshes statistics on those partitions that need new statistics</span></span>  
  
 <span data-ttu-id="a54ec-169">Se as estatísticas por partição não tiverem suporte, a opção será ignorada e um aviso será gerado.</span><span class="sxs-lookup"><span data-stu-id="a54ec-169">If per partition statistics are not supported the option is ignored and a warning is generated.</span></span> <span data-ttu-id="a54ec-170">As estatísticas incrementais não têm suporte para os seguintes tipos de estatísticas:</span><span class="sxs-lookup"><span data-stu-id="a54ec-170">Incremental stats are not supported for following statistics types:</span></span>  
  
-   <span data-ttu-id="a54ec-171">Estatísticas criadas com os índices que não estejam alinhados por partição com a tabela base.</span><span class="sxs-lookup"><span data-stu-id="a54ec-171">Statistics created with indexes that are not partition-aligned with the base table.</span></span>  
  
-   <span data-ttu-id="a54ec-172">Estatísticas criadas em bancos de dados secundários legíveis AlwaysOn.</span><span class="sxs-lookup"><span data-stu-id="a54ec-172">Statistics created on AlwaysOn readable secondary databases.</span></span>  
  
-   <span data-ttu-id="a54ec-173">Estatísticas criadas em bancos de dados somente leitura.</span><span class="sxs-lookup"><span data-stu-id="a54ec-173">Statistics created on read-only databases.</span></span>  
  
-   <span data-ttu-id="a54ec-174">Estatísticas criadas em índices filtrados.</span><span class="sxs-lookup"><span data-stu-id="a54ec-174">Statistics created on filtered indexes.</span></span>  
  
-   <span data-ttu-id="a54ec-175">Estatísticas criadas em exibições.</span><span class="sxs-lookup"><span data-stu-id="a54ec-175">Statistics created on views.</span></span>  
  
-   <span data-ttu-id="a54ec-176">Estatísticas criadas em tabelas internas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-176">Statistics created on internal tables.</span></span>  
  
-   <span data-ttu-id="a54ec-177">Estatísticas criadas com índices espaciais ou índices XML.</span><span class="sxs-lookup"><span data-stu-id="a54ec-177">Statistics created with spatial indexes or XML indexes.</span></span>  
  
||  
|-|  
|<span data-ttu-id="a54ec-178">**Aplica-se a**: do [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] ao [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a54ec-178">**Applies to**: [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] through [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>|  
  
##  <a name="when-to-create-statistics"></a><a name="CreateStatistics"></a><span data-ttu-id="a54ec-179">Quando criar estatísticas</span><span class="sxs-lookup"><span data-stu-id="a54ec-179">When to Create Statistics</span></span>  
 <span data-ttu-id="a54ec-180">O otimizador de consulta já cria estatísticas das seguintes maneiras:</span><span class="sxs-lookup"><span data-stu-id="a54ec-180">The query optimizer already creates statistics in the following ways:</span></span>  
  
1.  <span data-ttu-id="a54ec-181">O otimizador de consulta cria estatísticas para índices em tabelas ou exibições quando o índice é criado.</span><span class="sxs-lookup"><span data-stu-id="a54ec-181">The query optimizer creates statistics for indexes on tables or views when the index is created.</span></span> <span data-ttu-id="a54ec-182">Essas estatísticas são criadas nas colunas de chaves do índice.</span><span class="sxs-lookup"><span data-stu-id="a54ec-182">These statistics are created on the key columns of the index.</span></span> <span data-ttu-id="a54ec-183">Se o índice for um índice filtrado, o otimizador de consulta criará estatísticas filtradas no mesmo subconjunto de linhas especificado para o índice filtrado.</span><span class="sxs-lookup"><span data-stu-id="a54ec-183">If the index is a filtered index, the query optimizer creates filtered statistics on the same subset of rows specified for the filtered index.</span></span> <span data-ttu-id="a54ec-184">Para obter mais informações sobre índices filtrados, veja [Criar índices filtrados](../indexes/create-filtered-indexes.md) e [CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a54ec-184">For more information about filtered indexes, see [Create Filtered Indexes](../indexes/create-filtered-indexes.md) and [CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql).</span></span>  
  
2.  <span data-ttu-id="a54ec-185">O otimizador de consulta cria estatísticas para colunas únicas em predicados de consulta quando AUTO_CREATE_STATISTICS estiver ativada.</span><span class="sxs-lookup"><span data-stu-id="a54ec-185">The query optimizer creates statistics for single columns in query predicates when AUTO_CREATE_STATISTICS is on.</span></span>  
  
 <span data-ttu-id="a54ec-186">Para a maioria das consultas, esses dois métodos para criar estatísticas asseguram um plano de consulta de alta qualidade; em alguns casos, você pode aprimorar os planos de consulta criando estatísticas adicionais com a instrução [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="a54ec-186">For most queries, these two methods for creating statistics ensure a high-quality query plan; in a few cases, you can improve query plans by creating additional statistics with the [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) statement.</span></span> <span data-ttu-id="a54ec-187">Essas estatísticas adicionais podem capturar correlações estatísticas que o otimizador de consulta não considera ao criar estatísticas para índices ou colunas únicas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-187">These additional statistics can capture statistical correlations that the query optimizer does not account for when it creates statistics for indexes or single columns.</span></span> <span data-ttu-id="a54ec-188">Seu aplicativo pode ter correlações estatísticas adicionais nos dados de tabela que, se calculadas em um objeto de estatísticas, pode permitir que o otimizador de consulta aprimore os planos de consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-188">Your application might have additional statistical correlations in the table data that, if calculated into a statistics object, could enable the query optimizer to improve query plans.</span></span> <span data-ttu-id="a54ec-189">Por exemplo, estatísticas filtradas em um subconjunto de linhas de dados ou estatísticas multicolunas em colunas de predicado de consulta podem aprimorar o plano de consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-189">For example, filtered statistics on a subset of data rows or multicolumn statistics on query predicate columns might improve the query plan.</span></span>  
  
 <span data-ttu-id="a54ec-190">Ao criar estatísticas com a instrução CREATE STATISTICS, é recomendável manter a opção AUTO_CREATE_STATISTICS ativada de forma que o otimizador de consulta continue criando estatísticas da coluna única rotineiramente para colunas de predicado de consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-190">When creating statistics with the CREATE STATISTICS statement, we recommend keeping the AUTO_CREATE_STATISTICS option on so that the query optimizer continues to routinely create single-column statistics for query predicate columns.</span></span> <span data-ttu-id="a54ec-191">Para obter mais informações sobre predicados de consulta, veja [Critério de pesquisa &#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a54ec-191">For more information about query predicates, see [Search Condition &#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span></span>  
  
 <span data-ttu-id="a54ec-192">Considere a criação de estatísticas com a instrução CREATE STATISTICS quando alguma das seguintes opções se aplicar:</span><span class="sxs-lookup"><span data-stu-id="a54ec-192">Consider creating statistics with the CREATE STATISTICS statement when any of the following applies:</span></span>  
  
-   <span data-ttu-id="a54ec-193">O Orientador de Otimização do [!INCLUDE[ssDE](../../../includes/ssde-md.md)] sugere a criação de estatísticas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-193">The [!INCLUDE[ssDE](../../../includes/ssde-md.md)] Tuning Advisor suggests creating statistics.</span></span>  
  
-   <span data-ttu-id="a54ec-194">O predicado de consulta contém várias colunas correlacionadas que ainda não estão no mesmo índice.</span><span class="sxs-lookup"><span data-stu-id="a54ec-194">The query predicate contains multiple correlated columns that are not already in the same index.</span></span>  
  
-   <span data-ttu-id="a54ec-195">A consulta faz a seleção em um subconjunto de dados.</span><span class="sxs-lookup"><span data-stu-id="a54ec-195">The query selects from a subset of data.</span></span>  
  
-   <span data-ttu-id="a54ec-196">Há estatísticas ausentes na consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-196">The query has missing statistics.</span></span>  
  
### <a name="query-predicate-contains-multiple-correlated-columns"></a><span data-ttu-id="a54ec-197">O predicado de consulta contém várias colunas correlacionadas</span><span class="sxs-lookup"><span data-stu-id="a54ec-197">Query Predicate Contains Multiple Correlated Columns</span></span>  
 <span data-ttu-id="a54ec-198">Quando um predicado de consulta contém várias colunas que têm relações e dependências entre colunas, as estatísticas nas várias colunas podem aprimorar o plano de consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-198">When a query predicate contains multiple columns that have cross-column relationships and dependencies, statistics on the multiple columns might improve the query plan.</span></span> <span data-ttu-id="a54ec-199">As estatísticas em várias colunas contêm estatísticas de correlação entre colunas, chamadas *densidades*, que não estão disponíveis em estatísticas de coluna única.</span><span class="sxs-lookup"><span data-stu-id="a54ec-199">Statistics on multiple columns contain cross-column correlation statistics, called *densities*, that are not available in single-column statistics.</span></span> <span data-ttu-id="a54ec-200">As densidades podem aprimorar as estimativas de cardinalidade quando os resultados de consulta dependem de relações de dados entre várias colunas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-200">Densities can improve cardinality estimates when query results depend on data relationships among multiple columns.</span></span>  
  
 <span data-ttu-id="a54ec-201">Se as colunas já estiverem no mesmo índice, o objeto de estatísticas multicolunas já existirá e não será necessário criá-lo manualmente.</span><span class="sxs-lookup"><span data-stu-id="a54ec-201">If the columns are already in the same index, the multicolumn statistics object already exists and it is not necessary to create it manually.</span></span> <span data-ttu-id="a54ec-202">Se as colunas ainda não estiverem no mesmo índice, você poderá criar estatísticas multicolunas criando um índice nas colunas ou usando a instrução CREATE STATISTICS.</span><span class="sxs-lookup"><span data-stu-id="a54ec-202">If the columns are not already in the same index, you can create multicolumn statistics by creating an index on the columns or by using the CREATE STATISTICS statement.</span></span> <span data-ttu-id="a54ec-203">A manutenção de um índice exige mais recursos do sistema do que a de um objeto de estatísticas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-203">It requires more system resources to maintain an index than a statistics object.</span></span> <span data-ttu-id="a54ec-204">Se o aplicativo não exigir o índice multicolunas, você poderá economizar recursos do sistema criando o objeto de estatísticas sem criar o índice.</span><span class="sxs-lookup"><span data-stu-id="a54ec-204">If the application does not require the multicolumn index, you can economize on system resources by creating the statistics object without creating the index.</span></span>  
  
 <span data-ttu-id="a54ec-205">Ao criar estatísticas multicolunas, a ordem das colunas na definição do objeto de estatísticas afeta a efetividade de densidades para calcular estimativas de cardinalidade.</span><span class="sxs-lookup"><span data-stu-id="a54ec-205">When creating multicolumn statistics, the order of the columns in the statistics object definition affects the effectiveness of densities for making cardinality estimates.</span></span> <span data-ttu-id="a54ec-206">O objeto de estatísticas armazena densidades para cada prefixo de colunas de chave na definição do objeto.</span><span class="sxs-lookup"><span data-stu-id="a54ec-206">The statistics object stores densities for each prefix of key columns in the statistics object definition.</span></span> <span data-ttu-id="a54ec-207">Para obter mais informações sobre densidades, veja [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a54ec-207">For more information about densities, see [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span></span>  
  
 <span data-ttu-id="a54ec-208">Para criar densidades úteis para estimativas de cardinalidade, as colunas no predicado de consulta devem corresponder a um dos prefixos de colunas na definição do objeto de estatísticas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-208">To create densities that are useful for cardinality estimates, the columns in the query predicate must match one of the prefixes of columns in the statistics object definition.</span></span> <span data-ttu-id="a54ec-209">O exemplo a seguir cria um objeto de estatísticas multicolunas nas colunas `LastName`, `MiddleName`e `FirstName`.</span><span class="sxs-lookup"><span data-stu-id="a54ec-209">For example, the following creates a multicolumn statistics object on the columns `LastName`, `MiddleName`, and `FirstName`.</span></span>  
  
```  
USE AdventureWorks2012;  
GO  
IF EXISTS (SELECT name FROM sys.stats  
    WHERE name = 'LastFirst'  
    AND object_ID = OBJECT_ID ('Person.Person'))  
DROP STATISTICS Person.Person.LastFirst;  
GO  
CREATE STATISTICS LastFirst ON Person.Person (LastName, MiddleName, FirstName);  
GO  
```  
  
 <span data-ttu-id="a54ec-210">Neste exemplo, o objeto de estatísticas `LastFirst` possui densidades para os seguintes prefixos de coluna: (`LastName`), (`LastName, MiddleName`) e (`LastName, MiddleName, FirstName`).</span><span class="sxs-lookup"><span data-stu-id="a54ec-210">In this example, the statistics object `LastFirst` has densities for the following column prefixes: (`LastName`), (`LastName, MiddleName`), and (`LastName, MiddleName, FirstName`).</span></span> <span data-ttu-id="a54ec-211">A densidade não está disponível para (`LastName, FirstName`).</span><span class="sxs-lookup"><span data-stu-id="a54ec-211">The density is not available for (`LastName, FirstName`).</span></span> <span data-ttu-id="a54ec-212">Se a consulta usar `LastName` e `FirstName` sem usar `MiddleName`, a densidade não estará disponível para estimativas de cardinalidade.</span><span class="sxs-lookup"><span data-stu-id="a54ec-212">If the query uses `LastName` and `FirstName` without using `MiddleName`, the density is not available for cardinality estimates.</span></span>  
  
### <a name="query-selects-from-a-subset-of-data"></a><span data-ttu-id="a54ec-213">A consulta faz seleções em um subconjunto de dados</span><span class="sxs-lookup"><span data-stu-id="a54ec-213">Query Selects from a Subset of Data</span></span>  
 <span data-ttu-id="a54ec-214">Quando o otimizador de consulta cria estatísticas para colunas únicas e índices, as estatísticas são criadas para os valores em todas as linhas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-214">When the query optimizer creates statistics for single columns and indexes, it creates the statistics for the values in all rows.</span></span> <span data-ttu-id="a54ec-215">Quando as consultas fazem seleções em um subconjunto de linhas e esse subconjunto tem uma distribuição de dados exclusiva, as estatísticas filtradas podem aprimorar os planos de consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-215">When queries select from a subset of rows, and that subset of rows has a unique data distribution, filtered statistics can improve query plans.</span></span> <span data-ttu-id="a54ec-216">É possível criar estatísticas filtradas usando a instrução CREATE STATISTICS com a cláusula WHERE para definir a expressão de predicado de filtro.</span><span class="sxs-lookup"><span data-stu-id="a54ec-216">You can create filtered statistics by using the CREATE STATISTICS statement with the WHERE clause to define the filter predicate expression.</span></span>  
  
 <span data-ttu-id="a54ec-217">Por exemplo, usando o [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)], cada produto da tabela Production.Product pertence a uma das quatro categorias da tabela Production.ProductCategory: Bicicletas, Componentes, Vestuário e Acessórios.</span><span class="sxs-lookup"><span data-stu-id="a54ec-217">For example, using [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)], each product in the Production.Product table belongs to one of four categories in the Production.ProductCategory table: Bikes, Components, Clothing, and Accessories.</span></span> <span data-ttu-id="a54ec-218">Cada categoria possui uma distribuição de dados diferente para peso: as bicicletas pesam de 13,77 a 30, os componentes pesam de 2,12 a 1050,00 com alguns valores NULL, o peso de todas as roupas é NULL e o peso dos acessórios também é NULL.</span><span class="sxs-lookup"><span data-stu-id="a54ec-218">Each of the categories has a different data distribution for weight: bike weights range from 13.77 to 30.0, component weights range from 2.12 to 1050.00 with some NULL values, clothing weights are all NULL, and accessory weights are also NULL.</span></span>  
  
 <span data-ttu-id="a54ec-219">Usando Bicicletas como um exemplo, as estatísticas filtradas em todos os pesos de bicicleta fornecerão estatísticas mais precisas ao otimizador de consultas e podem melhorar a qualidade do plano de consulta comparadas com as estatísticas de tabela completa ou estatísticas inexistentes na coluna Peso.</span><span class="sxs-lookup"><span data-stu-id="a54ec-219">Using Bikes as an example, filtered statistics on all bike weights will provide more accurate statistics to the query optimizer and can improve the query plan quality compared with full-table statistics or nonexistent statistics on the Weight column.</span></span> <span data-ttu-id="a54ec-220">A coluna de peso das bicicletas é uma boa candidata para estatísticas filtradas, mas não necessariamente para um índice filtrado se o número de pesquisas de peso for relativamente pequeno.</span><span class="sxs-lookup"><span data-stu-id="a54ec-220">The bike weight column is a good candidate for filtered statistics but not necessarily a good candidate for a filtered index if the number of weight lookups is relatively small.</span></span> <span data-ttu-id="a54ec-221">O ganho de desempenho que um índice filtrado oferece às pesquisas pode não compensar os custos adicionais com a manutenção e o custo de armazenamento exigidos para adicionar um índice filtrado ao banco de dados.</span><span class="sxs-lookup"><span data-stu-id="a54ec-221">The performance gain for lookups that a filtered index provides might not outweigh the additional maintenance and storage cost for adding a filtered index to the database.</span></span>  
  
 <span data-ttu-id="a54ec-222">A instrução a seguir cria as estatísticas filtradas de `BikeWeights` em todas as subcategorias de Bicicletas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-222">The following statement creates the `BikeWeights` filtered statistics on all of the subcategories for Bikes.</span></span> <span data-ttu-id="a54ec-223">A expressão de predicado filtrada define bicicletas enumerando todas as suas subcategorias com a comparação `Production.ProductSubcategoryID IN (1,2,3)`.</span><span class="sxs-lookup"><span data-stu-id="a54ec-223">The filtered predicate expression defines bikes by enumerating all of the bike subcategories with the comparison `Production.ProductSubcategoryID IN (1,2,3)`.</span></span> <span data-ttu-id="a54ec-224">O predicado não pode usar o nome de categoria Bicicletas porque ele está armazenado na tabela Production.ProductCategory e todas as colunas na expressão de filtro devem estar na mesma tabela.</span><span class="sxs-lookup"><span data-stu-id="a54ec-224">The predicate cannot use the Bikes category name because it is stored in the Production.ProductCategory table, and all columns in the filter expression must be in the same table.</span></span>  
  
 [!code-sql[StatisticsDDL#FilteredStats2](../../snippets/tsql/SQL14/tsql/statisticsddl/transact-sql/filteredstats.sql#filteredstats2)]  
  
 <span data-ttu-id="a54ec-225">O otimizador de consulta pode usar as estatísticas filtradas de `BikeWeights` para aprimorar o plano da consulta a seguir, que seleciona todas as bicicletas que pesam mais de `25`.</span><span class="sxs-lookup"><span data-stu-id="a54ec-225">The query optimizer can use the `BikeWeights` filtered statistics to improve the query plan for the following query that selects all of the bikes that weigh more than `25`.</span></span>  
  
```  
SELECT P.Weight AS Weight, S.Name AS BikeName  
FROM Production.Product AS P  
    JOIN Production.ProductSubcategory AS S   
    ON P.ProductSubcategoryID = S.ProductSubcategoryID  
WHERE P.ProductSubcategoryID IN (1,2,3) AND P.Weight > 25  
ORDER BY P.Weight;  
GO  
```  
  
### <a name="query-identifies-missing-statistics"></a><span data-ttu-id="a54ec-226">A consulta identifica estatísticas ausentes</span><span class="sxs-lookup"><span data-stu-id="a54ec-226">Query Identifies Missing Statistics</span></span>  
 <span data-ttu-id="a54ec-227">Se um erro ou outro evento impedir que o otimizador de consulta crie estatísticas, o otimizador criará o plano de consulta sem usar estatísticas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-227">If an error or other event prevents the query optimizer from creating statistics, the query optimizer creates the query plan without using statistics.</span></span> <span data-ttu-id="a54ec-228">O otimizador de consulta marca as estatísticas como ausentes e tenta gerar as estatísticas novamente na próxima execução da consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-228">The query optimizer marks the statistics as missing and attempts to regenerate the statistics the next time the query is executed.</span></span>  
  
 <span data-ttu-id="a54ec-229">As estatísticas ausentes são indicadas como avisos (nome de tabela em texto vermelho) quando o plano de execução de uma consulta é exibido graficamente usando o [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a54ec-229">Missing statistics are indicated as warnings (table name in red text) when the execution plan of a query is graphically displayed using [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span></span> <span data-ttu-id="a54ec-230">Além disso, o monitoramento da classe de evento **Missing Column Statistics** usando o [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] indica quando há estatísticas ausentes.</span><span class="sxs-lookup"><span data-stu-id="a54ec-230">Additionally, monitoring the **Missing Column Statistics** event class by using [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] indicates when statistics are missing.</span></span> <span data-ttu-id="a54ec-231">Para obter mais informações, veja [Categoria de evento de erros e de avisos &#40;Mecanismo de Banco de Dados&#41;](../event-classes/errors-and-warnings-event-category-database-engine.md).</span><span class="sxs-lookup"><span data-stu-id="a54ec-231">For more information, see [Errors and Warnings Event Category &#40;Database Engine&#41;](../event-classes/errors-and-warnings-event-category-database-engine.md).</span></span>  
  
 <span data-ttu-id="a54ec-232">Se houver estatísticas ausentes, execute as seguintes etapas:</span><span class="sxs-lookup"><span data-stu-id="a54ec-232">If statistics are missing, perform the following steps:</span></span>  
  
-   <span data-ttu-id="a54ec-233">Verifique se AUTO_CREATE_STATISTICS e AUTO_UPDATE_STATISTICS estão ativadas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-233">Verify that AUTO_CREATE_STATISTICS and AUTO_UPDATE_STATISTICS are on.</span></span>  
  
-   <span data-ttu-id="a54ec-234">Verifique se o banco de dados não é somente leitura.</span><span class="sxs-lookup"><span data-stu-id="a54ec-234">Verify that the database is not read-only.</span></span> <span data-ttu-id="a54ec-235">Se o banco de dados for somente leitura, o otimizador de consulta não poderá salvar estatísticas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-235">If the database is read-only, the query optimizer cannot save statistics.</span></span>  
  
-   <span data-ttu-id="a54ec-236">Crie as estatísticas ausentes usando a instrução CREATE STATISTICS.</span><span class="sxs-lookup"><span data-stu-id="a54ec-236">Create the missing statistics by using the CREATE STATISTICS statement.</span></span>  
  
 <span data-ttu-id="a54ec-237">Quando as estatísticas em um banco de dados somente leitura ou um instantâneo somente leitura estão ausentes ou obsoletas, o [!INCLUDE[ssDE](../../../includes/ssde-md.md)] cria e mantém estatísticas temporárias em `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="a54ec-237">When statistics on a read-only database or read-only snapshot are missing or stale, the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] creates and maintains temporary statistics in `tempdb`.</span></span> <span data-ttu-id="a54ec-238">Quando o [!INCLUDE[ssDE](../../../includes/ssde-md.md)] cria estatísticas temporárias, o nome das estatísticas é anexado com o sufixo _readonly_database_statistic para diferenciar as estatísticas temporárias de estatísticas permanentes.</span><span class="sxs-lookup"><span data-stu-id="a54ec-238">When the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] creates temporary statistics, the statistics name is appended with the suffix _readonly_database_statistic to differentiate the temporary statistics from the permanent statistics.</span></span> <span data-ttu-id="a54ec-239">O sufixo _readonly_database_statistic fica reservado para estatísticas geradas pelo [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a54ec-239">The suffix _readonly_database_statistic is reserved for statistics generated by [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="a54ec-240">É possível criar e reproduzir scripts para as estatísticas temporárias em um banco de dados de leitura-gravação.</span><span class="sxs-lookup"><span data-stu-id="a54ec-240">Scripts for the temporary statistics can be created and reproduced on a read-write database.</span></span> <span data-ttu-id="a54ec-241">Quando em script, o [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] altera o sufixo do nome das estatísticas de _readonly_database_statistic para _readonly_database_statistic_scripted.</span><span class="sxs-lookup"><span data-stu-id="a54ec-241">When scripted, [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] changes the suffix of the statistics name from _readonly_database_statistic to _readonly_database_statistic_scripted.</span></span>  
  
 <span data-ttu-id="a54ec-242">Somente o [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] pode criar e atualizar estatísticas temporárias.</span><span class="sxs-lookup"><span data-stu-id="a54ec-242">Only [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] can create and update temporary statistics.</span></span> <span data-ttu-id="a54ec-243">No entanto, você pode excluir estatísticas temporárias e monitorar as propriedades de estatísticas que usam as mesmas ferramentas que você utiliza para estatísticas permanentes:</span><span class="sxs-lookup"><span data-stu-id="a54ec-243">However, you can delete temporary statistics and monitor statistics properties using the same tools that you use for permanent statistics:</span></span>  
  
-   <span data-ttu-id="a54ec-244">Exclua estatísticas temporárias usando a instrução [DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="a54ec-244">Delete temporary statistics using the [DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) statement.</span></span>  
  
-   <span data-ttu-id="a54ec-245">Para monitorar as estatísticas, use as exibições de catálogo **sys.stats** e **sys.stats_columns** .</span><span class="sxs-lookup"><span data-stu-id="a54ec-245">Monitor statistics using the **sys.stats** and **sys.stats_columns** catalog views.</span></span> <span data-ttu-id="a54ec-246">**sys_stats** inclui a coluna, **is_temporary** para indicar quais estatísticas são permanentes e quais são temporárias.</span><span class="sxs-lookup"><span data-stu-id="a54ec-246">**sys_stats** includes the **is_temporary** column, to indicate which statistics are permanent and which are temporary.</span></span>  
  
 <span data-ttu-id="a54ec-247">Como as estatísticas temporárias são armazenadas em `tempdb`, uma reinicialização do serviço [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] faz com que todas as estatísticas temporárias desapareçam.</span><span class="sxs-lookup"><span data-stu-id="a54ec-247">Because temporary statistics are stored in `tempdb`, a restart of the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] service causes all temporary statistics to disappear.</span></span>  
  
##  <a name="when-to-update-statistics"></a><a name="UpdateStatistics"></a><span data-ttu-id="a54ec-248">Quando atualizar estatísticas</span><span class="sxs-lookup"><span data-stu-id="a54ec-248">When to Update Statistics</span></span>  
 <span data-ttu-id="a54ec-249">O otimizador de consulta determina quando as estatísticas podem estar desatualizadas e as atualiza quando forem necessárias para um plano de consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-249">The query optimizer determines when statistics might be out-of-date and then updates them when they are needed for a query plan.</span></span> <span data-ttu-id="a54ec-250">Em alguns casos, você pode aprimorar o plano de consulta e, portanto, o desempenho da consulta por meio da atualização mais frequente das estatísticas do que quando AUTO_UPDATE_STATISTICS está ativada.</span><span class="sxs-lookup"><span data-stu-id="a54ec-250">In some cases you can improve the query plan and therefore improve query performance by updating statistics more frequently than occur when AUTO_UPDATE_STATISTICS is on.</span></span> <span data-ttu-id="a54ec-251">Você pode atualizar estatísticas com a instrução UPDATE STATISTICS ou o procedimento armazenado sp_updatestats.</span><span class="sxs-lookup"><span data-stu-id="a54ec-251">You can update statistics with the UPDATE STATISTICS statement or the stored procedure sp_updatestats.</span></span>  
  
 <span data-ttu-id="a54ec-252">A atualização de estatísticas assegura que as consultas sejam compiladas com estatísticas atualizadas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-252">Updating statistics ensures that queries compile with up-to-date statistics.</span></span> <span data-ttu-id="a54ec-253">Porém, a atualização de estatísticas faz com que as consultas sejam recompiladas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-253">However, updating statistics causes queries to recompile.</span></span> <span data-ttu-id="a54ec-254">É recomendável não atualizar estatísticas com muita frequência porque existe uma compensação de desempenho entre o aprimoramento dos planos de consulta e o tempo necessário para recompilar consultas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-254">We recommend not updating statistics too frequently because there is a performance tradeoff between improving query plans and the time it takes to recompile queries.</span></span> <span data-ttu-id="a54ec-255">As compensações específicas dependem do seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a54ec-255">The specific tradeoffs depend on your application.</span></span>  
  
 <span data-ttu-id="a54ec-256">Quando você atualizar estatísticas com UPDATE STATISTICS ou sp_updatestats, recomendamos manter a opção AUTO_UPDATE_STATISTICS ativada de forma que o otimizador de consultas continue a atualizar estatísticas periodicamente.</span><span class="sxs-lookup"><span data-stu-id="a54ec-256">When updating statistics with UPDATE STATISTICS or sp_updatestats, we recommend keeping AUTO_UPDATE_STATISTICS set to ON so that the query optimizer continues to routinely update statistics.</span></span> <span data-ttu-id="a54ec-257">Para obter mais informações sobre como atualizar estatísticas em uma coluna, um índice, uma tabela ou uma exibição indexada, veja [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a54ec-257">For more information about how to update statistics on a column, an index, a table, or an indexed view, see [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql).</span></span> <span data-ttu-id="a54ec-258">Para obter informações sobre como atualizar estatísticas de todas as tabelas definidas pelo usuário e internas no banco de dados, veja o procedimento armazenado [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a54ec-258">For information about how to update statistics for all user-defined and internal tables in the database, see the stored procedure [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span></span>  
  
 <span data-ttu-id="a54ec-259">Para determinar quando as estatísticas foram atualizadas pela última vez, use a função [STATS_DATE](/sql/t-sql/functions/stats-date-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="a54ec-259">To determine when statistics were last updated, use the [STATS_DATE](/sql/t-sql/functions/stats-date-transact-sql) function.</span></span>  
  
 <span data-ttu-id="a54ec-260">Considere a atualização de estatísticas nas seguintes condições:</span><span class="sxs-lookup"><span data-stu-id="a54ec-260">Consider updating statistics for the following conditions:</span></span>  
  
-   <span data-ttu-id="a54ec-261">Os tempos de execução de consulta estão lentos.</span><span class="sxs-lookup"><span data-stu-id="a54ec-261">Query execution times are slow.</span></span>  
  
-   <span data-ttu-id="a54ec-262">As operações de inserção ocorrem em colunas de chaves crescentes ou decrescentes.</span><span class="sxs-lookup"><span data-stu-id="a54ec-262">Insert operations occur on ascending or descending key columns.</span></span>  
  
-   <span data-ttu-id="a54ec-263">Após operações de manutenção.</span><span class="sxs-lookup"><span data-stu-id="a54ec-263">After maintenance operations.</span></span>  
  
### <a name="query-execution-times-are-slow"></a><span data-ttu-id="a54ec-264">Os tempos de execução de consulta estão lentos</span><span class="sxs-lookup"><span data-stu-id="a54ec-264">Query Execution Times Are Slow</span></span>  
 <span data-ttu-id="a54ec-265">Se os tempos de resposta de consultas estiverem lentos ou imprevisíveis, verifique se as consultas têm estatísticas atualizadas antes de executar as etapas adicionais de solução de problemas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-265">If query response times are slow or unpredictable, ensure that queries have up-to-date statistics before performing additional troubleshooting steps.</span></span>  
  
### <a name="insert-operations-occur-on-ascending-or-descending-key-columns"></a><span data-ttu-id="a54ec-266">As operações de inserção ocorrem em colunas de chaves crescentes ou decrescentes</span><span class="sxs-lookup"><span data-stu-id="a54ec-266">Insert Operations Occur on Ascending or Descending Key Columns</span></span>  
 <span data-ttu-id="a54ec-267">As estatísticas em colunas de chaves crescentes ou decrescentes, como colunas IDENTITY ou colunas de carimbo de data/hora em tempo real, podem exigir atualizações de estatísticas mais frequentes do que as executadas pelo otimizador de consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-267">Statistics on ascending or descending key columns, such as IDENTITY or real-time timestamp columns, might require more frequent statistics updates than the query optimizer performs.</span></span> <span data-ttu-id="a54ec-268">As operações de inserção acrescentam novos valores às colunas crescentes ou decrescentes.</span><span class="sxs-lookup"><span data-stu-id="a54ec-268">Insert operations append new values to ascending or descending columns.</span></span> <span data-ttu-id="a54ec-269">O número de linhas adicionadas pode ser muito pequeno para disparar uma atualização de estatísticas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-269">The number of rows added might be too small to trigger a statistics update.</span></span> <span data-ttu-id="a54ec-270">Se as estatísticas não estiverem atualizadas e as consultas fizerem seleções nas linhas adicionadas mais recentemente, as estatísticas atuais não terão estimativas de cardinalidade para obter esses novos valores.</span><span class="sxs-lookup"><span data-stu-id="a54ec-270">If statistics are not up-to-date and queries select from the most recently added rows, the current statistics will not have cardinality estimates for these new values.</span></span> <span data-ttu-id="a54ec-271">Isso pode resultar em estimativas de cardinalidade imprecisas e lentidão no desempenho de consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-271">This can result in inaccurate cardinality estimates and slow query performance.</span></span>  
  
 <span data-ttu-id="a54ec-272">Por exemplo, uma consulta que faz seleções em ordens de venda com as datas mais recentes terá estimativas de cardinalidade imprecisas, se as estatísticas não forem atualizadas para incluir estimativas de cardinalidade dessas ordens de venda.</span><span class="sxs-lookup"><span data-stu-id="a54ec-272">For example, a query that selects from the most recent sales order dates will have inaccurate cardinality estimates if the statistics are not updated to include cardinality estimates for the most recent sales order dates.</span></span>  
  
### <a name="after-maintenance-operations"></a><span data-ttu-id="a54ec-273">Após operações de manutenção</span><span class="sxs-lookup"><span data-stu-id="a54ec-273">After Maintenance Operations</span></span>  
 <span data-ttu-id="a54ec-274">Considere a atualização de estatísticas depois de executar procedimentos de manutenção que alteram a distribuição de dados, como truncar uma tabela ou executar uma inserção em massa de uma porcentagem grande das linhas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-274">Consider updating statistics after performing maintenance procedures that change the distribution of data, such as truncating a table or performing a bulk insert of a large percentage of the rows.</span></span> <span data-ttu-id="a54ec-275">Isso pode evitar futuros atrasos no processamento de consultas enquanto elas aguardam atualizações de estatísticas automáticas.</span><span class="sxs-lookup"><span data-stu-id="a54ec-275">This can avoid future delays in query processing while queries wait for automatic statistics updates.</span></span>  
  
 <span data-ttu-id="a54ec-276">Operações como reconstrução, desfragmentação ou reorganização de um índice não alteram a distribuição de dados.</span><span class="sxs-lookup"><span data-stu-id="a54ec-276">Operations such as rebuilding, defragmenting, or reorganizing an index do not change the distribution of data.</span></span> <span data-ttu-id="a54ec-277">Portanto, não é necessário atualizar estatísticas depois de executar as operações ALTER INDEX REBUILD, DBCC REINDEX, DBCC INDEXDEFRAG ou ALTER INDEX REORGANIZE.</span><span class="sxs-lookup"><span data-stu-id="a54ec-277">Therefore, you do not need to update statistics after performing ALTER INDEX REBUILD, DBCC REINDEX, DBCC INDEXDEFRAG, or ALTER INDEX REORGANIZE operations.</span></span> <span data-ttu-id="a54ec-278">O otimizador de consulta atualiza estatísticas quando você reconstrói um índice em uma tabela ou exibição com ALTER INDEX REBUILD ou DBCC DBREINDEX; porém, essa atualização de estatísticas é um subproduto da recriação do índice.</span><span class="sxs-lookup"><span data-stu-id="a54ec-278">The query optimizer updates statistics when you rebuild an index on a table or view with ALTER INDEX REBUILD or DBCC DBREINDEX, however; this statistics update is a byproduct of re-creating the index.</span></span> <span data-ttu-id="a54ec-279">O otimizador de consulta não atualiza estatísticas depois de operações DBCC INDEXDEFRAG ou ALTER INDEX REORGANIZE.</span><span class="sxs-lookup"><span data-stu-id="a54ec-279">The query optimizer does not update statistics after DBCC INDEXDEFRAG or ALTER INDEX REORGANIZE operations.</span></span>  
  
##  <a name="queries-that-use-statistics-effectively"></a><a name="DesignStatistics"></a><span data-ttu-id="a54ec-280">Consultas que usam estatísticas com eficiência</span><span class="sxs-lookup"><span data-stu-id="a54ec-280">Queries That Use Statistics Effectively</span></span>  
 <span data-ttu-id="a54ec-281">Algumas implementações de consulta, como variáveis locais e expressões complexas no predicado de consulta, podem gerar planos de consulta de qualidade inferior.</span><span class="sxs-lookup"><span data-stu-id="a54ec-281">Certain query implementations, such as local variables and complex expressions in the query predicate, can lead to suboptimal query plans.</span></span> <span data-ttu-id="a54ec-282">O cumprimento das diretrizes de design de consulta para o uso eficiente de estatísticas pode ajudar a evitar esse problema.</span><span class="sxs-lookup"><span data-stu-id="a54ec-282">Following query design guidelines for using statistics effectively can help to avoid this.</span></span> <span data-ttu-id="a54ec-283">Para obter mais informações sobre predicados de consulta, veja [Critério de pesquisa &#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a54ec-283">For more information about query predicates, see [Search Condition &#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span></span>  
  
 <span data-ttu-id="a54ec-284">Você pode melhorar planos de consulta aplicando diretrizes de design de consulta que usam estatísticas de modo eficiente para aprimorar *estimativas de cardinalidade* para expressões, variáveis e funções usadas em predicados de consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-284">You can improve query plans by applying query design guidelines that use statistics effectively to improve *cardinality estimates* for expressions, variables, and functions used in query predicates.</span></span> <span data-ttu-id="a54ec-285">Quando o otimizador de consulta não souber o valor de uma expressão, variável ou função, ele não saberá qual o valor a ser pesquisado no histograma e, portanto, não poderá recuperar a melhor estimativa de cardinalidade do histograma.</span><span class="sxs-lookup"><span data-stu-id="a54ec-285">When the query optimizer does not know the value of an expression, variable, or function, it does not know which value to lookup in the histogram and therefore cannot retrieve the best cardinality estimate from the histogram.</span></span> <span data-ttu-id="a54ec-286">Em vez disso, o otimizador de consulta baseia a estimativa de cardinalidade no número médio de linhas por valor distinto de todas as linhas de amostra no histograma.</span><span class="sxs-lookup"><span data-stu-id="a54ec-286">Instead, the query optimizer bases the cardinality estimate on the average number of rows per distinct value for all of the sampled rows in the histogram.</span></span> <span data-ttu-id="a54ec-287">Isso gera estimativas de cardinalidade de qualidade inferior e pode prejudicar o desempenho de consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-287">This leads to suboptimal cardinality estimates and can hurt query performance.</span></span>  
  
 <span data-ttu-id="a54ec-288">As diretrizes a seguir descrevem como escrever consultas para melhorar planos de consulta por meio do aprimoramento das estimativas de cardinalidade.</span><span class="sxs-lookup"><span data-stu-id="a54ec-288">The following guidelines describe how to write queries to improve query plans by improving cardinality estimates.</span></span>  
  
### <a name="improving-cardinality-estimates-for-expressions"></a><span data-ttu-id="a54ec-289">Aprimorando estimativas de cardinalidade para expressões</span><span class="sxs-lookup"><span data-stu-id="a54ec-289">Improving Cardinality Estimates for Expressions</span></span>  
 <span data-ttu-id="a54ec-290">Para aprimorar as estimativas de cardinalidade para expressões, siga estas diretrizes:</span><span class="sxs-lookup"><span data-stu-id="a54ec-290">To improve cardinality estimates for expressions, follow these guidelines:</span></span>  
  
-   <span data-ttu-id="a54ec-291">Sempre que possível, simplifique expressões com constantes.</span><span class="sxs-lookup"><span data-stu-id="a54ec-291">Whenever possible, simplify expressions with constants in them.</span></span> <span data-ttu-id="a54ec-292">O otimizador de consulta não avalia todas as funções e expressões que contêm constantes antes de determinar as estimativas de cardinalidade.</span><span class="sxs-lookup"><span data-stu-id="a54ec-292">The query optimizer does not evaluate all functions and expressions containing constants prior to determining cardinality estimates.</span></span> <span data-ttu-id="a54ec-293">Por exemplo, simplifique a expressão ABS (`-100) to 100`.</span><span class="sxs-lookup"><span data-stu-id="a54ec-293">For example, simplify the expression ABS(`-100) to 100`.</span></span>  
  
-   <span data-ttu-id="a54ec-294">Se a expressão usar muitas variáveis, considere a criação de uma coluna computada para a expressão e crie estatísticas ou um índice na coluna computada.</span><span class="sxs-lookup"><span data-stu-id="a54ec-294">If the expression uses multiple variables, consider creating a computed column for the expression and then create statistics or an index on the computed column.</span></span> <span data-ttu-id="a54ec-295">Por exemplo, o predicado de consulta `WHERE PRICE + Tax > 100` poderá ter uma estimativa de cardinalidade melhor se você criar uma coluna computada para a expressão `Price + Tax`.</span><span class="sxs-lookup"><span data-stu-id="a54ec-295">For example, the query predicate `WHERE PRICE + Tax > 100` might have a better cardinality estimate if you create a computed column for the expression `Price + Tax`.</span></span>  
  
### <a name="improving-cardinality-estimates-for-variables-and-functions"></a><span data-ttu-id="a54ec-296">Melhorando estimativas de cardinalidade para variáveis e funções</span><span class="sxs-lookup"><span data-stu-id="a54ec-296">Improving Cardinality Estimates for Variables and Functions</span></span>  
 <span data-ttu-id="a54ec-297">Para melhorar as estimativas de cardinalidade para variáveis e funções, siga estas diretrizes:</span><span class="sxs-lookup"><span data-stu-id="a54ec-297">To improve the cardinality estimates for variables and functions, follow these guidelines:</span></span>  
  
-   <span data-ttu-id="a54ec-298">Se o predicado de consulta usar uma variável local, considere reescrever a consulta para usar um parâmetro em vez de uma variável local.</span><span class="sxs-lookup"><span data-stu-id="a54ec-298">If the query predicate uses a local variable, consider rewriting the query to use a parameter instead of a local variable.</span></span> <span data-ttu-id="a54ec-299">O valor de uma variável local não é conhecido quando o otimizador de consulta cria o plano de execução de consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-299">The value of a local variable is not known when the query optimizer creates the query execution plan.</span></span> <span data-ttu-id="a54ec-300">Quando uma consulta usar um parâmetro, o otimizador de consulta usará a estimativa de cardinalidade para o primeiro valor de parâmetro real transmitido ao procedimento armazenado.</span><span class="sxs-lookup"><span data-stu-id="a54ec-300">When a query uses a parameter, the query optimizer uses the cardinality estimate for the first actual parameter value that is passed to the stored procedure.</span></span>  
  
-   <span data-ttu-id="a54ec-301">Considere o uso de uma tabela padrão ou uma tabela temporária para manter os resultados de funções com valor de tabela de várias instruções.</span><span class="sxs-lookup"><span data-stu-id="a54ec-301">Consider using a standard table or temporary table to hold the results of multi-statement table-valued functions.</span></span> <span data-ttu-id="a54ec-302">O otimizador de consulta não cria estatísticas para funções com valor de tabela de várias instruções.</span><span class="sxs-lookup"><span data-stu-id="a54ec-302">The query optimizer does not create statistics for multi-statement table-valued functions.</span></span> <span data-ttu-id="a54ec-303">Com essa abordagem, o otimizador de consulta pode criar estatísticas nas colunas de tabela e usá-las para criar um plano de consulta melhor.</span><span class="sxs-lookup"><span data-stu-id="a54ec-303">With this approach the query optimizer can create statistics on the table columns and use them to create a better query plan.</span></span>  
  
-   <span data-ttu-id="a54ec-304">Considere o uso de uma tabela padrão ou uma tabela temporária como uma substituição para variáveis de tabela.</span><span class="sxs-lookup"><span data-stu-id="a54ec-304">Consider using a standard table or temporary table as a replacement for table variables.</span></span> <span data-ttu-id="a54ec-305">O otimizador de consulta não cria estatísticas para variáveis de tabela.</span><span class="sxs-lookup"><span data-stu-id="a54ec-305">The query optimizer does not create statistics for table variables.</span></span> <span data-ttu-id="a54ec-306">Com essa abordagem, o otimizador de consulta pode criar estatísticas nas colunas de tabela e usá-las para criar um plano de consulta melhor.</span><span class="sxs-lookup"><span data-stu-id="a54ec-306">With this approach the query optimizer can create statistics on the table columns and use them to create a better query plan.</span></span> <span data-ttu-id="a54ec-307">Há compensações ao optar pelo uso de uma tabela temporária ou de uma variável de tabela; as variáveis de tabela usadas em procedimentos armazenados causam menos recompilações do procedimento armazenado que as tabelas temporárias.</span><span class="sxs-lookup"><span data-stu-id="a54ec-307">There are tradeoffs in determining whether to use a temporary table or a table variable; Table variables used in stored procedures cause fewer recompilations of the stored procedure than temporary tables.</span></span> <span data-ttu-id="a54ec-308">Dependendo do aplicativo, o uso de uma tabela temporária em vez de uma variável de tabela pode não melhorar o desempenho.</span><span class="sxs-lookup"><span data-stu-id="a54ec-308">Depending on the application, using a temporary table instead of a table variable might not improve performance.</span></span>  
  
-   <span data-ttu-id="a54ec-309">Se um procedimento armazenado contiver uma consulta que usa um parâmetro transmitido, evite alterar o valor de parâmetro no procedimento armazenado antes de usá-lo na consulta.</span><span class="sxs-lookup"><span data-stu-id="a54ec-309">If a stored procedure contains a query that uses a passed-in parameter, avoid changing the parameter value within the stored procedure before using it in the query.</span></span> <span data-ttu-id="a54ec-310">As estimativas de cardinalidade da consulta se baseiam no valor de parâmetro transmitido, não no valor atualizado.</span><span class="sxs-lookup"><span data-stu-id="a54ec-310">The cardinality estimates for the query are based on the passed-in parameter value and not the updated value.</span></span> <span data-ttu-id="a54ec-311">Para evitar alterar o valor do parâmetro, você pode reescrever a consulta para usar dois procedimentos armazenados.</span><span class="sxs-lookup"><span data-stu-id="a54ec-311">To avoid changing the parameter value, you can rewrite the query to use two stored procedures.</span></span>  
  
     <span data-ttu-id="a54ec-312">Por exemplo, o procedimento armazenado `Sales.GetRecentSales` a seguir altera o valor do parâmetro `@date` quando `@date is NULL`.</span><span class="sxs-lookup"><span data-stu-id="a54ec-312">For example, the following stored procedure `Sales.GetRecentSales` changes the value of the parameter `@date` when `@date is NULL`.</span></span>  
  
    ```  
    USE AdventureWorks2012;  
    GO  
    IF OBJECT_ID ( 'Sales.GetRecentSales', 'P') IS NOT NULL  
        DROP PROCEDURE Sales.GetRecentSales;  
    GO  
    CREATE PROCEDURE Sales.GetRecentSales (@date datetime)  
    AS BEGIN  
        IF @date is NULL  
            SET @date = DATEADD(MONTH, -3, (SELECT MAX(ORDERDATE) FROM Sales.SalesOrderHeader))  
        SELECT * FROM Sales.SalesOrderHeader h, Sales.SalesOrderDetail d  
        WHERE h.SalesOrderID = d.SalesOrderID  
        AND h.OrderDate > @date  
    END  
    GO  
    ```  
  
     <span data-ttu-id="a54ec-313">Se a primeira chamada do procedimento armazenado `Sales.GetRecentSales` transmitir NULL para o parâmetro `@date` , o otimizador de consulta compilará o procedimento armazenado com a estimativa de cardinalidade para `@date = NULL` , embora o predicado de consulta não seja chamado com `@date = NULL`.</span><span class="sxs-lookup"><span data-stu-id="a54ec-313">If the first call to the stored procedure `Sales.GetRecentSales` passes a NULL for the `@date` parameter, the query optimizer will compile the stored procedure with the cardinality estimate for `@date = NULL` even though the query predicate is not called with `@date = NULL`.</span></span> <span data-ttu-id="a54ec-314">Essa estimativa de cardinalidade pode ser significativamente diferente do número de linhas no resultado de consulta real.</span><span class="sxs-lookup"><span data-stu-id="a54ec-314">This cardinality estimate might be significantly different than the number of rows in the actual query result.</span></span> <span data-ttu-id="a54ec-315">Como resultado, o otimizador de consulta pode escolher um plano de consulta de qualidade inferior.</span><span class="sxs-lookup"><span data-stu-id="a54ec-315">As a result, the query optimizer might choose a suboptimal query plan.</span></span> <span data-ttu-id="a54ec-316">Para evitar isso, você pode reescrever o procedimento armazenado em dois procedimentos da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="a54ec-316">To help avoid this, you can rewrite the stored procedure into two procedures as follows:</span></span>  
  
    ```  
    USE AdventureWorks2012;  
    GO  
    IF OBJECT_ID ( 'Sales.GetNullRecentSales', 'P') IS NOT NULL  
        DROP PROCEDURE Sales.GetNullRecentSales;  
    GO  
    CREATE PROCEDURE Sales.GetNullRecentSales (@date datetime)  
    AS BEGIN  
        IF @date is NULL  
            SET @date = DATEADD(MONTH, -3, (SELECT MAX(ORDERDATE) FROM Sales.SalesOrderHeader))  
        EXEC Sales.GetNonNullRecentSales @date;  
    END  
    GO  
    IF OBJECT_ID ( 'Sales.GetNonNullRecentSales', 'P') IS NOT NULL  
        DROP PROCEDURE Sales.GetNonNullRecentSales;  
    GO  
    CREATE PROCEDURE Sales.GetNonNullRecentSales (@date datetime)  
    AS BEGIN  
        SELECT * FROM Sales.SalesOrderHeader h, Sales.SalesOrderDetail d  
        WHERE h.SalesOrderID = d.SalesOrderID  
        AND h.OrderDate > @date  
    END  
    GO  
    ```  
  
### <a name="improving-cardinality-estimates-with-query-hints"></a><span data-ttu-id="a54ec-317">Melhorando estimativas de cardinalidade com dicas de consulta</span><span class="sxs-lookup"><span data-stu-id="a54ec-317">Improving Cardinality Estimates with Query Hints</span></span>  
 <span data-ttu-id="a54ec-318">Para melhorar estimativas de cardinalidade para variáveis locais, você pode usar as dicas de consulta OPTIMIZE FOR ou OPTIMIZE FOR UNKNOWN com RECOMPILE.</span><span class="sxs-lookup"><span data-stu-id="a54ec-318">To improve cardinality estimates for local variables, you can use the OPTIMIZE FOR or OPTIMIZE FOR UNKNOWN query hints with RECOMPILE.</span></span> <span data-ttu-id="a54ec-319">Para obter mais informações, veja [Dicas de consulta &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-query).</span><span class="sxs-lookup"><span data-stu-id="a54ec-319">For more information, see [Query Hints &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-query).</span></span>  
  
 <span data-ttu-id="a54ec-320">Para alguns aplicativos, a recompilação da consulta toda vez que ela é executada pode levar muito tempo.</span><span class="sxs-lookup"><span data-stu-id="a54ec-320">For some applications, recompiling the query each time it executes might take too much time.</span></span> <span data-ttu-id="a54ec-321">A dica de consulta OPTIMIZER FOR poderá ajudar, mesmo que você não use a opção RECOMPILE.</span><span class="sxs-lookup"><span data-stu-id="a54ec-321">The OPTIMIZER FOR query hint can help even if you don't use the RECOMPILE option.</span></span> <span data-ttu-id="a54ec-322">Por exemplo, você poderia acrescentar uma opção OPTIMIZER FOR ao procedimento armazenado Sales.GetRecentSales para especificar uma data específica.</span><span class="sxs-lookup"><span data-stu-id="a54ec-322">For example, you could add an OPTIMIZER FOR option to the stored procedure Sales.GetRecentSales to specify a specific date.</span></span> <span data-ttu-id="a54ec-323">O exemplo a seguir acrescenta a opção OPTIMIZE FOR ao procedimento Sales.GetRecentSales.</span><span class="sxs-lookup"><span data-stu-id="a54ec-323">The following example adds the OPTIMIZE FOR option to the Sales.GetRecentSales procedure.</span></span>  
  
```sql
USE AdventureWorks2012;  
GO  
IF OBJECT_ID ( 'Sales.GetRecentSales', 'P') IS NOT NULL  
    DROP PROCEDURE Sales.GetRecentSales;  
GO  
CREATE PROCEDURE Sales.GetRecentSales (@date datetime)  
AS BEGIN  
    IF @date is NULL  
        SET @date = DATEADD(MONTH, -3, (SELECT MAX(ORDERDATE) FROM Sales.SalesOrderHeader))  
    SELECT * FROM Sales.SalesOrderHeader h, Sales.SalesOrderDetail d  
    WHERE h.SalesOrderID = d.SalesOrderID  
    AND h.OrderDate > @date  
    OPTION ( OPTIMIZE FOR ( @date = '2004-05-01 00:00:00.000'))  
END;  
GO  
```  
  
### <a name="improving-cardinality-estimates-with-plan-guides"></a><span data-ttu-id="a54ec-324">Melhorando estimativas de cardinalidade com guias de plano</span><span class="sxs-lookup"><span data-stu-id="a54ec-324">Improving Cardinality Estimates with Plan Guides</span></span>  
 <span data-ttu-id="a54ec-325">Para alguns aplicativos, é possível que as diretrizes de design de consulta não se apliquem porque você não pode alterar a consulta ou porque o uso da dica de consulta RECOMPILE pode causar muitas recompilações.</span><span class="sxs-lookup"><span data-stu-id="a54ec-325">For some applications, query design guidelines might not apply because you cannot change the query or using the RECOMPILE query hint might be cause too many recompiles.</span></span> <span data-ttu-id="a54ec-326">Você pode usar guias de plano para especificar outras dicas, como USE PLAN, a fim de controlar o comportamento da consulta ao investigar alterações do aplicativo com o fornecedor do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a54ec-326">You can use plan guides to specify other hints, such as USE PLAN, to control the behavior of the query while investigating application changes with the application vendor.</span></span> <span data-ttu-id="a54ec-327">Para obter mais informações sobre guias de plano, consulte [Plan Guides](../performance/plan-guides.md).</span><span class="sxs-lookup"><span data-stu-id="a54ec-327">For more information about plan guides, see [Plan Guides](../performance/plan-guides.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="a54ec-328">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="a54ec-328">See Also</span></span>  
 <span data-ttu-id="a54ec-329">[CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="a54ec-329">[CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql) </span></span>  
 <span data-ttu-id="a54ec-330">[UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="a54ec-330">[UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql) </span></span>  
 <span data-ttu-id="a54ec-331">[sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="a54ec-331">[sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) </span></span>  
 <span data-ttu-id="a54ec-332">[DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="a54ec-332">[DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql) </span></span>  
 <span data-ttu-id="a54ec-333">[Opções ALTER DATABASE SET &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-set-options) </span><span class="sxs-lookup"><span data-stu-id="a54ec-333">[ALTER DATABASE SET Options &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-set-options) </span></span>  
 <span data-ttu-id="a54ec-334">[DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="a54ec-334">[DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) </span></span>  
 <span data-ttu-id="a54ec-335">[CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="a54ec-335">[CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql) </span></span>  
 <span data-ttu-id="a54ec-336">[ALTER INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-index-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="a54ec-336">[ALTER INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-index-transact-sql) </span></span>  
 [<span data-ttu-id="a54ec-337">Criar índices filtrados</span><span class="sxs-lookup"><span data-stu-id="a54ec-337">Create Filtered Indexes</span></span>](../indexes/create-filtered-indexes.md)  
