---
title: Guia de controle de versão de linha e bloqueio de transações do SQL Server | Microsoft Docs
ms.custom: ''
ms.date: 01/24/2019
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
ms.assetid: c7757153-9697-4f01-881c-800e254918c9
author: rothja
ms.author: jroth
ms.openlocfilehash: c79f9997249568c88409394441d28c71da453d63
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87570406"
---
# <a name="sql-server-transaction-locking-and-row-versioning-guide"></a><span data-ttu-id="12fe9-102">Guia de Controle de Versão de Linha e Bloqueio de Transações do SQL Server</span><span class="sxs-lookup"><span data-stu-id="12fe9-102">SQL Server Transaction Locking and Row Versioning Guide</span></span>

  <span data-ttu-id="12fe9-103">Em um banco de dados, o gerenciamento incorreto de transações normalmente leva a problemas de contenção e de desempenho em sistemas com muitos usuários.</span><span class="sxs-lookup"><span data-stu-id="12fe9-103">In any database, mismanagement of transactions often leads to contention and performance problems in systems that have many users.</span></span> <span data-ttu-id="12fe9-104">À medida que o número de usuários que acessam os dados aumenta, torna-se importante ter aplicativos que utilizem as transações de maneira eficaz.</span><span class="sxs-lookup"><span data-stu-id="12fe9-104">As the number of users that access the data increases, it becomes important to have applications that use transactions efficiently.</span></span> <span data-ttu-id="12fe9-105">Este guia descreve os mecanismos de bloqueio e de controle de versão de linha que o [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] usa para assegurar a integridade física de cada transação, além de fornecer informações sobre como os aplicativos podem controlar as transações de maneira eficiente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-105">This guide describes the locking and row versioning mechanisms the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses to ensure the physical integrity of each transaction and provides information on how applications can control transactions efficiently.</span></span>  
  
<span data-ttu-id="12fe9-106">**Aplica-se a**: a [!INCLUDE[ssVersion2005](../includes/ssversion2005-md.md)] [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)] menos que indicado o contrário.</span><span class="sxs-lookup"><span data-stu-id="12fe9-106">**Applies to**: [!INCLUDE[ssVersion2005](../includes/ssversion2005-md.md)] through [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)] unless noted otherwise.</span></span>  
  
##  <a name="in-this-guide"></a><a name="Top"></a><span data-ttu-id="12fe9-107">Neste guia</span><span class="sxs-lookup"><span data-stu-id="12fe9-107">In This Guide</span></span>  

 [<span data-ttu-id="12fe9-108">Noções básicas da transação</span><span class="sxs-lookup"><span data-stu-id="12fe9-108">Transaction Basics</span></span>](#Basics)  
  
 [<span data-ttu-id="12fe9-109">Noções básicas de controle de versão de bloqueio e linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-109">Locking and Row Versioning Basics</span></span>](#Lock_Basics)  
  
 [<span data-ttu-id="12fe9-110">Bloqueio no Mecanismo de Banco de Dados</span><span class="sxs-lookup"><span data-stu-id="12fe9-110">Locking in the Database Engine</span></span>](#Lock_Engine)  
  
 [<span data-ttu-id="12fe9-111">Níveis de isolamento com base no controle de versão de linha no Mecanismo de Banco de Dados</span><span class="sxs-lookup"><span data-stu-id="12fe9-111">Row Versioning-based Isolation Levels in the Database Engine</span></span>](#Row_versioning)  
  
 [<span data-ttu-id="12fe9-112">Personalizando o bloqueio para um índice</span><span class="sxs-lookup"><span data-stu-id="12fe9-112">Customizing Locking for an Index</span></span>](#Customize)  
  
 [<span data-ttu-id="12fe9-113">Informações de transações avançadas</span><span class="sxs-lookup"><span data-stu-id="12fe9-113">Advanced Transaction Information</span></span>](#Advanced)  
  
##  <a name="transaction-basics"></a><a name="Basics"></a> <span data-ttu-id="12fe9-114">Noções básicas sobre transações</span><span class="sxs-lookup"><span data-stu-id="12fe9-114">Transaction Basics</span></span>  

 <span data-ttu-id="12fe9-115">Uma transação é uma sequência de operações executadas como uma única unidade lógica de trabalho.</span><span class="sxs-lookup"><span data-stu-id="12fe9-115">A transaction is a sequence of operations performed as a single logical unit of work.</span></span> <span data-ttu-id="12fe9-116">Uma unidade lógica de trabalho deve mostrar quatro propriedades, designadas pelas iniciais ACID (atomicidade, consistência, isolamento e durabilidade), para que seja qualificada como uma transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-116">A logical unit of work must exhibit four properties, called the atomicity, consistency, isolation, and durability (ACID) properties, to qualify as a transaction.</span></span>  
  
 <span data-ttu-id="12fe9-117">Atomicidade</span><span class="sxs-lookup"><span data-stu-id="12fe9-117">Atomicity</span></span>  
 <span data-ttu-id="12fe9-118">Uma transação deve ser uma unidade atômica de trabalho; ou todas as suas modificações de dados são executadas ou nenhuma delas é executada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-118">A transaction must be an atomic unit of work; either all of its data modifications are performed, or none of them are performed.</span></span>  
  
 <span data-ttu-id="12fe9-119">Consistência</span><span class="sxs-lookup"><span data-stu-id="12fe9-119">Consistency</span></span>  
 <span data-ttu-id="12fe9-120">Quando concluída, uma transação deve deixar todos os dados em um estado consistente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-120">When completed, a transaction must leave all data in a consistent state.</span></span> <span data-ttu-id="12fe9-121">Em um banco de dados relacional, todas as regras devem ser aplicadas às modificações da transação para manter toda a integridade dos dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-121">In a relational database, all rules must be applied to the transaction's modifications to maintain all data integrity.</span></span> <span data-ttu-id="12fe9-122">Todas as estruturas de dados internas, tais como índices em árvore B ou listas duplamente vinculadas, devem estar corretas ao término da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-122">All internal data structures, such as B-tree indexes or doubly-linked lists, must be correct at the end of the transaction.</span></span>  
  
 <span data-ttu-id="12fe9-123">Isolamento</span><span class="sxs-lookup"><span data-stu-id="12fe9-123">Isolation</span></span>  
 <span data-ttu-id="12fe9-124">Modificações feitas por transações simultâneas devem ser isoladas das modificações feitas por qualquer outra transação simultânea.</span><span class="sxs-lookup"><span data-stu-id="12fe9-124">Modifications made by concurrent transactions must be isolated from the modifications made by any other concurrent transactions.</span></span> <span data-ttu-id="12fe9-125">Uma transação reconhece os dados no estado em que estavam antes de outra transação simultânea tê-los modificado ou reconhece os dados depois que a segunda transação tiver sido concluída, mas não reconhece um estado intermediário.</span><span class="sxs-lookup"><span data-stu-id="12fe9-125">A transaction either recognizes data in the state it was in before another concurrent transaction modified it, or it recognizes the data after the second transaction has completed, but it does not recognize an intermediate state.</span></span> <span data-ttu-id="12fe9-126">Isso é chamado serializabilidade porque resulta na capacidade de recarregar os dados iniciais e reexecutar uma série de transações de modo que os dados obtidos estejam no mesmo estado em que estavam depois que as transações originais foram executadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-126">This is referred to as serializability because it results in the ability to reload the starting data and replay a series of transactions to end up with the data in the same state it was in after the original transactions were performed.</span></span>  
  
 <span data-ttu-id="12fe9-127">Durabilidade</span><span class="sxs-lookup"><span data-stu-id="12fe9-127">Durability</span></span>  
 <span data-ttu-id="12fe9-128">Depois que uma transação totalmente durável tiver sido concluída, seus efeitos ficam permanentemente no sistema.</span><span class="sxs-lookup"><span data-stu-id="12fe9-128">After a fully durable transaction has completed, its effects are permanently in place in the system.</span></span> <span data-ttu-id="12fe9-129">As modificações persistem até mesmo no caso de uma queda do sistema.</span><span class="sxs-lookup"><span data-stu-id="12fe9-129">The modifications persist even in the event of a system failure.</span></span> [!INCLUDE[ssSQL14](../includes/sssql14-md.md)] <span data-ttu-id="12fe9-130">e posteriores habilitam transações duráveis atrasadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-130">and later enable delayed durable transactions.</span></span> <span data-ttu-id="12fe9-131">As transações duráveis atrasadas são confirmadas antes do registro de log de transação ser persistente no disco.</span><span class="sxs-lookup"><span data-stu-id="12fe9-131">Delayed durable transactions commit before the transaction log record is persisted to disk.</span></span> <span data-ttu-id="12fe9-132">Para obter mais informações sobre durabilidade de transações atrasadas, consulte o tópico [Durabilidade da transação](../relational-databases/logs/control-transaction-durability.md).</span><span class="sxs-lookup"><span data-stu-id="12fe9-132">For more information on delayed transaction durability see the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md).</span></span>  
  
 <span data-ttu-id="12fe9-133">Os programadores SQL são responsáveis por iniciar e terminar transações em pontos que imponham a consistência lógica dos dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-133">SQL programmers are responsible for starting and ending transactions at points that enforce the logical consistency of the data.</span></span> <span data-ttu-id="12fe9-134">O programador deve definir a sequência de modificações de dados que deixem os dados em um estado consistente em relação às regras comerciais da organização.</span><span class="sxs-lookup"><span data-stu-id="12fe9-134">The programmer must define the sequence of data modifications that leave the data in a consistent state relative to the organization's business rules.</span></span> <span data-ttu-id="12fe9-135">O programador inclui essas instruções de modificação em uma única transação de modo que o [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] possa aplicar a integridade física da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-135">The programmer includes these modification statements in a single transaction so that the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] can enforce the physical integrity of the transaction.</span></span>  
  
 <span data-ttu-id="12fe9-136">É de responsabilidade de um sistema de banco de dados empresarial, tal como uma instância do [!INCLUDE[ssDE](../includes/ssde-md.md)], oferecer mecanismos que assegurem a integridade física de cada transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-136">It is the responsibility of an enterprise database system, such as an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)], to provide mechanisms ensuring the physical integrity of each transaction.</span></span> <span data-ttu-id="12fe9-137">O [!INCLUDE[ssDE](../includes/ssde-md.md)] oferece:</span><span class="sxs-lookup"><span data-stu-id="12fe9-137">The [!INCLUDE[ssDE](../includes/ssde-md.md)] provides:</span></span>  
  
-   <span data-ttu-id="12fe9-138">Recursos de bloqueio que preservam o isolamento da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-138">Locking facilities that preserve transaction isolation.</span></span>  
  
-   <span data-ttu-id="12fe9-139">Recursos de log garantem a durabilidade da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-139">Logging facilities ensure transaction durability.</span></span> <span data-ttu-id="12fe9-140">Para transações completamente duráveis, o registro de log é protegido no disco antes da confirmação das transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-140">For fully durable transactions the log record is hardened to disk before the transactions commits.</span></span> <span data-ttu-id="12fe9-141">Assim, mesmo se o hardware do servidor, o sistema operacional ou a instância do [!INCLUDE[ssDE](../includes/ssde-md.md)] falhar, a instância usará os logs de transações ao reinicializar para reverter automaticamente qualquer transação incompleta até o ponto da falha do sistema.</span><span class="sxs-lookup"><span data-stu-id="12fe9-141">Thus, even if the server hardware, operating system, or the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] itself fails, the instance uses the transaction logs upon restart to automatically roll back any uncompleted transactions to the point of the system failure.</span></span> <span data-ttu-id="12fe9-142">As transações duráveis atrasadas confirmar antes que o registro de log de transação é protegido no disco.</span><span class="sxs-lookup"><span data-stu-id="12fe9-142">Delayed durable transactions commit before the transaction log record is hardened to disk.</span></span> <span data-ttu-id="12fe9-143">Essas transações podem ser perdidas se houver uma falha do sistema antes de o registro de log ser protegido no disco.</span><span class="sxs-lookup"><span data-stu-id="12fe9-143">Such transactions may be lost if there is a system failure before the log record is hardened to disk.</span></span> <span data-ttu-id="12fe9-144">Para obter mais informações sobre durabilidade de transações atrasadas, consulte o tópico [Durabilidade da transação](../relational-databases/logs/control-transaction-durability.md).</span><span class="sxs-lookup"><span data-stu-id="12fe9-144">For more information on delayed transaction durability see the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md).</span></span>  
  
-   <span data-ttu-id="12fe9-145">Recursos de administração de transação que impõem a atomicidade e a consistência da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-145">Transaction management features that enforce transaction atomicity and consistency.</span></span> <span data-ttu-id="12fe9-146">Depois que uma transação tiver sido iniciada, ela deve ser concluída com êxito (confirmada) ou o [!INCLUDE[ssDE](../includes/ssde-md.md)] desfará todas as modificações de dados feitas desde que a transação foi iniciada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-146">After a transaction has started, it must be successfully completed (committed), or the [!INCLUDE[ssDE](../includes/ssde-md.md)] undoes all of the data modifications made since the transaction started.</span></span> <span data-ttu-id="12fe9-147">Essa operação é denominada de reversão da transação porque retorna os dados ao estado anterior a essas alterações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-147">This operation is referred to as rolling back a transaction because it returns the data to the state it was prior to those changes.</span></span>  
  
### <a name="controlling-transactions"></a><span data-ttu-id="12fe9-148">Controle de transações</span><span class="sxs-lookup"><span data-stu-id="12fe9-148">Controlling Transactions</span></span>  

 <span data-ttu-id="12fe9-149">Os aplicativos controlam transações principalmente ao especificar quando uma transação começa e termina.</span><span class="sxs-lookup"><span data-stu-id="12fe9-149">Applications control transactions mainly by specifying when a transaction starts and ends.</span></span> <span data-ttu-id="12fe9-150">O controle pode ser especificado pelo uso de instruções [!INCLUDE[tsql](../includes/tsql-md.md)] ou funções de interface de programação de aplicativo (API) de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-150">This can be specified by using either [!INCLUDE[tsql](../includes/tsql-md.md)] statements or database application programming interface (API) functions.</span></span> <span data-ttu-id="12fe9-151">O sistema também deve ser capaz de processar corretamente os erros que encerram uma transação antes de sua conclusão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-151">The system must also be able to correctly handle errors that terminate a transaction before it completes.</span></span> <span data-ttu-id="12fe9-152">Para obter mais informações, consulte [instruções de transação &#40;&#41;Transact-SQL ](/sql/t-sql/language-elements/transactions-transact-sql), [transações em ODBC](https://technet.microsoft.com/library/ms131281.aspx) e [Transações no SQL Server Native Client (OleDb)](https://msdn.microsoft.com/library/ms130918.aspx).</span><span class="sxs-lookup"><span data-stu-id="12fe9-152">For more information, see [Transaction Statements &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/transactions-transact-sql), [Transactions in ODBC](https://technet.microsoft.com/library/ms131281.aspx) and [Transactions in SQL Server Native Client (OLEDB)](https://msdn.microsoft.com/library/ms130918.aspx).</span></span>  
  
 <span data-ttu-id="12fe9-153">Por padrão, as transações são gerenciadas no nível de conexão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-153">By default, transactions are managed at the connection level.</span></span> <span data-ttu-id="12fe9-154">Quando uma transação é iniciada em uma conexão, todas as instruções [!INCLUDE[tsql](../includes/tsql-md.md)] executadas nessa conexão fazem parte da transação até a conclusão da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-154">When a transaction is started on a connection, all [!INCLUDE[tsql](../includes/tsql-md.md)] statements executed on that connection are part of the transaction until the transaction ends.</span></span> <span data-ttu-id="12fe9-155">Porém, em uma sessão de vários conjuntos de resultados ativos (MARS), uma transação [!INCLUDE[tsql](../includes/tsql-md.md)] explícita ou implícita se torna uma transação no escopo do lote gerenciada no nível do lote.</span><span class="sxs-lookup"><span data-stu-id="12fe9-155">However, under a multiple active result set (MARS) session, a [!INCLUDE[tsql](../includes/tsql-md.md)] explicit or implicit transaction becomes a batch-scoped transaction that is managed at the batch level.</span></span> <span data-ttu-id="12fe9-156">Quando o lote for concluído, se a transação no escopo do lote não for confirmada ou revertida, ela será revertida automaticamente pelo [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-156">When the batch completes, if the batch-scoped transaction is not committed or rolled back, it is automatically rolled back by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="12fe9-157">Para obter mais informações, consulte [Mars (vários conjuntos de resultados ativos) no SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span><span class="sxs-lookup"><span data-stu-id="12fe9-157">For more information, see [Multiple Active Result Sets (MARS) in SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span></span>  
  
#### <a name="starting-transactions"></a><span data-ttu-id="12fe9-158">Iniciando transações</span><span class="sxs-lookup"><span data-stu-id="12fe9-158">Starting Transactions</span></span>  

 <span data-ttu-id="12fe9-159">Ao usar funções de API e instruções [!INCLUDE[tsql](../includes/tsql-md.md)], você pode iniciar transações em uma instância do [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] como transações explícitas, autoconfirmadas ou implícitas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-159">Using API functions and [!INCLUDE[tsql](../includes/tsql-md.md)] statements, you can start transactions in an instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] as explicit, autocommit, or implicit transactions.</span></span>  
  
 <span data-ttu-id="12fe9-160">**Transações explícitas**</span><span class="sxs-lookup"><span data-stu-id="12fe9-160">**Explicit Transactions**</span></span>  
 <span data-ttu-id="12fe9-161">Uma transação explícita é aquela na qual você pode definir explicitamente o início e o término da transação pela função de API ou pela emissão de instruções [!INCLUDE[tsql](../includes/tsql-md.md)] BEGIN TRANSACTION, COMMIT TRANSACTION, COMMIT WORK, ROLLBACK TRANSACTION ou ROLLBACK WORK [!INCLUDE[tsql](../includes/tsql-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-161">An explicit transaction is one in which you explicitly define both the start and end of the transaction through an API function or by issuing the [!INCLUDE[tsql](../includes/tsql-md.md)] BEGIN TRANSACTION, COMMIT TRANSACTION, COMMIT WORK, ROLLBACK TRANSACTION, or ROLLBACK WORK [!INCLUDE[tsql](../includes/tsql-md.md)] statements.</span></span> <span data-ttu-id="12fe9-162">Quando a transação terminar, a conexão volta ao modo de transação em que estava antes de a transação explícita ser iniciada, seja o modo implícito ou de confirmação automática.</span><span class="sxs-lookup"><span data-stu-id="12fe9-162">When the transaction ends, the connection returns to the transaction mode it was in before the explicit transaction was started, either implicit or autocommit mode.</span></span>  
  
 <span data-ttu-id="12fe9-163">Você pode usar todas as instruções [!INCLUDE[tsql](../includes/tsql-md.md)] em uma transação explícita, com exceção das seguintes instruções:</span><span class="sxs-lookup"><span data-stu-id="12fe9-163">You can use all [!INCLUDE[tsql](../includes/tsql-md.md)] statements in an explicit transaction, except for the following statements:</span></span>  
  
||||  
|-|-|-|  
|<span data-ttu-id="12fe9-164">ALTER DATABASE</span><span class="sxs-lookup"><span data-stu-id="12fe9-164">ALTER DATABASE</span></span>|<span data-ttu-id="12fe9-165">CREATE DATABASE</span><span class="sxs-lookup"><span data-stu-id="12fe9-165">CREATE DATABASE</span></span>|<span data-ttu-id="12fe9-166">DROP FULLTEXT INDEX</span><span class="sxs-lookup"><span data-stu-id="12fe9-166">DROP FULLTEXT INDEX</span></span>|  
|<span data-ttu-id="12fe9-167">ALTER FULLTEXT CATALOG</span><span class="sxs-lookup"><span data-stu-id="12fe9-167">ALTER FULLTEXT CATALOG</span></span>|<span data-ttu-id="12fe9-168">CREATE FULLTEXT CATALOG</span><span class="sxs-lookup"><span data-stu-id="12fe9-168">CREATE FULLTEXT CATALOG</span></span>|<span data-ttu-id="12fe9-169">RECONFIGURE</span><span class="sxs-lookup"><span data-stu-id="12fe9-169">RECONFIGURE</span></span>|  
|<span data-ttu-id="12fe9-170">ALTER FULLTEXT INDEX</span><span class="sxs-lookup"><span data-stu-id="12fe9-170">ALTER FULLTEXT INDEX</span></span>|<span data-ttu-id="12fe9-171">CREATE FULLTEXT INDEX</span><span class="sxs-lookup"><span data-stu-id="12fe9-171">CREATE FULLTEXT INDEX</span></span>|<span data-ttu-id="12fe9-172">RESTORE</span><span class="sxs-lookup"><span data-stu-id="12fe9-172">RESTORE</span></span>|  
|<span data-ttu-id="12fe9-173">BACKUP</span><span class="sxs-lookup"><span data-stu-id="12fe9-173">BACKUP</span></span>|<span data-ttu-id="12fe9-174">DROP DATABASE</span><span class="sxs-lookup"><span data-stu-id="12fe9-174">DROP DATABASE</span></span>|<span data-ttu-id="12fe9-175">Procedimentos armazenados do sistema de texto completo</span><span class="sxs-lookup"><span data-stu-id="12fe9-175">Full-text system stored procedures</span></span>|  
|<span data-ttu-id="12fe9-176">CREATE DATABASE</span><span class="sxs-lookup"><span data-stu-id="12fe9-176">CREATE DATABASE</span></span>|<span data-ttu-id="12fe9-177">DROP FULLTEXT CATALOG</span><span class="sxs-lookup"><span data-stu-id="12fe9-177">DROP FULLTEXT CATALOG</span></span>|<span data-ttu-id="12fe9-178">sp_dboption para definir opções de banco de dados ou usar um procedimento do sistema que modifique o banco de dados mestre dentro de transações explícitas ou implícitas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-178">sp_dboption to set database options or any system procedure that modifies the master database inside explicit or implicit transactions.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-179">UPDATE STATISTICS pode ser usada dentro de uma transação explícita.</span><span class="sxs-lookup"><span data-stu-id="12fe9-179">UPDATE STATISTICS can be used inside an explicit transaction.</span></span> <span data-ttu-id="12fe9-180">Mas, ela será confirmada independentemente da transação envolvida e não poderá ser revertida.</span><span class="sxs-lookup"><span data-stu-id="12fe9-180">However, UPDATE STATISTICS commits independently of the enclosing transaction and cannot be rolled back.</span></span>  
  
 <span data-ttu-id="12fe9-181">**Transações de Confirmação Automática**</span><span class="sxs-lookup"><span data-stu-id="12fe9-181">**Autocommit Transactions**</span></span>  
 <span data-ttu-id="12fe9-182">O modo de confirmação automática é o modo padrão de gerenciamento de transações do mecanismo de banco de dados do SQL Server.</span><span class="sxs-lookup"><span data-stu-id="12fe9-182">Autocommit mode is the default transaction management mode of the SQL Server Database Engine.</span></span> <span data-ttu-id="12fe9-183">Toda instrução Transact-SQL é confirmada ou revertida quando concluída.</span><span class="sxs-lookup"><span data-stu-id="12fe9-183">Every Transact-SQL statement is committed or rolled back when it completes.</span></span> <span data-ttu-id="12fe9-184">Se uma instrução for concluída com sucesso, será confirmada; se encontrar qualquer erro, será revertida.</span><span class="sxs-lookup"><span data-stu-id="12fe9-184">If a statement completes successfully, it is committed; if it encounters any error, it is rolled back.</span></span> <span data-ttu-id="12fe9-185">A conexão a uma instância do mecanismo de banco de dados opera em modo de confirmação automática sempre que esse modo padrão não for substituído por transações explícitas ou implícitas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-185">A connection to an instance of the Database Engine operates in autocommit mode whenever this default mode has not been overridden by either explicit or implicit transactions.</span></span> <span data-ttu-id="12fe9-186">O modo de confirmação automática também é o modo padrão para ADO, OLE DB, ODBC e DB-Library.</span><span class="sxs-lookup"><span data-stu-id="12fe9-186">Autocommit mode is also the default mode for ADO, OLE DB, ODBC, and DB-Library.</span></span>  
  
 <span data-ttu-id="12fe9-187">**Transações Implícitas**</span><span class="sxs-lookup"><span data-stu-id="12fe9-187">**Implicit Transactions**</span></span>  
 <span data-ttu-id="12fe9-188">Quando uma conexão operar em modo de transação implícita, a instância do mecanismo de banco de dados iniciará automaticamente uma nova transação depois que a transação atual for confirmada ou revertida.</span><span class="sxs-lookup"><span data-stu-id="12fe9-188">When a connection is operating in implicit transaction mode, the instance of the Database Engine automatically starts a new transaction after the current transaction is committed or rolled back.</span></span> <span data-ttu-id="12fe9-189">Você não faz nada para determinar o início de uma transação; apenas confirma ou reverte cada uma das transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-189">You do nothing to delineate the start of a transaction; you only commit or roll back each transaction.</span></span> <span data-ttu-id="12fe9-190">O modo de transação implícita gera uma cadeia contínua de transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-190">Implicit transaction mode generates a continuous chain of transactions.</span></span> <span data-ttu-id="12fe9-191">Defina o modo de transação implícito como ativado por uma função de API ou pela instrução [!INCLUDE[tsql](../includes/tsql-md.md)] SET IMPLICIT_TRANSACTIONS ON.</span><span class="sxs-lookup"><span data-stu-id="12fe9-191">Set implicit transaction mode on through either an API function or the [!INCLUDE[tsql](../includes/tsql-md.md)] SET IMPLICIT_TRANSACTIONS ON statement.</span></span>  
  
 <span data-ttu-id="12fe9-192">Após a configuração do modo de transação implícita em uma conexão, a instância do [!INCLUDE[ssDE](../includes/ssde-md.md)] iniciará automaticamente a transação ao executar pela primeira vez cada uma destas instruções:</span><span class="sxs-lookup"><span data-stu-id="12fe9-192">After implicit transaction mode has been set on for a connection, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] automatically starts a transaction when it first executes any of these statements:</span></span>  
  
||||  
|-|-|-|  
|<span data-ttu-id="12fe9-193">ALTER TABLE</span><span class="sxs-lookup"><span data-stu-id="12fe9-193">ALTER TABLE</span></span>|<span data-ttu-id="12fe9-194">FETCH</span><span class="sxs-lookup"><span data-stu-id="12fe9-194">FETCH</span></span>|<span data-ttu-id="12fe9-195">REVOKE</span><span class="sxs-lookup"><span data-stu-id="12fe9-195">REVOKE</span></span>|  
|<span data-ttu-id="12fe9-196">CREATE</span><span class="sxs-lookup"><span data-stu-id="12fe9-196">CREATE</span></span>|<span data-ttu-id="12fe9-197">GRANT</span><span class="sxs-lookup"><span data-stu-id="12fe9-197">GRANT</span></span>|<span data-ttu-id="12fe9-198">SELECT</span><span class="sxs-lookup"><span data-stu-id="12fe9-198">SELECT</span></span>|  
|<span data-ttu-id="12fe9-199">Delete (excluir)</span><span class="sxs-lookup"><span data-stu-id="12fe9-199">DELETE</span></span>|<span data-ttu-id="12fe9-200">INSERT</span><span class="sxs-lookup"><span data-stu-id="12fe9-200">INSERT</span></span>|<span data-ttu-id="12fe9-201">TRUNCATE TABLE</span><span class="sxs-lookup"><span data-stu-id="12fe9-201">TRUNCATE TABLE</span></span>|  
|<span data-ttu-id="12fe9-202">DROP</span><span class="sxs-lookup"><span data-stu-id="12fe9-202">DROP</span></span>|<span data-ttu-id="12fe9-203">OPEN</span><span class="sxs-lookup"><span data-stu-id="12fe9-203">OPEN</span></span>|<span data-ttu-id="12fe9-204">UPDATE</span><span class="sxs-lookup"><span data-stu-id="12fe9-204">UPDATE</span></span>|  
  
 <span data-ttu-id="12fe9-205">**Transações no escopo do Lote**</span><span class="sxs-lookup"><span data-stu-id="12fe9-205">**Batch-scoped Transactions**</span></span>  
 <span data-ttu-id="12fe9-206">Aplicável apenas a MARS (Conjuntos de Resultados Ativos Múltiplos), a transação [!INCLUDE[tsql](../includes/tsql-md.md)] explícita ou implícita iniciada em uma sessão MARS se torna uma transação de escopo de lote.</span><span class="sxs-lookup"><span data-stu-id="12fe9-206">Applicable only to multiple active result sets (MARS), a [!INCLUDE[tsql](../includes/tsql-md.md)] explicit or implicit transaction that starts under a MARS session becomes a batch-scoped transaction.</span></span> <span data-ttu-id="12fe9-207">A transação de escopo de lote que não é confirmada ou revertida quando um lote é concluído, será revertida automaticamente pelo [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-207">A batch-scoped transaction that is not committed or rolled back when a batch completes is automatically rolled back by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span>  
  
 <span data-ttu-id="12fe9-208">**Transações distribuídas**</span><span class="sxs-lookup"><span data-stu-id="12fe9-208">**Distributed Transactions**</span></span>  
 <span data-ttu-id="12fe9-209">Transações distribuídas abrangem dois ou mais servidores conhecidos como gerenciadores de recursos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-209">Distributed transactions span two or more servers known as resource managers.</span></span> <span data-ttu-id="12fe9-210">O gerenciamento da transação deve ser coordenado entre os gerenciadores de recursos por um componente de servidor chamado de gerenciador de transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-210">The management of the transaction must be coordinated between the resource managers by a server component called a transaction manager.</span></span> <span data-ttu-id="12fe9-211">Cada instância do [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] pode operar como um gerenciador de recursos em transações distribuídas coordenadas por gerenciadores de transações, como o MS DTC (Coordenador de Transações Distribuídas da [!INCLUDE[msCoName](../includes/msconame-md.md)]), ou outros gerenciadores de transações que dão suporte à especificação XA do Open Group para processamento de transações distribuídas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-211">Each instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] can operate as a resource manager in distributed transactions coordinated by transaction managers, such as [!INCLUDE[msCoName](../includes/msconame-md.md)] Distributed Transaction Coordinator (MS DTC), or other transaction managers that support the Open Group XA specification for distributed transaction processing.</span></span> <span data-ttu-id="12fe9-212">Para obter mais informações, consulte a documentação do MS DTC.</span><span class="sxs-lookup"><span data-stu-id="12fe9-212">For more information, see the MS DTC documentation.</span></span>  
  
 <span data-ttu-id="12fe9-213">Uma transação em uma instância única do [!INCLUDE[ssDE](../includes/ssde-md.md)] que abrange dois ou mais bancos de dados é, de fato, uma transação distribuída.</span><span class="sxs-lookup"><span data-stu-id="12fe9-213">A transaction within a single instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] that spans two or more databases is actually a distributed transaction.</span></span> <span data-ttu-id="12fe9-214">A instância gerencia a transação distribuída internamente. Para o usuário, ela opera como uma transação local.</span><span class="sxs-lookup"><span data-stu-id="12fe9-214">The instance manages the distributed transaction internally; to the user, it operates as a local transaction.</span></span>  
  
 <span data-ttu-id="12fe9-215">No aplicativo, uma transação distribuída é gerenciada da mesma forma como uma transação local.</span><span class="sxs-lookup"><span data-stu-id="12fe9-215">At the application, a distributed transaction is managed much the same as a local transaction.</span></span> <span data-ttu-id="12fe9-216">No final da transação, o aplicativo solicita que a transação seja confirmada ou revertida.</span><span class="sxs-lookup"><span data-stu-id="12fe9-216">At the end of the transaction, the application requests the transaction to be either committed or rolled back.</span></span> <span data-ttu-id="12fe9-217">Uma confirmação distribuída deve ser gerenciada de forma diferenciada pelo gerenciador de transações para minimizar o risco de que uma falha de rede possa resultar em alguns gerenciadores de recurso que confirmam com êxito enquanto outros revertem a transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-217">A distributed commit must be managed differently by the transaction manager to minimize the risk that a network failure may result in some resource managers successfully committing while others roll back the transaction.</span></span> <span data-ttu-id="12fe9-218">Isso é obtido pelo gerenciamento do processo de confirmação em duas fases (a fase de preparação e a fase de confirmação), o que é conhecido como um protocolo 2PC.</span><span class="sxs-lookup"><span data-stu-id="12fe9-218">This is achieved by managing the commit process in two phases (the prepare phase and the commit phase), which is known as a two-phase commit (2PC).</span></span>  
  
 <span data-ttu-id="12fe9-219">Fase de preparo</span><span class="sxs-lookup"><span data-stu-id="12fe9-219">Prepare phase</span></span>  
 <span data-ttu-id="12fe9-220">Quando o gerenciador de transações recebe uma solicitação de confirmação, ele envia um comando de preparação a todos os gerenciadores de recursos envolvidos na transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-220">When the transaction manager receives a commit request, it sends a prepare command to all of the resource managers involved in the transaction.</span></span> <span data-ttu-id="12fe9-221">Cada gerenciador executa todas as ações necessárias para tornar a transação durável, e todos os buffers que mantêm imagens de log da transação são liberados no disco.</span><span class="sxs-lookup"><span data-stu-id="12fe9-221">Each resource manager then does everything required to make the transaction durable, and all buffers holding log images for the transaction are flushed to disk.</span></span> <span data-ttu-id="12fe9-222">À medida que cada gerenciador de recursos conclui a fase de preparação, ele retorna informações de êxito ou de falha ao gerenciador de transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-222">As each resource manager completes the prepare phase, it returns success or failure of the prepare to the transaction manager.</span></span> [!INCLUDE[ssSQL14](../includes/sssql14-md.md)] <span data-ttu-id="12fe9-223">introduziu a durabilidade da transação atrasada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-223">introduced delayed transaction durability.</span></span> <span data-ttu-id="12fe9-224">As transações duráveis atrasadas são confirmadas antes de imagens de log da transação serem liberadas para o disco.</span><span class="sxs-lookup"><span data-stu-id="12fe9-224">Delayed durable transactions commit before log images for the transaction are flushed to disk.</span></span> <span data-ttu-id="12fe9-225">Para obter mais informações sobre durabilidade de transações atrasadas, consulte o tópico [Durabilidade da transação](../relational-databases/logs/control-transaction-durability.md).</span><span class="sxs-lookup"><span data-stu-id="12fe9-225">For more information on delayed transaction durability see the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md).</span></span>  
  
 <span data-ttu-id="12fe9-226">Fase de confirmação</span><span class="sxs-lookup"><span data-stu-id="12fe9-226">Commit phase</span></span>  
 <span data-ttu-id="12fe9-227">Se o gerenciador de transações receber preparos bem-sucedidos de todos os gerenciadores de recursos, ele enviará comandos de confirmação a cada gerenciador de recursos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-227">If the transaction manager receives successful prepares from all of the resource managers, it sends commit commands to each resource manager.</span></span> <span data-ttu-id="12fe9-228">Em seguida, os gerenciadores de recursos podem concluir a confirmação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-228">The resource managers can then complete the commit.</span></span> <span data-ttu-id="12fe9-229">Se todos os gerenciadores de recursos relatarem uma confirmação bem-sucedida, o gerenciador de transações enviará uma notificação de êxito ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-229">If all of the resource managers report a successful commit, the transaction manager then sends a success notification to the application.</span></span> <span data-ttu-id="12fe9-230">Se um gerenciador de recursos informar uma falha na preparação, o gerenciador de transações enviará um comando de reversão a cada gerenciador de recursos e indicará a falha da confirmação ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-230">If any resource manager reported a failure to prepare, the transaction manager sends a rollback command to each resource manager and indicates the failure of the commit to the application.</span></span>  
  
 <span data-ttu-id="12fe9-231">Os aplicativos [!INCLUDE[ssDE](../includes/ssde-md.md)] podem gerenciar transações distribuídas por meio de [!INCLUDE[tsql](../includes/tsql-md.md)] ou da API do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-231">[!INCLUDE[ssDE](../includes/ssde-md.md)] applications can manage distributed transactions either through [!INCLUDE[tsql](../includes/tsql-md.md)] or the database API.</span></span> <span data-ttu-id="12fe9-232">Para obter mais informações, veja [BEGIN DISTRIBUTED TRANSACTION &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/begin-distributed-transaction-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-232">For more information, see [BEGIN DISTRIBUTED TRANSACTION &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/begin-distributed-transaction-transact-sql).</span></span>  
  
#### <a name="ending-transactions"></a><span data-ttu-id="12fe9-233">Finalizando transações</span><span class="sxs-lookup"><span data-stu-id="12fe9-233">Ending Transactions</span></span>  

 <span data-ttu-id="12fe9-234">Você pode finalizar transações com uma instrução COMMIT ou ROLLBACK ou com uma função de API correspondente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-234">You can end transactions with either a COMMIT or ROLLBACK statement, or through a corresponding API function.</span></span>  
  
 <span data-ttu-id="12fe9-235">COMMIT</span><span class="sxs-lookup"><span data-stu-id="12fe9-235">COMMIT</span></span>  
 <span data-ttu-id="12fe9-236">Se uma transação for concluída com êxito, confirme-a.</span><span class="sxs-lookup"><span data-stu-id="12fe9-236">If a transaction is successful, commit it.</span></span> <span data-ttu-id="12fe9-237">Uma instrução COMMIT garante que todas as modificações na transação fazem parte permanente do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-237">A COMMIT statement guarantees all of the transaction's modifications are made a permanent part of the database.</span></span> <span data-ttu-id="12fe9-238">Um COMMIT também libera recursos, como bloqueios, usados pela transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-238">A COMMIT also frees resources, such as locks, used by the transaction.</span></span>  
  
 <span data-ttu-id="12fe9-239">ROLLBACK</span><span class="sxs-lookup"><span data-stu-id="12fe9-239">ROLLBACK</span></span>  
 <span data-ttu-id="12fe9-240">Se ocorrer um erro em uma transação ou se o usuário decidir cancelá-la, reverta a transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-240">If an error occurs in a transaction, or if the user decides to cancel the transaction, then roll the transaction back.</span></span> <span data-ttu-id="12fe9-241">Uma instrução ROLLBACK desfaz todas as modificações feitas na transação retornando os dados ao estado anterior ao início da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-241">A ROLLBACK statement backs out all modifications made in the transaction by returning the data to the state it was in at the start of the transaction.</span></span> <span data-ttu-id="12fe9-242">Um ROLLBACK também libera recursos usados pela transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-242">A ROLLBACK also frees resources held by the transaction.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-243">Em conexões habilitadas para oferecer suporte a vários conjuntos de resultados ativos (MARS), uma transação explícita iniciada por uma função de API não pode ser confirmada enquanto houver solicitações pendentes para execução.</span><span class="sxs-lookup"><span data-stu-id="12fe9-243">Under connections enabled to support multiple active result sets (MARS), an explicit transaction started through an API function cannot be committed while there are pending requests for execution.</span></span> <span data-ttu-id="12fe9-244">Qualquer tentativa de confirmação desse tipo de transação enquanto houver operações pendentes sendo executadas resultará em um erro.</span><span class="sxs-lookup"><span data-stu-id="12fe9-244">Any attempt to commit this type of  transaction while there are outstanding operations running will result in an error.</span></span>  
  
#### <a name="errors-during-transaction-processing"></a><span data-ttu-id="12fe9-245">Erros durante o processamento de transações</span><span class="sxs-lookup"><span data-stu-id="12fe9-245">Errors During Transaction Processing</span></span>  

 <span data-ttu-id="12fe9-246">Se um erro impedir a conclusão bem-sucedida de uma transação, o [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] reverterá automaticamente a transação e liberará todos os recursos usados por ela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-246">If an error prevents the successful completion of a transaction, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] automatically rolls back the transaction and frees all resources held by the transaction.</span></span> <span data-ttu-id="12fe9-247">Se a conexão de rede do cliente com uma instância do [!INCLUDE[ssDE](../includes/ssde-md.md)] for interrompida, quaisquer transações pendentes para a conexão serão revertidas quando a rede notificar a instância sobre a interrupção.</span><span class="sxs-lookup"><span data-stu-id="12fe9-247">If the client's network connection to an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] is broken, any outstanding transactions for the connection are rolled back when the network notifies the instance of the break.</span></span> <span data-ttu-id="12fe9-248">Se o aplicativo cliente falhar ou se o computador cliente for desligado ou reiniciado, isso também interromperá a conexão e a instância do [!INCLUDE[ssDE](../includes/ssde-md.md)] reverterá quaisquer conexões pendentes quando a rede notificar a interrupção.</span><span class="sxs-lookup"><span data-stu-id="12fe9-248">If the client application fails or if the client computer goes down or is restarted, this also breaks the connection, and the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] rolls back any outstanding connections when the network notifies it of the break.</span></span> <span data-ttu-id="12fe9-249">Se o cliente fizer logoff do aplicativo, quaisquer transações pendentes serão revertidas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-249">If the client logs off the application, any outstanding transactions are rolled back.</span></span>  
  
 <span data-ttu-id="12fe9-250">Se ocorrer um erro de instrução de tempo de execução (como uma violação de restrição) em um lote, o comportamento padrão no [!INCLUDE[ssDE](../includes/ssde-md.md)] será reverter somente a instrução que gerou o erro.</span><span class="sxs-lookup"><span data-stu-id="12fe9-250">If a run-time statement error (such as a constraint violation) occurs in a batch, the default behavior in the [!INCLUDE[ssDE](../includes/ssde-md.md)] is to roll back only the statement that generated the error.</span></span> <span data-ttu-id="12fe9-251">Você pode alterar esse comportamento usando a instrução SET XACT_ABORT.</span><span class="sxs-lookup"><span data-stu-id="12fe9-251">You can change this behavior using the SET XACT_ABORT statement.</span></span> <span data-ttu-id="12fe9-252">Depois que SET XACT_ABORT ON for executada, qualquer erro de instrução em tempo de execução fará com que a transação atual seja revertida.</span><span class="sxs-lookup"><span data-stu-id="12fe9-252">After SET XACT_ABORT ON is executed, any run-time statement error causes an automatic rollback of the current transaction.</span></span> <span data-ttu-id="12fe9-253">Os erros de compilação, como erros de sintaxe, não são afetados por SET XACT_ABORT.</span><span class="sxs-lookup"><span data-stu-id="12fe9-253">Compile errors, such as syntax errors, are not affected by SET XACT_ABORT.</span></span> <span data-ttu-id="12fe9-254">Para obter mais informações, veja [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-254">For more information, see [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span></span>  
  
 <span data-ttu-id="12fe9-255">Quando ocorrerem erros, a ação corretiva (COMMIT ou ROLLBACK) deverá ser incluída em um código de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-255">When errors occur, corrective action (COMMIT or ROLLBACK) should be included in application code.</span></span> <span data-ttu-id="12fe9-256">Uma ferramenta eficaz para lidar com erros, incluindo aqueles em transações, é a [!INCLUDE[tsql](../includes/tsql-md.md)] tentativa... CAPTURAR construção.</span><span class="sxs-lookup"><span data-stu-id="12fe9-256">One effective tool for handling errors, including those in transactions, is the [!INCLUDE[tsql](../includes/tsql-md.md)] TRY...CATCH construct.</span></span> <span data-ttu-id="12fe9-257">Para obter mais informações com exemplos que incluem transações, veja [TRY...CATCH &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/try-catch-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-257">For more information with examples that include transactions, see [TRY...CATCH &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/try-catch-transact-sql).</span></span> <span data-ttu-id="12fe9-258">A partir [!INCLUDE[ssSQL11](../includes/sssql11-md.md)] do, você pode usar a instrução Throw para gerar uma exceção e transfere a execução para um bloco catch de um try... CAPTURAR construção.</span><span class="sxs-lookup"><span data-stu-id="12fe9-258">Beginning with [!INCLUDE[ssSQL11](../includes/sssql11-md.md)], you can use the THROW statement to raise an exception and transfers execution to a CATCH block of a TRY...CATCH construct.</span></span> <span data-ttu-id="12fe9-259">Para obter mais informações, veja [THROW &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/throw-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-259">For more information, see [THROW &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/throw-transact-sql).</span></span>  
  
##### <a name="compile-and-run-time-errors-in-autocommit-mode"></a><span data-ttu-id="12fe9-260">Erros em tempo de execução e de compilação no modo de confirmação automática</span><span class="sxs-lookup"><span data-stu-id="12fe9-260">Compile and Run-time Errors in Autocommit mode</span></span>  

 <span data-ttu-id="12fe9-261">No modo de confirmação automática, às vezes parece que uma instância do [!INCLUDE[ssDE](../includes/ssde-md.md)] reverteu um lote inteiro, em vez de apenas uma instrução SQL.</span><span class="sxs-lookup"><span data-stu-id="12fe9-261">In autocommit mode, it sometimes appears as if an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] has rolled back an entire batch instead of just one SQL statement.</span></span> <span data-ttu-id="12fe9-262">Isto acontece se o erro encontrado for um erro de compilação, não um erro em tempo de execução.</span><span class="sxs-lookup"><span data-stu-id="12fe9-262">This happens if the error encountered is a compile error, not a run-time error.</span></span> <span data-ttu-id="12fe9-263">Um erro de compilação impede o [!INCLUDE[ssDE](../includes/ssde-md.md)] de criar um plano de execução, assim nada no lote é executado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-263">A compile error prevents the [!INCLUDE[ssDE](../includes/ssde-md.md)] from building an execution plan, so nothing in the batch is executed.</span></span> <span data-ttu-id="12fe9-264">Embora pareça que todas as instruções antes daquela que gerou o erro tenham sido revertidas, o erro impediu que tudo no lote fosse executado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-264">Although it appears that all of the statements before the one generating the error were rolled back, the error prevented anything in the batch from being executed.</span></span> <span data-ttu-id="12fe9-265">No exemplo a seguir, nenhuma das instruções `INSERT` no terceiro lote foram executadas por causa de um erro de compilação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-265">In the following example, none of the `INSERT` statements in the third batch are executed because of a compile error.</span></span> <span data-ttu-id="12fe9-266">Parece que as primeiras duas instruções `INSERT` foram revertidas, mas elas nunca foram executadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-266">It appears that the first two `INSERT` statements are rolled back when they are never executed.</span></span>  
  
```sql
CREATE TABLE TestBatch (Cola INT PRIMARY KEY, Colb CHAR(3));  
GO  
INSERT INTO TestBatch VALUES (1, 'aaa');  
INSERT INTO TestBatch VALUES (2, 'bbb');  
INSERT INTO TestBatch VALUSE (3, 'ccc');  -- Syntax error.  
GO  
SELECT * FROM TestBatch;  -- Returns no rows.  
GO  
```  
  
 <span data-ttu-id="12fe9-267">No exemplo a seguir, a terceira instrução `INSERT` gera um erro de duplicação de chave primária em tempo de execução.</span><span class="sxs-lookup"><span data-stu-id="12fe9-267">In the following example, the third `INSERT` statement generates a run-time duplicate primary key error.</span></span> <span data-ttu-id="12fe9-268">As primeiras duas instruções `INSERT` têm êxito e são confirmadas; portanto, elas permanecem depois do erro em tempo de execução.</span><span class="sxs-lookup"><span data-stu-id="12fe9-268">The first two `INSERT` statements are successful and committed, so they remain after the run-time error.</span></span>  
  
```sql  
CREATE TABLE TestBatch (Cola INT PRIMARY KEY, Colb CHAR(3));  
GO  
INSERT INTO TestBatch VALUES (1, 'aaa');  
INSERT INTO TestBatch VALUES (2, 'bbb');  
INSERT INTO TestBatch VALUES (1, 'ccc');  -- Duplicate key error.  
GO  
SELECT * FROM TestBatch;  -- Returns rows 1 and 2.  
GO  
```  
  
 <span data-ttu-id="12fe9-269">O [!INCLUDE[ssDE](../includes/ssde-md.md)] usa resolução de nome adiada, na qual os nomes de objetos não são resolvidos até o tempo de execução.</span><span class="sxs-lookup"><span data-stu-id="12fe9-269">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses deferred name resolution, in which object names are not resolved until execution time.</span></span> <span data-ttu-id="12fe9-270">No exemplo a seguir, as primeiras duas instruções `INSERT` são executadas e confirmadas, e essas duas linhas permanecem na tabela `TestBatch`, depois que a terceira instrução `INSERT` gera um erro em tempo de execução, referindo-se a uma tabela que não existe.</span><span class="sxs-lookup"><span data-stu-id="12fe9-270">In the following example, the first two `INSERT` statements are executed and committed, and those two rows remain in the `TestBatch` table after the third `INSERT` statement generates a run-time error by referring to a table that does not exist.</span></span>  
  
```sql
CREATE TABLE TestBatch (Cola INT PRIMARY KEY, Colb CHAR(3));  
GO  
INSERT INTO TestBatch VALUES (1, 'aaa');  
INSERT INTO TestBatch VALUES (2, 'bbb');  
INSERT INTO TestBch VALUES (3, 'ccc');  -- Table name error.  
GO  
SELECT * FROM TestBatch;  -- Returns rows 1 and 2.  
GO  
```  
  
 <span data-ttu-id="12fe9-271">![Ícone de seta usado com o link voltar ao início](media/uparrow16x16.gif "Ícone de seta usado com o link Voltar ao Início") [neste guia](#Top)</span><span class="sxs-lookup"><span data-stu-id="12fe9-271">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="locking-and-row-versioning-basics"></a><a name="Lock_Basics"></a> <span data-ttu-id="12fe9-272">Noções básicas sobre bloqueio e controle de versão de linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-272">Locking and Row Versioning Basics</span></span>  

 <span data-ttu-id="12fe9-273">O [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] usa os seguintes mecanismos para garantir a integridade de transações e manter a consistência dos bancos de dados quando vários usuários estão acessando os dados ao mesmo tempo:</span><span class="sxs-lookup"><span data-stu-id="12fe9-273">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses the following mechanisms to ensure the integrity of transactions and maintain the consistency of databases when multiple users are accessing data at the same time:</span></span>  
  
-   <span data-ttu-id="12fe9-274">Bloqueio</span><span class="sxs-lookup"><span data-stu-id="12fe9-274">Locking</span></span>  
  
     <span data-ttu-id="12fe9-275">Cada transação solicita bloqueios de tipos diferentes nos recursos, como linhas, páginas ou tabelas, dos quais depende a transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-275">Each transaction requests locks of different types on the resources, such as rows, pages, or tables, on which the transaction is dependent.</span></span> <span data-ttu-id="12fe9-276">Os bloqueios não permitem que outras transações modifiquem os recursos de uma maneira que causaria problemas para a transação que solicita o bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-276">The locks block other transactions from modifying the resources in a way that would cause problems for the transaction requesting the lock.</span></span> <span data-ttu-id="12fe9-277">Cada transação libera seus bloqueios quando não depende mais dos recursos bloqueados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-277">Each transaction frees its locks when it no longer has a dependency on the locked resources.</span></span>  
  
-   <span data-ttu-id="12fe9-278">Controle de versão de linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-278">Row versioning</span></span>  
  
     <span data-ttu-id="12fe9-279">Quando um nível de isolamento baseado em controle de versão de linha é habilitado, o [!INCLUDE[ssDE](../includes/ssde-md.md)] mantém versões de cada linha modificada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-279">When a row versioning-based isolation level is enabled, the [!INCLUDE[ssDE](../includes/ssde-md.md)] maintains versions of each row that is modified.</span></span> <span data-ttu-id="12fe9-280">Os aplicativos podem especificar que uma transação use as versões da linha para exibir dados da forma como eram no início da transação ou consulta ao invés de proteger todas as leituras com bloqueios.</span><span class="sxs-lookup"><span data-stu-id="12fe9-280">Applications can specify that a transaction use the row versions to view data as it existed at the start of the transaction or query instead of protecting all reads with locks.</span></span> <span data-ttu-id="12fe9-281">Usando o controle de versão de linha, a possibilidade de uma operação de leitura bloquear outras transações é muito reduzida.</span><span class="sxs-lookup"><span data-stu-id="12fe9-281">By using row versioning, the chance that a read operation will block other transactions is greatly reduced.</span></span>  
  
 <span data-ttu-id="12fe9-282">O bloqueio e o controle de versão de linha impedem que os usuários leiam dados não confirmados e impedem que vários usuários tentem alterar os mesmos dados ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-282">Locking and row versioning prevent users from reading uncommitted data and prevent multiple users from attempting to change the same data at the same time.</span></span> <span data-ttu-id="12fe9-283">Sem o bloqueio ou o controle de versão de linha, as consultas executadas em relação a esses dados podem produzir resultados inesperados retornando dados que ainda não foram confirmados no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-283">Without locking or row versioning, queries executed against that data could produce unexpected results by returning data that has not yet been committed in the database.</span></span>  
  
 <span data-ttu-id="12fe9-284">Os aplicativos podem escolher níveis de isolamento da transação que definem o nível de proteção da transação contra efeitos de modificações feitas por outras transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-284">Applications can choose transaction isolation levels, which define the level of protection for the transaction from modifications made by other transactions.</span></span> <span data-ttu-id="12fe9-285">Podem ser especificadas dicas em nível de tabela para instruções [!INCLUDE[tsql](../includes/tsql-md.md)] individuais para personalizar ainda mais o comportamento para atender aos requisitos do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-285">Table-level hints can be specified for individual [!INCLUDE[tsql](../includes/tsql-md.md)] statements to further tailor behavior to fit the requirements of the application.</span></span>  
  
### <a name="managing-concurrent-data-access"></a><span data-ttu-id="12fe9-286">Gerenciando o acesso simultâneo a dados</span><span class="sxs-lookup"><span data-stu-id="12fe9-286">Managing Concurrent Data Access</span></span>  

 <span data-ttu-id="12fe9-287">Os usuários que acessam um recurso ao mesmo tempo estão acessando o recurso simultaneamente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-287">Users who access a resource at the same time are said to be accessing the resource concurrently.</span></span> <span data-ttu-id="12fe9-288">O acesso simultâneo a dados exige mecanismos para impedir efeitos adversos quando vários usuários tentam modificar recursos que outros usuários estão utilizando.</span><span class="sxs-lookup"><span data-stu-id="12fe9-288">Concurrent data access requires mechanisms to prevent adverse effects when multiple users try to modify resources that other users are actively using.</span></span>  
  
#### <a name="concurrency-effects"></a><span data-ttu-id="12fe9-289">Efeitos de simultaneidade</span><span class="sxs-lookup"><span data-stu-id="12fe9-289">Concurrency Effects</span></span>  

 <span data-ttu-id="12fe9-290">Os usuários que modificam dados podem afetar outros usuários que estejam lendo ou modificando os mesmos dados ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-290">Users modifying data can affect other users who are reading or modifying the same data at the same time.</span></span> <span data-ttu-id="12fe9-291">Dizemos que esses usuários estão acessando os dados simultaneamente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-291">These users are said to be accessing the data concurrently.</span></span> <span data-ttu-id="12fe9-292">Se um sistema de armazenamento de dados não tiver nenhum controle de simultaneidade, os usuários verão os seguintes efeitos colaterais:</span><span class="sxs-lookup"><span data-stu-id="12fe9-292">If a data storage system has no concurrency control, users could see the following side effects:</span></span>  
  
-   <span data-ttu-id="12fe9-293">Atualizações perdidas</span><span class="sxs-lookup"><span data-stu-id="12fe9-293">Lost updates</span></span>  
  
     <span data-ttu-id="12fe9-294">As atualizações perdidas acontecem quando duas ou mais transações selecionam a mesma linha e então atualizam a linha com base no valor selecionado originalmente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-294">Lost updates occur when two or more transactions select the same row and then update the row based on the value originally selected.</span></span> <span data-ttu-id="12fe9-295">Cada transação não tem conhecimento das outras transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-295">Each transaction is unaware of the other transactions.</span></span> <span data-ttu-id="12fe9-296">A última atualização substitui atualizações feitas pelas outras transações, o que resulta em dados perdidos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-296">The last update overwrites updates made by the other transactions, which results in lost data.</span></span>  
  
     <span data-ttu-id="12fe9-297">Por exemplo, dois editores fazem uma cópia eletrônica do mesmo documento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-297">For example, two editors make an electronic copy of the same document.</span></span> <span data-ttu-id="12fe9-298">Cada editor altera a cópia de maneira independentemente e salva a cópia alterada, substituindo, portanto, o documento original.</span><span class="sxs-lookup"><span data-stu-id="12fe9-298">Each editor changes the copy independently and then saves the changed copy thereby overwriting the original document.</span></span> <span data-ttu-id="12fe9-299">O editor que salva a cópia alterada por último substitui as alterações feitas pelo outro editor.</span><span class="sxs-lookup"><span data-stu-id="12fe9-299">The editor who saves the changed copy last overwrites the changes made by the other editor.</span></span> <span data-ttu-id="12fe9-300">Esse problema poderia ser evitado se um editor não pudesse acessar o arquivo até que o outro editor tivesse terminado e confirmado a transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-300">This problem could be avoided if one editor could not access the file until the other editor had finished and committed the transaction.</span></span>  
  
-   <span data-ttu-id="12fe9-301">Dependência não confirmada (leitura suja)</span><span class="sxs-lookup"><span data-stu-id="12fe9-301">Uncommitted dependency (dirty read)</span></span>  
  
     <span data-ttu-id="12fe9-302">A dependência não confirmada acontece quando uma segunda transação seleciona uma linha que está sendo atualizada por outra transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-302">Uncommitted dependency occurs when a second transaction selects a row that is being updated by another transaction.</span></span> <span data-ttu-id="12fe9-303">A segunda transação está lendo dados que não foram confirmados ainda e podem ser alterados pela transação que atualiza a linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-303">The second transaction is reading data that has not been committed yet and may be changed by the transaction updating the row.</span></span>  
  
     <span data-ttu-id="12fe9-304">Por exemplo, um editor está fazendo mudanças em um documento eletrônico.</span><span class="sxs-lookup"><span data-stu-id="12fe9-304">For example, an editor is making changes to an electronic document.</span></span> <span data-ttu-id="12fe9-305">Durante as mudanças, um segundo editor pega uma cópia do documento que inclui todas as mudanças feitas até o momento e distribui o documento para a audiência destinada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-305">During the changes, a second editor takes a copy of the document that includes all the changes made so far, and distributes the document to the intended audience.</span></span> <span data-ttu-id="12fe9-306">O primeiro editor decide então que as mudanças feitas até o momento estão erradas, remove as edições e salva o documento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-306">The first editor then decides the changes made so far are wrong and removes the edits and saves the document.</span></span> <span data-ttu-id="12fe9-307">O documento distribuído contém edições que já não existem e que deveriam ser tratadas como se nunca tivessem existido.</span><span class="sxs-lookup"><span data-stu-id="12fe9-307">The distributed document contains edits that no longer exist and should be treated as if they never existed.</span></span> <span data-ttu-id="12fe9-308">Esse problema poderia ser evitado se ninguém pudesse ler o documento alterado até que o primeiro editor salvasse a versão final com as modificações e confirmasse a transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-308">This problem could be avoided if no one could read the changed document until the first editor does the final save of modifications and commits the transaction.</span></span>  
  
-   <span data-ttu-id="12fe9-309">Análise inconsistente (leitura não repetível)</span><span class="sxs-lookup"><span data-stu-id="12fe9-309">Inconsistent analysis (nonrepeatable read)</span></span>  
  
     <span data-ttu-id="12fe9-310">Ocorre análise inconsistente quando uma segunda transação acessa a mesma linha várias vezes e lê dados diferentes a cada vez.</span><span class="sxs-lookup"><span data-stu-id="12fe9-310">Inconsistent analysis occurs when a second transaction accesses the same row several times and reads different data each time.</span></span> <span data-ttu-id="12fe9-311">A análise inconsistente é semelhante à dependência não confirmada, no sentido em que outra transação está alterando os dados que uma segunda transação está lendo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-311">Inconsistent analysis is similar to uncommitted dependency in that another transaction is changing the data that a second transaction is reading.</span></span> <span data-ttu-id="12fe9-312">No entanto, na análise inconsistente os dados lidos pela segunda transação foram confirmados pela transação que fez as alterações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-312">However, in inconsistent analysis, the data read by the second transaction was committed by the transaction that made the change.</span></span> <span data-ttu-id="12fe9-313">Além disso, a análise inconsistente envolve leituras múltiplas (duas ou mais) da mesma fila, e a cada vez as informações são alterada por outra transação; daí a denominação leitura não repetível.</span><span class="sxs-lookup"><span data-stu-id="12fe9-313">Also, inconsistent analysis involves multiple reads (two or more) of the same row, and each time the information is changed by another transaction; thus, the term nonrepeatable read.</span></span>  
  
     <span data-ttu-id="12fe9-314">Por exemplo, um editor lê o mesmo documento duas vezes, mas entre cada leitura o escritor reescreve o documento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-314">For example, an editor reads the same document twice, but between each reading the writer rewrites the document.</span></span> <span data-ttu-id="12fe9-315">Quando o editor lê o documento pela segunda vez, este já foi alterado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-315">When the editor reads the document for the second time, it has changed.</span></span> <span data-ttu-id="12fe9-316">A leitura original não era repetível.</span><span class="sxs-lookup"><span data-stu-id="12fe9-316">The original read was not repeatable.</span></span> <span data-ttu-id="12fe9-317">Esse problema poderia ser evitado se o gravador não pudesse alterar o documento até que o editor tivesse terminado de lê-lo pela última vez.</span><span class="sxs-lookup"><span data-stu-id="12fe9-317">This problem could be avoided if the writer could not change the document until the editor has finished reading it for the last time.</span></span>  
  
-   <span data-ttu-id="12fe9-318">Leituras fantasma</span><span class="sxs-lookup"><span data-stu-id="12fe9-318">Phantom reads</span></span>  
  
     <span data-ttu-id="12fe9-319">A leitura fantasma é uma situação que ocorre quando são executadas duas consultas idênticas e a coleção de linhas retornada pela segunda consulta é diferente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-319">A phantom read is a situation that occurs when two identical queries are executed and the collection of rows returned by the second query is different.</span></span> <span data-ttu-id="12fe9-320">O exemplo abaixo mostra como isso pode ocorrer.</span><span class="sxs-lookup"><span data-stu-id="12fe9-320">The example below shows how this may occur.</span></span> <span data-ttu-id="12fe9-321">Suponha que as duas transações abaixo sejam executadas ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-321">Assume the two transactions below are executing at the same time.</span></span> <span data-ttu-id="12fe9-322">As duas instruções SELECT na primeira transação podem retornar resultados diferentes, pois a instrução INSERT na segunda transação altera os dados usados por ambas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-322">The two SELECT statements in the first transaction may return different results because the INSERT statement in the second transaction changes the data used by both.</span></span>  
  
    ```sql  
    --Transaction 1  
    BEGIN TRAN;  
    SELECT ID FROM dbo.employee  
    WHERE ID > 5 and ID < 10;  
    --The INSERT statement from the second transaction occurs here.  
    SELECT ID FROM dbo.employee  
    WHERE ID > 5 and ID < 10;  
    COMMIT;  
    ```  
  
    ```sql  
    --Transaction 2  
    BEGIN TRAN;  
    INSERT INTO dbo.employee  
       SET name = 'New' WHERE ID = 5;  
    COMMIT;   
    ```  
  
-   <span data-ttu-id="12fe9-323">Leituras ausentes e duplicadas provocadas por atualizações de linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-323">Missing and double reads caused by row updates</span></span>  
  
    -   <span data-ttu-id="12fe9-324">Perdendo uma linha atualizada ou vendo uma linha atualizada várias vezes</span><span class="sxs-lookup"><span data-stu-id="12fe9-324">Missing a updated row or seeing an updated row multiple times</span></span>  
  
         <span data-ttu-id="12fe9-325">Transações que estejam sendo executadas no nível READ UNCOMMITTED não emitem bloqueios compartilhados para impedir que outras transações modifiquem os dados lidos pela transação atual.</span><span class="sxs-lookup"><span data-stu-id="12fe9-325">Transactions that are running at the READ UNCOMMITTED level do not issue shared locks to prevent other transactions from modifying data read by the current transaction.</span></span> <span data-ttu-id="12fe9-326">Transações que estejam sendo executadas no nível READ COMMITTED emitem bloqueios compartilhados, mas os bloqueios de linha ou de página são liberados depois que a linha é lida.</span><span class="sxs-lookup"><span data-stu-id="12fe9-326">Transactions that are running at the READ COMMITTED level do issue shared locks, but the row or page locks are released after the row is read.</span></span> <span data-ttu-id="12fe9-327">Em qualquer dos dois casos, quando você estiver percorrendo um índice, se outro usuário alterar a coluna de chave de índice da linha durante sua leitura, a linha poderia aparecer novamente se a alteração de chave movesse a linha para uma posição à frente de sua leitura.</span><span class="sxs-lookup"><span data-stu-id="12fe9-327">In either case, when you are scanning an index, if another user changes the index key column of the row during your read, the row might appear again if the key change moved the row to a position ahead of your scan.</span></span> <span data-ttu-id="12fe9-328">De maneira semelhante, a linha poderia não aparecer se a alteração de chave movesse a linha para uma posição no índice que você já tinha lido.</span><span class="sxs-lookup"><span data-stu-id="12fe9-328">Similarly, the row might not appear if the key change moved the row to a position in the index that you had already read.</span></span> <span data-ttu-id="12fe9-329">Para evitar isto, use a dica SERIALIZABLE ou HOLDLOCK ou controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-329">To avoid this, use the SERIALIZABLE or HOLDLOCK hint, or row versioning.</span></span> <span data-ttu-id="12fe9-330">Para obter mais informações, consulte [Dicas de tabela &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-table).</span><span class="sxs-lookup"><span data-stu-id="12fe9-330">For more information, see [Table Hints &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-table).</span></span>  
  
    -   <span data-ttu-id="12fe9-331">Perdendo uma ou mais linhas que não eram o destino da atualização</span><span class="sxs-lookup"><span data-stu-id="12fe9-331">Missing one or more rows that were not the target of update</span></span>  
  
         <span data-ttu-id="12fe9-332">Quando você estiver usando READ UNCOMMITTED, se sua consulta ler linhas que usem uma varredura de ordem de alocação (usando páginas IAM), você poderá perder linhas se outra transação estiver provocando uma divisão de página.</span><span class="sxs-lookup"><span data-stu-id="12fe9-332">When you are using READ UNCOMMITTED, if your query reads rows using an allocation order scan (using IAM pages), you might miss rows if another transaction is causing a page split.</span></span> <span data-ttu-id="12fe9-333">Isso não pode acontecer quando você estiver usando leitura confirmada, porque um bloqueio de tabela é mantido durante uma divisão de página, e não ocorre se a tabela não tiver um índice clusterizado, porque as atualizações não provocam divisões de página.</span><span class="sxs-lookup"><span data-stu-id="12fe9-333">This cannot occur when you are using read committed because a table lock is held during a page split and does not happen if the table does not have a clustered index, because updates do not cause page splits.</span></span>  
  
#### <a name="types-of-concurrency"></a><span data-ttu-id="12fe9-334">Tipos de simultaneidade</span><span class="sxs-lookup"><span data-stu-id="12fe9-334">Types of Concurrency</span></span>  

 <span data-ttu-id="12fe9-335">Quando muitas pessoas tentam modificar dados em um banco de dados ao mesmo tempo, um sistema de controles deve ser implementado de forma que as modificações feitas por uma pessoa não afetem adversamente as de outra pessoa.</span><span class="sxs-lookup"><span data-stu-id="12fe9-335">When many people attempt to modify data in a database at the same time, a system of controls must be implemented so that modifications made by one person do not adversely affect those of another person.</span></span> <span data-ttu-id="12fe9-336">Isso é chamado controle de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="12fe9-336">This is called concurrency control.</span></span>  
  
 <span data-ttu-id="12fe9-337">A teoria do controle de simultaneidade tem duas classificações para os métodos de instituição do controle de simultaneidade:</span><span class="sxs-lookup"><span data-stu-id="12fe9-337">Concurrency control theory has two classifications for the methods of instituting concurrency control:</span></span>  
  
-   <span data-ttu-id="12fe9-338">Controle de simultaneidade pessimista</span><span class="sxs-lookup"><span data-stu-id="12fe9-338">Pessimistic concurrency control</span></span>  
  
     <span data-ttu-id="12fe9-339">Um sistema de bloqueios impede que os usuários modifiquem os dados de uma forma que afete outros usuários.</span><span class="sxs-lookup"><span data-stu-id="12fe9-339">A system of locks prevents users from modifying data in a way that affects other users.</span></span> <span data-ttu-id="12fe9-340">Depois que um usuário executa uma ação que aplica um bloqueio, outros usuários não podem executar ações que estariam em conflito com o bloqueio até o proprietário liberar o bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-340">After a user performs an action that causes a lock to be applied, other users cannot perform actions that would conflict with the lock until the owner releases it.</span></span> <span data-ttu-id="12fe9-341">Isso é chamado de controle pessimista porque é principalmente usado em ambientes em que existe contenção elevada dos dados, e que o custo da proteção dos dados com bloqueios é inferior ao custo de reversão de transações, caso ocorram conflitos de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="12fe9-341">This is called pessimistic control because it is mainly used in environments where there is high contention for data, where the cost of protecting data with locks is less than the cost of rolling back transactions if concurrency conflicts occur.</span></span>  
  
-   <span data-ttu-id="12fe9-342">Controle de simultaneidade otimista</span><span class="sxs-lookup"><span data-stu-id="12fe9-342">Optimistic concurrency control</span></span>  
  
     <span data-ttu-id="12fe9-343">No controle de simultaneidade otimista, os usuários não bloqueiam os dados quando os leem.</span><span class="sxs-lookup"><span data-stu-id="12fe9-343">In optimistic concurrency control, users do not lock data when they read it.</span></span> <span data-ttu-id="12fe9-344">Quando um usuário atualiza os dados, o sistema verifica se outro usuário alterou os dados depois de lidos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-344">When a user updates data, the system checks to see if another user changed the data after it was read.</span></span> <span data-ttu-id="12fe9-345">Se outro usuário tiver atualizado os dados, um erro é ativado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-345">If another user updated the data, an error is raised.</span></span> <span data-ttu-id="12fe9-346">Normalmente, o usuário que recebe o erro reverte a transação e inicia novamente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-346">Typically, the user receiving the error rolls back the transaction and starts over.</span></span> <span data-ttu-id="12fe9-347">Isso é chamado de controle otimista porque é usado principalmente em ambientes em que existe contenção reduzida dos dados, e que o custo de reversão ocasional de uma transação é inferior ao custo de bloqueio dos dados quando os mesmos são lidos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-347">This is called optimistic because it is mainly used in environments where there is low contention for data, and where the cost of occasionally rolling back a transaction is lower than the cost of locking data when read.</span></span>  
  
 <span data-ttu-id="12fe9-348">O [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] oferece suporte a uma variedade de controles de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="12fe9-348">[!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] supports a range of concurrency control.</span></span> <span data-ttu-id="12fe9-349">Os usuários especificam o tipo de controle de simultaneidade selecionando níveis de isolamento da transação para conexões ou opções de simultaneidade em cursores.</span><span class="sxs-lookup"><span data-stu-id="12fe9-349">Users specify the type of concurrency control by selecting transaction isolation levels for connections or concurrency options on cursors.</span></span> <span data-ttu-id="12fe9-350">Esses atributos podem ser definidos usando instruções [!INCLUDE[tsql](../includes/tsql-md.md)], ou pelas propriedades e atributos de APIs (interfaces de programação de aplicativo) de banco de dados, como ADO, ADO.NET, OLE DB e ODBC.</span><span class="sxs-lookup"><span data-stu-id="12fe9-350">These attributes can be defined using [!INCLUDE[tsql](../includes/tsql-md.md)] statements, or through the properties and attributes of database application programming interfaces (APIs) such as ADO, ADO.NET, OLE DB, and ODBC.</span></span>  
  
#### <a name="isolation-levels-in-the-database-engine"></a><span data-ttu-id="12fe9-351">Níveis de isolamento no Mecanismo de Banco de Dados</span><span class="sxs-lookup"><span data-stu-id="12fe9-351">Isolation Levels in the Database Engine</span></span>  

 <span data-ttu-id="12fe9-352">As transações especificam um nível de isolamento que define o grau em que uma transação deve ser isolada contra modificações de recursos ou de dados feitas por outras transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-352">Transactions specify an isolation level that defines the degree to which one transaction must be isolated from resource or data modifications made by other transactions.</span></span> <span data-ttu-id="12fe9-353">Os níveis de isolamento são descritos em termos de quais efeitos colaterais de simultaneidade são permitidos, como leituras sujas ou leituras fantasma.</span><span class="sxs-lookup"><span data-stu-id="12fe9-353">Isolation levels are described in terms of which concurrency side-effects, such as dirty reads or phantom reads, are allowed.</span></span>  
  
 <span data-ttu-id="12fe9-354">Níveis de isolamento da transação controlam:</span><span class="sxs-lookup"><span data-stu-id="12fe9-354">Transaction isolation levels control:</span></span>  
  
-   <span data-ttu-id="12fe9-355">Se são feitos bloqueios quando os dados são lidos, e que tipo de bloqueio é solicitado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-355">Whether locks are taken when data is read, and what type of locks are requested.</span></span>  
  
-   <span data-ttu-id="12fe9-356">Por quanto tempo os bloqueios de leitura são mantidos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-356">How long the read locks are held.</span></span>  
  
-   <span data-ttu-id="12fe9-357">Se uma linha de referência de operação de leitura foi modificada por outra transação:</span><span class="sxs-lookup"><span data-stu-id="12fe9-357">Whether a read operation referencing rows modified by another transaction:</span></span>  
  
    -   <span data-ttu-id="12fe9-358">Bloqueia até que o bloqueio exclusivo na linha seja liberado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-358">Blocks until the exclusive lock on the row is freed.</span></span>  
  
    -   <span data-ttu-id="12fe9-359">Recupera a versão confirmada da linha existente no momento em que a instrução ou transação foi iniciada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-359">Retrieves the committed version of the row that existed at the time the statement or transaction started.</span></span>  
  
    -   <span data-ttu-id="12fe9-360">Lê a modificação de dados não confirmados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-360">Reads the uncommitted data modification.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="12fe9-361">Escolhendo um nível de isolamento da transação não afeta os bloqueios obtidos para proteger as modificações de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-361">Choosing a transaction isolation level does not affect the locks acquired to protect data modifications.</span></span> <span data-ttu-id="12fe9-362">Uma transação sempre obtém um bloqueio exclusivo em quaisquer dados que modifica e mantém tal bloqueio até que a transação seja concluída, sem considerar o conjunto de níveis de isolamento para a transação em questão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-362">A transaction always gets an exclusive lock on any data it modifies, and holds that lock until the transaction completes, regardless of the isolation level set for that transaction.</span></span> <span data-ttu-id="12fe9-363">Para operações de leitura, níveis de isolamento da transação definem principalmente o nível de proteção dos efeitos das modificações feitas por outras transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-363">For read operations, transaction isolation levels primarily define the level of protection from the effects of modifications made by other transactions.</span></span>  
  
 <span data-ttu-id="12fe9-364">Um nível de isolamento inferior aumenta a capacidade de muitos usuários acessarem dados ao mesmo tempo, mas aumenta o número de efeitos de simultaneidade (como leituras sujas ou atualizações perdidas) que os usuários podem encontrar.</span><span class="sxs-lookup"><span data-stu-id="12fe9-364">A lower isolation level increases the ability of many users to access data at the same time, but increases the number of concurrency effects (such as dirty reads or lost updates) users might encounter.</span></span> <span data-ttu-id="12fe9-365">Inversamente, um nível de isolamento mais alto reduz os tipos de efeito de simultaneidade que os usuários podem encontrar, mas requer mais recursos do sistema e aumenta as chances de uma transação bloquear outra.</span><span class="sxs-lookup"><span data-stu-id="12fe9-365">Conversely, a higher isolation level reduces the types of concurrency effects that users may encounter, but requires more system resources and increases the chances that one transaction will block another.</span></span> <span data-ttu-id="12fe9-366">Escolher o nível de isolamento apropriado depende de equilibrar os requisitos de integridade de dados do aplicativo em relação à sobrecarga de cada nível de isolamento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-366">Choosing the appropriate isolation level depends on balancing the data integrity requirements of the application against the overhead of each isolation level.</span></span> <span data-ttu-id="12fe9-367">O nível de isolamento mais alto, serializável, garante que uma transação recuperará exatamente os mesmos dados toda vez que repetir uma operação de leitura, mas faz isto executando um nível de bloqueio que provavelmente causará impacto em outros usuários em sistemas multiusuários.</span><span class="sxs-lookup"><span data-stu-id="12fe9-367">The highest isolation level, serializable, guarantees that a transaction will retrieve exactly the same data every time it repeats a read operation, but it does this by performing a level of locking that is likely to impact other users in multi-user systems.</span></span> <span data-ttu-id="12fe9-368">O mais baixo nível de isolamento, leitura de dados não confirmados, pode recuperar dados que foram modificados mas não foram confirmados por outras transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-368">The lowest isolation level, read uncommitted, may retrieve data that has been modified but not committed by other transactions.</span></span> <span data-ttu-id="12fe9-369">Todos os efeitos colaterais de simultaneidade podem acontecer em leitura não confirmada, mas não há nenhum bloqueio de leitura ou controle de versão, assim a sobrecarga é minimizada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-369">All of the concurrency side effects can happen in read uncommitted, but there is no read locking or versioning, so overhead is minimized.</span></span>  
  
##### <a name="database-engine-isolation-levels"></a><span data-ttu-id="12fe9-370">Níveis de isolamento do Mecanismo de Banco de Dados</span><span class="sxs-lookup"><span data-stu-id="12fe9-370">Database Engine Isolation Levels</span></span>  

 <span data-ttu-id="12fe9-371">O padrão ISO define os seguintes níveis de isolamento, todos têm suporte pelo [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)]:</span><span class="sxs-lookup"><span data-stu-id="12fe9-371">The ISO standard defines the following isolation levels, all of which are supported by the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)]:</span></span>  
  
|<span data-ttu-id="12fe9-372">Nível de Isolamento</span><span class="sxs-lookup"><span data-stu-id="12fe9-372">Isolation Level</span></span>|<span data-ttu-id="12fe9-373">Definição</span><span class="sxs-lookup"><span data-stu-id="12fe9-373">Definition</span></span>|  
|---------------------|----------------|  
|<span data-ttu-id="12fe9-374">Leitura não confirmada</span><span class="sxs-lookup"><span data-stu-id="12fe9-374">Read uncommitted</span></span>|<span data-ttu-id="12fe9-375">O nível de isolamento mais baixo, no qual as transações só estão isoladas o bastante para assegurar que dados corrompidos fisicamente não são sejam lidos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-375">The lowest isolation level where transactions are isolated only enough to ensure that physically corrupt data is not read.</span></span> <span data-ttu-id="12fe9-376">Nesse nível, são permitidas leituras sujas, para que uma transação tenha acesso às alterações ainda não confirmadas de outras transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-376">In this level, dirty reads are allowed, so one transaction may see not-yet-committed changes made by other transactions.</span></span>|  
|<span data-ttu-id="12fe9-377">Leitura confirmada</span><span class="sxs-lookup"><span data-stu-id="12fe9-377">Read committed</span></span>|<span data-ttu-id="12fe9-378">Permite que uma transação leia dados lidos anteriormente (não modificados) por outra transação, sem esperar pela conclusão da primeira transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-378">Allows a transaction to read data previously read (not modified) by another transaction without waiting for the first transaction to complete.</span></span> <span data-ttu-id="12fe9-379">O [!INCLUDE[ssDE](../includes/ssde-md.md)] mantém bloqueios de gravação (adquiridos em dados selecionados) até o término da transação, mas os bloqueios de leitura são liberados assim que a operação SELECT é efetuada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-379">The [!INCLUDE[ssDE](../includes/ssde-md.md)] keeps write locks (acquired on selected data) until the end of the transaction, but read locks are released as soon as the SELECT operation is performed.</span></span> <span data-ttu-id="12fe9-380">Esse é o nível padrão do [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-380">This is the [!INCLUDE[ssDE](../includes/ssde-md.md)] default level.</span></span>|  
|<span data-ttu-id="12fe9-381">Leitura repetida</span><span class="sxs-lookup"><span data-stu-id="12fe9-381">Repeatable read</span></span>|<span data-ttu-id="12fe9-382">O [!INCLUDE[ssDE](../includes/ssde-md.md)] mantém os bloqueios de gravação e leitura adquiridos em dados selecionados até o término da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-382">The [!INCLUDE[ssDE](../includes/ssde-md.md)] keeps read and write locks that are acquired on selected data until the end of the transaction.</span></span> <span data-ttu-id="12fe9-383">Contudo, poderão ocorrer leituras fantasmas, pois os bloqueios de intervalo não são gerenciados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-383">However, because range-locks are not managed, phantom reads can occur.</span></span>|  
|<span data-ttu-id="12fe9-384">Serializável</span><span class="sxs-lookup"><span data-stu-id="12fe9-384">Serializable</span></span>|<span data-ttu-id="12fe9-385">O nível mais alto, no qual as transações estão completamente isoladas umas das outras.</span><span class="sxs-lookup"><span data-stu-id="12fe9-385">The highest level where transactions are completely isolated from one another.</span></span> <span data-ttu-id="12fe9-386">O [!INCLUDE[ssDE](../includes/ssde-md.md)] mantém os bloqueios de gravação e leitura adquiridos em dados selecionados para que sejam liberados ao final da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-386">The [!INCLUDE[ssDE](../includes/ssde-md.md)] keeps read and write locks acquired on selected data to be released at the end of the transaction.</span></span> <span data-ttu-id="12fe9-387">Os bloqueios de intervalo são adquiridos quando uma operação SELECT usa uma cláusula WHERE em intervalo, sobretudo para evitar leituras fantasmas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-387">Range-locks are acquired when a SELECT operation uses a ranged WHERE clause, especially to avoid phantom reads.</span></span><br /><br /> <span data-ttu-id="12fe9-388">**Observação:** oode haver falha em operações e transações DDL em tabelas replicadas quando o nível de isolamento serializável é solicitado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-388">**Note:** DDL operations and transactions on replicated tables may fail when serializable isolation level is requested.</span></span> <span data-ttu-id="12fe9-389">Isso ocorre porque as consultas de replicação usam dicas que podem ser incompatíveis com o nível de isolamento serializável.</span><span class="sxs-lookup"><span data-stu-id="12fe9-389">This is because replication queries use hints that may be incompatible with serializable isolation level.</span></span>|  
  
 <span data-ttu-id="12fe9-390">O [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] também oferece suporte a dois níveis adicionais de isolamento da transação que usam controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-390">[!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] also supports two additional transaction isolation levels that use row versioning.</span></span> <span data-ttu-id="12fe9-391">O primeiro consiste em uma implementação nova de isolamento de leitura confirmada e o segundo consiste em um nível de isolamento da transação novo, instantâneo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-391">One is an implementation of read committed isolation, and one is a transaction isolation level, snapshot.</span></span>  
  
|<span data-ttu-id="12fe9-392">Nível de isolamento do controle de versão de linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-392">Row Versioning Isolation Level</span></span>|<span data-ttu-id="12fe9-393">Definição</span><span class="sxs-lookup"><span data-stu-id="12fe9-393">Definition</span></span>|  
|------------------------------------|----------------|  
|<span data-ttu-id="12fe9-394">Instantâneo de leitura confirmada</span><span class="sxs-lookup"><span data-stu-id="12fe9-394">Read Committed Snapshot</span></span>|<span data-ttu-id="12fe9-395">Quando a opção de banco de dados READ_COMMITTED_SNAPSHOT estiver definida como ON, o isolamento de leitura confirmada usará o controle de versão de linha para fornecer consistência de leitura no nível da instrução.</span><span class="sxs-lookup"><span data-stu-id="12fe9-395">When the READ_COMMITTED_SNAPSHOT database option is set ON, read committed isolation uses row versioning to provide statement-level read consistency.</span></span> <span data-ttu-id="12fe9-396">Operações de leitura só requerem bloqueios de nível de tabela SCH-S e nenhum bloqueio de página ou linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-396">Read operations require only SCH-S table level locks and no page or row locks.</span></span> <span data-ttu-id="12fe9-397">Ou seja, o mecanismo do banco de dados usa o controle de versão de linha para apresentar a cada instrução um instantâneo transacionalmente consistente dos dados conforme se encontravam no início da instrução.</span><span class="sxs-lookup"><span data-stu-id="12fe9-397">That is, the Database Engine uses row versioning to present each statement with a transactionally consistent snapshot of the data as it existed at the start of the statement.</span></span> <span data-ttu-id="12fe9-398">Não são usados bloqueios para proteger os dados contra atualizações efetuadas por outras transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-398">Locks are not used to protect the data from updates by other transactions.</span></span> <span data-ttu-id="12fe9-399">Uma função definida pelo usuário pode retornar dados confirmados depois do horário de início da instrução que contém que o UDF.</span><span class="sxs-lookup"><span data-stu-id="12fe9-399">A user-defined function can return data that was committed after the time the statement containing the UDF began.</span></span><br /><br /> <span data-ttu-id="12fe9-400">Quando a opção de banco de dados READ_COMMITTED_SNAPSHOT estiver configurada como OFF, que é a configuração padrão, o isolamento de leitura confirmada usará os bloqueios compartilhados para evitar que outras transações modifiquem linhas enquanto a transação atual estiver executando uma operação de leitura.</span><span class="sxs-lookup"><span data-stu-id="12fe9-400">When the READ_COMMITTED_SNAPSHOT database option is set OFF, which is the default setting, read committed isolation uses shared locks to prevent other transactions from modifying rows while the current transaction is running a read operation.</span></span> <span data-ttu-id="12fe9-401">Os bloqueios compartilhados também bloqueiam a instrução de ler linhas modificadas por outras transações até que a outra transação seja concluída.</span><span class="sxs-lookup"><span data-stu-id="12fe9-401">The shared locks also block the statement from reading rows modified by other transactions until the other transaction is completed.</span></span> <span data-ttu-id="12fe9-402">Ambas as implementações satisfazem a definição de ISO de isolamento de leitura confirmada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-402">Both implementations meet the ISO definition of read committed isolation.</span></span>|  
|<span data-ttu-id="12fe9-403">Instantâneo</span><span class="sxs-lookup"><span data-stu-id="12fe9-403">Snapshot</span></span>|<span data-ttu-id="12fe9-404">O nível de isolamento do instantâneo usa controle de versão de linha para fornecer consistência de leitura em nível de transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-404">The snapshot isolation level uses row versioning to provide transaction-level read consistency.</span></span> <span data-ttu-id="12fe9-405">Operações de leitura não requerem bloqueios de página ou linha; apenas bloqueios de tabela SCH-S são necessários.</span><span class="sxs-lookup"><span data-stu-id="12fe9-405">Read operations acquire no page or row locks; only SCH-S table locks are acquired.</span></span> <span data-ttu-id="12fe9-406">Ao ler linhas modificadas por outra transação, elas recuperam a versão da linha que existia na inicialização da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-406">When reading rows modified by another transaction, they retrieve the version of the row that existed when the transaction started.</span></span> <span data-ttu-id="12fe9-407">É possível usar o Isolamento do instantâneo em um banco de dados quando a opção de banco de dados ALLOW_SNAPSHOT_ISOLATION estiver definida como ON.</span><span class="sxs-lookup"><span data-stu-id="12fe9-407">You can only use Snapshot isolation against a database when the ALLOW_SNAPSHOT_ISOLATION database option is set ON.</span></span> <span data-ttu-id="12fe9-408">Por padrão, essa opção é definida como OFF para bancos de dados de usuários.</span><span class="sxs-lookup"><span data-stu-id="12fe9-408">By default, this option is set OFF for user databases.</span></span><br /><br /> <span data-ttu-id="12fe9-409">**Observação:** o [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] não tem suporte para controle de versão de metadados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-409">**Note:**  [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] does not support versioning of metadata.</span></span> <span data-ttu-id="12fe9-410">Por isso, há restrições nas operações de DDL que podem ser executadas em uma transação explícita que está sendo executada sob isolamento do instantâneo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-410">For this reason, there are restrictions on what DDL operations can be performed in an explicit transaction that is running under snapshot isolation.</span></span> <span data-ttu-id="12fe9-411">As instruções DDL a seguir não são permitidas sob o isolamento de instantâneo após uma instrução BEGIN TRANSACTION: ALTER TABLE, CREATE INDEX, CREATE XML INDEX, ALTER INDEX, DROP INDEX, DBCC REINDEX, ALTER PARTITION FUNCTION, ALTER PARTITION SCHEME ou qualquer instrução DDL do CLR (common language runtime).</span><span class="sxs-lookup"><span data-stu-id="12fe9-411">The following DDL statements are not permitted under snapshot isolation after a BEGIN TRANSACTION statement: ALTER TABLE, CREATE INDEX, CREATE XML INDEX, ALTER INDEX, DROP INDEX, DBCC REINDEX, ALTER PARTITION FUNCTION, ALTER PARTITION SCHEME, or any common language runtime (CLR) DDL statement.</span></span> <span data-ttu-id="12fe9-412">Essas instruções serão permitidas quando você estiver usando o isolamento de instantâneo em transações implícitas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-412">These statements are permitted when you are using snapshot isolation within implicit transactions.</span></span> <span data-ttu-id="12fe9-413">Uma transação implícita, por definição, é uma instrução única que torna possível impor semânticas de isolamento do instantâneo, até mesmo com instruções DDL.</span><span class="sxs-lookup"><span data-stu-id="12fe9-413">An implicit transaction, by definition, is a single statement that makes it possible to enforce the semantics of snapshot isolation, even with DDL statements.</span></span> <span data-ttu-id="12fe9-414">Violações desse princípio podem causar o erro 3961: “Falha na transação de isolamento do instantâneo no banco de dados '%. \* ls' porque o objeto acessado pela instrução foi modificado por uma instrução de DDL em outra transação simultânea desde o início dessa transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-414">Violations of this principle can cause error 3961: "Snapshot isolation transaction failed in database '%.\*ls' because the object accessed by the statement has been modified by a DDL statement in another concurrent transaction since the start of this transaction.</span></span> <span data-ttu-id="12fe9-415">Isso não é permitido porque os metadados não têm controle de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-415">It is not allowed because the metadata is not versioned.</span></span> <span data-ttu-id="12fe9-416">Uma atualização simultânea para metadados poderia gerar inconsistências se misturada com isolamento do instantâneo."</span><span class="sxs-lookup"><span data-stu-id="12fe9-416">A concurrent update to metadata could lead to inconsistency if mixed with snapshot isolation."</span></span>|  
  
 <span data-ttu-id="12fe9-417">A tabela a seguir mostra os efeitos colaterais de simultaneidade habilitados por níveis de isolamento diferentes.</span><span class="sxs-lookup"><span data-stu-id="12fe9-417">The following table shows the concurrency side effects enabled by the different isolation levels.</span></span>  
  
|<span data-ttu-id="12fe9-418">Nível de isolamento</span><span class="sxs-lookup"><span data-stu-id="12fe9-418">Isolation level</span></span>|<span data-ttu-id="12fe9-419">Leitura suja</span><span class="sxs-lookup"><span data-stu-id="12fe9-419">Dirty read</span></span>|<span data-ttu-id="12fe9-420">Leitura não repetível</span><span class="sxs-lookup"><span data-stu-id="12fe9-420">Nonrepeatable read</span></span>|<span data-ttu-id="12fe9-421">Fantasma</span><span class="sxs-lookup"><span data-stu-id="12fe9-421">Phantom</span></span>|  
|---------------------|----------------|------------------------|-------------|  
|<span data-ttu-id="12fe9-422">**Leitura não confirmada**</span><span class="sxs-lookup"><span data-stu-id="12fe9-422">**Read uncommitted**</span></span>|<span data-ttu-id="12fe9-423">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-423">Yes</span></span>|<span data-ttu-id="12fe9-424">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-424">Yes</span></span>|<span data-ttu-id="12fe9-425">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-425">Yes</span></span>|  
|<span data-ttu-id="12fe9-426">**Leitura confirmada**</span><span class="sxs-lookup"><span data-stu-id="12fe9-426">**Read committed**</span></span>|<span data-ttu-id="12fe9-427">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-427">No</span></span>|<span data-ttu-id="12fe9-428">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-428">Yes</span></span>|<span data-ttu-id="12fe9-429">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-429">Yes</span></span>|  
|<span data-ttu-id="12fe9-430">**Leitura repetível**</span><span class="sxs-lookup"><span data-stu-id="12fe9-430">**Repeatable read**</span></span>|<span data-ttu-id="12fe9-431">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-431">No</span></span>|<span data-ttu-id="12fe9-432">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-432">No</span></span>|<span data-ttu-id="12fe9-433">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-433">Yes</span></span>|  
|<span data-ttu-id="12fe9-434">**Instantâneo**</span><span class="sxs-lookup"><span data-stu-id="12fe9-434">**Snapshot**</span></span>|<span data-ttu-id="12fe9-435">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-435">No</span></span>|<span data-ttu-id="12fe9-436">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-436">No</span></span>|<span data-ttu-id="12fe9-437">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-437">No</span></span>|  
|<span data-ttu-id="12fe9-438">**Serializável**</span><span class="sxs-lookup"><span data-stu-id="12fe9-438">**Serializable**</span></span>|<span data-ttu-id="12fe9-439">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-439">No</span></span>|<span data-ttu-id="12fe9-440">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-440">No</span></span>|<span data-ttu-id="12fe9-441">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-441">No</span></span>|  
  
 <span data-ttu-id="12fe9-442">Para obter mais informações sobre os tipos específicos de controle de versão de linha ou bloqueio controlado pelos níveis de isolamento de transação, veja [SET TRANSACTION ISOLATION LEVEL &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-442">For more information about the specific types of locking or row versioning controlled by each transaction isolation level, see [SET TRANSACTION ISOLATION LEVEL &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql).</span></span>  
  
 <span data-ttu-id="12fe9-443">Níveis de isolamento da transação podem ser definidos usando [!INCLUDE[tsql](../includes/tsql-md.md)] ou por uma API de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-443">Transaction isolation levels can be set using [!INCLUDE[tsql](../includes/tsql-md.md)] or through a database API.</span></span>  
  
 [!INCLUDE[tsql](../includes/tsql-md.md)]  
 <span data-ttu-id="12fe9-444">Scripts [!INCLUDE[tsql](../includes/tsql-md.md)] usam a instrução SET TRANSACTION ISOLATION LEVEL.</span><span class="sxs-lookup"><span data-stu-id="12fe9-444">[!INCLUDE[tsql](../includes/tsql-md.md)] scripts use the SET TRANSACTION ISOLATION LEVEL statement.</span></span>  
  
 <span data-ttu-id="12fe9-445">ADO</span><span class="sxs-lookup"><span data-stu-id="12fe9-445">ADO</span></span>  
 <span data-ttu-id="12fe9-446">Aplicativos ADO definem a propriedade `IsolationLevel` do objeto **Connection** como adXactReadUncommitted, adXactReadCommitted, adXactRepeatableRead ou adXactReadSerializable.</span><span class="sxs-lookup"><span data-stu-id="12fe9-446">ADO applications set the `IsolationLevel` property of the **Connection** object to adXactReadUncommitted, adXactReadCommitted, adXactRepeatableRead, or adXactReadSerializable.</span></span>  
  
 <span data-ttu-id="12fe9-447">ADO.NET</span><span class="sxs-lookup"><span data-stu-id="12fe9-447">ADO.NET</span></span>  
 <span data-ttu-id="12fe9-448">Aplicativos ADO.NET que usam o namespace gerenciado `System.Data.SqlClient` podem chamar o método `SqlConnection.BeginTransaction` e definir a opção *IsolationLevel* como Unspecified, Chaos, ReadUncommitted, ReadCommitted, RepeatableRead, Serializable e Snapshot.</span><span class="sxs-lookup"><span data-stu-id="12fe9-448">ADO.NET applications using the `System.Data.SqlClient` managed namespace can call the `SqlConnection.BeginTransaction` method and set the *IsolationLevel* option to Unspecified, Chaos, ReadUncommitted, ReadCommitted, RepeatableRead, Serializable, and Snapshot.</span></span>  
  
 <span data-ttu-id="12fe9-449">OLE DB</span><span class="sxs-lookup"><span data-stu-id="12fe9-449">OLE DB</span></span>  
 <span data-ttu-id="12fe9-450">Ao iniciar uma transação, aplicativos que usam OLE DB chamam `ITransactionLocal::StartTransaction` com *isoLevel* definido como ISOLATIONLEVEL_READUNCOMMITTED, ISOLATIONLEVEL_READCOMMITTED, ISOLATIONLEVEL_REPEATABLEREAD, ISOLATIONLEVEL_SNAPSHOT ou ISOLATIONLEVEL_SERIALIZABLE.</span><span class="sxs-lookup"><span data-stu-id="12fe9-450">When starting a transaction, applications using OLE DB call `ITransactionLocal::StartTransaction` with *isoLevel* set to ISOLATIONLEVEL_READUNCOMMITTED, ISOLATIONLEVEL_READCOMMITTED, ISOLATIONLEVEL_REPEATABLEREAD, ISOLATIONLEVEL_SNAPSHOT, or ISOLATIONLEVEL_SERIALIZABLE.</span></span>  
  
 <span data-ttu-id="12fe9-451">Ao especificar o nível de isolamento da transação em modo de confirmação automática, aplicativos OLE DB podem definir a propriedade DBPROPSET_SESSION como DBPROP_SESS_AUTOCOMMITISOLEVELS DBPROPVAL_TI_CHAOS, DBPROPVAL_TI_READUNCOMMITTED, DBPROPVAL_TI_BROWSE, DBPROPVAL_TI_CURSORSTABILITY, DBPROPVAL_TI_READCOMMITTED, DBPROPVAL_TI_REPEATABLEREAD, DBPROPVAL_TI_SERIALIZABLE, DBPROPVAL_TI_ISOLATED ou DBPROPVAL_TI_SNAPSHOT.</span><span class="sxs-lookup"><span data-stu-id="12fe9-451">When specifying the transaction isolation level in autocommit mode, OLE DB applications can set the DBPROPSET_SESSION property DBPROP_SESS_AUTOCOMMITISOLEVELS to DBPROPVAL_TI_CHAOS, DBPROPVAL_TI_READUNCOMMITTED, DBPROPVAL_TI_BROWSE, DBPROPVAL_TI_CURSORSTABILITY, DBPROPVAL_TI_READCOMMITTED, DBPROPVAL_TI_REPEATABLEREAD, DBPROPVAL_TI_SERIALIZABLE, DBPROPVAL_TI_ISOLATED, or DBPROPVAL_TI_SNAPSHOT.</span></span>  
  
 <span data-ttu-id="12fe9-452">ODBCODBC</span><span class="sxs-lookup"><span data-stu-id="12fe9-452">ODBC</span></span>  
 <span data-ttu-id="12fe9-453">Aplicativos ODBC chamam `SQLSetConnectAttr` com *Attribute* definido como SQL_ATTR_TXN_ISOLATION e *ValuePtr* definido como SQL_TXN_READ_UNCOMMITTED, SQL_TXN_READ_COMMITTED, SQL_TXN_REPEATABLE_READ ou SQL_TXN_SERIALIZABLE.</span><span class="sxs-lookup"><span data-stu-id="12fe9-453">ODBC applications call `SQLSetConnectAttr` with *Attribute* set to SQL_ATTR_TXN_ISOLATION and *ValuePtr* set to SQL_TXN_READ_UNCOMMITTED, SQL_TXN_READ_COMMITTED, SQL_TXN_REPEATABLE_READ, or SQL_TXN_SERIALIZABLE.</span></span>  
  
 <span data-ttu-id="12fe9-454">Para transações de instantâneo, os aplicativos chamam `SQLSetConnectAttr` com Atributo definido como SQL_COPT_SS_TXN_ISOLATION e ValuePtr definido como SQL_TXN_SS_SNAPSHOT.</span><span class="sxs-lookup"><span data-stu-id="12fe9-454">For snapshot transactions, applications call `SQLSetConnectAttr` with Attribute set to SQL_COPT_SS_TXN_ISOLATION and ValuePtr set to SQL_TXN_SS_SNAPSHOT.</span></span> <span data-ttu-id="12fe9-455">Uma transação de instantâneo que usa SQL_COPT_SS_TXN_ISOLATION ou SQL_ATTR_TXN_ISOLATION pode ser recuperada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-455">A snapshot transaction can be retrieved using either SQL_COPT_SS_TXN_ISOLATION or SQL_ATTR_TXN_ISOLATION.</span></span>  
  
 <span data-ttu-id="12fe9-456">![Ícone de seta usado com o link voltar ao início](media/uparrow16x16.gif "Ícone de seta usado com o link Voltar ao Início") [neste guia](#Top)</span><span class="sxs-lookup"><span data-stu-id="12fe9-456">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="locking-in-the-database-engine"></a><a name="Lock_Engine"></a> <span data-ttu-id="12fe9-457">Bloqueio no Mecanismo de Banco de Dados</span><span class="sxs-lookup"><span data-stu-id="12fe9-457">Locking in the Database Engine</span></span>  

 <span data-ttu-id="12fe9-458">O bloqueio é um mecanismo usado pelo [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] para sincronizar o acesso de vários usuários à mesma parte dos dados simultaneamente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-458">Locking is a mechanism used by the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] to synchronize access by multiple users to the same piece of data at the same time.</span></span>  
  
 <span data-ttu-id="12fe9-459">Antes que uma transação adquira uma dependência de uma parte dos dados no estado atual, como por ler ou modificar os dados, ela deve se proteger contra os efeitos de outra transação que modifique os mesmos dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-459">Before a transaction acquires a dependency on the current state of a piece of data, such as by reading or modifying the data, it must protect itself from the effects of another transaction modifying the same data.</span></span> <span data-ttu-id="12fe9-460">A transação faz isso, solicitando um bloqueio na parte dos dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-460">The transaction does this by requesting a lock on the piece of data.</span></span> <span data-ttu-id="12fe9-461">Os bloqueios têm modos diferentes, como compartilhado ou exclusivo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-461">Locks have different modes, such as shared or exclusive.</span></span> <span data-ttu-id="12fe9-462">O modo de bloqueio define o nível de dependência que a transação tem nos dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-462">The lock mode defines the level of dependency the transaction has on the data.</span></span> <span data-ttu-id="12fe9-463">Nenhuma transação pode receber um bloqueio que conflite com o modo de um bloqueio já atribuído àqueles dados por outra transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-463">No transaction can be granted a lock that would conflict with the mode of a lock already granted on that data to another transaction.</span></span> <span data-ttu-id="12fe9-464">Se uma transação requisitar um modo de bloqueio que conflite com um bloqueio que já tenha sido atribuído aos mesmos dados, a instância do [!INCLUDE[ssDE](../includes/ssde-md.md)] fará uma pausa na transação requerida até que o primeiro bloqueio seja liberado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-464">If a transaction requests a lock mode that conflicts with a lock that has already been granted on the same data, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] will pause the requesting transaction until the first lock is released.</span></span>  
  
 <span data-ttu-id="12fe9-465">Quando uma transação modifica uma parte dos dados, ela mantém o bloqueio protegendo a modificação até o fim da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-465">When a transaction modifies a piece of data, it holds the lock protecting the modification until the end of the transaction.</span></span> <span data-ttu-id="12fe9-466">O tempo que uma transação mantém os bloqueios adquiridos, para proteger as operações de leitura, depende da configuração do nível de isolamento da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-466">How long a transaction holds the locks acquired to protect read operations depends on the transaction isolation level setting.</span></span> <span data-ttu-id="12fe9-467">Todos os bloqueios mantidos por uma transação são liberados quando a transação for concluída (confirma ou reverte).</span><span class="sxs-lookup"><span data-stu-id="12fe9-467">All locks held by a transaction are released when the transaction completes (either commits or rolls back).</span></span>  
  
 <span data-ttu-id="12fe9-468">Os aplicativos normalmente não solicitam bloqueios diretamente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-468">Applications do not typically request locks directly.</span></span> <span data-ttu-id="12fe9-469">Os bloqueios são administrados internamente por uma parte do [!INCLUDE[ssDE](../includes/ssde-md.md)] chamado de gerenciador de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-469">Locks are managed internally by a part of the [!INCLUDE[ssDE](../includes/ssde-md.md)] called the lock manager.</span></span> <span data-ttu-id="12fe9-470">Quando uma instância do [!INCLUDE[ssDE](../includes/ssde-md.md)] processa uma instrução [!INCLUDE[tsql](../includes/tsql-md.md)], o [!INCLUDE[ssDE](../includes/ssde-md.md)] processador de consulta determina quais recursos devem ser acessados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-470">When an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] processes a [!INCLUDE[tsql](../includes/tsql-md.md)] statement, the [!INCLUDE[ssDE](../includes/ssde-md.md)] query processor determines which resources are to be accessed.</span></span> <span data-ttu-id="12fe9-471">O processador de consulta determina que tipos de bloqueio são necessários para proteger cada recurso baseado no tipo de acesso e no nível configurado de isolamento da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-471">The query processor determines what types of locks are required to protect each resource based on the type of access and the transaction isolation level setting.</span></span> <span data-ttu-id="12fe9-472">O processador de consulta solicita os bloqueios apropriados ao gerenciador de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-472">The query processor then requests the appropriate locks from the lock manager.</span></span> <span data-ttu-id="12fe9-473">O gerenciador de bloqueio concede os bloqueios, se não houver bloqueios conflitantes mantidos por outras transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-473">The lock manager grants the locks if there are no conflicting locks held by other transactions.</span></span>  
  
### <a name="lock-granularity-and-hierarchies"></a><span data-ttu-id="12fe9-474">Bloqueio de granularidade e hierarquias</span><span class="sxs-lookup"><span data-stu-id="12fe9-474">Lock Granularity and Hierarchies</span></span>  

 <span data-ttu-id="12fe9-475">O [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] tem bloqueio multigranular que permite a uma transação bloquear diferentes tipos de recursos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-475">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] has multigranular locking that allows different types of resources to be locked by a transaction.</span></span> <span data-ttu-id="12fe9-476">Para minimizar o custo de bloqueio, o [!INCLUDE[ssDE](../includes/ssde-md.md)] bloqueia recursos automaticamente, em um nível apropriado para a tarefa.</span><span class="sxs-lookup"><span data-stu-id="12fe9-476">To minimize the cost of locking, the [!INCLUDE[ssDE](../includes/ssde-md.md)] locks resources automatically at a level appropriate to the task.</span></span> <span data-ttu-id="12fe9-477">Bloquear em uma granularidade menor como, por exemplo linhas, aumenta a concorrência mas tem uma sobrecarga maior, devido à exigência de mais bloqueios mantidos, se muitas linhas forem bloqueadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-477">Locking at a smaller granularity, such as rows, increases concurrency but has a higher overhead because more locks must be held if many rows are locked.</span></span> <span data-ttu-id="12fe9-478">Bloqueando em uma granularidade maior, como tabelas, é dispendioso em termos de simultaneidade, porque bloquear a tabela inteira restringe o acesso a qualquer parte da tabela por outras transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-478">Locking at a larger granularity, such as tables, are expensive in terms of concurrency because locking an entire table restricts access to any part of the table by other transactions.</span></span> <span data-ttu-id="12fe9-479">No entanto, tem uma sobrecarga menor, porque menos bloqueios estão sendo mantidos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-479">However, it has a lower overhead because fewer locks are being maintained.</span></span>  
  
 <span data-ttu-id="12fe9-480">O [!INCLUDE[ssDE](../includes/ssde-md.md)] precisa, frequentemente, adquirir bloqueios em vários níveis de granularidade para proteger totalmente um recurso.</span><span class="sxs-lookup"><span data-stu-id="12fe9-480">The [!INCLUDE[ssDE](../includes/ssde-md.md)] often has to acquire locks at multiple levels of granularity to fully protect a resource.</span></span> <span data-ttu-id="12fe9-481">Esse grupo de bloqueios em vários níveis de granularidade é chamado de uma hierarquia de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-481">This group of locks at multiple levels of granularity is called a lock hierarchy.</span></span> <span data-ttu-id="12fe9-482">Por exemplo, para proteger inteiramente a leitura de um índice, uma instância do [!INCLUDE[ssDE](../includes/ssde-md.md)] pode ter que adquirir bloqueios compartilhados em linhas e bloqueios intencionais compartilhados nas páginas e na tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-482">For example, to fully protect a read of an index, an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] may have to acquire share locks on rows and intent share locks on the pages and table.</span></span>  
  
 <span data-ttu-id="12fe9-483">A tabela seguinte mostra os recursos que o [!INCLUDE[ssDE](../includes/ssde-md.md)] pode bloquear.</span><span class="sxs-lookup"><span data-stu-id="12fe9-483">The following table shows the resources that the [!INCLUDE[ssDE](../includes/ssde-md.md)] can lock.</span></span>  
  
|<span data-ttu-id="12fe9-484">Recurso</span><span class="sxs-lookup"><span data-stu-id="12fe9-484">Resource</span></span>|<span data-ttu-id="12fe9-485">Descrição</span><span class="sxs-lookup"><span data-stu-id="12fe9-485">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="12fe9-486">RID</span><span class="sxs-lookup"><span data-stu-id="12fe9-486">RID</span></span>|<span data-ttu-id="12fe9-487">Um identificador de linha usado para bloquear uma única linha dentro de um heap.</span><span class="sxs-lookup"><span data-stu-id="12fe9-487">A row identifier used to lock a single row within a heap.</span></span>|  
|<span data-ttu-id="12fe9-488">KEY</span><span class="sxs-lookup"><span data-stu-id="12fe9-488">KEY</span></span>|<span data-ttu-id="12fe9-489">Um bloqueio de linha dentro de um índice usado para proteger um intervalo de chaves em transações serializáveis.</span><span class="sxs-lookup"><span data-stu-id="12fe9-489">A row lock within an index used to protect key ranges in serializable transactions.</span></span>|  
|<span data-ttu-id="12fe9-490">PAGE</span><span class="sxs-lookup"><span data-stu-id="12fe9-490">PAGE</span></span>|<span data-ttu-id="12fe9-491">Uma página de 8 quilobytes (KB) em um banco de dados, como dados ou páginas de índice.</span><span class="sxs-lookup"><span data-stu-id="12fe9-491">An 8-kilobyte (KB) page in a database, such as data or index pages.</span></span>|  
|<span data-ttu-id="12fe9-492">EXTENT</span><span class="sxs-lookup"><span data-stu-id="12fe9-492">EXTENT</span></span>|<span data-ttu-id="12fe9-493">Um grupo contíguo de oito páginas, como dados ou páginas de índice.</span><span class="sxs-lookup"><span data-stu-id="12fe9-493">A contiguous group of eight pages, such as data or index pages.</span></span>|  
|<span data-ttu-id="12fe9-494">HoBT</span><span class="sxs-lookup"><span data-stu-id="12fe9-494">HoBT</span></span>|<span data-ttu-id="12fe9-495">Um heap ou árvore-B.</span><span class="sxs-lookup"><span data-stu-id="12fe9-495">A heap or B-tree.</span></span> <span data-ttu-id="12fe9-496">Um bloqueio protegendo uma árvore-B (índice) ou o heap de páginas de dados que não tem um índice clusterizado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-496">A lock protecting a B-tree (index) or the heap data pages in a table that does not have a clustered index.</span></span>|  
|<span data-ttu-id="12fe9-497">TABLE</span><span class="sxs-lookup"><span data-stu-id="12fe9-497">TABLE</span></span>|<span data-ttu-id="12fe9-498">A tabela inteira, inclusive todos os dados e índices.</span><span class="sxs-lookup"><span data-stu-id="12fe9-498">The entire table, including all data and indexes.</span></span>|  
|<span data-ttu-id="12fe9-499">FILE</span><span class="sxs-lookup"><span data-stu-id="12fe9-499">FILE</span></span>|<span data-ttu-id="12fe9-500">Um arquivo do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-500">A database file.</span></span>|  
|<span data-ttu-id="12fe9-501">APPLICATION</span><span class="sxs-lookup"><span data-stu-id="12fe9-501">APPLICATION</span></span>|<span data-ttu-id="12fe9-502">Um recurso de aplicativo especificado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-502">An application-specified resource.</span></span>|  
|<span data-ttu-id="12fe9-503">METADATA</span><span class="sxs-lookup"><span data-stu-id="12fe9-503">METADATA</span></span>|<span data-ttu-id="12fe9-504">Bloqueios de metadados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-504">Metadata locks.</span></span>|  
|<span data-ttu-id="12fe9-505">ALLOCATION_UNIT</span><span class="sxs-lookup"><span data-stu-id="12fe9-505">ALLOCATION_UNIT</span></span>|<span data-ttu-id="12fe9-506">Uma unidade de alocação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-506">An allocation unit.</span></span>|  
|<span data-ttu-id="12fe9-507">DATABASE</span><span class="sxs-lookup"><span data-stu-id="12fe9-507">DATABASE</span></span>|<span data-ttu-id="12fe9-508">O banco de dados inteiro.</span><span class="sxs-lookup"><span data-stu-id="12fe9-508">The entire database.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-509">HoBT e bloqueios de TABLE podem ser afetados pela opção de LOCK_ESCALATION de [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-509">HoBT and TABLE locks can be affected by the LOCK_ESCALATION option of [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span></span>  
  
### <a name="lock-modes"></a><span data-ttu-id="12fe9-510">Modos de bloqueio</span><span class="sxs-lookup"><span data-stu-id="12fe9-510">Lock Modes</span></span>  

 <span data-ttu-id="12fe9-511">O [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] bloqueia recursos que, usando diferentes modos de bloqueio, determinam como os recursos podem ser acessados por transações simultâneas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-511">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] locks resources using different lock modes that determine how the resources can be accessed by concurrent transactions.</span></span>  
  
 <span data-ttu-id="12fe9-512">A tabela a seguir mostra o recurso de modos de bloqueio que o [!INCLUDE[ssDE](../includes/ssde-md.md)] utiliza.</span><span class="sxs-lookup"><span data-stu-id="12fe9-512">The following table shows the resource lock modes that the [!INCLUDE[ssDE](../includes/ssde-md.md)] uses.</span></span>  
  
|<span data-ttu-id="12fe9-513">Modo de bloqueio</span><span class="sxs-lookup"><span data-stu-id="12fe9-513">Lock mode</span></span>|<span data-ttu-id="12fe9-514">Descrição</span><span class="sxs-lookup"><span data-stu-id="12fe9-514">Description</span></span>|  
|---------------|-----------------|  
|<span data-ttu-id="12fe9-515">Compartilhado (S)</span><span class="sxs-lookup"><span data-stu-id="12fe9-515">Shared (S)</span></span>|<span data-ttu-id="12fe9-516">Usado para operações de leitura que não alteram ou atualizam dados, como uma instrução SELECT.</span><span class="sxs-lookup"><span data-stu-id="12fe9-516">Used for read operations that do not change or update data, such as a SELECT statement.</span></span>|  
|<span data-ttu-id="12fe9-517">Atualização (U)</span><span class="sxs-lookup"><span data-stu-id="12fe9-517">Update (U)</span></span>|<span data-ttu-id="12fe9-518">Usado em recursos que podem ser atualizados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-518">Used on resources that can be updated.</span></span> <span data-ttu-id="12fe9-519">Evita uma forma comum de deadlock que ocorre quando várias sessões estão lendo, bloqueando e potencialmente atualizando recursos mais tarde.</span><span class="sxs-lookup"><span data-stu-id="12fe9-519">Prevents a common form of deadlock that occurs when multiple sessions are reading, locking, and potentially updating resources later.</span></span>|  
|<span data-ttu-id="12fe9-520">Exclusivo (X)</span><span class="sxs-lookup"><span data-stu-id="12fe9-520">Exclusive (X)</span></span>|<span data-ttu-id="12fe9-521">Usado para operações da modificação de dados, como INSERT, UPDATE ou DELETE.</span><span class="sxs-lookup"><span data-stu-id="12fe9-521">Used for data-modification operations, such as INSERT, UPDATE, or DELETE.</span></span> <span data-ttu-id="12fe9-522">Assegura que várias atualizações não sejam realizadas no mesmo recurso ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-522">Ensures that multiple updates cannot be made to the same resource at the same time.</span></span>|  
|<span data-ttu-id="12fe9-523">Intencional</span><span class="sxs-lookup"><span data-stu-id="12fe9-523">Intent</span></span>|<span data-ttu-id="12fe9-524">Usado para estabelecer uma hierarquia de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-524">Used to establish a lock hierarchy.</span></span> <span data-ttu-id="12fe9-525">Os tipos de bloqueios intencionais são: intencional compartilhado (IS), intencional exclusivo (IX) e compartilhado com intenção exclusiva (SIX).</span><span class="sxs-lookup"><span data-stu-id="12fe9-525">The types of intent locks are: intent shared (IS), intent exclusive (IX), and shared with intent exclusive (SIX).</span></span>|  
|<span data-ttu-id="12fe9-526">Esquema</span><span class="sxs-lookup"><span data-stu-id="12fe9-526">Schema</span></span>|<span data-ttu-id="12fe9-527">Usado quando uma operação dependente do esquema de uma tabela está em execução.</span><span class="sxs-lookup"><span data-stu-id="12fe9-527">Used when an operation dependent on the schema of a table is executing.</span></span> <span data-ttu-id="12fe9-528">Os tipos de bloqueios de esquema são: modificação de esquema (Sch-M) e estabilidade de esquema (Sch-S).</span><span class="sxs-lookup"><span data-stu-id="12fe9-528">The types of schema locks are: schema modification (Sch-M) and schema stability (Sch-S).</span></span>|  
|<span data-ttu-id="12fe9-529">Atualização em massa (BU).</span><span class="sxs-lookup"><span data-stu-id="12fe9-529">Bulk Update (BU)</span></span>|<span data-ttu-id="12fe9-530">Usado quando para copiar dados em massa em uma tabela e a dica **TABLOCK** está especificada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-530">Used when bulk copying data into a table and the **TABLOCK** hint is specified.</span></span>|  
|<span data-ttu-id="12fe9-531">Intervalo de chave</span><span class="sxs-lookup"><span data-stu-id="12fe9-531">Key-range</span></span>|<span data-ttu-id="12fe9-532">Protege o intervalo de leitura de linhas lido por uma consulta ao usar o nível de isolamento da transação serializável.</span><span class="sxs-lookup"><span data-stu-id="12fe9-532">Protects the range of rows read by a query when using the serializable transaction isolation level.</span></span> <span data-ttu-id="12fe9-533">Assegura que outras transações não possam inserir linhas que se qualifiquem para consultas da transação serializável se as consultas forem executadas novamente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-533">Ensures that other transactions cannot insert rows that would qualify for the queries of the serializable transaction if the queries were run again.</span></span>|  
  
#### <a name="shared-locks"></a><span data-ttu-id="12fe9-534">Bloqueios compartilhados</span><span class="sxs-lookup"><span data-stu-id="12fe9-534">Shared Locks</span></span>  

 <span data-ttu-id="12fe9-535">Bloqueios compartilhados (S) permitem que transações simultâneas leiam um recurso (SELECT) sob controle de simultaneidade pessimista.</span><span class="sxs-lookup"><span data-stu-id="12fe9-535">Shared (S) locks allow concurrent transactions to read (SELECT) a resource under pessimistic concurrency control.</span></span> <span data-ttu-id="12fe9-536">Nenhuma outra transação pode modificar os dados enquanto bloqueios compartilhados (S) existirem no recurso.</span><span class="sxs-lookup"><span data-stu-id="12fe9-536">No other transactions can modify the data while shared (S) locks exist on the resource.</span></span> <span data-ttu-id="12fe9-537">Bloqueios compartilhados (S) em um recurso são liberados quando a operação de leitura termina, exceto se o nível de isolamento da transação for configurado para leitura repetida ou maior ou uma dica de bloqueio for usada para reter os bloqueios compartilhados (S) pela duração da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-537">Shared (S) locks on a resource are released as soon as the read operation completes, unless the transaction isolation level is set to repeatable read or higher, or a locking hint is used to retain the shared (S) locks for the duration of the transaction.</span></span>  
  
#### <a name="update-locks"></a><span data-ttu-id="12fe9-538">Bloqueios de atualização</span><span class="sxs-lookup"><span data-stu-id="12fe9-538">Update Locks</span></span>  

 <span data-ttu-id="12fe9-539">Bloqueios de atualização (U) evitam que um formulário comum faça deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-539">Update (U) locks prevent a common form of deadlock.</span></span> <span data-ttu-id="12fe9-540">Em uma transação serializável ou em leitura repetida, a transação lê os dados, adquire um bloqueio compartilhado (S) no recurso (página ou linha) e, então, modifica os dados, o que requer uma conversão para um bloqueio exclusivo (X).</span><span class="sxs-lookup"><span data-stu-id="12fe9-540">In a repeatable read or serializable transaction, the transaction reads data, acquiring a shared (S) lock on the resource (page or row), and then modifies the data, which requires lock conversion to an exclusive (X) lock.</span></span> <span data-ttu-id="12fe9-541">Se duas transações adquirem bloqueios em modo compartilhado em um recurso e tentam atualizar os dados simultaneamente, uma das transações tenta uma conversão do bloqueio para um bloqueio exclusivo (X).</span><span class="sxs-lookup"><span data-stu-id="12fe9-541">If two transactions acquire shared-mode locks on a resource and then attempt to update data concurrently, one transaction attempts the lock conversion to an exclusive (X) lock.</span></span> <span data-ttu-id="12fe9-542">A conversão de bloqueio de modo compartilhado para exclusivo precisa esperar, porque o bloqueio exclusivo para uma transação não é compatível com o bloqueio em modo compartilhado da outra transação; ocorre uma espera por bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-542">The shared-mode-to-exclusive lock conversion must wait because the exclusive lock for one transaction is not compatible with the shared-mode lock of the other transaction; a lock wait occurs.</span></span> <span data-ttu-id="12fe9-543">A segunda transação tenta adquirir um bloqueio exclusivo (X) para sua atualização.</span><span class="sxs-lookup"><span data-stu-id="12fe9-543">The second transaction attempts to acquire an exclusive (X) lock for its update.</span></span> <span data-ttu-id="12fe9-544">Como ambas as transações estão convertendo para bloqueios exclusivos (X), e ambas estão esperando pela outra transação liberar seu bloqueio em modo compartilhado, ocorre um deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-544">Because both transactions are converting to exclusive (X) locks, and they are each waiting for the other transaction to release its shared-mode lock, a deadlock occurs.</span></span>  
  
 <span data-ttu-id="12fe9-545">Para evitar esse problema de potencial deadlock, são usados bloqueios de atualização (U).</span><span class="sxs-lookup"><span data-stu-id="12fe9-545">To avoid this potential deadlock problem, update (U) locks are used.</span></span> <span data-ttu-id="12fe9-546">Só uma transação, de cada vez, pode obter um bloqueio de atualização (U) para um recurso.</span><span class="sxs-lookup"><span data-stu-id="12fe9-546">Only one transaction can obtain an update (U) lock to a resource at a time.</span></span> <span data-ttu-id="12fe9-547">Se uma transação modificar um recurso, o bloqueio de atualização (U) será convertido para um bloqueio exclusivo (X).</span><span class="sxs-lookup"><span data-stu-id="12fe9-547">If a transaction modifies a resource, the update (U) lock is converted to an exclusive (X) lock.</span></span>  
  
#### <a name="exclusive-locks"></a><span data-ttu-id="12fe9-548">Bloqueios exclusivos</span><span class="sxs-lookup"><span data-stu-id="12fe9-548">Exclusive Locks</span></span>  

 <span data-ttu-id="12fe9-549">Bloqueios exclusivos (X) evitam o acesso a um recurso através de transações simultâneas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-549">Exclusive (X) locks prevent access to a resource by concurrent transactions.</span></span> <span data-ttu-id="12fe9-550">Com um bloqueio exclusivo (X), nenhuma outra transação pode modificar os dados; operações de leitura podem ser realizadas apenas com o uso da dica NOLOCK ou nível de isolamento de leitura não confirmada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-550">With an exclusive (X) lock, no other transactions can modify data; read operations can take place only with the use of the NOLOCK hint or read uncommitted isolation level.</span></span>  
  
 <span data-ttu-id="12fe9-551">Instruções de modificação de dados como INSERT, UPDATE e DELETE combinam operações de modificação e de leitura.</span><span class="sxs-lookup"><span data-stu-id="12fe9-551">Data modification statements, such as INSERT, UPDATE, and DELETE combine both modification and read operations.</span></span> <span data-ttu-id="12fe9-552">A instrução primeiro executa as operações de leitura para adquirir dados, antes de executar as operações de modificação necessárias.</span><span class="sxs-lookup"><span data-stu-id="12fe9-552">The statement first performs read operations to acquire data before performing the required modification operations.</span></span> <span data-ttu-id="12fe9-553">Assim, as instruções de modificação de dados normalmente solicitam bloqueios compartilhados e bloqueios exclusivos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-553">Data modification statements, therefore, typically request both shared locks and exclusive locks.</span></span> <span data-ttu-id="12fe9-554">Por exemplo, uma instrução UPDATE poderia modificar linhas em uma tabela com base em uma junção com outra tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-554">For example, an UPDATE statement might modify rows in one table based on a join with another table.</span></span> <span data-ttu-id="12fe9-555">Nesse caso, a instrução UPDATE solicita bloqueios compartilhados nas linhas lidas na junção de tabela, além de solicitar bloqueios exclusivos nas linhas atualizadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-555">In this case, the UPDATE statement requests shared locks on the rows read in the join table in addition to requesting exclusive locks on the updated rows.</span></span>  
  
#### <a name="intent-locks"></a><span data-ttu-id="12fe9-556">Bloqueios intencionais</span><span class="sxs-lookup"><span data-stu-id="12fe9-556">Intent Locks</span></span>  

 <span data-ttu-id="12fe9-557">O [!INCLUDE[ssDE](../includes/ssde-md.md)] usa bloqueios intencionais para proteger a colocação de um bloqueio compartilhado (S) ou bloqueio exclusivo (X) em um recurso inferior na hierarquia de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-557">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses intent locks to protect placing a shared (S) lock or exclusive (X) lock on a resource lower in the lock hierarchy.</span></span> <span data-ttu-id="12fe9-558">Bloqueios intencionais são assim chamados porque eles são adquiridos antes de um bloqueio em um nível inferior, e dessa forma, sinalizam a intenção de colocar bloqueios em um nível inferior.</span><span class="sxs-lookup"><span data-stu-id="12fe9-558">Intent locks are named intent locks because they are acquired before a lock at the lower level, and therefore signal intent to place locks at a lower level.</span></span>  
  
 <span data-ttu-id="12fe9-559">Os bloqueios intencionais têm duas finalidades:</span><span class="sxs-lookup"><span data-stu-id="12fe9-559">Intent locks serve two purposes:</span></span>  
  
-   <span data-ttu-id="12fe9-560">Para evitar que outras transações modifiquem recursos de alto nível de uma forma que inviabilizaria o bloqueio em um nível inferior.</span><span class="sxs-lookup"><span data-stu-id="12fe9-560">To prevent other transactions from modifying the higher-level resource in a way that would invalidate the lock at the lower level.</span></span>  
  
-   <span data-ttu-id="12fe9-561">Para melhorar a eficiência do [!INCLUDE[ssDE](../includes/ssde-md.md)], detectando conflitos de bloqueio em um nível mais alto de granularidade.</span><span class="sxs-lookup"><span data-stu-id="12fe9-561">To improve the efficiency of the [!INCLUDE[ssDE](../includes/ssde-md.md)] in detecting lock conflicts at the higher level of granularity.</span></span>  
  
 <span data-ttu-id="12fe9-562">Por exemplo, um bloqueio intencional compartilhado é solicitado no nível de tabela antes que os bloqueios compartilhados (S) sejam solicitados em páginas ou linhas dentro dessa tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-562">For example, a shared intent lock is requested at the table level before shared (S) locks are requested on pages or rows within that table.</span></span> <span data-ttu-id="12fe9-563">Configurar um bloqueio intencional no nível de tabela evita que outra transação subsequentemente adquira um bloqueio exclusivo (X) em uma tabela contendo essa página.</span><span class="sxs-lookup"><span data-stu-id="12fe9-563">Setting an intent lock at the table level prevents another transaction from subsequently acquiring an exclusive (X) lock on the table containing that page.</span></span> <span data-ttu-id="12fe9-564">Bloqueios intencionais aumentam o desempenho porque o [!INCLUDE[ssDE](../includes/ssde-md.md)] examina os bloqueios intencionais somente no nível de tabela para determinar se a transação pode adquirir um bloqueio de forma segura nessa tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-564">Intent locks improve performance because the [!INCLUDE[ssDE](../includes/ssde-md.md)] examines intent locks only at the table level to determine if a transaction can safely acquire a lock on that table.</span></span> <span data-ttu-id="12fe9-565">Isso remove a necessidade de examinar cada bloqueio de linha ou página na tabela para determinar se a transação pode bloquear a tabela inteira.</span><span class="sxs-lookup"><span data-stu-id="12fe9-565">This removes the requirement to examine every row or page lock on the table to determine if a transaction can lock the entire table.</span></span>  
  
 <span data-ttu-id="12fe9-566">Os bloqueios intencionais incluem intencional compartilhado (IS), intencional exclusivo (IX) e compartilhado com intenção exclusiva (SIX).</span><span class="sxs-lookup"><span data-stu-id="12fe9-566">Intent locks include intent shared (IS), intent exclusive (IX), and shared with intent exclusive (SIX).</span></span>  
  
|<span data-ttu-id="12fe9-567">Modo de bloqueio</span><span class="sxs-lookup"><span data-stu-id="12fe9-567">Lock mode</span></span>|<span data-ttu-id="12fe9-568">Descrição</span><span class="sxs-lookup"><span data-stu-id="12fe9-568">Description</span></span>|  
|---------------|-----------------|  
|<span data-ttu-id="12fe9-569">Intencional compartilhado (IS)</span><span class="sxs-lookup"><span data-stu-id="12fe9-569">Intent shared (IS)</span></span>|<span data-ttu-id="12fe9-570">Protege bloqueios solicitados ou bloqueios compartilhados adquiridos em alguns (mas não todos) recursos mais baixos na hierarquia.</span><span class="sxs-lookup"><span data-stu-id="12fe9-570">Protects requested or acquired shared locks on some (but not all) resources lower in the hierarchy.</span></span>|  
|<span data-ttu-id="12fe9-571">Intencional exclusivo (IX)</span><span class="sxs-lookup"><span data-stu-id="12fe9-571">Intent exclusive (IX)</span></span>|<span data-ttu-id="12fe9-572">Protege os bloqueios solicitados ou bloqueios exclusivos adquiridos em alguns (mas não todos) recursos mais baixos na hierarquia.</span><span class="sxs-lookup"><span data-stu-id="12fe9-572">Protects requested or acquired exclusive locks on some (but not all) resources lower in the hierarchy.</span></span> <span data-ttu-id="12fe9-573">IX é um superconjunto de IS, e também protege solicitando bloqueios compartilhados em recursos de nível mais baixo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-573">IX is a superset of IS, and it also protects requesting shared locks on lower level resources.</span></span>|  
|<span data-ttu-id="12fe9-574">Compartilhado com intenção exclusiva (SIX)</span><span class="sxs-lookup"><span data-stu-id="12fe9-574">Shared with intent exclusive (SIX)</span></span>|<span data-ttu-id="12fe9-575">Protege bloqueios compartilhados solicitados ou adquiridos em todos os recursos inferiores na hierarquia e bloqueios intencionais exclusivos em alguns (mas não todos) recursos de nível mais baixo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-575">Protects requested or acquired shared locks on all resources lower in the hierarchy and intent exclusive locks on some (but not all) of the lower level resources.</span></span> <span data-ttu-id="12fe9-576">São permitido bloqueios IS simultâneos no recurso de nível mais alto.</span><span class="sxs-lookup"><span data-stu-id="12fe9-576">Concurrent IS locks at the top-level resource are allowed.</span></span> <span data-ttu-id="12fe9-577">Por exemplo, adquirir um bloqueio SIX, em uma tabela, também adquire bloqueios intencionais exclusivos nas páginas que estão sendo modificadas e bloqueios exclusivos nas linhas modificadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-577">For example, acquiring a SIX lock on a table also acquires intent exclusive locks on the pages being modified and exclusive locks on the modified rows.</span></span> <span data-ttu-id="12fe9-578">Só pode haver um bloqueio SIX por recurso de cada vez, evitando atualizações feitas no recurso por outras transações, embora outras transações possam ler recursos, em uma hierarquia mais baixa, obtendo bloqueios IS no nível de tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-578">There can be only one SIX lock per resource at one time, preventing updates to the resource made by other transactions, although other transactions can read resources lower in the hierarchy by obtaining IS locks at the table level.</span></span>|  
|<span data-ttu-id="12fe9-579">Atualização intencional (IU).</span><span class="sxs-lookup"><span data-stu-id="12fe9-579">Intent update (IU)</span></span>|<span data-ttu-id="12fe9-580">Protege os bloqueios de atualização solicitados ou adquiridos, em todos os recursos dos níveis mais baixos da hierarquia.</span><span class="sxs-lookup"><span data-stu-id="12fe9-580">Protects requested or acquired update locks on all resources lower in the hierarchy.</span></span> <span data-ttu-id="12fe9-581">Bloqueios de IU só são usados em recursos de página.</span><span class="sxs-lookup"><span data-stu-id="12fe9-581">IU locks are used only on page resources.</span></span> <span data-ttu-id="12fe9-582">Bloqueios IU são convertidos a bloqueios IX se houver uma operação de atualização.</span><span class="sxs-lookup"><span data-stu-id="12fe9-582">IU locks are converted to IX locks if an update operation takes place.</span></span>|  
|<span data-ttu-id="12fe9-583">Atualização intencional compartilhado (SIU)</span><span class="sxs-lookup"><span data-stu-id="12fe9-583">Shared intent update (SIU)</span></span>|<span data-ttu-id="12fe9-584">Uma combinação de bloqueios S e IU, como resultado de aquisição desses bloqueios, separadamente e simultaneamente, mantendo ambos os bloqueios.</span><span class="sxs-lookup"><span data-stu-id="12fe9-584">A combination of S and IU locks, as a result of acquiring these locks separately and simultaneously holding both locks.</span></span> <span data-ttu-id="12fe9-585">Por exemplo, uma transação executa uma consulta com a dica PAGLOCK e, então, executa uma operação de atualização.</span><span class="sxs-lookup"><span data-stu-id="12fe9-585">For example, a transaction executes a query with the PAGLOCK hint and then executes an update operation.</span></span> <span data-ttu-id="12fe9-586">A consulta com a dica PAGLOCK adquire o bloqueio de S e a operação de atualização adquire o bloqueio IU.</span><span class="sxs-lookup"><span data-stu-id="12fe9-586">The query with the PAGLOCK hint acquires the S lock, and the update operation acquires the IU lock.</span></span>|  
|<span data-ttu-id="12fe9-587">Atualização intencional exclusiva (UIX)</span><span class="sxs-lookup"><span data-stu-id="12fe9-587">Update intent exclusive (UIX)</span></span>|<span data-ttu-id="12fe9-588">Uma combinação de bloqueios U e IX, como resultado de aquisição desses bloqueios, separadamente e simultaneamente, mantendo ambos os bloqueios.</span><span class="sxs-lookup"><span data-stu-id="12fe9-588">A combination of U and IX locks, as a result of acquiring these locks separately and simultaneously holding both locks.</span></span>|  
  
#### <a name="schema-locks"></a><span data-ttu-id="12fe9-589">Bloqueios de esquema</span><span class="sxs-lookup"><span data-stu-id="12fe9-589">Schema Locks</span></span>  

 <span data-ttu-id="12fe9-590">O [!INCLUDE[ssDE](../includes/ssde-md.md)] usa esquema de bloqueios de modificação (Sch-M) durante a operação de definição de linguagem dos dados da tabela (DDL), tal como adicionar uma coluna ou cancelar uma tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-590">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses schema modification (Sch-M) locks during a table data definition language (DDL) operation, such as adding a column or dropping a table.</span></span> <span data-ttu-id="12fe9-591">Durante o tempo em ele é mantido, o bloqueio Sch-M evita o acesso simultâneo à tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-591">During the time that it is held, the Sch-M lock prevents concurrent access to the table.</span></span> <span data-ttu-id="12fe9-592">Isso significa que o bloqueio Sch-M bloqueia todos as operações externas até que o bloqueio seja liberado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-592">This means the Sch-M lock blocks all outside operations until the lock is released.</span></span>  
  
 <span data-ttu-id="12fe9-593">Algumas operações DML (Data Manipulation Language), tais como truncamento da tabela, usam o bloqueio Sch-M para impedir o acesso à tabelas afetadas por operações simultâneas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-593">Some data manipulation language (DML) operations, such as table truncation, use Sch-M locks to prevent access to affected tables by concurrent operations.</span></span>  
  
 <span data-ttu-id="12fe9-594">O [!INCLUDE[ssDE](../includes/ssde-md.md)] usa bloqueios de estabilidade de esquema (Sch-S) quando compila e executa consultas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-594">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses schema stability (Sch-S) locks when compiling and executing queries.</span></span> <span data-ttu-id="12fe9-595">Os bloqueios de Sch-S não bloqueiam quaisquer bloqueios transacionais, inclusive bloqueios exclusivos (X).</span><span class="sxs-lookup"><span data-stu-id="12fe9-595">Sch-S locks do not block any transactional locks, including exclusive (X) locks.</span></span> <span data-ttu-id="12fe9-596">Assim sendo, outras transações, incluindo aquelas com bloqueios X em uma tabela, continuam executando enquanto a consulta é compilada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-596">Therefore, other transactions, including those with X locks on a table, continue to run while a query is being compiled.</span></span> <span data-ttu-id="12fe9-597">Porém, operações simultâneas DDL e operações simultâneas DML que adquirem bloqueios Sch-M, não podem ser executadas na tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-597">However, concurrent DDL operations, and concurrent DML operations that acquire Sch-M locks, cannot be performed on the table.</span></span>  
  
#### <a name="bulk-update-locks"></a><span data-ttu-id="12fe9-598">Bloqueios de atualização em massa</span><span class="sxs-lookup"><span data-stu-id="12fe9-598">Bulk Update Locks</span></span>  

 <span data-ttu-id="12fe9-599">Os bloqueios de atualização em massa (BU) permitem a vários threads carregarem simultaneamente dados em massa para a mesma tabela, evitando que outros processos, que não são carregamentos de dados em massa acessem a tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-599">Bulk update (BU) locks allow multiple threads to bulk load data concurrently into the same table while preventing other processes that are not bulk loading data from accessing the table.</span></span> <span data-ttu-id="12fe9-600">O [!INCLUDE[ssDE](../includes/ssde-md.md)] usa bloqueios de atualização em massa (BU) quando as condições a seguir forem verdadeiras.</span><span class="sxs-lookup"><span data-stu-id="12fe9-600">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses bulk update (BU) locks when both of the following conditions are true.</span></span>  
  
-   <span data-ttu-id="12fe9-601">Você usa a instrução Transact-SQL BULK INSERT, ou a função OPENROWSET(BULK), ou um dos comandos de API de inserção em massa, como .NET SqlBulkCopy, OLEDB Fast Load APIs, ou as APIs de cópia em massa do ODBC para copiar dados em massa para uma tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-601">You use the Transact-SQL BULK INSERT statement, or the OPENROWSET(BULK) function, or you use one of the Bulk Insert API commands such as .NET SqlBulkCopy, OLEDB Fast Load APIs, or the ODBC Bulk Copy APIs to bulk copy data into a table.</span></span>  
  
-   <span data-ttu-id="12fe9-602">A dica **TABLOCK** é especificada ou a opção de tabela **bloqueio da tabela em carregamento em massa** é configurada usando **sp_tableoption**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-602">The **TABLOCK** hint is specified or the **table lock on bulk load** table option is set using **sp_tableoption**.</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="12fe9-603">Diferentemente da instrução BULK INSERT, que contém um bloqueio de atualização em massa menos restritivo, INSERT INTO...SELECT com a dica TABLOCK contém um bloqueio exclusivo (X) na tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-603">Unlike the BULK INSERT statement, which holds a less restrictive Bulk Update lock, INSERT INTO...SELECT with the TABLOCK hint holds an exclusive (X) lock on the table.</span></span> <span data-ttu-id="12fe9-604">Isso significa que você não pode inserir linhas usando operações de inserção paralelas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-604">This means that you cannot insert rows using parallel insert operations.</span></span>  
  
#### <a name="key-range-locks"></a><span data-ttu-id="12fe9-605">Bloqueios de intervalo de chave</span><span class="sxs-lookup"><span data-stu-id="12fe9-605">Key-Range Locks</span></span>  

 <span data-ttu-id="12fe9-606">Os bloqueios de intervalos com chave protegem um intervalo de linhas implicitamente incluídas em um conjunto de registros sendo lido por uma instrução [!INCLUDE[tsql](../includes/tsql-md.md)], ao mesmo tempo em que utiliza o nível de isolamento de transação serializável.</span><span class="sxs-lookup"><span data-stu-id="12fe9-606">Key-range locks protect a range of rows implicitly included in a record set being read by a [!INCLUDE[tsql](../includes/tsql-md.md)] statement while using the serializable transaction isolation level.</span></span> <span data-ttu-id="12fe9-607">O bloqueio de intervalo de chave impede leituras fantasmas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-607">Key-range locking prevents phantom reads.</span></span> <span data-ttu-id="12fe9-608">Ao proteger os intervalos de chaves entre as linhas, ele também evita inserções fantasmas ou exclusões em um conjunto de registros acessado por uma transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-608">By protecting the ranges of keys between rows, it also prevents phantom insertions or deletions into a record set accessed by a transaction.</span></span>  
  
### <a name="lock-compatibility"></a><span data-ttu-id="12fe9-609">Compatibilidade de bloqueios</span><span class="sxs-lookup"><span data-stu-id="12fe9-609">Lock Compatibility</span></span>  

 <span data-ttu-id="12fe9-610">A compatibilidade de bloqueios controla se várias transações adquirem bloqueios, no mesmo recurso ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-610">Lock compatibility controls whether multiple transactions can acquire locks on the same resource at the same time.</span></span> <span data-ttu-id="12fe9-611">Se um recurso já estiver bloqueado por outra transação, um novo pedido de bloqueio apenas pode ser feito se o modo do bloqueio solicitado for compatível com o modo do bloqueio existente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-611">If a resource is already locked by another transaction, a new lock request can be granted only if the mode of the requested lock is compatible with the mode of the existing lock.</span></span> <span data-ttu-id="12fe9-612">Se o modo de pedido de bloqueio não for compatível com o bloqueio existente, a transação que solicita um novo bloqueio espera a liberação do bloqueio existente ou que o intervalo de tempo limite se esgote.</span><span class="sxs-lookup"><span data-stu-id="12fe9-612">If the mode of the requested lock is not compatible with the existing lock, the transaction requesting the new lock waits for the existing lock to be released or for the lock timeout interval to expire.</span></span> <span data-ttu-id="12fe9-613">Por exemplo, nenhum modo de bloqueio é compatível com bloqueios exclusivos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-613">For example, no lock modes are compatible with exclusive locks.</span></span> <span data-ttu-id="12fe9-614">Enquanto um bloqueio exclusivo (X) for mantido, nenhuma outra transação pode adquirir um bloqueio de nenhum tipo (compartilhado, atualizado ou exclusivo) naquele recurso até que o bloqueio exclusivo (X) seja liberado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-614">While an exclusive (X) lock is held, no other transaction can acquire a lock of any kind (shared, update, or exclusive) on that resource until the exclusive (X) lock is released.</span></span> <span data-ttu-id="12fe9-615">Opcionalmente, se um bloqueio compartilhado (S) tiver sido aplicado a um recurso, outras transações podem também irão adquirir um bloqueio compartilhado (U) nesse item, mesmo que a primeira transação não esteja concluída.</span><span class="sxs-lookup"><span data-stu-id="12fe9-615">Alternatively, if a shared (S) lock has been applied to a resource, other transactions can also acquire a shared lock or an update (U) lock on that item even if the first transaction has not completed.</span></span> <span data-ttu-id="12fe9-616">No entanto, outras transações não podem adquirir um bloqueio exclusivo até que o bloqueio compartilhado tenha sido liberado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-616">However, other transactions cannot acquire an exclusive lock until the shared lock has been released.</span></span>  
  
 <span data-ttu-id="12fe9-617">A tabela a seguir mostra a compatibilidade dos modos de bloqueio mais comumente encontrados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-617">The following table shows the compatibility of the most commonly encountered lock modes.</span></span>  
  
||<span data-ttu-id="12fe9-618">Modo concedido existente</span><span class="sxs-lookup"><span data-stu-id="12fe9-618">Existing granted mode</span></span>||||||  
|------|---------------------------|------|------|------|------|------|  
|<span data-ttu-id="12fe9-619">**Modo solicitado**</span><span class="sxs-lookup"><span data-stu-id="12fe9-619">**Requested mode**</span></span>|<span data-ttu-id="12fe9-620">**IS**</span><span class="sxs-lookup"><span data-stu-id="12fe9-620">**IS**</span></span>|<span data-ttu-id="12fe9-621">**S**</span><span class="sxs-lookup"><span data-stu-id="12fe9-621">**S**</span></span>|<span data-ttu-id="12fe9-622">**U**</span><span class="sxs-lookup"><span data-stu-id="12fe9-622">**U**</span></span>|<span data-ttu-id="12fe9-623">**IX**</span><span class="sxs-lookup"><span data-stu-id="12fe9-623">**IX**</span></span>|<span data-ttu-id="12fe9-624">**SIX**</span><span class="sxs-lookup"><span data-stu-id="12fe9-624">**SIX**</span></span>|<span data-ttu-id="12fe9-625">**X**</span><span class="sxs-lookup"><span data-stu-id="12fe9-625">**X**</span></span>|  
|<span data-ttu-id="12fe9-626">**Tentativa compartilhada (IS)**</span><span class="sxs-lookup"><span data-stu-id="12fe9-626">**Intent shared (IS)**</span></span>|<span data-ttu-id="12fe9-627">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-627">Yes</span></span>|<span data-ttu-id="12fe9-628">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-628">Yes</span></span>|<span data-ttu-id="12fe9-629">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-629">Yes</span></span>|<span data-ttu-id="12fe9-630">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-630">Yes</span></span>|<span data-ttu-id="12fe9-631">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-631">Yes</span></span>|<span data-ttu-id="12fe9-632">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-632">No</span></span>|  
|<span data-ttu-id="12fe9-633">**Compartilhado (S)**</span><span class="sxs-lookup"><span data-stu-id="12fe9-633">**Shared (S)**</span></span>|<span data-ttu-id="12fe9-634">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-634">Yes</span></span>|<span data-ttu-id="12fe9-635">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-635">Yes</span></span>|<span data-ttu-id="12fe9-636">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-636">Yes</span></span>|<span data-ttu-id="12fe9-637">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-637">No</span></span>|<span data-ttu-id="12fe9-638">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-638">No</span></span>|<span data-ttu-id="12fe9-639">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-639">No</span></span>|  
|<span data-ttu-id="12fe9-640">**Atualização (U)**</span><span class="sxs-lookup"><span data-stu-id="12fe9-640">**Update (U)**</span></span>|<span data-ttu-id="12fe9-641">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-641">Yes</span></span>|<span data-ttu-id="12fe9-642">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-642">Yes</span></span>|<span data-ttu-id="12fe9-643">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-643">No</span></span>|<span data-ttu-id="12fe9-644">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-644">No</span></span>|<span data-ttu-id="12fe9-645">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-645">No</span></span>|<span data-ttu-id="12fe9-646">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-646">No</span></span>|  
|<span data-ttu-id="12fe9-647">**IX (intensão exclusiva)**</span><span class="sxs-lookup"><span data-stu-id="12fe9-647">**Intent exclusive (IX)**</span></span>|<span data-ttu-id="12fe9-648">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-648">Yes</span></span>|<span data-ttu-id="12fe9-649">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-649">No</span></span>|<span data-ttu-id="12fe9-650">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-650">No</span></span>|<span data-ttu-id="12fe9-651">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-651">Yes</span></span>|<span data-ttu-id="12fe9-652">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-652">No</span></span>|<span data-ttu-id="12fe9-653">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-653">No</span></span>|  
|<span data-ttu-id="12fe9-654">**SIX (compartilhado com intenção exclusiva)**</span><span class="sxs-lookup"><span data-stu-id="12fe9-654">**Shared with intent exclusive (SIX)**</span></span>|<span data-ttu-id="12fe9-655">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-655">Yes</span></span>|<span data-ttu-id="12fe9-656">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-656">No</span></span>|<span data-ttu-id="12fe9-657">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-657">No</span></span>|<span data-ttu-id="12fe9-658">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-658">No</span></span>|<span data-ttu-id="12fe9-659">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-659">No</span></span>|<span data-ttu-id="12fe9-660">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-660">No</span></span>|  
|<span data-ttu-id="12fe9-661">**Exclusivo (X)**</span><span class="sxs-lookup"><span data-stu-id="12fe9-661">**Exclusive (X)**</span></span>|<span data-ttu-id="12fe9-662">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-662">No</span></span>|<span data-ttu-id="12fe9-663">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-663">No</span></span>|<span data-ttu-id="12fe9-664">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-664">No</span></span>|<span data-ttu-id="12fe9-665">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-665">No</span></span>|<span data-ttu-id="12fe9-666">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-666">No</span></span>|<span data-ttu-id="12fe9-667">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-667">No</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-668">Um bloqueio intencional exclusivo (IX) é compatível com um modo de bloqueio IX porque IX significa que a intenção é atualizar somente algumas linhas em vez de todas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-668">An intent exclusive (IX) lock is compatible with an IX lock mode because IX means the intention is to update only some of the rows rather than all of them.</span></span> <span data-ttu-id="12fe9-669">Outras transações que tentarem ler ou atualizar algumas das linhas também são permitidas, exceto se não forem as mesmas linhas que estejam sendo atualizadas por outras transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-669">Other transactions that attempt to read or update some of the rows are also permitted as long as they are not the same rows being updated by other transactions.</span></span> <span data-ttu-id="12fe9-670">Além disso, se duas transações tentarem atualizar a mesma linha, ambas receberão um bloqueio IX no nível de tabela e página.</span><span class="sxs-lookup"><span data-stu-id="12fe9-670">Further, if two transactions attempt to update the same row, both transactions will be granted an IX lock at table and page level.</span></span> <span data-ttu-id="12fe9-671">No entanto, uma transação receberá um bloqueio X no nível de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-671">However, one transaction will be granted an X lock at row level.</span></span> <span data-ttu-id="12fe9-672">A outra transação deve aguardar até que o bloqueio de nível de linha seja removido.</span><span class="sxs-lookup"><span data-stu-id="12fe9-672">The other transaction must wait until the row-level lock is removed.</span></span>  
  
 <span data-ttu-id="12fe9-673">Use a tabela a seguir para determinar a compatibilidade de todos os modos de bloqueio disponíveis no [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-673">Use the following table to determine the compatibility of all the lock modes available in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span>  
  
 <span data-ttu-id="12fe9-674">![Diagrama que mostra a matriz de compatibilidade de bloqueio](media/lockconflicttable.gif "Diagrama que mostra a matriz de compatibilidade de bloqueio")</span><span class="sxs-lookup"><span data-stu-id="12fe9-674">![Diagram showing lock compatibility matrix](media/lockconflicttable.gif "Diagram showing lock compatibility matrix")</span></span>  
  
### <a name="key-range-locking"></a><span data-ttu-id="12fe9-675">Bloqueio de intervalo de chave</span><span class="sxs-lookup"><span data-stu-id="12fe9-675">Key-Range Locking</span></span>  

 <span data-ttu-id="12fe9-676">Os bloqueios de intervalos com chave protegem um intervalo de linhas implicitamente incluídas em um conjunto de registros sendo lido por uma instrução [!INCLUDE[tsql](../includes/tsql-md.md)], ao mesmo tempo em que utiliza o nível de isolamento de transação serializável.</span><span class="sxs-lookup"><span data-stu-id="12fe9-676">Key-range locks protect a range of rows implicitly included in a record set being read by a [!INCLUDE[tsql](../includes/tsql-md.md)] statement while using the serializable transaction isolation level.</span></span> <span data-ttu-id="12fe9-677">O nível de isolamento serializável requer que qualquer consulta executada durante uma transação deva obter o mesmo conjunto de linhas, toda vez que seja executada durante a transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-677">The serializable isolation level requires that any query executed during a transaction must obtain the same set of rows every time it is executed during the transaction.</span></span> <span data-ttu-id="12fe9-678">Um bloqueio de intervalo de chave protege esse requisito, impedindo que outras transações insiram novas linhas cujas chaves falhariam no intervalo de chaves lido pela transação serializável.</span><span class="sxs-lookup"><span data-stu-id="12fe9-678">A key range lock protects this requirement by preventing other transactions from inserting new rows whose keys would fall in the range of keys read by the serializable transaction.</span></span>  
  
 <span data-ttu-id="12fe9-679">O bloqueio de intervalo de chave impede leituras fantasmas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-679">Key-range locking prevents phantom reads.</span></span> <span data-ttu-id="12fe9-680">Ao proteger os intervalos de chaves entre as linhas, ele também evita inserções fantasmas em um conjunto de registros acessado por uma transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-680">By protecting the ranges of keys between rows, it also prevents phantom insertions into a set of records accessed by a transaction.</span></span>  
  
 <span data-ttu-id="12fe9-681">Um bloqueio de intervalo de chave é colocado em um índice, especificando um valor de chave inicial e final.</span><span class="sxs-lookup"><span data-stu-id="12fe9-681">A key-range lock is placed on an index, specifying a beginning and ending key value.</span></span> <span data-ttu-id="12fe9-682">Esse bloqueio impede quaisquer tentativas de inserção, atualização ou exclusão de qualquer linha de um valor de chave que falhe no intervalo, pois essas operações primeiro teriam que obter um bloqueio no índice.</span><span class="sxs-lookup"><span data-stu-id="12fe9-682">This lock blocks any attempt to insert, update, or delete any row with a key value that falls in the range because those operations would first have to acquire a lock on the index.</span></span> <span data-ttu-id="12fe9-683">Por exemplo, uma transação serializável pode emitir uma instrução SELECT que leia todas as linhas cujos valores das chaves estejam entre **'** AAA **'** e **'** CZZ **'**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-683">For example, a serializable transaction could issue a SELECT statement that reads all rows whose key values are between **'** AAA **'** and **'** CZZ **'**.</span></span> <span data-ttu-id="12fe9-684">Um bloqueio no intervalo de chave sobre o valor da chave de **'** AAA **'** até **'** CZZ **'** evita que outras transações insiram linhas com valores de chave em qualquer posição daquele intervalo, tais como **'** ADG **'** , **'** BBD **'** , ou **'** CAL **'** .</span><span class="sxs-lookup"><span data-stu-id="12fe9-684">A key-range lock on the key values in the range from **'** AAA **'** to **'** CZZ **'** prevents other transactions from inserting rows with key values anywhere in that range, such as **'** ADG **'**, **'** BBD **'**, or **'** CAL **'**.</span></span>  
  
#### <a name="key-range-lock-modes"></a><span data-ttu-id="12fe9-685">Modos de bloqueio de intervalo de chave</span><span class="sxs-lookup"><span data-stu-id="12fe9-685">Key-Range Lock Modes</span></span>  

 <span data-ttu-id="12fe9-686">O bloqueio de intervalo de chave inclui um intervalo e um componente de linha especificados no formato intervalo-linha:</span><span class="sxs-lookup"><span data-stu-id="12fe9-686">Key-range locks include both a range and a row component specified in range-row format:</span></span>  
  
-   <span data-ttu-id="12fe9-687">O intervalo representa o modo de bloqueio que protege o intervalo entre duas entradas consecutivas de índice.</span><span class="sxs-lookup"><span data-stu-id="12fe9-687">Range represents the lock mode protecting the range between two consecutive index entries.</span></span>  
  
-   <span data-ttu-id="12fe9-688">A fila representa o modo de bloqueio que protege a entrada de índice.</span><span class="sxs-lookup"><span data-stu-id="12fe9-688">Row represents the lock mode protecting the index entry.</span></span>  
  
-   <span data-ttu-id="12fe9-689">O modo representa o modo de bloqueio combinado em uso.</span><span class="sxs-lookup"><span data-stu-id="12fe9-689">Mode represents the combined lock mode used.</span></span> <span data-ttu-id="12fe9-690">Os modos de bloqueio de intervalo de chave consistem de duas partes.</span><span class="sxs-lookup"><span data-stu-id="12fe9-690">Key-range lock modes consist of two parts.</span></span> <span data-ttu-id="12fe9-691">A primeira representa o tipo de bloqueio utilizado para bloquear o intervalo de índice (Range*T*), e a segunda representa o tipo de bloqueio utilizado para bloquear uma chave específica (*K*).</span><span class="sxs-lookup"><span data-stu-id="12fe9-691">The first represents the type of lock used to lock the index range (Range*T*) and the second represents the lock type used to lock a specific key (*K*).</span></span> <span data-ttu-id="12fe9-692">As duas partes são conectadas por um hífen (-), como Intervalo*T*-*K*.</span><span class="sxs-lookup"><span data-stu-id="12fe9-692">The two parts are connected with a hyphen (-), such as Range*T*-*K*.</span></span>  
  
    |<span data-ttu-id="12fe9-693">Intervalo</span><span class="sxs-lookup"><span data-stu-id="12fe9-693">Range</span></span>|<span data-ttu-id="12fe9-694">Linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-694">Row</span></span>|<span data-ttu-id="12fe9-695">Mode</span><span class="sxs-lookup"><span data-stu-id="12fe9-695">Mode</span></span>|<span data-ttu-id="12fe9-696">Descrição</span><span class="sxs-lookup"><span data-stu-id="12fe9-696">Description</span></span>|  
    |-----------|---------|----------|-----------------|  
    |<span data-ttu-id="12fe9-697">RangeS</span><span class="sxs-lookup"><span data-stu-id="12fe9-697">RangeS</span></span>|<span data-ttu-id="12fe9-698">S</span><span class="sxs-lookup"><span data-stu-id="12fe9-698">S</span></span>|<span data-ttu-id="12fe9-699">RangeS-S</span><span class="sxs-lookup"><span data-stu-id="12fe9-699">RangeS-S</span></span>|<span data-ttu-id="12fe9-700">Intervalo compartilhado, bloqueio de recurso compartilhado; exame de intervalo serializável.</span><span class="sxs-lookup"><span data-stu-id="12fe9-700">Shared range, shared resource lock; serializable range scan.</span></span>|  
    |<span data-ttu-id="12fe9-701">RangeS</span><span class="sxs-lookup"><span data-stu-id="12fe9-701">RangeS</span></span>|<span data-ttu-id="12fe9-702">U</span><span class="sxs-lookup"><span data-stu-id="12fe9-702">U</span></span>|<span data-ttu-id="12fe9-703">RangeS-U</span><span class="sxs-lookup"><span data-stu-id="12fe9-703">RangeS-U</span></span>|<span data-ttu-id="12fe9-704">Intervalo compartilhado, bloqueio de recurso compartilhado; exame de atualização serializável.</span><span class="sxs-lookup"><span data-stu-id="12fe9-704">Shared range, update resource lock; serializable update scan.</span></span>|  
    |<span data-ttu-id="12fe9-705">RangeI</span><span class="sxs-lookup"><span data-stu-id="12fe9-705">RangeI</span></span>|<span data-ttu-id="12fe9-706">Nulo</span><span class="sxs-lookup"><span data-stu-id="12fe9-706">Null</span></span>|<span data-ttu-id="12fe9-707">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="12fe9-707">RangeI-N</span></span>|<span data-ttu-id="12fe9-708">Insere o intervalo, anula o bloqueio de recurso; usado para testar intervalos antes de inserir uma nova chave em um índice.</span><span class="sxs-lookup"><span data-stu-id="12fe9-708">Insert range, null resource lock; used to test ranges before inserting a new key into an index.</span></span>|  
    |<span data-ttu-id="12fe9-709">RangeX</span><span class="sxs-lookup"><span data-stu-id="12fe9-709">RangeX</span></span>|<span data-ttu-id="12fe9-710">X</span><span class="sxs-lookup"><span data-stu-id="12fe9-710">X</span></span>|<span data-ttu-id="12fe9-711">RangeX-X</span><span class="sxs-lookup"><span data-stu-id="12fe9-711">RangeX-X</span></span>|<span data-ttu-id="12fe9-712">Intervalo exclusivo, bloqueio de recurso exclusivo; usado ao atualizar uma chave em um intervalo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-712">Exclusive range, exclusive resource lock; used when updating a key in a range.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-713">O modo de bloqueio interno Nulo é compatível com todos os outros modos de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-713">The internal Null lock mode is compatible with all other lock modes.</span></span>  
  
 <span data-ttu-id="12fe9-714">Os modos de bloqueio de intervalo de chave têm uma matriz de compatibilidade que mostra quais bloqueios são compatíveis com outros bloqueios obtidos em chaves e intervalos sobrepostos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-714">Key-range lock modes have a compatibility matrix that shows which locks are compatible with other locks obtained on overlapping keys and ranges.</span></span>  
  
||<span data-ttu-id="12fe9-715">Modo concedido existente</span><span class="sxs-lookup"><span data-stu-id="12fe9-715">Existing granted mode</span></span>|||||||  
|------|---------------------------|------|------|------|------|------|------|  
|<span data-ttu-id="12fe9-716">**Modo solicitado**</span><span class="sxs-lookup"><span data-stu-id="12fe9-716">**Requested mode**</span></span>|<span data-ttu-id="12fe9-717">**S**</span><span class="sxs-lookup"><span data-stu-id="12fe9-717">**S**</span></span>|<span data-ttu-id="12fe9-718">**U**</span><span class="sxs-lookup"><span data-stu-id="12fe9-718">**U**</span></span>|<span data-ttu-id="12fe9-719">**X**</span><span class="sxs-lookup"><span data-stu-id="12fe9-719">**X**</span></span>|<span data-ttu-id="12fe9-720">**RangeS-S**</span><span class="sxs-lookup"><span data-stu-id="12fe9-720">**RangeS-S**</span></span>|<span data-ttu-id="12fe9-721">**RangeS-U**</span><span class="sxs-lookup"><span data-stu-id="12fe9-721">**RangeS-U**</span></span>|<span data-ttu-id="12fe9-722">**RangeI-N**</span><span class="sxs-lookup"><span data-stu-id="12fe9-722">**RangeI-N**</span></span>|<span data-ttu-id="12fe9-723">**RangeX-X**</span><span class="sxs-lookup"><span data-stu-id="12fe9-723">**RangeX-X**</span></span>|  
|<span data-ttu-id="12fe9-724">**Compartilhado (S)**</span><span class="sxs-lookup"><span data-stu-id="12fe9-724">**Shared (S)**</span></span>|<span data-ttu-id="12fe9-725">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-725">Yes</span></span>|<span data-ttu-id="12fe9-726">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-726">Yes</span></span>|<span data-ttu-id="12fe9-727">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-727">No</span></span>|<span data-ttu-id="12fe9-728">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-728">Yes</span></span>|<span data-ttu-id="12fe9-729">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-729">Yes</span></span>|<span data-ttu-id="12fe9-730">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-730">Yes</span></span>|<span data-ttu-id="12fe9-731">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-731">No</span></span>|  
|<span data-ttu-id="12fe9-732">**Atualização (U)**</span><span class="sxs-lookup"><span data-stu-id="12fe9-732">**Update (U)**</span></span>|<span data-ttu-id="12fe9-733">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-733">Yes</span></span>|<span data-ttu-id="12fe9-734">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-734">No</span></span>|<span data-ttu-id="12fe9-735">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-735">No</span></span>|<span data-ttu-id="12fe9-736">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-736">Yes</span></span>|<span data-ttu-id="12fe9-737">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-737">No</span></span>|<span data-ttu-id="12fe9-738">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-738">Yes</span></span>|<span data-ttu-id="12fe9-739">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-739">No</span></span>|  
|<span data-ttu-id="12fe9-740">**Exclusivo (X)**</span><span class="sxs-lookup"><span data-stu-id="12fe9-740">**Exclusive (X)**</span></span>|<span data-ttu-id="12fe9-741">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-741">No</span></span>|<span data-ttu-id="12fe9-742">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-742">No</span></span>|<span data-ttu-id="12fe9-743">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-743">No</span></span>|<span data-ttu-id="12fe9-744">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-744">No</span></span>|<span data-ttu-id="12fe9-745">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-745">No</span></span>|<span data-ttu-id="12fe9-746">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-746">Yes</span></span>|<span data-ttu-id="12fe9-747">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-747">No</span></span>|  
|<span data-ttu-id="12fe9-748">**RangeS-S**</span><span class="sxs-lookup"><span data-stu-id="12fe9-748">**RangeS-S**</span></span>|<span data-ttu-id="12fe9-749">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-749">Yes</span></span>|<span data-ttu-id="12fe9-750">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-750">Yes</span></span>|<span data-ttu-id="12fe9-751">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-751">No</span></span>|<span data-ttu-id="12fe9-752">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-752">Yes</span></span>|<span data-ttu-id="12fe9-753">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-753">Yes</span></span>|<span data-ttu-id="12fe9-754">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-754">No</span></span>|<span data-ttu-id="12fe9-755">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-755">No</span></span>|  
|<span data-ttu-id="12fe9-756">**RangeS-U**</span><span class="sxs-lookup"><span data-stu-id="12fe9-756">**RangeS-U**</span></span>|<span data-ttu-id="12fe9-757">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-757">Yes</span></span>|<span data-ttu-id="12fe9-758">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-758">No</span></span>|<span data-ttu-id="12fe9-759">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-759">No</span></span>|<span data-ttu-id="12fe9-760">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-760">Yes</span></span>|<span data-ttu-id="12fe9-761">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-761">No</span></span>|<span data-ttu-id="12fe9-762">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-762">No</span></span>|<span data-ttu-id="12fe9-763">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-763">No</span></span>|  
|<span data-ttu-id="12fe9-764">**RangeI-N**</span><span class="sxs-lookup"><span data-stu-id="12fe9-764">**RangeI-N**</span></span>|<span data-ttu-id="12fe9-765">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-765">Yes</span></span>|<span data-ttu-id="12fe9-766">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-766">Yes</span></span>|<span data-ttu-id="12fe9-767">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-767">Yes</span></span>|<span data-ttu-id="12fe9-768">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-768">No</span></span>|<span data-ttu-id="12fe9-769">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-769">No</span></span>|<span data-ttu-id="12fe9-770">Sim</span><span class="sxs-lookup"><span data-stu-id="12fe9-770">Yes</span></span>|<span data-ttu-id="12fe9-771">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-771">No</span></span>|  
|<span data-ttu-id="12fe9-772">**RangeX-X**</span><span class="sxs-lookup"><span data-stu-id="12fe9-772">**RangeX-X**</span></span>|<span data-ttu-id="12fe9-773">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-773">No</span></span>|<span data-ttu-id="12fe9-774">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-774">No</span></span>|<span data-ttu-id="12fe9-775">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-775">No</span></span>|<span data-ttu-id="12fe9-776">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-776">No</span></span>|<span data-ttu-id="12fe9-777">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-777">No</span></span>|<span data-ttu-id="12fe9-778">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-778">No</span></span>|<span data-ttu-id="12fe9-779">Não</span><span class="sxs-lookup"><span data-stu-id="12fe9-779">No</span></span>|  
  
#### <a name="conversion-locks"></a><span data-ttu-id="12fe9-780">Bloqueios de Conversão</span><span class="sxs-lookup"><span data-stu-id="12fe9-780">Conversion Locks</span></span>  

 <span data-ttu-id="12fe9-781">Os bloqueios de conversão são criados quando um bloqueio de intervalo de chave se sobrepuser a outro bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-781">Conversion locks are created when a key-range lock overlaps another lock.</span></span>  
  
|<span data-ttu-id="12fe9-782">Bloqueio 1</span><span class="sxs-lookup"><span data-stu-id="12fe9-782">Lock 1</span></span>|<span data-ttu-id="12fe9-783">Bloqueio 2</span><span class="sxs-lookup"><span data-stu-id="12fe9-783">Lock 2</span></span>|<span data-ttu-id="12fe9-784">Bloqueio de Conversão</span><span class="sxs-lookup"><span data-stu-id="12fe9-784">Conversion lock</span></span>|  
|------------|------------|---------------------|  
|<span data-ttu-id="12fe9-785">S</span><span class="sxs-lookup"><span data-stu-id="12fe9-785">S</span></span>|<span data-ttu-id="12fe9-786">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="12fe9-786">RangeI-N</span></span>|<span data-ttu-id="12fe9-787">RangeI-S</span><span class="sxs-lookup"><span data-stu-id="12fe9-787">RangeI-S</span></span>|  
|<span data-ttu-id="12fe9-788">U</span><span class="sxs-lookup"><span data-stu-id="12fe9-788">U</span></span>|<span data-ttu-id="12fe9-789">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="12fe9-789">RangeI-N</span></span>|<span data-ttu-id="12fe9-790">RangeI-U</span><span class="sxs-lookup"><span data-stu-id="12fe9-790">RangeI-U</span></span>|  
|<span data-ttu-id="12fe9-791">X</span><span class="sxs-lookup"><span data-stu-id="12fe9-791">X</span></span>|<span data-ttu-id="12fe9-792">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="12fe9-792">RangeI-N</span></span>|<span data-ttu-id="12fe9-793">RangeI-X</span><span class="sxs-lookup"><span data-stu-id="12fe9-793">RangeI-X</span></span>|  
|<span data-ttu-id="12fe9-794">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="12fe9-794">RangeI-N</span></span>|<span data-ttu-id="12fe9-795">RangeS-S</span><span class="sxs-lookup"><span data-stu-id="12fe9-795">RangeS-S</span></span>|<span data-ttu-id="12fe9-796">RangeX-S</span><span class="sxs-lookup"><span data-stu-id="12fe9-796">RangeX-S</span></span>|  
|<span data-ttu-id="12fe9-797">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="12fe9-797">RangeI-N</span></span>|<span data-ttu-id="12fe9-798">RangeS-U</span><span class="sxs-lookup"><span data-stu-id="12fe9-798">RangeS-U</span></span>|<span data-ttu-id="12fe9-799">RangeX-U</span><span class="sxs-lookup"><span data-stu-id="12fe9-799">RangeX-U</span></span>|  
  
 <span data-ttu-id="12fe9-800">Os bloqueios de conversão podem ser observados por um curto período de tempo sob diferentes circunstâncias complexas, às vezes enquanto executando processos simultâneos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-800">Conversion locks can be observed for a short period of time under different complex circumstances, sometimes while running concurrent processes.</span></span>  
  
#### <a name="serializable-range-scan-singleton-fetch-delete-and-insert"></a><span data-ttu-id="12fe9-801">Varredura de Intervalo Serializável, Busca de Singleton, Exclusão e Inserção</span><span class="sxs-lookup"><span data-stu-id="12fe9-801">Serializable Range Scan, Singleton Fetch, Delete, and Insert</span></span>  

 <span data-ttu-id="12fe9-802">O bloqueio de intervalo de chave garante que as seguintes operações sejam serializáveis:</span><span class="sxs-lookup"><span data-stu-id="12fe9-802">Key-range locking ensures that the following operations are serializable:</span></span>  
  
-   <span data-ttu-id="12fe9-803">Consulta de varredura de intervalo</span><span class="sxs-lookup"><span data-stu-id="12fe9-803">Range scan query</span></span>  
  
-   <span data-ttu-id="12fe9-804">Busca de singleton em linha inexistente</span><span class="sxs-lookup"><span data-stu-id="12fe9-804">Singleton fetch of nonexistent row</span></span>  
  
-   <span data-ttu-id="12fe9-805">Operação de exclusão</span><span class="sxs-lookup"><span data-stu-id="12fe9-805">Delete operation</span></span>  
  
-   <span data-ttu-id="12fe9-806">Operação de Inserção</span><span class="sxs-lookup"><span data-stu-id="12fe9-806">Insert operation</span></span>  
  
 <span data-ttu-id="12fe9-807">Antes que o bloqueio de intervalo de chave possa ocorrer, as seguintes condições devem ser satisfeitas:</span><span class="sxs-lookup"><span data-stu-id="12fe9-807">Before key-range locking can occur, the following conditions must be satisfied:</span></span>  
  
-   <span data-ttu-id="12fe9-808">O nível de isolamento da transação deve ser definido como SERIALIZABLE.</span><span class="sxs-lookup"><span data-stu-id="12fe9-808">The transaction-isolation level must be set to SERIALIZABLE.</span></span>  
  
-   <span data-ttu-id="12fe9-809">O processador de consulta deve usar um índice para implementar o predicado de filtro do intervalo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-809">The query processor must use an index to implement the range filter predicate.</span></span> <span data-ttu-id="12fe9-810">Por exemplo, a cláusula WHERE em uma instrução SELECT poderia estabelecer uma condição de intervalo com esse predicado: ColumnX BETWEEN N **'** AAA **'** AND N **'** CZZ **'** .</span><span class="sxs-lookup"><span data-stu-id="12fe9-810">For example, the WHERE clause in a SELECT statement could establish a range condition with this predicate: ColumnX BETWEEN N **'** AAA **'** AND N **'** CZZ **'**.</span></span> <span data-ttu-id="12fe9-811">Um bloqueio de intervalo de chave só poderá ser adquirido se a **ColumnX** estiver coberta por uma chave de índice.</span><span class="sxs-lookup"><span data-stu-id="12fe9-811">A key-range lock can only be acquired if **ColumnX** is covered by an index key.</span></span>  
  
#### <a name="examples"></a><span data-ttu-id="12fe9-812">Exemplos</span><span class="sxs-lookup"><span data-stu-id="12fe9-812">Examples</span></span>  

 <span data-ttu-id="12fe9-813">A seguinte tabela e índice são usados como base para os exemplos de intervalo de chave que seguem.</span><span class="sxs-lookup"><span data-stu-id="12fe9-813">The following table and index are used as a basis for the key-range locking examples that follow.</span></span>  
  
 <span data-ttu-id="12fe9-814">![Tabela de banco de dados com ilustração de índice de árvore b](media/btree4.gif "Tabela de banco de dados com ilustração de índice de árvore b")</span><span class="sxs-lookup"><span data-stu-id="12fe9-814">![Database table with index b-tree illustration](media/btree4.gif "Database table with index b-tree illustration")</span></span>  
  
##### <a name="range-scan-query"></a><span data-ttu-id="12fe9-815">Consulta de Varredura de Intervalo</span><span class="sxs-lookup"><span data-stu-id="12fe9-815">Range Scan Query</span></span>  

 <span data-ttu-id="12fe9-816">Para garantir que uma consulta de varredura de intervalo seja serializável, a mesma consulta deve retornar os mesmos resultados a cada vez que seja executada dentro de uma mesma transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-816">To ensure a range scan query is serializable, the same query should return the same results each time it is executed within the same transaction.</span></span> <span data-ttu-id="12fe9-817">Novas linhas não devem ser inseridas dentro da consulta de varredura de intervalo por outras transações; caso contrário, elas se tornam inserções fantasmas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-817">New rows must not be inserted within the range scan query by other transactions; otherwise, these become phantom inserts.</span></span> <span data-ttu-id="12fe9-818">Por exemplo, a consulta seguinte usa a tabela e índice da ilustração anterior:</span><span class="sxs-lookup"><span data-stu-id="12fe9-818">For example, the following query uses the table and index in the previous illustration:</span></span>  
  
```sql  
SELECT name  
    FROM mytable  
    WHERE name BETWEEN 'A' AND 'C';  
```  
  
 <span data-ttu-id="12fe9-819">Os bloqueios de intervalo de chave são posicionados nas entradas do índice correspondentes ao intervalo das linhas de dados, onde o nome está entre os valores Adam e Dale, evitando que novas linhas que se qualifiquem na consulta anterior sejam acrescentadas ou exclusas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-819">Key-range locks are placed on the index entries corresponding to the range of data rows where the name is between the values Adam and Dale, preventing new rows qualifying in the previous query from being added or deleted.</span></span> <span data-ttu-id="12fe9-820">Embora o primeiro nome desse intervalo seja Adam, o bloqueio de intervalo de chave RangeS-S dessa entrada de índice garante que nenhum nome novo começando com a letra A possa ser adicionado antes de Adam, como por exemplo Abigail.</span><span class="sxs-lookup"><span data-stu-id="12fe9-820">Although the first name in this range is Adam, the RangeS-S mode key-range lock on this index entry ensures that no new names beginning with the letter A can be added before Adam, such as Abigail.</span></span> <span data-ttu-id="12fe9-821">De forma semelhante, o bloqueio de intervalo de chave RangeS-S na entrada do índice garante que nenhum nome novo começando com a letra C possa ser adicionado depois de Carlos, como Clive por exemplo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-821">Similarly, the RangeS-S key-range lock on the index entry for Dale ensures that no new names beginning with the letter C can be added after Carlos, such as Clive.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-822">O número de bloqueios que RangeS-S contém é *n*+1, em que *n* é o número de linhas que satisfazem a consulta.</span><span class="sxs-lookup"><span data-stu-id="12fe9-822">The number of RangeS-S locks held is *n*+1, where *n* is the number of rows that satisfy the query.</span></span>  
  
##### <a name="singleton-fetch-of-nonexistent-data"></a><span data-ttu-id="12fe9-823">Busca Singleton de Dados Inexistentes</span><span class="sxs-lookup"><span data-stu-id="12fe9-823">Singleton Fetch of Nonexistent Data</span></span>  

 <span data-ttu-id="12fe9-824">Se uma consulta dentro de uma transação tenta selecionar uma fila que não existe, a emissão da consulta em um momento posterior dentro da mesma transação terá que retornar o mesmo resultado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-824">If a query within a transaction attempts to select a row that does not exist, issuing the query at a later point within the same transaction has to return the same result.</span></span> <span data-ttu-id="12fe9-825">Nenhuma outra transação terá permissão de inserir essa linha inexistente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-825">No other transaction can be allowed to insert that nonexistent row.</span></span> <span data-ttu-id="12fe9-826">Por exemplo, nessa consulta:</span><span class="sxs-lookup"><span data-stu-id="12fe9-826">For example, given this query:</span></span>  
  
```sql 
SELECT name  
    FROM mytable  
    WHERE name = 'Bill';  
```  
  
 <span data-ttu-id="12fe9-827">Um bloqueio de intervalo de chave é posicionado na entrada de índice correspondendo ao intervalo de nome de `Ben` a `Bing` pois o nome `Bill` seria inserido entre essas duas entradas adjacentes.</span><span class="sxs-lookup"><span data-stu-id="12fe9-827">A key-range lock is placed on the index entry corresponding to the name range from `Ben` to `Bing` because the name `Bill` would be inserted between these two adjacent index entries.</span></span> <span data-ttu-id="12fe9-828">O bloqueio de intervalo de chave do modo RangeS-S é posicionado na entrada de índice `Bing`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-828">The RangeS-S mode key-range lock is placed on the index entry `Bing`.</span></span> <span data-ttu-id="12fe9-829">Isso impede que qualquer outra transação insira valores, como `Bill`, entre as entradas de índice `Ben` e `Bing`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-829">This prevents any other transaction from inserting values, such as `Bill`, between the index entries `Ben` and `Bing`.</span></span>  
  
##### <a name="delete-operation"></a><span data-ttu-id="12fe9-830">Operação de Exclusão</span><span class="sxs-lookup"><span data-stu-id="12fe9-830">Delete Operation</span></span>  

 <span data-ttu-id="12fe9-831">Ao excluir um valor dentro de uma transação, o intervalo no qual o valor se encaixa não tem que ser bloqueado durante a transação que está executando a operação de exclusão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-831">When deleting a value within a transaction, the range the value falls into does not have to be locked for the duration of the transaction performing the delete operation.</span></span> <span data-ttu-id="12fe9-832">Bloquear o valor de chave excluso até o fim da transação é suficiente para manter a serialização.</span><span class="sxs-lookup"><span data-stu-id="12fe9-832">Locking the deleted key value until the end of the transaction is sufficient to maintain serializability.</span></span> <span data-ttu-id="12fe9-833">Por exemplo, na seguinte instrução DELETE:</span><span class="sxs-lookup"><span data-stu-id="12fe9-833">For example, given this DELETE statement:</span></span>  
  
```sql  
DELETE mytable  
    WHERE name = 'Bob';  
```  
  
 <span data-ttu-id="12fe9-834">Um bloqueio (X) exclusivo é posicionado na entrada de índice correspondente ao nome `Bob`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-834">An exclusive (X) lock is placed on the index entry corresponding to the name `Bob`.</span></span> <span data-ttu-id="12fe9-835">Outras transações podem inserir ou excluir valores entre ou após o valor excluído `Bob`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-835">Other transactions can insert or delete values before or after the deleted value `Bob`.</span></span> <span data-ttu-id="12fe9-836">Entretanto, qualquer transação que tente ler, inserir, ou excluir o valor `Bob` será bloqueada até que a transação de exclusão seja confirmada ou revertida.</span><span class="sxs-lookup"><span data-stu-id="12fe9-836">However, any transaction that attempts to read, insert, or delete the value `Bob` will be blocked until the deleting transaction either commits or rolls back.</span></span>  
  
 <span data-ttu-id="12fe9-837">A exclusão de intervalo pode ser executada utilizando três modos básicos de bloqueio: de linha, de página, ou de tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-837">Range delete can be executed using three basic lock modes: row, page, or table lock.</span></span> <span data-ttu-id="12fe9-838">A estratégia de bloqueio de linha, página, ou tabela, é decidida pelo otimizador de consultas, ou pode ser especificada pelo usuário através de dicas como ROWLOCK, PAGLOCK, ou TABLOCK.</span><span class="sxs-lookup"><span data-stu-id="12fe9-838">The row, page, or table locking strategy is decided by query optimizer or can be specified by the user through optimizer hints such as ROWLOCK, PAGLOCK, or TABLOCK.</span></span> <span data-ttu-id="12fe9-839">Quando PAGLOCK ou TABLOCK são usadas, o [!INCLUDE[ssDE](../includes/ssde-md.md)] desaloca imediatamente uma página de entrada, se todas as linhas dessa página forem exclusas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-839">When PAGLOCK or TABLOCK is used, the [!INCLUDE[ssDE](../includes/ssde-md.md)] immediately deallocates an index page if all rows are deleted from this page.</span></span> <span data-ttu-id="12fe9-840">Por outro lado, quando ROWLOCK é usada, todas as linhas exclusas são marcadas apenas como exclusas; elas são depois removidas da página de índice usando-se uma tarefa em segundo plano.</span><span class="sxs-lookup"><span data-stu-id="12fe9-840">In contrast, when ROWLOCK is used, all deleted rows are marked only as deleted; they are removed from the index page later using a background task.</span></span>  
  
##### <a name="insert-operation"></a><span data-ttu-id="12fe9-841">Operação de Inserção</span><span class="sxs-lookup"><span data-stu-id="12fe9-841">Insert Operation</span></span>  

 <span data-ttu-id="12fe9-842">Ao inserir um valor dentro de uma transação, o intervalo no qual o valor se encaixa não tem que ser bloqueado durante a transação que está executando a operação de inserção.</span><span class="sxs-lookup"><span data-stu-id="12fe9-842">When inserting a value within a transaction, the range the value falls into does not have to be locked for the duration of the transaction performing the insert operation.</span></span> <span data-ttu-id="12fe9-843">Bloquear o valor da chave inserida até o término da transação é suficiente para manter a serialização.</span><span class="sxs-lookup"><span data-stu-id="12fe9-843">Locking the inserted key value until the end of the transaction is sufficient to maintain serializability.</span></span> <span data-ttu-id="12fe9-844">Por exemplo, na seguinte instrução INSERT:</span><span class="sxs-lookup"><span data-stu-id="12fe9-844">For example, given this INSERT statement:</span></span>  
  
```sql  
INSERT mytable VALUES ('Dan');  
```  
  
 <span data-ttu-id="12fe9-845">O bloqueio de intervalo de chave no modo RangeI-N é posicionado na entrada de índice correspondente ao nome David, para testar o intervalo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-845">The RangeI-N mode key-range lock is placed on the index entry corresponding to the name David to test the range.</span></span> <span data-ttu-id="12fe9-846">Se o bloqueio é concedido, `Dan` é inserido, e um bloqueio (X) exclusivo é posicionado no valor `Dan`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-846">If the lock is granted, `Dan` is inserted and an exclusive (X) lock is placed on the value `Dan`.</span></span> <span data-ttu-id="12fe9-847">O bloqueio de intervalo de chave no modo RangeI-N, só é necessário para testar o intervalo, e não é mantido durante a transação que executa a operação de inserção.</span><span class="sxs-lookup"><span data-stu-id="12fe9-847">The RangeI-N mode key-range lock is necessary only to test the range and is not held for the duration of the transaction performing the insert operation.</span></span> <span data-ttu-id="12fe9-848">Outras transações podem inserir ou excluir valores antes ou após o valor inserido `Dan`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-848">Other transactions can insert or delete values before or after the inserted value `Dan`.</span></span> <span data-ttu-id="12fe9-849">Entretanto, qualquer transação que tente ler, inserir, ou excluir o valor `Dan` será bloqueada até que a transação de inserção seja confirmada ou revertida.</span><span class="sxs-lookup"><span data-stu-id="12fe9-849">However, any transaction attempting to read, insert, or delete the value `Dan` will be locked until the inserting transaction either commits or rolls back.</span></span>  
  
### <a name="dynamic-locking"></a><span data-ttu-id="12fe9-850">Bloqueio dinâmico</span><span class="sxs-lookup"><span data-stu-id="12fe9-850">Dynamic Locking</span></span>  

 <span data-ttu-id="12fe9-851">Usar bloqueios de nível baixo, como bloqueios de linha, aumenta a simultaneidade diminuindo a probabilidade de duas transações solicitarem bloqueios, da mesma parte dos dados, ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-851">Using low-level locks, such as row locks, increases concurrency by decreasing the probability that two transactions will request locks on the same piece of data at the same time.</span></span> <span data-ttu-id="12fe9-852">Bloqueios de nível baixo também aumentam o número de bloqueios e os recursos necessários para administrá-los.</span><span class="sxs-lookup"><span data-stu-id="12fe9-852">Using low-level locks also increases the number of locks and the resources needed to manage them.</span></span> <span data-ttu-id="12fe9-853">Usar tabela de nível alto ou bloqueios de página diminui a sobrecarga, porém causando diminuição da simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="12fe9-853">Using high-level table or page locks lowers overhead, but at the expense of lowering concurrency.</span></span>  
  
 <span data-ttu-id="12fe9-854">![Diagrama que mostra custo versus granularidade](media/lockcht.gif "Diagrama que mostra custo versus granularidade")</span><span class="sxs-lookup"><span data-stu-id="12fe9-854">![Diagram showing cost versus granularity](media/lockcht.gif "Diagram showing cost versus granularity")</span></span>  
  
 <span data-ttu-id="12fe9-855">O [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] usa uma estratégia de bloqueio dinâmico para determinar os bloqueios mais eficazes.</span><span class="sxs-lookup"><span data-stu-id="12fe9-855">The [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses a dynamic locking strategy to determine the most cost-effective locks.</span></span> <span data-ttu-id="12fe9-856">O [!INCLUDE[ssDE](../includes/ssde-md.md)] determina automaticamente quais os bloqueios mais apropriados quando a consulta é executada, com base nas características do esquema e da consulta.</span><span class="sxs-lookup"><span data-stu-id="12fe9-856">The [!INCLUDE[ssDE](../includes/ssde-md.md)] automatically determines what locks are most appropriate when the query is executed, based on the characteristics of the schema and query.</span></span> <span data-ttu-id="12fe9-857">Por exemplo, para reduzir a sobrecarga de bloqueios, o otimizador pode escolher bloqueios no nível de página em um índice, ao executar uma verificação do índice.</span><span class="sxs-lookup"><span data-stu-id="12fe9-857">For example, to reduce the overhead of locking, the optimizer may choose page-level locks in an index when performing an index scan.</span></span>  
  
 <span data-ttu-id="12fe9-858">O bloqueio dinâmico tem as seguintes vantagens:</span><span class="sxs-lookup"><span data-stu-id="12fe9-858">Dynamic locking has the following advantages:</span></span>  
  
-   <span data-ttu-id="12fe9-859">Administração de banco de dados simplificada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-859">Simplified database administration.</span></span> <span data-ttu-id="12fe9-860">Os administradores do banco de dados não precisam ajustar os limites de escalonamento de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-860">Database administrators do not have to adjust lock escalation thresholds.</span></span>  
  
-   <span data-ttu-id="12fe9-861">Desempenho superior.</span><span class="sxs-lookup"><span data-stu-id="12fe9-861">Increased performance.</span></span> <span data-ttu-id="12fe9-862">O [!INCLUDE[ssDE](../includes/ssde-md.md)] minimiza a sobrecarga do sistema usando bloqueios adequados à tarefa.</span><span class="sxs-lookup"><span data-stu-id="12fe9-862">The [!INCLUDE[ssDE](../includes/ssde-md.md)] minimizes system overhead by using locks appropriate to the task.</span></span>  
  
-   <span data-ttu-id="12fe9-863">Os desenvolvedores de aplicativos podem se concentrar no desenvolvimento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-863">Application developers can concentrate on development.</span></span> <span data-ttu-id="12fe9-864">O [!INCLUDE[ssDE](../includes/ssde-md.md)] ajusta o bloqueio automaticamente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-864">The [!INCLUDE[ssDE](../includes/ssde-md.md)] adjusts locking automatically.</span></span>  
  
 <span data-ttu-id="12fe9-865">No [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] e em versões posteriores, o comportamento do escalonamento de bloqueios foi alterado com a introdução da opção LOCK_ESCALATION.</span><span class="sxs-lookup"><span data-stu-id="12fe9-865">In [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] and later versions, the behavior of lock escalation has changed with the introduction of the LOCK_ESCALATION option.</span></span> <span data-ttu-id="12fe9-866">Para obter mais informações, consulte a opção LOCK_ESCALATION de [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-866">For more information, see the LOCK_ESCALATION option of [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span></span>  
  
### <a name="deadlocking"></a><span data-ttu-id="12fe9-867">Deadlock</span><span class="sxs-lookup"><span data-stu-id="12fe9-867">Deadlocking</span></span>  

 <span data-ttu-id="12fe9-868">Um deadlock acontece quando duas ou mais tarefas bloqueiam permanentemente uma à outra; uma tarefa está bloqueando um recurso que a outra tarefa está tentando bloquear.</span><span class="sxs-lookup"><span data-stu-id="12fe9-868">A deadlock occurs when two or more tasks permanently block each other by each task having a lock on a resource which the other tasks are trying to lock.</span></span> <span data-ttu-id="12fe9-869">Por exemplo:</span><span class="sxs-lookup"><span data-stu-id="12fe9-869">For example:</span></span>  
  
-   <span data-ttu-id="12fe9-870">A transação A adquire um bloqueio compartilhado da linha 1.</span><span class="sxs-lookup"><span data-stu-id="12fe9-870">Transaction A acquires a share lock on row 1.</span></span>  
  
-   <span data-ttu-id="12fe9-871">A transação B adquire um bloqueio compartilhado da linha 2.</span><span class="sxs-lookup"><span data-stu-id="12fe9-871">Transaction B acquires a share lock on row 2.</span></span>  
  
-   <span data-ttu-id="12fe9-872">A transação A agora solicita um bloqueio exclusivo na linha 2 e é bloqueado até que a transação B termine e libere o bloqueio compartilhado que tem na linha 2.</span><span class="sxs-lookup"><span data-stu-id="12fe9-872">Transaction A now requests an exclusive lock on row 2, and is blocked until transaction B finishes and releases the share lock it has on row 2.</span></span>  
  
-   <span data-ttu-id="12fe9-873">A transação B agora solicita um bloqueio exclusivo na linha 1 e é bloqueado até que a transação A termine e libere o bloqueio compartilhado que tem na linha 1.</span><span class="sxs-lookup"><span data-stu-id="12fe9-873">Transaction B now requests an exclusive lock on row 1, and is blocked until transaction A finishes and releases the share lock it has on row 1.</span></span>  
  
 <span data-ttu-id="12fe9-874">A transação A não pode concluir até que a transação B seja concluída, mas a transação B está bloqueada pela transação A. Essa condição também é chamada de dependência cíclica: A transação A tem uma dependência da transação B e a transação B fecha o círculo tendo uma dependência da transação A.</span><span class="sxs-lookup"><span data-stu-id="12fe9-874">Transaction A cannot complete until transaction B completes, but transaction B is blocked by transaction A. This condition is also called a cyclic dependency: Transaction A has a dependency on transaction B, and transaction B closes the circle by having a dependency on transaction A.</span></span>  
  
 <span data-ttu-id="12fe9-875">Ambas as transações em um deadlock esperarão indefinidamente, a menos que o deadlock seja quebrado por um processo externo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-875">Both transactions in a deadlock will wait forever unless the deadlock is broken by an external process.</span></span> <span data-ttu-id="12fe9-876">O monitor de deadlock [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] verifica periodicamente as tarefas que estão em um deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-876">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] deadlock monitor periodically checks for tasks that are in a deadlock.</span></span> <span data-ttu-id="12fe9-877">Se o monitor detectar uma dependência cíclica, ele escolhe uma das tarefas como vítima e termina sua transação com um erro.</span><span class="sxs-lookup"><span data-stu-id="12fe9-877">If the monitor detects a cyclic dependency, it chooses one of the tasks as a victim and terminates its transaction with an error.</span></span> <span data-ttu-id="12fe9-878">Isso permite que a outra tarefa complete sua transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-878">This allows the other task to complete its transaction.</span></span> <span data-ttu-id="12fe9-879">O aplicativo com a transação que terminou com um erro pode repetir a transação, a qual normalmente é concluída depois que a outra transação em deadlock é encerrada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-879">The application with the transaction that terminated with an error can retry the transaction, which usually completes after the other deadlocked transaction has finished.</span></span>  
  
 <span data-ttu-id="12fe9-880">O deadlock é frequentemente confundido com bloqueio normal.</span><span class="sxs-lookup"><span data-stu-id="12fe9-880">Deadlocking is often confused with normal blocking.</span></span> <span data-ttu-id="12fe9-881">Quando uma transação solicita um bloqueio em um recurso bloqueado por outra transação, a transação solicitante espera até que o bloqueio seja liberado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-881">When a transaction requests a lock on a resource locked by another transaction, the requesting transaction waits until the lock is released.</span></span> <span data-ttu-id="12fe9-882">Por padrão, as transações [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] não têm tempo limite, a menos que LOCK_TIMEOUT seja configurado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-882">By default, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] transactions do not time out, unless LOCK_TIMEOUT is set.</span></span> <span data-ttu-id="12fe9-883">A transação solicitante é bloqueada, não em deadlock, por que ela não fez nada para bloquear a transação que deve o bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-883">The requesting transaction is blocked, not deadlocked, because the requesting transaction has not done anything to block the transaction owning the lock.</span></span> <span data-ttu-id="12fe9-884">Finalmente, a transação proprietária vai terminar e liberar o bloqueio e a transação solicitante terá o bloqueio atribuído e processado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-884">Eventually, the owning transaction will complete and release the lock, and then the requesting transaction will be granted the lock and proceed.</span></span>  
  
 <span data-ttu-id="12fe9-885">Os deadlocks às vezes são chamados de abraço mortal.</span><span class="sxs-lookup"><span data-stu-id="12fe9-885">Deadlocks are sometimes called a deadly embrace.</span></span>  
  
 <span data-ttu-id="12fe9-886">Deadlock é uma condição que pode ocorrer em qualquer sistema com vários threads, não só em sistemas de gerenciamento de banco de dados relacional, e pode ocorrer para outros recursos, além de bloqueios de objetos em bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-886">Deadlock is a condition that can occur on any system with multiple threads, not just on a relational database management system, and can occur for resources other than locks on database objects.</span></span> <span data-ttu-id="12fe9-887">Por exemplo, um thread em um sistema operacional de vários threads pode adquirir um ou mais recursos, como bloqueios de memória.</span><span class="sxs-lookup"><span data-stu-id="12fe9-887">For example, a thread in a multithreaded operating system might acquire one or more resources, such as blocks of memory.</span></span> <span data-ttu-id="12fe9-888">Se o recurso sendo adquirido é atualmente propriedade de outro thread, o primeiro thread pode ter que esperar o thread proprietário liberar o recurso alvo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-888">If the resource being acquired is currently owned by another thread, the first thread may have to wait for the owning thread to release the target resource.</span></span> <span data-ttu-id="12fe9-889">O thread em espera tem uma dependência do thread proprietário para aquele recurso em particular.</span><span class="sxs-lookup"><span data-stu-id="12fe9-889">The waiting thread is said to have a dependency on the owning thread for that particular resource.</span></span> <span data-ttu-id="12fe9-890">Em uma instância do [!INCLUDE[ssDE](../includes/ssde-md.md)], sessões podem fazer um deadlock ao adquirir recursos que não são de banco de dados, como memória ou threads.</span><span class="sxs-lookup"><span data-stu-id="12fe9-890">In an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)], sessions can deadlock when acquiring nondatabase resources, such as memory or threads.</span></span>  
  
 <span data-ttu-id="12fe9-891">![Diagrama mostrando o deadlock de transação](media/dedlck1.gif "Diagrama mostrando o deadlock de transação")</span><span class="sxs-lookup"><span data-stu-id="12fe9-891">![Diagram showing transaction deadlock](media/dedlck1.gif "Diagram showing transaction deadlock")</span></span>  
  
 <span data-ttu-id="12fe9-892">Na ilustração, a transação T1 tem uma dependência da transação T2 para o recurso de bloqueio de tabela **Part**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-892">In the illustration, transaction T1 has a dependency on transaction T2 for the **Part** table lock resource.</span></span> <span data-ttu-id="12fe9-893">Da mesma forma, a transação T2 tem uma dependência da transação T1 para o recurso de bloqueio de tabela **Supplier**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-893">Similarly, transaction T2 has a dependency on transaction T1 for the **Supplier** table lock resource.</span></span> <span data-ttu-id="12fe9-894">Devido a essas dependências formarem um ciclo, há um deadlock entre as transações T1 e T2.</span><span class="sxs-lookup"><span data-stu-id="12fe9-894">Because these dependencies form a cycle, there is a deadlock between transactions T1 and T2.</span></span>  
  
 <span data-ttu-id="12fe9-895">Os deadlocks também podem ocorrer quando uma tabela é particionada e a configuração LOCK_ESCALATION do ALTER TABLE é configurada para AUTO.</span><span class="sxs-lookup"><span data-stu-id="12fe9-895">Deadlocks can also occur when a table is partitioned and the LOCK_ESCALATION setting of ALTER TABLE is set to AUTO.</span></span> <span data-ttu-id="12fe9-896">Quando LOCK_ESCALATION é definido como AUTO, a simultaneidade aumenta, permitindo que o [!INCLUDE[ssDE](../includes/ssde-md.md)] bloqueie partições de tabela no nível de HoBT em vez de no nível de tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-896">When LOCK_ESCALATION is set to AUTO, concurrency increases by allowing the [!INCLUDE[ssDE](../includes/ssde-md.md)] to lock table partitions at the HoBT level instead of at the TABLE level.</span></span> <span data-ttu-id="12fe9-897">Entretanto, quando transações separadas mantêm bloqueios de partição em uma tabela e querem um bloqueio em algum lugar de outra partição de transações, isso causa um deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-897">However, when separate transactions hold partition locks in a table and want a lock somewhere on the other transactions partition, this causes a deadlock.</span></span> <span data-ttu-id="12fe9-898">Esse tipo de deadlock pode ser evitado configurando LOCK_ESCALATION para TABLE; embora essa configuração irá reduzir a simultaneidade forçando as atualizações extensas em uma partição a esperarem por um bloqueio de tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-898">This type of deadlock can be avoided by setting LOCK_ESCALATION to TABLE; although this setting will reduce concurrency by forcing large updates to a partition to wait for a table lock.</span></span>  
  
#### <a name="detecting-and-ending-deadlocks"></a><span data-ttu-id="12fe9-899">Detectando e encerrando deadlocks</span><span class="sxs-lookup"><span data-stu-id="12fe9-899">Detecting and Ending Deadlocks</span></span>  

 <span data-ttu-id="12fe9-900">Um deadlock acontece quando duas ou mais tarefas bloqueiam permanentemente uma à outra; uma tarefa está bloqueando um recurso que a outra tarefa está tentando bloquear.</span><span class="sxs-lookup"><span data-stu-id="12fe9-900">A deadlock occurs when two or more tasks permanently block each other by each task having a lock on a resource which the other tasks are trying to lock.</span></span> <span data-ttu-id="12fe9-901">O seguinte gráfico apresenta uma exibição de alto nível de um estado de deadlock em que:</span><span class="sxs-lookup"><span data-stu-id="12fe9-901">The following graph presents a high level view of a deadlock state where:</span></span>  
  
-   <span data-ttu-id="12fe9-902">A tarefa T1 tem um bloqueio no recurso R1 (indicado pela seta de R1 para T1) e solicitou um bloqueio no recurso R2 (indicado pela seta de T1 para R2).</span><span class="sxs-lookup"><span data-stu-id="12fe9-902">Task T1 has a lock on resource R1 (indicated by the arrow from R1 to T1) and has requested a lock on resource R2 (indicated by the arrow from T1 to R2).</span></span>  
  
-   <span data-ttu-id="12fe9-903">A tarefa T2 tem um bloqueio no recurso R2 (indicado pela seta de R2 a T2) e solicitou um bloqueio no recurso R1 (indicado pela seta de T2 a R1).</span><span class="sxs-lookup"><span data-stu-id="12fe9-903">Task T2 has a lock on resource R2 (indicated by the arrow from R2 to T2) and has requested a lock on resource R1 (indicated by the arrow from T2 to R1).</span></span>  
  
-   <span data-ttu-id="12fe9-904">Como nenhuma tarefa pode continuar até que um recurso esteja disponível e nenhum recurso pode ser liberado até que uma tarefa continue, ocorre um estado de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-904">Because neither task can continue until a resource is available and neither resource can be released until a task continues, a deadlock state exists.</span></span>  
  
 <span data-ttu-id="12fe9-905">![Diagrama mostrando tarefas em um estado de deadlock](media/task-deadlock-state.gif "Diagrama mostrando tarefas em um estado de deadlock")</span><span class="sxs-lookup"><span data-stu-id="12fe9-905">![Diagram showing tasks in a deadlock state](media/task-deadlock-state.gif "Diagram showing tasks in a deadlock state")</span></span>  
  
 <span data-ttu-id="12fe9-906">O [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] detecta ciclos de deadlock automaticamente dentro do [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-906">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] automatically detects deadlock cycles within [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="12fe9-907">O [!INCLUDE[ssDE](../includes/ssde-md.md)] escolhe uma das sessões como vítima de deadlock e a transação atual é encerrada com um erro para quebrar o deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-907">The [!INCLUDE[ssDE](../includes/ssde-md.md)] chooses one of the sessions as a deadlock victim and the current transaction is terminated with an error to break the deadlock.</span></span>  
  
##### <a name="resources-that-can-deadlock"></a><span data-ttu-id="12fe9-908">Recursos que podem acarretar deadlock</span><span class="sxs-lookup"><span data-stu-id="12fe9-908">Resources That Can Deadlock</span></span>  

 <span data-ttu-id="12fe9-909">Cada sessão de usuário pode ter uma ou mais tarefas sendo executadas em seu nome, sendo que cada tarefa pode adquirir ou aguardar para adquirir uma variedade de recursos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-909">Each user session might have one or more tasks running on its behalf where each task might acquire or wait to acquire a variety of resources.</span></span> <span data-ttu-id="12fe9-910">Os tipos de recursos a seguir podem causar bloqueio que pode resultar em um deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-910">The following types of resources can cause blocking that could result in a deadlock.</span></span>  
  
-   <span data-ttu-id="12fe9-911">**Bloqueios**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-911">**Locks**.</span></span> <span data-ttu-id="12fe9-912">A espera para adquirir bloqueios em recursos, como objetos, páginas, linhas, metadados e aplicativos pode causar deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-912">Waiting to acquire locks on resources, such as objects, pages, rows, metadata, and applications can cause deadlock.</span></span> <span data-ttu-id="12fe9-913">Por exemplo, a transação T1 tem um bloqueio compartilhado (S) na linha r1 e está esperando para obter um bloqueio exclusivo (X) em r2.</span><span class="sxs-lookup"><span data-stu-id="12fe9-913">For example, transaction T1 has a shared (S) lock on row r1 and is waiting to get an exclusive (X) lock on r2.</span></span> <span data-ttu-id="12fe9-914">A transação T2 tem um bloqueio compartilhado (S) na linha r1 e está esperando para obter um bloqueio exclusivo (X) em r1.</span><span class="sxs-lookup"><span data-stu-id="12fe9-914">Transaction T2 has a shared (S) lock on r2 and is waiting to get an exclusive (X) lock on row r1.</span></span> <span data-ttu-id="12fe9-915">Isso resulta em um ciclo de bloqueio no qual T1 e T2 esperam que uma libere os recursos bloqueados da outra.</span><span class="sxs-lookup"><span data-stu-id="12fe9-915">This results in a lock cycle in which T1 and T2 wait for each other to release the locked resources.</span></span>  
  
-   <span data-ttu-id="12fe9-916">**Threads de trabalho**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-916">**Worker threads**.</span></span> <span data-ttu-id="12fe9-917">Uma tarefa em fila aguardando um thread de trabalho pode causar um deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-917">A queued task waiting for an available worker thread can cause deadlock.</span></span> <span data-ttu-id="12fe9-918">Se a tarefa em fila possuir recursos que estão bloqueando todos os threads de trabalhado, haverá um deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-918">If the queued task owns resources that are blocking all worker threads, a deadlock will result.</span></span> <span data-ttu-id="12fe9-919">Por exemplo, a sessão S1 inicia uma transação e adquire um bloqueio compartilhado (S) na linha r1 e, depois, fica suspenso.</span><span class="sxs-lookup"><span data-stu-id="12fe9-919">For example, session S1 starts a transaction and acquires a shared (S) lock on row r1 and then goes to sleep.</span></span> <span data-ttu-id="12fe9-920">As sessões ativas em execução em todos os threads de trabalhado disponíveis estão tentando adquirir bloqueios exclusivos (X) na linha r1.</span><span class="sxs-lookup"><span data-stu-id="12fe9-920">Active sessions running on all available worker threads are trying to acquire exclusive (X) locks on row r1.</span></span> <span data-ttu-id="12fe9-921">Como a sessão S1 não pode adquirir um thread de trabalho, ela não pode confirmar a transação e liberar o bloqueio na linha r1.</span><span class="sxs-lookup"><span data-stu-id="12fe9-921">Because session S1 cannot acquire a worker thread, it cannot commit the transaction and release the lock on row r1.</span></span> <span data-ttu-id="12fe9-922">Isso resulta em um deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-922">This results in a deadlock.</span></span>  
  
-   <span data-ttu-id="12fe9-923">**Memória**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-923">**Memory**.</span></span> <span data-ttu-id="12fe9-924">Quando solicitações simultâneas estão esperando por concessões de memória que não podem ser satisfeitas com a memória disponível, pode ocorrer um deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-924">When concurrent requests are waiting for memory grants that cannot be satisfied with the available memory, a deadlock can occur.</span></span> <span data-ttu-id="12fe9-925">Por exemplo, duas consultas simultâneas, Q1 e Q2, são executadas como funções definidas pelo usuário que adquirem 10MB e 20MB de memória, respectivamente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-925">For example, two concurrent queries, Q1 and Q2, execute as user-defined functions that acquire 10MB and 20MB of memory respectively.</span></span> <span data-ttu-id="12fe9-926">Se cada consulta precisar de 30MB e a memória disponível total for de 20MB, Q1 e Q2 deverão esperar uma pela outra para liberar memória. Isso resulta em um deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-926">If each query needs 30MB and the total available memory is 20MB, then Q1 and Q2 must wait for each other to release memory, and this results in a deadlock.</span></span>  
  
-   <span data-ttu-id="12fe9-927">**Recursos relacionados à execução de consultas paralelas** Threads de coordenador, produtor ou consumidor associados a uma porta de troca podem bloquear uns aos outros, provocando um deadlock, normalmente ao incluir pelo menos um outro processo que não faz parte da consulta paralela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-927">**Parallel query execution-related resources** Coordinator, producer, or consumer threads associated with an exchange port may block each other causing a deadlock usually when including at least one other process that is not a part of the parallel query.</span></span> <span data-ttu-id="12fe9-928">Além disso, quando uma consulta paralela começa a ser executada, o [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] determina o grau de paralelismo, ou o número de threads de trabalho, com base na carga de trabalho atual.</span><span class="sxs-lookup"><span data-stu-id="12fe9-928">Also, when a parallel query starts execution, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] determines the degree of parallelism, or the number of worker threads, based upon the current workload.</span></span> <span data-ttu-id="12fe9-929">Se a carga de trabalho do sistema for alterada inesperadamente, por exemplo, quando novas consultas forem executadas no servidor ou o sistema ficar sem threads de trabalho, poderá ocorrer um deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-929">If the system workload unexpectedly changes, for example, where new queries start running on the server or the system runs out of worker threads, then a deadlock could occur.</span></span>  
  
-   <span data-ttu-id="12fe9-930">**Recursos MARS (conjunto de resultados ativos múltiplos)** .</span><span class="sxs-lookup"><span data-stu-id="12fe9-930">**Multiple Active Result Sets (MARS) resources**.</span></span> <span data-ttu-id="12fe9-931">Esses recursos são usados para controlar a intercalação de várias solicitações ativas em MARS.</span><span class="sxs-lookup"><span data-stu-id="12fe9-931">These resources are used to control interleaving of multiple active requests under MARS.</span></span> <span data-ttu-id="12fe9-932">Para obter mais informações, consulte [Mars (vários conjuntos de resultados ativos) no SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span><span class="sxs-lookup"><span data-stu-id="12fe9-932">For more information, see [Multiple Active Result Sets (MARS) in SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span></span>  
  
    -   <span data-ttu-id="12fe9-933">**Recurso do usuário**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-933">**User resource**.</span></span> <span data-ttu-id="12fe9-934">Quando um thread está esperando por um recurso que é potencialmente controlado por um aplicativo de usuário, o recurso é considerado como externo ou recurso de usuário e é tratado como um bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-934">When a thread is waiting for a resource that is potentially controlled by a user application, the resource is considered to be an external or user resource and is treated like a lock.</span></span>  
  
    -   <span data-ttu-id="12fe9-935">**Mutex da sessão**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-935">**Session mutex**.</span></span> <span data-ttu-id="12fe9-936">As tarefas que estão sendo executadas em uma sessão são intercaladas, ou seja, apenas uma tarefa pode ser executada na sessão em um determinado momento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-936">The tasks running in one session are interleaved, meaning that only one task can run under the session at a given time.</span></span> <span data-ttu-id="12fe9-937">Antes de a tarefa ser executada, deve ter acesso exclusivo ao mutex de sessão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-937">Before the task can run, it must have exclusive access to the session mutex.</span></span>  
  
    -   <span data-ttu-id="12fe9-938">**Mutex de transação**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-938">**Transaction mutex**.</span></span> <span data-ttu-id="12fe9-939">Todas as tarefas que estão sendo executadas em uma transação são intercaladas, ou seja, somente uma tarefa pode ser executada na transação em um determinado momento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-939">All tasks running in one transaction are interleaved, meaning that only one task can run under the transaction at a given time.</span></span> <span data-ttu-id="12fe9-940">Antes da tarefa ser executada, deve ter acesso exclusivo ao mutex de transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-940">Before the task can run, it must have exclusive access to the transaction mutex.</span></span>  
  
     <span data-ttu-id="12fe9-941">Para que uma tarefa seja executada em MARS, ela deve adquirir o mutex da sessão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-941">In order for a task to run under MARS, it must acquire the session mutex.</span></span> <span data-ttu-id="12fe9-942">Se a tarefa estiver sendo executada em uma transação, deverá adquirir o mutex de transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-942">If the task is running under a transaction, it must then acquire the transaction mutex.</span></span> <span data-ttu-id="12fe9-943">Isso garante que apenas uma tarefa esteja ativa em um determinado momento, sessão e transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-943">This guarantees that only one task is active at one time in a given session and a given transaction.</span></span> <span data-ttu-id="12fe9-944">Quando os mutexes solicitados forem adquiridos, a tarefa poderá ser executada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-944">Once the required mutexes have been acquired, the task can execute.</span></span> <span data-ttu-id="12fe9-945">Quando a tarefa termina, ou está no meio da solicitação, primeiro ela libera o mutex de transação e, depois, o mutex de sessão em ordem reversa de aquisição.</span><span class="sxs-lookup"><span data-stu-id="12fe9-945">When the task finishes, or yields in the middle of the request, it will first release transaction mutex followed by the session mutex in reverse order of acquisition.</span></span> <span data-ttu-id="12fe9-946">Porém, podem ocorrer deadlocks com esses recursos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-946">However, deadlocks can occur with these resources.</span></span> <span data-ttu-id="12fe9-947">No exemplo de código a seguir, duas tarefas, solicitação de usuário U1 e solicitação de usuário U2, estão sendo executadas na mesma sessão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-947">In the following code example, two tasks, user request U1 and user request U2, are running in the same session.</span></span>  
  
    ```  
    U1:    Rs1=Command1.Execute("insert sometable EXEC usp_someproc");  
    U2:    Rs2=Command2.Execute("select colA from sometable");  
    ```  
  
     <span data-ttu-id="12fe9-948">O procedimento armazenado que está sendo executado na solicitação U1 adquiriu o mutex de sessão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-948">The stored procedure executing from user request U1 has acquired the session mutex.</span></span> <span data-ttu-id="12fe9-949">Se o procedimento armazenado levar muito tempo para ser executado, o [!INCLUDE[ssDE](../includes/ssde-md.md)] presumirá que o procedimento armazenado está esperando uma entrada do usuário.</span><span class="sxs-lookup"><span data-stu-id="12fe9-949">If the stored procedure takes a long time to execute, it is assumed by the [!INCLUDE[ssDE](../includes/ssde-md.md)] that the stored procedure is waiting for input from the user.</span></span> <span data-ttu-id="12fe9-950">A solicitação de usuário U2 está esperando pelo mutex de sessão, enquanto o usuário está esperando pelo conjunto de resultados de U2, e U1 está esperando por um recurso de usuário.</span><span class="sxs-lookup"><span data-stu-id="12fe9-950">User request U2 is waiting for the session mutex while the user is waiting for the result set from U2, and U1 is waiting for a user resource.</span></span> <span data-ttu-id="12fe9-951">Esse estado de deadlock é logicamente ilustrado como:</span><span class="sxs-lookup"><span data-stu-id="12fe9-951">This is deadlock state logically illustrated as:</span></span>  
  
 <span data-ttu-id="12fe9-952">![Diagrama lógico mostrando deadlock de processo do usuário.](media/udb9-logicflowexamplec.gif "Diagrama lógico mostrando deadlock de processo do usuário.")</span><span class="sxs-lookup"><span data-stu-id="12fe9-952">![Logic diagram showing user process deadlock.](media/udb9-logicflowexamplec.gif "Logic diagram showing user process deadlock.")</span></span>  
  
##### <a name="deadlock-detection"></a><span data-ttu-id="12fe9-953">Detecção de deadlock</span><span class="sxs-lookup"><span data-stu-id="12fe9-953">Deadlock Detection</span></span>  

 <span data-ttu-id="12fe9-954">Todos os recursos listados na seção anterior participam do esquema de detecção de deadlock [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-954">All of the resources listed in the section above participate in the [!INCLUDE[ssDE](../includes/ssde-md.md)] deadlock detection scheme.</span></span> <span data-ttu-id="12fe9-955">A detecção de deadlock é executada por um thread de monitor de bloqueio que periodicamente inicia uma pesquisa por todas as tarefas em uma instância do [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-955">Deadlock detection is performed by a lock monitor thread that periodically initiates a search through all of the tasks in an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)].</span></span> <span data-ttu-id="12fe9-956">Os seguintes pontos descrevem o processo de pesquisa:</span><span class="sxs-lookup"><span data-stu-id="12fe9-956">The following points describe the search process:</span></span>  
  
-   <span data-ttu-id="12fe9-957">O intervalo padrão é de 5 segundos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-957">The default interval is 5 seconds.</span></span>  
  
-   <span data-ttu-id="12fe9-958">Se o thread de monitor de bloqueio localizar deadlocks, o intervalo de detecção de deadlock diminuirá de 5 segundos para até 100 milissegundos, dependendo da frequência de deadlocks.</span><span class="sxs-lookup"><span data-stu-id="12fe9-958">If the lock monitor thread finds deadlocks, the deadlock detection interval will drop from 5 seconds to as low as 100 milliseconds depending on the frequency of deadlocks.</span></span>  
  
-   <span data-ttu-id="12fe9-959">Se o thread de monitor de bloqueio parar de localizar deadlocks, o [!INCLUDE[ssDE](../includes/ssde-md.md)] aumentará os intervalos entre pesquisas para 5 segundos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-959">If the lock monitor thread stops finding deadlocks, the [!INCLUDE[ssDE](../includes/ssde-md.md)] increases the intervals between searches to 5 seconds.</span></span>  
  
-   <span data-ttu-id="12fe9-960">Se um deadlock tiver sido detectado há pouco tempo, presume-se que os próximos threads que precisarem esperar por um bloqueio estejam entrando no ciclo de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-960">If a deadlock has just been detected, it is assumed that the next threads that must wait for a lock are entering the deadlock cycle.</span></span> <span data-ttu-id="12fe9-961">O primeiro par de esperas de bloqueio, após a detecção de um deadlock, dispara imediatamente uma pesquisa de deadlock em vez de aguardar pelo próximo intervalo de detecção de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-961">The first couple of lock waits after a deadlock has been detected will immediately trigger a deadlock search rather than wait for the next deadlock detection interval.</span></span> <span data-ttu-id="12fe9-962">Por exemplo, se o intervalo atual for de 5 segundos, e um deadlock tiver sido detectado há pouco tempo, a próxima espera de bloqueio iniciará o detector de deadlock imediatamente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-962">For example, if the current interval is 5 seconds, and a deadlock was just detected, the next lock wait will kick off the deadlock detector immediately.</span></span> <span data-ttu-id="12fe9-963">Se essa espera de bloqueio fizer parte de um deadlock, será detectada imediatamente em vez de durante a próxima pesquisa de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-963">If this lock wait is part of a deadlock, it will be detected right away rather than during next deadlock search.</span></span>  
  
 <span data-ttu-id="12fe9-964">Normalmente, o [!INCLUDE[ssDE](../includes/ssde-md.md)] executa somente a detecção periódica de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-964">The [!INCLUDE[ssDE](../includes/ssde-md.md)] typically performs periodic deadlock detection only.</span></span> <span data-ttu-id="12fe9-965">Como o número de deadlocks encontrado no sistema geralmente é pequeno, a detecção periódica de deadlock ajuda a reduzir a sobrecarga de detecção de deadlock no sistema.</span><span class="sxs-lookup"><span data-stu-id="12fe9-965">Because the number of deadlocks encountered in the system is usually small, periodic deadlock detection helps to reduce the overhead of deadlock detection in the system.</span></span>  
  
 <span data-ttu-id="12fe9-966">Quando o monitor de bloqueio inicia a pesquisa de deadlock para um determinado thread, ele identifica o recurso em que o thread está esperando.</span><span class="sxs-lookup"><span data-stu-id="12fe9-966">When the lock monitor initiates deadlock search for a particular thread, it identifies the resource on which the thread is waiting.</span></span> <span data-ttu-id="12fe9-967">O monitor de bloqueio localiza o proprietário desse recurso em particular e, recursivamente, continua a pesquisa de deadlock para esses threads até encontrar um ciclo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-967">The lock monitor then finds the owner(s) for that particular resource and recursively continues the deadlock search for those threads until it finds a cycle.</span></span> <span data-ttu-id="12fe9-968">Um ciclo identificado dessa maneira forma um deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-968">A cycle identified in this manner forms a deadlock.</span></span>  
  
 <span data-ttu-id="12fe9-969">Depois que um deadlock é detectado, o [!INCLUDE[ssDE](../includes/ssde-md.md)] encerra esse deadlock escolhendo um dos threads como uma vítima de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-969">After a deadlock is detected, the [!INCLUDE[ssDE](../includes/ssde-md.md)] ends a deadlock by choosing one of the threads as a deadlock victim.</span></span> <span data-ttu-id="12fe9-970">O [!INCLUDE[ssDE](../includes/ssde-md.md)] encerra o lote atual que está sendo executado para o thread, reverte a transação da vítima de deadlock e retorna um erro 1205 para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-970">The [!INCLUDE[ssDE](../includes/ssde-md.md)] terminates the current batch being executed for the thread, rolls back the transaction of the deadlock victim, and returns a 1205 error to the application.</span></span> <span data-ttu-id="12fe9-971">A reversão da transação da vítima de deadlock libera todos os bloqueios mantidos pela transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-971">Rolling back the transaction for the deadlock victim releases all locks held by the transaction.</span></span> <span data-ttu-id="12fe9-972">Isso permite que as transações dos outros threads sejam desbloqueadas e prossigam.</span><span class="sxs-lookup"><span data-stu-id="12fe9-972">This allows the transactions of the other threads to become unblocked and continue.</span></span> <span data-ttu-id="12fe9-973">O erro 1205 da vítima de deadlock registra informações sobre os threads e recursos envolvidos em um deadlock no log de erros.</span><span class="sxs-lookup"><span data-stu-id="12fe9-973">The 1205 deadlock victim error records information about the threads and resources involved in a deadlock in the error log.</span></span>  
  
 <span data-ttu-id="12fe9-974">Por padrão, o [!INCLUDE[ssDE](../includes/ssde-md.md)] escolhe a sessão que está executando a transação mais fácil de ser revertida como a vítima de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-974">By default, the [!INCLUDE[ssDE](../includes/ssde-md.md)] chooses as the deadlock victim the session running the transaction that is least expensive to roll back.</span></span> <span data-ttu-id="12fe9-975">Alternativamente, um usuário pode especificar a prioridade de sessões em uma situação de deadlock usando a instrução SET DEADLOCK_PRIORITY.</span><span class="sxs-lookup"><span data-stu-id="12fe9-975">Alternatively, a user can specify the priority of sessions in a deadlock situation using the SET DEADLOCK_PRIORITY statement.</span></span> <span data-ttu-id="12fe9-976">O DEADLOCK_PRIORITY pode ser definida como LOW, NORMAL ou HIGH ou, alternativamente, pode ser definido como qualquer valor de inteiro no intervalo (-10 a 10).</span><span class="sxs-lookup"><span data-stu-id="12fe9-976">DEADLOCK_PRIORITY can be set to LOW, NORMAL, or HIGH, or alternatively can be set to any integer value in the range (-10 to 10).</span></span> <span data-ttu-id="12fe9-977">A prioridade de deadlock assume NORMAL como padrão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-977">The deadlock priority defaults to NORMAL.</span></span> <span data-ttu-id="12fe9-978">Se duas sessões tiverem prioridades de deadlock diferentes, a sessão com a prioridade mais baixa será escolhida como a vítima de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-978">If two sessions have different deadlock priorities, the session with the lower priority is chosen as the deadlock victim.</span></span> <span data-ttu-id="12fe9-979">Se ambas as sessões tiverem a mesma prioridade de deadlock, a sessão com a transação menos dispendiosa para ser revertida será escolhida.</span><span class="sxs-lookup"><span data-stu-id="12fe9-979">If both sessions have the same deadlock priority, the session with the transaction that is least expensive to roll back is chosen.</span></span> <span data-ttu-id="12fe9-980">Se as sessões envolvidas no ciclo de deadlock tiverem a mesma prioridade de deadlock e o mesmo custo, a vítima será escolhida aleatoriamente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-980">If sessions involved in the deadlock cycle have the same deadlock priority and the same cost, a victim is chosen randomly.</span></span>  
  
 <span data-ttu-id="12fe9-981">Ao trabalhar com CLR, o monitor de deadlock detecta automaticamente um deadlock para recursos de sincronização (monitores, bloqueio de leitura/gravação ou junção de thread) acessados dentro dos procedimentos gerenciados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-981">When working with CLR, the deadlock monitor automatically detects deadlock for synchronization resources (monitors, reader/writer lock and thread join) accessed inside managed procedures.</span></span> <span data-ttu-id="12fe9-982">Entretanto, o deadlock é resolvido ao se lançar uma exceção no procedimento selecionado como a vítima de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-982">However, the deadlock is resolved by throwing an exception in the procedure that was selected to be the deadlock victim.</span></span> <span data-ttu-id="12fe9-983">É importante entender que a exceção não libera automaticamente os recursos pertencentes à vítima; os recursos devem ser liberados explicitamente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-983">It is important to understand that the exception does not automatically release resources currently owned by the victim; the resources must be explicitly released.</span></span> <span data-ttu-id="12fe9-984">Em consonância com o comportamento de exceção, a exceção usada para identificar uma vítima de deadlock pode ser capturada e ignorada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-984">Consistent with exception behavior, the exception used to identify a deadlock victim can be caught and dismissed.</span></span>  
  
##### <a name="deadlock-information-tools"></a><span data-ttu-id="12fe9-985">Ferramentas de informações sobre deadlock</span><span class="sxs-lookup"><span data-stu-id="12fe9-985">Deadlock Information Tools</span></span>  

 <span data-ttu-id="12fe9-986">Para exibir informações sobre deadlock, o [!INCLUDE[ssDE](../includes/ssde-md.md)] fornece ferramentas de monitoração na forma de dois sinalizadores de rastreamento e o evento gráfico de deadlock no [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-986">To view deadlock information, the [!INCLUDE[ssDE](../includes/ssde-md.md)] provides monitoring tools in the form of two trace flags, and the deadlock graph event in [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)].</span></span>  
  
###### <a name="trace-flag-1204-and-trace-flag-1222"></a><span data-ttu-id="12fe9-987">Sinalizadores de rastreamento 1204 e 1222</span><span class="sxs-lookup"><span data-stu-id="12fe9-987">Trace Flag 1204 and Trace Flag 1222</span></span>  

 <span data-ttu-id="12fe9-988">Quando acontecem deadlocks, os sinalizadores de rastreamento 1204 e 1222 retornam informações captadas no log de erros [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-988">When deadlocks occur, trace flag 1204 and trace flag 1222 return information that is captured in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] error log.</span></span> <span data-ttu-id="12fe9-989">O sinalizador de rastreamento 1204 relata informações de deadlock formatadas por cada nó envolvido no deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-989">Trace flag 1204 reports deadlock information formatted by each node involved in the deadlock.</span></span> <span data-ttu-id="12fe9-990">O sinalizador de rastreamento 1222 formata informações de deadlock, primeiro por processos e depois por recursos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-990">Trace flag 1222 formats deadlock information, first by processes and then by resources.</span></span> <span data-ttu-id="12fe9-991">É possível permitir que ambos os sinalizadores de rastreamento obtenham duas representações do mesmo evento de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-991">It is possible to enable both trace flags to obtain two representations of the same deadlock event.</span></span>  
  
 <span data-ttu-id="12fe9-992">Além de definir as propriedades dos sinalizadores de rastreamento 1204 e 1222, a tabela a seguir também mostra suas semelhanças e diferenças.</span><span class="sxs-lookup"><span data-stu-id="12fe9-992">In addition to defining the properties of trace flag 1204 and 1222, the following table also shows the similarities and differences.</span></span>  
  
|<span data-ttu-id="12fe9-993">Propriedade</span><span class="sxs-lookup"><span data-stu-id="12fe9-993">Property</span></span>|<span data-ttu-id="12fe9-994">Sinalizadores de rastreamento 1204 e 1222</span><span class="sxs-lookup"><span data-stu-id="12fe9-994">Trace Flag 1204 and Trace Flag 1222</span></span>|<span data-ttu-id="12fe9-995">Apenas sinalizador de rastreamento 1204</span><span class="sxs-lookup"><span data-stu-id="12fe9-995">Trace Flag 1204 only</span></span>|<span data-ttu-id="12fe9-996">Apenas sinalizador de rastreamento 1222</span><span class="sxs-lookup"><span data-stu-id="12fe9-996">Trace Flag 1222 only</span></span>|  
|--------------|-----------------------------------------|--------------------------|--------------------------|  
|<span data-ttu-id="12fe9-997">Formato da saída</span><span class="sxs-lookup"><span data-stu-id="12fe9-997">Output format</span></span>|<span data-ttu-id="12fe9-998">A saída captada no log de erros do [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-998">Output is captured in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] error log.</span></span>|<span data-ttu-id="12fe9-999">Focado nos nós envolvidos no deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-999">Focused on the nodes involved in the deadlock.</span></span> <span data-ttu-id="12fe9-1000">Cada nó tem uma seção dedicada e a seção final descreve a vítima de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1000">Each node has a dedicated section, and the final section describes the deadlock victim.</span></span>|<span data-ttu-id="12fe9-1001">Retorna informações em um formato parecido com XML que não está em conformidade com uma definição de esquema XML (XSD).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1001">Returns information in an XML-like format that does not conform to an XML Schema Definition (XSD) schema.</span></span> <span data-ttu-id="12fe9-1002">O formato tem três seções principais.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1002">The format has three major sections.</span></span> <span data-ttu-id="12fe9-1003">A primeira seção declara a vítima de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1003">The first section declares the deadlock victim.</span></span> <span data-ttu-id="12fe9-1004">A segunda seção descreve cada processo envolvido no deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1004">The second section describes each process involved in the deadlock.</span></span> <span data-ttu-id="12fe9-1005">A terceira seção descreve os recursos que são sinônimos com os nós no sinalizador de rastreamento 1204.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1005">The third section describes the resources that are synonymous with nodes in trace flag 1204.</span></span>|  
|<span data-ttu-id="12fe9-1006">Identificando atributos</span><span class="sxs-lookup"><span data-stu-id="12fe9-1006">Identifying attributes</span></span>|<span data-ttu-id="12fe9-1007">**SPID: \<x> ECID: \<x> .**</span><span class="sxs-lookup"><span data-stu-id="12fe9-1007">**SPID:\<x> ECID:\<x>.**</span></span> <span data-ttu-id="12fe9-1008">Identifica o thread de ID de processo de sistema em casos de processos paralelos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1008">Identifies the system process ID thread in cases of parallel processes.</span></span> <span data-ttu-id="12fe9-1009">A entrada `SPID:<x> ECID:0` , onde \<x> é substituída pelo valor SPID, representa o thread principal.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1009">The entry `SPID:<x> ECID:0`, where \<x> is replaced by the SPID value, represents the main thread.</span></span> <span data-ttu-id="12fe9-1010">A entrada `SPID:<x> ECID:<y>` , em que \<x> é substituída pelo valor SPID e \<y> maior que 0, representa os subthreads para o mesmo SPID.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1010">The entry `SPID:<x> ECID:<y>`, where \<x> is replaced by the SPID value and \<y> is greater than 0, represents the sub-threads for the same SPID.</span></span><br /><br /> <span data-ttu-id="12fe9-1011">**BatchID** (**sbid** para sinalizador de rastreamento 1222).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1011">**BatchID** (**sbid** for trace flag 1222).</span></span> <span data-ttu-id="12fe9-1012">Identifica o lote do qual a execução de código está solicitando ou mantendo um bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1012">Identifies the batch from which code execution is requesting or holding a lock.</span></span> <span data-ttu-id="12fe9-1013">Quando vários conjuntos de resultados ativos (MARS) estão desabilitados, o valor BatchID é 0.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1013">When Multiple Active Result Sets (MARS) is disabled, the BatchID value is 0.</span></span> <span data-ttu-id="12fe9-1014">Quando MARS está habilitado, o valor para lotes ativos é 1 para *n*.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1014">When MARS is enabled, the value for active batches is 1 to *n*.</span></span> <span data-ttu-id="12fe9-1015">Se não houver lotes ativos na sessão, BatchID será 0.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1015">If there are no active batches in the session, BatchID is 0.</span></span><br /><br /> <span data-ttu-id="12fe9-1016">**Modo**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1016">**Mode**.</span></span> <span data-ttu-id="12fe9-1017">Especifica o tipo de bloqueio de um determinado recurso que é solicitado, concedido ou aguardado por um thread.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1017">Specifies the type of lock for a particular resource that is requested, granted, or waited on by a thread.</span></span> <span data-ttu-id="12fe9-1018">O modo pode ser IS (Intencional Compartilhado), S (Compartilhado), U (Atualização), IX (Intencional Exclusivo), SIX (Compartilhado com Intenção Exclusiva) e X (Exclusivo).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1018">Mode can be IS (Intent Shared), S (Shared), U (Update), IX (Intent Exclusive), SIX (Shared with Intent Exclusive), and X (Exclusive).</span></span><br /><br /> <span data-ttu-id="12fe9-1019">**Nº de linha** (**linha** para o sinalizador de rastreamento 1222).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1019">**Line #** (**line** for trace flag 1222).</span></span> <span data-ttu-id="12fe9-1020">Lista o número de linha no lote atual de instruções que estava sendo executado quando o deadlock aconteceu.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1020">Lists the line number in the current batch of statements that was being executed when the deadlock occurred.</span></span><br /><br /> <span data-ttu-id="12fe9-1021">**Input Buf** (**inputbuf** para o sinalizador de rastreamento 1222).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1021">**Input Buf** (**inputbuf** for trace flag 1222).</span></span> <span data-ttu-id="12fe9-1022">Lista todas as instruções no lote atual.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1022">Lists all the statements in the current batch.</span></span>|<span data-ttu-id="12fe9-1023">**Nó**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1023">**Node**.</span></span> <span data-ttu-id="12fe9-1024">Representa o número de entrada na cadeia de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1024">Represents the entry number in the deadlock chain.</span></span><br /><br /> <span data-ttu-id="12fe9-1025">**Listas**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1025">**Lists**.</span></span> <span data-ttu-id="12fe9-1026">O proprietário do bloqueio pode fazer parte destas listas:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1026">The lock owner can be part of these lists:</span></span><br /><br /> <span data-ttu-id="12fe9-1027">**Lista de Concessões**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1027">**Grant List**.</span></span> <span data-ttu-id="12fe9-1028">Enumera os proprietários atuais do recurso.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1028">Enumerates the current owners of the resource.</span></span><br /><br /> <span data-ttu-id="12fe9-1029">**Lista de Conversão**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1029">**Convert List**.</span></span> <span data-ttu-id="12fe9-1030">Enumera os proprietários atuais que estão tentando converter seus bloqueios em um nível mais alto.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1030">Enumerates the current owners that are trying to convert their locks to a higher level.</span></span><br /><br /> <span data-ttu-id="12fe9-1031">**Lista de Espera**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1031">**Wait List**.</span></span> <span data-ttu-id="12fe9-1032">Enumera as novas solicitações de bloqueio do recurso.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1032">Enumerates current new lock requests for the resource.</span></span><br /><br /> <span data-ttu-id="12fe9-1033">**Tipo de Instrução**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1033">**Statement Type**.</span></span> <span data-ttu-id="12fe9-1034">Descreve o tipo de instrução DML (SELECT, INSERT, UPDATE ou DELETE) em que os threads têm permissões.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1034">Describes the type of DML statement (SELECT, INSERT, UPDATE, or DELETE) on which the threads have permissions.</span></span><br /><br /> <span data-ttu-id="12fe9-1035">**Proprietário do Recurso Vítima**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1035">**Victim Resource Owner**.</span></span> <span data-ttu-id="12fe9-1036">Especifica o thread participante que o [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] escolhe como a vítima para quebrar o ciclo de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1036">Specifies the participating thread that [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] chooses as the victim to break the deadlock cycle.</span></span> <span data-ttu-id="12fe9-1037">O thread escolhido e todos os sub-threads existentes são encerrados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1037">The chosen thread and all existing sub-threads are terminated.</span></span><br /><br /> <span data-ttu-id="12fe9-1038">**Próximo Branch**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1038">**Next Branch**.</span></span> <span data-ttu-id="12fe9-1039">Representa os dois ou mais sub-threads do mesmo SPID envolvidos no ciclo de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1039">Represents the two or more sub-threads from the same SPID that are involved in the deadlock cycle.</span></span>|<span data-ttu-id="12fe9-1040">**vítima do deadlock**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1040">**deadlock victim**.</span></span> <span data-ttu-id="12fe9-1041">Representa o endereço de memória física da tarefa (consulte [os_tasks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-tasks-transact-sql)) que foi selecionada como vítima de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1041">Represents the physical memory address of the task (see [sys.dm_os_tasks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-tasks-transact-sql)) that was selected as a deadlock victim.</span></span> <span data-ttu-id="12fe9-1042">Pode ser 0 (zero) no caso de um deadlock não resolvido.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1042">It may be 0 (zero) in the case of an unresolved deadlock.</span></span> <span data-ttu-id="12fe9-1043">Uma tarefa que está sendo revertida não pode ser escolhida como vítima de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1043">A task that is rolling back cannot be chosen as a deadlock victim.</span></span><br /><br /> <span data-ttu-id="12fe9-1044">**executionstack**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1044">**executionstack**.</span></span> <span data-ttu-id="12fe9-1045">Representa o código [!INCLUDE[tsql](../includes/tsql-md.md)] que está sendo executado no momento em que o deadlock ocorre.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1045">Represents [!INCLUDE[tsql](../includes/tsql-md.md)] code that is being executed at the time the deadlock occurs.</span></span><br /><br /> <span data-ttu-id="12fe9-1046">**prioridade**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1046">**priority**.</span></span> <span data-ttu-id="12fe9-1047">Representa a prioridade do deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1047">Represents deadlock priority.</span></span> <span data-ttu-id="12fe9-1048">Em determinados casos, o [!INCLUDE[ssDE](../includes/ssde-md.md)] pode optar por alterar a prioridade de deadlock para uma duração curta para obter uma simultaneidade melhor.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1048">In certain cases, the [!INCLUDE[ssDE](../includes/ssde-md.md)] may opt to alter the deadlock priority for a short duration to achieve better concurrency.</span></span><br /><br /> <span data-ttu-id="12fe9-1049">**logused**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1049">**logused**.</span></span> <span data-ttu-id="12fe9-1050">Espaço de log usado pela tarefa.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1050">Log space used by the task.</span></span><br /><br /> <span data-ttu-id="12fe9-1051">**ID do proprietário**. A ID da transação que tem controle da solicitação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1051">**owner id**. The ID of the transaction that has control of the request.</span></span><br /><br /> <span data-ttu-id="12fe9-1052">**status**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1052">**status**.</span></span> <span data-ttu-id="12fe9-1053">O estado da tarefa.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1053">State of the task.</span></span> <span data-ttu-id="12fe9-1054">Pode ser um dos seguintes valores:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1054">It is one of the following values:</span></span><br /><br /> <span data-ttu-id="12fe9-1055">>> **pendente**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1055">>> **pending**.</span></span> <span data-ttu-id="12fe9-1056">Esperando por um thread de trabalho.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1056">Waiting for a worker thread.</span></span><br /><br /> <span data-ttu-id="12fe9-1057">>> **executável**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1057">>> **runnable**.</span></span> <span data-ttu-id="12fe9-1058">Pronto para ser executado, mas esperando por um quantum.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1058">Ready to run but waiting for a quantum.</span></span><br /><br /> <span data-ttu-id="12fe9-1059">>> **em execução**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1059">>> **running**.</span></span> <span data-ttu-id="12fe9-1060">Atualmente em execução no agendador.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1060">Currently running on the scheduler.</span></span><br /><br /> <span data-ttu-id="12fe9-1061">>> **suspenso**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1061">>> **suspended**.</span></span> <span data-ttu-id="12fe9-1062">A execução está suspensa.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1062">Execution is suspended.</span></span><br /><br /> <span data-ttu-id="12fe9-1063">>> **concluído**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1063">>> **done**.</span></span> <span data-ttu-id="12fe9-1064">A tarefa foi concluída.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1064">Task has completed.</span></span><br /><br /> <span data-ttu-id="12fe9-1065">>> **spinloop**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1065">>> **spinloop**.</span></span> <span data-ttu-id="12fe9-1066">Esperando que um spinlock seja liberado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1066">Waiting for a spinlock to become free.</span></span><br /><br /> <span data-ttu-id="12fe9-1067">**waitresource**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1067">**waitresource**.</span></span> <span data-ttu-id="12fe9-1068">O recurso exigido pela tarefa.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1068">The resource needed by the task.</span></span><br /><br /> <span data-ttu-id="12fe9-1069">**waittime**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1069">**waittime**.</span></span> <span data-ttu-id="12fe9-1070">O tempo em milissegundos de espera pelo recurso.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1070">Time in milliseconds waiting for the resource.</span></span><br /><br /> <span data-ttu-id="12fe9-1071">**schedulerid**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1071">**schedulerid**.</span></span> <span data-ttu-id="12fe9-1072">O agendador associado à essa tarefa.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1072">Scheduler associated with this task.</span></span> <span data-ttu-id="12fe9-1073">Veja [sys.dm_os_schedulers &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-schedulers-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1073">See [sys.dm_os_schedulers &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-schedulers-transact-sql).</span></span><br /><br /> <span data-ttu-id="12fe9-1074">**hostname**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1074">**hostname**.</span></span> <span data-ttu-id="12fe9-1075">O nome da estação de trabalho.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1075">The name of the workstation.</span></span><br /><br /> <span data-ttu-id="12fe9-1076">**isolationlevel**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1076">**isolationlevel**.</span></span> <span data-ttu-id="12fe9-1077">O nível de isolamento da transação atual.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1077">The current transaction isolation level.</span></span><br /><br /> <span data-ttu-id="12fe9-1078">**Xactid**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1078">**Xactid**.</span></span> <span data-ttu-id="12fe9-1079">A ID da transação que tem controle da solicitação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1079">The ID of the transaction that has control of the request.</span></span><br /><br /> <span data-ttu-id="12fe9-1080">**currentdb**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1080">**currentdb**.</span></span> <span data-ttu-id="12fe9-1081">A ID do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1081">The ID of the database.</span></span><br /><br /> <span data-ttu-id="12fe9-1082">**lastbatchstarted**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1082">**lastbatchstarted**.</span></span> <span data-ttu-id="12fe9-1083">A última vez em que um processo cliente iniciou uma execução em lote.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1083">The last time a client process started batch execution.</span></span><br /><br /> <span data-ttu-id="12fe9-1084">**lastbatchcompleted**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1084">**lastbatchcompleted**.</span></span> <span data-ttu-id="12fe9-1085">A última vez em que um processo cliente concluiu uma execução em lote.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1085">The last time a client process completed batch execution.</span></span><br /><br /> <span data-ttu-id="12fe9-1086">**clientoption1 e clientoption2**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1086">**clientoption1 and clientoption2**.</span></span> <span data-ttu-id="12fe9-1087">Defina as opções nessa conexão de cliente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1087">Set options on this client connection.</span></span> <span data-ttu-id="12fe9-1088">Esse é um bitmask que inclui informações sobre opções normalmente controladas por instruções SET, como SET NOCOUNT e SET XACTABORT.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1088">This is a bitmask that includes information about options usually controlled by SET statements such as SET NOCOUNT and SET XACTABORT.</span></span><br /><br /> <span data-ttu-id="12fe9-1089">**associatedObjectId**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1089">**associatedObjectId**.</span></span> <span data-ttu-id="12fe9-1090">Representa a ID de HoBT (heap ou árvore B).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1090">Represents the HoBT (heap or b-tree) ID.</span></span>|  
|<span data-ttu-id="12fe9-1091">Atributos do recurso</span><span class="sxs-lookup"><span data-stu-id="12fe9-1091">Resource attributes</span></span>|<span data-ttu-id="12fe9-1092">**RID**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1092">**RID**.</span></span> <span data-ttu-id="12fe9-1093">Identifica a única linha dentro de uma tabela na qual um bloqueio é mantido ou solicitado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1093">Identifies the single row within a table on which a lock is held or requested.</span></span> <span data-ttu-id="12fe9-1094">RID é representado como RID: *db_id:file_id:page_no:row_no*.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1094">RID is represented as RID: *db_id:file_id:page_no:row_no*.</span></span> <span data-ttu-id="12fe9-1095">Por exemplo, `RID: 6:1:20789:0`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1095">For example, `RID: 6:1:20789:0`.</span></span><br /><br /> <span data-ttu-id="12fe9-1096">**OBJECT**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1096">**OBJECT**.</span></span> <span data-ttu-id="12fe9-1097">Identifica a tabela na qual um bloqueio é mantido ou solicitado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1097">Identifies the table on which a lock is held or requested.</span></span> <span data-ttu-id="12fe9-1098">OBJECT é representado como OBJECT: *db_id:object_id*.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1098">OBJECT is represented as OBJECT: *db_id:object_id*.</span></span> <span data-ttu-id="12fe9-1099">Por exemplo, `TAB: 6:2009058193`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1099">For example, `TAB: 6:2009058193`.</span></span><br /><br /> <span data-ttu-id="12fe9-1100">**KEY**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1100">**KEY**.</span></span> <span data-ttu-id="12fe9-1101">Identifica o intervalo de chave dentro de um índice em que um bloqueio é mantido ou solicitado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1101">Identifies the key range within an index on which a lock is held or requested.</span></span> <span data-ttu-id="12fe9-1102">KEY é representado como KEY: *db_id:hobt_id* (*o valor de hash da chave de índice*).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1102">KEY is represented as KEY: *db_id:hobt_id* (*index key hash value*).</span></span> <span data-ttu-id="12fe9-1103">Por exemplo, `KEY: 6:72057594057457664 (350007a4d329)`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1103">For example, `KEY: 6:72057594057457664 (350007a4d329)`.</span></span><br /><br /> <span data-ttu-id="12fe9-1104">**PAG**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1104">**PAG**.</span></span> <span data-ttu-id="12fe9-1105">Identifica o recurso de página no qual um bloqueio é mantido ou solicitado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1105">Identifies the page resource on which a lock is held or requested.</span></span> <span data-ttu-id="12fe9-1106">PAG é representado como PAG: *db_id:file_id:page_no*.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1106">PAG is represented as PAG: *db_id:file_id:page_no*.</span></span> <span data-ttu-id="12fe9-1107">Por exemplo, `PAG: 6:1:20789`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1107">For example, `PAG: 6:1:20789`.</span></span><br /><br /> <span data-ttu-id="12fe9-1108">**EXT**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1108">**EXT**.</span></span> <span data-ttu-id="12fe9-1109">Identifica a estrutura de extensão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1109">Identifies the extent structure.</span></span> <span data-ttu-id="12fe9-1110">EXT é representado como EXT: *db_id:file_id:extent_no*.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1110">EXT is represented as EXT: *db_id:file_id:extent_no*.</span></span> <span data-ttu-id="12fe9-1111">Por exemplo, `EXT: 6:1:9`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1111">For example, `EXT: 6:1:9`.</span></span><br /><br /> <span data-ttu-id="12fe9-1112">**DB**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1112">**DB**.</span></span> <span data-ttu-id="12fe9-1113">Identifica o bloqueio de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1113">Identifies the database lock.</span></span> <span data-ttu-id="12fe9-1114">**DB é representado de um dos seguintes modos:**</span><span class="sxs-lookup"><span data-stu-id="12fe9-1114">**DB is represented in one of the following ways:**</span></span><br /><br /> <span data-ttu-id="12fe9-1115">DB: *db_id*</span><span class="sxs-lookup"><span data-stu-id="12fe9-1115">DB: *db_id*</span></span><br /><br /> <span data-ttu-id="12fe9-1116">DB: *db_id*[BULK-OP-DB], que identifica o bloqueio de banco de dados feito pelo banco de dados de backup.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1116">DB: *db_id*[BULK-OP-DB], which identifies the database lock taken by the backup database.</span></span><br /><br /> <span data-ttu-id="12fe9-1117">DB: *db_id*[BULK-OP-LOG], que identifica o bloqueio feito pelo log de backup daquele banco de dados específico.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1117">DB: *db_id*[BULK-OP-LOG], which identifies the lock taken by the backup log for that particular database.</span></span><br /><br /> <span data-ttu-id="12fe9-1118">**APP**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1118">**APP**.</span></span> <span data-ttu-id="12fe9-1119">Identifica o bloqueio feito por um recurso de aplicativo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1119">Identifies the lock taken by an application resource.</span></span> <span data-ttu-id="12fe9-1120">APP é representado por APP: *lock_resource*.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1120">APP is represented as APP: *lock_resource*.</span></span> <span data-ttu-id="12fe9-1121">Por exemplo, `APP: Formf370f478`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1121">For example, `APP: Formf370f478`.</span></span><br /><br /> <span data-ttu-id="12fe9-1122">**METADATA**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1122">**METADATA**.</span></span> <span data-ttu-id="12fe9-1123">Representa os recursos de metadados envolvidos em um deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1123">Represents metadata resources involved in a deadlock.</span></span> <span data-ttu-id="12fe9-1124">Como METADATA tem muitos sub-recursos, o valor retornado depende do sub-recurso envolvido no deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1124">Because METADATA has many subresources, the value returned depends upon the subresource that has deadlocked.</span></span> <span data-ttu-id="12fe9-1125">Por exemplo, metadados. USER_TYPE retorna `user_type_id =` \<*integer_value*> .</span><span class="sxs-lookup"><span data-stu-id="12fe9-1125">For example, METADATA.USER_TYPE returns `user_type_id =` \<*integer_value*>.</span></span> <span data-ttu-id="12fe9-1126">Para obter mais informações sobre os recursos e sub-recursos METADATA, consulte [sys.DM tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1126">For more information about METADATA resources and subresources, see [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span></span><br /><br /> <span data-ttu-id="12fe9-1127">**HOBT**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1127">**HOBT**.</span></span> <span data-ttu-id="12fe9-1128">Representa um heap ou árvore B envolvida em um deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1128">Represents a heap or b-tree involved in a deadlock.</span></span>|<span data-ttu-id="12fe9-1129">Nenhum exclusivo para esse sinalizador de rastreamento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1129">None exclusive to this trace flag.</span></span>|<span data-ttu-id="12fe9-1130">Nenhum exclusivo para esse sinalizador de rastreamento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1130">None exclusive to this trace flag.</span></span>|  
  
###### <a name="trace-flag-1204-example"></a><span data-ttu-id="12fe9-1131">Exemplo do sinalizador de rastreamento 1204</span><span class="sxs-lookup"><span data-stu-id="12fe9-1131">Trace Flag 1204 Example</span></span>  

 <span data-ttu-id="12fe9-1132">O exemplo a seguir mostra a saída quando o sinalizador de rastreamento 1204 é ativado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1132">The following example shows the output when trace flag 1204 is turned on.</span></span> <span data-ttu-id="12fe9-1133">Neste caso, a tabela em Node 1 é um heap sem índices, e a tabela em Node 2 é um heap com índices não clusterizados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1133">In this case, the table in Node 1 is a heap with no indexes, and the table in Node 2 is a heap with a nonclustered index.</span></span> <span data-ttu-id="12fe9-1134">A chave de índice em Node 2 é atualizada quando o deadlock ocorre.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1134">The index key in Node 2 is being updated when the deadlock occurs.</span></span>  
  
```  
Deadlock encountered .... Printing deadlock information  
Wait-for graph  
  
Node:1  
  
RID: 6:1:20789:0               CleanCnt:3 Mode:X Flags: 0x2  
 Grant List 0:  
   Owner:0x0315D6A0 Mode: X          
     Flg:0x0 Ref:0 Life:02000000 SPID:55 ECID:0 XactLockInfo: 0x04D9E27C  
   SPID: 55 ECID: 0 Statement Type: UPDATE Line #: 6  
   Input Buf: Language Event:   
BEGIN TRANSACTION  
   EXEC usp_p2  
 Requested By:   
   ResType:LockOwner Stype:'OR'Xdes:0x03A3DAD0   
     Mode: U SPID:54 BatchID:0 ECID:0 TaskProxy:(0x04976374) Value:0x315d200 Cost:(0/868)  
  
Node:2  
  
KEY: 6:72057594057457664 (350007a4d329) CleanCnt:2 Mode:X Flags: 0x0  
 Grant List 0:  
   Owner:0x0315D140 Mode: X          
     Flg:0x0 Ref:0 Life:02000000 SPID:54 ECID:0 XactLockInfo: 0x03A3DAF4  
   SPID: 54 ECID: 0 Statement Type: UPDATE Line #: 6  
   Input Buf: Language Event:   
     BEGIN TRANSACTION  
       EXEC usp_p1  
 Requested By:   
   ResType:LockOwner Stype:'OR'Xdes:0x04D9E258   
     Mode: U SPID:55 BatchID:0 ECID:0 TaskProxy:(0x0475E374) Value:0x315d4a0 Cost:(0/380)  
  
Victim Resource Owner:  
 ResType:LockOwner Stype:'OR'Xdes:0x04D9E258   
     Mode: U SPID:55 BatchID:0 ECID:0 TaskProxy:(0x0475E374) Value:0x315d4a0 Cost:(0/380)  
```  
  
###### <a name="trace-flag-1222-example"></a><span data-ttu-id="12fe9-1135">Exemplo do sinalizador de rastreamento 1222</span><span class="sxs-lookup"><span data-stu-id="12fe9-1135">Trace Flag 1222 Example</span></span>  

 <span data-ttu-id="12fe9-1136">O exemplo a seguir mostra a saída quando o sinalizador de rastreamento 1222 é ativado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1136">The following example shows the output when trace flag 1222 is turned on.</span></span> <span data-ttu-id="12fe9-1137">Neste caso, uma tabela é um heap sem índices, e a outra tabela é um heap com um índice não clusterizado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1137">In this case, one table is a heap with no indexes, and the other table is a heap with a nonclustered index.</span></span> <span data-ttu-id="12fe9-1138">Na segunda tabela, a chave de índice é atualizada quando o deadlock ocorre.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1138">In the second table, the index key is being updated when the deadlock occurs.</span></span>  
  
```  
deadlock-list  
 deadlock victim=process689978  
  process-list  
   process id=process6891f8 taskpriority=0 logused=868   
   waitresource=RID: 6:1:20789:0 waittime=1359 ownerId=310444   
   transactionname=user_transaction   
   lasttranstarted=2005-09-05T11:22:42.733 XDES=0x3a3dad0   
   lockMode=U schedulerid=1 kpid=1952 status=suspended spid=54   
   sbid=0 ecid=0 priority=0 transcount=2   
   lastbatchstarted=2005-09-05T11:22:42.733   
   lastbatchcompleted=2005-09-05T11:22:42.733   
   clientapp=Microsoft SQL Server Management Studio - Query   
   hostname=TEST_SERVER hostpid=2216 loginname=DOMAIN\user   
   isolationlevel=read committed (2) xactid=310444 currentdb=6   
   lockTimeout=4294967295 clientoption1=671090784 clientoption2=390200  
    executionStack  
     frame procname=AdventureWorks2012.dbo.usp_p1 line=6 stmtstart=202   
     sqlhandle=0x0300060013e6446b027cbb00c69600000100000000000000  
     UPDATE T2 SET COL1 = 3 WHERE COL1 = 1;       
     frame procname=adhoc line=3 stmtstart=44   
     sqlhandle=0x01000600856aa70f503b8104000000000000000000000000  
     EXEC usp_p1       
    inputbuf  
      BEGIN TRANSACTION  
       EXEC usp_p1  
   process id=process689978 taskpriority=0 logused=380   
   waitresource=KEY: 6:72057594057457664 (350007a4d329)     
   waittime=5015 ownerId=310462 transactionname=user_transaction   
   lasttranstarted=2005-09-05T11:22:44.077 XDES=0x4d9e258 lockMode=U   
   schedulerid=1 kpid=3024 status=suspended spid=55 sbid=0 ecid=0   
   priority=0 transcount=2 lastbatchstarted=2005-09-05T11:22:44.077   
   lastbatchcompleted=2005-09-05T11:22:44.077   
   clientapp=Microsoft SQL Server Management Studio - Query   
   hostname=TEST_SERVER hostpid=2216 loginname=DOMAIN\user   
   isolationlevel=read committed (2) xactid=310462 currentdb=6   
   lockTimeout=4294967295 clientoption1=671090784 clientoption2=390200  
    executionStack  
     frame procname=AdventureWorks2012.dbo.usp_p2 line=6 stmtstart=200   
     sqlhandle=0x030006004c0a396c027cbb00c69600000100000000000000  
     UPDATE T1 SET COL1 = 4 WHERE COL1 = 1;       
     frame procname=adhoc line=3 stmtstart=44   
     sqlhandle=0x01000600d688e709b85f8904000000000000000000000000  
     EXEC usp_p2       
    inputbuf  
      BEGIN TRANSACTION  
        EXEC usp_p2      
  resource-list  
   ridlock fileid=1 pageid=20789 dbid=6 objectname=AdventureWorks2012.dbo.T2   
   id=lock3136940 mode=X associatedObjectId=72057594057392128  
    owner-list  
     owner id=process689978 mode=X  
    waiter-list  
     waiter id=process6891f8 mode=U requestType=wait  
   keylock hobtid=72057594057457664 dbid=6 objectname=AdventureWorks2012.dbo.T1   
   indexname=nci_T1_COL1 id=lock3136fc0 mode=X   
   associatedObjectId=72057594057457664  
    owner-list  
     owner id=process6891f8 mode=X  
    waiter-list  
     waiter id=process689978 mode=U requestType=wait  
```  
  
###### <a name="profiler-deadlock-graph-event"></a><span data-ttu-id="12fe9-1139">Evento gráfico de deadlock de designer de perfil</span><span class="sxs-lookup"><span data-stu-id="12fe9-1139">Profiler Deadlock Graph Event</span></span>  

 <span data-ttu-id="12fe9-1140">Este é um evento do [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] que apresenta uma representação gráfica das tarefas e recursos envolvidos em um deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1140">This is an event in [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] that presents a graphical depiction of the tasks and resources involved in a deadlock.</span></span> <span data-ttu-id="12fe9-1141">O exemplo a seguir mostra a saída do [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] quando o evento de gráfico de deadlock é ativado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1141">The following example shows the output from [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] when the deadlock graph event is turned on.</span></span>  
  
 <span data-ttu-id="12fe9-1142">![Diagrama de fluxo lógico mostrando deadlock de processo do usuário.](media/udb9-profilerdeadlockgraphc.gif "Diagrama de fluxo lógico mostrando deadlock de processo do usuário.")</span><span class="sxs-lookup"><span data-stu-id="12fe9-1142">![Logic flow diagram showing user process deadlock.](media/udb9-profilerdeadlockgraphc.gif "Logic flow diagram showing user process deadlock.")</span></span>  
  
 <span data-ttu-id="12fe9-1143">Para obter mais informações sobre como executar o [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] grafo de deadlock, consulte [salvar grafos de deadlock &#40;SQL Server Profiler&#41;](../relational-databases/performance/save-deadlock-graphs-sql-server-profiler.md).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1143">For more information about running the [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] deadlock graph, see [Save Deadlock Graphs &#40;SQL Server Profiler&#41;](../relational-databases/performance/save-deadlock-graphs-sql-server-profiler.md).</span></span>  
  
#### <a name="handling-deadlocks"></a><span data-ttu-id="12fe9-1144">Manipulando deadlocks</span><span class="sxs-lookup"><span data-stu-id="12fe9-1144">Handling Deadlocks</span></span>  

 <span data-ttu-id="12fe9-1145">Quando uma instância do [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] escolhe uma transação como vítima do deadlock, ela encerra o lote atual, reverte a transação e retorna a mensagem de erro 1205 ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1145">When an instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] chooses a transaction as a deadlock victim, it terminates the current batch, rolls back the transaction, and returns error message 1205 to the application.</span></span>  
  
 `Your transaction (process ID #52) was deadlocked on {lock | communication buffer | thread} resources with another process and has been chosen as the deadlock victim. Rerun your transaction.`  
  
 <span data-ttu-id="12fe9-1146">Como qualquer aplicativo que envia consultas [!INCLUDE[tsql](../includes/tsql-md.md)] pode ser escolhido como vítima de deadlock, os aplicativos deverão ter um manipulador de erros que possa interceptar a mensagem de erro 1205.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1146">Because any application submitting [!INCLUDE[tsql](../includes/tsql-md.md)] queries can be chosen as the deadlock victim, applications should have an error handler that can trap error message 1205.</span></span> <span data-ttu-id="12fe9-1147">Se um aplicativo não interceptar o erro, o aplicativo poderá prosseguir sem saber que sua transação foi revertida e que erros podem ocorrer.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1147">If an application does not trap the error, the application can proceed unaware that its transaction has been rolled back and errors can occur.</span></span>  
  
 <span data-ttu-id="12fe9-1148">A implementação de um manipulador de erros que intercepte a mensagem de erro 1205 permite que um aplicativo manipule a situação de deadlock e tome uma ação paliativa (por exemplo, enviar automaticamente de novo a consulta que estava envolvida no deadlock).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1148">Implementing an error handler that traps error message 1205 allows an application to handle the deadlock situation and take remedial action (for example, automatically resubmitting the query that was involved in the deadlock).</span></span> <span data-ttu-id="12fe9-1149">Ao enviar a consulta novamente de forma automática, o usuário não precisa saber que ocorreu um deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1149">By resubmitting the query automatically, the user does not need to know that a deadlock occurred.</span></span>  
  
 <span data-ttu-id="12fe9-1150">O aplicativo deveria pausar brevemente antes de enviar novamente a consulta.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1150">The application should pause briefly before resubmitting its query.</span></span> <span data-ttu-id="12fe9-1151">Isso dá a outra transação envolvida no deadlock uma chance para completar e liberar seus bloqueios que formaram parte do ciclo de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1151">This gives the other transaction involved in the deadlock a chance to complete and release its locks that formed part of the deadlock cycle.</span></span> <span data-ttu-id="12fe9-1152">Isso minimiza a probabilidade do deadlock ocorrer novamente quando a consulta reenviada solicitar seus bloqueios.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1152">This minimizes the likelihood of the deadlock reoccurring when the resubmitted query requests its locks.</span></span>  
  
#### <a name="minimizing-deadlocks"></a><span data-ttu-id="12fe9-1153">Minimizando deadlocks</span><span class="sxs-lookup"><span data-stu-id="12fe9-1153">Minimizing Deadlocks</span></span>  

 <span data-ttu-id="12fe9-1154">Embora deadlocks não possam ser completamente evitados, seguir certas convenções de codificação pode minimizar a chance de gerar um deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1154">Although deadlocks cannot be completely avoided, following certain coding conventions can minimize the chance of generating a deadlock.</span></span> <span data-ttu-id="12fe9-1155">Minimizar deadlocks pode aumentar a taxa de transferência da transação e pode reduzir a sobrecarga do sistema pois poucas transações são:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1155">Minimizing deadlocks can increase transaction throughput and reduce system overhead because fewer transactions are:</span></span>  
  
-   <span data-ttu-id="12fe9-1156">Revertidas, desfazendo todo o trabalho executado pela transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1156">Rolled back, undoing all the work performed by the transaction.</span></span>  
  
-   <span data-ttu-id="12fe9-1157">Reenviadas por aplicativos pois elas foram revertidas quando bloqueadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1157">Resubmitted by applications because they were rolled back when deadlocked.</span></span>  
  
 <span data-ttu-id="12fe9-1158">Para ajudar a minimizar deadlocks:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1158">To help minimize deadlocks:</span></span>  
  
-   <span data-ttu-id="12fe9-1159">Acesse objetos na mesma ordem.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1159">Access objects in the same order.</span></span>  
  
-   <span data-ttu-id="12fe9-1160">Evite a interação de usuário durante as transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1160">Avoid user interaction in transactions.</span></span>  
  
-   <span data-ttu-id="12fe9-1161">Mantenha as transações curtas e em um lote.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1161">Keep transactions short and in one batch.</span></span>  
  
-   <span data-ttu-id="12fe9-1162">Use um nível de isolamento inferior.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1162">Use a lower isolation level.</span></span>  
  
-   <span data-ttu-id="12fe9-1163">Use um nível de isolamento com base em controle de versão de linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-1163">Use a row versioning-based isolation level.</span></span>  
  
    -   <span data-ttu-id="12fe9-1164">Configure a opção de banco de dados READ_COMMITTED_SNAPSHOT em ON, para habilitar que as transações de leitura confirmada utilizem controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1164">Set READ_COMMITTED_SNAPSHOT database option ON to enable read-committed transactions to use row versioning.</span></span>  
  
    -   <span data-ttu-id="12fe9-1165">Use transação de isolamento de instantâneo</span><span class="sxs-lookup"><span data-stu-id="12fe9-1165">Use snapshot isolation.</span></span>  
  
-   <span data-ttu-id="12fe9-1166">Use associações de saída.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1166">Use bound connections.</span></span>  
  
##### <a name="access-objects-in-the-same-order"></a><span data-ttu-id="12fe9-1167">Acesse objetos na mesma ordem.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1167">Access Objects in the Same Order</span></span>  

 <span data-ttu-id="12fe9-1168">Se todas as transações simultâneas acessarem objetos na mesma ordem, haverá menos chance de ocorrerem deadlocks.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1168">If all concurrent transactions access objects in the same order, deadlocks are less likely to occur.</span></span> <span data-ttu-id="12fe9-1169">Por exemplo, se duas transações simultâneas obtiverem um bloqueio na tabela **Supplier** e depois na tabela **Part**, uma transação será bloqueada na tabela **Supplier** até que a outra transação seja concluída.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1169">For example, if two concurrent transactions obtain a lock on the **Supplier** table and then on the **Part** table, one transaction is blocked on the **Supplier** table until the other transaction is completed.</span></span> <span data-ttu-id="12fe9-1170">Após a primeira transação ser confirmada ou revertida, a segunda continua e um deadlock não acontece.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1170">After the first transaction commits or rolls back, the second continues, and a deadlock does not occur.</span></span> <span data-ttu-id="12fe9-1171">Usar procedimentos armazenados para todas as modificações de dados pode padronizar a ordem de acesso dos objetos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1171">Using stored procedures for all data modifications can standardize the order of accessing objects.</span></span>  
  
 <span data-ttu-id="12fe9-1172">![Diagrama mostrando impedimento do deadlock de transação](media/dedlck2.gif "Diagrama mostrando impedimento do deadlock de transação")</span><span class="sxs-lookup"><span data-stu-id="12fe9-1172">![Diagram showing deadlock avoidance](media/dedlck2.gif "Diagram showing deadlock avoidance")</span></span>  
  
##### <a name="avoid-user-interaction-in-transactions"></a><span data-ttu-id="12fe9-1173">Evite usar interação nas transações</span><span class="sxs-lookup"><span data-stu-id="12fe9-1173">Avoid User Interaction in Transactions</span></span>  

 <span data-ttu-id="12fe9-1174">Evite escrever transações que incluam interação de usuário, pois a velocidade de lotes executados sem intervenção de usuário é muito mais rápida que a velocidade que um usuário deve responder manualmente às consultas, como por exemplo, responder a um prompt para um parâmetro solicitado por um aplicativo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1174">Avoid writing transactions that include user interaction, because the speed of batches running without user intervention is much faster than the speed at which a user must manually respond to queries, such as replying to a prompt for a parameter requested by an application.</span></span> <span data-ttu-id="12fe9-1175">Por exemplo, se uma transação estiver esperando por entrada de usuário e o usuário sai para almoçar ou vai para casa durante o fim de semana, esse mesmo usuário atrasa o término da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1175">For example, if a transaction is waiting for user input and the user goes to lunch or even home for the weekend, the user delays the transaction from completing.</span></span> <span data-ttu-id="12fe9-1176">Isto degrada a taxa de transferência do sistema, pois quaisquer bloqueios mantidos pela transação somente são liberados quando a transação é confirmada ou revertida.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1176">This degrades system throughput because any locks held by the transaction are released only when the transaction is committed or rolled back.</span></span> <span data-ttu-id="12fe9-1177">Até mesmo se uma situação de deadlock não surgir, outras transações que acessem os mesmos recursos serão bloqueadas enquanto esperam pela conclusão da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1177">Even if a deadlock situation does not arise, other transactions accessing the same resources are blocked while waiting for the transaction to complete.</span></span>  
  
##### <a name="keep-transactions-short-and-in-one-batch"></a><span data-ttu-id="12fe9-1178">Mantenha as transações curtas e em um lote.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1178">Keep Transactions Short and in One Batch</span></span>  

 <span data-ttu-id="12fe9-1179">Um deadlock ocorre tipicamente quando várias transações demoradas são executadas simultaneamente no mesmo banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1179">A deadlock typically occurs when several long-running transactions execute concurrently in the same database.</span></span> <span data-ttu-id="12fe9-1180">Quanto mais longa a transação, por mais tempo as atualizações e bloqueios exclusivos são mantidos, bloqueando outras atividades, e levando à possíveis situações de deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1180">The longer the transaction, the longer the exclusive or update locks are held, blocking other activity and leading to possible deadlock situations.</span></span>  
  
 <span data-ttu-id="12fe9-1181">Manter as transações em um lote minimiza as viagens de ida-e-volta de rede durante uma transação, reduzindo possíveis retardos ao completar a transação e liberando bloqueios.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1181">Keeping transactions in one batch minimizes network roundtrips during a transaction, reducing possible delays in completing the transaction and releasing locks.</span></span>  
  
##### <a name="use-a-lower-isolation-level"></a><span data-ttu-id="12fe9-1182">Use um nível inferior de isolamento</span><span class="sxs-lookup"><span data-stu-id="12fe9-1182">Use a Lower Isolation Level</span></span>  

 <span data-ttu-id="12fe9-1183">Determine se uma transação pode ser executada em um nível inferior de isolamento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1183">Determine whether a transaction can run at a lower isolation level.</span></span> <span data-ttu-id="12fe9-1184">Implementar confirmação por leitura permite que uma transação leia dados lidos anteriormente (não modificados) por outra transação, sem esperar pela conclusão da primeira transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1184">Implementing read committed allows a transaction to read data previously read (not modified) by another transaction without waiting for the first transaction to complete.</span></span> <span data-ttu-id="12fe9-1185">Usar um nível de isolamento inferior, como a leitura confirmada, mantém bloqueios compartilhados por uma período mais curto que um nível de isolamento maior, como o serializável.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1185">Using a lower isolation level, such as read committed, holds shared locks for a shorter duration than a higher isolation level, such as serializable.</span></span> <span data-ttu-id="12fe9-1186">Isto reduz a contenção de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1186">This reduces locking contention.</span></span>  
  
##### <a name="use-a-row-versioning-based-isolation-level"></a><span data-ttu-id="12fe9-1187">Use um nível de isolamento com base em controle de versão de linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-1187">Use a Row Versioning-based Isolation Level</span></span>  

 <span data-ttu-id="12fe9-1188">Quando a opção READ_COMMITTED_SNAPSHOT do banco de dados é configurada em ON, uma transação em execução sob o nível de isolamento de leitura confirmada utiliza controle de versão de linha em vez de bloqueios compartilhados durante operações de leitura.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1188">When the READ_COMMITTED_SNAPSHOT database option is set ON, a transaction running under read committed isolation level uses row versioning rather than shared locks during read operations.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-1189">Alguns aplicativos dependem de um comportamento de bloqueio e desbloqueio de isolamento confirmado por leitura.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1189">Some applications rely upon locking and blocking behavior of read committed isolation.</span></span> <span data-ttu-id="12fe9-1190">Para estes aplicativos, algumas alterações são necessárias antes que essa opção possa ser habilitada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1190">For these applications, some change is required before this option can be enabled.</span></span>  
  
 <span data-ttu-id="12fe9-1191">O isolamento de instantâneo também usa controle de versão de linha, o qual não usa bloqueios compartilhados durante operações de leitura.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1191">Snapshot isolation also uses row versioning, which does not use shared locks during read operations.</span></span> <span data-ttu-id="12fe9-1192">Antes que uma transação possa ser executada sob um isolamento de instantâneo, a opção ALLOW_SNAPSHOT_ISOLATION do banco de dados deve ser configurada em ON.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1192">Before a transaction can run under snapshot isolation, the ALLOW_SNAPSHOT_ISOLATION database option must be set ON.</span></span>  
  
 <span data-ttu-id="12fe9-1193">Implemente estes níveis de isolamento para minimizar deadlocks, que podem ocorrer entre as operações de leitura e gravação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1193">Implement these isolation levels to minimize deadlocks that can occur between read and write operations.</span></span>  
  
##### <a name="use-bound-connections"></a><span data-ttu-id="12fe9-1194">Use associações de saída.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1194">Use Bound Connections</span></span>  

 <span data-ttu-id="12fe9-1195">Usar associações de saída usando, faz com que duas ou mais conexões abertas pelo mesmo aplicativo possam cooperar entre si.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1195">Using bound connections, two or more connections opened by the same application can cooperate with each other.</span></span> <span data-ttu-id="12fe9-1196">Qualquer bloqueio adquirido pelas conexões secundárias é mantido como se tivessem sido adquiridos pela conexão primária, e vice-versa.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1196">Any locks acquired by the secondary connections are held as if they were acquired by the primary connection, and vice versa.</span></span> <span data-ttu-id="12fe9-1197">Portanto, eles não bloqueiam um ao outro.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1197">Therefore they do not block each other.</span></span>  
  
### <a name="lock-partitioning"></a><span data-ttu-id="12fe9-1198">Particionamento de bloqueio</span><span class="sxs-lookup"><span data-stu-id="12fe9-1198">Lock Partitioning</span></span>  

 <span data-ttu-id="12fe9-1199">Para os grandes sistemas de computador, bloqueios em objetos que são referenciados com frequência podem se tornar um gargalo de desempenho, uma vez que a aquisição e liberação de bloqueios produz contenções em recursos de bloqueios internos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1199">For large computer systems, locks on frequently referenced objects can become a performance bottleneck as acquiring and releasing locks place contention on internal locking resources.</span></span> <span data-ttu-id="12fe9-1200">O particionamento de bloqueio melhora o desempenho do bloqueio dividindo um único recurso de bloqueio em vários recursos de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1200">Lock partitioning enhances locking performance by splitting a single lock resource into multiple lock resources.</span></span> <span data-ttu-id="12fe9-1201">Esse recurso só está disponível para sistemas com 16 ou mais CPUs, é habilitado automaticamente e não pode ser desabilitado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1201">This feature is only available for systems with 16 or more CPUs, and is automatically enabled and cannot be disabled.</span></span> <span data-ttu-id="12fe9-1202">Apenas os bloqueios de objeto podem ser particionados. Os bloqueios de objeto que têm um subtipo não são particionados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1202">Only object locks can be partitioned.Object locks that have a subtype are not partitioned.</span></span> <span data-ttu-id="12fe9-1203">Para obter mais informações, consulte [sys.DM tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1203">For more information, see [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span></span>  
  
#### <a name="understanding-lock-partitioning"></a><span data-ttu-id="12fe9-1204">Compreendendo o particionamento de bloqueio</span><span class="sxs-lookup"><span data-stu-id="12fe9-1204">Understanding Lock Partitioning</span></span>  

 <span data-ttu-id="12fe9-1205">As tarefas de bloqueio acessam vários recursos compartilhados, dois dos quais são otimizados através de particionamento de bloqueio:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1205">Locking tasks access several shared resources, two of which are optimized by lock partitioning:</span></span>  
  
-   <span data-ttu-id="12fe9-1206">**Spinlock**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1206">**Spinlock**.</span></span> <span data-ttu-id="12fe9-1207">Controla o acesso a um recurso de bloqueio, como uma linha ou uma tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1207">This controls access to a lock resource, such as a row or a table.</span></span>  
  
     <span data-ttu-id="12fe9-1208">Sem particionamento de bloqueio, um spinlock gerencia todas as solicitações de bloqueio para um único recurso de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1208">Without lock partitioning, one spinlock manages all lock requests for a single lock resource.</span></span> <span data-ttu-id="12fe9-1209">Em sistemas que têm um grande volume de atividade, a contenção pode acontecer enquanto as solicitações de bloqueio esperam que o spinlock fique disponível.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1209">On systems that experience a large volume of activity, contention can occur as lock requests wait for the spinlock to become available.</span></span> <span data-ttu-id="12fe9-1210">Nessa situação, adquirir bloqueios pode se converter em um gargalo e ter um impacto negativo no desempenho.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1210">Under this situation, acquiring locks can become a bottleneck and can negatively impact performance.</span></span>  
  
     <span data-ttu-id="12fe9-1211">Para reduzir a contenção em um único recurso de bloqueio, o particionamento de bloqueio divide um único recurso de bloqueio em vários recursos de bloqueio para distribuir a carga através de vários spinlocks.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1211">To reduce contention on a single lock resource, lock partitioning splits a single lock resource into multiple lock resources to distribute the load across multiple spinlocks.</span></span>  
  
-   <span data-ttu-id="12fe9-1212">**Memória**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1212">**Memory**.</span></span> <span data-ttu-id="12fe9-1213">É usada para armazenar as estruturas de recurso de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1213">This is used to store the lock resource structures.</span></span>  
  
     <span data-ttu-id="12fe9-1214">Depois que o spinlock é adquirido, são armazenadas estruturas de bloqueio na memória, que então são acessadas e eventualmente modificadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1214">Once the spinlock is acquired, lock structures are stored in memory and then accessed and possibly modified.</span></span> <span data-ttu-id="12fe9-1215">Distribuir acesso de bloqueio através de vários recursos ajuda eliminar a necessidade de transferir blocos de memória entre CPUs, que ajudará melhorar o desempenho.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1215">Distributing lock access across multiple resources helps to eliminate the need to transfer memory blocks between CPUs, which will help to improve performance.</span></span>  
  
#### <a name="implementing-and-monitoring-lock-partitioning"></a><span data-ttu-id="12fe9-1216">Implementando e monitorando o particionamento de bloqueio</span><span class="sxs-lookup"><span data-stu-id="12fe9-1216">Implementing and Monitoring Lock Partitioning</span></span>  

 <span data-ttu-id="12fe9-1217">O particionamento de bloqueio é ativado por padrão para sistemas com 16 ou mais CPUs.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1217">Lock partitioning is turned on by default for systems with 16 or more CPUs.</span></span> <span data-ttu-id="12fe9-1218">Quando o particionamento de bloqueio é habilitado, uma mensagem informativa é registrada no log de erros do [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-1218">When lock partitioning is enabled, an informational message is recorded in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] error log.</span></span>  
  
 <span data-ttu-id="12fe9-1219">Ao adquirir bloqueios em um recurso particionado:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1219">When acquiring locks on a partitioned resource:</span></span>  
  
-   <span data-ttu-id="12fe9-1220">Só os modos de bloqueio NL, SCH-S, IS, IU e IX modos são adquiridos em uma única partição.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1220">Only NL, SCH-S, IS, IU, and IX lock modes are acquired on a single partition.</span></span>  
  
-   <span data-ttu-id="12fe9-1221">Bloqueios S (Shared), X (Exclusive) e outros bloqueios em modos diferentes de NL, SCH-S, IS, IU e IX em todas as partições iniciando com partição ID 0 e seguindo na partição a ordem de ID.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1221">Shared (S), exclusive (X), and other locks in modes other than NL, SCH-S, IS, IU, and IX must be acquired on all partitions starting with partition ID 0 and following in partition ID order.</span></span> <span data-ttu-id="12fe9-1222">Esses bloqueios em um recurso particionado usarão mais memória que os bloqueios, no mesmo modo, em um recurso não particionado, desde que cada partição seja efetivamente um bloqueio separado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1222">These locks on a partitioned resource will use more memory than locks in the same mode on a non-partitioned resource since each partition is effectively a separate lock.</span></span> <span data-ttu-id="12fe9-1223">O aumento de memória é determinado pelo número de partições.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1223">The memory increase is determined by the number of partitions.</span></span> <span data-ttu-id="12fe9-1224">Os contadores de bloqueio do [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] no Monitor de Desempenho do Windows exibirão informações sobre a memória usada em bloqueios particionados e não particionados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1224">The [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] lock counters in the Windows Performance Monitor will display information about memory used by partitioned and non-partitioned locks.</span></span>  
  
 <span data-ttu-id="12fe9-1225">Uma transação é atribuída a uma partição quando a transação inicia.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1225">A transaction is assigned to a partition when the transaction starts.</span></span> <span data-ttu-id="12fe9-1226">Para a transação, todas as solicitações de bloqueio que podem ser particionadas usam a partição atribuída a essa transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1226">For the transaction, all lock requests that can be partitioned use the partition assigned to that transaction.</span></span> <span data-ttu-id="12fe9-1227">Por esse método, o acesso para bloquear recursos do mesmo objeto através de transações diferentes é distribuído através de diferentes partições.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1227">By this method, access to lock resources of the same object by different transactions is distributed across different partitions.</span></span>  
  
 <span data-ttu-id="12fe9-1228">A coluna resource_lock_partition no sys.dm_tran_locks da Exibição de Gerenciamento Dinâmico fornece o ID da partição de bloqueio para um recurso de bloqueio particionado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1228">The resource_lock_partition column in the sys.dm_tran_locks Dynamic Management View provides the lock partition ID for a lock partitioned resource.</span></span> <span data-ttu-id="12fe9-1229">Para obter mais informações, consulte [sys.DM tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1229">For more information, see [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span></span>  
  
 <span data-ttu-id="12fe9-1230">A coluna de BigintData1 fornece o ID da partição de bloqueio para o recurso de bloqueio particionado no evento de Bloqueios do [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-1230">Under the Locks event in [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)], the BigintData1 column provides the lock partition ID for a lock partitioned resource.</span></span>  
  
#### <a name="working-with-lock-partitioning"></a><span data-ttu-id="12fe9-1231">Trabalhando com particionamento de bloqueio</span><span class="sxs-lookup"><span data-stu-id="12fe9-1231">Working with Lock Partitioning</span></span>  

 <span data-ttu-id="12fe9-1232">Os exemplos de código a seguir ilustram o particionamento de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1232">The following code examples illustrate lock partitioning.</span></span> <span data-ttu-id="12fe9-1233">Nos exemplos, são executadas duas transações em duas sessões diferentes para mostrar o comportamento de particionamento de bloqueio em um sistema de computador com 16 CPUs.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1233">In the examples, two transactions are executed in two different sessions in order to show lock partitioning behavior on a computer system with 16 CPUs.</span></span>  
  
 <span data-ttu-id="12fe9-1234">Estas instruções [!INCLUDE[tsql](../includes/tsql-md.md)] criam objetos de teste que são usados nos exemplos a seguir.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1234">These [!INCLUDE[tsql](../includes/tsql-md.md)] statements create test objects that are used in the examples that follow.</span></span>  
  
```sql  
-- Create a test table.  
CREATE TABLE TestTable  
    (col1        int);  
GO  
  
-- Create a clustered index on the table.  
CREATE CLUSTERED INDEX ci_TestTable   
    ON TestTable (col1);  
GO  
  
-- Populate the table.  
INSERT INTO TestTable VALUES (1);  
GO  
```  
  
##### <a name="example-a"></a><span data-ttu-id="12fe9-1235">Exemplo A</span><span class="sxs-lookup"><span data-stu-id="12fe9-1235">Example A</span></span>  

 <span data-ttu-id="12fe9-1236">Sessão 1:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1236">Session 1:</span></span>  
  
 <span data-ttu-id="12fe9-1237">Uma instrução `SELECT` é executada em uma transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1237">A `SELECT` statement is executed under a transaction.</span></span> <span data-ttu-id="12fe9-1238">Devido à dica de bloqueio `HOLDLOCK`, essa instrução adquirirá e reterá um bloqueio IS (Intencional compartilhado) na tabela (para efeitos de ilustração, são ignorados os bloqueios de linha e de página).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1238">Because of the `HOLDLOCK` lock hint, this statement will acquire and retain an Intent shared (IS) lock on the table (for this illustration, row and page locks are ignored).</span></span> <span data-ttu-id="12fe9-1239">O bloqueio IS só será adquirido na partição atribuída à transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1239">The IS lock will be acquired only on the partition assigned to the transaction.</span></span> <span data-ttu-id="12fe9-1240">Para este exemplo, supõe-se que o bloqueio IS é adquirido na ID 7 da partição.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1240">For this example, it is assumed that the IS lock is acquired on partition ID 7.</span></span>  
  
```sql  
-- Start a transaction.  
BEGIN TRANSACTION  
    -- This SELECT statement will acquire an IS lock on the table.  
    SELECT col1  
        FROM TestTable  
        WITH (HOLDLOCK);  
```  
  
 <span data-ttu-id="12fe9-1241">Sessão 2:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1241">Session 2:</span></span>  
  
 <span data-ttu-id="12fe9-1242">Uma transação é iniciada e a instrução `SELECT` que executa sob essa transação adquirirá e reterá um bloqueio S (compartilhado) na tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1242">A transaction is started, and the `SELECT` statement running under this transaction will acquire and retain a shared (S) lock on the table.</span></span> <span data-ttu-id="12fe9-1243">O bloqueio S será adquirido em todas as partições que resultem em vários bloqueios de tabela, um para cada partição.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1243">The S lock will be acquired on all partitions which results in multiple table locks, one for each partition.</span></span> <span data-ttu-id="12fe9-1244">Por exemplo, em um sistema com 16 CPUs, 16 bloqueios S serão emitidos através de os IDs de partição 0-15.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1244">For example, on a 16-cpu system, 16 S locks will be issued across lock partition IDs 0-15.</span></span> <span data-ttu-id="12fe9-1245">Como o bloqueio S é compatível com o bloqueio de IS, que é mantido na ID 7 da partição pela transação na sessão 1, não há nenhum bloqueio entre as transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1245">Because the S lock is compatible with the IS lock being held on partition ID 7 by the transaction in session 1, there is no blocking between transactions.</span></span>  
  
```sql  
BEGIN TRANSACTION  
    SELECT col1  
        FROM TestTable  
        WITH (TABLOCK, HOLDLOCK);  
```  
  
 <span data-ttu-id="12fe9-1246">Sessão 1:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1246">Session 1:</span></span>  
  
 <span data-ttu-id="12fe9-1247">A instrução `SELECT` a seguir é executada na transação que ainda estiver ativa na sessão 1.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1247">The following `SELECT` statement is executed under the transaction that is still active under session 1.</span></span> <span data-ttu-id="12fe9-1248">Devido a dica de bloqueio de tabela exclusivo, a transação tentará adquirir um bloqueio X na tabela .</span><span class="sxs-lookup"><span data-stu-id="12fe9-1248">Because of the exclusive (X) table lock hint, the transaction will attempt to acquire an X lock on the table.</span></span> <span data-ttu-id="12fe9-1249">Entretanto, o bloqueio S que está sendo mantido pela transação na sessão 2 bloqueará o bloqueio X na ID 0 da partição.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1249">However, the S lock that is being held by the transaction in session 2 will block the X lock at partition ID 0.</span></span>  
  
```sql  
SELECT col1  
    FROM TestTable  
    WITH (TABLOCKX);  
```  
  
##### <a name="example-b"></a><span data-ttu-id="12fe9-1250">Exemplo B</span><span class="sxs-lookup"><span data-stu-id="12fe9-1250">Example B</span></span>  

 <span data-ttu-id="12fe9-1251">Sessão 1:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1251">Session 1:</span></span>  
  
 <span data-ttu-id="12fe9-1252">Uma instrução `SELECT` é executada em uma transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1252">A `SELECT` statement is executed under a transaction.</span></span> <span data-ttu-id="12fe9-1253">Devido à dica de bloqueio `HOLDLOCK`, essa instrução adquirirá e reterá um bloqueio IS (Intencional compartilhado) na tabela (para efeitos de ilustração, são ignorados os bloqueios de linha e de página).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1253">Because of the `HOLDLOCK` lock hint, this statement will acquire and retain an Intent shared (IS) lock on the table (for this illustration, row and page locks are ignored).</span></span> <span data-ttu-id="12fe9-1254">O bloqueio IS só será adquirido na partição atribuída à transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1254">The IS lock will be acquired only on the partition assigned to the transaction.</span></span> <span data-ttu-id="12fe9-1255">Para este exemplo, supõe-se que o bloqueio IS é adquirido na ID 6 da partição.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1255">For this example, it is assumed that the IS lock is acquired on partition ID 6.</span></span>  
  
```sql  
-- Start a transaction.  
BEGIN TRANSACTION  
    -- This SELECT statement will acquire an IS lock on the table.  
    SELECT col1  
        FROM TestTable  
        WITH (HOLDLOCK);  
```  
  
 <span data-ttu-id="12fe9-1256">Sessão 2:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1256">Session 2:</span></span>  
  
 <span data-ttu-id="12fe9-1257">Uma instrução `SELECT` é executada em uma transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1257">A `SELECT` statement is executed under a transaction.</span></span> <span data-ttu-id="12fe9-1258">Devido a dica de bloqueio `TABLOCKX`, a transação tenta adquirir um bloqueio X (exclusivo) na tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1258">Because of the `TABLOCKX` lock hint, the transaction tries to acquire an exclusive (X) lock on the table.</span></span> <span data-ttu-id="12fe9-1259">Lembre-se que o bloqueio X deve ser adquirido em todas as partições começando com o ID de partição 0.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1259">Remember that the X lock must be acquired on all partitions starting with partition ID 0.</span></span> <span data-ttu-id="12fe9-1260">Entretanto, o bloqueio X será adquirido em todos os IDs de partição 0-5 pelo bloqueio IS que é adquirido no ID de partição 6.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1260">The X lock will be acquired on all partitions IDs 0-5 but will be blocked by the IS lock that is acquired on partition ID 6.</span></span>  
  
 <span data-ttu-id="12fe9-1261">Nos IDs de partição 7-15 que o bloqueio X ainda não atingiu, outras transações podem continuar adquirindo bloqueios.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1261">On partition IDs 7-15 that the X lock has not yet reached, other transactions can continue to acquire locks.</span></span>  
  
```sql  
BEGIN TRANSACTION  
    SELECT col1  
        FROM TestTable  
        WITH (TABLOCKX, HOLDLOCK);  
```  
  
 <span data-ttu-id="12fe9-1262">![Ícone de seta usado com o link voltar ao início](media/uparrow16x16.gif "Ícone de seta usado com o link Voltar ao Início") [neste guia](#Top)</span><span class="sxs-lookup"><span data-stu-id="12fe9-1262">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="row-versioning-based-isolation-levels-in-the-database-engine"></a><a name="Row_versioning"></a><span data-ttu-id="12fe9-1263">Níveis de isolamento baseados em controle de versão de linha no Mecanismo de Banco de Dados</span><span class="sxs-lookup"><span data-stu-id="12fe9-1263">Row Versioning-based Isolation Levels in the Database Engine</span></span>  

 <span data-ttu-id="12fe9-1264">Com o SQL Server 2005, o mecanismo de banco de dados passou a oferecer a implementação do nível de isolamento de uma transação existente, a leitura confirmada, que fornece um instantâneo de nível de instrução usando o controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1264">Starting with SQL Server 2005, the Database Engine offers an implementation of an existing transaction isolation level, read committed, that provides a statement level snapshot using row versioning.</span></span> <span data-ttu-id="12fe9-1265">O mecanismo de banco de dados do SQL Server também oferece um nível de isolamento da transação, o instantâneo, que fornece um instantâneo de nível de transação e que também usa o controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1265">SQL Server Database Engine also offers a transaction isolation level, snapshot, that provides a transaction level snapshot also using row versioning.</span></span>  
  
 <span data-ttu-id="12fe9-1266">O controle de versão de linha é uma estrutura geral no [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] que chama um mecanismo de gravação de cópia quando uma linha é modificada ou excluída.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1266">Row versioning is a general framework in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] that invokes a copy-on-write mechanism when a row is modified or deleted.</span></span> <span data-ttu-id="12fe9-1267">Enquanto a transação está sendo executada, ele requer que a versão anterior da linha esteja disponível para transações que exigem um estado transacional consistente anterior.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1267">This requires that while the transaction is running, the old version of the row must be available for transactions that require an earlier transactionally consistent state.</span></span> <span data-ttu-id="12fe9-1268">O controle de versão de linha é usado para:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1268">Row versioning is used to do the following:</span></span>  
  
-   <span data-ttu-id="12fe9-1269">Compilar as tabelas **inseridas** e **excluídas** em gatilhos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1269">Build the **inserted** and **deleted** tables in triggers.</span></span> <span data-ttu-id="12fe9-1270">Qualquer linha modificada pelo gatilho tem controle de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1270">Any rows modified by the trigger are versioned.</span></span> <span data-ttu-id="12fe9-1271">Isso inclui as linhas modificadas pela instrução que iniciou o gatilho, bem como quaisquer modificações de dados feitas pelo gatilho.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1271">This includes the rows modified by the statement that launched the trigger, as well as any data modifications made by the trigger.</span></span>  
  
-   <span data-ttu-id="12fe9-1272">Oferecer suporte a vários conjuntos de resultados ativos (MARS)</span><span class="sxs-lookup"><span data-stu-id="12fe9-1272">Support Multiple Active Result Sets (MARS).</span></span> <span data-ttu-id="12fe9-1273">Se uma sessão MARS emitir uma instrução de modificação de dados (como INSERT, UPDATE ou DELETE) cada vez que houver um conjunto de resultados ativos, as linhas afetadas pela instrução de modificação terão controle de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1273">If a MARS session issues a data modification statement (such as INSERT, UPDATE, or DELETE) at a time there is an active result set, the rows affected by the modification statement are versioned.</span></span>  
  
-   <span data-ttu-id="12fe9-1274">Oferecer suporte a operações de índice que especificam a opção ONLINE.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1274">Support index operations that specify the ONLINE option.</span></span>  
  
-   <span data-ttu-id="12fe9-1275">Oferecer suporte a níveis de isolamento de transações com base em controle de versão de linha:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1275">Support row versioning-based transaction isolation levels:</span></span>  
  
    -   <span data-ttu-id="12fe9-1276">Uma nova implementação de nível de isolamento de leitura confirmada que utiliza o controle de versão de linha para fornecer a consistência de leitura em nível de instrução.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1276">A new implementation of read committed isolation level that uses row versioning to provide statement-level read consistency.</span></span>  
  
    -   <span data-ttu-id="12fe9-1277">Um novo nível de isolamento, instantâneo, para fornecer a consistência de leitura em nível de transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1277">A new isolation level, snapshot, to provide transaction-level read consistency.</span></span>  
  
 <span data-ttu-id="12fe9-1278">O banco de dados `tempdb` deve ter espaço suficiente para o armazenamento de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1278">The `tempdb` database must have enough space for the version store.</span></span> <span data-ttu-id="12fe9-1279">Quando `tempdb` está cheio, as operações de atualização param de gerar versões e continuam a ter êxito, mas as operações de leitura podem falhar porque uma versão de linha específica necessária não existe mais.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1279">When `tempdb` is full, update operations will stop generating versions and continue to succeed, but read operations might fail because a particular row version that is needed no longer exists.</span></span> <span data-ttu-id="12fe9-1280">Isto afeta operações como gatilhos, MARS e indexação online.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1280">This affects operations like triggers, MARS, and online indexing.</span></span>  
  
 <span data-ttu-id="12fe9-1281">O uso de controle de versão de linha para transações de leitura confirmada e de instantâneo é um processo em duas etapas:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1281">Using row versioning for read-committed and snapshot transactions is a two-step process:</span></span>  
  
1.  <span data-ttu-id="12fe9-1282">Defina uma ou ambas as opções de banco de dados READ_COMMITTED_SNAPSHOT e ALLOW_SNAPSHOT_ISOLATION como ON.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1282">Set either or both the READ_COMMITTED_SNAPSHOT and ALLOW_SNAPSHOT_ISOLATION database options ON.</span></span>  
  
2.  <span data-ttu-id="12fe9-1283">Defina o nível de isolamento da transação apropriado em um aplicativo:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1283">Set the appropriate transaction isolation level in an application:</span></span>  
  
    -   <span data-ttu-id="12fe9-1284">Quando a opção de banco de dados READ_COMMITTED_SNAPSHOT for ON, as transações que configuram o nível de isolamento da leitura confirmada usarão o controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1284">When the READ_COMMITTED_SNAPSHOT database option is ON, transactions setting the read committed isolation level use row versioning.</span></span>  
  
    -   <span data-ttu-id="12fe9-1285">Quando a opção de banco de dados ALLOW_SNAPSHOT_ISOLATION for ON, as transações poderão definir o nível de isolamento do instantâneo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1285">When the ALLOW_SNAPSHOT_ISOLATION database option is ON, transactions can set the snapshot isolation level.</span></span>  
  
 <span data-ttu-id="12fe9-1286">Quando a opção de banco de dados READ_COMMITTED_SNAPSHOT ou ALLOW_SNAPSHOT_ISOLATION for ON, o [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] atribuirá um número de sequência da transação (XSN) para cada transação que manipular dados usando o controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1286">When either READ_COMMITTED_SNAPSHOT or ALLOW_SNAPSHOT_ISOLATION database option is set ON, the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] assigns a transaction sequence number (XSN) to each transaction that manipulates data using row versioning.</span></span> <span data-ttu-id="12fe9-1287">As transações iniciam quando uma instrução BEGIN TRANSACTION é executada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1287">Transactions start at the time a BEGIN TRANSACTION statement is executed.</span></span> <span data-ttu-id="12fe9-1288">Porém, o número de sequência da transação inicia com a primeira operação de leitura ou gravação depois da instrução BEGIN TRANSACTION.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1288">However, the transaction sequence number starts with the first read or write operation after the BEGIN TRANSACTION statement.</span></span> <span data-ttu-id="12fe9-1289">O número de sequência da transação é incrementado um por vez sempre que é atribuído.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1289">The transaction sequence number is incremented by one each time it is assigned.</span></span>  
  
 <span data-ttu-id="12fe9-1290">Quando as opções de banco de dados READ_COMMITTED_SNAPSHOT ou ALLOW_SNAPSHOT_ISOLATION forem ON, as cópias lógicas (versões) serão mantidas para todas as modificações de dados executadas no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1290">When either the READ_COMMITTED_SNAPSHOT or ALLOW_SNAPSHOT_ISOLATION database options are ON, logical copies (versions) are maintained for all data modifications performed in the database.</span></span> <span data-ttu-id="12fe9-1291">Sempre que uma linha é modificada por uma transação específica, a instância do [!INCLUDE[ssDE](../includes/ssde-md.md)] armazena uma versão da imagem confirmada anteriormente da linha em `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1291">Every time a row is modified by a specific transaction, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] stores a version of the previously committed image of the row in `tempdb`.</span></span> <span data-ttu-id="12fe9-1292">Cada versão é marcada com o número de sequência de transação da transação que fez a alteração.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1292">Each version is marked with the transaction sequence number of the transaction that made the change.</span></span> <span data-ttu-id="12fe9-1293">As versões das linhas modificadas são encadeadas usando uma lista de links.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1293">The versions of modified rows are chained using a link list.</span></span> <span data-ttu-id="12fe9-1294">O valor da linha mais recente sempre é armazenado no banco de dados atual e encadeado às linhas com controle de versão armazenadas em `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1294">The newest row value is always stored in the current database and chained to the versioned rows stored in `tempdb`.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-1295">Para a modificação de LOBs (objetos grandes), somente o fragmento alterado é copiado para o armazenamento de versão em `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1295">For modification of large objects (LOBs), only the changed fragment is copied to the version store in `tempdb`.</span></span>  
  
 <span data-ttu-id="12fe9-1296">As versões da linha são mantidas por tempo suficiente para atender os requisitos das transações executadas em níveis de isolamento com base em controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1296">Row versions are held long enough to satisfy the requirements of transactions running under row versioning-based isolation levels.</span></span> <span data-ttu-id="12fe9-1297">O [!INCLUDE[ssDE](../includes/ssde-md.md)] localiza o número útil mais antigo de sequência da transação e exclui periodicamente todas as versões da linha carimbadas com números de sequência da transação inferiores ao número útil mais antigo da sequência.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1297">The [!INCLUDE[ssDE](../includes/ssde-md.md)] tracks the earliest useful transaction sequence number and periodically deletes all row versions stamped with transaction sequence numbers that are lower than the earliest useful sequence number.</span></span>  
  
 <span data-ttu-id="12fe9-1298">Quando ambas as opções do banco de dados estão definidas como OFF, somente as linhas modificadas por gatilhos ou sessões MARS, ou lidas por operações de índice ONLINE, têm controle de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1298">When both database options are set to OFF, only rows modified by triggers or MARS sessions, or read by ONLINE index operations, are versioned.</span></span> <span data-ttu-id="12fe9-1299">Essas versões de linha são liberadas quando já não são necessárias.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1299">Those row versions are released when no longer needed.</span></span> <span data-ttu-id="12fe9-1300">Um thread em segundo plano é periodicamente executado para remover versões obsoletas da linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1300">A background thread periodically executes to remove stale row versions.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-1301">Para transações de execução curta, uma versão de uma linha modificada pode ficar armazenada em cache no pool de buffers sem ser gravada nos arquivos de disco do banco de dados `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1301">For short-running transactions, a version of a modified row may get cached in the buffer pool without getting written into the disk files of the `tempdb` database.</span></span> <span data-ttu-id="12fe9-1302">Se a necessidade da linha com controle de versão for de curta duração, a linha será simplesmente retirada do pool de buffers sem necessariamente gerar uma sobrecarga de E/S.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1302">If the need for the versioned row is short-lived, it will simply get dropped from the buffer pool and may not necessarily incur I/O overhead.</span></span>  
  
### <a name="behavior-when-reading-data"></a><span data-ttu-id="12fe9-1303">Comportamento durante a leitura de dados</span><span class="sxs-lookup"><span data-stu-id="12fe9-1303">Behavior When Reading Data</span></span>  

 <span data-ttu-id="12fe9-1304">Quando as transações são executadas em dados de leitura de isolamento com base em controle de versão de linha, as operações de leitura não adquirem bloqueios compartilhados (S) nos dados que estão sendo lidos, portanto, não bloqueiam transações que estão modificando dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1304">When transactions running under row versioning-based isolation read data, the read operations do not acquire shared (S) locks on the data being read, and therefore do not block transactions that are modifying data.</span></span> <span data-ttu-id="12fe9-1305">A sobrecarga de recursos de bloqueio também é minimizada conforme o número de bloqueios adquirido é reduzido.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1305">Also, the overhead of locking resources is minimized as the number of locks acquired is reduced.</span></span> <span data-ttu-id="12fe9-1306">O isolamento de leitura confirmada que usa controle de versão de linha e isolamento de instantâneo é desenvolvido para fornecer consistências de leitura em nível de transação e instrução de dados com controle de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1306">Read committed isolation using row versioning and snapshot isolation are designed to provide statement-level or transaction-level read consistencies of versioned data.</span></span>  
  
 <span data-ttu-id="12fe9-1307">Todas as consultas, incluindo as transações executadas em níveis de isolamento com base em controle de versão de linha, adquirem bloqueios Sch-S (estabilidade do esquema) durante a compilação e a execução.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1307">All queries, including transactions running under row versioning-based isolation levels, acquire Sch-S (schema stability) locks during compilation and execution.</span></span> <span data-ttu-id="12fe9-1308">Por causa disso, as consultas são bloqueadas quando uma transação simultânea mantém um bloqueio Sch-M (modificação de esquema) na tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1308">Because of this, queries are blocked when a concurrent transaction holds a Sch-M (schema modification) lock on the table.</span></span> <span data-ttu-id="12fe9-1309">Por exemplo, uma operação DDL (Linguagem de Definição de Dados) adquire um bloqueio Sch-M antes de modificar as informações do esquema da tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1309">For example, a data definition language (DDL) operation acquires a Sch-M lock before it modifies the schema information of the table.</span></span> <span data-ttu-id="12fe9-1310">As transações de consulta, incluindo aquelas executadas em nível de isolamento com base em controle de versão de linha, são bloqueadas ao tentar adquirir um bloqueio Sch-S.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1310">Query transactions, including those running under a row versioning-based isolation level, are blocked when attempting to acquire a Sch-S lock.</span></span> <span data-ttu-id="12fe9-1311">Da mesma forma, uma consulta que mantém um bloqueio Sch-S bloqueará uma transação simultânea que tentar adquirir um bloqueio Sch-M.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1311">Conversely, a query holding a Sch-S lock blocks a concurrent transaction that attempts to acquire a Sch-M lock.</span></span>  
  
 <span data-ttu-id="12fe9-1312">Quando uma transação que usa o nível de isolamento do instantâneo é iniciada, a instância do [!INCLUDE[ssDE](../includes/ssde-md.md)] registra todas as transações ativas no momento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1312">When a transaction using the snapshot isolation level starts, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] records all of the currently active transactions.</span></span> <span data-ttu-id="12fe9-1313">Quando a transação de instantâneo lê uma linha que tem uma cadeia de versão, o [!INCLUDE[ssDE](../includes/ssde-md.md)] segue a cadeia e recupera a linha em que o número de sequência da transação:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1313">When the snapshot transaction reads a row that has a version chain, the [!INCLUDE[ssDE](../includes/ssde-md.md)] follows the chain and retrieves the row where the transaction sequence number is:</span></span>  
  
-   <span data-ttu-id="12fe9-1314">Está mais próxima, mas inferior ao número de sequência da transação de instantâneo que está lendo a linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1314">Closest to but lower than the sequence number of the snapshot transaction reading the row.</span></span>  
  
-   <span data-ttu-id="12fe9-1315">Não está na lista das transações ativas quando a transação de instantâneo é iniciada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1315">Not in the list of the transactions active when the snapshot transaction started.</span></span>  
  
 <span data-ttu-id="12fe9-1316">As operações de leitura executadas por uma transação de instantâneo recuperam a última versão de cada linha confirmada quando a transação de instantâneo foi iniciada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1316">Read operations performed by a snapshot transaction retrieve the last version of each row that had been committed at the time the snapshot transaction started.</span></span> <span data-ttu-id="12fe9-1317">Isso fornece um instantâneo transacional consistente dos dados, da mesma forma como existiam no início da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1317">This provides a transactionally consistent snapshot of the data as it existed at the start of the transaction.</span></span>  
  
 <span data-ttu-id="12fe9-1318">As transações de leitura confirmada que usam controle de versão de linha funcionam praticamente do mesmo modo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1318">Read-committed transactions using row versioning operate in much the same way.</span></span> <span data-ttu-id="12fe9-1319">A diferença é que a transação de leitura confirmada não usa o seu próprio número de sequência da transação ao escolher versões de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1319">The difference is that the read-committed transaction does not use its own transaction sequence number when choosing row versions.</span></span> <span data-ttu-id="12fe9-1320">Cada vez que uma instrução é iniciada, a transação de leitura confirmada lê o último número de sequência da transação emitido para aquela instância do [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-1320">Each time a statement is started, the read-committed transaction reads the latest transaction sequence number issued for that instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)].</span></span> <span data-ttu-id="12fe9-1321">Esse é o número de sequência da transação usado para selecionar as versões de linha corretas para aquela instrução.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1321">This is the transaction sequence number used to select the correct row versions for that statement.</span></span> <span data-ttu-id="12fe9-1322">Isso permite que as transações de leitura confirmada veja um instantâneo dos dados como ele era no início de cada instrução.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1322">This allows read-committed transactions to see a snapshot of the data as it exists at the start of each statement.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-1323">Embora as transações de leitura confirmada que usam controle de versão de linha forneçam uma exibição transacional consistente dos dados em um nível de instrução, as versões de linha geradas ou acessadas por esse tipo de transação são mantidas até a conclusão da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1323">Even though read-committed transactions using row versioning provides a transactionally consistent view of the data at a statement level, row versions generated or accessed by this type of transaction are maintained until the transaction completes.</span></span>  
  
### <a name="behavior-when-modifying-data"></a><span data-ttu-id="12fe9-1324">Comportamento durante a modificação de dados</span><span class="sxs-lookup"><span data-stu-id="12fe9-1324">Behavior When Modifying Data</span></span>  

 <span data-ttu-id="12fe9-1325">Em uma transação de leitura confirmada que usa o controle de versão de linha, a seleção de linhas a serem atualizadas é feita usando uma verificação de bloqueio em que um bloqueio de atualização (U) é feito na linha de dados conforme os valores dos dados são lidos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1325">In a read-committed transaction using row versioning, the selection of rows to update is done using a blocking scan where an update (U) lock is taken on the data row as data values are read.</span></span> <span data-ttu-id="12fe9-1326">Isso é igual à transação de leitura confirmada que não usa controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1326">This is the same as a read-committed transaction that does not use row versioning.</span></span> <span data-ttu-id="12fe9-1327">Se a linha de dados não atender os critérios de atualização, o bloqueio de atualização será liberado naquela linha e a próxima linha será fechada e verificada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1327">If the data row does not meet the update criteria, the update lock is released on that row and the next row is locked and scanned.</span></span>  
  
 <span data-ttu-id="12fe9-1328">As transações executadas em isolamento de instantâneo usam uma abordagem otimista para modificação de dados adquirindo bloqueios em dados antes de executar a modificação somente para impor restrições.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1328">Transactions running under snapshot isolation take an optimistic approach to data modification by acquiring locks on data before performing the modification only to enforce constraints.</span></span> <span data-ttu-id="12fe9-1329">Do contrário, os bloqueios não são adquiridos em dados até que os dados sejam modificados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1329">Otherwise, locks are not acquired on data until the data is to be modified.</span></span> <span data-ttu-id="12fe9-1330">Quando uma linha de dados atende os critérios de atualização, a transação de instantâneo verifica se a linha de dados não foi modificada por uma transação simultânea que foi confirmada depois do início da transação de instantâneo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1330">When a data row meets the update criteria, the snapshot transaction verifies that the data row has not been modified by a concurrent transaction that committed after the snapshot transaction began.</span></span> <span data-ttu-id="12fe9-1331">Se a linha de dados tiver sido modificada fora da transação de instantâneo, ocorrerá um conflito de atualização e a transação de instantâneo será finalizada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1331">If the data row has been modified outside of the snapshot transaction, an update conflict occurs and the snapshot transaction is terminated.</span></span> <span data-ttu-id="12fe9-1332">O conflito de atualização é controlado pelo [!INCLUDE[ssDE](../includes/ssde-md.md)] e não há como desabilitar a detecção de conflito de atualização.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1332">The update conflict is handled by the [!INCLUDE[ssDE](../includes/ssde-md.md)] and there is no way to disable the update conflict detection.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-1333">As operações de atualização executadas em isolamento de instantâneo são internamente executadas em isolamento de leitura confirmada quando a transação de instantâneo acessa qualquer um dos seguintes itens:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1333">Update operations running under snapshot isolation internally execute under read committed isolation when the snapshot transaction accesses any of the following:</span></span>  
>   
>  <span data-ttu-id="12fe9-1334">Uma tabela com uma restrição FOREIGN KEY.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1334">A table with a FOREIGN KEY constraint.</span></span>  
>   
>  <span data-ttu-id="12fe9-1335">Uma tabela referenciada na restrição FOREIGN KEY de outra tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1335">A table that is referenced in the FOREIGN KEY constraint of another table.</span></span>  
>   
>  <span data-ttu-id="12fe9-1336">Uma exibição indexada referenciando mais de uma tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1336">An indexed view referencing more than one table.</span></span>  
>   
>  <span data-ttu-id="12fe9-1337">Porém, mesmo de acordo com essas condições, a operação de atualização continuará verificando se os dados não foram modificados por outra transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1337">However, even under these conditions the update operation will continue to verify that the data has not been modified by another transaction.</span></span> <span data-ttu-id="12fe9-1338">Se os dados tiverem sido modificados por outra transação, a transação de instantâneo encontrará um conflito de atualização e será finalizada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1338">If data has been modified by another transaction, the snapshot transaction encounters an update conflict and is terminated.</span></span>  
  
### <a name="behavior-in-summary"></a><span data-ttu-id="12fe9-1339">Resumo do comportamento</span><span class="sxs-lookup"><span data-stu-id="12fe9-1339">Behavior in Summary</span></span>  

 <span data-ttu-id="12fe9-1340">A tabela a seguir resume as diferenças entre o isolamento de instantâneo e o isolamento de leitura confirmada usando o controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1340">The following table summarizes the differences between snapshot isolation and read committed isolation using row versioning.</span></span>  
  
|<span data-ttu-id="12fe9-1341">Propriedade</span><span class="sxs-lookup"><span data-stu-id="12fe9-1341">Property</span></span>|<span data-ttu-id="12fe9-1342">Nível de isolamento de leitura confirmada usando o controle de versão de linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-1342">Read-committed isolation level using row versioning</span></span>|<span data-ttu-id="12fe9-1343">Nível de isolamento do instantâneo</span><span class="sxs-lookup"><span data-stu-id="12fe9-1343">Snapshot isolation level</span></span>|  
|--------------|----------------------------------------------------------|------------------------------|  
|<span data-ttu-id="12fe9-1344">A opção de banco de dados que deve ser definida como ON para habilitar o suporte exigido.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1344">The database option that must be set to ON to enable the required support.</span></span>|<span data-ttu-id="12fe9-1345">READ_COMMITTED_SNAPSHOT</span><span class="sxs-lookup"><span data-stu-id="12fe9-1345">READ_COMMITTED_SNAPSHOT</span></span>|<span data-ttu-id="12fe9-1346">ALLOW_SNAPSHOT_ISOLATION</span><span class="sxs-lookup"><span data-stu-id="12fe9-1346">ALLOW_SNAPSHOT_ISOLATION</span></span>|  
|<span data-ttu-id="12fe9-1347">Como uma sessão solicita o tipo específico de controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1347">How a session requests the specific type of row versioning.</span></span>|<span data-ttu-id="12fe9-1348">Use o nível padrão de isolamento de leitura confirmada ou execute a instrução SET TRANSACTION ISOLATION LEVEL para especificar o nível de isolamento READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1348">Use the default read-committed isolation level, or run the SET TRANSACTION ISOLATION LEVEL statement to specify the READ COMMITTED isolation level.</span></span> <span data-ttu-id="12fe9-1349">Isso pode ser feito depois do início da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1349">This can be done after the transaction starts.</span></span>|<span data-ttu-id="12fe9-1350">Exige a execução de SET TRANSACTION ISOLATION LEVEL para especificar o nível de isolamento SNAPSHOT antes do início da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1350">Requires the execution of SET TRANSACTION ISOLATION LEVEL to specify the SNAPSHOT isolation level before the start of the transaction.</span></span>|  
|<span data-ttu-id="12fe9-1351">A versão dos dados lidos por instruções.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1351">The version of data read by statements.</span></span>|<span data-ttu-id="12fe9-1352">Todos os dados que foram confirmados antes do início de cada instrução.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1352">All data that was committed before the start of each statement.</span></span>|<span data-ttu-id="12fe9-1353">Todos os dados que foram confirmados antes do início de cada transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1353">All data that was committed before the start of each transaction.</span></span>|  
|<span data-ttu-id="12fe9-1354">Como as atualizações são controladas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1354">How updates are handled.</span></span>|<span data-ttu-id="12fe9-1355">Faz a reversão de versões de linha a dados reais para selecionar as linhas que devem ser atualizadas e usa os bloqueios de atualização nas linhas de dados selecionadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1355">Reverts from row versions to actual data to select rows to update and uses update locks on the data rows selected.</span></span> <span data-ttu-id="12fe9-1356">Adquire bloqueios exclusivos em linhas de dados atuais a serem modificadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1356">Acquires exclusive locks on actual data rows to be modified.</span></span> <span data-ttu-id="12fe9-1357">Nenhuma detecção de conflito de atualização.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1357">No update conflict detection.</span></span>|<span data-ttu-id="12fe9-1358">Usa versões de linha para selecionar linhas a serem atualizadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1358">Uses row versions to select rows to update.</span></span> <span data-ttu-id="12fe9-1359">Tenta adquirir um bloqueio exclusivo na linha de dados reais a ser modificada e, se os dados tiverem sido modificados por outra transação, ocorrerá um conflito de atualização e a transação de instantâneo será finalizada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1359">Tries to acquire an exclusive lock on the actual data row to be modified, and if the data has been modified by another transaction, an update conflict occurs and the snapshot transaction is terminated.</span></span>|  
|<span data-ttu-id="12fe9-1360">Atualização de detecção de conflito.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1360">Update conflict detection.</span></span>|<span data-ttu-id="12fe9-1361">Nenhum.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1361">None.</span></span>|<span data-ttu-id="12fe9-1362">Suporte integrado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1362">Integrated support.</span></span> <span data-ttu-id="12fe9-1363">Não pode ser desabilitado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1363">Cannot be disabled.</span></span>|  
  
### <a name="row-versioning-resource-usage"></a><span data-ttu-id="12fe9-1364">Uso do recurso de controle de versão de linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-1364">Row Versioning Resource Usage</span></span>  

 <span data-ttu-id="12fe9-1365">A estrutura de controle de versão de linha dá suporte aos seguintes recursos disponíveis no [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1365">The row versioning framework supports the following features available in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]:</span></span>  
  
-   <span data-ttu-id="12fe9-1366">Gatilhos</span><span class="sxs-lookup"><span data-stu-id="12fe9-1366">Triggers</span></span>  
  
-   <span data-ttu-id="12fe9-1367">MARS (vários conjuntos de resultados ativos)</span><span class="sxs-lookup"><span data-stu-id="12fe9-1367">Multiple Active Results Sets (MARS)</span></span>  
  
-   <span data-ttu-id="12fe9-1368">Indexação online</span><span class="sxs-lookup"><span data-stu-id="12fe9-1368">Online indexing</span></span>  
  
 <span data-ttu-id="12fe9-1369">A estrutura de controle de versão de linha também dá suporte aos seguintes níveis de isolamento da transação baseada no controle de versão de linha que, por padrão, não estão habilitados:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1369">The row versioning framework also supports the following row versioning-based transaction isolation levels, which by default are not enabled:</span></span>  
  
-   <span data-ttu-id="12fe9-1370">Quando a opção de banco de dados READ_COMMITTED_SNAPSHOT for ON, as transações READ_COMMITTED fornecerão consistência de leitura no nível da instrução usando o controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1370">When the READ_COMMITTED_SNAPSHOT database option is ON, READ_COMMITTED transactions provide statement-level read consistency using row versioning.</span></span>  
  
-   <span data-ttu-id="12fe9-1371">Quando a opção de banco de dados ALLOW_SNAPSHOT_ISOLATION for ON, as transações SNAPSHOT fornecerão consistência de leitura no nível da transação usando o controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1371">When the ALLOW_SNAPSHOT_ISOLATION database option is ON, SNAPSHOT transactions provide transaction-level read consistency using row versioning.</span></span>  
  
 <span data-ttu-id="12fe9-1372">Os níveis de isolamento com base no controle de versão de linha reduzem o número de bloqueios adquiridos pela transação eliminando o uso de bloqueios compartilhados em operações de leitura.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1372">Row versioning-based isolation levels reduce the number of locks acquired by transaction by eliminating the use of shared locks on read operations.</span></span> <span data-ttu-id="12fe9-1373">Isso aumenta o desempenho do sistema reduzindo os recursos usados para gerenciar bloqueios.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1373">This increases system performance by reducing the resources used to manage locks.</span></span> <span data-ttu-id="12fe9-1374">O desempenho também é aumentado pela redução do número de vezes em que uma transação fica bloqueada por bloqueios adquiridos por outras transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1374">Performance is also increased by reducing the number of times a transaction is blocked by locks acquired by other transactions.</span></span>  
  
 <span data-ttu-id="12fe9-1375">Os níveis de isolamento com base no controle de versão de linha aumentam os recursos necessários pelas modificações de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1375">Row versioning-based isolation levels increase the resources needed by data modifications.</span></span> <span data-ttu-id="12fe9-1376">Habilitar essas opções faz com que todas as modificações de dados no banco de dados sejam controladas por versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1376">Enabling these options causes all data modifications for the database to be versioned.</span></span> <span data-ttu-id="12fe9-1377">Uma cópia dos dados antes da modificação é armazenada em tempdb, mesmo quando não há transações ativas que usam o isolamento com base em controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1377">A copy of the data before modification is stored in tempdb even when there are no active transactions using row versioning-based isolation.</span></span> <span data-ttu-id="12fe9-1378">Os dados após a modificação incluem um ponteiro para os dados controlados por versão armazenados em tempdb.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1378">The data after modification includes a pointer to the versioned data stored in tempdb.</span></span> <span data-ttu-id="12fe9-1379">Para objetos grandes, apenas parte do objeto alterado é copiada em tempdb.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1379">For large objects, only part of the object that changed is copied to tempdb.</span></span>  
  
#### <a name="space-used-in-tempdb"></a><span data-ttu-id="12fe9-1380">Espaço usado no tempdb</span><span class="sxs-lookup"><span data-stu-id="12fe9-1380">Space Used in tempdb</span></span>  

 <span data-ttu-id="12fe9-1381">Para cada instância do [!INCLUDE[ssDE](../includes/ssde-md.md)], o tempdb deve ter espaço suficiente para manter as versões de linha geradas para cada banco de dados na instância.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1381">For each instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)], tempdb must have enough space to hold the row versions generated for every database in the instance.</span></span> <span data-ttu-id="12fe9-1382">O administrador de banco do dados deve garantir que tempdb tem espaço suficiente para oferecer suporte ao armazenamento da versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1382">The database administrator must ensure that tempdb has ample space to support the version store.</span></span> <span data-ttu-id="12fe9-1383">Há dois armazenamentos de versão em tempdb:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1383">There are two version stores in tempdb:</span></span>  
  
-   <span data-ttu-id="12fe9-1384">O repositório de versão de compilação de índices online é usado para compilações de índices online em todos os bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1384">The online index build version store is used for online index builds in all databases.</span></span>  
  
-   <span data-ttu-id="12fe9-1385">O repositório da versão comum é usado para todas as outras operações de modificação de dados em todos os bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1385">The common version store is used for all other data modification operations in all databases.</span></span>  
  
 <span data-ttu-id="12fe9-1386">As versões de linha devem ser armazenadas enquanto uma transação ativa precisar acessá-las.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1386">Row versions must be stored for as long as an active transaction needs to access it.</span></span> <span data-ttu-id="12fe9-1387">Uma vez a cada minuto, um thread em segundo plano remove as versões de linha que não são mais necessárias e libera o espaço da versão no tempdb.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1387">Once every minute, a background thread removes row versions that are no longer needed and frees up the version space in tempdb.</span></span> <span data-ttu-id="12fe9-1388">Uma transação de longa execução impedirá que o espaço do repositório de versão seja liberado, se as seguintes condições forem encontradas:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1388">A long-running transaction prevents space in the version store from being released if it meets any of the following conditions:</span></span>  
  
-   <span data-ttu-id="12fe9-1389">Ela usa isolamento com base em controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1389">It uses row versioning-based isolation.</span></span>  
  
-   <span data-ttu-id="12fe9-1390">Ela usa gatilhos, MARS ou operações de compilação de índices online.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1390">It uses triggers, MARS, or online index build operations.</span></span>  
  
-   <span data-ttu-id="12fe9-1391">Ela gera versões de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1391">It generates row versions.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-1392">Quando um gatilho é acionado em uma transação, são mantidas as versões de linha criadas pelo gatilho até o término da transação, mesmo quando as versões de linha não forem mais necessárias após o gatilho ser concluído.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1392">When a trigger is invoked inside a transaction, the row versions created by the trigger are maintained until the end of the transaction, even though the row versions are no longer needed after the trigger completes.</span></span> <span data-ttu-id="12fe9-1393">Isso também se aplica a transações de leitura confirmada que usam controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1393">This also applies to read-committed transactions that use row versioning.</span></span> <span data-ttu-id="12fe9-1394">Com esse tipo de transação, uma exibição consistente de maneira transacional do banco de dados é necessária apenas para cada instrução na transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1394">With this type of transaction, a transactionally consistent view of the database is needed only for each statement in the transaction.</span></span> <span data-ttu-id="12fe9-1395">Isso significa que as versões de linha criadas para uma instrução na transação não são necessárias depois que a instrução é concluída.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1395">This means that the row versions created for a statement in the transaction are no longer needed after the statement completes.</span></span> <span data-ttu-id="12fe9-1396">Porém, as versões de linha criadas por cada instrução na transação são mantidas até que a transação seja concluída.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1396">However, row versions created by each statement in the transaction are maintained until the transaction completes.</span></span>  
  
 <span data-ttu-id="12fe9-1397">Quando o espaço no tempdb for insuficiente, o [!INCLUDE[ssDE](../includes/ssde-md.md)] reduzirá os armazenamentos da versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1397">When tempdb runs out of space, the [!INCLUDE[ssDE](../includes/ssde-md.md)] forces the version stores to shrink.</span></span> <span data-ttu-id="12fe9-1398">Durante o processo de redução, as transações mais longas que estiverem sendo executadas e que ainda não geraram versões de linha serão marcadas como vítimas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1398">During the shrink process, the longest running transactions that have not yet generated row versions are marked as victims.</span></span> <span data-ttu-id="12fe9-1399">Uma mensagem 3967 é gerada no log de erros para cada transação vítima.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1399">A message 3967 is generated in the error log for each victim transaction.</span></span> <span data-ttu-id="12fe9-1400">Se uma transação for marcada como uma vítima, não poderá ler as versões de linha no armazenamento da versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1400">If a transaction is marked as a victim, it can no longer read the row versions in the version store.</span></span> <span data-ttu-id="12fe9-1401">Ao tentar ler versões de linhas, a mensagem 3966 é gerada e a transação é revertida.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1401">When it attempts to read row versions, message 3966 is generated and the transaction is rolled back.</span></span> <span data-ttu-id="12fe9-1402">Se o processo de redução for executado com êxito, haverá espaço disponível em tempdb.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1402">If the shrinking process succeeds, space becomes available in tempdb.</span></span> <span data-ttu-id="12fe9-1403">Caso contrário, o tempdb ficará sem espaço e ocorrerá o seguinte:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1403">Otherwise, tempdb runs out of space and the following occurs:</span></span>  
  
-   <span data-ttu-id="12fe9-1404">As operações de gravação continuarão a ser executadas, mas não gerarão versões.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1404">Write operations continue to execute but do not generate versions.</span></span> <span data-ttu-id="12fe9-1405">Uma mensagem informativa (3959) será exibida no log de erros, mas a transação que grava dados não será afetada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1405">An information message (3959) appears in the error log, but the transaction that writes data is not affected.</span></span>  
  
-   <span data-ttu-id="12fe9-1406">As transações que tentam acessar versões de linha que não foram geradas devido a uma reversão completa de tempdb serão encerradas com um erro 3958.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1406">Transactions that attempt to access row versions that were not generated because of a tempdb full rollback terminate with an error 3958.</span></span>  
  
#### <a name="space-used-in-data-rows"></a><span data-ttu-id="12fe9-1407">Espaço usado em linhas de dados</span><span class="sxs-lookup"><span data-stu-id="12fe9-1407">Space Used in Data Rows</span></span>  

 <span data-ttu-id="12fe9-1408">Cada linha de banco de dados pode usar até 14 bytes ao término da linha para obter informações sobre o controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1408">Each database row may use up to 14 bytes at the end of the row for row versioning information.</span></span> <span data-ttu-id="12fe9-1409">As informações sobre o controle de versão de linha contêm o número de sequência da transação que confirmou a versão e o ponteiro da linha controlada por versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1409">The row versioning information contains the transaction sequence number of the transaction that committed the version and the pointer to the versioned row.</span></span> <span data-ttu-id="12fe9-1410">Esses 14 bytes são adicionados na primeira vez em que a linha é modificada, ou quando uma nova linha é inserida, em qualquer uma destas condições:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1410">These 14 bytes are added the first time the row is modified, or when a new row is inserted, under any of these conditions:</span></span>  
  
-   <span data-ttu-id="12fe9-1411">A opção READ_COMMITTED_SNAPSHOT ou ALLOW_SNAPSHOT_ISOLATION está ON.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1411">READ_COMMITTED_SNAPSHOT or ALLOW_SNAPSHOT_ISOLATION options are ON.</span></span>  
  
-   <span data-ttu-id="12fe9-1412">A tabela tem um gatilho.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1412">The table has a trigger.</span></span>  
  
-   <span data-ttu-id="12fe9-1413">Os MARS (conjuntos de resultados ativos múltiplos) estão sendo usados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1413">Multiple Active Results Sets (MARS) is being used.</span></span>  
  
-   <span data-ttu-id="12fe9-1414">As operações de compilação de índices online estão sendo executadas atualmente na tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1414">Online index build operations are currently running on the table.</span></span>  
  
 <span data-ttu-id="12fe9-1415">Esses 14 bytes são removidos da linha do banco de dados na primeira vez em que a linha é modificada nestas condições:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1415">These 14 bytes are removed from the database row the first time the row is modified under all of these conditions:</span></span>  
  
-   <span data-ttu-id="12fe9-1416">As opções READ_COMMITTED_SNAPSHOT e ALLOW_SNAPSHOT_ISOLATION estão OFF.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1416">READ_COMMITTED_SNAPSHOT and ALLOW_SNAPSHOT_ISOLATION options are OFF.</span></span>  
  
-   <span data-ttu-id="12fe9-1417">O gatilho não existe mais na tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1417">The trigger no longer exists on the table.</span></span>  
  
-   <span data-ttu-id="12fe9-1418">Os MARS não estão sendo usados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1418">MARS is not being used.</span></span>  
  
-   <span data-ttu-id="12fe9-1419">As operações de compilação de índices online não estão sendo executadas no momento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1419">Online index build operations are not currently running.</span></span>  
  
 <span data-ttu-id="12fe9-1420">Se você usar qualquer um dos recursos de controle de versão de linha, poderá ser necessário alocar espaço em disco adicional para o banco de dados para acomodar a linha de 14 bytes por banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1420">If you use any of the row versioning features, you might need to allocate additional disk space for the database to accommodate the 14 bytes per database row.</span></span> <span data-ttu-id="12fe9-1421">A adição das informações de controle de versão de linha poderá causar a divisão da página de índice ou a alocação de uma nova página de dados se não houver espaço disponível suficiente na página atual.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1421">Adding the row versioning information can cause index page splits or the allocation of a new data page if there is not enough space available on the current page.</span></span> <span data-ttu-id="12fe9-1422">Por exemplo, se o comprimento médio da linha for 100 bytes, os 14 bytes adicionais farão com que uma tabela existente cresça até 14%.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1422">For example, if the average row length is 100 bytes, the additional 14 bytes cause an existing table to grow up to 14 percent.</span></span>  
  
 <span data-ttu-id="12fe9-1423">Reduzir o [fator de preenchimento](../relational-databases/indexes/specify-fill-factor-for-an-index.md) pode ajudar a impedir ou diminuir a fragmentação de páginas de índice.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1423">Decreasing the [fill factor](../relational-databases/indexes/specify-fill-factor-for-an-index.md) might help to prevent or decrease fragmentation of index pages.</span></span> <span data-ttu-id="12fe9-1424">Para exibir informações de fragmentação dos dados e índices de uma tabela ou exibição, você pode usar [DBCC SHOWCONTIG](/sql/t-sql/database-console-commands/dbcc-showcontig-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1424">To view fragmentation information for the data and indexes of a table or view, you can use [DBCC SHOWCONTIG](/sql/t-sql/database-console-commands/dbcc-showcontig-transact-sql).</span></span>  
  
#### <a name="space-used-in-large-objects"></a><span data-ttu-id="12fe9-1425">Espaço usado em objetos grandes</span><span class="sxs-lookup"><span data-stu-id="12fe9-1425">Space Used in Large Objects</span></span>  

 <span data-ttu-id="12fe9-1426">O [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] dá suporte a seis tipos de dados que podem manter grandes cadeias de caracteres com até 2 GB (gigabytes) de comprimento: `nvarchar(max)`, `varchar(max)`, `varbinary(max)`, `ntext`, `text` e `image`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1426">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] supports six data types that can hold large strings up to 2 gigabytes (GB) in length: `nvarchar(max)`, `varchar(max)`, `varbinary(max)`, `ntext`, `text`, and `image`.</span></span> <span data-ttu-id="12fe9-1427">Grandes cadeias de caracteres armazenadas que usam esses tipos de dados são armazenadas em uma série de fragmentos de dados vinculados à linha de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1427">Large strings stored using these data types are stored in a series of data fragments that are linked to the data row.</span></span> <span data-ttu-id="12fe9-1428">As informações de controle de versão de linha estão armazenadas em cada fragmento usado para armazenar grandes cadeias de caracteres.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1428">Row versioning information is stored in each fragment used to store these large strings.</span></span> <span data-ttu-id="12fe9-1429">Os fragmentos de dados são uma coleção de páginas dedicadas a objetos grandes em uma tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1429">Data fragments are a collection of pages dedicated to large objects in a table.</span></span>  
  
 <span data-ttu-id="12fe9-1430">Conforme novos valores grandes forem adicionados a um banco de dados, eles serão alocados com o máximo de 8040 bytes de dados por fragmento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1430">As new large values are added to a database, they are allocated using a maximum of 8040 bytes of data per fragment.</span></span> <span data-ttu-id="12fe9-1431">Versões anteriores do [!INCLUDE[ssDE](../includes/ssde-md.md)] armazenavam até 8080 bytes de dados `ntext`, `text` ou `image` por fragmento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1431">Earlier versions of the [!INCLUDE[ssDE](../includes/ssde-md.md)] stored up to 8080 bytes of `ntext`, `text`, or `image` data per fragment.</span></span>  
  
 <span data-ttu-id="12fe9-1432">O dados de LOB (Objeto Grande) `ntext`, `text` e `image` existentes não são atualizados para criar espaço para as informações de controle de versão de linha quando um banco de dados é atualizado para [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] de uma versão anterior do [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-1432">Existing `ntext`, `text`, and `image` large object (LOB) data is not updated to make space for the row versioning information when a database is upgraded to [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] from an earlier version of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="12fe9-1433">Porém, a primeira vez em que os dados de LOB são modificados, eles são atualizados dinamicamente para habilitar o armazenamento de informações de controle de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1433">However, the first time the LOB data is modified, it is dynamically upgraded to enable storage of versioning information.</span></span> <span data-ttu-id="12fe9-1434">Isso acontecerá até mesmo se não forem geradas versões de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1434">This will happen even if row versions are not generated.</span></span> <span data-ttu-id="12fe9-1435">Depois que os dados de LOB são atualizados, o número máximo de bytes armazenados por fragmento é reduzido de 8080 bytes para 8040 bytes.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1435">After the LOB data is upgraded, the maximum number of bytes stored per fragment is reduced from 8080 bytes to 8040 bytes.</span></span> <span data-ttu-id="12fe9-1436">O processo de atualização é equivalente a excluir o valor LOB e reinserir o mesmo valor.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1436">The upgrade process is equivalent to deleting the LOB value and reinserting the same value.</span></span> <span data-ttu-id="12fe9-1437">Os dados de LOB são atualizados mesmo quando apenas um byte é modificado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1437">The LOB data is upgraded even if only one byte is modified.</span></span> <span data-ttu-id="12fe9-1438">Essa é uma operação única para cada coluna `ntext`, `text` ou `image`, mas cada operação pode gerar uma grande quantidade de alocações de página e atividade de E/S dependendo do tamanho dos dados de LOB.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1438">This is a one-time operation for each `ntext`, `text`, or `image` column, but each operation may generate a large amount of page allocations and I/O activity depending upon the size of the LOB data.</span></span> <span data-ttu-id="12fe9-1439">Isso também poderá gerar uma grande quantidade de atividade de registro se a modificação for totalmente registrada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1439">It may also generate a large amount of logging activity if the modification is fully logged.</span></span> <span data-ttu-id="12fe9-1440">As operações WRITETEXT e UPDATETEXT serão registradas minimamente se o modo de recuperação do banco de dados não for definido como FULL.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1440">WRITETEXT and UPDATETEXT operations are minimally logged if database recovery mode is not set to FULL.</span></span>  
  
 <span data-ttu-id="12fe9-1441">Os tipos de dados `nvarchar(max)`, `varchar(max)` e `varbinary(max)` não estão disponíveis nas versões anteriores do [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-1441">The `nvarchar(max)`, `varchar(max)`, and `varbinary(max)` data types are not available in earlier versions of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="12fe9-1442">Portanto, eles não têm nenhum problema de atualização.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1442">Therefore, they have no upgrade issues.</span></span>  
  
 <span data-ttu-id="12fe9-1443">Deve ser alocado espaço em disco suficiente para acomodar esse requisito.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1443">Enough disk space should be allocated to accommodate this requirement.</span></span>  
  
#### <a name="monitoring-row-versioning-and-the-version-store"></a><span data-ttu-id="12fe9-1444">Monitorando o controle de versão de linha e o armazenamento da versão</span><span class="sxs-lookup"><span data-stu-id="12fe9-1444">Monitoring Row Versioning and the Version Store</span></span>  

 <span data-ttu-id="12fe9-1445">Para monitorar os processos de controle de versão de linha, armazenamento de versão e isolamento de instantâneo quanto ao desempenho e aos problemas, o [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] fornece ferramentas na forma de DMVs (Exibições de Gerenciamento Dinâmico) e contadores de desempenho no Windows System Monitor.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1445">For monitoring row versioning, version store, and snapshot isolation processes for performance and problems, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] provides tools in the form of Dynamic Management Views (DMVs) and performance counters in Windows System Monitor.</span></span>  
  
##### <a name="dmvs"></a><span data-ttu-id="12fe9-1446">DMVs</span><span class="sxs-lookup"><span data-stu-id="12fe9-1446">DMVs</span></span>  

 <span data-ttu-id="12fe9-1447">As DMVs a seguir fornecem informações sobre o estado atual do sistema de tempdb e o armazenamento da versão, bem como sobre as transações que usam controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1447">The following DMVs provide information about the current system state of tempdb and the version store, as well as transactions using row versioning.</span></span>  
  
 <span data-ttu-id="12fe9-1448">sys.dm_db_file_space_usage.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1448">sys.dm_db_file_space_usage.</span></span> <span data-ttu-id="12fe9-1449">Retorna informações de uso do espaço de cada arquivo no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1449">Returns space usage information for each file in the database.</span></span> <span data-ttu-id="12fe9-1450">Para obter mais informações, veja [sys.dm_db_file_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-file-space-usage-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1450">For more information, see [sys.dm_db_file_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-file-space-usage-transact-sql).</span></span>  
  
 <span data-ttu-id="12fe9-1451">sys.dm_db_session_space_usage.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1451">sys.dm_db_session_space_usage.</span></span> <span data-ttu-id="12fe9-1452">Retorna a alocação de páginas e a atividade de desalocação por sessão do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1452">Returns page allocation and deallocation activity by session for the database.</span></span> <span data-ttu-id="12fe9-1453">Para obter mais informações, veja [sys.dm_db_session_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-session-space-usage-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1453">For more information, see [sys.dm_db_session_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-session-space-usage-transact-sql).</span></span>  
  
 <span data-ttu-id="12fe9-1454">sys.dm_db_task_space_usage.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1454">sys.dm_db_task_space_usage.</span></span> <span data-ttu-id="12fe9-1455">Retorna a alocação de páginas e a atividade de desalocação por tarefa do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1455">Returns page allocation and deallocation activity by task for the database.</span></span> <span data-ttu-id="12fe9-1456">Para obter mais informações, veja [sys.dm_db_task_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-task-space-usage-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1456">For more information, see [sys.dm_db_task_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-task-space-usage-transact-sql).</span></span>  
  
 <span data-ttu-id="12fe9-1457">sys.dm_tran_top_version_generators.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1457">sys.dm_tran_top_version_generators.</span></span> <span data-ttu-id="12fe9-1458">Retorna uma tabela virtual para os objetos que produzem a maioria das versões no repositório de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1458">Returns a virtual table for the objects producing the most versions in the version store.</span></span> <span data-ttu-id="12fe9-1459">Agrupa os 256 maiores registros agregados por database_id e rowset_id.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1459">It groups the top 256 aggregated record lengths by database_id and rowset_id.</span></span> <span data-ttu-id="12fe9-1460">Use essa função para localizar os maiores usuários do repositório de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1460">Use this function to find the largest consumers of the version store.</span></span> <span data-ttu-id="12fe9-1461">Para obter mais informações, veja [sys.DM tran_top_version_generators &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-top-version-generators-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1461">For more information, see [sys.dm_tran_top_version_generators &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-top-version-generators-transact-sql).</span></span>  
  
 <span data-ttu-id="12fe9-1462">sys.dm_tran_version_store.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1462">sys.dm_tran_version_store.</span></span> <span data-ttu-id="12fe9-1463">Retorna uma tabela virtual que exibe todos os registros de versão no repositório de versão comum.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1463">Returns a virtual table that displays all version records in the common version store.</span></span> <span data-ttu-id="12fe9-1464">Para obter mais informações, veja [sys.dm_tran_version_store &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-version-store-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1464">For more information, see [sys.dm_tran_version_store &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-version-store-transact-sql).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-1465">sys.dm_tran_top_version_generators e sys.dm_tran_version_store são funções cuja execução é potencialmente muito dispendiosa, uma vez que ambas consultam todo o armazenamento de versão, que pode ser muito grande.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1465">sys.dm_tran_top_version_generators and sys.dm_tran_version_store are potentially very expensive functions to run, since both query the entire version store, which could be very large.</span></span>  
  
 <span data-ttu-id="12fe9-1466">sys.dm_tran_active_snapshot_database_transactions.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1466">sys.dm_tran_active_snapshot_database_transactions.</span></span> <span data-ttu-id="12fe9-1467">Retorna uma tabela virtual para todas as transações ativas em todos os bancos de dados dentro da instância do [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] que usam controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1467">Returns a virtual table for all active transactions in all databases within the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] instance that use row versioning.</span></span> <span data-ttu-id="12fe9-1468">As transações de sistema não são exibidas nessa DMV.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1468">System transactions do not appear in this DMV.</span></span> <span data-ttu-id="12fe9-1469">Para obter mais informações, veja [sys.dm_tran_active_snapshot_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-active-snapshot-database-transactions-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1469">For more information, see [sys.dm_tran_active_snapshot_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-active-snapshot-database-transactions-transact-sql).</span></span>  
  
 <span data-ttu-id="12fe9-1470">sys.dm_tran_transactions_snapshot.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1470">sys.dm_tran_transactions_snapshot.</span></span> <span data-ttu-id="12fe9-1471">Retorna uma tabela virtual que exibe instantâneos tirados por cada transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1471">Returns a virtual table that displays snapshots taken by each transaction.</span></span> <span data-ttu-id="12fe9-1472">O instantâneo contém o número de sequência das transações ativas que usam controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1472">The snapshot contains the sequence number of the active transactions that use row versioning.</span></span> <span data-ttu-id="12fe9-1473">Para obter mais informações, veja [sys.dm_tran_transactions_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-transactions-snapshot-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1473">For more information, see [sys.dm_tran_transactions_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-transactions-snapshot-transact-sql).</span></span>  
  
 <span data-ttu-id="12fe9-1474">sys.dm_tran_current_transaction.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1474">sys.dm_tran_current_transaction.</span></span> <span data-ttu-id="12fe9-1475">Retorna uma única linha que exibe informações de estado relacionadas ao controle de versão de linha da transação na sessão atual.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1475">Returns a single row that displays row versioning-related state information of the transaction in the current session.</span></span> <span data-ttu-id="12fe9-1476">Para obter mais informações, veja [sys.dm_tran_current_transaction &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-transaction-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1476">For more information, see [sys.dm_tran_current_transaction &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-transaction-transact-sql).</span></span>  
  
 <span data-ttu-id="12fe9-1477">sys.dm_tran_current_snapshot.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1477">sys.dm_tran_current_snapshot.</span></span> <span data-ttu-id="12fe9-1478">Retorna uma tabela virtual que exibe todas as transações ativas no momento em que a transação de isolamento do instantâneo atual é iniciada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1478">Returns a virtual table that displays all active transactions at the time the current snapshot isolation transaction starts.</span></span> <span data-ttu-id="12fe9-1479">Se a transação atual estiver usando um isolamento de instantâneo, essa função não retornará nenhuma linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1479">If the current transaction is using snapshot isolation, this function returns no rows.</span></span> <span data-ttu-id="12fe9-1480">sys.dm_tran_current_snapshot é semelhante a sys.dm_tran_transactions_snapshot, exceto pelo fato de que retorna apenas as transações ativas para o instantâneo atual.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1480">sys.dm_tran_current_snapshot is similar to sys.dm_tran_transactions_snapshot, except that it returns only the active transactions for the current snapshot.</span></span> <span data-ttu-id="12fe9-1481">Para obter mais informações, veja [sys.DM tran_current_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-snapshot-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1481">For more information, see [sys.dm_tran_current_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-snapshot-transact-sql).</span></span>  
  
##### <a name="performance-counters"></a><span data-ttu-id="12fe9-1482">Contadores de desempenho</span><span class="sxs-lookup"><span data-stu-id="12fe9-1482">Performance Counters</span></span>  

 <span data-ttu-id="12fe9-1483">Os contadores de desempenho do [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] fornecem informações sobre o desempenho do sistema afetado por processos do [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-1483">[!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] performance counters provide information about the system performance impacted by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] processes.</span></span> <span data-ttu-id="12fe9-1484">Os contadores de desempenho a seguir monitoram tempdb e o armazenamento de versão, bem como transações que usam controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1484">The following performance counters monitor tempdb and the version store, as well as transactions using row versioning.</span></span> <span data-ttu-id="12fe9-1485">Os contadores de desempenho estão contidos no objeto de desempenho SQLServer:Transactions.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1485">The performance counters are contained in the SQLServer:Transactions performance object.</span></span>  
  
 <span data-ttu-id="12fe9-1486">**Espaço livre em tempdb (KB)** .</span><span class="sxs-lookup"><span data-stu-id="12fe9-1486">**Free Space in tempdb (KB)**.</span></span> <span data-ttu-id="12fe9-1487">Monitora a quantidade, em KB (kilobytes), de espaço livre no banco de dados tempdb.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1487">Monitors the amount, in kilobytes (KB), of free space in the tempdb database.</span></span> <span data-ttu-id="12fe9-1488">Deve haver espaço livre suficiente em tempdb para processar o repositório de versão que dá suporte ao isolamento de instantâneo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1488">There must be enough free space in tempdb to handle the version store that supports snapshot isolation.</span></span>  
  
 <span data-ttu-id="12fe9-1489">A fórmula a seguir fornece uma estimativa aproximada do tamanho do armazenamento de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1489">The following formula provides a rough estimate of the size of the version store.</span></span> <span data-ttu-id="12fe9-1490">Para transações de longa execução, pode ser útil monitorar a taxa de geração e limpeza para calcular o tamanho máximo de armazenamento de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1490">For long-running transactions, it may be useful to monitor the generation and cleanup rate to estimate the maximum size of the version store.</span></span>  
  
 <span data-ttu-id="12fe9-1491">[tamanho do repositório de versão comum] = 2 \* [dados de repositório de versão gerados por minuto] \* [maior tempo de execução (minutos) da transação]</span><span class="sxs-lookup"><span data-stu-id="12fe9-1491">[size of common version store] = 2 \* [version store data generated per minute] \* [longest running time (minutes) of the transaction]</span></span>  
  
 <span data-ttu-id="12fe9-1492">O tempo de execução mais longo das transações não deve incluir as compilações de índices online.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1492">The longest running time of transactions should not include online index builds.</span></span> <span data-ttu-id="12fe9-1493">Como essas operações podem demorar muito tempo em tabelas muito grandes, as compilações de índices online usam um armazenamento de versão separado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1493">Because these operations may take a long time on very large tables, online index builds use a separate version store.</span></span> <span data-ttu-id="12fe9-1494">O tamanho aproximado do repositório de versão de compilação de índices online é igual à quantidade de dados modificados na tabela, incluindo todos os índices, enquanto a compilação de índices online estiver ativa.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1494">The approximate size of the online index build version store equals the amount of data modified in the table, including all indexes, while the online index build is active.</span></span>  
  
 <span data-ttu-id="12fe9-1495">**Tamanho do Repositório de Versão (KB)** .</span><span class="sxs-lookup"><span data-stu-id="12fe9-1495">**Version Store Size (KB)**.</span></span> <span data-ttu-id="12fe9-1496">Monitora o tamanho em KB de todos os armazenamentos de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1496">Monitors the size in KB of all version stores.</span></span> <span data-ttu-id="12fe9-1497">Essas informações ajudam a determinar a quantidade de espaço necessária no banco de dados tempdb para o armazenamento de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1497">This information helps determine the amount of space needed in the tempdb database for the version store.</span></span> <span data-ttu-id="12fe9-1498">O monitoramento desse contador durante um determinado tempo fornece uma estimativa útil do espaço adicional necessário para tempdb.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1498">Monitoring this counter over a period of time provides a useful estimate of additional space needed for tempdb.</span></span>  
  
 <span data-ttu-id="12fe9-1499">`Version Generation rate (KB/s)`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1499">`Version Generation rate (KB/s)`.</span></span> <span data-ttu-id="12fe9-1500">Monitora a taxa de geração de versão, em KB por segundo, em todos os repositórios de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1500">Monitors the version generation rate in KB per second in all version stores.</span></span>  
  
 <span data-ttu-id="12fe9-1501">`Version Cleanup rate (KB/s)`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1501">`Version Cleanup rate (KB/s)`.</span></span> <span data-ttu-id="12fe9-1502">Monitora a taxa de limpeza de versão, em KB por segundo, em todos os repositórios de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1502">Monitors the version cleanup rate in KB per second in all version stores.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-1503">As informações da Taxa de Geração de Versão (KB/s) e da Taxa de Limpeza de Versão (KB/s) podem ser usadas para prever os requisitos de espaço de tempdb.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1503">Information from Version Generation rate (KB/s) and Version Cleanup rate (KB/s) can be used to predict tempdb space requirements.</span></span>  
  
 <span data-ttu-id="12fe9-1504">**Contagem de unidade de Repositório de Versão**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1504">**Version Store unit count**.</span></span> <span data-ttu-id="12fe9-1505">Monitora a contagem de unidades do repositório de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1505">Monitors the count of version store units.</span></span>  
  
 <span data-ttu-id="12fe9-1506">**Criação de unidade de Repositório de Versão**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1506">**Version Store unit creation**.</span></span> <span data-ttu-id="12fe9-1507">Monitora o número total de unidades de repositório de versão criadas para armazenar versões de linha depois que a instância tiver sido iniciada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1507">Monitors the total number of version store units created to store row versions since the instance was started.</span></span>  
  
 <span data-ttu-id="12fe9-1508">**Truncamento de unidade de Repositório de Versão**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1508">**Version Store unit truncation**.</span></span> <span data-ttu-id="12fe9-1509">Monitora o número total de unidades de repositório de versão truncadas depois que a instância tiver sido iniciada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1509">Monitors the total number of version store units truncated since the instance was started.</span></span> <span data-ttu-id="12fe9-1510">Uma unidade de repositório de versão é truncada quando o [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] determina que nenhuma das linhas de versão armazenadas na unidade de armazenamento de versão é necessária para a execução de transações ativas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1510">A version store unit is truncated when [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] determines that none of the version rows stored in the version store unit are needed to run active transactions.</span></span>  
  
 <span data-ttu-id="12fe9-1511">**Taxa de conflito de atualização**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1511">**Update conflict ratio**.</span></span> <span data-ttu-id="12fe9-1512">Monitora a taxa de transação de instantâneo de atualização com conflitos de atualização para o número total de transações de instantâneo de atualização.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1512">Monitors the ratio of update snapshot transaction that have update conflicts to the total number of update snapshot transactions.</span></span>  
  
 <span data-ttu-id="12fe9-1513">**Tempo de execução da transação mais longo**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1513">**Longest Transaction Running Time**.</span></span> <span data-ttu-id="12fe9-1514">Monitora o tempo de execução mais longo em segundos de qualquer transação que usa controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1514">Monitors the longest running time in seconds of any transaction using row versioning.</span></span> <span data-ttu-id="12fe9-1515">Pode ser usado para determinar se alguma transação está sendo executada por uma quantidade de tempo excessiva.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1515">This can be used to determine if any transaction is running for an unreasonable amount of time.</span></span>  
  
 <span data-ttu-id="12fe9-1516">**Transações**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1516">**Transactions**.</span></span> <span data-ttu-id="12fe9-1517">Monitora o número total de transações ativas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1517">Monitors the total number of active transactions.</span></span> <span data-ttu-id="12fe9-1518">Não inclui as transações de sistema.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1518">This does not include system transactions.</span></span>  
  
 <span data-ttu-id="12fe9-1519">`Snapshot Transactions`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1519">`Snapshot Transactions`.</span></span> <span data-ttu-id="12fe9-1520">Monitora o número total de transações de instantâneo ativas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1520">Monitors the total number of active snapshot transactions.</span></span>  
  
 <span data-ttu-id="12fe9-1521">`Update Snapshot Transactions`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1521">`Update Snapshot Transactions`.</span></span> <span data-ttu-id="12fe9-1522">Monitora o número total de transações de instantâneo ativas que executam operações de atualização.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1522">Monitors the total number of active snapshot transactions that perform update operations.</span></span>  
  
 <span data-ttu-id="12fe9-1523">`NonSnapshot Version Transactions`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1523">`NonSnapshot Version Transactions`.</span></span> <span data-ttu-id="12fe9-1524">Monitora o número total de transações de não instantâneo ativas que geram registros de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1524">Monitors the total number of active non-snapshot transactions that generate version records.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-1525">A soma de Transações de Instantâneo de Atualização e Transações de Versão Não Instantâneo representa o número total de transações que participam da geração de versão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1525">The sum of Update Snapshot Transactions and NonSnapshot Version Transactions represents the total number of transactions that participate in version generation.</span></span> <span data-ttu-id="12fe9-1526">A diferença de Transações de Instantâneo e Transações de Instantâneo de Atualização informa o número de transações de instantâneo somente leitura.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1526">The difference of Snapshot Transactions and Update Snapshot Transactions reports the number of read-only snapshot transactions.</span></span>  
  
### <a name="row-versioning-based-isolation-level-example"></a><span data-ttu-id="12fe9-1527">Exemplo de nível de isolamento com base em controle de versão de linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-1527">Row Versioning-based Isolation Level Example</span></span>  

 <span data-ttu-id="12fe9-1528">Os exemplos a seguir mostram as diferenças de comportamento entre transações de isolamento de instantâneo e transações de leitura confirmada que usam controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1528">The following examples show the differences in behavior between snapshot isolation transactions and read-committed transactions that use row versioning.</span></span>  
  
#### <a name="a-working-with-snapshot-isolation"></a><span data-ttu-id="12fe9-1529">a.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1529">A.</span></span> <span data-ttu-id="12fe9-1530">Trabalhando com isolamento de instantâneo</span><span class="sxs-lookup"><span data-stu-id="12fe9-1530">Working with snapshot isolation</span></span>  

 <span data-ttu-id="12fe9-1531">Neste exemplo, uma transação sendo executada sob um isolamento de instantâneo lê dados que são então modificados por outra transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1531">In this example, a transaction running under snapshot isolation reads data that is then modified by another transaction.</span></span> <span data-ttu-id="12fe9-1532">A transação de instantâneo não bloqueia a operação de atualização executada pela outra transação, e continua lendo dados do controle de versão de linha, ao mesmo tempo em que ignora a modificação de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1532">The snapshot transaction does not block the update operation executed by the other transaction, and it continues to read data from the versioned row, ignoring the data modification.</span></span> <span data-ttu-id="12fe9-1533">Porém, quando a transação de instantâneo tentar modificar os dados que já foram modificados pela outra transação, a transação de instantâneo gera um erro e é terminada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1533">However, when the snapshot transaction attempts to modify the data that has already been modified by the other transaction, the snapshot transaction generates an error and is terminated.</span></span>  
  
 <span data-ttu-id="12fe9-1534">Na sessão 1:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1534">On session 1:</span></span>  
  
```sql  
USE AdventureWorks2012;  -- Or the 2008 or 2008R2 version of the AdventureWorks database.  
GO  
  
-- Enable snapshot isolation on the database.  
ALTER DATABASE AdventureWorks2012  
    SET ALLOW_SNAPSHOT_ISOLATION ON;  
GO  
  
-- Start a snapshot transaction  
SET TRANSACTION ISOLATION LEVEL SNAPSHOT;  
GO  
  
BEGIN TRANSACTION;  
    -- This SELECT statement will return  
    -- 48 vacation hours for the employee.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
```  
  
 <span data-ttu-id="12fe9-1535">Sessão 2:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1535">On session 2:</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
  
-- Start a transaction.  
BEGIN TRANSACTION;  
    -- Subtract a vacation day from employee 4.  
    -- Update is not blocked by session 1 since  
    -- under snapshot isolation shared locks are  
    -- not requested.  
    UPDATE HumanResources.Employee  
        SET VacationHours = VacationHours - 8  
        WHERE BusinessEntityID = 4;  
  
    -- Verify that the employee now has 40 vacation hours.  
    SELECT VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
```  
  
 <span data-ttu-id="12fe9-1536">Na sessão 1:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1536">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement - this shows  
    -- the employee having 48 vacation hours.  The  
    -- snapshot transaction is still reading data from  
    -- the versioned row.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
```  
  
 <span data-ttu-id="12fe9-1537">Sessão 2:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1537">On session 2:</span></span>  
  
```sql  
-- Commit the transaction; this commits the data  
-- modification.  
COMMIT TRANSACTION;  
GO  
```  
  
 <span data-ttu-id="12fe9-1538">Na sessão 1:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1538">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement - this still   
    -- shows the employee having 48 vacation hours  
    -- even after the other transaction has committed  
    -- the data modification.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
    -- Because the data has been modified outside of the  
    -- snapshot transaction, any further data changes to   
    -- that data by the snapshot transaction will cause   
    -- the snapshot transaction to fail. This statement   
    -- will generate a 3960 error and the transaction will   
    -- terminate.  
    UPDATE HumanResources.Employee  
        SET SickLeaveHours = SickLeaveHours - 8  
        WHERE BusinessEntityID = 4;  
  
-- Undo the changes to the database from session 1.   
-- This will not undo the change from session 2.  
ROLLBACK TRANSACTION  
GO  
```  
  
#### <a name="b-working-with-read-committed-using-row-versioning"></a><span data-ttu-id="12fe9-1539">B.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1539">B.</span></span> <span data-ttu-id="12fe9-1540">Trabalhando com leituras confirmadas com o controle de versão de linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-1540">Working with read-committed using row versioning</span></span>  

 <span data-ttu-id="12fe9-1541">Neste exemplo, uma transação de leitura confirmada que usa o controle de versão de linha é executada ao mesmo tempo que outra transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1541">In this example, a read-committed transaction using row versioning runs concurrently with another transaction.</span></span> <span data-ttu-id="12fe9-1542">A transação de leitura confirmada se comporta diferentemente de uma transação de instantâneo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1542">The read-committed transaction behaves differently than a snapshot transaction.</span></span> <span data-ttu-id="12fe9-1543">Como uma transação de instantâneo, a transação de leitura confirmada lerá controles de versão de linhas, mesmo após a outra transação ter modificado os dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1543">Like a snapshot transaction, the read-committed transaction will read versioned rows even after the other transaction has modified data.</span></span> <span data-ttu-id="12fe9-1544">Entretanto, diferentemente de uma transação de instantâneo, a transação de leitura confirmada:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1544">However, unlike a snapshot transaction, the read-committed transaction will:</span></span>  
  
-   <span data-ttu-id="12fe9-1545">Lerá os dados modificados depois que a outra transação confirmar as mudanças de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1545">Read the modified data after the other transaction commits the data changes.</span></span>  
  
-   <span data-ttu-id="12fe9-1546">Poderá atualizar os dados modificados pela outra transação onde a transação de instantâneo não pôde.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1546">Be able to update the data modified by the other transaction where the snapshot transaction could not.</span></span>  
  
 <span data-ttu-id="12fe9-1547">Na sessão 1:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1547">On session 1:</span></span>  
  
```sql  
USE AdventureWorks2012;  -- Or any earlier version of the AdventureWorks database.  
GO  
  
-- Enable READ_COMMITTED_SNAPSHOT on the database.  
-- For this statement to succeed, this session  
-- must be the only connection to the AdventureWorks2012  
-- database.  
ALTER DATABASE AdventureWorks2012  
    SET READ_COMMITTED_SNAPSHOT ON;  
GO  
  
-- Start a read-committed transaction  
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;  
GO  
  
BEGIN TRANSACTION;  
    -- This SELECT statement will return  
    -- 48 vacation hours for the employee.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
```  
  
 <span data-ttu-id="12fe9-1548">Sessão 2:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1548">On session 2:</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
  
-- Start a transaction.  
BEGIN TRANSACTION;  
    -- Subtract a vacation day from employee 4.  
    -- Update is not blocked by session 1 since  
    -- under read-committed using row versioning shared locks are  
    -- not requested.  
    UPDATE HumanResources.Employee  
        SET VacationHours = VacationHours - 8  
        WHERE BusinessEntityID = 4;  
  
    -- Verify that the employee now has 40 vacation hours.  
    SELECT VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
```  
  
 <span data-ttu-id="12fe9-1549">Na sessão 1:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1549">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement - this still shows  
    -- the employee having 48 vacation hours.  The  
    -- read-committed transaction is still reading data   
    -- from the versioned row and the other transaction   
    -- has not committed the data changes yet.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
```  
  
 <span data-ttu-id="12fe9-1550">Sessão 2:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1550">On session 2:</span></span>  
  
```sql  
-- Commit the transaction.  
COMMIT TRANSACTION;  
GO  
  
```  
  
 <span data-ttu-id="12fe9-1551">Na sessão 1:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1551">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement which now shows the   
    -- employee having 40 vacation hours.  Being   
    -- read-committed, this transaction is reading the   
    -- committed data. This is different from snapshot  
    -- isolation which reads from the versioned row.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
    -- This statement, which caused the snapshot transaction   
    -- to fail, will succeed with read-committed using row versioning.  
    UPDATE HumanResources.Employee  
        SET SickLeaveHours = SickLeaveHours - 8  
        WHERE BusinessEntityID = 4;  
  
-- Undo the changes to the database from session 1.   
-- This will not undo the change from session 2.  
ROLLBACK TRANSACTION;  
GO  
```  
  
### <a name="enabling-row-versioning-based-isolation-levels"></a><span data-ttu-id="12fe9-1552">Habilitando os níveis de isolamento baseados em controle de versão de linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-1552">Enabling Row Versioning-Based Isolation Levels</span></span>  

 <span data-ttu-id="12fe9-1553">Os administradores de banco de dados controlam as configurações no nível de banco de dados para controle de versão de linha usando as opções de banco de dados READ_COMMITTED_SNAPSHOT e ALLOW_SNAPSHOT_ISOLATION na instrução ALTER DATABASE.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1553">Database administrators control the database-level settings for row versioning by using the READ_COMMITTED_SNAPSHOT and ALLOW_SNAPSHOT_ISOLATION database options in the ALTER DATABASE statement.</span></span>  
  
 <span data-ttu-id="12fe9-1554">Quando a opção de banco de dados READ_COMMITTED_SNAPSHOT está definida como ON, são ativados os mecanismos usados para oferece suporte à opção imediatamente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1554">When the READ_COMMITTED_SNAPSHOT database option is set ON, the mechanisms used to support the option are activated immediately.</span></span> <span data-ttu-id="12fe9-1555">Ao definir a opção READ_COMMITTED_SNAPSHOT, só a conexão que executa o comando ALTER DATABASE é permitida no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1555">When setting the READ_COMMITTED_SNAPSHOT option, only the connection executing the ALTER DATABASE command is allowed in the database.</span></span> <span data-ttu-id="12fe9-1556">Não deve haver nenhuma outra conexão aberta no banco de dados até que ALTER DATABASE esteja concluído.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1556">There must be no other open connection in the database until ALTER DATABASE is complete.</span></span> <span data-ttu-id="12fe9-1557">O banco de dados não precisa estar no modo do usuário único.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1557">The database does not have to be in single-user mode.</span></span>  
  
 <span data-ttu-id="12fe9-1558">A seguinte instrução [!INCLUDE[tsql](../includes/tsql-md.md)] habilita READ_COMMITTED_SNAPSHOT:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1558">The following [!INCLUDE[tsql](../includes/tsql-md.md)] statement enables READ_COMMITTED_SNAPSHOT:</span></span>  
  
```sql  
ALTER DATABASE AdventureWorks2012  
    SET READ_COMMITTED_SNAPSHOT ON;  
```  
  
 <span data-ttu-id="12fe9-1559">Quando a opção banco de dados ALLOW_SNAPSHOT_ISOLATION está definida como ON, a instância do [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] não gera versões de linhas para os dados modificados até que todas as transações ativas que modificaram os dados no banco de dados estejam concluídas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1559">When the ALLOW_SNAPSHOT_ISOLATION database option is set ON, the instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] does not generate row versions for modified data until all active transactions that have modified data in the database complete.</span></span> <span data-ttu-id="12fe9-1560">Se houver transações de modificação ativas, o [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] definirá o estado da opção como PENDING_ON.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1560">If there are active modification transactions, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] sets the state of the option to PENDING_ON.</span></span> <span data-ttu-id="12fe9-1561">Depois que todas as modificações de transações estiverem concluídas, o estado da opção é alterado para ON.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1561">After all of the modification transactions complete, the state of the option is changed to ON.</span></span> <span data-ttu-id="12fe9-1562">Os usuários não podem iniciar uma transação de instantâneo nesse banco de dados até que a opção esteja completamente ON.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1562">Users cannot start a snapshot transaction in that database until the option is fully ON.</span></span> <span data-ttu-id="12fe9-1563">O banco de dados passa por um estado de PENDING_OFF quando o administrador de banco de dados define a opção ALLOW_SNAPSHOT_ISOLATION como OFF.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1563">The database passes through a PENDING_OFF state when the database administrator sets the ALLOW_SNAPSHOT_ISOLATION option to OFF.</span></span>  
  
 <span data-ttu-id="12fe9-1564">A instrução [!INCLUDE[tsql](../includes/tsql-md.md)] a seguir habilitará ALLOW_SNAPSHOT_ISOLATION:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1564">The following [!INCLUDE[tsql](../includes/tsql-md.md)] statement will enable ALLOW_SNAPSHOT_ISOLATION:</span></span>  
  
```sql  
ALTER DATABASE AdventureWorks2012  
    SET ALLOW_SNAPSHOT_ISOLATION ON;  
```  
  
 <span data-ttu-id="12fe9-1565">A tabela a seguir relaciona e descreve os estados da opção ALLOW_SNAPSHOT_ISOLATION.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1565">The following table lists and describes the states of the ALLOW_SNAPSHOT_ISOLATION option.</span></span> <span data-ttu-id="12fe9-1566">Usar a opção ALTER DATABASE com a opção ALLOW_SNAPSHOT_ISOLATION não bloqueará os usuários que estiverem acessando os dados do banco de dados no momento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1566">Using ALTER DATABASE with the ALLOW_SNAPSHOT_ISOLATION option does not block users who are currently accessing the database data.</span></span>  
  
|<span data-ttu-id="12fe9-1567">Estado da estrutura de isolamento de instantâneo para banco de dados atual</span><span class="sxs-lookup"><span data-stu-id="12fe9-1567">State of snapshot isolation framework for current database</span></span>|<span data-ttu-id="12fe9-1568">Descrição</span><span class="sxs-lookup"><span data-stu-id="12fe9-1568">Description</span></span>|  
|----------------------------------------------------------------|-----------------|  
|<span data-ttu-id="12fe9-1569">OFF</span><span class="sxs-lookup"><span data-stu-id="12fe9-1569">OFF</span></span>|<span data-ttu-id="12fe9-1570">O suporte para as transações de isolamento de instantâneo não está ativado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1570">The support for snapshot isolation transactions is not activated.</span></span> <span data-ttu-id="12fe9-1571">Não é permitida nenhuma transação de isolamento de instantâneo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1571">No snapshot isolation transactions are allowed.</span></span>|  
|<span data-ttu-id="12fe9-1572">PENDING_ON</span><span class="sxs-lookup"><span data-stu-id="12fe9-1572">PENDING_ON</span></span>|<span data-ttu-id="12fe9-1573">O suporte para as transações de isolamento de instantâneo está em estado de transição (de OFF para ON).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1573">The support for snapshot isolation transactions is in transition state (from OFF to ON).</span></span> <span data-ttu-id="12fe9-1574">As transações abertas precisam ser concluídas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1574">Open transactions must complete.</span></span><br /><br /> <span data-ttu-id="12fe9-1575">Não é permitida nenhuma transação de isolamento de instantâneo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1575">No snapshot isolation transactions are allowed.</span></span>|  
|<span data-ttu-id="12fe9-1576">ATIVADO</span><span class="sxs-lookup"><span data-stu-id="12fe9-1576">ON</span></span>|<span data-ttu-id="12fe9-1577">O suporte para as transações de isolamento de instantâneo está ativado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1577">The support for snapshot isolation transactions is activated.</span></span><br /><br /> <span data-ttu-id="12fe9-1578">São permitidas transações de instantâneo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1578">Snapshot transactions are allowed.</span></span>|  
|<span data-ttu-id="12fe9-1579">PENDING_OFF</span><span class="sxs-lookup"><span data-stu-id="12fe9-1579">PENDING_OFF</span></span>|<span data-ttu-id="12fe9-1580">O suporte para as transações de isolamento de instantâneo está em estado de transição (de ON para OFF).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1580">The support for snapshot isolation transactions is in transition state (from ON to OFF).</span></span><br /><br /> <span data-ttu-id="12fe9-1581">As transações de instantâneo iniciadas depois dessa hora não poderão acessar este banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1581">Snapshot transactions started after this time cannot access this database.</span></span> <span data-ttu-id="12fe9-1582">Atualizar transações ainda paga o custo de controle de versão neste banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1582">Update transactions still pay the cost of versioning in this database.</span></span> <span data-ttu-id="12fe9-1583">As transações de instantâneo existentes ainda podem acessar este banco de dados sem problemas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1583">Existing snapshot transactions can still access this database without a problem.</span></span> <span data-ttu-id="12fe9-1584">O estado PENDING_OFF não se torna OFF até que todas as transações de instantâneo, que estavam ativas quando o estado de isolamento de instantâneo do banco de dados era ON, forem concluídas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1584">The state PENDING_OFF does not become OFF until all snapshot transactions that were active when the database snapshot isolation state was ON finish.</span></span>|  
  
 <span data-ttu-id="12fe9-1585">Use as exibições do catálogo sys.databases para determinar o estado de ambas as opções do banco de dados de controle de versão de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1585">Use the sys.databases catalog view to determine the state of both row versioning database options.</span></span>  
  
 <span data-ttu-id="12fe9-1586">Todas as atualizações para tabelas de usuário e algumas tabelas do sistema armazenados no mestre e no msdb geram versões de linha.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1586">All updates to user tables and some system tables stored in master and msdb generate row versions.</span></span>  
  
 <span data-ttu-id="12fe9-1587">A opção ALLOW_SNAPSHOT_ISOLATION é definida automaticamente como ON nos bancos de dados mestre e msdb e não pode ser desabilitada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1587">The ALLOW_SNAPSHOT_ISOLATION option is automatically set ON in the master and msdb databases, and cannot be disabled.</span></span>  
  
 <span data-ttu-id="12fe9-1588">Os usuários não podem definir a opção READ_COMMITTED_SNAPSHOT como ON no mestre, no tempdb ou no msdb.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1588">Users cannot set the READ_COMMITTED_SNAPSHOT option ON in master, tempdb, or msdb.</span></span>  
  
### <a name="using-row-versioning-based-isolation-levels"></a><span data-ttu-id="12fe9-1589">Usando níveis de isolamento com base em controle de versão de linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-1589">Using Row Versioning-based Isolation Levels</span></span>  

 <span data-ttu-id="12fe9-1590">A estrutura de controle de versão de linha permanece sempre habilitada no [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] e é usada por vários recursos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1590">The row versioning framework is always enabled in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], and is used by multiple features.</span></span> <span data-ttu-id="12fe9-1591">Além de fornecer níveis de isolamento com base em controle de versão de linha, ela é usada para oferecer suporte a modificações feitas em gatilhos e em sessões MARS (Multiple Active Result Sets), e para oferecer suporte à leitura de dados de operações de índice ONLINE.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1591">Besides providing row versioning-based isolation levels, it is used to support modifications made in triggers and multiple active result sets (MARS) sessions, and to support data reads for ONLINE index operations.</span></span>  
  
 <span data-ttu-id="12fe9-1592">Os níveis de isolamento com base em controle de versão de linha são habilitados no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1592">Row versioning-based isolation levels are enabled at the database level.</span></span> <span data-ttu-id="12fe9-1593">Todos os aplicativos que acessam os objetos de bancos de dados habilitados podem executar consultas usando os seguintes níveis de isolamento:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1593">Any application accessing objects from enabled databases can run queries using the following isolation levels:</span></span>  
  
-   <span data-ttu-id="12fe9-1594">Leitura confirmada que usa controle de versão de linha pela definição da opção de banco de dados `READ_COMMITTED_SNAPSHOT` como `ON`, como mostrado no seguinte exemplo de código:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1594">Read-committed that uses row versioning by setting the `READ_COMMITTED_SNAPSHOT` database option to `ON` as shown in the following code example:</span></span>  
  
    ```sql  
    ALTER DATABASE AdventureWorks2012  
        SET READ_COMMITTED_SNAPSHOT ON;  
    ```  
  
     <span data-ttu-id="12fe9-1595">Quando o banco de dados está habilitado para READ_COMMITTED_SNAPSHOT, todas as consultas no nível de isolamento confirmado para leitura usam controle de versão de linha, o que significa que as operações de leitura não bloqueiam as operações de atualização.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1595">When the database is enabled for READ_COMMITTED_SNAPSHOT, all queries running under the read committed isolation level use row versioning, which means that read operations do not block update operations.</span></span>  
  
-   <span data-ttu-id="12fe9-1596">Isolamento do instantâneo através da definição da opção de banco de dados `ALLOW_SNAPSHOT_ISOLATION` como `ON`, como mostrado no exemplo de código seguinte:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1596">Snapshot isolation by setting the `ALLOW_SNAPSHOT_ISOLATION` database option to `ON` as shown in the following code example:</span></span>  
  
    ```sql  
    ALTER DATABASE AdventureWorks2012  
        SET ALLOW_SNAPSHOT_ISOLATION ON;  
    ```  
  
     <span data-ttu-id="12fe9-1597">Uma transação executada em isolamento de instantâneo pode acessar tabelas do banco de dados habilitadas para instantâneo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1597">A transaction running under snapshot isolation can access tables in the database that have been enabled for snapshot.</span></span> <span data-ttu-id="12fe9-1598">Para acessar tabelas que não foram habilitadas para instantâneo, é preciso alterar o nível de isolamento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1598">To access tables that have not been enabled for snapshot, the isolation level must be changed.</span></span> <span data-ttu-id="12fe9-1599">Por exemplo, o exemplo de código a seguir mostra uma instrução `SELECT` que une duas tabelas durante a execução de uma transação de instantâneo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1599">For example, the following code example shows a `SELECT` statement that joins two tables while running under a snapshot transaction.</span></span> <span data-ttu-id="12fe9-1600">Uma das tabelas pertence a um banco de dados no qual o isolamento de instantâneo não está habilitado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1600">One table belongs to a database in which snapshot isolation is not enabled.</span></span> <span data-ttu-id="12fe9-1601">Quando a instrução `SELECT` for executada no isolamento de instantâneo, não será executada com êxito.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1601">When the `SELECT` statement runs under snapshot isolation, it fails to execute successfully.</span></span>  
  
    ```sql  
    SET TRANSACTION ISOLATION LEVEL SNAPSHOT;  
    BEGIN TRAN  
        SELECT t1.col5, t2.col5  
            FROM Table1 as t1  
            INNER JOIN SecondDB.dbo.Table2 as t2  
                ON t1.col1 = t2.col2;  
    ```  
  
     <span data-ttu-id="12fe9-1602">O exemplo de código a seguir mostra a mesma instrução `SELECT` que foi modificada para alterar o nível de isolamento da transação para leitura confirmada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1602">The following code example shows the same `SELECT` statement that has been modified to change the transaction isolation level to read-committed.</span></span> <span data-ttu-id="12fe9-1603">Em razão dessa mudança, a instrução `SELECT` será executada com êxito.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1603">Because of this change, the `SELECT` statement executes successfully.</span></span>  
  
    ```sql  
    SET TRANSACTION ISOLATION LEVEL SNAPSHOT;  
    BEGIN TRAN  
        SELECT t1.col5, t2.col5  
            FROM Table1 as t1  
            WITH (READCOMMITTED)  
            INNER JOIN SecondDB.dbo.Table2 as t2  
                ON t1.col1 = t2.col2;  
    ```  
  
#### <a name="limitations-of-transactions-using-row-versioning-based-isolation-levels"></a><span data-ttu-id="12fe9-1604">Limitações de transações usando níveis de isolamento com base em controle de versão de linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-1604">Limitations of Transactions Using Row Versioning-based Isolation Levels</span></span>  

 <span data-ttu-id="12fe9-1605">Considere as limitações a seguir ao trabalhar com níveis de isolamento baseados em controle de versão de linha:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1605">Consider the following limitations when working with row versioning-based isolation levels:</span></span>  
  
-   <span data-ttu-id="12fe9-1606">READ_COMMITTED_SNAPSHOT não pode ser habilitada em tempdb, msdb, nem em master.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1606">READ_COMMITTED_SNAPSHOT cannot be enabled in tempdb, msdb, or master.</span></span>  
  
-   <span data-ttu-id="12fe9-1607">As tabelas temporárias globais são armazenadas em tempdb.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1607">Global temp tables are stored in tempdb.</span></span> <span data-ttu-id="12fe9-1608">Ao acessar tabelas temporárias globais em uma transação de instantâneo, uma das seguintes ações deve ocorrer:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1608">When accessing global temp tables inside a snapshot transaction, one of the following must happen:</span></span>  
  
    -   <span data-ttu-id="12fe9-1609">Defina a opção de banco de dados ALLOW_SNAPSHOT_ISOLATION como ON em tempdb.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1609">Set the ALLOW_SNAPSHOT_ISOLATION database option ON in tempdb.</span></span>  
  
    -   <span data-ttu-id="12fe9-1610">Use uma dica de isolamento para alterar o nível de isolamento da instrução.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1610">Use an isolation hint to change the isolation level for the statement.</span></span>  
  
-   <span data-ttu-id="12fe9-1611">Transações de instantâneo falham quando:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1611">Snapshot transactions fail when:</span></span>  
  
    -   <span data-ttu-id="12fe9-1612">O banco de dados é transformado em somente leitura após o início da transação de instantâneo, mas antes que a transação de instantâneo acesse o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1612">A database is made read-only after the snapshot transaction starts, but before the snapshot transaction accesses the database.</span></span>  
  
    -   <span data-ttu-id="12fe9-1613">Se objetos forem acessados em vários bancos de dados, um estado de banco de dados terá sido alterado de tal modo que a recuperação do banco de dados ocorrerá após o início da transação de instantâneo, mas antes que a transação de instantâneo acesse o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1613">If accessing objects from multiple databases, a database state was changed in such a way that database recovery occurred after a snapshot transaction starts, but before the snapshot transaction accesses the database.</span></span> <span data-ttu-id="12fe9-1614">Por exemplo: o banco de dados foi definido como OFFLINE e depois como ONLINE; o banco de dados fecha automaticamente e se abre ou o banco de dados é desanexado e anexado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1614">For example: the database was set to OFFLINE and then to ONLINE, database autoclose and open, or database detach and attach.</span></span>  
  
-   <span data-ttu-id="12fe9-1615">Não há suporte para transações distribuídas, inclusive consultas em bancos de dados particionados distribuídos em isolamento de instantâneo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1615">Distributed transactions, including queries in distributed partitioned databases, are not supported under snapshot isolation.</span></span>  
  
-   [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] <span data-ttu-id="12fe9-1616">não mantém versões múltiplas de metadados de sistema.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1616">does not keep multiple versions of system metadata.</span></span> <span data-ttu-id="12fe9-1617">As instruções DDL (Linguagem de Definição de Dados) em tabelas e em outros objetos de banco de dados (índices, exibições, tipos de dados, procedimentos armazenados e funções CLR (Common Language Runtime)) alteram metadados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1617">Data definition language (DDL) statements on tables and other database objects (indexes, views, data types, stored procedures, and common language runtime functions) change metadata.</span></span> <span data-ttu-id="12fe9-1618">Se uma instrução DDL modificar um objeto, qualquer referência simultânea ao objeto em isolamento de instantâneo fará com que a transação de instantâneo falhe.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1618">If a DDL statement modifies an object, any concurrent reference to the object under snapshot isolation causes the snapshot transaction to fail.</span></span> <span data-ttu-id="12fe9-1619">Transações de leitura confirmada não têm essa limitação quando a opção de banco de dados READ_COMMITTED_SNAPSHOT é ON.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1619">Read-committed transactions do not have this limitation when the READ_COMMITTED_SNAPSHOT database option is ON.</span></span>  
  
     <span data-ttu-id="12fe9-1620">Por exemplo, um administrador de banco de dados executa a instrução `ALTER INDEX` a seguir.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1620">For example, a database administrator executes the following `ALTER INDEX` statement.</span></span>  
  
    ```sql  
    USE AdventureWorks2012;  
    GO  
    ALTER INDEX AK_Employee_LoginID  
        ON HumanResources.Employee REBUILD;  
    GO  
    ```  
  
     <span data-ttu-id="12fe9-1621">Qualquer transação de instantâneo que esteja ativa quando a instrução `ALTER INDEX` for executada receberá um erro, caso ela tente fazer referência à tabela `HumanResources.Employee` após a execução da instrução `ALTER INDEX`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1621">Any snapshot transaction that is active when the `ALTER INDEX` statement is executed receives an error if it attempts to reference the `HumanResources.Employee` table after the `ALTER INDEX` statement is executed.</span></span> <span data-ttu-id="12fe9-1622">As transações de leitura confirmada que usam controle de versão de linha não são afetadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1622">Read-committed transactions using row versioning are not affected.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="12fe9-1623">As operações BULK INSERT podem causar alterações a metadados da tabela de destino (por exemplo, ao desabilitar verificações de restrição).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1623">BULK INSERT operations may cause changes to target table metadata (for example, when disabling constraint checks).</span></span> <span data-ttu-id="12fe9-1624">Quando isso ocorre, as transações de isolamento de instantâneo simultâneas que acessam tabelas inseridas em massa falham.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1624">When this happens, concurrent snapshot isolation transactions accessing bulk inserted tables fail.</span></span>  
  
 <span data-ttu-id="12fe9-1625">![Ícone de seta usado com o link voltar ao início](media/uparrow16x16.gif "Ícone de seta usado com o link Voltar ao Início") [neste guia](#Top)</span><span class="sxs-lookup"><span data-stu-id="12fe9-1625">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
## <a name="customizing-locking-and-row-versioning"></a><span data-ttu-id="12fe9-1626">Personalizando bloqueio e controle de versão de linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-1626">Customizing Locking and Row Versioning</span></span>  
  
### <a name="customizing-the-lock-time-out"></a><span data-ttu-id="12fe9-1627">Personalizando tempo limite de bloqueio</span><span class="sxs-lookup"><span data-stu-id="12fe9-1627">Customizing the Lock Time-Out</span></span>  

 <span data-ttu-id="12fe9-1628">Quando uma instância do [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] não pode conceder um bloqueio para uma transação porque outra transação já tem um bloqueio conflitante no recurso, a primeira transação fica bloqueada esperando que o bloqueio existente seja liberado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1628">When an instance of the [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] cannot grant a lock to a transaction because another transaction already owns a conflicting lock on the resource, the first transaction becomes blocked waiting for the existing lock to be released.</span></span> <span data-ttu-id="12fe9-1629">Por padrão, não existe período obrigatório de tempo limite e nenhuma forma para testar se um recurso está bloqueado antes de bloqueá-lo, exceto a tentativa de acessar os dados (e potencialmente ser bloqueado indefinidamente).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1629">By default, there is no mandatory time-out period and no way to test whether a resource is locked before locking it, except to attempt to access the data (and potentially get blocked indefinitely).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-1630">No [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], use a exibição de gerenciamento dinâmico **sys.dm_os_waiting_tasks** para determinar se um processo está sendo bloqueado e quem o está bloqueando.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1630">In [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], use the **sys.dm_os_waiting_tasks** dynamic management view to determine whether a process is being blocked and who is blocking it.</span></span> <span data-ttu-id="12fe9-1631">Em versões anteriores do [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], use o procedimento armazenado do sistema **sp_who**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1631">In earlier versions of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], use the **sp_who** system stored procedure.</span></span>  
  
 <span data-ttu-id="12fe9-1632">A configuração LOCK_TIMEOUT permite que um aplicativo defina um tempo máximo que uma instrução espera um recurso bloqueado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1632">The LOCK_TIMEOUT setting allows an application to set a maximum time that a statement waits on a blocked resource.</span></span> <span data-ttu-id="12fe9-1633">Quando uma instrução espera por mais tempo do que a configuração LOCK_TIMEOUT, a instrução bloqueada é cancelada automaticamente e a mensagem de erro 1222 (`Lock request time-out period exceeded`) é retornada ao aplicativo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1633">When a statement has waited longer than the LOCK_TIMEOUT setting, the blocked statement is canceled automatically, and error message 1222 (`Lock request time-out period exceeded`) is returned to the application.</span></span> <span data-ttu-id="12fe9-1634">Porém, qualquer transação que contém a instrução não é revertida ou cancelada pelo [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-1634">Any transaction containing the statement, however, is not rolled back or canceled by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="12fe9-1635">Portanto, o aplicativo deve ter um identificador de erro que possa interceptar a mensagem de erro 1222.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1635">Therefore, the application must have an error handler that can trap error message 1222.</span></span> <span data-ttu-id="12fe9-1636">Se um aplicativo não interceptar o erro, o aplicativo poderá continuar sem reconhecer que uma instrução individual dentro de uma transação foi cancelada, e poderão ocorrer erros porque as instruções posteriores da transação podem depender da instrução que nunca foi executada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1636">If an application does not trap the error, the application can proceed unaware that an individual statement within a transaction has been canceled, and errors can occur because statements later in the transaction might depend on the statement that was never executed.</span></span>  
  
 <span data-ttu-id="12fe9-1637">A implementação de um identificador de erro que intercepte a mensagem de erro 1222 permite que um aplicativo possa lidar com a situação de tempo limite e execute uma ação para corrigir a situação, como: automaticamente enviar novamente a instrução que estava bloqueada ou reverter toda a transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1637">Implementing an error handler that traps error message 1222 allows an application to handle the time-out situation and take remedial action, such as: automatically resubmitting the statement that was blocked or rolling back the entire transaction.</span></span>  
  
 <span data-ttu-id="12fe9-1638">Para determinar a configuração atual de LOCK_TIMEOUT, execute a @LOCK_TIMEOUT função @:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1638">To determine the current LOCK_TIMEOUT setting, execute the @@LOCK_TIMEOUT function:</span></span>  
  
```sql  
SELECT @@lock_timeout;  
GO  
```  
  
### <a name="customizing-transaction-isolation-level"></a><span data-ttu-id="12fe9-1639">Personalizando o nível de isolamento da transação</span><span class="sxs-lookup"><span data-stu-id="12fe9-1639">Customizing Transaction Isolation Level</span></span>  

 <span data-ttu-id="12fe9-1640">READ COMMITTED é o nível de isolamento padrão do [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-1640">READ COMMITTED is the default isolation level for the [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span></span> <span data-ttu-id="12fe9-1641">Se um aplicativo precisar operar em um nível de isolamento diferente, poderá usar os seguintes métodos para definir o nível de isolamento:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1641">If an application must operate at a different isolation level, it can use the following methods to set the isolation level:</span></span>  
  
-   <span data-ttu-id="12fe9-1642">Executar a instrução [SET TRANSACTION ISOLATION LEVEL](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1642">Run the [SET TRANSACTION ISOLATION LEVEL](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql) statement.</span></span>  
  
-   <span data-ttu-id="12fe9-1643">Aplicativos ADO.NET que usam o SqlClient namespace gerenciado podem especificar uma opção *IsolationLevel* usando o método SqlConnection.BeginTransaction.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1643">ADO.NET applications that use the System.Data.SqlClient managed namespace can specify an *IsolationLevel* option by using the SqlConnection.BeginTransaction method.</span></span>  
  
-   <span data-ttu-id="12fe9-1644">Aplicativos que usam ADO podem definir a propriedade `Autocommit Isolation Levels`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1644">Applications that use ADO can set the `Autocommit Isolation Levels` property.</span></span>  
  
-   <span data-ttu-id="12fe9-1645">Ao iniciar uma transação, os aplicativos que usam OLE DB podem chamar ITransactionLocal::StartTransaction com *isoLevel* definido como o nível desejado de isolamento da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1645">When starting a transaction, applications using OLE DB can call ITransactionLocal::StartTransaction with *isoLevel* set to the desired transaction isolation level.</span></span> <span data-ttu-id="12fe9-1646">Ao especificar o nível de isolamento em modo de confirmação automática, os aplicativos que usam OLE DB podem definir a propriedade DBPROPSET_SESSION DBPROP_SESS_AUTOCOMMITISOLEVELS como o nível desejado de isolamento da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1646">When specifying the isolation level in autocommit mode, applications that use OLE DB can set the DBPROPSET_SESSION property DBPROP_SESS_AUTOCOMMITISOLEVELS to the desired transaction isolation level.</span></span>  
  
-   <span data-ttu-id="12fe9-1647">Aplicativos que usam ODBC podem definir o atributo SQL_COPT_SS_TXN_ISOLATION usando SQLSetConnectAttr.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1647">Applications that use ODBC can set the SQL_COPT_SS_TXN_ISOLATION attribute by using SQLSetConnectAttr.</span></span>  
  
 <span data-ttu-id="12fe9-1648">Quando o nível de isolamento é especificado, o comportamento de bloqueio de todas as consultas e instruções de DML (linguagem de manipulação de dados) na sessão [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] opera nesse nível de isolamento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1648">When the isolation level is specified, the locking behavior for all queries and data manipulation language (DML) statements in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] session operates at that isolation level.</span></span> <span data-ttu-id="12fe9-1649">O nível de isolamento permanece em vigor até o término da sessão ou até que o nível de isolamento seja definido como outro nível.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1649">The isolation level remains in effect until the session terminates or until the isolation level is set to another level.</span></span>  
  
 <span data-ttu-id="12fe9-1650">O exemplo seguinte define o nível de isolamento `SERIALIZABLE`:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1650">The following example sets the `SERIALIZABLE` isolation level:</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;  
GO  
BEGIN TRANSACTION;  
SELECT BusinessEntityID  
    FROM HumanResources.Employee;  
GO  
```  
  
 <span data-ttu-id="12fe9-1651">O nível de isolamento pode ser substituído por uma consulta individual ou instruções DML, se necessário, especificando uma dica no nível de tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1651">The isolation level can be overridden for individual query or DML statements, if necessary, by specifying a table-level hint.</span></span> <span data-ttu-id="12fe9-1652">A especificação de uma dica no nível de tabela não afeta outras instruções na sessão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1652">Specifying a table-level hint does not affect other statements in the session.</span></span> <span data-ttu-id="12fe9-1653">Recomendamos que as dicas no nível de tabela sejam usadas para alterar o comportamento padrão apenas quando absolutamente necessário.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1653">We recommend that table-level hints be used to change the default behavior only when absolutely necessary.</span></span>  
  
 <span data-ttu-id="12fe9-1654">O [!INCLUDE[ssDE](../includes/ssde-md.md)] talvez tenha que adquirir bloqueios ao ler metadados mesmo quando o nível de isolamento é definido como um nível em que os bloqueios de compartilhamento não são solicitados durante a leitura de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1654">The [!INCLUDE[ssDE](../includes/ssde-md.md)] might have to acquire locks when reading metadata even when the isolation level is set to a level where share locks are not requested when reading data.</span></span> <span data-ttu-id="12fe9-1655">Por exemplo, uma transação em execução no nível de isolamento de leitura não confirmada não adquire bloqueios de compartilhamento ao ler dados, mas pode solicitar bloqueios ao ler uma exibição de catálogo do sistema.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1655">For example, a transaction running at the read-uncommitted isolation level does not acquire share locks when reading data, but might sometime request locks when reading a system catalog view.</span></span> <span data-ttu-id="12fe9-1656">Isso significa que é possível que uma transação de leitura não confirmada cause o bloqueio ao consultar uma tabela quando uma transação simultânea estiver modificando os metadados dessa tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1656">This means it is possible for a read uncommitted transaction to cause blocking when querying a table when a concurrent transaction is modifying the metadata of that table.</span></span>  
  
 <span data-ttu-id="12fe9-1657">Para determinar o nível de isolamento da transação definido atualmente, use a instrução `DBCC USEROPTIONS`, como mostrado no exemplo a seguir.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1657">To determine the transaction isolation level currently set, use the `DBCC USEROPTIONS` statement as shown in the following example.</span></span> <span data-ttu-id="12fe9-1658">O conjunto de resultados pode ser diferente do conjunto de resultados em seu sistema.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1658">The result set may vary from the result set on your system.</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;  
GO  
DBCC USEROPTIONS;  
GO  
```  
  
 [!INCLUDE[ssResult](../includes/ssresult-md.md)]  
  
 `Set Option                   Value`  
  
 `---------------------------- -------------------------------------------`  
  
 `textsize                     2147483647`  
  
 `language                     us_english`  
  
 `dateformat                   mdy`  
  
 `datefirst                    7`  
  
 `...                          ...`  
  
 `Isolation level              repeatable read`  
  
 ``  
  
 `(14 row(s) affected)`  
  
 ``  
  
 `DBCC execution completed. If DBCC printed error messages, contact your system administrator.`  
  
### <a name="locking-hints"></a><span data-ttu-id="12fe9-1659">Dicas de bloqueio</span><span class="sxs-lookup"><span data-stu-id="12fe9-1659">Locking Hints</span></span>  

 <span data-ttu-id="12fe9-1660">Dicas de bloqueio podem ser especificadas para referências de tabela individuais nas instruções SELECT, INSERT, UPDATE e DELETE.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1660">Locking hints can be specified for individual table references in the SELECT, INSERT, UPDATE, and DELETE statements.</span></span> <span data-ttu-id="12fe9-1661">As dicas especificam o tipo de bloqueio ou controle de versão de linha da instância que o [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] usa para dados de tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1661">The hints specify the type of locking or row versioning the instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses for the table data.</span></span> <span data-ttu-id="12fe9-1662">Dicas de bloqueio de tabelas podem ser usadas quando é necessário um controle mais refinado dos tipos de bloqueios adquiridos em um objeto.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1662">Table-level locking hints can be used when a finer control of the types of locks acquired on an object is required.</span></span> <span data-ttu-id="12fe9-1663">Essas dicas de bloqueio substituem o nível de isolamento da transação atual na sessão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1663">These locking hints override the current transaction isolation level for the session.</span></span>  
  
 <span data-ttu-id="12fe9-1664">Para obter mais informações sobre as dicas de bloqueio específicas e seus comportamentos, veja [Dicas de tabela&#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-table).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1664">For more information about the specific locking hints and their behaviors, see [Table Hints &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-table).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-1665">O otimizador de consulta [!INCLUDE[ssDE](../includes/ssde-md.md)] quase sempre escolhe o nível de bloqueio correto.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1665">The [!INCLUDE[ssDE](../includes/ssde-md.md)] query optimizer almost always chooses the correct locking level.</span></span> <span data-ttu-id="12fe9-1666">É recomendável que as dicas de bloqueio no nível de tabela sejam usadas para alterar o comportamento de bloqueio padrão apenas quando necessário.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1666">We recommend that table-level locking hints be used to change the default locking behavior only when necessary.</span></span> <span data-ttu-id="12fe9-1667">Não permitir um nível de bloqueio pode afetar adversamente a simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1667">Disallowing a locking level can adversely affect concurrency.</span></span>  
  
 <span data-ttu-id="12fe9-1668">O [!INCLUDE[ssDE](../includes/ssde-md.md)] talvez tenha que adquirir bloqueios ao ler metadados, mesmo quando está processando uma seleção com uma dica de bloqueio, que impede solicitações para bloqueios de compartilhamento durante a leitura de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1668">The [!INCLUDE[ssDE](../includes/ssde-md.md)] might have to acquire locks when reading metadata, even when processing a select with a locking hint that prevents requests for share locks when reading data.</span></span> <span data-ttu-id="12fe9-1669">Por exemplo, SELECT usando a dica NOLOCK não adquire bloqueios de compartilhamento ao ler dados, mas pode solicitar bloqueios ao ler uma exibição de catálogo do sistema.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1669">For example, a SELECT using the NOLOCK hint does not acquire share locks when reading data, but might sometime request locks when reading a system catalog view.</span></span> <span data-ttu-id="12fe9-1670">Isso significa que é possível uma instrução SELECT usando NOLOCK ser bloqueada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1670">This means it is possible for a SELECT statement using NOLOCK to be blocked.</span></span>  
  
 <span data-ttu-id="12fe9-1671">Como é mostrado no exemplo a seguir, se o nível de isolamento da transação for configurado para `SERIALIZABLE`, e a dica de bloqueio em nível de tabela `NOLOCK` for usada com a instrução `SELECT`, bloqueios de intervalo de chaves usados para manter transações serializáveis não são aceitos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1671">As shown in the following example, if the transaction isolation level is set to `SERIALIZABLE`, and the table-level locking hint `NOLOCK` is used with the `SELECT` statement, key-range locks typically used to maintain serializable transactions are not taken.</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;  
GO  
BEGIN TRANSACTION;  
GO  
SELECT JobTitle  
    FROM HumanResources.Employee WITH (NOLOCK);  
GO  
  
-- Get information about the locks held by   
-- the transaction.  
SELECT    
        resource_type,   
        resource_subtype,   
        request_mode  
    FROM sys.dm_tran_locks  
    WHERE request_session_id = @@spid;  
  
-- End the transaction.  
ROLLBACK;  
GO  
```  
  
 <span data-ttu-id="12fe9-1672">O único bloqueio aceito que referencia `HumanResources.Employee` é um bloqueio de estabilidade (Sch-S) de esquema.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1672">The only lock taken that references `HumanResources.Employee` is a schema stability (Sch-S) lock.</span></span> <span data-ttu-id="12fe9-1673">Nesse caso, a seriabilidade não é mais garantida.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1673">In this case, serializability is no longer guaranteed.</span></span>  
  
 <span data-ttu-id="12fe9-1674">No [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)], a opção LOCK_ESCALATION de ALTER TABLE pode não favorecer bloqueios de tabela e ativar bloqueios HoBT em tabelas particionadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1674">In [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)], the LOCK_ESCALATION option of ALTER TABLE can disfavor table locks, and enable HoBT locks on partitioned tables.</span></span> <span data-ttu-id="12fe9-1675">Essa opção não é uma dica de bloqueio, mas pode ser usada para reduzir o escalonamento do bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1675">This option is not a locking hint, but can but used to reduce lock escalation.</span></span> <span data-ttu-id="12fe9-1676">Para obter mais informações, veja [ALTER TABLE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-table-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1676">For more information, see [ALTER TABLE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-table-transact-sql).</span></span>  
  
###  <a name="customizing-locking-for-an-index"></a><a name="Customize"></a> <span data-ttu-id="12fe9-1677">Personalizando bloqueio de um índice</span><span class="sxs-lookup"><span data-stu-id="12fe9-1677">Customizing Locking for an Index</span></span>  

 <span data-ttu-id="12fe9-1678">O [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] usa uma estratégia de bloqueio dinâmico que escolhe automaticamente a melhor granularidade de bloqueio para as consultas, na maioria dos casos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1678">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses a dynamic locking strategy that automatically chooses the best locking granularity for queries in most cases.</span></span> <span data-ttu-id="12fe9-1679">É recomendável substituir os níveis de bloqueio padrão que têm bloqueio de página e de linha ativado, a não ser que os padrões de acesso a tabela e ao índice sejam bem compreendidos e consistentes e haja um problema de contenção de recursos a ser resolvida.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1679">We recommend that you do not override the default locking levels, which have page and row locking on, unless table or index access patterns are well understood and consistent, and there is a resource contention problem to solve.</span></span> <span data-ttu-id="12fe9-1680">Substituir um nível de bloqueio pode impedir significativamente o acesso simultâneo a uma tabela ou índice.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1680">Overriding a locking level can significantly impede concurrent access to a table or index.</span></span> <span data-ttu-id="12fe9-1681">Por exemplo, a especificação de apenas bloqueios em nível de tabela em uma tabela grande que os usuários acessam excessivamente pode provocar gargalos, porque os usuários precisam esperar que o bloqueio em nível de tabela seja liberado para acessar a tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1681">For example, specifying only table-level locks on a large table that users access heavily can cause bottlenecks because users must wait for the table-level lock to be released before accessing the table.</span></span>  
  
 <span data-ttu-id="12fe9-1682">Há alguns casos em que a desabilitação do bloqueio de página ou de linha poderá ser benéfico, se os padrões de acesso forem bem-entendidos e consistentes.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1682">There are a few cases where disallowing page or row locking can be beneficial, if the access patterns are well understood and consistent.</span></span> <span data-ttu-id="12fe9-1683">Por exemplo, um aplicativo de banco de dados usa uma tabela de pesquisa que é atualizada semanalmente em um processo em lotes.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1683">For example, a database application uses a lookup table that is updated weekly in a batch process.</span></span> <span data-ttu-id="12fe9-1684">Leitores simultâneos acessam a tabela com um bloqueio compartilhado (S) e a atualização em lotes semanal acessa a tabela com um bloqueio exclusivo (X).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1684">Concurrent readers access the table with a shared (S) lock and the weekly batch update accesses the table with an exclusive (X) lock.</span></span> <span data-ttu-id="12fe9-1685">A desativação do bloqueio de página e de linha na tabela reduz a sobrecarga do bloqueio durante a semana permitindo que os leitores acessem a tabela simultaneamente por meio de bloqueios de tabelas compartilhado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1685">Turning off page and row locking on the table reduces the locking overhead throughout the week by allowing readers to concurrently access the table through shared table locks.</span></span> <span data-ttu-id="12fe9-1686">Quando o trabalho em lotes é executado, ele pode concluir a atualização de maneira eficiente porque obtém um bloqueio de tabela exclusivo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1686">When the batch job runs, it can complete the update efficiently because it obtains an exclusive table lock.</span></span>  
  
 <span data-ttu-id="12fe9-1687">A desativação do bloqueio de página e de linha pode ou não ser aceitável porque a atualização semanal em lotes bloqueia o acesso dos leitores simultâneos à tabela enquanto a atualização está em execução.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1687">Turning off page and row locking might or might not be acceptable because the weekly batch update will block the concurrent readers from accessing the table while the update runs.</span></span> <span data-ttu-id="12fe9-1688">Se o trabalho em lotes só alterar algumas linhas ou páginas, você poderá alterar o nível de bloqueio para permitir bloqueio em nível de linha ou de página, o que permite que outras seções leiam a tabela sem bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1688">If the batch job only changes a few rows or pages, you can change the locking level to allow row or page level locking, which will enable other sessions to read from the table without blocking.</span></span> <span data-ttu-id="12fe9-1689">Se o trabalho em lotes tiver um grande número de atualizações, obter um bloqueio exclusivo na tabela poderá ser a melhor maneira de garantir que o trabalho em lotes seja concluído de maneira eficiente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1689">If the batch job has a large number of updates, obtaining an exclusive lock on the table may be the best way to ensure the batch job finishes efficiently.</span></span>  
  
 <span data-ttu-id="12fe9-1690">Ocasionalmente um deadlock ocorre quando duas operações concorrentes adquirirem bloqueios de linha na mesma tabela e então bloqueiam a página porque ambas precisam bloquear a página.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1690">Occasionally a deadlock occurs when two concurrent operations acquire row locks on the same table and then block because they both need to lock the page.</span></span> <span data-ttu-id="12fe9-1691">A desabilitação de bloqueios de linha força uma operação a esperar, evitando o deadlock.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1691">Disallowing row locks forces one of the operations to wait, avoiding the deadlock.</span></span>  
  
 <span data-ttu-id="12fe9-1692">A granularidade de bloqueio usada em um índice pode ser definida usando as instruções CREATE INDEX e ALTER INDEX.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1692">The granularity of locking used on an index can be set using the CREATE INDEX and ALTER INDEX statements.</span></span> <span data-ttu-id="12fe9-1693">As configurações de bloqueio se aplicam a páginas de índice e a páginas de tabela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1693">The lock settings apply to both the index pages and the table pages.</span></span> <span data-ttu-id="12fe9-1694">Além disso, podem ser usadas as instruções CREATE TABLE e ALTER TABLE para definir a granularidade de bloqueio nas restrições PRIMARY KEY e UNIQUE.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1694">In addition, the CREATE TABLE and ALTER TABLE statements can be used to set locking granularity on PRIMARY KEY and UNIQUE constraints.</span></span> <span data-ttu-id="12fe9-1695">Para compatibilidade com versões anteriores, o procedimento armazenado do sistema **sp_indexoption** também pode definir a granularidade.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1695">For backwards compatibility, the **sp_indexoption** system stored procedure can also set the granularity.</span></span> <span data-ttu-id="12fe9-1696">Para exibir a opção atual de bloqueio para um determinado índice, use a função INDEXPROPERTY.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1696">To display the current locking option for a given index, use the INDEXPROPERTY function.</span></span> <span data-ttu-id="12fe9-1697">Podem não ser permitidos bloqueios no nível de página, no nível de linha ou uma combinação de bloqueios no nível de página e no nível de linha, para um determinado índice.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1697">Page-level locks, row-level locks, or a combination of page-level and row-level locks can be disallowed for a given index.</span></span>  
  
|<span data-ttu-id="12fe9-1698">Bloqueios não permitidos</span><span class="sxs-lookup"><span data-stu-id="12fe9-1698">Disallowed locks</span></span>|<span data-ttu-id="12fe9-1699">Índice acessado por</span><span class="sxs-lookup"><span data-stu-id="12fe9-1699">Index accessed by</span></span>|  
|----------------------|-----------------------|  
|<span data-ttu-id="12fe9-1700">Nível de página</span><span class="sxs-lookup"><span data-stu-id="12fe9-1700">Page level</span></span>|<span data-ttu-id="12fe9-1701">Bloqueios no nível de linha e no nível de tabela</span><span class="sxs-lookup"><span data-stu-id="12fe9-1701">Row-level and table-level locks</span></span>|  
|<span data-ttu-id="12fe9-1702">Nível de linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-1702">Row level</span></span>|<span data-ttu-id="12fe9-1703">Bloqueios no nível de página e no nível de tabela</span><span class="sxs-lookup"><span data-stu-id="12fe9-1703">Page-level and table-level locks</span></span>|  
|<span data-ttu-id="12fe9-1704">Nível de página e nível de linha</span><span class="sxs-lookup"><span data-stu-id="12fe9-1704">Page level and row level</span></span>|<span data-ttu-id="12fe9-1705">Bloqueio no nível de tabela</span><span class="sxs-lookup"><span data-stu-id="12fe9-1705">Table-level locks</span></span>|  
  
 <span data-ttu-id="12fe9-1706">![Ícone de seta usado com o link voltar ao início](media/uparrow16x16.gif "Ícone de seta usado com o link Voltar ao Início") [neste guia](#Top)</span><span class="sxs-lookup"><span data-stu-id="12fe9-1706">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="advanced-transaction-information"></a><a name="Advanced"></a> <span data-ttu-id="12fe9-1707">Informações sobre transações avançadas</span><span class="sxs-lookup"><span data-stu-id="12fe9-1707">Advanced Transaction Information</span></span>  
  
### <a name="nesting-transactions"></a><span data-ttu-id="12fe9-1708">Aninhando transações</span><span class="sxs-lookup"><span data-stu-id="12fe9-1708">Nesting Transactions</span></span>  

 <span data-ttu-id="12fe9-1709">Transações explícitas podem ser aninhadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1709">Explicit transactions can be nested.</span></span> <span data-ttu-id="12fe9-1710">Isso serve basicamente para dar suporte a transações em procedimentos armazenados que possam ser chamados de um processo já presente em uma transação ou de processos que não tenham nenhuma transação ativa.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1710">This is primarily intended to support transactions in stored procedures that can be called either from a process already in a transaction or from processes that have no active transaction.</span></span>  
  
 <span data-ttu-id="12fe9-1711">O exemplo a seguir mostra o uso planejado de transações aninhadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1711">The following example shows the intended use of nested transactions.</span></span> <span data-ttu-id="12fe9-1712">O procedimento `TransProc` obriga sua transação independentemente do modo de transação de qualquer processo que o execute.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1712">The procedure `TransProc` enforces its transaction regardless of the transaction mode of any process that executes it.</span></span> <span data-ttu-id="12fe9-1713">Se `TransProc` for chamado quando uma transação estiver ativa, a transação aninhada em `TransProc` será amplamente ignorada e suas instruções INSERT serão confirmadas ou revertidas com base na ação final tomada para a transação externa.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1713">If `TransProc` is called when a transaction is active, the nested transaction in `TransProc` is largely ignored, and its INSERT statements are committed or rolled back based on the final action taken for the outer transaction.</span></span> <span data-ttu-id="12fe9-1714">Se `TransProc` for executado por um processo que não tenha uma transação pendente, o COMMIT TRANSACTION ao término do procedimento confirmará efetivamente as instruções INSERT.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1714">If `TransProc` is executed by a process that does not have an outstanding transaction, the COMMIT TRANSACTION at the end of the procedure effectively commits the INSERT statements.</span></span>  
  
```sql  
SET QUOTED_IDENTIFIER OFF;  
GO  
SET NOCOUNT OFF;  
GO  
CREATE TABLE TestTrans(Cola INT PRIMARY KEY,  
               Colb CHAR(3) NOT NULL);  
GO  
CREATE PROCEDURE TransProc @PriKey INT, @CharCol CHAR(3) AS  
BEGIN TRANSACTION InProc  
INSERT INTO TestTrans VALUES (@PriKey, @CharCol)  
INSERT INTO TestTrans VALUES (@PriKey + 1, @CharCol)  
COMMIT TRANSACTION InProc;  
GO  
/* Start a transaction and execute TransProc. */  
BEGIN TRANSACTION OutOfProc;  
GO  
EXEC TransProc 1, 'aaa';  
GO  
/* Roll back the outer transaction, this will  
   roll back TransProc's nested transaction. */  
ROLLBACK TRANSACTION OutOfProc;  
GO  
EXECUTE TransProc 3,'bbb';  
GO  
/* The following SELECT statement shows only rows 3 and 4 are   
   still in the table. This indicates that the commit  
   of the inner transaction from the first EXECUTE statement of  
   TransProc was overridden by the subsequent rollback. */  
SELECT * FROM TestTrans;  
GO  
```  
  
 <span data-ttu-id="12fe9-1715">A confirmação de transações internas é ignorada pelo [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-1715">Committing inner transactions is ignored by the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span></span> <span data-ttu-id="12fe9-1716">A transação é confirmada ou revertida com base na ação tomada no término da transação mais externa.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1716">The transaction is either committed or rolled back based on the action taken at the end of the outermost transaction.</span></span> <span data-ttu-id="12fe9-1717">Se a transação externa for confirmada, as transações aninhadas internas também serão confirmadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1717">If the outer transaction is committed, the inner nested transactions are also committed.</span></span> <span data-ttu-id="12fe9-1718">Se a transação externa for revertida, então todas as transações internas também serão revertidas, sem considerar se as transações internas estavam individualmente confirmadas ou não.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1718">If the outer transaction is rolled back, then all inner transactions are also rolled back, regardless of whether or not the inner transactions were individually committed.</span></span>  
  
 <span data-ttu-id="12fe9-1719">Cada chamada para COMMIT TRANSACTION ou COMMIT WORK se aplica a última BEGIN TRANSACTION executada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1719">Each call to COMMIT TRANSACTION or COMMIT WORK applies to the last executed BEGIN TRANSACTION.</span></span> <span data-ttu-id="12fe9-1720">Se as instruções de BEGIN TRANSACTION forem aninhadas, então uma instrução COMMIT só se aplicará à última transação aninhada que é a transação interna.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1720">If the BEGIN TRANSACTION statements are nested, then a COMMIT statement applies only to the last nested transaction, which is the innermost transaction.</span></span> <span data-ttu-id="12fe9-1721">Mesmo que uma instrução COMMIT TRANSACTION *transaction_name* em uma transação aninhada se refere ao nome da transação externa, a confirmação se aplica somente à transação mais interna.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1721">Even if a COMMIT TRANSACTION *transaction_name* statement within a nested transaction refers to the transaction name of the outer transaction, the commit applies only to the innermost transaction.</span></span>  
  
 <span data-ttu-id="12fe9-1722">Não é válido para o parâmetro *transaction_name* de uma instrução ROLLBACK TRANSACTION para se referir às transações internas de um conjunto de transações aninhadas nomeadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1722">It is not legal for the *transaction_name* parameter of a ROLLBACK TRANSACTION statement to refer to the inner transactions of a set of named nested transactions.</span></span> <span data-ttu-id="12fe9-1723">*transaction_name* pode se referir apenas ao nome da transação mais externa.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1723">*transaction_name* can refer only to the transaction name of the outermost transaction.</span></span> <span data-ttu-id="12fe9-1724">Se uma instrução de ROLLBACK TRANSACTION *transaction_name* que usa o nome da transação externa for executada em qualquer nível de um conjunto de transações aninhadas, todas as transações aninhadas serão revertidas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1724">If a ROLLBACK TRANSACTION *transaction_name* statement using the name of the outer transaction is executed at any level of a set of nested transactions, all of the nested transactions are rolled back.</span></span> <span data-ttu-id="12fe9-1725">Se uma instrução ROLLBACK WORK ou ROLLBACK TRANSACTION sem um parâmetro *transaction_name* for executada em qualquer nível de um conjunto de transações aninhadas, ela reverterá todas as transações aninhadas, incluindo a transação externa.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1725">If a ROLLBACK WORK or ROLLBACK TRANSACTION statement without a *transaction_name* parameter is executed at any level of a set of nested transaction, it rolls back all of the nested transactions, including the outermost transaction.</span></span>  
  
 <span data-ttu-id="12fe9-1726">A @TRANCOUNT função @ registra o nível de aninhamento da transação atual.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1726">The @@TRANCOUNT function records the current transaction nesting level.</span></span> <span data-ttu-id="12fe9-1727">Cada instrução de BEGIN TRANSACTION incrementa @ @TRANCOUNT por um.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1727">Each BEGIN TRANSACTION statement increments @@TRANCOUNT by one.</span></span> <span data-ttu-id="12fe9-1728">Cada instrução COMMIT transação ou confirmar trabalho diminui @ @TRANCOUNT por um.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1728">Each COMMIT TRANSACTION or COMMIT WORK statement decrements @@TRANCOUNT by one.</span></span> <span data-ttu-id="12fe9-1729">Um trabalho de reversão ou uma instrução ROLLBACK TRANSACTION que não tem um nome de transação reverte todas as transações aninhadas e decrementa @ @TRANCOUNT para 0.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1729">A ROLLBACK WORK or a ROLLBACK TRANSACTION statement that does not have a transaction name rolls back all nested transactions and decrements @@TRANCOUNT to 0.</span></span> <span data-ttu-id="12fe9-1730">Uma transação de reversão que usa o nome da transação da transação mais externa em um conjunto de transações aninhadas reverte todas as transações aninhadas e decrementa @ @TRANCOUNT para 0.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1730">A ROLLBACK TRANSACTION that uses the transaction name of the outermost transaction in a set of nested transactions rolls back all of the nested transactions and decrements @@TRANCOUNT to 0.</span></span> <span data-ttu-id="12fe9-1731">Quando você não tiver certeza se já está em uma transação, selecione @ @TRANCOUNT para determinar se ela é 1 ou mais.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1731">When you are unsure if you are already in a transaction, SELECT @@TRANCOUNT to determine if it is 1 or more.</span></span> <span data-ttu-id="12fe9-1732">Se @ @TRANCOUNT for 0, você não estará em uma transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1732">If @@TRANCOUNT is 0, you are not in a transaction.</span></span>  
  
### <a name="using-bound-sessions"></a><span data-ttu-id="12fe9-1733">Usando sessões associadas</span><span class="sxs-lookup"><span data-stu-id="12fe9-1733">Using Bound Sessions</span></span>  

 <span data-ttu-id="12fe9-1734">As sessões associadas facilitam a coordenação de ações em várias sessões no mesmo servidor.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1734">Bound sessions ease the coordination of actions across multiple sessions on the same server.</span></span> <span data-ttu-id="12fe9-1735">As sessões associadas permitem que duas ou mais sessões compartilhem a mesma transação e bloqueios e trabalhem nos mesmos dados sem conflitos de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1735">Bound sessions allow two or more sessions to share the same transaction and locks, and can work on the same data without lock conflicts.</span></span> <span data-ttu-id="12fe9-1736">Essas seções podem ser criadas a partir de várias sessões dentro do mesmo aplicativo ou de vários aplicativos com sessões separadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1736">Bound sessions can be created from multiple sessions within the same application or from multiple applications with separate sessions.</span></span>  
  
 <span data-ttu-id="12fe9-1737">Para participar de uma sessão associada, uma sessão chama **sp_getbindtoken** ou **srv_getbindtoken** (por meio de serviços de dados abertos) para obter um token de associação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1737">To participate in a bound session, a session calls **sp_getbindtoken** or **srv_getbindtoken** (through Open Data Services) to get a bind token.</span></span> <span data-ttu-id="12fe9-1738">Um token de ligação é uma cadeia de caracteres que identifica exclusivamente cada transação associada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1738">A bind token is a character string that uniquely identifies each bound transaction.</span></span> <span data-ttu-id="12fe9-1739">O token de ligação é enviado às outras sessões a serem associadas à sessão atual.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1739">The bind token is then sent to the other sessions to be bound with the current session.</span></span> <span data-ttu-id="12fe9-1740">As outras sessões associam a transação chamando **sp_bindsession**, usando o token de associação recebido da primeira sessão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1740">The other sessions bind to the transaction by calling **sp_bindsession**, using the bind token received from the first session.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="12fe9-1741">Uma sessão deve ter uma transação de usuário ativa para que **sp_getbindtoken** ou **srv_getbindtoken** seja realizada com sucesso.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1741">A session must have an active user transaction in order for **sp_getbindtoken** or **srv_getbindtoken** to succeed.</span></span>  
  
 <span data-ttu-id="12fe9-1742">Os tokens de ligação devem ser transmitidos a partir do código do aplicativo que faz a primeira sessão para o código de aplicativo que associa subsequentemente suas sessões à primeira sessão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1742">Bind tokens must be transmitted from the application code that makes the first session to the application code that subsequently binds their sessions to the first session.</span></span> <span data-ttu-id="12fe9-1743">Não há nenhuma instrução [!INCLUDE[tsql](../includes/tsql-md.md)] ou função de API que um aplicativo pode usar para obter o token de ligação para uma transação iniciada por outro processo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1743">There is no [!INCLUDE[tsql](../includes/tsql-md.md)] statement or API function that an application can use to get the bind token for a transaction started by another process.</span></span> <span data-ttu-id="12fe9-1744">Alguns dos métodos que podem ser usados para transmitir um token de ligação incluem o seguinte:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1744">Some of the methods that can be used to transmit a bind token include the following:</span></span>  
  
-   <span data-ttu-id="12fe9-1745">Se todas as sessões forem iniciadas do mesmo processo de aplicativo, os tokens de ligação poderão ser armazenados na memória global ou passados em funções como um parâmetro.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1745">If the sessions are all initiated from the same application process, bind tokens can be stored in global memory or passed into functions as a parameter.</span></span>  
  
-   <span data-ttu-id="12fe9-1746">Se as sessões forem feitas a partir de processos de aplicativo separados, os tokens de ligação poderão ser transmitidos usando a comunicação entre processos (IPC), como uma chamada de procedimento remoto (RPC) ou troca dinâmica de dados (DDE).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1746">If the sessions are made from separate application processes, bind tokens can be transmitted using interprocess communication (IPC), such as a remote procedure call (RPC) or dynamic data exchange (DDE).</span></span>  
  
-   <span data-ttu-id="12fe9-1747">Os tokens de ligação podem ser armazenados em uma tabela em uma instância do [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] que possa ser lida pelos processos que desejam se associar à primeira sessão.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1747">Bind tokens can be stored in a table in an instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] that can be read by processes wanting to bind to the first session.</span></span>  
  
 <span data-ttu-id="12fe9-1748">Somente uma sessão em um conjunto de sessões associadas pode estar ativa a qualquer momento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1748">Only one session in a set of bound sessions can be active at any time.</span></span> <span data-ttu-id="12fe9-1749">Se uma sessão estiver executando uma instrução na instância ou tiver resultados pendentes da instância, nenhuma outra sessão associada a ela poderá acessar a instância até que a sessão atual termine o processamento ou cancele a instrução atual.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1749">If one session is executing a statement on the instance or has results pending from the instance, no other session bound to it can access the instance until the current session finishes processing or cancels the current statement.</span></span> <span data-ttu-id="12fe9-1750">Se a instância estiver ocupada processando uma instrução de outras sessões associadas, ocorrerá um erro indicando que o espaço de transação está em uso e a sessão deverá tentar novamente posteriormente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1750">If the instance is busy processing a statement from another of the bound sessions, an error occurs indicating that the transaction space is in use and the session should retry later.</span></span>  
  
 <span data-ttu-id="12fe9-1751">Quando você associa as sessões, cada sessão retém sua configuração de nível de isolamento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1751">When you bind sessions, each session retains its isolation level setting.</span></span> <span data-ttu-id="12fe9-1752">O uso de SET TRANSACTION ISOLATION LEVEL para alterar a configuração de nível de isolamento de uma sessão não afeta a configuração de nenhuma outra sessão associada a ela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1752">Using SET TRANSACTION ISOLATION LEVEL to change the isolation level setting of one session does not affect the setting of any other session bound to it.</span></span>  
  
#### <a name="types-of-bound-sessions"></a><span data-ttu-id="12fe9-1753">Tipos de sessões associadas</span><span class="sxs-lookup"><span data-stu-id="12fe9-1753">Types of Bound Sessions</span></span>  

 <span data-ttu-id="12fe9-1754">Os dois tipos de sessões associadas são local e distribuído.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1754">The two types of bound sessions are local and distributed.</span></span>  
  
-   <span data-ttu-id="12fe9-1755">Sessão associada local</span><span class="sxs-lookup"><span data-stu-id="12fe9-1755">Local bound session</span></span>  
  
     <span data-ttu-id="12fe9-1756">Permite que as sessões associadas compartilhem o espaço de transação de uma única transação em uma instância única do [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="12fe9-1756">Allows bound sessions to share the transaction space of a single transaction in a single instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)].</span></span>  
  
-   <span data-ttu-id="12fe9-1757">Sessão associada distribuída</span><span class="sxs-lookup"><span data-stu-id="12fe9-1757">Distributed bound session</span></span>  
  
     <span data-ttu-id="12fe9-1758">Permite que as sessões associadas compartilhem a mesma transação em duas ou mais instâncias até que toda a transação seja confirmada ou revertida usando o MS DTC (Coordenador de Transações Distribuídas da [!INCLUDE[msCoName](../includes/msconame-md.md)]).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1758">Allows bound sessions to share the same transaction across two or more instances until the entire transaction is either committed or rolled back by using [!INCLUDE[msCoName](../includes/msconame-md.md)] Distributed Transaction Coordinator (MS DTC).</span></span>  
  
 <span data-ttu-id="12fe9-1759">As sessões associadas distribuídas não são identificadas por um token de ligação de cadeia de caracteres; elas são identificadas por meio de números de identificação da transação distribuída.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1759">Distributed bound sessions are not identified by a character string bind token; they are identified by distributed transaction identification numbers.</span></span> <span data-ttu-id="12fe9-1760">Se uma sessão associada estiver envolvida em uma transação local e executar uma RPC em um servidor remoto com SET REMOTE_PROC_TRANSACTIONS ON, a transação associada local será promovida automaticamente a uma transação associada distribuída por MS DTC e uma sessão MS DTC será iniciada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1760">If a bound session is involved in a local transaction and executes an RPC on a remote server with SET REMOTE_PROC_TRANSACTIONS ON, the local bound transaction is automatically promoted to a distributed bound transaction by MS DTC and an MS DTC session is started.</span></span>  
  
#### <a name="when-to-use-bound-sessions"></a><span data-ttu-id="12fe9-1761">Quando usar sessões associadas</span><span class="sxs-lookup"><span data-stu-id="12fe9-1761">When to Use Bound Sessions</span></span>  

 <span data-ttu-id="12fe9-1762">Nas versões anteriores do [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], as sessões associadas eram usadas principalmente no desenvolvimento de procedimentos armazenados estendidos que precisavam executar instruções [!INCLUDE[tsql](../includes/tsql-md.md)] a favor do processo que as chamava.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1762">In earlier versions of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], bound sessions were primarily used in developing extended stored procedures that must execute [!INCLUDE[tsql](../includes/tsql-md.md)] statements on behalf of the process that calls them.</span></span> <span data-ttu-id="12fe9-1763">A passagem do processo de chamada por um token de ligação como um parâmetro do procedimento armazenado estendido permite que o procedimento seja associado ao espaço de transação do processo de chamada, integrando o procedimento armazenado estendido ao processo de chamada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1763">Having the calling process pass in a bind token as one parameter of the extended stored procedure allows the procedure to join the transaction space of the calling process, thereby integrating the extended stored procedure with the calling process.</span></span>  
  
 <span data-ttu-id="12fe9-1764">No [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)], os procedimentos armazenados gravados que usam CLR são mais seguros, evolutivos e estáveis que os procedimentos armazenados estendidos.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1764">In the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)], stored procedures written using CLR are more secure, scalable, and stable than extended stored procedures.</span></span> <span data-ttu-id="12fe9-1765">Os procedimentos armazenados em CLR usam o objeto **SqlContext** para ingressar no contexto da sessão de chamada, não **sp_bindsession**.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1765">CLR-stored procedures use the **SqlContext** object to join the context of the calling session, not **sp_bindsession**.</span></span>  
  
 <span data-ttu-id="12fe9-1766">As sessões associadas podem ser usadas para desenvolver aplicativos de três camadas nos quais a lógica empresarial está incorporada em programas separados que trabalham cooperativamente em uma única transação empresarial.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1766">Bound sessions can be used to develop three-tier applications in which business logic is incorporated into separate programs that work cooperatively on a single business transaction.</span></span> <span data-ttu-id="12fe9-1767">Esses programas devem ser codificados para coordenar seu acesso cuidadosamente a um banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1767">These programs must be coded to carefully coordinate their access to a database.</span></span> <span data-ttu-id="12fe9-1768">Como as duas sessões compartilham os mesmos bloqueios, os dois programas não devem tentar modificar os mesmos dados ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1768">Because the two sessions share the same locks, the two programs must not try to modify the same data at the same time.</span></span> <span data-ttu-id="12fe9-1769">Em qualquer point-in-time, apenas uma sessão pode trabalhar como parte da transação; não pode haver execução paralela.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1769">At any point in time, only one session can be doing work as part of the transaction; there can be no parallel execution.</span></span> <span data-ttu-id="12fe9-1770">A transação pode ser alternada apenas entre sessões em pontos bem definidos, como quando todas as instruções DML forem concluídas e seus resultados forem recuperados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1770">The transaction can only be switched between sessions at well-defined yield points, such as when all DML statements have completed and their results have been retrieved.</span></span>  
  
### <a name="coding-efficient-transactions"></a><span data-ttu-id="12fe9-1771">Codificando transações eficientes</span><span class="sxs-lookup"><span data-stu-id="12fe9-1771">Coding Efficient Transactions</span></span>  

 <span data-ttu-id="12fe9-1772">É importante manter as transações tão curtas quanto possível.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1772">It is important to keep transactions as short as possible.</span></span> <span data-ttu-id="12fe9-1773">Quando uma transação é iniciada, um DBMS (Sistema de administração de banco de dados), deve manter muitos recursos, até o término da transação, para proteger as propriedades (ACID) de atomicidade, consistência, isolamento e durabilidade da transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1773">When a transaction is started, a database management system (DBMS) must hold many resources until the end of the transaction to protect the atomicity, consistency, isolation, and durability (ACID) properties of the transaction.</span></span> <span data-ttu-id="12fe9-1774">Se os dados forem modificados, as linhas modificadas devem ser protegidas com bloqueios exclusivos que evitem a leitura das linhas por qualquer outra transação, e os bloqueios exclusivos devem ser mantidos até que a transação seja confirmada ou revertida.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1774">If data is modified, the modified rows must be protected with exclusive locks that prevent any other transaction from reading the rows, and exclusive locks must be held until the transaction is committed or rolled back.</span></span> <span data-ttu-id="12fe9-1775">Dependendo das configurações de nível de isolamento da transação, as instruções SELECT podem obter bloqueios que devem ser mantidos até que a transação esteja confirmada ou revertida.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1775">Depending on transaction isolation level settings, SELECT statements may acquire locks that must be held until the transaction is committed or rolled back.</span></span> <span data-ttu-id="12fe9-1776">Especialmente em sistemas com muitos usuários, as transações devem ser mantidas tão curtas quanto possível para reduzir a contenção de bloqueios de recursos em conexões simultâneas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1776">Especially in systems with many users, transactions must be kept as short as possible to reduce locking contention for resources between concurrent connections.</span></span> <span data-ttu-id="12fe9-1777">Transações longas e ineficazes podem não causar problemas com um número pequeno de usuários, mas são intoleráveis em um sistema com milhares de usuários.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1777">Long-running, inefficient transactions may not be a problem with small numbers of users, but they are intolerable in a system with thousands of users.</span></span> <span data-ttu-id="12fe9-1778">Começando com o [!INCLUDE[ssSQL14](../includes/sssql14-md.md)][!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], há compatibilidade com transações duráveis atrasadas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1778">Beginning with [!INCLUDE[ssSQL14](../includes/sssql14-md.md)][!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] supports delayed durable transactions.</span></span> <span data-ttu-id="12fe9-1779">As transações duráveis atrasadas não garantem a durabilidade.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1779">Delayed durable transactions do not guarantee durability.</span></span> <span data-ttu-id="12fe9-1780">Consulte o tópico [Durabilidade da Transação](../relational-databases/logs/control-transaction-durability.md) para obter mais informações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1780">See the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md) for more information.</span></span>  
  
#### <a name="coding-guidelines"></a><span data-ttu-id="12fe9-1781">Codificando diretrizes</span><span class="sxs-lookup"><span data-stu-id="12fe9-1781">Coding Guidelines</span></span>  

 <span data-ttu-id="12fe9-1782">Estas são diretrizes para codificar transações eficazes:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1782">These are guidelines for coding efficient transactions:</span></span>  
  
-   <span data-ttu-id="12fe9-1783">Não solicite entradas de usuários durante a transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1783">Do not require input from users during a transaction.</span></span>  
  
     <span data-ttu-id="12fe9-1784">Obtenha todas as entradas necessárias da parte dos usuários antes do início de uma transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1784">Get all required input from users before a transaction is started.</span></span> <span data-ttu-id="12fe9-1785">Sendo necessária uma entrada adicional de usuário durante uma transação, reverta a transação atual e reinicie a transação depois que a entrada do usuário for fornecida.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1785">If additional user input is required during a transaction, roll back the current transaction and restart the transaction after the user input is supplied.</span></span> <span data-ttu-id="12fe9-1786">Mesmo que os usuários respondam imediatamente, a reação humana é muito mais lenta que a velocidade do computador.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1786">Even if users respond immediately, human reaction times are vastly slower than computer speeds.</span></span> <span data-ttu-id="12fe9-1787">Todos os recursos mantidos pela transação são retidos por um tempo extremamente longo, criando potencial para causar problemas de bloqueio.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1787">All resources held by the transaction are held for an extremely long time, which has the potential to cause blocking problems.</span></span> <span data-ttu-id="12fe9-1788">Se os usuários não responderem, a transação permanecerá ativa, bloqueando recursos críticos até que eles respondam, o que pode não acontecer por vários minutos ou até mesmo horas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1788">If users do not respond, the transaction remains active, locking critical resources until they respond, which may not happen for several minutes or even hours.</span></span>  
  
-   <span data-ttu-id="12fe9-1789">Não abra uma transação enquanto estiver navegando pelos dados, se possível.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1789">Do not open a transaction while browsing through data, if at all possible.</span></span>  
  
     <span data-ttu-id="12fe9-1790">As transações não devem ser iniciadas até que toda a análise preliminar de dados tenha terminado.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1790">Transactions should not be started until all preliminary data analysis has been completed.</span></span>  
  
-   <span data-ttu-id="12fe9-1791">Mantenha a transação tão curta quanto possível.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1791">Keep the transaction as short as possible.</span></span>  
  
     <span data-ttu-id="12fe9-1792">Depois de saber quais são as modificações que precisam ser feitas, inicie uma transação, execute as instruções de modificação e, em seguida, confirme ou reverta imediatamente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1792">After you know the modifications that have to be made, start a transaction, execute the modification statements, and then immediately commit or roll back.</span></span> <span data-ttu-id="12fe9-1793">Só abra a transação quando for necessário.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1793">Do not open the transaction before it is required.</span></span>  
  
-   <span data-ttu-id="12fe9-1794">Para reduzir o bloqueio, considere usar um nível de isolamento de linha baseado em controle de versão de linha para consultas somente leitura.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1794">To reduce blocking, consider using a row versioning-based isolation level for read-only queries.</span></span>  
  
-   <span data-ttu-id="12fe9-1795">Utilize bem os níveis de isolamento de transação inferiores.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1795">Make intelligent use of lower transaction isolation levels.</span></span>  
  
     <span data-ttu-id="12fe9-1796">Muitos aplicativos podem ser prontamente codificados para usar um nível de isolamento de transação de leitura confirmada.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1796">Many applications can be readily coded to use a read-committed transaction isolation level.</span></span> <span data-ttu-id="12fe9-1797">Nem todas as transações requerem nível de isolamento de transação serializável.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1797">Not all transactions require the serializable transaction isolation level.</span></span>  
  
-   <span data-ttu-id="12fe9-1798">Utilize bem as opções inferiores de simultaneidade de cursor, como opções de simultaneidade otimista.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1798">Make intelligent use of lower cursor concurrency options, such as optimistic concurrency options.</span></span>  
  
     <span data-ttu-id="12fe9-1799">Em um sistema com pouca probabilidade de atualizações simultâneas, a sobrecarga de lidar com um erro ocasional quando "alguém altera seus dados depois que você os leu" pode ser muito inferior à sobrecarga de sempre bloquear linhas à medida que são lidas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1799">In a system with a low probability of concurrent updates, the overhead of dealing with an occasional "somebody else changed your data after you read it" error can be much lower than the overhead of always locking rows as they are read.</span></span>  
  
-   <span data-ttu-id="12fe9-1800">Acesse a menor quantidade de dados possível enquanto estiver em uma transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1800">Access the least amount of data possible while in a transaction.</span></span>  
  
     <span data-ttu-id="12fe9-1801">Isso reduz o número de linhas bloqueadas, reduzindo, portanto, a contenção entre transações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1801">This lessens the number of locked rows, thereby reducing contention between transactions.</span></span>  
  
#### <a name="avoiding-concurrency-and-resource-problems"></a><span data-ttu-id="12fe9-1802">Evitando problemas de simultaneidade e de recurso</span><span class="sxs-lookup"><span data-stu-id="12fe9-1802">Avoiding Concurrency and Resource Problems</span></span>  

 <span data-ttu-id="12fe9-1803">Para impedir problemas de simultaneidade e de recurso, gerencie cuidadosamente as transações implícitas.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1803">To prevent concurrency and resource problems, manage implicit transactions carefully.</span></span> <span data-ttu-id="12fe9-1804">Ao usar transações implícitas, a próxima instrução do [!INCLUDE[tsql](../includes/tsql-md.md)] após COMMIT ou ROLLBACK iniciará automaticamente uma nova transação.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1804">When using implicit transactions, the next [!INCLUDE[tsql](../includes/tsql-md.md)] statement after COMMIT or ROLLBACK automatically starts a new transaction.</span></span> <span data-ttu-id="12fe9-1805">Isso pode fazer com que uma nova transação seja aberta enquanto o aplicativo navega pelos dados, ou até mesmo quando solicita entradas da parte do usuário.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1805">This can cause a new transaction to be opened while the application browses through data, or even when it requires input from the user.</span></span> <span data-ttu-id="12fe9-1806">Depois de completar a última transação necessária à proteção contra modificações de dados, desative as transações implícitas até que a transação seja novamente necessária para proteger as modificações de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1806">After completing the last transaction required to protect data modifications, turn off implicit transactions until a transaction is once again required to protect data modifications.</span></span> <span data-ttu-id="12fe9-1807">Esse processo deixa o [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] usar o modo autocommit enquanto o aplicativo navega pelos dados e obtém entradas do usuário.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1807">This process lets the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] use autocommit mode while the application is browsing data and getting input from the user.</span></span>  
  
 <span data-ttu-id="12fe9-1808">Além disso, quando o nível de isolamento do instantâneo estiver habilitado, embora uma nova transação não vá reter bloqueios, uma transação de execução longa impedirá a remoção de versões antigas de `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1808">In addition, when the snapshot isolation level is enabled, although a new transaction will not hold locks, a long-running transaction will prevent the old versions from being removed from `tempdb`.</span></span>  
  
### <a name="managing-long-running-transactions"></a><span data-ttu-id="12fe9-1809">Gerenciando transações demoradas</span><span class="sxs-lookup"><span data-stu-id="12fe9-1809">Managing Long-Running Transactions</span></span>  

 <span data-ttu-id="12fe9-1810">Uma *transação de execução longa* é uma transação ativa que não foi confirmada nem revertida em tempo hábil.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1810">A *long-running transaction* is an active transaction that has not been committed or roll backed the transaction in a timely manner.</span></span> <span data-ttu-id="12fe9-1811">Por exemplo, se o início e o término de uma transação forem controlados pelo usuário, uma causa típica de uma transação de longa execução será um usuário iniciar uma transação e sair enquanto a transação espera por uma resposta dele.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1811">For example, if the beginning and end of a transaction is controlled by the user, a typical cause of a long-running transaction is a user starting a transaction and then leaving while the transaction waits for a response from the user.</span></span>  
  
 <span data-ttu-id="12fe9-1812">Uma transação de execução longa pode causar sérios problemas para um banco de dados, como:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1812">A long running transaction can cause serious problems for a database, as follows:</span></span>  
  
-   <span data-ttu-id="12fe9-1813">Se uma instância de servidor for desligada depois que uma transação ativa tiver realizado muitas modificações não confirmadas, a fase de recuperação da reinicialização subsequente poderá demorar muito mais do que o tempo especificado pela opção de configuração de servidor de **intervalo de recuperação** ou pelo ALTER DATABASE... Defina TARGET_RECOVERY_TIME opção.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1813">If a server instance is shut down after an active transaction has performed many uncommitted modifications, the recovery phase of the subsequent restart can take much longer than the time specified by the **recovery interval** server configuration option or by the ALTER DATABASE... SET TARGET_RECOVERY_TIME option.</span></span> <span data-ttu-id="12fe9-1814">Essas opções controlam a frequência de pontos de verificação ativos e indiretos, respectivamente.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1814">These options control the frequency of active and indirect checkpoints, respectively.</span></span> <span data-ttu-id="12fe9-1815">Para obter mais informações sobre os tipos de pontos de verificação, veja [Pontos de verificação de bancos de dados &#40;SQL Server&#41;](../relational-databases/logs/database-checkpoints-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1815">For more information about the types of checkpoints, see [Database Checkpoints &#40;SQL Server&#41;](../relational-databases/logs/database-checkpoints-sql-server.md).</span></span>  
  
-   <span data-ttu-id="12fe9-1816">É importante ressaltar que, embora uma transação em espera possa gerar um log muito pequeno, ela reterá o truncamento de log indefinidamente, fazendo com que o log da transação aumente bastante e seja completamente preenchido.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1816">More importantly, although a waiting transaction might generate very little log, it holds up log truncation indefinitely, causing the transaction log to grow and possibly fill up.</span></span> <span data-ttu-id="12fe9-1817">Se o log da transação for completamente preenchido, o banco de dados não fará mais atualizações.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1817">If the transaction log fills up, the database cannot perform any more updates.</span></span> <span data-ttu-id="12fe9-1818">Para obter mais informações, consulte [solucionar problemas de um log de transações completo &#40;SQL Server erro 9002&#41;](../relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002.md)e [o Log de transações &#40;](../relational-databases/logs/the-transaction-log-sql-server.md)SQL Server&#41;.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1818">For more information, see [Troubleshoot a Full Transaction Log &#40;SQL Server Error 9002&#41;](../relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002.md), and [The Transaction Log &#40;SQL Server&#41;](../relational-databases/logs/the-transaction-log-sql-server.md).</span></span>  
  
#### <a name="discovering-long-running-transactions"></a><span data-ttu-id="12fe9-1819">Descobrindo transações demoradas</span><span class="sxs-lookup"><span data-stu-id="12fe9-1819">Discovering Long-Running Transactions</span></span>  

 <span data-ttu-id="12fe9-1820">Para procurar transações demoradas, use um dos seguintes:</span><span class="sxs-lookup"><span data-stu-id="12fe9-1820">To look for long-running transactions, use one of the following:</span></span>  
  
-   <span data-ttu-id="12fe9-1821">**sys.dm_tran_database_transactions**</span><span class="sxs-lookup"><span data-stu-id="12fe9-1821">**sys.dm_tran_database_transactions**</span></span>  
  
     <span data-ttu-id="12fe9-1822">Essa exibição de gerenciamento dinâmico retorna informações sobre as transações no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1822">This dynamic management view returns information about transactions at the database level.</span></span> <span data-ttu-id="12fe9-1823">Para uma transação de execução demorada, as colunas de interesse específico incluem a hora do primeiro registro de log (**database_transaction_begin_time**), o estado atual da transação (**database_transaction_state**) e o LSN (número de sequência de log) do registro de início do log de transações (**database_transaction_begin_lsn**).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1823">For a long-running transaction, columns of particular interest include the time of the first log record (**database_transaction_begin_time**), the current state of the transaction (**database_transaction_state**), and the log sequence number (LSN) of the begin record in the transaction log (**database_transaction_begin_lsn**).</span></span>  
  
     <span data-ttu-id="12fe9-1824">Para obter mais informações, consulte [sys.DM tran_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-database-transactions-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1824">For more information, see [sys.dm_tran_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-database-transactions-transact-sql).</span></span>  
  
-   <span data-ttu-id="12fe9-1825">DBCC OPENTRAN</span><span class="sxs-lookup"><span data-stu-id="12fe9-1825">DBCC OPENTRAN</span></span>  
  
     <span data-ttu-id="12fe9-1826">Essa instrução permite identificar a ID do proprietário da transação, de modo que seja possível localizar potencialmente a origem da transação para um término mais ordenado (confirmar, em vez de revertê-la).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1826">This statement lets you identify the user ID of the owner of the transaction, so you can potentially track down the source of the transaction for a more orderly termination (committing it rather than rolling it back).</span></span> <span data-ttu-id="12fe9-1827">Para obter mais informações, consulte [DBCC OPENTRAN &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-opentran-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1827">For more information, see [DBCC OPENTRAN &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-opentran-transact-sql).</span></span>  
  
#### <a name="stopping-a-transaction"></a><span data-ttu-id="12fe9-1828">Parando uma transação</span><span class="sxs-lookup"><span data-stu-id="12fe9-1828">Stopping a Transaction</span></span>  

 <span data-ttu-id="12fe9-1829">Talvez seja necessário usar a instrução KILL.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1829">You may have to use the KILL statement.</span></span> <span data-ttu-id="12fe9-1830">Use essa instrução com muito cuidado, porém, especialmente quando houver processos importantes em processamento.</span><span class="sxs-lookup"><span data-stu-id="12fe9-1830">Use this statement very carefully, however, especially when critical processes are running.</span></span> <span data-ttu-id="12fe9-1831">Para obter mais informações, consulte [KILL &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/kill-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="12fe9-1831">For more information, see [KILL &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/kill-transact-sql).</span></span>  
  
 <span data-ttu-id="12fe9-1832">![Ícone de seta usado com o link voltar ao início](media/uparrow16x16.gif "Ícone de seta usado com o link Voltar ao Início") [neste guia](#Top)</span><span class="sxs-lookup"><span data-stu-id="12fe9-1832">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="12fe9-1833">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="12fe9-1833">See Also</span></span>  

 <span data-ttu-id="12fe9-1834">[Isolamento de transação com base no controle de versão de linha SQL Server 2005](https://msdn.microsoft.com/library/ms345124(v=sql.90).aspx) </span><span class="sxs-lookup"><span data-stu-id="12fe9-1834">[SQL Server 2005 Row Versioning-Based Transaction Isolation](https://msdn.microsoft.com/library/ms345124(v=sql.90).aspx) </span></span>  
 <span data-ttu-id="12fe9-1835">[Sobrecarga do controle de versão de linha](https://blogs.msdn.com/b/sqlserverstorageengine/archive/2008/03/30/overhead-of-row-versioning.aspx) </span><span class="sxs-lookup"><span data-stu-id="12fe9-1835">[Overhead of Row Versioning](https://blogs.msdn.com/b/sqlserverstorageengine/archive/2008/03/30/overhead-of-row-versioning.aspx) </span></span>  
 [<span data-ttu-id="12fe9-1836">Como criar uma transação autônoma no SQL Server 2008</span><span class="sxs-lookup"><span data-stu-id="12fe9-1836">How to create an autonomous transaction in SQL Server 2008</span></span>](https://blogs.msdn.com/b/sqlprogrammability/archive/2008/08/22/how-to-create-an-autonomous-transaction-in-sql-server-2008.aspx)  
  
  
