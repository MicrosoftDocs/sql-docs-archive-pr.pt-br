---
title: MERGE em pacotes do Integration Services | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: integration-services
ms.topic: conceptual
helpviewer_keywords:
- MERGE statement [SQL Server]
ms.assetid: 7e44a5c2-e6d6-4fe2-a079-4f95ccdb147b
author: chugugrace
ms.author: chugu
ms.openlocfilehash: cc6de738d44b91a9e2a4885978ba4a46dfede8cf
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87572619"
---
# <a name="merge-in-integration-services-packages"></a><span data-ttu-id="6b464-102">MERGE em pacotes do Integration Services</span><span class="sxs-lookup"><span data-stu-id="6b464-102">MERGE in Integration Services Packages</span></span>
  <span data-ttu-id="6b464-103">Na versão atual do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)][!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)], a instrução SQL em uma tarefa Executar SQL pode conter uma instrução MERGE.</span><span class="sxs-lookup"><span data-stu-id="6b464-103">In the current release of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)][!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)], the SQL statement in an Execute SQL task can contain a MERGE statement.</span></span> <span data-ttu-id="6b464-104">A instrução MERGE permite realizar várias operações INSERT, UPDATE e DELETE em uma única instrução.</span><span class="sxs-lookup"><span data-stu-id="6b464-104">This MERGE statement enables you to accomplish multiple INSERT, UPDATE, and DELETE operations in a single statement.</span></span>  
  
 <span data-ttu-id="6b464-105">Para usar a instrução MERGE em um pacote, siga estas etapas:</span><span class="sxs-lookup"><span data-stu-id="6b464-105">To use the MERGE statement in a package, follow these steps:</span></span>  
  
-   <span data-ttu-id="6b464-106">Crie uma tarefa Fluxo de Dados que carrega, transforma e salva os dados de origem em uma tabela temporária ou de preparação.</span><span class="sxs-lookup"><span data-stu-id="6b464-106">Create a Data Flow task that loads, transforms, and saves the source data to a temporary or staging table.</span></span>  
  
-   <span data-ttu-id="6b464-107">Crie uma tarefa Executar SQL que contém a instrução MERGE.</span><span class="sxs-lookup"><span data-stu-id="6b464-107">Create an Execute SQL task that contains the MERGE statement.</span></span>  
  
-   <span data-ttu-id="6b464-108">Conecte a tarefa Fluxo de Dados à tarefa Executar SQL e use os dados da tabela de preparação como entrada para a instrução MERGE.</span><span class="sxs-lookup"><span data-stu-id="6b464-108">Connect the Data Flow task to the Execute SQL task, and use the data in the staging table as the input for the MERGE statement.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="6b464-109">Embora uma instrução MERGE normalmente precise de uma tabela de preparação nesse caso, o desempenho da instrução MERGE, em geral, ultrapassa o desempenho da pesquisa de linha por linha executada pela transformação Pesquisa.</span><span class="sxs-lookup"><span data-stu-id="6b464-109">Although a MERGE statement typically requires a staging table in this scenario, the performance of the MERGE statement usually exceeds that of the row-by-row lookup performed by the Lookup transformation.</span></span> <span data-ttu-id="6b464-110">A instrução MERGE também é útil quando o tamanho grande de uma tabela de pesquisa testa a memória disponível para a transformação Pesquisa armazenar a tabela de referência em cache.</span><span class="sxs-lookup"><span data-stu-id="6b464-110">MERGE is also useful when the large size of a lookup table would test the memory that is available to the Lookup transformation for caching its reference table.</span></span>  
  
 <span data-ttu-id="6b464-111">O restante deste tópico discute alguns usos adicionais da instrução MERGE.</span><span class="sxs-lookup"><span data-stu-id="6b464-111">The remainder of this topic discusses some additional uses for the MERGE statement.</span></span>  
  
 <span data-ttu-id="6b464-112">Para um componente de destino de exemplo que oferece suporte ao uso da instrução MERGE, consulte o exemplo da comunidade CodePlex, [Destino MERGE](https://go.microsoft.com/fwlink/?LinkId=141215).</span><span class="sxs-lookup"><span data-stu-id="6b464-112">For a sample destination component that supports the use of the MERGE statement, see the CodePlex community sample, [MERGE Destination](https://go.microsoft.com/fwlink/?LinkId=141215).</span></span>  
  
## <a name="using-merge"></a><span data-ttu-id="6b464-113">Usando MERGE</span><span class="sxs-lookup"><span data-stu-id="6b464-113">Using MERGE</span></span>  
 <span data-ttu-id="6b464-114">Normalmente, você usa a instrução MERGE quando deseja aplicar alterações que incluem inserções, atualizações e exclusões de uma tabela para outra.</span><span class="sxs-lookup"><span data-stu-id="6b464-114">Typically, you use the MERGE statement when you want to apply changes that include inserts, updates, and deletions from one table to another table.</span></span> <span data-ttu-id="6b464-115">Antes do [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], este processo precisava de uma transformação Pesquisa e de várias transformações Comando OLE DB.</span><span class="sxs-lookup"><span data-stu-id="6b464-115">Prior to [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], this process required both a Lookup transformation and multiple OLE DB Command transformations.</span></span> <span data-ttu-id="6b464-116">A transformação Pesquisa executava uma pesquisa em linha por linha para determinar se cada linha era nova ou tinha sido alterada.</span><span class="sxs-lookup"><span data-stu-id="6b464-116">The Lookup transformation performed a row-by-row lookup to determine whether each row was new or changed.</span></span> <span data-ttu-id="6b464-117">Em seguida, as transformações Comando OLE DB executavam as operações INSERT, UPDATE e DELETE necessárias.</span><span class="sxs-lookup"><span data-stu-id="6b464-117">The OLE DB Command transformations then performed the necessary INSERT, UPDATE, and DELETE operations.</span></span> <span data-ttu-id="6b464-118">A partir do [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], uma única instrução MERGE pode substituir a transformação Pesquisa e as transformações Comando OLE DB correspondentes.</span><span class="sxs-lookup"><span data-stu-id="6b464-118">Beginning in [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], a single MERGE statement can replace both the Lookup transformation and the corresponding OLE DB Command transformations.</span></span>  
  
### <a name="merge-with-incremental-loads"></a><span data-ttu-id="6b464-119">MERGE com cargas incrementais</span><span class="sxs-lookup"><span data-stu-id="6b464-119">MERGE with Incremental Loads</span></span>  
 <span data-ttu-id="6b464-120">A funcionalidade de alteração da captura dos dados que é nova no [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] facilita a execução de cargas incrementais com segurança em um data warehouse.</span><span class="sxs-lookup"><span data-stu-id="6b464-120">The change data capture functionality that is new in [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] makes it easier to perform incremental loads reliably to a data warehouse.</span></span> <span data-ttu-id="6b464-121">Como alternativa para o uso de transformações Comando OLE DB parametrizadas para executar as inserções e atualizações, você pode usar a instrução MERGE para combinar as duas operações.</span><span class="sxs-lookup"><span data-stu-id="6b464-121">As an alternative to using parameterized OLE DB Command transformations to perform the inserts and the updates, you can use the MERGE statement to combine both operations.</span></span>  
  
 <span data-ttu-id="6b464-122">Para obter mais informações, consulte [Aplicar as alterações ao destino](../change-data-capture/apply-the-changes-to-the-destination.md).</span><span class="sxs-lookup"><span data-stu-id="6b464-122">For more information, see [Apply the Changes to the Destination](../change-data-capture/apply-the-changes-to-the-destination.md).</span></span>  
  
#### <a name="merge-in-other-scenarios"></a><span data-ttu-id="6b464-123">MERGE em outros cenários</span><span class="sxs-lookup"><span data-stu-id="6b464-123">MERGE in Other Scenarios</span></span>  
 <span data-ttu-id="6b464-124">Nos cenários a seguir, você pode usar a instrução MERGE fora ou dentro de um pacote do [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="6b464-124">In the following scenarios, you can use the MERGE statement either outside or inside an [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] package.</span></span> <span data-ttu-id="6b464-125">No entanto, um pacote do [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] geralmente deve carregar esses dados a partir de várias fontes heterogêneas e, em seguida, combinar e limpar os dados.</span><span class="sxs-lookup"><span data-stu-id="6b464-125">However, an [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] package is often required to load this data from multiple heterogeneous sources, and then to combine and cleanse the data.</span></span> <span data-ttu-id="6b464-126">Desse modo, é aconselhável usar a instrução MERGE em um pacote para que você tenha mais praticidade e seja mais fácil executar a manutenção.</span><span class="sxs-lookup"><span data-stu-id="6b464-126">Therefore, you might consider using the MERGE statement in a package for convenience and ease of maintenance.</span></span>  
  
##### <a name="track-buying-habits"></a><span data-ttu-id="6b464-127">Acompanhar hábitos de compra</span><span class="sxs-lookup"><span data-stu-id="6b464-127">Track Buying Habits</span></span>  
 <span data-ttu-id="6b464-128">A tabela FactBuyingHabits no data warehouse rastreia a última data em que um cliente comprou um determinado produto.</span><span class="sxs-lookup"><span data-stu-id="6b464-128">The FactBuyingHabits table in the data warehouse tracks the last date on which a customer bought a given product.</span></span> <span data-ttu-id="6b464-129">A tabela consiste nas colunas ProductID, CustomerID e PurchaseDate.</span><span class="sxs-lookup"><span data-stu-id="6b464-129">The table consists of ProductID, CustomerID and PurchaseDate columns.</span></span> <span data-ttu-id="6b464-130">Todas as semanas, o banco de dados transacional gera uma tabela PurchaseRecords que inclui as compras feitas durante aquela semana.</span><span class="sxs-lookup"><span data-stu-id="6b464-130">Every week, the transactional database generates a PurchaseRecords table that includes the purchases made during that week.</span></span> <span data-ttu-id="6b464-131">O objetivo é usar uma única instrução MERGE para mesclar as informações da tabela PurchaseRecords na tabela FactBuyingHabits.</span><span class="sxs-lookup"><span data-stu-id="6b464-131">The objective is to use a single MERGE statement to merge the information in the PurchaseRecords table into the FactBuyingHabits table.</span></span> <span data-ttu-id="6b464-132">Para os pares produto-cliente que não existem, a instrução MERGE insere linhas novas.</span><span class="sxs-lookup"><span data-stu-id="6b464-132">For product-customer pairs that do not exist, the MERGE statement inserts new rows.</span></span> <span data-ttu-id="6b464-133">Para os pares produto-cliente que existem, a instrução MERGE atualiza a data de compra mais recente.</span><span class="sxs-lookup"><span data-stu-id="6b464-133">For product-customer pairs that exist, the MERGE statement updates the most recent date-of-purchase.</span></span>  
  
###### <a name="track-price-history"></a><span data-ttu-id="6b464-134">Acompanhar o histórico de preços</span><span class="sxs-lookup"><span data-stu-id="6b464-134">Track Price History</span></span>  
 <span data-ttu-id="6b464-135">A tabela DimBook representa a lista de livros do inventário de um vendedor de livros e identifica o histórico de preços de cada livro.</span><span class="sxs-lookup"><span data-stu-id="6b464-135">The DimBook table represents the list of books in the inventory of a book seller and identifies the price history of each book.</span></span> <span data-ttu-id="6b464-136">Esta tabela tem estas colunas: ISBN, ProductID, Price, Shelf e IsCurrent.</span><span class="sxs-lookup"><span data-stu-id="6b464-136">This table has these columns: ISBN, ProductID, Price, Shelf, and IsCurrent.</span></span> <span data-ttu-id="6b464-137">Esta tabela também tem uma linha para cada preço que o livro já teve.</span><span class="sxs-lookup"><span data-stu-id="6b464-137">This table also has one row for each price the book has had.</span></span> <span data-ttu-id="6b464-138">Uma dessas linhas contém o preço atual.</span><span class="sxs-lookup"><span data-stu-id="6b464-138">One of these rows contains the current price.</span></span> <span data-ttu-id="6b464-139">Para indicar qual linha contém o preço atual, o valor da coluna IsCurrent para essa linha é definido como 1.</span><span class="sxs-lookup"><span data-stu-id="6b464-139">To indicate which row contains the current price, the value of the IsCurrent column for that row is set to 1.</span></span>  
  
 <span data-ttu-id="6b464-140">Todas as semanas, o banco de dados gera uma tabela WeeklyChanges que contém as alterações de preço da semana e os novos livros que foram adicionados durante a semana.</span><span class="sxs-lookup"><span data-stu-id="6b464-140">Every week, the database generates a WeeklyChanges table that contains price changes for the week and new books that were added during the week.</span></span> <span data-ttu-id="6b464-141">Usando uma única instrução MERGE, você pode aplicar as alterações da tabela WeeklyChanges na tabela DimBook.</span><span class="sxs-lookup"><span data-stu-id="6b464-141">By using a single MERGE statement, you can apply the changes in the WeeklyChanges table to the DimBook table.</span></span> <span data-ttu-id="6b464-142">A instrução MERGE insere novas linhas para os livros adicionados recentemente e atualiza a coluna IsCurrent para 0 nas linhas dos livros existentes cujo preço foi alterado.</span><span class="sxs-lookup"><span data-stu-id="6b464-142">The MERGE statement inserts new rows for newly-added books, and updates the IsCurrent column to 0 for rows of existing books whose prices have changed.</span></span> <span data-ttu-id="6b464-143">A instrução MERGE também insere novas linhas para os livros cujo preço foi alterado e, para essas novas linhas, define o valor da coluna IsCurrent como 1.</span><span class="sxs-lookup"><span data-stu-id="6b464-143">The MERGE statement also inserts new rows for books whose prices have changed, and for these new rows, sets the value of the IsCurrent column to 1.</span></span>  
  
### <a name="merge-a-table-with-new-data-against-the-old-table"></a><span data-ttu-id="6b464-144">Mesclar uma tabela com dados novos em uma tabela antiga</span><span class="sxs-lookup"><span data-stu-id="6b464-144">Merge a Table with New Data Against the Old Table</span></span>  
 <span data-ttu-id="6b464-145">O banco de dados define as propriedades de um objeto usando um "esquema aberto", ou seja, uma tabela que contém pares nome-valor para cada propriedade.</span><span class="sxs-lookup"><span data-stu-id="6b464-145">The database models the properties of an object by using an "open schema," that is, a table contains name-value pairs for each property.</span></span> <span data-ttu-id="6b464-146">A tabela Properties tem três colunas: EntityID, PropertyID e Value.</span><span class="sxs-lookup"><span data-stu-id="6b464-146">The Properties table has three columns: EntityID, PropertyID, and Value.</span></span> <span data-ttu-id="6b464-147">Uma tabela NewProperties que é uma versão mais nova da tabela deve ser sincronizada com a tabela Properties.</span><span class="sxs-lookup"><span data-stu-id="6b464-147">A NewProperties table that is a newer version of the table has to be synchronized with the Properties table.</span></span> <span data-ttu-id="6b464-148">Para sincronizar essas duas tabelas, você pode usar uma única instrução MERGE para executar as seguintes operações:</span><span class="sxs-lookup"><span data-stu-id="6b464-148">To synchronize these two tables, you can use a single MERGE statement to perform the following operations:</span></span>  
  
-   <span data-ttu-id="6b464-149">Exclua propriedades da tabela Properties se elas não existirem na tabela NewProperties.</span><span class="sxs-lookup"><span data-stu-id="6b464-149">Delete properties from the Properties table if they are absent from the NewProperties table.</span></span>  
  
-   <span data-ttu-id="6b464-150">Atualize os valores das propriedades que estão na tabela Properties com os novos valores encontrados na tabela NewProperties.</span><span class="sxs-lookup"><span data-stu-id="6b464-150">Update values for properties that are in the Properties table with new values found in the NewProperties table.</span></span>  
  
-   <span data-ttu-id="6b464-151">Insira novas propriedades para as propriedades que estão na tabela NewProperties, mas não são encontradas na tabela Properties.</span><span class="sxs-lookup"><span data-stu-id="6b464-151">Insert new properties for properties that are in the NewProperties table but are not found in the Properties table.</span></span>  
  
 <span data-ttu-id="6b464-152">Essa abordagem é útil em cenários que lembram cenários de replicação, onde o objetivo é manter os dados das duas tabelas em dois servidores sincronizados.</span><span class="sxs-lookup"><span data-stu-id="6b464-152">This approach is useful in scenarios that resemble replication scenarios, where the objective is to keep data in two tables on two servers synchronized.</span></span>  
  
### <a name="track-inventory"></a><span data-ttu-id="6b464-153">Acompanhar o inventário</span><span class="sxs-lookup"><span data-stu-id="6b464-153">Track Inventory</span></span>  
 <span data-ttu-id="6b464-154">O banco de dados Inventory tem uma tabela ProductsInventory que tem as colunas ProductID e StockOnHand.</span><span class="sxs-lookup"><span data-stu-id="6b464-154">The Inventory database has a ProductsInventory table that has ProductID and StockOnHand columns.</span></span> <span data-ttu-id="6b464-155">Uma tabela Shipments com as colunas ProductID, CustomerID e Quantity rastreia o envio de produtos para os clientes.</span><span class="sxs-lookup"><span data-stu-id="6b464-155">A Shipments table with ProductID, CustomerID, and Quantity columns tracks shipments of products to customers.</span></span> <span data-ttu-id="6b464-156">A tabela ProductInventory deve ser atualizada diariamente com base nas informações da tabela Shipments.</span><span class="sxs-lookup"><span data-stu-id="6b464-156">The ProductInventory table has to be updated daily based on information in the Shipments table.</span></span> <span data-ttu-id="6b464-157">Uma única instrução MERGE pode reduzir o inventário na tabela ProductInventory com base nas remessas feitas.</span><span class="sxs-lookup"><span data-stu-id="6b464-157">A single MERGE statement can reduce the inventory in the ProductInventory table based on the shipments made.</span></span> <span data-ttu-id="6b464-158">Se o inventário de um produto for reduzido a 0, a instrução MERGE também poderá excluir a linha desse produto da tabela ProductInventory.</span><span class="sxs-lookup"><span data-stu-id="6b464-158">If the inventory for a product has been reduced to 0, that MERGE statement can also delete that product row from the ProductInventory table.</span></span>  
  
  
