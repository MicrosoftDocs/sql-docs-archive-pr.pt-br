---
title: Atualizar o envio de logs para SQL Server 2014 (Transact-SQL) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- log shipping [SQL Server], upgrading
ms.assetid: b1289cc3-f5be-40bb-8801-0e3eed40336e
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 80330d03853c984cfd26100b02918eb218705085
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87583774"
---
# <a name="upgrade-log-shipping-to-sql-server-2014-transact-sql"></a><span data-ttu-id="6bacc-102">Atualizar o envio de logs para o SQL Server 2014 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="6bacc-102">Upgrade Log Shipping to SQL Server 2014 (Transact-SQL)</span></span>
  <span data-ttu-id="6bacc-103">É possível preservar as configurações de envio de logs ao atualizar do [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)]ou [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] para o [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="6bacc-103">It is possible to preserve log shipping configurations when upgrading from [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)], or [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span> <span data-ttu-id="6bacc-104">Este tópico descreve cenários alternativos e práticas recomendadas para atualizar uma configuração de envio de logs.</span><span class="sxs-lookup"><span data-stu-id="6bacc-104">This topic describes alternative scenarios and best practices for upgrading a log shipping configuration.</span></span>

> [!NOTE]
>  <span data-ttu-id="6bacc-105">[A compactação de backup](../../relational-databases/backup-restore/backup-compression-sql-server.md) foi introduzida no [!INCLUDE[ssEnterpriseEd10](../../includes/ssenterpriseed10-md.md)].</span><span class="sxs-lookup"><span data-stu-id="6bacc-105">[Backup compression](../../relational-databases/backup-restore/backup-compression-sql-server.md) was introduced in [!INCLUDE[ssEnterpriseEd10](../../includes/ssenterpriseed10-md.md)].</span></span> <span data-ttu-id="6bacc-106">Uma configuração de envio de logs atualizada usa a opção de configuração no nível do servidor de **compactação de backup padrão** para controlar se a compactação será utilizada para os arquivos de backup de log de transações.</span><span class="sxs-lookup"><span data-stu-id="6bacc-106">An upgraded log shipping configuration uses the **backup compression default** server-level configuration option to control whether backup compression is used for the transaction log backup files.</span></span> <span data-ttu-id="6bacc-107">O comportamento de compactação de backups de log pode ser especificado para cada configuração de envio de logs.</span><span class="sxs-lookup"><span data-stu-id="6bacc-107">The backup compression behavior of log backups can be specified for each log shipping configuration.</span></span> <span data-ttu-id="6bacc-108">Para obter mais informações, consulte [Configurar o envio de logs &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="6bacc-108">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>


##  <a name="protect-your-data-before-the-upgrade"></a><a name="ProtectData"></a> <span data-ttu-id="6bacc-109">Proteja os dados antes da atualização</span><span class="sxs-lookup"><span data-stu-id="6bacc-109">Protect Your Data Before the Upgrade</span></span>
 <span data-ttu-id="6bacc-110">Como uma prática recomendada, sugerimos que você proteja seus dados antes de uma atualização de envio de logs.</span><span class="sxs-lookup"><span data-stu-id="6bacc-110">As a best practice, we recommend that you protect your data before a log shipping upgrade.</span></span>

 <span data-ttu-id="6bacc-111">**Para proteger os dados**</span><span class="sxs-lookup"><span data-stu-id="6bacc-111">**To protect your data**</span></span>

1.  <span data-ttu-id="6bacc-112">Execute um backup completo de todos os bancos de dados primários.</span><span class="sxs-lookup"><span data-stu-id="6bacc-112">Perform a full database backup on every primary database.</span></span>

     <span data-ttu-id="6bacc-113">Para obter mais informações, veja [Criar um backup completo de banco de dados &#40;SQL Server&#41;](../../relational-databases/backup-restore/create-a-full-database-backup-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="6bacc-113">For more information, see [Create a Full Database Backup &#40;SQL Server&#41;](../../relational-databases/backup-restore/create-a-full-database-backup-sql-server.md).</span></span>

2.  <span data-ttu-id="6bacc-114">Execute o comando [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql) em todos os bancos de dados primários.</span><span class="sxs-lookup"><span data-stu-id="6bacc-114">Run the [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql) command on every primary database.</span></span>

##  <a name="upgrading-the-monitor-server-instance"></a><a name="UpgradeMonitor"></a><span data-ttu-id="6bacc-115">Atualizando a instância do servidor monitor</span><span class="sxs-lookup"><span data-stu-id="6bacc-115">Upgrading the Monitor Server Instance</span></span>
 <span data-ttu-id="6bacc-116">Se existir uma instância do servidor monitor, ela poderá ser atualizada em qualquer momento.</span><span class="sxs-lookup"><span data-stu-id="6bacc-116">The monitor server instance, if any, can be upgraded at any time.</span></span>

 <span data-ttu-id="6bacc-117">Enquanto o servidor monitor está sendo atualizado, a configuração de envio de logs continua funcionando, mas seu status não será registrado nas tabelas do monitor.</span><span class="sxs-lookup"><span data-stu-id="6bacc-117">While the monitor server is being upgraded, the log shipping configuration continues to work, but its status is not recorded in the tables on the monitor.</span></span> <span data-ttu-id="6bacc-118">Qualquer alerta que tenha sido configurado não será disparado, enquanto o servidor monitor estiver sendo atualizado.</span><span class="sxs-lookup"><span data-stu-id="6bacc-118">Any alerts that have been configured will not be triggered while the monitor server is being upgraded.</span></span> <span data-ttu-id="6bacc-119">Após a atualização, você poderá atualizar as informações nas tabelas do monitor executando o procedimento armazenado do sistema [sp_refresh_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-refresh-log-shipping-monitor-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="6bacc-119">After the upgrade, you can update the information in the monitor tables by executing the [sp_refresh_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-refresh-log-shipping-monitor-transact-sql) system stored procedure.</span></span>

##  <a name="upgrading-log-shipping-configurations-with-a-single-secondary-server"></a><a name="UpgradeSingleSecondary"></a><span data-ttu-id="6bacc-120">Atualizando configurações de envio de logs com um único servidor secundário</span><span class="sxs-lookup"><span data-stu-id="6bacc-120">Upgrading Log Shipping Configurations with a Single Secondary Server</span></span>
 <span data-ttu-id="6bacc-121">O processo de atualização descrito nesta seção assume uma configuração que consiste no servidor primário e somente em um servidor secundário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-121">The upgrade process described in this section assumes a configuration consisting of the primary server and only one secondary server.</span></span> <span data-ttu-id="6bacc-122">Essa configuração é representada na ilustração seguinte que mostra uma instância de servidor primário, A, e uma única instância de servidor secundário, B.</span><span class="sxs-lookup"><span data-stu-id="6bacc-122">This configuration is represented in the following illustration, which shows a primary server instance, A, and a single secondary server instance, B.</span></span>

 <span data-ttu-id="6bacc-123">![Um servidor secundário e nenhum servidor monitor](../media/ls-2-wayconfig-nomonitor.gif "Um servidor secundário e nenhum servidor monitor")</span><span class="sxs-lookup"><span data-stu-id="6bacc-123">![One secondary server and no monitor server](../media/ls-2-wayconfig-nomonitor.gif "One secondary server and no monitor server")</span></span>

 <span data-ttu-id="6bacc-124">Para obter informações sobre como atualizar vários servidores secundários, consulte [Atualizando várias instâncias do servidor secundário](#MultipleSecondaries), posteriormente neste tópico.</span><span class="sxs-lookup"><span data-stu-id="6bacc-124">For information about upgrading multiple secondary servers, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>
 

###  <a name="upgrading-the-secondary-server-instance"></a><a name="UpgradeSecondary"></a><span data-ttu-id="6bacc-125">Atualizando a instância do servidor secundário</span><span class="sxs-lookup"><span data-stu-id="6bacc-125">Upgrading the Secondary Server Instance</span></span>
 <span data-ttu-id="6bacc-126">O processo de atualização envolve a atualização das instâncias do servidor secundário de uma configuração de envio de logs do [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] ou posterior para o [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] antes de atualizar a instância de servidor primário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-126">The upgrade process involves upgrading the secondary server instances of a [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher log shipping configuration to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] before upgrading the primary server instance.</span></span> <span data-ttu-id="6bacc-127">Sempre atualize primeiro a instância do servidor secundário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-127">Always upgrade the secondary server instance first.</span></span> <span data-ttu-id="6bacc-128">Se o servidor primário fosse atualizado antes de um secundário, o envio de logs falharia porque um backup criado em uma versão mais recente do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] não pode ser restaurado em uma versão mais antiga do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="6bacc-128">If the primary server were upgraded before a secondary server, log shipping would fail because a backup created on a newer version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] cannot be restored on an older version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span>

 <span data-ttu-id="6bacc-129">O envio de logs continua ao longo do processo de atualização porque os servidores secundários atualizados continuam restaurando os backups de log do servidor primário do [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] ou posterior.</span><span class="sxs-lookup"><span data-stu-id="6bacc-129">Log shipping continues throughout the upgrade process because the upgraded secondary servers continue to restore the log backups from the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher primary server.</span></span> <span data-ttu-id="6bacc-130">O processo para atualizar as instâncias do servidor secundário depende em parte se a configuração de envio de logs possui vários servidores secundários.</span><span class="sxs-lookup"><span data-stu-id="6bacc-130">The process for upgrading the secondary server instances depends partly on whether the log shipping configuration possesses multiple secondary servers.</span></span> <span data-ttu-id="6bacc-131">Para obter mais informações, consulte [Atualizando várias instâncias do servidor secundário](#MultipleSecondaries)posteriormente neste tópico.</span><span class="sxs-lookup"><span data-stu-id="6bacc-131">For more information, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>

 <span data-ttu-id="6bacc-132">Enquanto a instância do servidor secundário estiver sendo atualizada, os trabalhos de cópia e restauração de envio de logs não serão executados, portanto, os backups de log de transações não restaurados serão acumulados.</span><span class="sxs-lookup"><span data-stu-id="6bacc-132">While the secondary server instance is being upgraded, the log shipping copy and restore jobs do not run, so unrestored transaction log backups will accumulate.</span></span> <span data-ttu-id="6bacc-133">A quantidade de acumulação dependerá da frequência de backups agendados no servidor primário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-133">The amount of accumulation depends on the frequency of scheduled backup on the primary server.</span></span> <span data-ttu-id="6bacc-134">Além disso, se um servidor monitor separado tiver sido configurado, alertas poderão ser gerados indicando que restaurações não foram realizadas por um período mais longo do que o intervalo configurado.</span><span class="sxs-lookup"><span data-stu-id="6bacc-134">Also, if a separate monitor server has been configured, alerts might be raised indicating restores have not been performed for longer than the configured interval.</span></span>

 <span data-ttu-id="6bacc-135">Depois que o servidor secundário tiver sido atualizado, os trabalhos dos agentes de envio de logs serão retomados e retomarão a copiar e a restaurar os backups de log da instância do servidor primário, o servidor A. O tempo necessário para o servidor secundário atualizar o banco de dados secundário varia, dependendo do tempo necessário para atualizar o servidor secundário e da frequência dos backups no servidor primário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-135">Once the secondary server has been upgraded, the log shipping agents jobs resume and continue to copy and restore log backups from the primary server instance, server A. The amount of time required for the secondary server to bring the secondary database up to date varies, depending on the time taken to upgrade the secondary server and the frequency of the backups on the primary server.</span></span>

> [!NOTE]
>  <span data-ttu-id="6bacc-136">Durante a atualização do servidor, o banco de dados secundário não será atualizado para um banco de dados do [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="6bacc-136">During the server upgrade, the secondary database is not upgraded to a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] database.</span></span> <span data-ttu-id="6bacc-137">Ele só será atualizado se estiver online.</span><span class="sxs-lookup"><span data-stu-id="6bacc-137">It will get upgraded only if it is brought online.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="6bacc-138">A opção RESTORE WITH STANDBY não tem suporte para um banco de dados que requer atualização.</span><span class="sxs-lookup"><span data-stu-id="6bacc-138">The RESTORE WITH STANDBY option is not supported for a database that requires upgrading.</span></span> <span data-ttu-id="6bacc-139">Se um banco de dados secundário atualizado foi configurado usando RESTORE WITH STANDBY, os logs de transação já não poderão ser restaurados depois da atualização.</span><span class="sxs-lookup"><span data-stu-id="6bacc-139">If an upgraded secondary database has been configured by using RESTORE WITH STANDBY, transaction logs can no longer be restored after upgrade.</span></span> <span data-ttu-id="6bacc-140">Para retomar o envio de logs no banco de dados secundário, você precisará configurar o envio de logs novamente no servidor em espera.</span><span class="sxs-lookup"><span data-stu-id="6bacc-140">To resume log shipping on that secondary database, you will need to set up log shipping again on that standby server.</span></span> <span data-ttu-id="6bacc-141">Para obter mais informações sobre a opção de espera, consulte [argumentos de restore &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-arguments-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="6bacc-141">For more information about the STANDBY option, see [RESTORE Arguments &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-arguments-transact-sql).</span></span>

###  <a name="upgrading-the-primary-server-instance"></a><a name="UpgradePrimary"></a> <span data-ttu-id="6bacc-142">Atualizando a instância do servidor primário</span><span class="sxs-lookup"><span data-stu-id="6bacc-142">Upgrading the Primary Server Instance</span></span>
 <span data-ttu-id="6bacc-143">Ao planejar uma atualização, uma consideração importante é a quantidade de tempo que seu banco de dados ficará indisponível.</span><span class="sxs-lookup"><span data-stu-id="6bacc-143">When planning an upgrade, a significant consideration is the amount of time that your database will be unavailable.</span></span> <span data-ttu-id="6bacc-144">O cenário de atualização mais simples indisponibiliza o banco de dados durante a atualização do servidor primário (cenário 1, abaixo).</span><span class="sxs-lookup"><span data-stu-id="6bacc-144">The simplest upgrade scenario involves the database being unavailable while you upgrade the primary server (scenario 1, below).</span></span>

 <span data-ttu-id="6bacc-145">Por meio de um processo de atualização mais complicado, você poderá maximizar a disponibilidade do seu banco de dados efetuando failover do servidor primário do [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] ou posterior para um servidor secundário do [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] antes de atualizar o servidor primário original (cenário 2, abaixo).</span><span class="sxs-lookup"><span data-stu-id="6bacc-145">At the cost of a more complicated upgrade process, you can maximize your database availability by failing over the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher primary server to a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] secondary server before upgrading the original primary server (scenario 2, below).</span></span> <span data-ttu-id="6bacc-146">Há duas variantes do cenário de failover.</span><span class="sxs-lookup"><span data-stu-id="6bacc-146">There are two variants of the failover scenario.</span></span> <span data-ttu-id="6bacc-147">Você pode alternar novamente para o servidor primário original e manter a configuração original de envio de logs.</span><span class="sxs-lookup"><span data-stu-id="6bacc-147">You can switch back to the original primary server and keep the original log shipping configuration.</span></span> <span data-ttu-id="6bacc-148">Alternativamente, você poderá remover a configuração original de envio de logs antes de atualizar o servidor primário original e posteriormente criar uma nova configuração usando o novo servidor primário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-148">Alternatively, you can remove the original log shipping configuration before upgrading the original primary server and later create a new configuration using the new primary server.</span></span> <span data-ttu-id="6bacc-149">Esta seção descreve os dois cenários.</span><span class="sxs-lookup"><span data-stu-id="6bacc-149">This section describes both these scenarios.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="6bacc-150">Atualize a instância do servidor secundário antes de atualizar a instância de servidor primário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-150">Be sure to upgrade the secondary server instance before upgrading the primary server instance.</span></span> <span data-ttu-id="6bacc-151">Para obter mais informações, consulte [Atualizando a instância do servidor secundário](#UpgradeSecondary)anteriormente neste tópico.</span><span class="sxs-lookup"><span data-stu-id="6bacc-151">For more information, see [Upgrading the Secondary Server Instance](#UpgradeSecondary), earlier in this topic.</span></span>


####  <a name="scenario-1-upgrade-primary-server-instance-without-failover"></a><a name="Scenario1"></a><span data-ttu-id="6bacc-152">Cenário 1: atualizar a instância do servidor primário sem failover</span><span class="sxs-lookup"><span data-stu-id="6bacc-152">Scenario 1: Upgrade Primary Server Instance Without Failover</span></span>
 <span data-ttu-id="6bacc-153">Este é o cenário mais simples, entretanto ele gera mais tempo de inatividade do que o cenário que usa failover.</span><span class="sxs-lookup"><span data-stu-id="6bacc-153">This is the simpler scenario, but it causes more downtime than using failover.</span></span> <span data-ttu-id="6bacc-154">A instância do servidor primário é simplesmente atualizada e o banco de dados fica indisponível durante esta atualização.</span><span class="sxs-lookup"><span data-stu-id="6bacc-154">The primary server instance is simply upgraded and the database is unavailable during this upgrade.</span></span>

 <span data-ttu-id="6bacc-155">Quando o servidor é atualizado, o banco de dados fica online automaticamente, o que faz com que ele seja atualizado.</span><span class="sxs-lookup"><span data-stu-id="6bacc-155">Once the server is upgraded, the database is automatically brought back online, which causes it to be upgraded.</span></span> <span data-ttu-id="6bacc-156">Depois que o banco de dados é atualizado, os trabalhos de envio de logs são retomados.</span><span class="sxs-lookup"><span data-stu-id="6bacc-156">After the database is upgraded, the log shipping jobs resume.</span></span>

#### <a name="scenario-2-upgrade-primary-server-instance-with-failover"></a><span data-ttu-id="6bacc-157">Cenário 2: Atualização da instância do servidor primário com failover</span><span class="sxs-lookup"><span data-stu-id="6bacc-157">Scenario 2: Upgrade Primary Server Instance with Failover</span></span>
 <span data-ttu-id="6bacc-158">Este cenário maximiza a disponibilidade e minimiza tempo de inatividade.</span><span class="sxs-lookup"><span data-stu-id="6bacc-158">This scenario maximizes availability and minimizes downtime.</span></span> <span data-ttu-id="6bacc-159">Ele utiliza um failover controlado para a instância do servidor secundário, o que mantém o banco de dados disponível enquanto a instância do servidor primário original é atualizada.</span><span class="sxs-lookup"><span data-stu-id="6bacc-159">It utilizes a controlled failover to the secondary server instance, which keeps the database available while the original primary server instance is upgraded.</span></span> <span data-ttu-id="6bacc-160">O tempo de inatividade é limitado ao tempo relativamente curto do failover, em vez do tempo necessário para atualizar a instância do servidor primário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-160">Downtime is limited to the relatively short time required to fail over, rather than the time required to upgrade the primary server instance.</span></span>

 <span data-ttu-id="6bacc-161">A atualização da instância do servidor primário com failover envolve três procedimentos gerais: a execução de um failover controlado para o servidor secundário, a atualização da instância do servidor primário original para [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]e a configuração de envio de logs em uma instância do servidor primário do [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="6bacc-161">Upgrading the primary server instance with failover involves three general procedures: performing a controlled failover to the secondary server, upgrading the original primary server instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], and setting up log shipping on a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] primary server instance.</span></span> <span data-ttu-id="6bacc-162">Esses procedimentos são descritos nesta seção.</span><span class="sxs-lookup"><span data-stu-id="6bacc-162">These procedures are described in this section.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="6bacc-163">Se você planeja ter a instância do servidor secundário como a nova instância do servidor primário, precisará remover a configuração de envio de logs.</span><span class="sxs-lookup"><span data-stu-id="6bacc-163">If you plan to have the secondary server instance as the new primary server instance, you need to remove the log shipping configuration.</span></span> <span data-ttu-id="6bacc-164">O envio de logs precisará ser reconfigurado do novo primário para o novo secundário, depois que a instância do servidor primário original tiver sido atualizada.</span><span class="sxs-lookup"><span data-stu-id="6bacc-164">Log shipping will need to be reconfigured from the new primary to the new secondary, after the original primary server instance has been upgraded.</span></span> <span data-ttu-id="6bacc-165">Para obter mais informações, consulte [remover o envio de logs &#40;SQL Server&#41;](remove-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="6bacc-165">For more information, see [Remove Log Shipping &#40;SQL Server&#41;](remove-log-shipping-sql-server.md).</span></span>


#####  <a name="procedure-1-perform-a-controlled-failover-to-the-secondary-server"></a><a name="Procedure1"></a><span data-ttu-id="6bacc-166">Procedimento 1: executar um failover controlado para o servidor secundário</span><span class="sxs-lookup"><span data-stu-id="6bacc-166">Procedure 1: Perform a Controlled Failover to the Secondary Server</span></span>
 <span data-ttu-id="6bacc-167">Failover controlado no servidor secundário:</span><span class="sxs-lookup"><span data-stu-id="6bacc-167">Controlled failover to the secondary server:</span></span>

1.  <span data-ttu-id="6bacc-168">Execute manualmente um [backup da parte final do log](../../relational-databases/backup-restore/tail-log-backups-sql-server.md) do log de transações no banco de dados primário ESPECIFICANDO with NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="6bacc-168">Manually perform a [tail-log backup](../../relational-databases/backup-restore/tail-log-backups-sql-server.md) of the transaction log on the primary database specifying WITH NORECOVERY.</span></span> <span data-ttu-id="6bacc-169">Esse backup de log captura quaisquer registros de log ainda sem backup e coloca o banco de dados offline.</span><span class="sxs-lookup"><span data-stu-id="6bacc-169">This log backup captures any log records that have not been backed up yet and takes the database offline.</span></span> <span data-ttu-id="6bacc-170">Observe que enquanto o banco de dados estiver offline, o trabalho de backup de envio de logs falhará.</span><span class="sxs-lookup"><span data-stu-id="6bacc-170">Note that while the database is offline, the log shipping backup job will fail.</span></span>

     <span data-ttu-id="6bacc-171">O exemplo seguinte cria um backup da parte final do log do banco de dados do `AdventureWorks` no servidor primário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-171">The following example creates a tail log backup of the `AdventureWorks` database on the primary server.</span></span> <span data-ttu-id="6bacc-172">O arquivo de backup é nomeado como `Failover_AW_20080315.trn`:</span><span class="sxs-lookup"><span data-stu-id="6bacc-172">The backup file is named `Failover_AW_20080315.trn`:</span></span>

    ```
    BACKUP LOG AdventureWorks 
      TO DISK = N'\\FileServer\LogShipping\AdventureWorks\Failover_AW_20080315.trn' 
       WITH NORECOVERY;
    GO
    ```

     <span data-ttu-id="6bacc-173">Recomendamos que você use uma convenção de nomeação de arquivo distinta para diferenciar o arquivo de backup criado manualmente dos arquivos de backup criados pelo trabalho de backup de envio de logs.</span><span class="sxs-lookup"><span data-stu-id="6bacc-173">We recommend that you use a distinct file naming convention to differentiate the manually-created backup file from the backup files created by the log shipping backup job.</span></span>

2.  <span data-ttu-id="6bacc-174">No servidor secundário:</span><span class="sxs-lookup"><span data-stu-id="6bacc-174">On the secondary server:</span></span>

    1.  <span data-ttu-id="6bacc-175">Assegure-se de que todos os backups obtidos automaticamente pelo backup de envio de logs tenham sido aplicados.</span><span class="sxs-lookup"><span data-stu-id="6bacc-175">Ensure that all backups taken automatically by the log shipping backup jobs have been applied.</span></span> <span data-ttu-id="6bacc-176">Para verificar quais trabalhos de backup foram aplicados, use o procedimento armazenado do sistema [sp_help_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-transact-sql) no servidor monitor ou nos servidores primários e secundários.</span><span class="sxs-lookup"><span data-stu-id="6bacc-176">To check which backup jobs have been applied, use the [sp_help_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-transact-sql) system stored procedure on the monitor server or on the primary and secondary servers.</span></span> <span data-ttu-id="6bacc-177">O mesmo arquivo deve ser listado nas colunas **last_backup_file**, **last_copied_file**e **last_restored_file** .</span><span class="sxs-lookup"><span data-stu-id="6bacc-177">The same file should be listed in the **last_backup_file**, **last_copied_file**, and **last_restored_file** columns.</span></span> <span data-ttu-id="6bacc-178">Se alguns dos arquivos de backup não foram copiados e restaurados, chame manualmente os trabalhos de cópia e restauração do agente para a configuração de envio de logs.</span><span class="sxs-lookup"><span data-stu-id="6bacc-178">If any of the backup files have not been copied and restored, manually invoke the agent copy and restore jobs for the log shipping configuration.</span></span>

         <span data-ttu-id="6bacc-179">Para obter informações sobre como iniciar um trabalho, consulte [Start a Job](../../ssms/agent/start-a-job.md).</span><span class="sxs-lookup"><span data-stu-id="6bacc-179">For information about starting a job, see [Start a Job](../../ssms/agent/start-a-job.md).</span></span>

    2.  <span data-ttu-id="6bacc-180">Copie o arquivo de backup de log final que você criou na etapa 1 do compartilhamento de arquivo para o local que é usado pelo envio de logs no servidor secundário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-180">Copy your the final log backup file that you created in step 1 from the file share to the local location that is used by log shipping on the secondary server.</span></span>

    3.  <span data-ttu-id="6bacc-181">Restaure o backup do final do log especificando WITH RECOVERY para colocar o banco de dados online.</span><span class="sxs-lookup"><span data-stu-id="6bacc-181">Restore the final log backup specifying WITH RECOVERY to bring the database online.</span></span> <span data-ttu-id="6bacc-182">Como resultado de ser colocado online, o banco de dados será atualizado para [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="6bacc-182">As part of being brought online, the database will upgraded to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>

         <span data-ttu-id="6bacc-183">O exemplo seguinte restaura o backup da parte final do log do banco de dados do `AdventureWorks` no banco de dados secundário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-183">The following example restores the tail log backup of the `AdventureWorks` database on the secondary database.</span></span> <span data-ttu-id="6bacc-184">O exemplo usa a opção de WITH RECOVERY que coloca o banco de dados online:</span><span class="sxs-lookup"><span data-stu-id="6bacc-184">The example uses the WITH RECOVERY option, which brings the database online:</span></span>

        ```
        RESTORE LOG AdventureWorks 
          FROM DISK = N'c:\logshipping\Failover_AW_20080315.trn' 
           WITH RECOVERY;
        GO
        ```

        > [!NOTE]
        >  <span data-ttu-id="6bacc-185">Para uma configuração que contém mais de um servidor secundário, há considerações adicionais.</span><span class="sxs-lookup"><span data-stu-id="6bacc-185">For a configuration that contains more than one secondary server, there are additional considerations.</span></span> <span data-ttu-id="6bacc-186">Para obter mais informações, consulte [Atualizando várias instâncias do servidor secundário](#MultipleSecondaries)posteriormente neste tópico.</span><span class="sxs-lookup"><span data-stu-id="6bacc-186">For more information, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>

    4.  <span data-ttu-id="6bacc-187">Efetue o failover do banco de dados redirecionando os clientes do servidor primário original (servidor A) para o servidor secundário online (servidor B).</span><span class="sxs-lookup"><span data-stu-id="6bacc-187">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span>

    5.  <span data-ttu-id="6bacc-188">Cuidado para que o log de transações do banco de dados secundário não seja preenchido enquanto o banco de dados estiver online.</span><span class="sxs-lookup"><span data-stu-id="6bacc-188">Take care that the transaction log of the secondary database does not fill while the database is online.</span></span> <span data-ttu-id="6bacc-189">Para impedir que o log de transações seja preenchido, talvez seja necessário fazer seu backup.</span><span class="sxs-lookup"><span data-stu-id="6bacc-189">To prevent the transaction log from filling, you might need to back it up.</span></span> <span data-ttu-id="6bacc-190">Nesse caso, recomendamos que você faça seu backup em um local compartilhado, um *compartilhamento de backup*, para tornar os backups disponíveis para restauração em outra instância do servidor.</span><span class="sxs-lookup"><span data-stu-id="6bacc-190">If so, we recommend that you back it up to a shared location, a *backup share*, to make the backups available for restoring on the other server instance.</span></span>

#####  <a name="procedure-2-upgrade-the-original-primary-server-instance-to-sscurrent"></a><a name="Procedure2"></a><span data-ttu-id="6bacc-191">Procedimento 2: atualizar a instância do servidor primário original para[!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span><span class="sxs-lookup"><span data-stu-id="6bacc-191">Procedure 2: Upgrade the Original Primary Server Instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span></span>
 <span data-ttu-id="6bacc-192">Depois de atualizar a instância do servidor primário original para o [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], o banco de dados ainda estará offline e no formato.</span><span class="sxs-lookup"><span data-stu-id="6bacc-192">After you upgrade the original primary server instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], the database will still be offline and in the format.</span></span>

#####  <a name="procedure-3-set-up-log-shipping-on-sscurrent"></a><a name="Procedure3"></a><span data-ttu-id="6bacc-193">Procedimento 3: configurar o envio de logs em[!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span><span class="sxs-lookup"><span data-stu-id="6bacc-193">Procedure 3: Set Up Log Shipping on [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span></span>
 <span data-ttu-id="6bacc-194">O restante do processo de atualização dependerá de o envio de logs ainda estar configurado, como a seguir:</span><span class="sxs-lookup"><span data-stu-id="6bacc-194">The rest of the upgrade process depends on whether log shipping is still configured, as follows:</span></span>

-   <span data-ttu-id="6bacc-195">Se você manteve a configuração de envio de logs do [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]ou posterior, alterne novamente para a instância do servidor primário original.</span><span class="sxs-lookup"><span data-stu-id="6bacc-195">If you have kept the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]or higher log shipping configuration, switch back to the original primary server instance.</span></span> <span data-ttu-id="6bacc-196">Para obter mais informações, consulte [Para alternar novamente para a instância do servidor primário original](#SwitchToOrigPrimary)posteriormente nessa seção.</span><span class="sxs-lookup"><span data-stu-id="6bacc-196">For more information, see [To Switch Back to the Original Primary Server Instance](#SwitchToOrigPrimary), later in this section.</span></span>

-   <span data-ttu-id="6bacc-197">Se você tiver removido a configuração de envio de logs antes de efetuar o failover, crie uma nova configuração de envio de logs em que a instância do servidor secundário original seja a nova instância do servidor primário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-197">If you removed the log shipping configuration before failing over, create a new log shipping configuration in which the original secondary server instance is the new primary server instance.</span></span> <span data-ttu-id="6bacc-198">Para obter mais informações, consulte [Para manter a instância do servidor secundário antiga como a nova instância do servidor primário](#KeepOldSecondaryAsNewPrimary)posteriormente nessa seção.</span><span class="sxs-lookup"><span data-stu-id="6bacc-198">For more information, see [To Keep the Old Secondary Server Instance As the New Primary Server Instance](#KeepOldSecondaryAsNewPrimary), later in this section.</span></span>

######  <a name="to-switch-back-to-the-original-primary-server-instance"></a><a name="SwitchToOrigPrimary"></a><span data-ttu-id="6bacc-199">Para voltar para a instância do servidor primário original</span><span class="sxs-lookup"><span data-stu-id="6bacc-199">To Switch Back to the Original Primary Server Instance</span></span>

1.  <span data-ttu-id="6bacc-200">No servidor primário provisório (servidor B), faça backup do final do log usando WITH NORECOVERY para fazer backup da parte final do log e colocar o banco de dados offline.</span><span class="sxs-lookup"><span data-stu-id="6bacc-200">On the interim primary server (server B), back up the tail of the log using WITH NORECOVERY to create a tail-log backup and take the database offline.</span></span> <span data-ttu-id="6bacc-201">O backup da parte final do log é nomeado como `Switchback_AW_20080315.trn`.Por exemplo:</span><span class="sxs-lookup"><span data-stu-id="6bacc-201">The tail log backup is named `Switchback_AW_20080315.trn`.For example:</span></span>

    ```
    BACKUP LOG AdventureWorks 
      TO DISK = N'\\FileServer\LogShipping\AdventureWorks\Switchback_AW_20080315.trn' 
       WITH NORECOVERY;
    GO
    ```

2.  <span data-ttu-id="6bacc-202">Se alguns backups de log de transações forem feitos no banco de dados primário provisório, além do backup da parte final que você criou na etapa 1, restaure aqueles backups de log usando WITH NORECOVERY para o banco de dados offline no servidor primário original (servidor A).</span><span class="sxs-lookup"><span data-stu-id="6bacc-202">If any transaction log backups were taken on the interim primary database, other than the tail backup that you created in step 1, restore those log backups using WITH NORECOVERY to the offline database on the original primary server (server A).</span></span> <span data-ttu-id="6bacc-203">O banco de dados será atualizado para o formato [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] quando o primeiro backup de log for restaurado.</span><span class="sxs-lookup"><span data-stu-id="6bacc-203">The database is upgraded to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] format when the first log backup is restored.</span></span>

3.  <span data-ttu-id="6bacc-204">Restaure o backup do final do log, `Switchback_AW_20080315.trn`, no banco de dados primário original (no servidor A) usando o WITH RECOVERY para colocar o banco de dados online.</span><span class="sxs-lookup"><span data-stu-id="6bacc-204">Restore the tail-log backup, `Switchback_AW_20080315.trn`, on the original primary database (on server A) using WITH RECOVERY to bring the database online.</span></span>

4.  <span data-ttu-id="6bacc-205">Efetue o failover novamente no banco de dados primário original (no servidor A) redirecionando os clientes para o servidor secundário online do servidor primário original.</span><span class="sxs-lookup"><span data-stu-id="6bacc-205">Fail over back to the original primary database (on server A) by redirecting clients to the online secondary server from the original primary server.</span></span>

 <span data-ttu-id="6bacc-206">Depois que o banco de dados ficar online, a configuração do envio de logs original retomará.</span><span class="sxs-lookup"><span data-stu-id="6bacc-206">After the database comes online, the original log shipping configuration will resume.</span></span>

######  <a name="to-keep-the-old-secondary-server-instance-as-the-new-primary-server-instance"></a><a name="KeepOldSecondaryAsNewPrimary"></a><span data-ttu-id="6bacc-207">Para manter a instância antiga do servidor secundário como a nova instância do servidor primário</span><span class="sxs-lookup"><span data-stu-id="6bacc-207">To Keep the Old Secondary Server Instance As the New Primary Server Instance</span></span>
 <span data-ttu-id="6bacc-208">Estabeleça uma nova configuração de envio de logs utilizando a instância do servidor secundário antiga, B, como o servidor primário e a instância do servidor primário antiga, A, como o novo servidor secundário, como a seguir:</span><span class="sxs-lookup"><span data-stu-id="6bacc-208">Establish a new log shipping configuration using the old secondary server instance, B, as the primary server and the old primary server instance, A, as the new secondary server, as follows:</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="6bacc-209">A configuração de envio de logs antiga deve ter sido removida do servidor primário original no início do processo antes do backup manual do log de transações que colocou o banco de dados offline.</span><span class="sxs-lookup"><span data-stu-id="6bacc-209">The old log shipping configuration should have been removed from the original primary server at the start of the process before taking the manual transaction log backup that took the database offline.</span></span>

1.  <span data-ttu-id="6bacc-210">Para evitar a realização de um backup completo e restauração do banco de dados no novo servidor secundário (servidor A), aplique os backups de log do novo banco de dados primário no novo banco de dados secundário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-210">To avoid performing a complete backup and restore of the database on the new secondary server (server A), apply the log backups from the new primary database to the new secondary database.</span></span> <span data-ttu-id="6bacc-211">Na configuração de exemplo, isto envolve a restauração dos backups de log efetuados no servidor B para o banco de dados do servidor A.</span><span class="sxs-lookup"><span data-stu-id="6bacc-211">In the example configuration, this involves restoring the log backups taken on server B to the database on server A.</span></span>

2.  <span data-ttu-id="6bacc-212">Faça backup do log do novo banco de dados primário (no servidor B).</span><span class="sxs-lookup"><span data-stu-id="6bacc-212">Back up the log from the new primary database (on server B).</span></span>

3.  <span data-ttu-id="6bacc-213">Restaure os backups de log para a nova instância do servidor secundário (servidor A) usando WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="6bacc-213">Restore the log backups to the new secondary server instance (server A) using WITH NORECOVERY.</span></span> <span data-ttu-id="6bacc-214">A primeira operação de restauração atualizará o banco de dados para [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="6bacc-214">The first restore operation updates the database to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>

4.  <span data-ttu-id="6bacc-215">Configure o envio de logs com o servidor secundário anterior (servidor B) como a instância do servidor primário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-215">Configure log shipping with the former secondary server (server B) as the primary server instance.</span></span>

    > [!IMPORTANT]
    >  <span data-ttu-id="6bacc-216">Se você usar o [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], especifique se o banco de dados secundário já está inicializado.</span><span class="sxs-lookup"><span data-stu-id="6bacc-216">If you use [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], specify that the secondary database is already initialized.</span></span>

     <span data-ttu-id="6bacc-217">Para obter mais informações, consulte [Configurar o envio de logs &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="6bacc-217">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>

5.  <span data-ttu-id="6bacc-218">Efetue o failover do banco de dados redirecionando os clientes do servidor primário original (servidor A) para o servidor secundário online (servidor B).</span><span class="sxs-lookup"><span data-stu-id="6bacc-218">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span>

    > [!IMPORTANT]
    >  <span data-ttu-id="6bacc-219">Quando você efetuar o failover para um novo banco de dados primário, deverá assegurar-se de que os metadados estejam consistentes com os metadados do banco de dados primário original.</span><span class="sxs-lookup"><span data-stu-id="6bacc-219">When you failover to a new primary database, you should ensure that its metadata is consistent with the metadata of the original primary database.</span></span> <span data-ttu-id="6bacc-220">Para obter mais informações, consulte [Gerenciar metadados ao disponibilizar um banco de dados em outra instância do servidor &#40;SQL Server&#41;](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md).</span><span class="sxs-lookup"><span data-stu-id="6bacc-220">For more information, see [Manage Metadata When Making a Database Available on Another Server Instance &#40;SQL Server&#41;](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md).</span></span>

##  <a name="upgrading-multiple-secondary-server-instances"></a><a name="MultipleSecondaries"></a><span data-ttu-id="6bacc-221">Atualizando várias instâncias de servidor secundário</span><span class="sxs-lookup"><span data-stu-id="6bacc-221">Upgrading Multiple Secondary Server Instances</span></span>
 <span data-ttu-id="6bacc-222">Essa configuração é representada na ilustração seguinte que mostra uma instância do servidor primário, A, e duas instâncias do servidor secundário, B e C.</span><span class="sxs-lookup"><span data-stu-id="6bacc-222">This configuration is represented in the following illustration, which shows a primary server instance, A, and two secondary server instances, B and C.</span></span>

 <span data-ttu-id="6bacc-223">![Dois servidores secundários e nenhum servidor monitor](../media/ls-3-wayconfig-nomonitor.gif "Dois servidores secundários e nenhum servidor monitor")</span><span class="sxs-lookup"><span data-stu-id="6bacc-223">![Two secondary servers and no monitor server](../media/ls-3-wayconfig-nomonitor.gif "Two secondary servers and no monitor server")</span></span>

 <span data-ttu-id="6bacc-224">Esta seção discute como atualizar usando um failover e alternando de volta para o servidor primário original.</span><span class="sxs-lookup"><span data-stu-id="6bacc-224">This section discusses how to upgrade using a failover and then switching back to the original primary server.</span></span> <span data-ttu-id="6bacc-225">O processo de atualização da instância primária com failover torna-se mais complexo quando há várias instâncias do servidor secundário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-225">When upgrading the primary instance with failover the process is more complex when there are multiple secondary server instances.</span></span> <span data-ttu-id="6bacc-226">No procedimento seguinte, depois que todos os servidores secundários forem atualizados, ocorrerá o failover do servidor primário para um dos bancos de dados secundários atualizados.</span><span class="sxs-lookup"><span data-stu-id="6bacc-226">In the following procedure, after all the secondary servers are upgraded, the primary server is failed over to one of the upgraded secondary databases.</span></span> <span data-ttu-id="6bacc-227">O servidor primário original será atualizado e ocorrerá o failover do envio de logs novamente para ele.</span><span class="sxs-lookup"><span data-stu-id="6bacc-227">The original primary server is upgraded, and log shipping is failed over back to it.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="6bacc-228">Sempre atualize todas as instâncias do servidor secundário antes de atualizar o servidor primário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-228">Always upgrade all the secondary server instances before you upgrade the primary server.</span></span>

 <span data-ttu-id="6bacc-229">**Para atualizar usando um failover e alternando de volta para o servidor primário original**</span><span class="sxs-lookup"><span data-stu-id="6bacc-229">**To upgrade using a failover and then switching back to original primary server**</span></span>

1.  <span data-ttu-id="6bacc-230">Atualize todas as instâncias do servidor secundário (servidores B e C).</span><span class="sxs-lookup"><span data-stu-id="6bacc-230">Upgrade all the secondary server instances (server B and server C).</span></span>

2.  <span data-ttu-id="6bacc-231">Obtenha a parte final do log de transações do banco de dados primário (no servidor A) e coloque o banco de dados offline efetuando o backup do log de transações por meio do WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="6bacc-231">Obtain the tail of the transaction log of the primary database (on server A), and take the database offline, by backing up the transaction log using WITH NORECOVERY.</span></span>

3.  <span data-ttu-id="6bacc-232">No servidor secundário para o qual você planeja efetuar failover (servidor B) coloque o banco de dados secundário online restaurando o backup de log por meio do WITH RECOVERY.</span><span class="sxs-lookup"><span data-stu-id="6bacc-232">On the secondary server to which you plan to fail over (server B), bring the secondary database online, by restoring the log backup using WITH RECOVERY.</span></span>

4.  <span data-ttu-id="6bacc-233">Em todos os outros servidores secundários (servidor C), deixe o banco de dados secundário offline restaurando o backup de log por meio do WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="6bacc-233">On every other secondary server (server C), leave the secondary database offline by restoring the log backup using WITH NORECOVERY.</span></span>

    > [!NOTE]
    >  <span data-ttu-id="6bacc-234">Os trabalhos de cópia e restauração de envio de logs serão executados nos servidores secundários, mas os trabalhos não serão bem-sucedidos porque novos arquivos de backup de log não serão colocados no compartilhamento de backup.</span><span class="sxs-lookup"><span data-stu-id="6bacc-234">The log shipping copy and restore jobs will run on the secondary servers, but the jobs will do nothing because new log-backup files will not be placed on the backup share.</span></span>

5.  <span data-ttu-id="6bacc-235">Efetue o failover do banco de dados redirecionando os clientes do servidor primário original (servidor A) para o servidor secundário online (servidor B).</span><span class="sxs-lookup"><span data-stu-id="6bacc-235">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span> <span data-ttu-id="6bacc-236">O banco de dados online se tornará um servidor primário provisório, mantendo o banco de dados disponível enquanto o servidor primário original estiver offline (servidor A).</span><span class="sxs-lookup"><span data-stu-id="6bacc-236">The online database becomes an interim primary server, keeping the database available while the original primary server is offline (server A).</span></span>

6.  <span data-ttu-id="6bacc-237">Atualize o servidor primário original (servidor A).</span><span class="sxs-lookup"><span data-stu-id="6bacc-237">Upgrade the original primary server (server A).</span></span>

7.  <span data-ttu-id="6bacc-238">No banco de dados no qual você fez o failover – o banco de dados primário provisório (no servidor B), faça backup manualmente do log de transações usando WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="6bacc-238">On the database to which you failed over-the interim primary database (on server B), manually back up the transaction log using WITH NORECOVERY.</span></span> <span data-ttu-id="6bacc-239">Isso coloca o banco de dados offline.</span><span class="sxs-lookup"><span data-stu-id="6bacc-239">This takes the database offline.</span></span>

8.  <span data-ttu-id="6bacc-240">Restaure todos os backups de log de transações que você criou no banco de dados primário provisório (no servidor B) para todos os outros bancos de dados secundários (no servidor C) com o WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="6bacc-240">Restore all transaction log backups that you created on the interim primary database (on server B) to every other secondary database (on server C) using WITH NORECOVERY.</span></span> <span data-ttu-id="6bacc-241">Isso permite que o envio de logs continue do banco de dados primário original depois de sua atualização, sem exigir uma restauração completa em cada banco de dados secundário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-241">This allows log shipping to continue from the original primary database after its upgrade, without requiring a full database restore on each secondary database.</span></span>

9. <span data-ttu-id="6bacc-242">Restaure o log de transações do servidor primário provisório (servidor B) para o banco de dados primário original (no servidor A) por meio do WITH RECOVERY.</span><span class="sxs-lookup"><span data-stu-id="6bacc-242">Restore the transaction log from the interim primary server (server B) to the original primary database (on server A) using WITH RECOVERY.</span></span>

##  <a name="redeploying-log-shipping"></a><a name="Redeploying"></a><span data-ttu-id="6bacc-243">Reimplantando o envio de logs</span><span class="sxs-lookup"><span data-stu-id="6bacc-243">Redeploying Log Shipping</span></span>
 <span data-ttu-id="6bacc-244">Se você não desejar migrar sua configuração de envio de logs usando um dos procedimentos citados acima, é possível reimplantar o envio de logs do zero, reinicializando seu banco de dados secundário com um backup completo e com a restauração do banco de dados primário.</span><span class="sxs-lookup"><span data-stu-id="6bacc-244">If you do not want to migrate your log shipping configuration using one of the procedures shown above, you can redeploy log shipping from scratch by reinitializing your secondary database with a full backup and restore of the primary database.</span></span> <span data-ttu-id="6bacc-245">Essa pode ser uma boa opção, se você tiver um banco de dados pequeno ou se uma alta disponibilidade não for crucial durante o procedimento de atualização.</span><span class="sxs-lookup"><span data-stu-id="6bacc-245">This may be a desirable option if you have a small database or if high availability is not crucial during the upgrade procedure.</span></span>

 <span data-ttu-id="6bacc-246">Para obter informações sobre como habilitar o envio de logs, consulte [Configurar o envio de logs &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="6bacc-246">For information about enabling log shipping, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="6bacc-247">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="6bacc-247">See Also</span></span>
 <span data-ttu-id="6bacc-248">[Backups de log de transações &#40;SQL Server&#41;](../../relational-databases/backup-restore/transaction-log-backups-sql-server.md) [aplicar backups de log de transações &#40;SQL Server&#41;](../../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md) [tabelas de envio de logs e procedimentos armazenados](log-shipping-tables-and-stored-procedures.md)</span><span class="sxs-lookup"><span data-stu-id="6bacc-248">[Transaction Log Backups &#40;SQL Server&#41;](../../relational-databases/backup-restore/transaction-log-backups-sql-server.md) [Apply Transaction Log Backups &#40;SQL Server&#41;](../../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md) [Log Shipping Tables and Stored Procedures](log-shipping-tables-and-stored-procedures.md)</span></span>
