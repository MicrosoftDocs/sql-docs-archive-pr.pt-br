---
title: Envio de logs e replicação (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- replication [SQL Server], log shipping and
- log shipping [SQL Server], replication and
ms.assetid: 132bebfd-0206-4d23-829a-b38e5ed17bc9
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: e3b1a0e08c5850b9e31202965909dfcfe1273e47
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87575335"
---
# <a name="log-shipping-and-replication-sql-server"></a><span data-ttu-id="149da-102">Replicação e envio de logs (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="149da-102">Log Shipping and Replication (SQL Server)</span></span>
  <span data-ttu-id="149da-103">O envio de logs envolve duas cópias de um único banco de dados que, normalmente, residem em computadores diferentes.</span><span class="sxs-lookup"><span data-stu-id="149da-103">Log shipping involves two copies of a single database that typically reside on different computers.</span></span> <span data-ttu-id="149da-104">Em determinado momento, apenas uma cópia do banco de dados está atualmente disponível aos clientes.</span><span class="sxs-lookup"><span data-stu-id="149da-104">At any given time, only one copy of the database is currently available to clients.</span></span> <span data-ttu-id="149da-105">Essa cópia é conhecida como o banco de dados primário.</span><span class="sxs-lookup"><span data-stu-id="149da-105">This copy is known as the primary database.</span></span> <span data-ttu-id="149da-106">As atualizações feitas pelos clientes no banco de dados primário são propagadas por meio do envio de logs para a outra cópia do banco de dados, conhecida como banco de dados secundário.</span><span class="sxs-lookup"><span data-stu-id="149da-106">Updates made by clients to the primary database are propagated by means of log shipping to the other copy of the database, known as the secondary database.</span></span> <span data-ttu-id="149da-107">O envio de logs envolve a aplicação de um log de transações de todas as inserções, atualizações ou exclusões feitas no banco de dados primário para o banco de dados secundário.</span><span class="sxs-lookup"><span data-stu-id="149da-107">Log shipping involves applying the transaction log from every insertion, update, or deletion made on the primary database onto the secondary database.</span></span>  
  
 <span data-ttu-id="149da-108">O envio de logs pode ser usado em combinação com a replicação, com o seguinte comportamento:</span><span class="sxs-lookup"><span data-stu-id="149da-108">Log shipping can be used in conjunction with replication, with the following behavior:</span></span>  
  
-   <span data-ttu-id="149da-109">A replicação não continua depois de um failover de envio de logs.</span><span class="sxs-lookup"><span data-stu-id="149da-109">Replication does not continue after a log shipping failover.</span></span> <span data-ttu-id="149da-110">Se ocorrer um failover, os agentes de replicação não conectarão ao secundário, portanto, as transações não serão replicadas para os Assinantes.</span><span class="sxs-lookup"><span data-stu-id="149da-110">If a failover occurs, replication agents do not connect to the secondary, so transactions are not replicated to Subscribers.</span></span> <span data-ttu-id="149da-111">Se ocorrer um failback para o primário, a replicação será retomada.</span><span class="sxs-lookup"><span data-stu-id="149da-111">If a failback to the primary occurs, replication resumes.</span></span> <span data-ttu-id="149da-112">Todas as transações que o envio de logs copia do secundário para o primário são replicadas para os Assinantes.</span><span class="sxs-lookup"><span data-stu-id="149da-112">All transactions that log shipping copies from the secondary back to the primary are replicated to Subscribers.</span></span>  
  
-   <span data-ttu-id="149da-113">Se o primário for permanentemente perdido, o secundário poderá ser renomeado para que a replicação possa continuar.</span><span class="sxs-lookup"><span data-stu-id="149da-113">If the primary is permanently lost, the secondary can be renamed so that replication can continue.</span></span> <span data-ttu-id="149da-114">O restante deste tópico descreve os requisitos e procedimentos para manipular este caso.</span><span class="sxs-lookup"><span data-stu-id="149da-114">The remainder of this topic describes the requirements and procedures for handling this case.</span></span> <span data-ttu-id="149da-115">O exemplo fornecido é o banco de dados de publicação, que é o banco de dados mais comum de envio de logs, porém, também pode ser aplicado em um processo semelhante para bancos de dados de assinatura e distribuição.</span><span class="sxs-lookup"><span data-stu-id="149da-115">The example given is the publication database, which is the most common database to log ship, but a similar process can also be applied to subscription and distribution databases.</span></span>  
  
 <span data-ttu-id="149da-116">Para obter informações sobre como recuperar bancos de dados envolvidos em replicação sem nenhuma necessidade de reconfigurar a replicação, consulte [Fazer backup e restaurar bancos de dados replicados](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md).</span><span class="sxs-lookup"><span data-stu-id="149da-116">For information about recovering databases involved in replication without any need to reconfigure replication, see [Back Up and Restore Replicated Databases](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="149da-117">É recomendável usar espelhamento de banco de dados, em vez de envio de logs, para dar mais disponibilidade ao banco de dados de publicação.</span><span class="sxs-lookup"><span data-stu-id="149da-117">We recommend using database mirroring, rather than log shipping, to provide availability for the publication database.</span></span> <span data-ttu-id="149da-118">Para obter mais informações, consulte [Espelhamento e replicação de banco de dados &#40;SQL Server&#41;](../database-mirroring/database-mirroring-and-replication-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="149da-118">For more information, see [Database Mirroring and Replication &#40;SQL Server&#41;](../database-mirroring/database-mirroring-and-replication-sql-server.md).</span></span>  
  
## <a name="requirements-and-procedures-for-replicating-from-the-secondary-if-the-primary-is-lost"></a><span data-ttu-id="149da-119">Requisitos e procedimentos para replicação do secundário caso o primário seja perdido</span><span class="sxs-lookup"><span data-stu-id="149da-119">Requirements and Procedures for Replicating from the Secondary If the Primary Is Lost</span></span>  
 <span data-ttu-id="149da-120">Lembre-se dos requisitos e considerações a seguir:</span><span class="sxs-lookup"><span data-stu-id="149da-120">Be aware of the following requirements and considerations:</span></span>  
  
-   <span data-ttu-id="149da-121">Se o primário contiver mais de um banco de dados de publicação, envie os logs de todos os bancos de dados de publicação ao mesmo secundário.</span><span class="sxs-lookup"><span data-stu-id="149da-121">If a primary contains more than one publication database, log ship all of the publication databases to the same secondary.</span></span>  
  
-   <span data-ttu-id="149da-122">O caminho de instalação da instância do servidor secundário deve ser igual ao do primário.</span><span class="sxs-lookup"><span data-stu-id="149da-122">The installation path for the secondary server instance must be the same as the primary.</span></span> <span data-ttu-id="149da-123">Os locais do banco de dados do usuário no servidor secundário devem ser iguais aos do primário.</span><span class="sxs-lookup"><span data-stu-id="149da-123">User database locations on the secondary server must be the same as on the primary.</span></span>  
  
-   <span data-ttu-id="149da-124">Faça o backup da chave mestra de serviço no primário.</span><span class="sxs-lookup"><span data-stu-id="149da-124">Back up the service master key at the primary.</span></span> <span data-ttu-id="149da-125">Essa chave será restaurada no secundário.</span><span class="sxs-lookup"><span data-stu-id="149da-125">This key will be restored at the secondary.</span></span> <span data-ttu-id="149da-126">Para obter mais informações, consulte [BACKUP SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-service-master-key-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="149da-126">For more information, see [BACKUP SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-service-master-key-transact-sql).</span></span>  
  
-   <span data-ttu-id="149da-127">O envio de logs não oferece garantia contra a perda de dados.</span><span class="sxs-lookup"><span data-stu-id="149da-127">Log shipping does not guarantee against data loss.</span></span> <span data-ttu-id="149da-128">Uma falha no banco de dados primário pode resultar na perda de dados para os quais ainda não foi feito o backup ou para backups perdidos durante a falha.</span><span class="sxs-lookup"><span data-stu-id="149da-128">A failure on the primary database can result in the loss of data that has not yet been backed up or for backups that are lost during the failure.</span></span>  
  
### <a name="log-shipping-with-transactional-replication"></a><span data-ttu-id="149da-129">Envio de logs com replicação transacional</span><span class="sxs-lookup"><span data-stu-id="149da-129">Log Shipping with Transactional Replication</span></span>  
 <span data-ttu-id="149da-130">Para replicação transacional, o comportamento do envio de logs depende da opção **sincronizar com backup** .</span><span class="sxs-lookup"><span data-stu-id="149da-130">For transactional replication, the behavior of log shipping depends on the **sync with backup** option.</span></span> <span data-ttu-id="149da-131">Essa opção pode ser definida no banco de dados de publicação e no banco de dados de distribuição; no envio de logs para o Publicador, apenas a configuração no banco de dados de publicação é relevante.</span><span class="sxs-lookup"><span data-stu-id="149da-131">This option can be set on the publication database and distribution database; in log shipping for the Publisher, only the setting on the publication database is relevant.</span></span>  
  
 <span data-ttu-id="149da-132">Definir essa opção no banco de dados de publicação assegura que as transações não serão entregues ao banco de dados de distribuição até ser realizado o backup do banco de dados de publicação.</span><span class="sxs-lookup"><span data-stu-id="149da-132">Setting this option on the publication database ensures that transactions are not delivered to the distribution database until they are backed up at the publication database.</span></span> <span data-ttu-id="149da-133">O último backup do banco de dados de publicação poderá então ser restaurado no servidor secundário sem qualquer possibilidade do banco de dados de distribuição possuir transações que o banco de dados de publicação restaurado não possua.</span><span class="sxs-lookup"><span data-stu-id="149da-133">The last publication database backup can then be restored at the secondary server without any possibility of the distribution database having transactions that the restored publication database does not have.</span></span> <span data-ttu-id="149da-134">Essa opção garante que se ocorrer failover do Publicador para o servidor secundário, será mantida a consistência entre o Publicador, o Distribuidor e os Assinantes.</span><span class="sxs-lookup"><span data-stu-id="149da-134">This option guarantees that if the Publisher fails over to a secondary server, consistency is maintained between the Publisher, Distributor, and Subscribers.</span></span> <span data-ttu-id="149da-135">A latência e a taxa de transferência serão afetadas porque as transações não poderão ser entregues ao banco de dados de distribuição até que tenha sido feito backup no Publicador. É recomendável definir essa opção no banco de dados de publicação caso o seu aplicativo possa tolerar essa latência.</span><span class="sxs-lookup"><span data-stu-id="149da-135">Latency and throughput are affected because transactions cannot be delivered to the distribution database until they have been backed up at the Publisher; if your application can tolerate this latency, we recommend that you set this option on the publication database.</span></span> <span data-ttu-id="149da-136">Se a opção **sincronizar com backup** ainda não estiver definida, os Assinantes poderão receber alterações que não estão mais incluídas no banco de dados recuperado no servidor secundário.</span><span class="sxs-lookup"><span data-stu-id="149da-136">If the **sync with backup** option is not set, Subscribers might receive changes that are no longer included in the recovered database at the secondary server.</span></span> <span data-ttu-id="149da-137">Para obter mais informações, consulte [Estratégias para fazer backup e restaurar o instantâneo e a replicação transacional](../../relational-databases/replication/transactional/transactional-replication.md).</span><span class="sxs-lookup"><span data-stu-id="149da-137">For more information, see [Strategies for Backing Up and Restoring Snapshot and Transactional Replication](../../relational-databases/replication/transactional/transactional-replication.md).</span></span>  
  
 <span data-ttu-id="149da-138">**Para configurar a replicação transacional e o envio de logs com a opção sincronizar com backup**</span><span class="sxs-lookup"><span data-stu-id="149da-138">**To configure transactional replication and log shipping with the sync with backup option**</span></span>  
  
1.  <span data-ttu-id="149da-139">Se a opção sincronizar com backup não estiver definida no banco de dados de publicação, execute `sp_replicationdboption '<publicationdatabasename>', 'sync with backup', 'true'`.</span><span class="sxs-lookup"><span data-stu-id="149da-139">If the sync with backup option is not set on the publication database, execute `sp_replicationdboption '<publicationdatabasename>', 'sync with backup', 'true'`.</span></span> <span data-ttu-id="149da-140">Para obter mais informações, consulte [sp_replicationdboption &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="149da-140">For more information, see [sp_replicationdboption &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql).</span></span>  
  
2.  <span data-ttu-id="149da-141">Configure o envio de logs para o banco de dados de publicação.</span><span class="sxs-lookup"><span data-stu-id="149da-141">Configure log shipping for the publication database.</span></span> <span data-ttu-id="149da-142">Para obter mais informações, consulte [Configurar o envio de logs &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="149da-142">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
3.  <span data-ttu-id="149da-143">Se ocorrer falha no Publicador, restaure o último log do banco de dados no servidor secundário por meio da opção KEEP_REPLICATION do RESTORE LOG.</span><span class="sxs-lookup"><span data-stu-id="149da-143">If the Publisher fails, restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="149da-144">Isso retém todas as configurações de replicação do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="149da-144">This retains all replication settings for the database.</span></span> <span data-ttu-id="149da-145">Para obter mais informações, consulte [Failover para um envio de logs secundário&#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) e [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="149da-145">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
4.  <span data-ttu-id="149da-146">Restaure o banco de dados **msdb** e os bancos de dados **mestres** do primário no secundário.</span><span class="sxs-lookup"><span data-stu-id="149da-146">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="149da-147">Para obter mais informações, consulte [Fazer backup e restaurar bancos de dados do sistema &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="149da-147">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="149da-148">Se o primário também era um Distribuidor, restaure o banco de dados de distribuição do primário no secundário.</span><span class="sxs-lookup"><span data-stu-id="149da-148">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="149da-149">Esses bancos de dados devem ser consistentes com o banco de dados de publicação no primário em termos de configuração de replicação e definições.</span><span class="sxs-lookup"><span data-stu-id="149da-149">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
5.  <span data-ttu-id="149da-150">No servidor secundário, renomeie o computador e, em seguida, renomeie a instância do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] para que corresponda ao nome do servidor primário.</span><span class="sxs-lookup"><span data-stu-id="149da-150">At the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="149da-151">Para obter informações sobre como renomear um computador, consulte a documentação do Windows.</span><span class="sxs-lookup"><span data-stu-id="149da-151">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="149da-152">Para obter informações sobre como renomear o servidor, consulte [Renomear um computador que hospeda uma instância autônoma do SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) e [Renomear uma instância do cluster de failover do SQL Server](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span><span class="sxs-lookup"><span data-stu-id="149da-152">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
6.  <span data-ttu-id="149da-153">No servidor secundário, restaure a chave mestra de serviço da qual foi feito o backup do primário.</span><span class="sxs-lookup"><span data-stu-id="149da-153">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="149da-154">Para obter mais informações, consulte [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="149da-154">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
 <span data-ttu-id="149da-155">**Para configurar a replicação transacional e envio de logs sem a opção sincronizar com backup**</span><span class="sxs-lookup"><span data-stu-id="149da-155">**To configure transactional replication and log shipping without the sync with backup option**</span></span>  
  
1.  <span data-ttu-id="149da-156">Configure o envio de logs para o banco de dados de publicação.</span><span class="sxs-lookup"><span data-stu-id="149da-156">Configure log shipping for the publication database.</span></span> <span data-ttu-id="149da-157">Para obter mais informações, consulte [Configurar o envio de logs &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="149da-157">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="149da-158">Se ocorrer falha no Publicador, restaure o último log do banco de dados no servidor secundário por meio da opção KEEP_REPLICATION do RESTORE LOG.</span><span class="sxs-lookup"><span data-stu-id="149da-158">If the Publisher fails, restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="149da-159">Isso retém todas as configurações de replicação do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="149da-159">This retains all replication settings for the database.</span></span> <span data-ttu-id="149da-160">Para obter mais informações, consulte [Failover para um envio de logs secundário&#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) e [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="149da-160">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
3.  <span data-ttu-id="149da-161">Restaure o banco de dados **msdb** e os bancos de dados **mestres** do primário no secundário.</span><span class="sxs-lookup"><span data-stu-id="149da-161">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="149da-162">Para obter mais informações, consulte [Fazer backup e restaurar bancos de dados do sistema &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="149da-162">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="149da-163">Se o primário também era um Distribuidor, restaure o banco de dados de distribuição do primário no secundário.</span><span class="sxs-lookup"><span data-stu-id="149da-163">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="149da-164">Esses bancos de dados devem ser consistentes com o banco de dados de publicação no primário em termos de configuração de replicação e definições.</span><span class="sxs-lookup"><span data-stu-id="149da-164">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
4.  <span data-ttu-id="149da-165">No servidor secundário, renomeie o computador e, em seguida, renomeie a instância do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] para que corresponda ao nome do servidor primário.</span><span class="sxs-lookup"><span data-stu-id="149da-165">At the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="149da-166">Para obter informações sobre como renomear um computador, consulte a documentação do Windows.</span><span class="sxs-lookup"><span data-stu-id="149da-166">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="149da-167">Para obter informações sobre como renomear o servidor, consulte [Renomear um computador que hospeda uma instância autônoma do SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) e [Renomear uma instância do cluster de failover do SQL Server](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span><span class="sxs-lookup"><span data-stu-id="149da-167">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
     <span data-ttu-id="149da-168">Você poderá receber uma mensagem de erro do Log Reader Agent informando que o banco de dados de publicação e o banco de dados de distribuição não estão sincronizados.</span><span class="sxs-lookup"><span data-stu-id="149da-168">You might receive an error message from the Log Reader Agent that the publication database and the distribution database are not synchronized.</span></span>  
  
5.  <span data-ttu-id="149da-169">No servidor secundário, restaure a chave mestra de serviço da qual foi feito o backup do primário.</span><span class="sxs-lookup"><span data-stu-id="149da-169">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="149da-170">Para obter mais informações, consulte [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="149da-170">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
6.  <span data-ttu-id="149da-171">Execute **sp_replrestart**.</span><span class="sxs-lookup"><span data-stu-id="149da-171">Execute **sp_replrestart**.</span></span> <span data-ttu-id="149da-172">Esse procedimento armazenado pode ser usado para forçar o Log Reader Agent a ignorar todas as transações replicadas anteriormente no log do banco de dados de publicação.</span><span class="sxs-lookup"><span data-stu-id="149da-172">This stored procedure can be used to force the Log Reader Agent to ignore all the previous replicated transactions in the publication database log.</span></span> <span data-ttu-id="149da-173">As transações aplicadas depois da conclusão do procedimento armazenado serão processadas pelo Log Reader Agent.</span><span class="sxs-lookup"><span data-stu-id="149da-173">Transactions applied after the completion of the stored procedure are processed by the Log Reader Agent.</span></span> <span data-ttu-id="149da-174">Para obter mais informações, consulte [sp_replrestart &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="149da-174">For more information, see [sp_replrestart &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql).</span></span>  
  
7.  <span data-ttu-id="149da-175">Reinicie o Log Reader Agent depois que o procedimento armazenado for executado com êxito.</span><span class="sxs-lookup"><span data-stu-id="149da-175">Restart the Log Reader Agent after the stored procedure executes successfully.</span></span> <span data-ttu-id="149da-176">Para obter mais informações, consulte [Iniciar e interromper um agente de replicação &#40;SQL Server Management Studio&#41;](../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md).</span><span class="sxs-lookup"><span data-stu-id="149da-176">For more information, see [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md).</span></span>  
  
8.  <span data-ttu-id="149da-177">As transações que já foram distribuídas ao Assinante podem ser aplicadas no Publicador.</span><span class="sxs-lookup"><span data-stu-id="149da-177">Transactions that have already been distributed to Subscriber might be applied at the Publisher.</span></span> <span data-ttu-id="149da-178">Para garantir que o Agente de Distribuição não tenha uma falha com um erro ao tentar aplicar novamente essas transações a um Assinante, especifique o perfil do agente intitulado **Continuar em caso de erros de consistência de dados**.</span><span class="sxs-lookup"><span data-stu-id="149da-178">To ensure that the Distribution Agent does not fail with an error when attempting to reapply these transactions at a Subscriber, specify the agent profile titled **Continue On Data Consistency Errors**.</span></span>  
  
### <a name="log-shipping-with-merge-replication"></a><span data-ttu-id="149da-179">Envio de logs com replicação de mesclagem</span><span class="sxs-lookup"><span data-stu-id="149da-179">Log Shipping with Merge Replication</span></span>  
 <span data-ttu-id="149da-180">Siga as etapas do procedimento a seguir para configurar a replicação de mesclagem e envio de logs.</span><span class="sxs-lookup"><span data-stu-id="149da-180">Follow the steps in the procedure below to configure merge replication and log shipping.</span></span>  
  
 <span data-ttu-id="149da-181">**Para configurar a replicação de mesclagem e envio de logs**</span><span class="sxs-lookup"><span data-stu-id="149da-181">**To configure merge replication and log shipping**</span></span>  
  
1.  <span data-ttu-id="149da-182">Configure o envio de logs para o banco de dados de publicação.</span><span class="sxs-lookup"><span data-stu-id="149da-182">Configure log shipping for the publication database.</span></span> <span data-ttu-id="149da-183">Para obter mais informações, consulte [Configurar o envio de logs &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="149da-183">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="149da-184">Se ocorrer falha no Publicador, no servidor secundário, renomeie o computador e, em seguida, renomeie a instância do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] para que corresponda ao nome do servidor primário.</span><span class="sxs-lookup"><span data-stu-id="149da-184">If the Publisher fails, at the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="149da-185">Para obter informações sobre como renomear um computador, consulte a documentação do Windows.</span><span class="sxs-lookup"><span data-stu-id="149da-185">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="149da-186">Para obter informações sobre como renomear o servidor, consulte [Renomear um computador que hospeda uma instância autônoma do SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) e [Renomear uma instância do cluster de failover do SQL Server](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span><span class="sxs-lookup"><span data-stu-id="149da-186">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
3.  <span data-ttu-id="149da-187">Restaure o último log do banco de dados no servidor secundário por meio da opção KEEP_REPLICATION do RESTORE LOG.</span><span class="sxs-lookup"><span data-stu-id="149da-187">Restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="149da-188">Isso retém todas as configurações de replicação do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="149da-188">This retains all replication settings for the database.</span></span> <span data-ttu-id="149da-189">Para obter mais informações, consulte [Failover para um envio de logs secundário&#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) e [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="149da-189">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
4.  <span data-ttu-id="149da-190">Restaure o banco de dados **msdb** e os bancos de dados **mestres** do primário no secundário.</span><span class="sxs-lookup"><span data-stu-id="149da-190">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="149da-191">Para obter mais informações, consulte [Fazer backup e restaurar bancos de dados do sistema &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="149da-191">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="149da-192">Se o primário também era um Distribuidor, restaure o banco de dados de distribuição do primário no secundário.</span><span class="sxs-lookup"><span data-stu-id="149da-192">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="149da-193">Esses bancos de dados devem ser consistentes com o banco de dados de publicação no primário em termos de configuração de replicação e definições.</span><span class="sxs-lookup"><span data-stu-id="149da-193">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
5.  <span data-ttu-id="149da-194">No servidor secundário, restaure a chave mestra de serviço da qual foi feito o backup do primário.</span><span class="sxs-lookup"><span data-stu-id="149da-194">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="149da-195">Para obter mais informações, consulte [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="149da-195">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
6.  <span data-ttu-id="149da-196">Sincronize o banco de dados de publicação com um ou mais bancos de dados de assinatura.</span><span class="sxs-lookup"><span data-stu-id="149da-196">Synchronize the publication database with one or more subscription databases.</span></span> <span data-ttu-id="149da-197">Isso permite que você carregue as alterações feitas anteriormente no banco de dados de publicação, mas que não estão representadas no backup restaurado.</span><span class="sxs-lookup"><span data-stu-id="149da-197">This allows you to upload those changes made previously in the publication database, but not represented in the restored backup.</span></span> <span data-ttu-id="149da-198">Os dados que podem ser carregados dependem do modo como uma publicação é filtrada:</span><span class="sxs-lookup"><span data-stu-id="149da-198">The data that can be uploaded depends on the way in which a publication is filtered:</span></span>  
  
    -   <span data-ttu-id="149da-199">Se a publicação não for filtrada, você deverá conseguir atualizar o banco de dados de publicação com uma sincronização com o Assinante mais atualizado.</span><span class="sxs-lookup"><span data-stu-id="149da-199">If the publication is not filtered, you should be able to bring the publication database up-to-date by synchronizing with the most up-to-date Subscriber.</span></span>  
  
    -   <span data-ttu-id="149da-200">Se a publicação for filtrada, talvez você possa atualizar o banco de dados de publicação.</span><span class="sxs-lookup"><span data-stu-id="149da-200">If the publication is filtered, you might not be able to bring the publication database up-to-date.</span></span> <span data-ttu-id="149da-201">Considere uma tabela particionada, de modo que cada assinatura receba os dados do cliente somente de uma região: Norte, Leste, Sul e Oeste.</span><span class="sxs-lookup"><span data-stu-id="149da-201">Consider a table that is partitioned such that each subscription receives customer data only for a single region: North, East, South, and West.</span></span> <span data-ttu-id="149da-202">Se existir pelo menos um Assinante para cada partição de dados, a sincronização com um Assinante para cada partição deverá atualizar o banco de dados de publicação.</span><span class="sxs-lookup"><span data-stu-id="149da-202">If there is at least one Subscriber for each partition of data, synchronizing with a Subscriber for each partition should bring the publication database up-to-date.</span></span> <span data-ttu-id="149da-203">Entretanto, se por exemplo, os dados da partição oeste, não foram replicados para nenhum Assinante, então esses dados no Publicador não poderão ser atualizados.</span><span class="sxs-lookup"><span data-stu-id="149da-203">However, if data in the West partition, for example, was not replicated to any Subscribers, this data at the Publisher cannot be brought up-to-date.</span></span> <span data-ttu-id="149da-204">Nesse caso, é recomendável reinicializar todas as assinaturas de forma que os dados no Publicador e nos Assinantes convirjam.</span><span class="sxs-lookup"><span data-stu-id="149da-204">In this case, we recommend reinitializing all subscriptions so that the data at the Publisher and Subscribers converges.</span></span> <span data-ttu-id="149da-205">Para obter mais informações, consulte [Reinicializar as assinaturas](../../relational-databases/replication/reinitialize-subscriptions.md).</span><span class="sxs-lookup"><span data-stu-id="149da-205">For more information, see [Reinitialize Subscriptions](../../relational-databases/replication/reinitialize-subscriptions.md).</span></span>  
  
     <span data-ttu-id="149da-206">Se você sincronizar com um Assinante que está executando uma versão do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] anterior à [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], a assinatura não poderá ser anônima; ela deverá ser a assinatura de um cliente ou de um servidor (referenciadas como assinaturas locais e assinaturas globais nas versões anteriores).</span><span class="sxs-lookup"><span data-stu-id="149da-206">If you synchronize with a Subscriber that is running a version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] prior to [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], the subscription cannot be anonymous; it must be a client subscription or server subscription (referred to as local subscriptions and global subscriptions in previous releases).</span></span> <span data-ttu-id="149da-207">Para obter mais informações, consulte [Sincronizar dados](../../relational-databases/replication/synchronize-data.md).</span><span class="sxs-lookup"><span data-stu-id="149da-207">For more information, see [Synchronize Data](../../relational-databases/replication/synchronize-data.md).</span></span>   
  
## <a name="see-also"></a><span data-ttu-id="149da-208">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="149da-208">See Also</span></span>  
 <span data-ttu-id="149da-209">[Replicação do SQL Server](../../relational-databases/replication/sql-server-replication.md) </span><span class="sxs-lookup"><span data-stu-id="149da-209">[SQL Server Replication](../../relational-databases/replication/sql-server-replication.md) </span></span>  
 <span data-ttu-id="149da-210">[Sobre o envio de logs &#40;SQL Server&#41;](about-log-shipping-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="149da-210">[About Log Shipping &#40;SQL Server&#41;](about-log-shipping-sql-server.md) </span></span>  
 [<span data-ttu-id="149da-211">Espelhamento e replicação de banco de dados &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="149da-211">Database Mirroring and Replication &#40;SQL Server&#41;</span></span>](../database-mirroring/database-mirroring-and-replication-sql-server.md)  
  
  
