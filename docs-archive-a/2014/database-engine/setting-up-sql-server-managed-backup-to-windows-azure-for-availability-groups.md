---
title: Configurando SQL Server Backup gerenciado para o Azure para grupos de disponibilidade | Microsoft Docs
description: Este tutorial mostra como configurar SQL Server Backup gerenciado para Microsoft Azure para bancos de dados que participam de grupos de disponibilidade Always On.
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
ms.assetid: 0c4553cd-d8e4-4691-963a-4e414cc0f1ba
author: mashamsft
ms.author: mathoma
ms.openlocfilehash: ebae9f75ac25698582b7f3e4c78c2fb773bd803e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87568770"
---
# <a name="setting-up-sql-server-managed-backup-to-azure-for-availability-groups"></a><span data-ttu-id="16442-103">Configurar o backup gerenciado do SQL Server para Azure para grupos de disponibilidade</span><span class="sxs-lookup"><span data-stu-id="16442-103">Setting up SQL Server Managed Backup to Azure for Availability Groups</span></span>
  <span data-ttu-id="16442-104">Este tópico é um tutorial sobre como configurar o [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para bancos de dados que fazem parte dos Grupos de Disponibilidade AlwaysOn.</span><span class="sxs-lookup"><span data-stu-id="16442-104">This topic is a tutorial on configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for databases participating in AlwaysOn Availability Groups.</span></span>  
  
## <a name="availability-group-configurations"></a><span data-ttu-id="16442-105">Configurações de grupo de disponibilidade</span><span class="sxs-lookup"><span data-stu-id="16442-105">Availability Group Configurations</span></span>  
 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]<span data-ttu-id="16442-106">tem suporte para bancos de dados do grupo de disponibilidade, se as réplicas estão configuradas localmente ou totalmente no Azure, ou uma implementação híbrida entre o local e em uma ou mais máquinas virtuais do Azure.</span><span class="sxs-lookup"><span data-stu-id="16442-106">is supported for Availability Group databases, whether the replicas are all configured on-premises, or entirely on Azure, or a Hybrid implementation between on-premises and on one or more Azure virtual machines.</span></span> <span data-ttu-id="16442-107">No entanto, talvez você precise considerar o seguinte para uma ou mais implementações:</span><span class="sxs-lookup"><span data-stu-id="16442-107">However you might need to consider the following for one or more implementations:</span></span>  
  
-   <span data-ttu-id="16442-108">Frequência de Backups de Log: a frequência do backup de logs aumenta com o tempo e o log.</span><span class="sxs-lookup"><span data-stu-id="16442-108">Log Backup Frequency: The frequency of log backup is both time and log growth.</span></span> <span data-ttu-id="16442-109">Por exemplo, o backup de log é feito uma vez a cada 2 horas, a menos que o espaço de log usado nesse período de duas horas seja de 5 MB ou mais.</span><span class="sxs-lookup"><span data-stu-id="16442-109">For example, the log backup is taken once every 2 hours unless the log space used within the two hour period is 5 MB or more.</span></span> <span data-ttu-id="16442-110">Isso se aplica a todas as implementações, locais, em nuvem ou Híbrida.</span><span class="sxs-lookup"><span data-stu-id="16442-110">This applies to all implementations, on-premises, cloud, or a Hybrid.</span></span>  
  
-   <span data-ttu-id="16442-111">Largura de banda de rede: isso se aplica a implementações em que as réplicas estão localizadas em locais físicos diferentes, como em uma nuvem híbrida ou em diferentes regiões do Azure em uma configuração somente em nuvem.</span><span class="sxs-lookup"><span data-stu-id="16442-111">Network Bandwidth: This applies to implementations where the replicas are located in different physical locations, like in a hybrid cloud, or across different Azure regions in a cloud only configuration.</span></span> <span data-ttu-id="16442-112">A largura de banda de rede pode afetar a latência dos secundários e se os secundários forem definidos como replicação síncrona, então isso poderá causar aumento de log no primário.</span><span class="sxs-lookup"><span data-stu-id="16442-112">The network bandwidth can affect the latency of the secondaries and if the secondaries are set to synchronous replication, then this can cause log growth on the primary.</span></span> <span data-ttu-id="16442-113">Se os secundários forem definidos para replicação síncrona, não poderão prosseguir devido à latência de rede, o que poderá resultar em perda de dados no caso de um failover na réplica secundária.</span><span class="sxs-lookup"><span data-stu-id="16442-113">If the secondaries are set to synchronous replication, the secondaries may not be able to keep up due to network latency, which can result in data loss in the event of a failover to the secondary replica.</span></span>  
  
### <a name="configuring-ss_smartbackup-for-availability-databases"></a><span data-ttu-id="16442-114">Configurando o [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para bancos de dados de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="16442-114">Configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for Availability Databases.</span></span>  
 <span data-ttu-id="16442-115">**Permissões:**</span><span class="sxs-lookup"><span data-stu-id="16442-115">**Permissions:**</span></span>  
  
-   <span data-ttu-id="16442-116">Requer associação na função de banco de dados **db_backupoperator** , com permissões **ALTER ANY Credential** e `EXECUTE` permissões em **sp_delete_backuphistory**procedimento armazenado.</span><span class="sxs-lookup"><span data-stu-id="16442-116">Requires membership in **db_backupoperator** database role, with **ALTER ANY CREDENTIAL** permissions, and `EXECUTE` permissions on **sp_delete_backuphistory**stored procedure.</span></span>  
  
-   <span data-ttu-id="16442-117">Requer permissões **SELECT** na função **smart_admin.fn_get_current_xevent_settings**.</span><span class="sxs-lookup"><span data-stu-id="16442-117">Requires **SELECT** permissions on the **smart_admin.fn_get_current_xevent_settings**function.</span></span>  
  
-   <span data-ttu-id="16442-118">Requer `EXECUTE` permissões no procedimento armazenado **smart_admin. sp_get_backup_diagnostics** .</span><span class="sxs-lookup"><span data-stu-id="16442-118">Requires `EXECUTE` permissions on the **smart_admin.sp_get_backup_diagnostics** stored procedure.</span></span> <span data-ttu-id="16442-119">Além disso, requer permissões `VIEW SERVER STATE`, pois chama internamente outros objetos do sistema que exigem essa permissão.</span><span class="sxs-lookup"><span data-stu-id="16442-119">In addition, it requires `VIEW SERVER STATE` permissions as it internally calls other system objects that require this permission.</span></span>  
  
-   <span data-ttu-id="16442-120">Requer `EXECUTE` permissões nos `smart_admin.sp_set_instance_backup` `smart_admin.sp_backup_master_switch` procedimentos armazenados e.</span><span class="sxs-lookup"><span data-stu-id="16442-120">Requires `EXECUTE` permissions on the `smart_admin.sp_set_instance_backup` and `smart_admin.sp_backup_master_switch` stored procedures.</span></span>  
  
 <span data-ttu-id="16442-121">Estas são as etapas básicas para configurar um Grupo de disponibilidade AlwaysOn com o [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span><span class="sxs-lookup"><span data-stu-id="16442-121">The following are the basic steps to setting up an AlwaysOn Availability Group with [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="16442-122">Um tutorial passo a passo detalhado será descrito mais adiante neste tópico.</span><span class="sxs-lookup"><span data-stu-id="16442-122">A detailed step-by step tutorial is described later in this topic.</span></span>  
  
1.  <span data-ttu-id="16442-123">Depois que você criar Grupo de Disponibilidade, configure a réplica de backup preferencial.</span><span class="sxs-lookup"><span data-stu-id="16442-123">Once you have created Availability Group, configure the preferred backup replica.</span></span> <span data-ttu-id="16442-124">Essa configuração para o Grupo de Disponibilidade também é usada pelo [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para determinar qual réplica deve ser usada para o backup.</span><span class="sxs-lookup"><span data-stu-id="16442-124">This setting for the Availability Group is also used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to determine which replica to use for backup.</span></span> <span data-ttu-id="16442-125">Para obter instruções passo a passo sobre como configurar a preferência de backup, consulte [Configurar o backup em réplicas de disponibilidade &#40;SQL Server&#41;](availability-groups/windows/configure-backup-on-availability-replicas-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="16442-125">For step by step instructions about how to set up the backup preference, see [Configure Backup on Availability Replicas &#40;SQL Server&#41;](availability-groups/windows/configure-backup-on-availability-replicas-sql-server.md).</span></span>  <span data-ttu-id="16442-126">Se você estiver criando um novo grupo de disponibilidade AlwaysOn, consulte [introdução com Grupos de Disponibilidade AlwaysOn &#40;SQL Server&#41;](availability-groups/windows/getting-started-with-always-on-availability-groups-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="16442-126">If you are creating a new AlwaysOn Availability Group, see [Getting Started with AlwaysOn Availability Groups &#40;SQL Server&#41;](availability-groups/windows/getting-started-with-always-on-availability-groups-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="16442-127">Configure o acesso de conexão somente leitura às réplicas secundárias.</span><span class="sxs-lookup"><span data-stu-id="16442-127">Configure read only connection access to the secondary replicas.</span></span> <span data-ttu-id="16442-128">Para obter instruções passo a passo sobre como configurar o acesso somente leitura, consulte [Configurar o acesso somente leitura em uma réplica de disponibilidade &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md)</span><span class="sxs-lookup"><span data-stu-id="16442-128">For step by step instructions about how to configure read only access, see [Configure Read-Only Access on an Availability Replica &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md)</span></span>  
  
3.  <span data-ttu-id="16442-129">Especifique a réplica de Backup.</span><span class="sxs-lookup"><span data-stu-id="16442-129">Specify Backup replica.</span></span> <span data-ttu-id="16442-130">A configuração de réplica de backup preferencial é usada pelo [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para determinar o banco de dados a ser usado para agendar backups.</span><span class="sxs-lookup"><span data-stu-id="16442-130">The preferred backup replica setting is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to determine which database to use for scheduling backups from..</span></span>  <span data-ttu-id="16442-131">Para determinar se a réplica atual é a réplica de backup preferida, use a função de [&#41;sys. fn_hadr_backup_is_preferred_replica &#40;Transact-SQL](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="16442-131">To determine whether the current replica is the preferred backup replica, use the [sys.fn_hadr_backup_is_preferred_replica  &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) function.</span></span>  
  
4.  <span data-ttu-id="16442-132">Em cada [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuração de execução de réplica para o banco de dados usando o procedimento armazenado do **administrador inteligente. sp_set_db_backup** .</span><span class="sxs-lookup"><span data-stu-id="16442-132">On each replica run [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuration for the database using the **smart-admin.sp_set_db_backup** stored procedure.</span></span>  
  
     <span data-ttu-id="16442-133">\*\* [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] comportamento após um failover:\*\* [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] continuará a funcionar e manterá cópias de backup e capacidade de recuperação após um evento de failover.</span><span class="sxs-lookup"><span data-stu-id="16442-133">**[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] behavior after a failover:** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will continue to work and maintain backup copies and recoverability after a failover event.</span></span> <span data-ttu-id="16442-134">Nenhuma ação específica é necessária depois de um failover.</span><span class="sxs-lookup"><span data-stu-id="16442-134">No specific action is required after a failover.</span></span>  
  
#### <a name="considerations-and-requirements"></a><span data-ttu-id="16442-135">Considerações e requisitos:</span><span class="sxs-lookup"><span data-stu-id="16442-135">Considerations and Requirements:</span></span>  
 <span data-ttu-id="16442-136">Configurar o [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para os bancos de dados que participam do Grupo de Disponibilidade AlwaysOn exige considerações e requisitos específicos.</span><span class="sxs-lookup"><span data-stu-id="16442-136">Configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for databases participating in AlwaysOn Availability Group requires specific considerations and requirements.</span></span> <span data-ttu-id="16442-137">Esta é uma lista de considerações e requisitos:</span><span class="sxs-lookup"><span data-stu-id="16442-137">Following is a list of considerations and requirements:</span></span>  
  
-   <span data-ttu-id="16442-138">Os parâmetros de configuração do [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] devem ser os mesmos para todos os bancos de dados em todos os nós do [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] que participam no mesmo Grupo de Disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="16442-138">The [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuration settings should be the same for all the databases on all the nodes of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] participating in the same Availability Group.</span></span> <span data-ttu-id="16442-139">Você pode obter isso definindo as mesmas configurações do [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para todas as réplicas primárias e no nível do banco de dados ou definindo as mesmas configurações padrão do [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] em todos os nós participantes dos Grupos de Disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="16442-139">You can achieve this either by setting  the same [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configurations for the primary and all the replicas at the database level, or by setting the same default [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] settings on all the nodes participating in the Availability Groups.</span></span> <span data-ttu-id="16442-140">É recomendável definir o [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] no banco de dados, pois configurar o [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] no nível do banco de dados permite isolar as configurações nos bancos de dados, e as alterações nas configurações padrão afetam todos os outros bancos de dados na instâncias.</span><span class="sxs-lookup"><span data-stu-id="16442-140">We recommend setting [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] at the database because configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] at the database level lets you isolate the settings to the databases and changes to default settings affect all other databases on the instance.</span></span>  
  
-   <span data-ttu-id="16442-141">Especifique a réplica de Backup.</span><span class="sxs-lookup"><span data-stu-id="16442-141">Specify Backup replica.</span></span> <span data-ttu-id="16442-142">A configuração da réplica de backup preferencial é usada pelo [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para agendar os backups.</span><span class="sxs-lookup"><span data-stu-id="16442-142">The preferred backup replica setting is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to schedule the backups.</span></span> <span data-ttu-id="16442-143">Para determinar se a réplica atual é a réplica de backup preferida, use a função de [&#41;sys. fn_hadr_backup_is_preferred_replica &#40;Transact-SQL](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="16442-143">To determine whether the current replica is the preferred backup replica, use the [sys.fn_hadr_backup_is_preferred_replica  &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) function.</span></span>  
  
-   <span data-ttu-id="16442-144">Se a réplica secundária estiver configurada como a réplica preferencial, ela deverá ser configurada para ter pelo menos acesso de conexão somente leitura.</span><span class="sxs-lookup"><span data-stu-id="16442-144">If the secondary replica is configured as the preferred replica, it should be configured to have at least read only connection access.</span></span> <span data-ttu-id="16442-145">Não há suporte para grupos de disponibilidade que não têm nenhum acesso de conexão com os bancos de dados secundários.</span><span class="sxs-lookup"><span data-stu-id="16442-145">Availability groups that have no connection access to secondary databases are not supported.</span></span>  <span data-ttu-id="16442-146">Para obter mais informações, consulte [Configurar o acesso somente leitura em uma réplica de disponibilidade &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="16442-146">For more information, see [Configure Read-Only Access on an Availability Replica &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md).</span></span>  
  
-   <span data-ttu-id="16442-147">Se você estiver configurando o [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] depois de configurar o Grupo de Disponibilidade, o [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] tentará copiar todos os backups existentes e os copiará no contêiner de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="16442-147">If you are configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] after you configure the Availability Group, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will attempt to copy any existing backups based and copy them over to the storage container.</span></span>  <span data-ttu-id="16442-148">Se o [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] não conseguir localizar ou acessar os backup existentes, ele agendará um backup completo do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="16442-148">If [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is unable to find or access existing backups, it will schedule a full database backup.</span></span> <span data-ttu-id="16442-149">Isso é feito especificamente para otimizar as operações de backup de bancos de dados do Grupo de Disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="16442-149">This is done specifically to optimize the backup operations for Availability Group databases.</span></span>  
  
-   <span data-ttu-id="16442-150">Talvez você queira considerar a desabilitação das configurações de nível de instância se estiver criando um novo banco de dados de disponibilidade e não pretende aplicar as configurações de nível de instância ao banco de dados</span><span class="sxs-lookup"><span data-stu-id="16442-150">You may want to consider disabling the instance level settings if you are creating a new availability database, and you don't intend to apply the instance level settings to the database</span></span>  
  
-   <span data-ttu-id="16442-151">Ao usar criptografia, use o mesmo certificado em todas as réplicas.</span><span class="sxs-lookup"><span data-stu-id="16442-151">When using encryption, use the same certificate on all the replicas.</span></span> <span data-ttu-id="16442-152">Isso facilita as operações de backup e contínuas ininterruptas no caso de um failover ou de restaurações em uma réplica diferente.</span><span class="sxs-lookup"><span data-stu-id="16442-152">This facilitates continued and uninterrupted backup operations in the event of a failover or restores to a different replica.</span></span>  
  
#### <a name="enable-and-configure-ss_smartbackup-for-an-availability-database"></a><span data-ttu-id="16442-153">Habilitar e configurar o [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para um Banco de Dados de Disponibilidade</span><span class="sxs-lookup"><span data-stu-id="16442-153">Enable and Configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for an Availability Database</span></span>  
 <span data-ttu-id="16442-154">Este tutorial descreve as etapas de habilitação e configuração do [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para um banco de dados (AGTestDB) nos computadores Node1 e Node2, seguidas pelas etapas de habilitação do monitoramento do status de integridade do [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span><span class="sxs-lookup"><span data-stu-id="16442-154">This tutorial describes the steps to enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for a database (AGTestDB) on computers Node1 and Node2, followed by steps to enable monitoring the [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] health status.</span></span>  
  
1.  <span data-ttu-id="16442-155">**Criar uma conta de armazenamento do Azure:** Os backups são armazenados no serviço de armazenamento de BLOBs do Azure.</span><span class="sxs-lookup"><span data-stu-id="16442-155">**Create an Azure storage account:** The backups are stored in the Azure Blob storage service.</span></span> <span data-ttu-id="16442-156">Você deve primeiro criar uma conta de armazenamento do Azure, se ainda não tiver uma.</span><span class="sxs-lookup"><span data-stu-id="16442-156">You must first create an Azure storage account, if you do not already have one.</span></span> <span data-ttu-id="16442-157">Para obter mais informações, consulte [criando uma conta de armazenamento do Azure](https://www.windowsazure.com/manage/services/storage/how-to-create-a-storage-account/).</span><span class="sxs-lookup"><span data-stu-id="16442-157">For more information, see [Creating an Azure Storage Account](https://www.windowsazure.com/manage/services/storage/how-to-create-a-storage-account/).</span></span> <span data-ttu-id="16442-158">Anote o nome da conta de armazenamento, as chaves de acesso e a URL da conta de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="16442-158">Make a note of the storage account name, access keys, and URL of the storage account.</span></span> <span data-ttu-id="16442-159">O nome da conta de armazenamento e as informações de chave de acesso são usados para criar uma Credencial SQL.</span><span class="sxs-lookup"><span data-stu-id="16442-159">The storage account name and access key information is used to create a SQL Credential.</span></span> <span data-ttu-id="16442-160">A Credencial do SQL é usada pelo [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] durante operações de backup para autenticação para a conta de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="16442-160">The SQL Credential is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] during backup operations to authenticate to the storage account.</span></span>  
  
2.  <span data-ttu-id="16442-161">**Criar uma credencial SQL:** Crie uma Credencial do SQL usando o nome da conta de armazenamento como a Identidade e a chave de acesso de armazenamento como a senha.</span><span class="sxs-lookup"><span data-stu-id="16442-161">**Create a SQL Credential:** Create a SQL Credential using the name of the storage account as the Identity and the storage access key as the password.</span></span>  
  
3.  <span data-ttu-id="16442-162">**Garantir que o serviço SQL Server Agent foi iniciado e está em execução:** Inicie o SQL Server Agent se ele não estiver em execução.</span><span class="sxs-lookup"><span data-stu-id="16442-162">**Ensure SQL Server Agent service is Started and Running:** Start SQL Server Agent if it is not currently running.</span></span> [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] <span data-ttu-id="16442-163">requer que o SQL Server Agent esteja em execução na instância para executar operações de backup.</span><span class="sxs-lookup"><span data-stu-id="16442-163">requires SQL Server Agent to be running on the instance to perform backup operations.</span></span>  <span data-ttu-id="16442-164">Talvez seja necessário definir o SQL Agent para ser executado automaticamente para garantir que as operações de backup ocorram regularmente.</span><span class="sxs-lookup"><span data-stu-id="16442-164">You may want to set SQL Agent to run automatically to make sure that backup operations can occur regularly.</span></span>  
  
4.  <span data-ttu-id="16442-165">**Determinar o período de retenção:** Determine o período de retenção desejado para os arquivos de backup.</span><span class="sxs-lookup"><span data-stu-id="16442-165">**Determine the retention period:** Determine the retention period that you want for the backup files.</span></span> <span data-ttu-id="16442-166">O período de retenção é especificado em dias e pode variar de 1 a 30.</span><span class="sxs-lookup"><span data-stu-id="16442-166">The retention period is specified in days and can range from 1 to 30.</span></span> <span data-ttu-id="16442-167">O período de retenção determina o tempo de recuperação do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="16442-167">The retention period determines the recoverability time frame for the database.</span></span>  
  
5.  <span data-ttu-id="16442-168">**Crie um certificado ou uma chave assimétrica a ser usada para criptografia durante o backup:** Crie o certificado no primeiro nó Node1 e, em seguida, exporte-o para um arquivo usando o [certificado de BACKUP &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-certificate-transact-sql)..</span><span class="sxs-lookup"><span data-stu-id="16442-168">**Create a Certificate or Asymmetric key to use for encryption during back up:** Create the certificate on the first node Node1, and then export it to a file using [BACKUP CERTIFICATE &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-certificate-transact-sql)..</span></span> <span data-ttu-id="16442-169">No Nó 2, crie um certificado usando o arquivo exportado do Nó 1.</span><span class="sxs-lookup"><span data-stu-id="16442-169">On Node 2, create a certificate using the file exported from Node 1 .</span></span> <span data-ttu-id="16442-170">Para obter mais informações sobre como criar um certificado a partir de um arquivo, consulte o exemplo em [criar certificado &#40;&#41;Transact-SQL ](/sql/t-sql/statements/create-certificate-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="16442-170">For more information on creating a certificate from a file, see the example in [CREATE CERTIFICATE &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-certificate-transact-sql).</span></span>  
  
6.  <span data-ttu-id="16442-171">**Habilitar e configurar o [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para AGTestDB em Node1:** inicie SQL Server Management Studio e conecte-se à instância no Node1 em que o banco de dados de disponibilidade está instalado.</span><span class="sxs-lookup"><span data-stu-id="16442-171">**Enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for AGTestDB on Node1:** Start SQL Server Management Studio  and connect to the instance on Node1 where the availability database  is installed.</span></span> <span data-ttu-id="16442-172">Na janela de consulta, execute a seguinte instrução após modificar os valores do nome do banco de dados, a URL de armazenamento, a Credencial SQL e o período de retenção de acordo com seus requisitos:</span><span class="sxs-lookup"><span data-stu-id="16442-172">From the query window run the following statement after you modify the values for the database name, storage URL, SQL Credential and retention period per your requirements:</span></span>  
  
    ```sql  
    Use msdb;  
    GO  
    EXEC smart_admin.sp_set_db_backup   
                    @database_name='AGTestDB'   
                    ,@retention_days=30   
                    ,@credential_name='MyCredential'  
                    ,@encryption_algorithm ='AES_128'  
                    ,@encryptor_type= 'Certificate'  
                    ,@encryptor_name='MyBackupCert'  
                    ,@enable_backup=1;  
    GO  
    ```  
  
     <span data-ttu-id="16442-173">Para obter mais informações sobre como criar um certificado para criptografia, consulte a etapa **criar um certificado de backup** em [criar um backup criptografado](../relational-databases/backup-restore/create-an-encrypted-backup.md).</span><span class="sxs-lookup"><span data-stu-id="16442-173">For more information on creating a certificate for encryption, see the **Create a Backup Certificate** step in [Create an Encrypted Backup](../relational-databases/backup-restore/create-an-encrypted-backup.md).</span></span>  
  
7.  <span data-ttu-id="16442-174">**Habilitar e configurar o [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para AGTestDB em NODE2:** inicie SQL Server Management Studio e conecte-se à instância no NODE2 em que o banco de dados de disponibilidade está instalado.</span><span class="sxs-lookup"><span data-stu-id="16442-174">**Enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for AGTestDB on Node2:** Start SQL Server Management Studio and connect to the instance on Node2 where the availability database  is installed.</span></span> <span data-ttu-id="16442-175">Na janela de consulta, execute a seguinte instrução após modificar os valores do nome do banco de dados, a URL de armazenamento, a Credencial SQL e o período de retenção de acordo com seus requisitos:</span><span class="sxs-lookup"><span data-stu-id="16442-175">From the query window run the following statement after you modify the values for the database name, storage URL, SQL Credential and retention period per your requirements:</span></span>  
  
    ```sql  
    Use msdb;  
    GO  
    EXEC smart_admin.sp_set_db_backup   
                    @database_name='AGTestDB'   
                    ,@retention_days=30   
                    ,@credential_name='MyCredential'  
                    ,@encryption_algorithm ='AES_128'  
                    ,@encryptor_type= 'Certificate'  
                    ,@encryptor_name='MyBackupCert'  
                    ,@enable_backup=1;  
    GO  
    ```  
  
     [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] <span data-ttu-id="16442-176">está habilitado no banco de dados que você especificou.</span><span class="sxs-lookup"><span data-stu-id="16442-176">is now enabled on the database you specified.</span></span> <span data-ttu-id="16442-177">Podem ser necessários até 15 minutos para que as operações de backup no banco de dados comecem a ser executadas.</span><span class="sxs-lookup"><span data-stu-id="16442-177">It may take up to 15 minutes for the backup operations on the database to start to run.</span></span> <span data-ttu-id="16442-178">O backup ocorrerá na réplica de backup preferencial.</span><span class="sxs-lookup"><span data-stu-id="16442-178">The backup will occur on the preferred backup replica.</span></span>  
  
8.  <span data-ttu-id="16442-179">**Examinar a configuração padrão do evento estendido:**  Examine a configuração do evento estendido executando a seguinte instrução Transact-SQL na réplica que [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] está usando para agendar os backups do.</span><span class="sxs-lookup"><span data-stu-id="16442-179">**Review Extended Event Default Configuration:**  Review the Extended Event configuration by running the following transact-SQL statement on the replica that [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is using to schedule the backups from.</span></span> <span data-ttu-id="16442-180">Em geral, essa é a configuração da réplica de backup preferencial para um Grupo de Disponibilidade ao qual o banco de dados pertence.</span><span class="sxs-lookup"><span data-stu-id="16442-180">This is usually the preferred backup replica setting for the Availability Group that the database belongs to.</span></span>  
  
    ```sql  
    SELECT * FROM smart_admin.fn_get_current_xevent_settings(); 
    ```  
  
     <span data-ttu-id="16442-181">Você verá que os eventos de canal Admin, Operacional e Analítico estão habilitados por padrão e não podem ser desabilitados.</span><span class="sxs-lookup"><span data-stu-id="16442-181">You should see that Admin, Operational  and Analytical channel events are enabled by default and cannot be disabled.</span></span> <span data-ttu-id="16442-182">Isso deve ser suficiente para monitorar os eventos que requerem intervenção manual.</span><span class="sxs-lookup"><span data-stu-id="16442-182">This should be sufficient to monitor the events that require manual intervention.</span></span>  <span data-ttu-id="16442-183">Você pode habilitar os eventos de depuração, mas esses canais incluem eventos informativos e de depuração que usa o [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para detectar problemas e resolvê-los.</span><span class="sxs-lookup"><span data-stu-id="16442-183">You can enable the debug events, but these channels include informational and debug events that [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] uses to detect issues and solve them.</span></span> <span data-ttu-id="16442-184">Para obter mais informações, consulte [monitorar SQL Server Backup gerenciado no Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span><span class="sxs-lookup"><span data-stu-id="16442-184">For more information, see [Monitor SQL Server Managed Backup to Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span></span>  
  
9. <span data-ttu-id="16442-185">**Habilitar e configurar a notificação do status de integridade:** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] tem um procedimento armazenado que cria um trabalho de agente para enviar notificações por email sobre erros ou avisos que possam exigir atenção.</span><span class="sxs-lookup"><span data-stu-id="16442-185">**Enable and Configure Notification for Health Status:** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] has a stored procedure that creates an agent job to send out e-mail notifications of errors or warnings that may require attention.</span></span>  <span data-ttu-id="16442-186">Para receber essas notificações, você deve habilitar a execução do procedimento armazenado que cria um Trabalho do SQL Server Agent.</span><span class="sxs-lookup"><span data-stu-id="16442-186">To receive such notifications, you must enable run the stored procedure which creates a SQL Server Agent Job.</span></span> <span data-ttu-id="16442-187">As etapas a seguir descrevem o processo para habilitar e configurar notificações por email:</span><span class="sxs-lookup"><span data-stu-id="16442-187">The following steps describe the process to enable and configure e-mail notifications:</span></span>  
  
    1.  <span data-ttu-id="16442-188">Configure o Database Mail se ele ainda não estiver habilitado na instância.</span><span class="sxs-lookup"><span data-stu-id="16442-188">Setup Database Mail if it is not already enabled on the instance.</span></span> <span data-ttu-id="16442-189">Para obter mais informações, consulte [Configure Database Mail](../relational-databases/database-mail/configure-database-mail.md).</span><span class="sxs-lookup"><span data-stu-id="16442-189">For more information, see [Configure Database Mail](../relational-databases/database-mail/configure-database-mail.md).</span></span>  
  
    2.  <span data-ttu-id="16442-190">Configure o SQL Server Agent Notification para usar o Database Mail.</span><span class="sxs-lookup"><span data-stu-id="16442-190">Configure SQL Server Agent Notification to use Database Mail.</span></span> <span data-ttu-id="16442-191">Para obter mais informações, consulte [Configurar o SQL Server Agent Mail para usar o Database Mail](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md).</span><span class="sxs-lookup"><span data-stu-id="16442-191">For more information, see [Configure SQL Server Agent Mail to Use Database Mail](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md).</span></span>  
  
    3.  <span data-ttu-id="16442-192">**Habilitar notificações por email para receber avisos e erros de backup:** Na janela de consulta, execute as seguintes instruções Transact-SQL:</span><span class="sxs-lookup"><span data-stu-id="16442-192">**Enable e-mail notifications to receive backup errors and warnings:** From the query window, run the following Transact-SQL statements:</span></span>  
  
        ```sql  
        EXEC msdb.smart_admin.sp_set_parameter  
        @parameter_name = 'SSMBackup2WANotificationEmailIds',  
        @parameter_value = '<email>'  
        ```  
  
         <span data-ttu-id="16442-193">Para obter mais informações e um script de exemplo completo, consulte [monitorar SQL Server Backup gerenciado no Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span><span class="sxs-lookup"><span data-stu-id="16442-193">For more information and a full sample script see [Monitor SQL Server Managed Backup to Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span></span>  
  
10. <span data-ttu-id="16442-194">**Exibir arquivos de backup na conta de armazenamento do Azure:** Conecte-se à conta de armazenamento de SQL Server Management Studio ou Portal de Gerenciamento do Azure.</span><span class="sxs-lookup"><span data-stu-id="16442-194">**View backup files in the Azure Storage Account:** Connect to the storage account from SQL Server Management Studio or the Azure Management Portal.</span></span> <span data-ttu-id="16442-195">Você verá um contêiner para a instância do SQL Server que hospeda o banco de dados que configurou para usar o [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span><span class="sxs-lookup"><span data-stu-id="16442-195">You will see a container for the instance of SQL Server that hosts the database you configured to use [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="16442-196">Você também poderá consultar um banco de dados e um backup de log 15 minutos depois de habilitar o [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] para o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="16442-196">You may also see a database and a log backup within 15 minutes of enabling [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the database.</span></span>  
  
11. <span data-ttu-id="16442-197">**Monitorar o Status de Integridade:**  Realize o monitoramento por meio das notificações por email configuradas anteriormente ou monitore de forma ativa os eventos registrados em log.</span><span class="sxs-lookup"><span data-stu-id="16442-197">**Monitor the Health Status:**  You can monitor through e-mail notifications you configured previously, or actively monitor the events logged.</span></span> <span data-ttu-id="16442-198">Estes são alguns exemplos de instruções Transact-SQL usados para exibir os eventos:</span><span class="sxs-lookup"><span data-stu-id="16442-198">The following are some example Transact-SQL Statements used to view the events:</span></span>  
  
    ```sql  
    --  view all admin events  
    Use msdb;  
    Go  
    DECLARE @startofweek datetime  
    DECLARE @endofweek datetime  
    SET @startofweek = DATEADD(Day, 1-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)   
    SET @endofweek = DATEADD(Day, 7-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)  
  
    DECLARE @eventresult TABLE  
    (event_type nvarchar(512),  
    event varchar (512),  
    timestamp datetime  
    )  
  
    INSERT INTO @eventresult  
  
    EXEC smart_admin.sp_get_backup_diagnostics @begin_time = @startofweek, @end_time = @endofweek  
  
    SELECT * from @eventresult  
    WHERE event_type LIKE '%admin%'  
    ```  
  
    ```sql  
    -- to enable debug events  
    Use msdb;  
    Go  
    EXEC smart_admin.sp_set_parameter 'FileRetentionDebugXevent', 'True'  
    ```  
  
    ```sql  
    --  View all events in the current week  
    Use msdb;  
    Go  
    DECLARE @startofweek datetime  
    DECLARE @endofweek datetime  
    SET @startofweek = DATEADD(Day, 1-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)   
    SET @endofweek = DATEADD(Day, 7-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)  
  
    EXEC smart_admin.sp_get_backup_diagnostics @begin_time = @startofweek, @end_time = @endofweek;  
    ```  
  
 <span data-ttu-id="16442-199">As etapas descritas nesta seção destinam-se especificamente à configuração do [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] pela primeira vez no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="16442-199">The steps described in this section are specifically for configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the first time on the database.</span></span> <span data-ttu-id="16442-200">Você pode modificar as configurações existentes usando o mesmo procedimento armazenado do sistema **smart_admin.sp_set_db_backup** e fornecer os novos valores.</span><span class="sxs-lookup"><span data-stu-id="16442-200">You can modify the existing configurations using the same system stored procedure **smart_admin.sp_set_db_backup** and provide the new values.</span></span> <span data-ttu-id="16442-201">Para obter mais informações, consulte [SQL Server Backup gerenciado para o Azure – configurações de retenção e armazenamento](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-retention-and-storage-settings.md).</span><span class="sxs-lookup"><span data-stu-id="16442-201">For more information, see [SQL Server Managed Backup to Azure - Retention and Storage Settings](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-retention-and-storage-settings.md).</span></span>  
  
### <a name="considerations-when-removing-a-database-from-alwayson-availability-group-configuration"></a><span data-ttu-id="16442-202">Considerações ao remover um banco de dados de configuração do Grupo de Disponibilidade AlwaysOn</span><span class="sxs-lookup"><span data-stu-id="16442-202">Considerations when Removing a Database from AlwaysOn Availability Group Configuration</span></span>  
 <span data-ttu-id="16442-203">Se um banco de dados for removido da configuração do grupo de disponibilidade AlwaysOn e agora for um banco de dados autônomo, recomendamos fazer backup usando [smart_admin. sp_backup_on_demand &#40;&#41;do Transact-SQL ](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="16442-203">If a database is removed from the AlwaysOn Availability Group configuration and is now a stand-alone database, we recommend doing backup using [smart_admin.sp_backup_on_demand &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql).</span></span> <span data-ttu-id="16442-204">Quando você cria um backup de banco de dados dessa maneira, ele estabelece uma nova cadeia de backup, e o arquivo será colocado no contêiner específico da instância, e não no contêiner de disponibilidade do contêiner em que os backups foram armazenados quando o banco de dados fazia parte do Grupo de Disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="16442-204">When you create a database backup  this way, it establishes  a new backup chain and the file will be placed in the instance specific container as opposed to Availability container where the backups were stored when the database was part of Availability Group.</span></span>  
  
> [!WARNING]  
>  <span data-ttu-id="16442-205">A capacidade de recuperação do banco de dados nesse cenário, desde os backups anteriores até a alteração do status do Grupo de Disponibilidade, não é garantida.</span><span class="sxs-lookup"><span data-stu-id="16442-205">The recoverability of the database in this scenario from backups previous to the change in the Availability Group status is not guaranteed.</span></span>  
  
