---
title: Configurar o backup em réplicas de disponibilidade (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/14/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- backup priority
- backup on secondary replicas
- Availability Groups [SQL Server], availability replicas
- Availability Groups [SQL Server], backup on secondary replicas
- active secondary replicas [SQL Server], backup on
- automated backup preference
- Availability Groups [SQL Server], active secondary replicas
ms.assetid: 74bc40bb-9f57-44e4-8988-1d69c0585eb6
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 91a781d957eb2f5a81d323fc3c65c93e34945c12
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87685300"
---
# <a name="configure-backup-on-availability-replicas-sql-server"></a><span data-ttu-id="c23b3-102">Configurar backup em réplicas de disponibilidade (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="c23b3-102">Configure Backup on Availability Replicas (SQL Server)</span></span>
  <span data-ttu-id="c23b3-103">Este tópico descreve como configurar o backup em réplicas secundárias de um grupo de disponibilidade AlwaysOn usando o [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)], o [!INCLUDE[tsql](../../../includes/tsql-md.md)]ou o PowerShell no [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="c23b3-103">This topic describes how to configure backup on secondary replicas for an AlwaysOn availability group by using [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)], [!INCLUDE[tsql](../../../includes/tsql-md.md)], or PowerShell in [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)].</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c23b3-104">Para obter uma introdução ao backup em réplicas secundárias, consulte secundários [ativos: backup em réplicas secundárias (grupos de disponibilidade AlwaysOn)](active-secondaries-backup-on-secondary-replicas-always-on-availability-groups.md).</span><span class="sxs-lookup"><span data-stu-id="c23b3-104">For an introduction to backup on secondary replicas, see [Active Secondaries: Backup on Secondary Replicas (AlwaysOn Availability Groups)](active-secondaries-backup-on-secondary-replicas-always-on-availability-groups.md).</span></span>  
  
 
  

  
##  <a name="before-you-begin"></a><a name="BeforeYouBegin"></a> <span data-ttu-id="c23b3-105">Antes de começar</span><span class="sxs-lookup"><span data-stu-id="c23b3-105">Before You Begin</span></span>  
  
###  <a name="prerequisites"></a><a name="Prerequisites"></a> <span data-ttu-id="c23b3-106">Pré-requisitos</span><span class="sxs-lookup"><span data-stu-id="c23b3-106">Prerequisites</span></span>  
 <span data-ttu-id="c23b3-107">Você deve estar conectado à instância do servidor que hospeda a réplica primária.</span><span class="sxs-lookup"><span data-stu-id="c23b3-107">You must be connected to the server instance that hosts the primary replica.</span></span>  
  
###  <a name="security"></a><a name="Security"></a> <span data-ttu-id="c23b3-108">Segurança</span><span class="sxs-lookup"><span data-stu-id="c23b3-108">Security</span></span>  
  
####  <a name="permissions"></a><a name="Permissions"></a> <span data-ttu-id="c23b3-109">Permissões</span><span class="sxs-lookup"><span data-stu-id="c23b3-109">Permissions</span></span>  
  
|<span data-ttu-id="c23b3-110">Tarefa</span><span class="sxs-lookup"><span data-stu-id="c23b3-110">Task</span></span>|<span data-ttu-id="c23b3-111">Permissões</span><span class="sxs-lookup"><span data-stu-id="c23b3-111">Permissions</span></span>|  
|----------|-----------------|  
|<span data-ttu-id="c23b3-112">Para configurar o backup em réplicas secundárias ao criar um grupo de disponibilidade</span><span class="sxs-lookup"><span data-stu-id="c23b3-112">To configure backup on secondary replicas when creating an availability group</span></span>|<span data-ttu-id="c23b3-113">Requer a associação na função de servidor fixa **sysadmin** e a permissão de servidor CREATE AVAILABILITY GROUP, a permissão ALTER ANY AVAILABILITY GROUP ou a permissão CONTROL SERVER.</span><span class="sxs-lookup"><span data-stu-id="c23b3-113">Requires membership in the **sysadmin** fixed server role and either CREATE AVAILABILITY GROUP server permission, ALTER ANY AVAILABILITY GROUP permission, or CONTROL SERVER permission.</span></span>|  
|<span data-ttu-id="c23b3-114">Para modificar um grupo de disponibilidade ou uma réplica de disponibilidade</span><span class="sxs-lookup"><span data-stu-id="c23b3-114">To modify an availability group or availability replica</span></span>|<span data-ttu-id="c23b3-115">Requer a permissão ALTER AVAILABILITY GROUP no grupo de disponibilidade, a permissão CONTROL AVAILABILITY GROUP, a permissão ALTER ANY AVAILABILITY GROUP ou a permissão CONTROL SERVER.</span><span class="sxs-lookup"><span data-stu-id="c23b3-115">Requires ALTER AVAILABILITY GROUP permission on the availability group, CONTROL AVAILABILITY GROUP permission, ALTER ANY AVAILABILITY GROUP permission, or CONTROL SERVER permission.</span></span>|  
  
##  <a name="using-sql-server-management-studio"></a><a name="SSMSProcedure"></a> <span data-ttu-id="c23b3-116">Usando o SQL Server Management Studio</span><span class="sxs-lookup"><span data-stu-id="c23b3-116">Using SQL Server Management Studio</span></span>  
 <span data-ttu-id="c23b3-117">**Para configurar o backup em réplicas secundárias**</span><span class="sxs-lookup"><span data-stu-id="c23b3-117">**To configure backup on secondary replicas**</span></span>  
  
1.  <span data-ttu-id="c23b3-118">No Pesquisador de Objetos, conecte-se à instância do servidor que hospeda a réplica primária e clique no nome do servidor para expandir a árvore de servidores.</span><span class="sxs-lookup"><span data-stu-id="c23b3-118">In Object Explorer, connect to the server instance that hosts the primary replica, and click the server name to expand the server tree.</span></span>  
  
2.  <span data-ttu-id="c23b3-119">Expanda os nós **Alta Disponibilidade AlwaysOn** e **Grupos de Disponibilidade** .</span><span class="sxs-lookup"><span data-stu-id="c23b3-119">Expand the **AlwaysOn High Availability** node and the **Availability Groups** node.</span></span>  
  
3.  <span data-ttu-id="c23b3-120">Clique no grupo de disponibilidade cujas preferências de backup você deseja configurar e selecione o comando **Propriedades** .</span><span class="sxs-lookup"><span data-stu-id="c23b3-120">Click the availability group whose backup preferences you want to configure, and select the **Properties** command.</span></span>  
  
4.  <span data-ttu-id="c23b3-121">Na caixa de diálogo **Propriedades de Grupo de Disponibilidade** , selecione a página **Preferências de Backup** .</span><span class="sxs-lookup"><span data-stu-id="c23b3-121">In the **Availability Group Properties** dialog box, select **Backup Preferences** page.</span></span>  
  
5.  <span data-ttu-id="c23b3-122">No painel **Onde devem ocorrer os backups?** , selecione uma destas preferências de backup automatizada para o grupo de disponibilidade:</span><span class="sxs-lookup"><span data-stu-id="c23b3-122">On the **Where should backups occur?** panel, select the automated backup preference for the availability group, one of:</span></span>  
  
     <span data-ttu-id="c23b3-123">**Preferir Secundário**</span><span class="sxs-lookup"><span data-stu-id="c23b3-123">**Prefer Secondary**</span></span>  
     <span data-ttu-id="c23b3-124">Especifica que os backups devem ocorrer em uma réplica secundária, exceto quando a réplica primária for a única réplica online.</span><span class="sxs-lookup"><span data-stu-id="c23b3-124">Specifies that backups should occur on a secondary replica except when the primary replica is the only replica online.</span></span> <span data-ttu-id="c23b3-125">Nesse caso, o backup deve ocorrer na réplica primária.</span><span class="sxs-lookup"><span data-stu-id="c23b3-125">In that case, the backup should occur on the primary replica.</span></span> <span data-ttu-id="c23b3-126">Essa é a opção padrão.</span><span class="sxs-lookup"><span data-stu-id="c23b3-126">This is the default option.</span></span>  
  
     <span data-ttu-id="c23b3-127">**Somente Secundário**</span><span class="sxs-lookup"><span data-stu-id="c23b3-127">**Secondary only**</span></span>  
     <span data-ttu-id="c23b3-128">Especifica que os backups nunca devem ser executados na réplica primária.</span><span class="sxs-lookup"><span data-stu-id="c23b3-128">Specifies that backups should never be performed on the primary replica.</span></span> <span data-ttu-id="c23b3-129">Se a réplica primária for a única réplica online, o backup não deveria ocorrer.</span><span class="sxs-lookup"><span data-stu-id="c23b3-129">If the primary replica is the only replica online, the backup should not occur.</span></span>  
  
     `Primary`  
     <span data-ttu-id="c23b3-130">Especifica que os backups sempre devem ocorrer na réplica primária.</span><span class="sxs-lookup"><span data-stu-id="c23b3-130">Specifies that the backups should always occur on the primary replica.</span></span> <span data-ttu-id="c23b3-131">Essa opção será útil se você precisar de recursos de backup, como a criação de backups diferenciais, que não têm suporte quando o backup é executado em uma réplica secundária.</span><span class="sxs-lookup"><span data-stu-id="c23b3-131">This option is useful if you need backup features, such as creating differential backups, that are not supported when backup is run on a secondary replica.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="c23b3-132">Se você pretende usar o envio de logs para preparar qualquer banco de dados secundário para um grupo de disponibilidade, defina a preferência de backup automatizada como `Primary` até que todos os bancos de dados secundários estejam preparados e associados ao grupo de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="c23b3-132">If you plan to use log shipping to prepare any secondary databases for an availability group, set the automated backup preference to `Primary` until all the secondary databases have been prepared and joined to the availability group.</span></span>  
  
     <span data-ttu-id="c23b3-133">**Qualquer Réplica**</span><span class="sxs-lookup"><span data-stu-id="c23b3-133">**Any Replica**</span></span>  
     <span data-ttu-id="c23b3-134">Especifica que você prefere que trabalhos de backup ignorem a função das réplicas de disponibilidade ao escolher a réplica para executar backups.</span><span class="sxs-lookup"><span data-stu-id="c23b3-134">Specifies that you prefer that backup jobs ignore the role of the availability replicas when choosing the replica to perform backups.</span></span> <span data-ttu-id="c23b3-135">Observe que os trabalhos de backup podem avaliar outros fatores, como prioridade de backup de cada réplica de disponibilidade em combinação com seu estado operacional e estado conectado.</span><span class="sxs-lookup"><span data-stu-id="c23b3-135">Note backup jobs might evaluate other factors such as backup priority of each availability replica in combination with its operational state and connected state.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="c23b3-136">Não há nenhuma imposição da configuração de preferência de backup automatizado.</span><span class="sxs-lookup"><span data-stu-id="c23b3-136">There is no enforcement of the automated backup preference setting.</span></span> <span data-ttu-id="c23b3-137">A interpretação dessa preferência depende da lógica, se houver, que você usa para o script em trabalhos de backup para os bancos de dados em um determinado grupo de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="c23b3-137">The interpretation of this preference depends on the logic, if any, that you script into backup jobs for the databases in a given availability group.</span></span> <span data-ttu-id="c23b3-138">A configuração de preferência de backup automatizado não tem efeito sobre backups ad hoc.</span><span class="sxs-lookup"><span data-stu-id="c23b3-138">The automated backup preference setting has no impact on ad-hoc backups.</span></span> <span data-ttu-id="c23b3-139">Para obter mais informações, consulte [Acompanhamento: Após configurar o backup em réplicas secundárias](#FollowUp) , posteriormente neste tópico.</span><span class="sxs-lookup"><span data-stu-id="c23b3-139">For more information, see [Follow Up: After Configuring Backup on Secondary Replicas](#FollowUp) later in this topic.</span></span>  
  
6.  <span data-ttu-id="c23b3-140">Use a grade **Prioridades de backup de réplica** para alterar a prioridade de backup das réplicas de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="c23b3-140">Use the **Replica backup priorities** grid to change the backup priority of the availability replicas.</span></span> <span data-ttu-id="c23b3-141">Esta grade exibe a prioridade de backup atual de cada instância de servidor que hospeda uma réplica para o grupo de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="c23b3-141">This grid displays the current backup priority of each server instance that hosts a replica for the availability group.</span></span> <span data-ttu-id="c23b3-142">As colunas da grade são as seguintes:</span><span class="sxs-lookup"><span data-stu-id="c23b3-142">The grid columns are as follows:</span></span>  
  
     <span data-ttu-id="c23b3-143">**Instância do Servidor**</span><span class="sxs-lookup"><span data-stu-id="c23b3-143">**Server Instance**</span></span>  
     <span data-ttu-id="c23b3-144">O nome da instância do [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] que hospeda a réplica de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="c23b3-144">The name of the instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] that hosts the availability replica.</span></span>  
  
     <span data-ttu-id="c23b3-145">**Prioridade de Backup (Mais Baixa = 1, Mais Alta = 100)**</span><span class="sxs-lookup"><span data-stu-id="c23b3-145">**Backup Priority (Lowest=1, Highest=100)**</span></span>  
     <span data-ttu-id="c23b3-146">Especifica sua prioridade para executar backups nesta réplica em relação às outras réplicas no mesmo grupo de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="c23b3-146">Specifies your priority for performing backups on this replica relative to the other replicas in the same availability group.</span></span> <span data-ttu-id="c23b3-147">O valor é um número inteiro no intervalo de 0..100.</span><span class="sxs-lookup"><span data-stu-id="c23b3-147">The value is an integer in the range of 0..100.</span></span> <span data-ttu-id="c23b3-148">1 indica a prioridade mais baixa, e 100 indica a prioridade mais alta.</span><span class="sxs-lookup"><span data-stu-id="c23b3-148">1 indicates the lowest priority, and 100 indicates the highest priority.</span></span> <span data-ttu-id="c23b3-149">Se **Prioridade de Backup** = 1, a réplica de disponibilidade será escolhida para execução de backups apenas se nenhuma réplica de disponibilidade de prioridade mais alta estiver disponível atualmente.</span><span class="sxs-lookup"><span data-stu-id="c23b3-149">If **Backup Priority** = 1, the availability replica would be chosen for performing backups only if no higher priority availability replicas are currently available.</span></span>  
  
     <span data-ttu-id="c23b3-150">**Excluir Réplica**</span><span class="sxs-lookup"><span data-stu-id="c23b3-150">**Exclude Replica**</span></span>  
     <span data-ttu-id="c23b3-151">Selecione se desejar que esta réplica de disponibilidade nunca seja escolhida para executar backups.</span><span class="sxs-lookup"><span data-stu-id="c23b3-151">Select if you never want this availability replica to be chosen for performing backups.</span></span> <span data-ttu-id="c23b3-152">Isso é útil, por exemplo, para uma réplica de disponibilidade remota para a qual você nunca deseja que ocorra o failover de backups.</span><span class="sxs-lookup"><span data-stu-id="c23b3-152">This is useful, for example, for a remote availability replica to which you never want backups to fail over.</span></span>  
  
7.  <span data-ttu-id="c23b3-153">Para confirmar suas alterações, clique em **OK**.</span><span class="sxs-lookup"><span data-stu-id="c23b3-153">To commit your changes, click **OK**.</span></span>  
  
 <span data-ttu-id="c23b3-154">**Modos alternativos de acessar a página Preferências de Backup**</span><span class="sxs-lookup"><span data-stu-id="c23b3-154">**Alternative ways to access the Backup Preferences page**</span></span>  
  
-   [<span data-ttu-id="c23b3-155">Usar a caixa de diálogo Novo Grupo de Disponibilidade &#40;SQL Server Management Studio&#41;</span><span class="sxs-lookup"><span data-stu-id="c23b3-155">Use the New Availability Group Dialog Box &#40;SQL Server Management Studio&#41;</span></span>](use-the-new-availability-group-dialog-box-sql-server-management-studio.md)  
  
-   [<span data-ttu-id="c23b3-156">Usar o Assistente para Adicionar Réplica ao Grupo de Disponibilidade &#40;SQL Server Management Studio&#41;</span><span class="sxs-lookup"><span data-stu-id="c23b3-156">Use the Add Replica to Availability Group Wizard &#40;SQL Server Management Studio&#41;</span></span>](use-the-add-replica-to-availability-group-wizard-sql-server-management-studio.md)  
  
-   [<span data-ttu-id="c23b3-157">Usar a caixa de diálogo Novo Grupo de Disponibilidade &#40;SQL Server Management Studio&#41;</span><span class="sxs-lookup"><span data-stu-id="c23b3-157">Use the New Availability Group Dialog Box &#40;SQL Server Management Studio&#41;</span></span>](use-the-new-availability-group-dialog-box-sql-server-management-studio.md)  
  
##  <a name="using-transact-sql"></a><a name="TsqlProcedure"></a> <span data-ttu-id="c23b3-158">Usando o Transact-SQL</span><span class="sxs-lookup"><span data-stu-id="c23b3-158">Using Transact-SQL</span></span>  
 <span data-ttu-id="c23b3-159">**Para configurar o backup em réplicas secundárias**</span><span class="sxs-lookup"><span data-stu-id="c23b3-159">**To configure backup on secondary replicas**</span></span>  
  
1.  <span data-ttu-id="c23b3-160">Conecte-se à instância de servidor que hospeda a réplica primária.</span><span class="sxs-lookup"><span data-stu-id="c23b3-160">Connect to the server instance that hosts the primary replica.</span></span>  
  
2.  <span data-ttu-id="c23b3-161">Para um novo grupo de disponibilidade, use a instrução [CREATE AVAILABILITY GROUP &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-availability-group-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="c23b3-161">For a new availability group, use the [CREATE AVAILABILITY GROUP &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-availability-group-transact-sql) statement.</span></span> <span data-ttu-id="c23b3-162">Se você estiver modificando um grupo de disponibilidade existente, use a instrução [ALTER AVAILABILITY GROUP &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-availability-group-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="c23b3-162">If you are modifying an existing availability group, use the [ALTER AVAILABILITY GROUP &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-availability-group-transact-sql) statement.</span></span>  
  
##  <a name="using-powershell"></a><a name="PowerShellProcedure"></a> <span data-ttu-id="c23b3-163">Uso do PowerShell</span><span class="sxs-lookup"><span data-stu-id="c23b3-163">Using PowerShell</span></span>  

### <a name="to-configure-backup-on-secondary-replicas"></a><span data-ttu-id="c23b3-164">Para configurar o backup em réplicas secundárias</span><span class="sxs-lookup"><span data-stu-id="c23b3-164">To configure backup on secondary replicas</span></span>
  
1.  <span data-ttu-id="c23b3-165">Defina o padrão (`cd`) para a instância de servidor que hospeda a réplica primária.</span><span class="sxs-lookup"><span data-stu-id="c23b3-165">Set default (`cd`) to the server instance that hosts the primary replica.</span></span>  
  
2.  <span data-ttu-id="c23b3-166">Opcionalmente, configure a prioridade de backup de cada réplica de disponibilidade que você está adicionando ou modificando.</span><span class="sxs-lookup"><span data-stu-id="c23b3-166">Optionally, configure the backup priority of each availability replica that you are adding or modifying.</span></span> <span data-ttu-id="c23b3-167">Esta prioridade é usada pela instância de servidor que hospeda a réplica primária para decidir qual réplica deve atender uma solicitação de backup automatizado em um banco de dados no grupo de disponibilidade (a réplica com prioridade mais alta é escolhida).</span><span class="sxs-lookup"><span data-stu-id="c23b3-167">This priority is used by the server instance that hosts the primary replica to decide which replica should service an automated backup request on a database in the availability group (the replica with highest priority is chosen).</span></span> <span data-ttu-id="c23b3-168">Essa prioridade pode ser qualquer número entre 0 e 100, inclusive.</span><span class="sxs-lookup"><span data-stu-id="c23b3-168">This priority can be any number between 0 and 100, inclusive.</span></span> <span data-ttu-id="c23b3-169">Uma prioridade de 0 indica que a réplica não deve ser considerada como candidata para atender solicitações de backup.</span><span class="sxs-lookup"><span data-stu-id="c23b3-169">A priority of 0 indicates that the replica should not be considered as a candidate for servicing backup requests.</span></span>  <span data-ttu-id="c23b3-170">A configuração padrão é 50.</span><span class="sxs-lookup"><span data-stu-id="c23b3-170">The default setting is 50.</span></span>  
  
     <span data-ttu-id="c23b3-171">Ao adicionar uma réplica de disponibilidade a um grupo de disponibilidade, use o cmdlet `New-SqlAvailabilityReplica`.</span><span class="sxs-lookup"><span data-stu-id="c23b3-171">When adding an availability replica to an availability group, use the `New-SqlAvailabilityReplica` cmdlet.</span></span> <span data-ttu-id="c23b3-172">Ao modificar uma réplica de disponibilidade existente, use o cmdlet `Set-SqlAvailabilityReplica`.</span><span class="sxs-lookup"><span data-stu-id="c23b3-172">When modifying an existing availability replica, use the `Set-SqlAvailabilityReplica` cmdlet.</span></span> <span data-ttu-id="c23b3-173">Em ambos os casos, especifique o `BackupPriority` parâmetro *n* , em que *n* é um valor de 0 a 100.</span><span class="sxs-lookup"><span data-stu-id="c23b3-173">In either case, specify the `BackupPriority`*n* parameter, where *n* is a value from 0 to 100.</span></span>  
  
     <span data-ttu-id="c23b3-174">Por exemplo, o comando a seguir define a prioridade de backup da réplica de disponibilidade `MyReplica` como `60`.</span><span class="sxs-lookup"><span data-stu-id="c23b3-174">For example, the following command sets the backup priority of the availability replica `MyReplica` to `60`.</span></span>  
  
    ```powershell
    Set-SqlAvailabilityReplica -BackupPriority 60 -Path SQLSERVER:\Sql\Computer\Instance\AvailabilityGroups\MyAg\AvailabilityReplicas\MyReplica  
    ```  
  
3.  <span data-ttu-id="c23b3-175">Outra opção é configurar a preferência de backup automatizada para o grupo de disponibilidade que você está criando ou modificando.</span><span class="sxs-lookup"><span data-stu-id="c23b3-175">Optionally, configure the automated backup preference for the availability group that you are creating  or modifying.</span></span> <span data-ttu-id="c23b3-176">Esta preferência indica como um trabalho de backup deve avaliar a réplica primária ao escolher onde executar backups.</span><span class="sxs-lookup"><span data-stu-id="c23b3-176">This preference indicates how a backup job should evaluate the primary replica when choosing where to perform backups.</span></span> <span data-ttu-id="c23b3-177">A configuração padrão é preferir réplicas secundárias.</span><span class="sxs-lookup"><span data-stu-id="c23b3-177">The default setting is to prefer secondary replicas.</span></span>  
  
     <span data-ttu-id="c23b3-178">Ao criar um grupo de disponibilidade, use o cmdlet `New-SqlAvailabilityGroup`.</span><span class="sxs-lookup"><span data-stu-id="c23b3-178">When creating an availability group, use the `New-SqlAvailabilityGroup` cmdlet.</span></span> <span data-ttu-id="c23b3-179">Ao modificar um grupo de disponibilidade existente, use o cmdlet `Set-SqlAvailabilityGroup`.</span><span class="sxs-lookup"><span data-stu-id="c23b3-179">When modifying an existing availability group, use the `Set-SqlAvailabilityGroup` cmdlet.</span></span> <span data-ttu-id="c23b3-180">Nos dois casos, especifique o parâmetro `AutomatedBackupPreference`.</span><span class="sxs-lookup"><span data-stu-id="c23b3-180">In either case, specify the `AutomatedBackupPreference` parameter.</span></span>  
  
     <span data-ttu-id="c23b3-181">onde:</span><span class="sxs-lookup"><span data-stu-id="c23b3-181">where,</span></span>  
  
     `Primary`  
     <span data-ttu-id="c23b3-182">Especifica que os backups sempre devem ocorrer na réplica primária.</span><span class="sxs-lookup"><span data-stu-id="c23b3-182">Specifies that the backups should always occur on the primary replica.</span></span> <span data-ttu-id="c23b3-183">Essa opção será útil se você precisar de recursos de backup, como a criação de backups diferenciais, que não têm suporte quando o backup é executado em uma réplica secundária.</span><span class="sxs-lookup"><span data-stu-id="c23b3-183">This option is useful if you need backup features, such as creating differential backups, that are not supported when backup is run on a secondary replica.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="c23b3-184">Se você pretende usar o envio de logs para preparar qualquer banco de dados secundário para um grupo de disponibilidade, defina a preferência de backup automatizada como `Primary` até que todos os bancos de dados secundários estejam preparados e associados ao grupo de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="c23b3-184">If you plan to use log shipping to prepare any secondary databases for an availability group, set the automated backup preference to `Primary` until all the secondary databases have been prepared and joined to the availability group.</span></span>  
  
     `SecondaryOnly`  
     <span data-ttu-id="c23b3-185">Especifica que os backups nunca devem ser executados na réplica primária.</span><span class="sxs-lookup"><span data-stu-id="c23b3-185">Specifies that backups should never be performed on the primary replica.</span></span> <span data-ttu-id="c23b3-186">Se a réplica primária for a única réplica online, o backup não deveria ocorrer.</span><span class="sxs-lookup"><span data-stu-id="c23b3-186">If the primary replica is the only replica online, the backup should not occur.</span></span>  
  
     `Secondary`  
     <span data-ttu-id="c23b3-187">Especifica que os backups devem ocorrer em uma réplica secundária, exceto quando a réplica primária for a única réplica online.</span><span class="sxs-lookup"><span data-stu-id="c23b3-187">Specifies that backups should occur on a secondary replica except when the primary replica is the only replica online.</span></span> <span data-ttu-id="c23b3-188">Nesse caso, o backup deve ocorrer na réplica primária.</span><span class="sxs-lookup"><span data-stu-id="c23b3-188">In that case, the backup should occur on the primary replica.</span></span> <span data-ttu-id="c23b3-189">Esse é o comportamento padrão.</span><span class="sxs-lookup"><span data-stu-id="c23b3-189">This is the default behavior.</span></span>  
  
     `None`  
     <span data-ttu-id="c23b3-190">Especifica que você prefere que trabalhos de backup ignorem a função das réplicas de disponibilidade ao escolher a réplica para executar backups.</span><span class="sxs-lookup"><span data-stu-id="c23b3-190">Specifies that you prefer that backup jobs ignore the role of the availability replicas when choosing the replica to perform backups.</span></span> <span data-ttu-id="c23b3-191">Observe que os trabalhos de backup podem avaliar outros fatores, como prioridade de backup de cada réplica de disponibilidade em combinação com seu estado operacional e estado conectado.</span><span class="sxs-lookup"><span data-stu-id="c23b3-191">Note backup jobs might evaluate other factors such as backup priority of each availability replica in combination with its operational state and  connected state.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="c23b3-192">Não há nenhuma imposição de `AutomatedBackupPreference`.</span><span class="sxs-lookup"><span data-stu-id="c23b3-192">There is no enforcement of `AutomatedBackupPreference`.</span></span> <span data-ttu-id="c23b3-193">A interpretação dessa preferência depende da lógica, se houver, que você usa para o script em trabalhos de backup para os bancos de dados em um determinado grupo de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="c23b3-193">The interpretation of this preference depends on the logic, if any, that you script into backup jobs for the databases in a given availability group.</span></span> <span data-ttu-id="c23b3-194">A configuração de preferência de backup automatizado não tem efeito sobre backups ad hoc.</span><span class="sxs-lookup"><span data-stu-id="c23b3-194">The automated backup preference setting has no impact on ad-hoc backups.</span></span> <span data-ttu-id="c23b3-195">Para obter mais informações, consulte [Acompanhamento: Após configurar o backup em réplicas secundárias](#FollowUp) , posteriormente neste tópico.</span><span class="sxs-lookup"><span data-stu-id="c23b3-195">For more information, see [Follow Up: After Configuring Backup on Secondary Replicas](#FollowUp) later in this topic.</span></span>  
  
     <span data-ttu-id="c23b3-196">Por exemplo, o comando a seguir define a propriedade `AutomatedBackupPreference` no grupo de disponibilidade `MyAg` como `SecondaryOnly`.</span><span class="sxs-lookup"><span data-stu-id="c23b3-196">For example, the following command sets the `AutomatedBackupPreference` property on the availability group `MyAg` to `SecondaryOnly`.</span></span> <span data-ttu-id="c23b3-197">Backups automatizados de bancos de dados neste grupo de disponibilidade nunca ocorrerão na réplica primária, mas serão redirecionados à réplica secundária com a configuração de prioridade de backup mais alta.</span><span class="sxs-lookup"><span data-stu-id="c23b3-197">Automated backups of databases in this availability group will never occur on the primary replica, but will be redirected to the secondary replica with the highest backup priority setting.</span></span>  
  
    ```powershell
    Set-SqlAvailabilityGroup -Path SQLSERVER:\Sql\PrimaryServer\InstanceName\AvailabilityGroups\MyAg `  
     -AutomatedBackupPreference SecondaryOnly  
    ```  
  
> [!NOTE]  
>  <span data-ttu-id="c23b3-198">Para exibir a sintaxe de um cmdlet, use o cmdlet `Get-Help` no ambiente do [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] PowerShell.</span><span class="sxs-lookup"><span data-stu-id="c23b3-198">To view the syntax of a cmdlet, use the `Get-Help` cmdlet in the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] PowerShell environment.</span></span> <span data-ttu-id="c23b3-199">Para obter mais informações, consulte [Get Help SQL Server PowerShell](../../../powershell/sql-server-powershell.md).</span><span class="sxs-lookup"><span data-stu-id="c23b3-199">For more information, see [Get Help SQL Server PowerShell](../../../powershell/sql-server-powershell.md).</span></span>  
  
<span data-ttu-id="c23b3-200">Para configurar e usar o provedor de SQL Server PowerShell, consulte [provedor de SQL Server PowerShell](../../../powershell/sql-server-powershell-provider.md) e [obter ajuda SQL Server PowerShell](../../../powershell/sql-server-powershell.md).</span><span class="sxs-lookup"><span data-stu-id="c23b3-200">To set up and use the SQL Server PowerShell provider, see [SQL Server PowerShell Provider](../../../powershell/sql-server-powershell-provider.md) and [Get Help SQL Server PowerShell](../../../powershell/sql-server-powershell.md).</span></span>
  
##  <a name="follow-up-after-configuring-backup-on-secondary-replicas"></a><a name="FollowUp"></a><span data-ttu-id="c23b3-201">Acompanhamento: depois de configurar o backup em réplicas secundárias</span><span class="sxs-lookup"><span data-stu-id="c23b3-201">Follow Up: After Configuring Backup on Secondary Replicas</span></span>  
 <span data-ttu-id="c23b3-202">Para levar em conta a preferência de backup automatizada para um determinado grupo de disponibilidade, em cada instância de servidor que hospeda uma réplica de disponibilidade cuja prioridade de backup for maior que zero (>0), gere trabalhos de backup de script para os bancos de dados no grupo de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="c23b3-202">To take the automated backup preference into account for a given availability group, on each server instance that hosts an availability replica whose backup priority is greater than zero (>0), you need to script backup jobs for the databases in the availability group.</span></span> <span data-ttu-id="c23b3-203">Para determinar se a réplica atual é a réplica de backup preferencial, use a função [sys.fn_hadr_backup_is_preferred_replica](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) no script de backup.</span><span class="sxs-lookup"><span data-stu-id="c23b3-203">To determine whether the current replica is the preferred backup replica, use the [sys.fn_hadr_backup_is_preferred_replica](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) function in your backup script.</span></span> <span data-ttu-id="c23b3-204">Se a réplica de disponibilidade que está hospedada pela instância de servidor atual for a réplica de backup preferida, esta função retornará 1.</span><span class="sxs-lookup"><span data-stu-id="c23b3-204">If the availability replica that is hosted by the current server instance is the preferred replica for backups, this function returns 1.</span></span> <span data-ttu-id="c23b3-205">Se não, a função retornará 0.</span><span class="sxs-lookup"><span data-stu-id="c23b3-205">If not, the function returns 0.</span></span> <span data-ttu-id="c23b3-206">Ao executar um script simples em cada réplica de disponibilidade que consulte essa função, você poderá determinar qual réplica deve executar um determinado trabalho de backup.</span><span class="sxs-lookup"><span data-stu-id="c23b3-206">By running a simple script on each availability replica that queries this function, you can determine which replica should run a given backup job.</span></span> <span data-ttu-id="c23b3-207">Por exemplo, um snippet típico de um script de trabalho de backup teria a seguinte aparência:</span><span class="sxs-lookup"><span data-stu-id="c23b3-207">For example, a typical snippet of a backup-job script would look like:</span></span>  
  
```  
IF (NOT sys.fn_hadr_backup_is_preferred_replica(@DBNAME))  
BEGIN  
      Select 'This is not the preferred replica, exiting with success';  
      RETURN 0 - This is a normal, expected condition, so the script returns success  
END  
BACKUP DATABASE @DBNAME TO DISK=<disk>  
   WITH COPY_ONLY;  
```  
  
 <span data-ttu-id="c23b3-208">O script de um trabalho de backup com essa lógica permite agendar o trabalho para execução em cada réplica de disponibilidade na mesma agenda.</span><span class="sxs-lookup"><span data-stu-id="c23b3-208">Scripting a backup job with this logic enables you to schedule the job to run on every availability replica on the same schedule.</span></span> <span data-ttu-id="c23b3-209">Cada um desses trabalhos examina os mesmos dados para determinar qual trabalho deve ser executado, portanto, somente um dos trabalhos agendados realmente continuará para o estágio de backup.</span><span class="sxs-lookup"><span data-stu-id="c23b3-209">Each of these jobs looks at the same data to determine which job should run, so only one of the scheduled job actually proceeds to the backup stage.</span></span>  <span data-ttu-id="c23b3-210">No caso de um failover, nenhum dos scripts ou trabalhos precisa ser modificado.</span><span class="sxs-lookup"><span data-stu-id="c23b3-210">In the event of a failover, none of the scripts or jobs needs to be modified.</span></span> <span data-ttu-id="c23b3-211">Além disso, se você reconfigurar um grupo de disponibilidade para adicionar uma réplica de disponibilidade, o gerenciamento do trabalho de backup exigirá simplesmente copiar ou agendar o trabalho de backup.</span><span class="sxs-lookup"><span data-stu-id="c23b3-211">Also, if you reconfigure an availability group to add an availability replica, managing the backup job requires simply copying or scheduling the backup job.</span></span> <span data-ttu-id="c23b3-212">Se você remover uma réplica de disponibilidade, simplesmente exclua o trabalho de backup da instância de servidor que hospeda essa réplica.</span><span class="sxs-lookup"><span data-stu-id="c23b3-212">If you remove an availability replica, simply delete the backup job from the server instance that hosted that replica.</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="c23b3-213">Se você usar o[Assistente de Plano de Manutenção](../../../relational-databases/maintenance-plans/use-the-maintenance-plan-wizard.md)para criar determinado trabalho de backup, o trabalho incluirá automaticamente a lógica de script que chama e verifica a função **sys.fn_hadr_backup_is_preferred_replica** .</span><span class="sxs-lookup"><span data-stu-id="c23b3-213">If you use the[Maintenance Plan Wizard](../../../relational-databases/maintenance-plans/use-the-maintenance-plan-wizard.md)to create a given backup job, the job will automatically include the scripting logic that calls and checks the **sys.fn_hadr_backup_is_preferred_replica** function.</span></span> <span data-ttu-id="c23b3-214">No entanto, o trabalho de backup não retornará a mensagem "Esta não é a réplica preferida...". Crie um trabalho para cada banco de dados de disponibilidade em cada instância de servidor que hospedar uma réplica de disponibilidade para o grupo de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="c23b3-214">However, the backup job will not return the "This is not the preferred replica..." message.Be sure to create the job(s) for each availability database on every server instance that hosts an availability replica for the availability group.</span></span>  
  
##  <a name="to-obtain-information-about-backup-preference-settings"></a><a name="ForInfoAboutBuPref"></a><span data-ttu-id="c23b3-215">Para obter informações sobre as configurações de preferência de backup</span><span class="sxs-lookup"><span data-stu-id="c23b3-215">To Obtain Information About Backup Preference Settings</span></span>  
 <span data-ttu-id="c23b3-216">Os seguintes são úteis para obter informações relevantes para backup em secundário.</span><span class="sxs-lookup"><span data-stu-id="c23b3-216">The following are useful for obtaining information that is relevant for backup on secondary.</span></span>  
  
|<span data-ttu-id="c23b3-217">Exibir</span><span class="sxs-lookup"><span data-stu-id="c23b3-217">View</span></span>|<span data-ttu-id="c23b3-218">Informação</span><span class="sxs-lookup"><span data-stu-id="c23b3-218">Information</span></span>|<span data-ttu-id="c23b3-219">Colunas relevantes</span><span class="sxs-lookup"><span data-stu-id="c23b3-219">Relevant Columns</span></span>|  
|----------|-----------------|----------------------|  
|[<span data-ttu-id="c23b3-220">sys.fn_hadr_backup_is_preferred_replica</span><span class="sxs-lookup"><span data-stu-id="c23b3-220">sys.fn_hadr_backup_is_preferred_replica</span></span>](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql)|<span data-ttu-id="c23b3-221">A réplica atual é a réplica de backup preferencial?</span><span class="sxs-lookup"><span data-stu-id="c23b3-221">Is the current replica the preferred backup replica?</span></span>|<span data-ttu-id="c23b3-222">Não aplicável.</span><span class="sxs-lookup"><span data-stu-id="c23b3-222">Not applicable.</span></span>|  
|[<span data-ttu-id="c23b3-223">sys.availability_groups</span><span class="sxs-lookup"><span data-stu-id="c23b3-223">sys.availability_groups</span></span>](/sql/relational-databases/system-catalog-views/sys-availability-groups-transact-sql)|<span data-ttu-id="c23b3-224">preferência de backup automatizada</span><span class="sxs-lookup"><span data-stu-id="c23b3-224">Automated backup preference</span></span>|<span data-ttu-id="c23b3-225">**automated_backup_preference**</span><span class="sxs-lookup"><span data-stu-id="c23b3-225">**automated_backup_preference**</span></span><br /><br /> <span data-ttu-id="c23b3-226">**automated_backup_preference_desc**</span><span class="sxs-lookup"><span data-stu-id="c23b3-226">**automated_backup_preference_desc**</span></span>|  
|[<span data-ttu-id="c23b3-227">sys.availability_replicas</span><span class="sxs-lookup"><span data-stu-id="c23b3-227">sys.availability_replicas</span></span>](/sql/relational-databases/system-catalog-views/sys-availability-replicas-transact-sql)|<span data-ttu-id="c23b3-228">Prioridade de backup de determinada réplica de disponibilidade</span><span class="sxs-lookup"><span data-stu-id="c23b3-228">Backup priority of a given availability replica</span></span>|<span data-ttu-id="c23b3-229">**backup_priority**</span><span class="sxs-lookup"><span data-stu-id="c23b3-229">**backup_priority**</span></span>|  
|[<span data-ttu-id="c23b3-230">sys.dm_hadr_availability_replica_states</span><span class="sxs-lookup"><span data-stu-id="c23b3-230">sys.dm_hadr_availability_replica_states</span></span>](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-availability-replica-states-transact-sql)|<span data-ttu-id="c23b3-231">A réplica é local para a instância de servidor?</span><span class="sxs-lookup"><span data-stu-id="c23b3-231">Is replica local to the server instance?</span></span><br /><br /> <span data-ttu-id="c23b3-232">Função atual</span><span class="sxs-lookup"><span data-stu-id="c23b3-232">Current role</span></span><br /><br /> <span data-ttu-id="c23b3-233">Estado operacional</span><span class="sxs-lookup"><span data-stu-id="c23b3-233">Operational state</span></span><br /><br /> <span data-ttu-id="c23b3-234">Estado conectado</span><span class="sxs-lookup"><span data-stu-id="c23b3-234">Connected state</span></span><br /><br /> <span data-ttu-id="c23b3-235">Integridade da sincronização de uma réplicas de disponibilidade</span><span class="sxs-lookup"><span data-stu-id="c23b3-235">Synchronization health of an availability replica</span></span>|<span data-ttu-id="c23b3-236">**is_local**</span><span class="sxs-lookup"><span data-stu-id="c23b3-236">**is_local**</span></span><br /><br /> <span data-ttu-id="c23b3-237">**role**, **role_desc**</span><span class="sxs-lookup"><span data-stu-id="c23b3-237">**role**, **role_desc**</span></span><br /><br /> <span data-ttu-id="c23b3-238">**operational_state**, **operational_state_desc**</span><span class="sxs-lookup"><span data-stu-id="c23b3-238">**operational_state**, **operational_state_desc**</span></span><br /><br /> <span data-ttu-id="c23b3-239">**connected_state**, **connected_state_desc**</span><span class="sxs-lookup"><span data-stu-id="c23b3-239">**connected_state**, **connected_state_desc**</span></span><br /><br /> <span data-ttu-id="c23b3-240">**synchronization_health**, **synchronization_health_desc**</span><span class="sxs-lookup"><span data-stu-id="c23b3-240">**synchronization_health**, **synchronization_health_desc**</span></span>|  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> <span data-ttu-id="c23b3-241">Conteúdo relacionado</span><span class="sxs-lookup"><span data-stu-id="c23b3-241">Related Content</span></span>  
  
-   [<span data-ttu-id="c23b3-242">Guia de soluções AlwaysOn do Microsoft SQL Server para alta disponibilidade e recuperação de desastre</span><span class="sxs-lookup"><span data-stu-id="c23b3-242">Microsoft SQL Server AlwaysOn Solutions Guide for High Availability and Disaster Recovery</span></span>](https://go.microsoft.com/fwlink/?LinkId=227600)  
  
-   [<span data-ttu-id="c23b3-243">Blog da equipe do AlwaysOn do SQL Server: blog oficial da equipe do SQL Server AlwaysOn</span><span class="sxs-lookup"><span data-stu-id="c23b3-243">SQL Server AlwaysOn Team Blog: The official SQL Server AlwaysOn Team Blog</span></span>](https://blogs.msdn.com/b/sqlalwayson/)  
  
## <a name="see-also"></a><span data-ttu-id="c23b3-244">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="c23b3-244">See Also</span></span>  
 <span data-ttu-id="c23b3-245">[Visão geral do Grupos de Disponibilidade AlwaysOn &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="c23b3-245">[Overview of AlwaysOn Availability Groups &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span></span>  
 [<span data-ttu-id="c23b3-246">Secundárias ativas: backup em réplicas secundárias (Grupos de Disponibilidade AlwaysOn)</span><span class="sxs-lookup"><span data-stu-id="c23b3-246">Active Secondaries: Backup on Secondary Replicas (AlwaysOn Availability Groups)</span></span>](active-secondaries-backup-on-secondary-replicas-always-on-availability-groups.md) 
