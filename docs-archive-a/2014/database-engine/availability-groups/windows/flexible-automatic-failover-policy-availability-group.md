---
title: Política de failover flexível para failover automático de um grupo de disponibilidade (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- Availability Groups [SQL Server], flexible failover policy
- Availability Groups [SQL Server], failover
- flexible failover policy
- failover [SQL Server], AlwaysOn Availability Groups
ms.assetid: 8c504c7f-5c1d-4124-b697-f735ef0084f0
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: cd4dd62d8b30e2041415e0b9be5682ce4b01d1f6
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87573278"
---
# <a name="flexible-failover-policy-for-automatic-failover-of-an-availability-group-sql-server"></a><span data-ttu-id="56422-102">Política de failover flexível para failover automático de um grupo de disponibilidade (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="56422-102">Flexible Failover Policy for Automatic Failover of an Availability Group (SQL Server)</span></span>
  <span data-ttu-id="56422-103">Uma política de failover flexível fornece controle granular sobre as condições que causam [failover automático](failover-and-failover-modes-always-on-availability-groups.md) para um grupo de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="56422-103">A flexible failover policy provides granular control over the conditions that cause [automatic failover](failover-and-failover-modes-always-on-availability-groups.md) for an availability group.</span></span> <span data-ttu-id="56422-104">Ao alterar as condições de falha que disparam um failover automático e a frequência de verificações de integridade, você pode aumentar ou diminuir a probabilidade de um failover automático para oferecer suporte ao seu SLA para alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="56422-104">By changing the failure conditions that trigger an automatic failover and the frequency of health checks, you can increase or decrease the likelihood of an automatic failover to support your SLA for high availability.</span></span>  
  
 <span data-ttu-id="56422-105">A política de failover flexível de um grupo de disponibilidade é definida por seu nível da condição de falha e pelo limite de tempo limite da verificação de integridade.</span><span class="sxs-lookup"><span data-stu-id="56422-105">The flexible failover policy of an availability group is defined by its failure-condition level and health-check timeout threshold.</span></span> <span data-ttu-id="56422-106">Ao detectar que um grupo de disponibilidade excedeu seu nível de condição de falha ou seu limite de tempo limite da verificação de integridade, a DLL de recurso do grupo de disponibilidade responde ao cluster WSFC (Windows Server Failover Clustering).</span><span class="sxs-lookup"><span data-stu-id="56422-106">On detecting that an availability group has exceeded its failure condition level or its health-check timeout threshold, the availability group's resource DLL responds back to the Windows Server Failover Clustering (WSFC) cluster.</span></span> <span data-ttu-id="56422-107">O cluster WSFC inicia um failover automático para a réplica secundária.</span><span class="sxs-lookup"><span data-stu-id="56422-107">The WSFC cluster then initiates an automatic failover to the secondary replica.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="56422-108">Se um grupo de disponibilidade exceder seu limite de falha do WSFC, o cluster do WSFC não tentará um failover automático para o grupo de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="56422-108">If an availability group exceeds its WSFC failure threshold, the WSFC cluster will not attempt an automatic failover for the availability group.</span></span> <span data-ttu-id="56422-109">Além disso, o grupo de recursos do WSFC do grupo de disponibilidade permanece em um estado com falha até o administrador de cluster manualmente colocar online o grupo de recursos com falha ou o administrador de banco de dados executar um failover manual do grupo de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="56422-109">Furthermore, the WSFC resource group of the availability group remains in a failed state until either the cluster administrator manually brings the failed resource group online or the database administrator performs a manual failover of the availability group.</span></span> <span data-ttu-id="56422-110">O *limite de falha do WSFC* é definido como o número máximo de falhas com suporte para o grupo de disponibilidade durante um determinado período de tempo.</span><span class="sxs-lookup"><span data-stu-id="56422-110">The *WSFC failure threshold* is defined as the maximum number of failures supported for the availability group during a given time period.</span></span> <span data-ttu-id="56422-111">O período padrão é de seis horas e o valor padrão para o número máximo de falhas durante este período é *n*-1, em que *n* é o número de nós do WSFC.</span><span class="sxs-lookup"><span data-stu-id="56422-111">The default time period is six hours, and the default value for the maximum number of failures during this period is *n*-1, where *n* is the number of WSFC nodes.</span></span> <span data-ttu-id="56422-112">Para alterar os valores do limite de failover para um determinado grupo de disponibilidade, use o Console de Gerenciador de Failover WSFC.</span><span class="sxs-lookup"><span data-stu-id="56422-112">To change the failure-threshold values for a given availability group, use the WSFC Failover Manager Console.</span></span>  
  
  
  
##  <a name="health-check-timeout-threshold"></a><a name="HCtimeout"></a> <span data-ttu-id="56422-113">Limite do tempo limite da verificação de integridade</span><span class="sxs-lookup"><span data-stu-id="56422-113">Health-Check Timeout Threshold</span></span>  
 <span data-ttu-id="56422-114">A DLL de recurso do WSFC do grupo de disponibilidade executa uma *verificação de integridade* da réplica primária, chamando o procedimento armazenado [sp_server_diagnostics](/sql/relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql) na instância do SQL Server que hospeda a réplica primária.</span><span class="sxs-lookup"><span data-stu-id="56422-114">WSFC resource DLL of the availability group performs a *health check* of the primary replica by calling the [sp_server_diagnostics](/sql/relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql) stored procedure on the instance of SQL Server that hosts the primary replica.</span></span> <span data-ttu-id="56422-115">**sp_server_diagnostics** retorna resultados em um intervalo 1/3 em relação ao limite do tempo limite da verificação de integridade para o grupo de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="56422-115">**sp_server_diagnostics** returns results at an interval that equals 1/3 of the health-check timeout threshold for the availability group.</span></span> <span data-ttu-id="56422-116">O limite do tempo limite da verificação de integridade padrão é de 30 segundos, levando **sp_server_diagnostics** a retornar em um intervalo de 10 segundos.</span><span class="sxs-lookup"><span data-stu-id="56422-116">The default health-check timeout threshold is 30 seconds, which causes **sp_server_diagnostics** to return at a 10-second interval.</span></span> <span data-ttu-id="56422-117">Se **sp_server_diagnostics** for lento ou não estiver retornando informações, a DLL de recurso aguardará o intervalo completo do limite de tempo limite da verificação de integridade antes de determinar que a réplica primária não está respondendo.</span><span class="sxs-lookup"><span data-stu-id="56422-117">If **sp_server_diagnostics** is slow or is not returning information, the resource DLL will wait for the full interval of the health-check timeout threshold before determining that the primary replica is unresponsive.</span></span> <span data-ttu-id="56422-118">Se a réplica primária não estiver respondendo, um failover automático será iniciado, se tiver suporte no momento.</span><span class="sxs-lookup"><span data-stu-id="56422-118">If the primary replica is unresponsive, an automatic failover is initiated, if currently supported.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="56422-119">**sp_server_diagnostics** não realiza verificações de integridade no nível de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="56422-119">**sp_server_diagnostics** does not perform health checks at the database level.</span></span>  
  
##  <a name="failure-condition-level"></a><a name="FClevel"></a> <span data-ttu-id="56422-120">Nível da condição de falha</span><span class="sxs-lookup"><span data-stu-id="56422-120">Failure-Condition Level</span></span>  
 <span data-ttu-id="56422-121">O nível da condição de falha do grupo de disponibilidade determina se os dados de diagnóstico e as informações de integridade retornadas por **sp_server_diagnostics** garantem um failover automático.</span><span class="sxs-lookup"><span data-stu-id="56422-121">Whether the diagnostic data and health information returned by **sp_server_diagnostics** warrants an automatic failover depends on the failure-condition level of the availability group.</span></span> <span data-ttu-id="56422-122">O *nível de condição de falha* especifica as condições de falha que disparam um failover automático.</span><span class="sxs-lookup"><span data-stu-id="56422-122">The *failure-condition level* specifies what failure conditions trigger an automatic failover.</span></span> <span data-ttu-id="56422-123">Há cinco níveis da condição de falha que variam do menos restritivo (nível 1) até o mais restritivo (nível 5).</span><span class="sxs-lookup"><span data-stu-id="56422-123">There are five failure-condition levels, which range from the least restrictive (level one) to the most restrictive (level five).</span></span> <span data-ttu-id="56422-124">Um nível específico abrange todos os níveis menos restritivos.</span><span class="sxs-lookup"><span data-stu-id="56422-124">A given level encompasses the less restrictive levels.</span></span> <span data-ttu-id="56422-125">Portanto, o nível mais rígido, cinco, inclui os quatro níveis de condições menos restritivos e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="56422-125">Thus, the strictest level, five, includes the four less restrictive conditions, and so forth.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="56422-126">Bancos de dados danificados e bancos de dados suspeitos não são detectados por nenhum nível de condição de falha.</span><span class="sxs-lookup"><span data-stu-id="56422-126">Damaged databases and suspect databases are not detected by any failure-condition level.</span></span> <span data-ttu-id="56422-127">Portanto, um banco de dados que esteja danificado ou suspeito (seja devido a um problema de hardware, corrupção de dados ou outro problema) nunca dispara um failover automático.</span><span class="sxs-lookup"><span data-stu-id="56422-127">Therefore, a database that is damaged or suspect (whether due to a hardware failure, data corruption, or other issue) never triggers an automatic failover.</span></span>  
  
 <span data-ttu-id="56422-128">A tabela a seguir descreve as condições de falha que correspondem a cada nível.</span><span class="sxs-lookup"><span data-stu-id="56422-128">The following table describes the failure-conditions that corresponds to each level.</span></span>  
  
|<span data-ttu-id="56422-129">Nível</span><span class="sxs-lookup"><span data-stu-id="56422-129">Level</span></span>|<span data-ttu-id="56422-130">Condição de falha</span><span class="sxs-lookup"><span data-stu-id="56422-130">Failure Condition</span></span>|[!INCLUDE[tsql](../../../includes/tsql-md.md)] <span data-ttu-id="56422-131">Valor</span><span class="sxs-lookup"><span data-stu-id="56422-131">Value</span></span>|<span data-ttu-id="56422-132">Valor de PowerShell</span><span class="sxs-lookup"><span data-stu-id="56422-132">PowerShell Value</span></span>|  
|-----------|-----------------------|------------------------------|----------------------|  
|<span data-ttu-id="56422-133">Um</span><span class="sxs-lookup"><span data-stu-id="56422-133">One</span></span>|<span data-ttu-id="56422-134">Em servidor inativo.</span><span class="sxs-lookup"><span data-stu-id="56422-134">On server down.</span></span> <span data-ttu-id="56422-135">Este é o nível menos restritivo.</span><span class="sxs-lookup"><span data-stu-id="56422-135">This is the least restrictive level.</span></span> <span data-ttu-id="56422-136">Especifica que um failover automático é iniciado quando uma destas condições ocorre:</span><span class="sxs-lookup"><span data-stu-id="56422-136">Specifies that an automatic failover is initiated when any of the following occurs:</span></span><br /><br /> <span data-ttu-id="56422-137">O serviço [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] está inativo.</span><span class="sxs-lookup"><span data-stu-id="56422-137">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] service is down.</span></span><br /><br /> <span data-ttu-id="56422-138">A concessão do grupo de disponibilidade para conexão com o cluster WSFC expira porque nenhum ACK foi recebido da instância de servidor.</span><span class="sxs-lookup"><span data-stu-id="56422-138">The lease of the availability group for connecting to the WSFC cluster expires because no ACK is received from the server instance.</span></span> <span data-ttu-id="56422-139">Para obter mais informações, consulte [Como funciona o tempo limite de concessão de AlwaysOn do SQL Server](https://blogs.msdn.com/b/psssql/archive/2012/09/07/how-it-works-sql-server-alwayson-lease-timeout.aspx).</span><span class="sxs-lookup"><span data-stu-id="56422-139">For more information, see [How It Works: SQL Server AlwaysOn Lease Timeout](https://blogs.msdn.com/b/psssql/archive/2012/09/07/how-it-works-sql-server-alwayson-lease-timeout.aspx).</span></span>|<span data-ttu-id="56422-140">1</span><span class="sxs-lookup"><span data-stu-id="56422-140">1</span></span>|`OnServerDown`|  
|<span data-ttu-id="56422-141">Dois</span><span class="sxs-lookup"><span data-stu-id="56422-141">Two</span></span>|<span data-ttu-id="56422-142">Em servidor sem resposta.</span><span class="sxs-lookup"><span data-stu-id="56422-142">On server unresponsive.</span></span> <span data-ttu-id="56422-143">Especifica que um failover automático é iniciado quando uma destas condições ocorre:</span><span class="sxs-lookup"><span data-stu-id="56422-143">Specifies that an automatic failover is initiated when any of the following occurs:</span></span><br /><br /> <span data-ttu-id="56422-144">A instância do [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] não se conecta ao cluster e o limite de tempo limite especificado pelo usuário do grupo de disponibilidade é excedido.</span><span class="sxs-lookup"><span data-stu-id="56422-144">The instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] does not connect to cluster, and the user-specified health check timeout threshold of the availability group is exceeded.</span></span><br /><br /> <span data-ttu-id="56422-145">A réplica de disponibilidade está em estado de falha.</span><span class="sxs-lookup"><span data-stu-id="56422-145">The availability replica is in failed state.</span></span>|<span data-ttu-id="56422-146">2</span><span class="sxs-lookup"><span data-stu-id="56422-146">2</span></span>|`OnServerUnresponsive`|  
|<span data-ttu-id="56422-147">Três</span><span class="sxs-lookup"><span data-stu-id="56422-147">Three</span></span>|<span data-ttu-id="56422-148">Em erros críticos do servidor.</span><span class="sxs-lookup"><span data-stu-id="56422-148">On critical server error.</span></span> <span data-ttu-id="56422-149">Especifica que um failover automático é iniciado em erros internos críticos do [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , como spinlocks órfãos, violações do acesso de gravação graves ou muito despejo.</span><span class="sxs-lookup"><span data-stu-id="56422-149">Specifies that an automatic failover is initiated on critical [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] internal errors, such as orphaned spinlocks, serious write-access violations, or too much dumping.</span></span> <span data-ttu-id="56422-150">Este é o nível padrão.</span><span class="sxs-lookup"><span data-stu-id="56422-150">This is the default level.</span></span>|<span data-ttu-id="56422-151">3</span><span class="sxs-lookup"><span data-stu-id="56422-151">3</span></span>|`OnCriticalServerError`|  
|<span data-ttu-id="56422-152">Quatro</span><span class="sxs-lookup"><span data-stu-id="56422-152">Four</span></span>|<span data-ttu-id="56422-153">Em erros moderados do servidor.</span><span class="sxs-lookup"><span data-stu-id="56422-153">On moderate server error.</span></span> <span data-ttu-id="56422-154">Especifica que um failover automático é iniciado em caso de erros internos moderados do [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , como uma condição de memória insuficiente persistente no pool de recursos interno do [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="56422-154">Specifies that an automatic failover is initiated on moderate [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] internal errors, such as a persistent out-of-memory condition in the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] internal resource pool.</span></span>|<span data-ttu-id="56422-155">4</span><span class="sxs-lookup"><span data-stu-id="56422-155">4</span></span>|`OnModerateServerError`|  
|<span data-ttu-id="56422-156">Cinco</span><span class="sxs-lookup"><span data-stu-id="56422-156">Five</span></span>|<span data-ttu-id="56422-157">Em qualquer condição de falha qualificada.</span><span class="sxs-lookup"><span data-stu-id="56422-157">On any qualified failure conditions.</span></span> <span data-ttu-id="56422-158">Este é o nível mais restritivo.</span><span class="sxs-lookup"><span data-stu-id="56422-158">This is the most restrictive level.</span></span> <span data-ttu-id="56422-159">Especifica que um failover automático é iniciado em qualquer condição de falha qualificada, incluindo:</span><span class="sxs-lookup"><span data-stu-id="56422-159">Specifies that an automatic failover is initiated on any qualified failure conditions, including:</span></span><br /><br /> <span data-ttu-id="56422-160">Esgotamento dos threads de trabalho do SQL Engine.</span><span class="sxs-lookup"><span data-stu-id="56422-160">Exhaustion of SQL Engine worker-threads.</span></span><br /><br /> <span data-ttu-id="56422-161">Detecção de um deadlock insolúvel.</span><span class="sxs-lookup"><span data-stu-id="56422-161">Detection of an unsolvable deadlock.</span></span>|<span data-ttu-id="56422-162">5</span><span class="sxs-lookup"><span data-stu-id="56422-162">5</span></span>|`OnAnyQualifiedFailureConditions`|  
  
> [!NOTE]  
>  <span data-ttu-id="56422-163">A falta de resposta de uma instância do [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] para solicitações do cliente é irrelevante para grupos de disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="56422-163">Lack of response by an instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] to client requests is irrelevant to availability groups.</span></span>  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="56422-164">Tarefas relacionadas</span><span class="sxs-lookup"><span data-stu-id="56422-164">Related Tasks</span></span>  
 <span data-ttu-id="56422-165">**To configure automatic failover**</span><span class="sxs-lookup"><span data-stu-id="56422-165">**To configure automatic failover**</span></span>  
  
-   <span data-ttu-id="56422-166">[Alterar o modo de disponibilidade de uma réplica de disponibilidade &#40;SQL Server&#41;](change-the-availability-mode-of-an-availability-replica-sql-server.md) (o failover automático exige o modo de disponibilidade de confirmação síncrona)</span><span class="sxs-lookup"><span data-stu-id="56422-166">[Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;](change-the-availability-mode-of-an-availability-replica-sql-server.md) (automatic failover requires synchronous-commit availability mode)</span></span>  
  
-   [<span data-ttu-id="56422-167">Alterar o modo de failover de uma réplica de disponibilidade &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="56422-167">Change the Failover Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-failover-mode-of-an-availability-replica-sql-server.md)  
  
-   [<span data-ttu-id="56422-168">Configurar a política de failover flexível para controlar condições de failover automático (grupos de disponibilidade AlwaysOn)</span><span class="sxs-lookup"><span data-stu-id="56422-168">Configure the Flexible Failover Policy to Control Conditions for Automatic Failover (AlwaysOn Availability Groups)</span></span>](configure-flexible-automatic-failover-policy.md)  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> <span data-ttu-id="56422-169">Conteúdo relacionado</span><span class="sxs-lookup"><span data-stu-id="56422-169">Related Content</span></span>  
  
-   [<span data-ttu-id="56422-170">Como funciona o tempo limite de concessão de AlwaysOn do SQL Server</span><span class="sxs-lookup"><span data-stu-id="56422-170">How It Works: SQL Server AlwaysOn Lease Timeout</span></span>](https://blogs.msdn.com/b/psssql/archive/2012/09/07/how-it-works-sql-server-alwayson-lease-timeout.aspx)  
  
## <a name="see-also"></a><span data-ttu-id="56422-171">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="56422-171">See Also</span></span>  
 <span data-ttu-id="56422-172">[Visão geral do Grupos de Disponibilidade AlwaysOn &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="56422-172">[Overview of AlwaysOn Availability Groups &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span></span>  
 <span data-ttu-id="56422-173">[Modos de disponibilidade (Grupos de Disponibilidade AlwaysOn)](availability-modes-always-on-availability-groups.md) </span><span class="sxs-lookup"><span data-stu-id="56422-173">[Availability Modes (AlwaysOn Availability Groups)](availability-modes-always-on-availability-groups.md) </span></span>  
 <span data-ttu-id="56422-174">[Failover e modos de failover &#40;Grupos de Disponibilidade AlwaysOn&#41;](failover-and-failover-modes-always-on-availability-groups.md) </span><span class="sxs-lookup"><span data-stu-id="56422-174">[Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md) </span></span>  
 <span data-ttu-id="56422-175">[WSFC &#40;Windows Server Failover Clustering&#41; com o SQL Server](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="56422-175">[Windows Server Failover Clustering &#40;WSFC&#41; with SQL Server](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md) </span></span>  
 <span data-ttu-id="56422-176">[Política de failover para instâncias de cluster de failover](../../../sql-server/failover-clusters/windows/failover-policy-for-failover-cluster-instances.md) </span><span class="sxs-lookup"><span data-stu-id="56422-176">[Failover Policy for Failover Cluster Instances](../../../sql-server/failover-clusters/windows/failover-policy-for-failover-cluster-instances.md) </span></span>  
 [<span data-ttu-id="56422-177">sp_server_diagnostics &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="56422-177">sp_server_diagnostics &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql)  
  
  
