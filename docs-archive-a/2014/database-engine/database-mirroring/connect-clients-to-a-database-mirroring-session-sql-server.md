---
title: Conectar clientes a uma sessão de espelhamento de banco de dados (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- partners [SQL Server], connecting clients to
- database mirroring [SQL Server], connecting clients to
- client connections [SQL Server], database mirroring
- connections [SQL Server], database mirroring
ms.assetid: 0d5d2742-2614-43de-9ab9-864addb6299b
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 16faa8d02a22fba3e4cfa4cbe0bd6558fc140fdd
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87571580"
---
# <a name="connect-clients-to-a-database-mirroring-session-sql-server"></a><span data-ttu-id="6698b-102">Conectar clientes a uma sessão de espelhamento de banco de dados (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="6698b-102">Connect Clients to a Database Mirroring Session (SQL Server)</span></span>
  <span data-ttu-id="6698b-103">Para se conectar a uma sessão de espelhamento de banco de dados, um cliente pode usar o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client ou o .NET Framework Data Provider para o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="6698b-103">To connect to a database mirroring session, a client can use either [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client or .NET Framework Data Provider for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="6698b-104">Quando configurados para um banco de dados do [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] , esses provedores de acesso de dados dão suporte completo ao espelhamento de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="6698b-104">When configured for a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] database, these data access providers both fully support database mirroring.</span></span> <span data-ttu-id="6698b-105">Para obter informações sobre as considerações de programação para usar um banco de dados espelho, consulte [Using Database Mirroring](../../relational-databases/native-client/features/using-database-mirroring.md).</span><span class="sxs-lookup"><span data-stu-id="6698b-105">For information about programming considerations for using a mirrored database, see [Using Database Mirroring](../../relational-databases/native-client/features/using-database-mirroring.md).</span></span> <span data-ttu-id="6698b-106">Além disso, a instância de servidor principal atual deve estar disponível e o logon do cliente deve ter sido criado na instância de servidor.</span><span class="sxs-lookup"><span data-stu-id="6698b-106">In addition, the current principal server instance must be available and the login of the client must have been created on the server instance.</span></span> <span data-ttu-id="6698b-107">Para obter mais informações, consulte [Solução de problemas de usuários órfãos &#40;SQL Server&#41;](../../sql-server/failover-clusters/troubleshoot-orphaned-users-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="6698b-107">For more information, see [Troubleshoot Orphaned Users &#40;SQL Server&#41;](../../sql-server/failover-clusters/troubleshoot-orphaned-users-sql-server.md).</span></span> <span data-ttu-id="6698b-108">As conexões de cliente com uma sessão de espelhamento de banco de dados não envolvem a instância de servidor testemunha, se essa existir.</span><span class="sxs-lookup"><span data-stu-id="6698b-108">Client connections to a database mirroring session do not involve the witness server instance, if one exists.</span></span>  
  
 ##  <a name="making-the-initial-connection-to-a-database-mirroring-session"></a><a name="InitialConnection"></a> <span data-ttu-id="6698b-109">Estabelecendo a conexão inicial com uma sessão de espelhamento de banco de dados</span><span class="sxs-lookup"><span data-stu-id="6698b-109">Making the Initial Connection to a Database Mirroring Session</span></span>  
 <span data-ttu-id="6698b-110">Para a conexão inicial com um banco de dados espelho, um cliente deve fornecer uma cadeia de conexão que no mínimo forneça o nome de uma instância de servidor.</span><span class="sxs-lookup"><span data-stu-id="6698b-110">For the initial connection to a mirrored database, a client must supply a connection string that minimally supplies the name of a server instance.</span></span> <span data-ttu-id="6698b-111">Esse nome de servidor exigido deve identificar a instância do servidor principal atual e é conhecido como *nome do parceiro inicial*.</span><span class="sxs-lookup"><span data-stu-id="6698b-111">This required server name should identify the current principal server instance and is known as the *initial partner name*.</span></span>  
  
 <span data-ttu-id="6698b-112">Opcionalmente, a cadeia de conexão também pode fornecer o nome de outra instância de servidor que deverá identificar a instância do servidor espelho atual para uso, se o parceiro inicial estiver indisponível durante a primeira tentativa de conexão.</span><span class="sxs-lookup"><span data-stu-id="6698b-112">Optionally, the connection string can also supply the name of another server instance, which should identify the current mirror server instance, for use if the initial partner is unavailable during the first connection attempt.</span></span> <span data-ttu-id="6698b-113">O segundo nome é conhecido como *nome do parceiro de failover*.</span><span class="sxs-lookup"><span data-stu-id="6698b-113">The second name is known as the *failover partner name*.</span></span>  
  
 <span data-ttu-id="6698b-114">A cadeia de conexão também deve fornecer um nome de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="6698b-114">The connection string must also supply a database name.</span></span> <span data-ttu-id="6698b-115">Isso é necessário para habilitar tentativas de failover pelo provedor de acesso de dados.</span><span class="sxs-lookup"><span data-stu-id="6698b-115">This is necessary to enable failover attempts by the data access provider.</span></span>  
  
 <span data-ttu-id="6698b-116">Ao receber uma cadeia de conexão, o provedor de acesso de dados armazena o nome do parceiro inicial e o nome de parceiro de failover, se fornecido, em um cache na memória volátil do cliente (para código gerenciado, o cache é delimitado ao domínio do aplicativo).</span><span class="sxs-lookup"><span data-stu-id="6698b-116">On receiving a connection string, the data access provider stores the initial partner name and the failover partner name, if supplied, in a cache in the client's volatile memory (for managed code, the cache is scoped to the application domain).</span></span> <span data-ttu-id="6698b-117">Uma vez em cache, o nome do parceiro inicial nunca é atualizado pelo provedor de acesso de dados.</span><span class="sxs-lookup"><span data-stu-id="6698b-117">Once cached, the initial partner name is never updated by the data access provider.</span></span> <span data-ttu-id="6698b-118">Quando o cliente fornece o nome de parceiro de failover, o provedor de acesso de dados também armazena temporariamente esse nome, caso o provedor não possa se conectar usando o nome do parceiro inicial.</span><span class="sxs-lookup"><span data-stu-id="6698b-118">When the client supplies the failover partner name, the data access provider also stores this failover partner name temporarily in case the provider cannot connect using the initial partner name.</span></span>  
  
 <span data-ttu-id="6698b-119">Uma sessão de espelhamento de banco de dados não protege contra problemas de acesso ao servidor que sejam específicos dos clientes, como quando um computador cliente está tendo problemas de comunicação com a rede.</span><span class="sxs-lookup"><span data-stu-id="6698b-119">A database mirroring session does not protect against server-access problems that are specific to clients, such as when a client computer is having a problems communicating with the network.</span></span> <span data-ttu-id="6698b-120">Uma tentativa de conexão com um banco de dados espelho também pode falhar por várias razões não relacionadas ao provedor de acesso de dados; por exemplo, uma tentativa de conexão pode falhar porque a instância do servidor principal está inativa, como acontece quando o banco de dados cai ou por causa de um erro de rede.</span><span class="sxs-lookup"><span data-stu-id="6698b-120">A connection attempt to a mirrored database can also fail for a variety of reasons that are unrelated to the data-access provider; for example, a connection attempt can fail because the principal server instance is inactive, as occurs when the database is failing over, or because of a network error.</span></span>  
  
 <span data-ttu-id="6698b-121">Ao tentar se conectar, o provedor de acesso de dados começa usando o nome do parceiro inicial.</span><span class="sxs-lookup"><span data-stu-id="6698b-121">When attempting to connect, the data access provider begins by using the initial partner name.</span></span> <span data-ttu-id="6698b-122">Se a instância de servidor especificada estiver disponível e for a instância de servidor principal atual, a tentativa de conexão geralmente será bem-sucedida.</span><span class="sxs-lookup"><span data-stu-id="6698b-122">If the specified server instance is available and is the current principal server instance, the connection attempt typically succeeds.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6698b-123">Se a sessão de espelhamento for pausada, o cliente geralmente fará a conexão com o servidor principal e baixará o nome do parceiro.</span><span class="sxs-lookup"><span data-stu-id="6698b-123">If the mirroring session is paused, the client typically connects to the principal server and the downloads the partner name.</span></span> <span data-ttu-id="6698b-124">Porém, o banco de dados estará indisponível para o cliente até retomar o espelhamento.</span><span class="sxs-lookup"><span data-stu-id="6698b-124">However, the database is unavailable to the client until mirroring resumes.</span></span>  
  
 <span data-ttu-id="6698b-125">Se essa tentativa não funcionar, o provedor de acesso de dados tentará o nome do parceiro de failover, se disponível.</span><span class="sxs-lookup"><span data-stu-id="6698b-125">If that attempt does not work, the data access provider tries the failover partner name, if available.</span></span> <span data-ttu-id="6698b-126">Se um dos nomes de parceiro identificar o servidor principal atual corretamente, o provedor de acesso de dados em geral terá êxito em abrir a conexão inicial.</span><span class="sxs-lookup"><span data-stu-id="6698b-126">If either partner name correctly identifies the current principal server, the data access provider normally succeeds in opening the initial connection.</span></span> <span data-ttu-id="6698b-127">Na conclusão dessa conexão, o provedor de acesso de dados baixa o nome da instância do servidor do servidor espelho atual.</span><span class="sxs-lookup"><span data-stu-id="6698b-127">On completing this connection, the data access provider downloads the server instance name of the current mirror server.</span></span> <span data-ttu-id="6698b-128">Esse nome é armazenado no cache como o nome do parceiro de failover, substituindo o nome do parceiro de failover fornecido pelo cliente, se houver.</span><span class="sxs-lookup"><span data-stu-id="6698b-128">This name is stored in the cache as the failover partner name, overwriting the client-supplied failover partner name, if any.</span></span> <span data-ttu-id="6698b-129">Depois disso, o provedor de dados .NET Framework para o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] não atualiza o nome do parceiro de failover.</span><span class="sxs-lookup"><span data-stu-id="6698b-129">Thereafter, the .NET Framework Data Provider for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] does not update the failover partner name.</span></span> <span data-ttu-id="6698b-130">Em contraste, o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client atualiza o cache sempre que uma conexão subsequente ou redefinição de conexão retorna um nome de parceiro diferente.</span><span class="sxs-lookup"><span data-stu-id="6698b-130">In contrast, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client updates the cache whenever a subsequent connection or connection reset returns a different partner name.</span></span>  
  
 <span data-ttu-id="6698b-131">A figura a seguir ilustra uma conexão de cliente com o parceiro inicial, **Partner_A**, para um banco de dados espelho denominado **Db_1**.</span><span class="sxs-lookup"><span data-stu-id="6698b-131">The following figure illustrates a client connection to the initial partner, **Partner_A**, for a mirrored database named **Db_1**.</span></span> <span data-ttu-id="6698b-132">Esta figura mostra um caso em que o nome do parceiro inicial fornecido pelo cliente identifica corretamente o servidor principal atual, **Partner_A**.</span><span class="sxs-lookup"><span data-stu-id="6698b-132">This figure shows a case in which the initial partner name supplied by the client correctly identifies the current principal server, **Partner_A**.</span></span> <span data-ttu-id="6698b-133">A tentativa de conexão inicial tem sucesso e o provedor de acesso a dados armazena o nome do servidor espelho (atualmente **Partner_B**) como o nome do parceiro de failover no cache local.</span><span class="sxs-lookup"><span data-stu-id="6698b-133">The initial connection attempt succeeds, and the data access provider stores the name of the mirror server (currently **Partner_B**) as the failover partner name in the local cache.</span></span> <span data-ttu-id="6698b-134">Finalmente, o cliente se conecta à cópia principal do banco de dados **Db_1** .</span><span class="sxs-lookup"><span data-stu-id="6698b-134">Finally, the client connects to the principal copy of the **Db_1** database.</span></span>  
  
 <span data-ttu-id="6698b-135">![Conexão de cliente se o parceiro inicial for o principal](../media/dbm-initial-connection.gif "Conexão de cliente se o parceiro inicial for o principal")</span><span class="sxs-lookup"><span data-stu-id="6698b-135">![Client connection if initial partner is principal](../media/dbm-initial-connection.gif "Client connection if initial partner is principal")</span></span>  
  
 <span data-ttu-id="6698b-136">A tentativa de conexão inicial pode falhar, por exemplo, por causa de um erro de rede ou uma instância de servidor inativa.</span><span class="sxs-lookup"><span data-stu-id="6698b-136">The initial connection attempt may fail, for example, because of a network error or an inactive server instance.</span></span> <span data-ttu-id="6698b-137">Como o parceiro inicial está indisponível, para que o provedor de acesso de dados tente se conectar ao parceiro de failover, o cliente deve ter fornecido o nome do parceiro de failover na cadeia de conexão.</span><span class="sxs-lookup"><span data-stu-id="6698b-137">Because the initial partner is unavailable, for the data access provider to attempt to connect to the failover partner, the client must have supplied the failover partner name in the connection string.</span></span>  
  
 <span data-ttu-id="6698b-138">Nesse caso, se o nome do parceiro de failover estiver indisponível, a tentativa de conexão original continuará até o tempo limite de conexão de rede ou um erro seja retornado (da mesma maneira que para um banco de dados não espelhado).</span><span class="sxs-lookup"><span data-stu-id="6698b-138">In that case, if the failover partner name is unavailable, the original connection attempt continues until the network connection timeout or an error is returned (just as for a non-mirrored database).</span></span>  
  
 <span data-ttu-id="6698b-139">Quando o nome do parceiro de failover é fornecido na cadeia de conexão, o comportamento do provedor de acesso de dados dependerá do protocolo de rede e do sistema operacional do cliente, como segue:</span><span class="sxs-lookup"><span data-stu-id="6698b-139">When the failover partner name is supplied in the connection string, the behavior of the data access provider depends on the network protocol and operating system of the client, as follows:</span></span>  
  
-   <span data-ttu-id="6698b-140">Para TCP/IP, as tentativas de conexão são governadas por um algoritmo de nova tentativa de conexão específico ao espelhamento de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="6698b-140">For TCP/IP, the connection attempts are regulated by a connection retry algorithm that is specific to database mirroring.</span></span> <span data-ttu-id="6698b-141">O *algoritmo de nova tentativa de conexão* determina o tempo máximo (o *tempo de nova tentativa*) designado para abrir uma conexão em uma determinada tentativa de conexão.</span><span class="sxs-lookup"><span data-stu-id="6698b-141">The *connection retry algorithm* determines the maximum time (the *retry time*) allotted for opening a connection in a given connection attempt.</span></span>  
  
-   <span data-ttu-id="6698b-142">Para outros protocolos de rede</span><span class="sxs-lookup"><span data-stu-id="6698b-142">For other network protocols</span></span>  
  
     <span data-ttu-id="6698b-143">Se um erro ocorrer ou se o parceiro inicial estiver indisponível, a tentativa inicial de conexão aguardará até o fim do tempo limite para conexão na rede ou para logon, no provedor de acesso de dados.</span><span class="sxs-lookup"><span data-stu-id="6698b-143">If an error occurs or if the initial partner is unavailable, the initial connection attempt waits until the network connection timeout period expires or the login timeout period expires on the data access provider.</span></span> <span data-ttu-id="6698b-144">Geralmente, essa espera é de 20 a 30 segundos.</span><span class="sxs-lookup"><span data-stu-id="6698b-144">Typically, this wait is on the order of 20 to 30 seconds.</span></span> <span data-ttu-id="6698b-145">Depois disso, se o tempo limite do provedor de acesso de dados não tiver expirado, ele tentará se conectar ao parceiro de failover.</span><span class="sxs-lookup"><span data-stu-id="6698b-145">Thereafter, if the data access provider has not timed out, it attempts to connect to the failover partner.</span></span> <span data-ttu-id="6698b-146">Se o tempo limite expirar antes que a conexão aconteça ou o parceiro de failover esteja indisponível, a tentativa de conexão falhará.</span><span class="sxs-lookup"><span data-stu-id="6698b-146">If the connection timeout period expires before the connection succeeds or the failover partner is unavailable, the connection attempt fails.</span></span> <span data-ttu-id="6698b-147">Se o parceiro de failover estiver disponível dentro do tempo limite de logon e agora for o servidor principal, a tentativa de conexão geralmente será bem-sucedida.</span><span class="sxs-lookup"><span data-stu-id="6698b-147">If failover partner is available within the login timeout period and is now the principal server, the connection attempt normally succeeds.</span></span>  

  
### <a name="connection-strings-for-a-mirrored-database"></a><span data-ttu-id="6698b-148">Cadeias de conexão para um banco de dados espelho</span><span class="sxs-lookup"><span data-stu-id="6698b-148">Connection Strings for a Mirrored Database</span></span>  
 <span data-ttu-id="6698b-149">A cadeia de conexão fornecida pelo cliente contém informações que o provedor de acesso de dados usa para se conectar ao banco de dados.</span><span class="sxs-lookup"><span data-stu-id="6698b-149">The connection string supplied by the client contains information that the data access provider uses to connect to the database.</span></span> <span data-ttu-id="6698b-150">Esta seção discute as palavras-chave especificamente relevantes para conexão com um banco de dados espelhado usando um [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client ODBC Driver Connection.</span><span class="sxs-lookup"><span data-stu-id="6698b-150">This section discusses the keywords that are specifically relevant for connecting to a mirrored database using a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client ODBC Driver Connection.</span></span>  
  
#### <a name="network-attribute"></a><span data-ttu-id="6698b-151">Atributo de rede</span><span class="sxs-lookup"><span data-stu-id="6698b-151">Network Attribute</span></span>  
 <span data-ttu-id="6698b-152">A cadeia de conexão deve conter o atributo **Network** para especificar o protocolo de rede.</span><span class="sxs-lookup"><span data-stu-id="6698b-152">The connection string should contain the **Network** attribute to specify the network protocol.</span></span> <span data-ttu-id="6698b-153">Isso assegura que o protocolo de rede especificado persista entre conexões com parceiros diferentes.</span><span class="sxs-lookup"><span data-stu-id="6698b-153">This ensures that the specified network protocol persists between connections to different partners.</span></span> <span data-ttu-id="6698b-154">O melhor protocolo por conectar a um banco de dados espelho é o TCP/IP.</span><span class="sxs-lookup"><span data-stu-id="6698b-154">The best protocol for connecting to a mirrored database is TCP/IP.</span></span> <span data-ttu-id="6698b-155">Para garantir que o cliente solicite o TCP/IP em cada conexão com os parceiros, uma cadeia de conexão fornece o seguinte atributo:</span><span class="sxs-lookup"><span data-stu-id="6698b-155">To ensure that the client requests TCP/IP for every connection to the partners, a connection string supplies the following attribute:</span></span>  
  
```  
Network=dbmssocn;   
```  
  
> [!IMPORTANT]  
>  <span data-ttu-id="6698b-156">Recomendamos manter o TCP/IP no topo da lista de protocolos de um cliente.</span><span class="sxs-lookup"><span data-stu-id="6698b-156">We recommend keeping TCP/IP at the top of a client's protocol list.</span></span> <span data-ttu-id="6698b-157">No entanto, se a cadeia de conexão especificar o atributo **Network** , isso substituirá a ordem da lista.</span><span class="sxs-lookup"><span data-stu-id="6698b-157">However, if the connection string specifies the **Network** attribute, this overrides the list order.</span></span>  
  
 <span data-ttu-id="6698b-158">Alternativamente, para garantir que o cliente solicite pipes nomeados para cada conexão com os parceiros, uma cadeia de conexão fornece o seguinte atributo:</span><span class="sxs-lookup"><span data-stu-id="6698b-158">Alternatively, to ensure that the client requests named pipes for every connection to the partners, a connection string supplies the following attribute:</span></span>  
  
```  
Network=dbnmpntw;   
```  
  
> [!IMPORTANT]  
>  <span data-ttu-id="6698b-159">Como pipes nomeados não usam o algoritmo de nova tentativa TCP/IP, em muitos casos, uma tentativa de conexão de pipes nomeados pode exceder o tempo limite antes da conexão com um banco de dados espelho.</span><span class="sxs-lookup"><span data-stu-id="6698b-159">Because named pipes does not use the TCP/IP retry algorithm, in many cases, a named pipes connection attempt may time out before connecting to a mirrored database.</span></span>  
  
#### <a name="server-attribute"></a><span data-ttu-id="6698b-160">Atributo de servidor</span><span class="sxs-lookup"><span data-stu-id="6698b-160">Server Attribute</span></span>  
 <span data-ttu-id="6698b-161">A cadeia de conexão deve conter um atributo `Server` que forneça o nome do parceiro inicial que deverá identificar a instância do servidor principal atual.</span><span class="sxs-lookup"><span data-stu-id="6698b-161">The connection string must contain a `Server` attribute that supplies the initial partner name, which should identify the current principal server instance.</span></span>  
  
 <span data-ttu-id="6698b-162">A forma mais simples de identificar a instância do servidor é especificando seu nome, *<server_name>* [ **\\** _<SQL_Server_instance_name>_ ].</span><span class="sxs-lookup"><span data-stu-id="6698b-162">The simplest way to identify the server instance is by specifying its name , *<server_name>*[**\\**_<SQL_Server_instance_name>_].</span></span> <span data-ttu-id="6698b-163">Por exemplo:</span><span class="sxs-lookup"><span data-stu-id="6698b-163">For example:</span></span>  
  
 `Server=Partner_A;`  
  
 <span data-ttu-id="6698b-164">ou</span><span class="sxs-lookup"><span data-stu-id="6698b-164">or</span></span>  
  
 `Server=Partner_A\Instance_2;`  
  
 <span data-ttu-id="6698b-165">No entanto, quando o nome do sistema for usado, o cliente deverá executar uma pesquisa DNS para obter o endereço IP do servidor e uma consulta com o SQL Server Browser para obter o número de porta do servidor em que o parceiro reside.</span><span class="sxs-lookup"><span data-stu-id="6698b-165">However, when the system name is used, the client must perform a DNS lookup to obtain the IP address of the server and a SQL Server Browser query to obtain the port number of the server on which the partner resides.</span></span> <span data-ttu-id="6698b-166">Essas pesquisas e consultas podem ser ignoradas especificando o endereço IP e o número de porta do parceiro no atributo `Server`, em vez de especificar o nome do servidor.</span><span class="sxs-lookup"><span data-stu-id="6698b-166">Those lookups and queries can be bypassed by specifying the IP address and port number of the partner in the `Server` attribute, rather than specifying the server name.</span></span> <span data-ttu-id="6698b-167">Isso é recomendado para minimizar a possibilidade de atrasos externos durante a conexão com esse parceiro.</span><span class="sxs-lookup"><span data-stu-id="6698b-167">This is recommended to minimize the possibility of external delays while connecting to that partner.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6698b-168">Uma consulta com o SQL Server Browser será necessária se a cadeia de conexão especificar o nome da instância nomeada, e não a porta.</span><span class="sxs-lookup"><span data-stu-id="6698b-168">A SQL Server Browser query is necessary if the connection string specifies the named instance name and not the port.</span></span>  
  
 <span data-ttu-id="6698b-169">Para especificar o endereço IP e a porta, o `Server` atributo usa o seguinte formulário, `Server=` *<ip_address>* `,` *\<port>* , por exemplo:</span><span class="sxs-lookup"><span data-stu-id="6698b-169">To specify the IP address and port, the `Server` attribute takes the following form, `Server=`*<ip_address>*`,`*\<port>*, for example:</span></span>  
  
```  
Server=123.34.45.56,4724;   
```  
  
> [!NOTE]  
>  <span data-ttu-id="6698b-170">O endereço IP pode ser o IP Versão 4 (IPv4) ou IP Versão 6 (IPv6).</span><span class="sxs-lookup"><span data-stu-id="6698b-170">The IP address can be IP Version 4 (IPv4) or IP Version 6 (IPv6).</span></span>  
  
#### <a name="database-attribute"></a><span data-ttu-id="6698b-171">Atributo de banco de dados</span><span class="sxs-lookup"><span data-stu-id="6698b-171">Database Attribute</span></span>  
 <span data-ttu-id="6698b-172">Além disso, a cadeia de conexão deve especificar o atributo `Database` para fornecer o nome do banco de dados espelho.</span><span class="sxs-lookup"><span data-stu-id="6698b-172">In addition, the connection string must specify the `Database` attribute to supply the name of the mirrored database.</span></span> <span data-ttu-id="6698b-173">Se o banco de dados estiver indisponível quando o cliente tentar se conectar, uma exceção é ativada.</span><span class="sxs-lookup"><span data-stu-id="6698b-173">If the database is unavailable when the client attempts to connect, an exception is raised.</span></span>  
  
 <span data-ttu-id="6698b-174">Por exemplo, para se conectar expressamente ao banco de dados **AdventureWorks** no servidor principal Partner_A, um cliente usa a seguinte cadeia de conexão:</span><span class="sxs-lookup"><span data-stu-id="6698b-174">For example, to expressly connect to the **AdventureWorks** database on the principal server Partner_A, a client uses the following connection string:</span></span>  
  
 `" Server=Partner_A; Database=AdventureWorks "`  
  
> [!NOTE]  
>  <span data-ttu-id="6698b-175">Essa cadeia de caracterse omite informações de autenticação.</span><span class="sxs-lookup"><span data-stu-id="6698b-175">This string omits authentication information.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="6698b-176">O agrupamento do prefixo de protocolo com o `Server` atributo ( `Server=tcp:` *\<servername>* ) é incompatível com o atributo **Network** , e a especificação do protocolo em ambos os locais provavelmente resultará em um erro.</span><span class="sxs-lookup"><span data-stu-id="6698b-176">Bundling the protocol prefix with the `Server` attribute (`Server=tcp:`*\<servername>*) is incompatible with the **Network** attribute, and specifying the protocol in both places will likely result in an error.</span></span> <span data-ttu-id="6698b-177">Portanto, é recomendável que uma cadeia de conexão especifique o protocolo usando o atributo **Network** e especifique apenas o nome do servidor no `Server` atributo ( `"Network=dbmssocn; Server=` *\<servername>* `"` ).</span><span class="sxs-lookup"><span data-stu-id="6698b-177">Therefore, we recommend that a connection string specify the protocol using the **Network** attribute and specify only the server name in the `Server` attribute (`"Network=dbmssocn; Server=`*\<servername>*`"`).</span></span>  
  
#### <a name="failover-partner-attribute"></a><span data-ttu-id="6698b-178">Atributo de parceiro de failover</span><span class="sxs-lookup"><span data-stu-id="6698b-178">Failover Partner Attribute</span></span>  
 <span data-ttu-id="6698b-179">Além do nome do parceiro inicial, o cliente pode especificar também o nome do parceiro de failover, que deve identificar a instância do servidor espelho atual.</span><span class="sxs-lookup"><span data-stu-id="6698b-179">In addition to the initial partner name, the client can also specify failover partner name, which should identify the current mirror server instance.</span></span> <span data-ttu-id="6698b-180">O parceiro de failover é especificado por uma das palavras-chave para o atributo do parceiro de failover.</span><span class="sxs-lookup"><span data-stu-id="6698b-180">The failover partner is specified by one of the keywords for the failover partner attribute.</span></span> <span data-ttu-id="6698b-181">A palavra-chave desse atributo depende da API em uso.</span><span class="sxs-lookup"><span data-stu-id="6698b-181">The keyword for this attribute depends on the API that you are using.</span></span> <span data-ttu-id="6698b-182">A tabela a seguir lista estas palavras-chave:</span><span class="sxs-lookup"><span data-stu-id="6698b-182">The following table lists these keywords:</span></span>  
  
|<span data-ttu-id="6698b-183">API</span><span class="sxs-lookup"><span data-stu-id="6698b-183">API</span></span>|<span data-ttu-id="6698b-184">Palavra-chave do atributo de parceiro de failover</span><span class="sxs-lookup"><span data-stu-id="6698b-184">Keyword for failover partner attribute</span></span>|  
|---------|--------------------------------------------|  
|<span data-ttu-id="6698b-185">Provedor OLE DB</span><span class="sxs-lookup"><span data-stu-id="6698b-185">OLE DB Provider</span></span>|`FailoverPartner`|  
|<span data-ttu-id="6698b-186">Driver ODBC</span><span class="sxs-lookup"><span data-stu-id="6698b-186">ODBC Driver</span></span>|`Failover_Partner`|  
|<span data-ttu-id="6698b-187">ADO ( ActiveX Data Object)</span><span class="sxs-lookup"><span data-stu-id="6698b-187">ActiveX Data Objects (ADO)</span></span>|`Failover Partner`|  
  
 <span data-ttu-id="6698b-188">A forma mais simples de identificar a instância do servidor é pelo seu nome do sistema, *<server_name>* [ **\\** _<SQL_Server_instance_name>_ ].</span><span class="sxs-lookup"><span data-stu-id="6698b-188">The simplest way to identify the server instance is by its system name, *<server_name>*[**\\**_<SQL_Server_instance_name>_].</span></span>  
  
 <span data-ttu-id="6698b-189">Alternativamente, o endereço IP e número da porta podem ser fornecidos no atributo `Failover Partner`.</span><span class="sxs-lookup"><span data-stu-id="6698b-189">Alternatively, the IP address and port number can be supplied in the `Failover Partner` attribute.</span></span> <span data-ttu-id="6698b-190">Se a tentativa de conexão inicial falhar durante a primeira conexão com o banco de dados, a tentativa para se conectar ao parceiro de failover não precisará depender do DNS e do SQL Server Browser.</span><span class="sxs-lookup"><span data-stu-id="6698b-190">If the initial connection attempt fails during the first connection to the database, the attempt to connect to the failover partner will be freed from relying on DNS and SQL Server Browser.</span></span> <span data-ttu-id="6698b-191">Quando uma conexão é estabelecida, o nome do parceiro de failover será sobrescrito com o nome do parceiro de failover, assim, se um failover acontecer, as conexões redirecionadas necessitarão do DNS e do SQL Server Browser.</span><span class="sxs-lookup"><span data-stu-id="6698b-191">Once a connection is established, the failover partner name will be overwritten with the failover partner name, so if a failover occurs, the redirected connections will require DNS and SQL Server Browser.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6698b-192">Quando só o nome do parceiro inicial é fornecido, os desenvolvedores de aplicativos não precisam tomar nenhuma ação ou gravar nenhum código, exceto sobre como se reconectar.</span><span class="sxs-lookup"><span data-stu-id="6698b-192">When only the initial partner name is provided, application developers do not need to take any action or write any code except about how to reconnect.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6698b-193">Desenvolvedores de aplicativos de código gerenciado fornecem o nome do parceiro de failover no `ConnectionString` do objeto `SqlConnection`.</span><span class="sxs-lookup"><span data-stu-id="6698b-193">Managed code application developers supply the failover partner name in the `ConnectionString` of the `SqlConnection` object.</span></span> <span data-ttu-id="6698b-194">Para obter informações sobre como usar essa cadeia de conexão, consulte “Suporte ao espelhamento de banco de dados no Provedor de Dados .NET Framework para SQL Server" na documentação ADO.NET que é parte do [!INCLUDE[msCoName](../../includes/msconame-md.md)] .NET Framework SDK.</span><span class="sxs-lookup"><span data-stu-id="6698b-194">For information on using this connection string, see "Database Mirroring Support in the .NET Framework Data Provider for SQL Server" in the ADO.NET documentation, which is part of the [!INCLUDE[msCoName](../../includes/msconame-md.md)] .NET Framework SDK.</span></span>  
  
#### <a name="example-connection-string"></a><span data-ttu-id="6698b-195">Cadeia de conexão de exemplo</span><span class="sxs-lookup"><span data-stu-id="6698b-195">Example Connection String</span></span>  
 <span data-ttu-id="6698b-196">Por exemplo, para fazer a conexão explícita com o banco de dados **AdventureWorks** usando o TCP/IP em Partner_A ou Partner_B, um aplicativo cliente que utiliza o driver ODBC pode fornecer a seguinte cadeia de conexão:</span><span class="sxs-lookup"><span data-stu-id="6698b-196">For example, to explicitly connect using TCP/IP to the **AdventureWorks** database on either Partner_A or Partner_B, a client application that uses the ODBC Driver could supply the following connection string:</span></span>  
  
```  
"Server=Partner_A; Failover_Partner=Partner_B; Database=AdventureWorks; Network=dbmssocn"  
```  
  
 <span data-ttu-id="6698b-197">Alternativamente, o cliente pode usar o endereço IP e número da porta para identificar o parceiro inicial, Partner_A; por exemplo, se o endereço IP for 250.65.43.21 e o número da porta for 4734, a cadeia de conexão será:</span><span class="sxs-lookup"><span data-stu-id="6698b-197">Alternatively, the client could use the IP address and port number to identify the initial partner, Partner_A; for example, if the IP address is 250.65.43.21 and the port number is 4734, the connection string would be:</span></span>  
  
```  
"Server=250.65.43.21,4734; Failover_Partner=Partner_B; Database=AdventureWorks; Network=dbmssocn"  
```  
  
##  <a name="connection-retry-algorithm-for-tcpip-connections"></a><a name="RetryAlgorithm"></a> <span data-ttu-id="6698b-198">Algoritmo de nova tentativa de conexão (para conexões TCP/IP)</span><span class="sxs-lookup"><span data-stu-id="6698b-198">Connection Retry Algorithm (for TCP/IP Connections)</span></span>  
 <span data-ttu-id="6698b-199">Para uma conexão TCP/IP, quando ambos os nomes de parceiro estiverem no cache, o provedor de acesso a dados aderirá a um algoritmo de nova tentativa de conexão.</span><span class="sxs-lookup"><span data-stu-id="6698b-199">For a TCP/IP connection, when both partner names are in the cache, the data access provider adheres to a connection retry algorithm.</span></span> <span data-ttu-id="6698b-200">Isto é verdade tanto para fazer a conexão inicial para a sessão como para reconectar depois de perder uma conexão estabelecida.</span><span class="sxs-lookup"><span data-stu-id="6698b-200">This is true both for making the initial connection to the session and for reconnecting after losing an established connection.</span></span> <span data-ttu-id="6698b-201">Quando uma conexão tiver sido estabelecida, completar os passos de pré-logon e logon leva tempo adicional.</span><span class="sxs-lookup"><span data-stu-id="6698b-201">Once a connection has been opened, completing the pre-login and login steps takes additional time.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6698b-202">O tempo gasto para abrir uma conexão pode exceder o tempo de retentar por causa de fatores externos, como lookups de DNS lento, controlador/Kerberos Key Distribution Center (KDC) de domínio lento, tempo gasto contatando o SQL Server Browser, congestão de rede e outros.</span><span class="sxs-lookup"><span data-stu-id="6698b-202">The time spent in opening a connection can exceed the retry time because of external factors, such as slow DNS lookups, slow domain controller/Kerberos Key Distribution Center (KDC), time spent contacting SQL Server Browser, network congestion, and so forth.</span></span> <span data-ttu-id="6698b-203">Tais fatores externos podem impedir um cliente de conectar a um banco de dados espelho.</span><span class="sxs-lookup"><span data-stu-id="6698b-203">Such external factors can prevent a client from connecting to a mirrored database.</span></span> <span data-ttu-id="6698b-204">Além disso, fatores externos podem fazer uma conexão levar mais tempo para abrir do que o tempo estimado para retentar.</span><span class="sxs-lookup"><span data-stu-id="6698b-204">Also, external factors can cause a connection to take longer to open than the allotted retry time.</span></span> <span data-ttu-id="6698b-205">Para obter informações sobre como ignorar o DNS e o SQL Server Browser para a tentativa de conexão com o parceiro inicial, consulte [Estabelecendo a conexão inicial com uma sessão de espelhamento de banco de dados](#InitialConnection)anteriormente neste tópico.</span><span class="sxs-lookup"><span data-stu-id="6698b-205">For information on bypassing DNS and SQL Server Browser for connection attempt to the initial partner, see [Making the Initial Connection to a Database Mirroring Session](#InitialConnection), earlier in this topic.</span></span>  
  
 <span data-ttu-id="6698b-206">Se uma tentativa de conexão falhar ou o tempo de nova tentativa expirar antes da conexão acontecer, o provedor de acesso de dados tentará o outro parceiro.</span><span class="sxs-lookup"><span data-stu-id="6698b-206">If a connection attempt fails or the retry time expires before it succeeds, the data access provider tries the other partner.</span></span> <span data-ttu-id="6698b-207">Se uma conexão não for aberta neste ponto, o provedor tentará alternadamente os nomes do parceiro inicial e do failover, até que uma conexão seja aberta ou o período de logon expire. O período do tempo limite de logon padrão é de 15 segundos.</span><span class="sxs-lookup"><span data-stu-id="6698b-207">If a connection is not opened by this point, the provider alternately tries the initial and failover partner names, until a connection is opened or the login period times out. The default login time-out period is 15 seconds.</span></span> <span data-ttu-id="6698b-208">Nós recomendamos que o período de tempo limite de logon seja pelo menos de 5 segundos.</span><span class="sxs-lookup"><span data-stu-id="6698b-208">We recommend that the login time-out period be at least 5 seconds.</span></span> <span data-ttu-id="6698b-209">Especificar um período de tempo limite menor poderia impedir quaisquer das tentativas de conexão de ter êxito.</span><span class="sxs-lookup"><span data-stu-id="6698b-209">Specifying a smaller time-out period might prevent any of the connection attempts from succeeding.</span></span>  
  
 <span data-ttu-id="6698b-210">O tempo da retentar é uma porcentagem do período de logon.</span><span class="sxs-lookup"><span data-stu-id="6698b-210">The retry time is a percentage of the login period.</span></span> <span data-ttu-id="6698b-211">O tempo da retentar para uma tentativa de conexão é maior em cada turno sucessivo.</span><span class="sxs-lookup"><span data-stu-id="6698b-211">The retry time for a connection attempt is larger in each successive round.</span></span> <span data-ttu-id="6698b-212">No primeiro turno, o tempo de retentar para cada das duas tentativas é de 8 por cento do período de logon total.</span><span class="sxs-lookup"><span data-stu-id="6698b-212">In the first round, the retry time for each of the two attempts is 8 percent of the total login period.</span></span> <span data-ttu-id="6698b-213">Em cada turno sucessivo, o algoritmo de retentar aumenta o tempo máximo de retentar pela mesma quantia.</span><span class="sxs-lookup"><span data-stu-id="6698b-213">In each successive round, the retry algorithm increases the maximum retry time by the same amount.</span></span> <span data-ttu-id="6698b-214">Assim, o retentar para as primeiras oito tentativas de conexão é como se segue:</span><span class="sxs-lookup"><span data-stu-id="6698b-214">Thus, the retry times for the first eight connection attempts is as follows:</span></span>  
  
 <span data-ttu-id="6698b-215">8%, 8%, 16%, 16%, 24%, 24%, 32%, 32%</span><span class="sxs-lookup"><span data-stu-id="6698b-215">8%, 8%, 16%, 16%, 24%, 24%, 32%, 32%</span></span>  
  
 <span data-ttu-id="6698b-216">O tempo de retentar é calculado usando a seguinte fórmula:</span><span class="sxs-lookup"><span data-stu-id="6698b-216">The retry time is calculated using the following formula:</span></span>  
  
 <span data-ttu-id="6698b-217">_RetryTime_ **=** _PreviousRetryTime_ **+(** 0.08 **&#42;** _LoginTimeout_ **)**</span><span class="sxs-lookup"><span data-stu-id="6698b-217">_RetryTime_ **=** _PreviousRetryTime_ **+(** 0.08 **&#42;**_LoginTimeout_**)**</span></span>  
  
 <span data-ttu-id="6698b-218">Onde *PreviousRetryTime* é inicialmente 0.</span><span class="sxs-lookup"><span data-stu-id="6698b-218">Where *PreviousRetryTime* is initially 0.</span></span>  
  
 <span data-ttu-id="6698b-219">Por exemplo, se usar o período de intervalo de logon padrão de 15 segundos, *LoginTimeout* *= 15*.</span><span class="sxs-lookup"><span data-stu-id="6698b-219">For example, if using the default login time-out period of 15 seconds, *LoginTimeout* *= 15*.</span></span> <span data-ttu-id="6698b-220">Nesse caso, os tempos de nova tentativa alocados nos primeiros três turnos são os seguintes:</span><span class="sxs-lookup"><span data-stu-id="6698b-220">In this case, the retry times allotted in the first three rounds are as follows:</span></span>  
  
|<span data-ttu-id="6698b-221">Round</span><span class="sxs-lookup"><span data-stu-id="6698b-221">Round</span></span>|<span data-ttu-id="6698b-222">Cálculo de*RetryTime*</span><span class="sxs-lookup"><span data-stu-id="6698b-222">*RetryTime* calculation</span></span>|<span data-ttu-id="6698b-223">Tempo de nova tentativa por tentativa</span><span class="sxs-lookup"><span data-stu-id="6698b-223">Retry time per attempt</span></span>|  
|-----------|-----------------------------|----------------------------|  
|<span data-ttu-id="6698b-224">1</span><span class="sxs-lookup"><span data-stu-id="6698b-224">1</span></span>|<span data-ttu-id="6698b-225">0 **+(** 0,08 **&#42;** 15 **)**</span><span class="sxs-lookup"><span data-stu-id="6698b-225">0 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="6698b-226">1,2 segundos</span><span class="sxs-lookup"><span data-stu-id="6698b-226">1.2 seconds</span></span>|  
|<span data-ttu-id="6698b-227">2</span><span class="sxs-lookup"><span data-stu-id="6698b-227">2</span></span>|<span data-ttu-id="6698b-228">1,2 **+(** 0,08 **&#42;** 15 **)**</span><span class="sxs-lookup"><span data-stu-id="6698b-228">1.2 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="6698b-229">2,4 segundos</span><span class="sxs-lookup"><span data-stu-id="6698b-229">2.4 seconds</span></span>|  
|<span data-ttu-id="6698b-230">3</span><span class="sxs-lookup"><span data-stu-id="6698b-230">3</span></span>|<span data-ttu-id="6698b-231">2,4 **+(** 0,08 **&#42;** 15 **)**</span><span class="sxs-lookup"><span data-stu-id="6698b-231">2.4 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="6698b-232">3,6 segundos</span><span class="sxs-lookup"><span data-stu-id="6698b-232">3.6 seconds</span></span>|  
|<span data-ttu-id="6698b-233">4</span><span class="sxs-lookup"><span data-stu-id="6698b-233">4</span></span>|<span data-ttu-id="6698b-234">3,6 **+(** 0,08 **&#42;** 15 **)**</span><span class="sxs-lookup"><span data-stu-id="6698b-234">3.6 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="6698b-235">4,8 segundos</span><span class="sxs-lookup"><span data-stu-id="6698b-235">4.8 seconds</span></span>|   
  
 <span data-ttu-id="6698b-236">A figura a seguir ilustra esses tempos de nova tentativa em tentativas de conexão sucessivas, todas elas com tempos limite esgotados.</span><span class="sxs-lookup"><span data-stu-id="6698b-236">The following figure illustrates these retry times for successive connection attempts, each of which times out.</span></span>  
  
 <span data-ttu-id="6698b-237">![Atrasos máximos de repetições para um tempo limite de logon de 15 segundos](../media/dbm-retry-algorithm.gif "Atrasos máximos de repetições para um tempo limite de logon de 15 segundos")</span><span class="sxs-lookup"><span data-stu-id="6698b-237">![Maximum retry delays for 15 second login timeout](../media/dbm-retry-algorithm.gif "Maximum retry delays for 15 second login timeout")</span></span>  
  
 <span data-ttu-id="6698b-238">Para o período limite de logon padrão, o tempo máximo estimado para os primeiros três turnos de tentativas de conexão é de 14.4 segundos.</span><span class="sxs-lookup"><span data-stu-id="6698b-238">For the default login time-out period, the maximum time allotted to the first three rounds of connection attempts is 14.4 seconds.</span></span> <span data-ttu-id="6698b-239">Se toda tentativa fosse usar tudo de seu tempo estimado, só 0.6 segundo de tempo restaria antes do período de logon expirar. Naquele caso, o quarto turno seria reduzido, permitindo só uma tentativa rápida final para conectar usando o nome de parceiro inicial.</span><span class="sxs-lookup"><span data-stu-id="6698b-239">If every attempt were to use all of its allotted time, only 0.6 seconds of time would remain before the login period times out. In that case, the fourth round would be curtailed, allowing only a final quick attempt to connect using the initial partner name.</span></span> <span data-ttu-id="6698b-240">Porém, uma tentativa de conexão pode falhar em menos tempo do que seu tempo estimado, particularmente em turnos posteriores.</span><span class="sxs-lookup"><span data-stu-id="6698b-240">However, a connection attempt may fail in less than its allotted retry time, particularly in later rounds.</span></span> <span data-ttu-id="6698b-241">Por exemplo, receber um erro de rede pode fazer com que uma tentativa termine antes que o tempo de retentar expire.</span><span class="sxs-lookup"><span data-stu-id="6698b-241">For example, receiving a network error can cause an attempt to end before the retry time expires.</span></span> <span data-ttu-id="6698b-242">Se as primeiras tentativas falharem devido a um erro de rede, haveria tempo adicional disponível para o quarto turno e, talvez, turnos adicionais.</span><span class="sxs-lookup"><span data-stu-id="6698b-242">If earlier attempts fail due to a network error, additional time would be available for the fourth round and, perhaps, additional rounds.</span></span>  
  
 <span data-ttu-id="6698b-243">Outra causa de uma tentativa falha é uma instância de servidor inativa, como acontece quando uma instância de servidor estiver comprometida numa interrupção de seu banco de dados.</span><span class="sxs-lookup"><span data-stu-id="6698b-243">Another cause of a failed attempt is an inactive server instance, as occurs when a server instance is engaged in failing over its database.</span></span> <span data-ttu-id="6698b-244">Neste caso, um atraso é imposto para impedir clientes de sobrecarregar os parceiros com uma sucessão rápida de tentativas de conexão.</span><span class="sxs-lookup"><span data-stu-id="6698b-244">In this case, a retry delay is imposed to prevent clients from overloading the partners with a rapid succession of connection attempts.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6698b-245">Quando ambos os nomes de parceiros estiverem disponíveis, se o período de tempo de limite de logon for infinito, o cliente tentará se reconectar indefinidamente aos servidores, alternando entre o nome de parceiro inicial e o nome de parceiro de failover.</span><span class="sxs-lookup"><span data-stu-id="6698b-245">When both partner names are available, if the login time-out period is infinite, the client attempts to reconnect to the servers indefinitely, alternating between the initial partner name and the failover partner name.</span></span>  
<span data-ttu-id="6698b-246">)</span><span class="sxs-lookup"><span data-stu-id="6698b-246">)</span></span>  
  
### <a name="retry-delays-during-failover"></a><span data-ttu-id="6698b-247">Atrasos de nova tentativa durante o failover</span><span class="sxs-lookup"><span data-stu-id="6698b-247">Retry Delays During Failover</span></span>  
 <span data-ttu-id="6698b-248">Se um cliente tentar se conectar a um parceiro que está em failover, o parceiro responderá imediatamente que é inativo.</span><span class="sxs-lookup"><span data-stu-id="6698b-248">If a client attempts to connect to a partner that is failing over, the partner immediately responds that it is inactive.</span></span> <span data-ttu-id="6698b-249">Neste caso, cada turno de tentativas de conexão é muito mais breve que o tempo de retentar estimado.</span><span class="sxs-lookup"><span data-stu-id="6698b-249">In this case, each round of connection attempts are much briefer than the allotted retry time.</span></span> <span data-ttu-id="6698b-250">Isso significa que muitos turnos de tentativas de conexão poderiam acontecer antes que o período de logon expire. Para evitar a sobrecarrega dos parceiros com uma série rápida de tentativas de conexão durante um failover, o provedor de acesso de dados adiciona um breve retardo ao retentar depois de cada turno de retentar.</span><span class="sxs-lookup"><span data-stu-id="6698b-250">This means that many rounds of connection attempts could happen before the login period times out. To avoid overloading the partners with a rapid series of connection attempts during a failover, the data access provider adds a brief retry delay after each retry cycle.</span></span> <span data-ttu-id="6698b-251">A duração de um determinado retardo ao retentar é determinada pelo algoritmo de retardo ao retentar.</span><span class="sxs-lookup"><span data-stu-id="6698b-251">The length of a given retry delay is determined by the retry-delay algorithm.</span></span> <span data-ttu-id="6698b-252">Depois do primeiro turno, o retardo é 100 milissegundos.</span><span class="sxs-lookup"><span data-stu-id="6698b-252">After the first round, the delay is 100 milliseconds.</span></span> <span data-ttu-id="6698b-253">Após cada um dos três turnos, o retardo ao repetir dobra – para 200, 400 e 800.</span><span class="sxs-lookup"><span data-stu-id="6698b-253">After each of the next three rounds, the retry delay doubles-to 200, 400, and 800.</span></span> <span data-ttu-id="6698b-254">Em todos os últimos turnos, o atraso de nova tentativa é de 1 segundo até que a tentativa de conexão tenha êxito ou expire.</span><span class="sxs-lookup"><span data-stu-id="6698b-254">For all later rounds, the retry delay is 1 second until the connection attempt succeeds or times out.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6698b-255">Se a instância de servidor for parada, então a solicitação de conexão falhará imediatamente.</span><span class="sxs-lookup"><span data-stu-id="6698b-255">If the server instance is stopped, then the connection request fails immediately.</span></span>  
  
 <span data-ttu-id="6698b-256">A figura seguinte ilustra como o atraso de nova tentativa afeta as tentativas de conexão durante um failover manual, no qual os parceiros trocam suas funções.</span><span class="sxs-lookup"><span data-stu-id="6698b-256">The following figure illustrates how the retry delay affects connection attempts during a manual failover, in which the partners switch their roles.</span></span> <span data-ttu-id="6698b-257">O período de tempo limite de logon padrão é de 15 segundos.</span><span class="sxs-lookup"><span data-stu-id="6698b-257">The login time-out period is 15 seconds.</span></span>  
  
 <span data-ttu-id="6698b-258">![Algoritmo de repetição-atraso](../media/dbm-retry-delay-algorithm.gif "Algoritmo de repetição-atraso")</span><span class="sxs-lookup"><span data-stu-id="6698b-258">![Retry-delay algorithm](../media/dbm-retry-delay-algorithm.gif "Retry-delay algorithm")</span></span>  
  
##  <a name="reconnecting-to-a-database-mirroring-session"></a><a name="Reconnecting"></a> <span data-ttu-id="6698b-259">Reconectando uma sessão de espelhamento de banco de dados</span><span class="sxs-lookup"><span data-stu-id="6698b-259">Reconnecting to a Database Mirroring Session</span></span>  
 <span data-ttu-id="6698b-260">Se uma conexão estabelecida com uma sessão de espelhamento de banco de dados falhar por qualquer motivo, por exemplo, devido a um failover de espelhamento de banco de dados, e o aplicativo tentar se reconectar ao servidor inicial, o provedor de acesso de dados poderá tentar se reconectar usando o nome de parceiro de failover armazenado no cache do cliente.</span><span class="sxs-lookup"><span data-stu-id="6698b-260">If an established connection to a database mirroring session fails for any reason, for example, due to a database mirroring failover, and the application attempts to reconnect to the initial server, the data access provider can attempt to reconnect using the failover partner name stored in the client's cache.</span></span> <span data-ttu-id="6698b-261">Porém, a reconexão não é automática.</span><span class="sxs-lookup"><span data-stu-id="6698b-261">Reconnecting is not automatic, however.</span></span> <span data-ttu-id="6698b-262">O aplicativo deve se dar conta do erro.</span><span class="sxs-lookup"><span data-stu-id="6698b-262">The application must become aware of the error.</span></span> <span data-ttu-id="6698b-263">Então, o aplicativo precisa fechar a conexão com falha e abrir uma conexão nova que use os mesmos atributos de cadeia de caracteres de conexão.</span><span class="sxs-lookup"><span data-stu-id="6698b-263">Then, the application needs to close the failed connection and open a new connection using the same connection string attributes.</span></span> <span data-ttu-id="6698b-264">Neste momento, o provedor de acesso de dados redireciona a conexão ao parceiro de failover.</span><span class="sxs-lookup"><span data-stu-id="6698b-264">At this point, the data access provider redirects the connection to the failover partner.</span></span> <span data-ttu-id="6698b-265">Se a instância de servidor identificada por este nome for atualmente o servidor principal, a tentativa de conexão normalmente terá sucesso.</span><span class="sxs-lookup"><span data-stu-id="6698b-265">If the server instance identified by this name is currently the principal server, the connection attempt usually succeeds.</span></span> <span data-ttu-id="6698b-266">Caso estiver obscuro se uma transação foi confirmada ou revertida, o aplicativo deve inspecionar o estado da transação, da mesma maneira como ao reconectar a uma instância de servidor autônoma.</span><span class="sxs-lookup"><span data-stu-id="6698b-266">If it is unclear whether a transaction was committed or rolled back, the application must check on the state of the transaction, in the same way as when reconnecting to a stand-alone server instance.</span></span>  
  
 <span data-ttu-id="6698b-267">A reconexão se assemelha a uma conexão inicial para a qual a cadeia de caracteres de conexão forneceu um nome de parceiro de failover.</span><span class="sxs-lookup"><span data-stu-id="6698b-267">Reconnecting resembles an initial connection for which the connection string supplied a failover partner name.</span></span> <span data-ttu-id="6698b-268">Se a primeira tentativa de conexão falhar, as tentativas de conexão alternarão seguidamente entre o nome do parceiro inicial e o nome do parceiro de failover até que o cliente conecte ao servidor principal ou o provedor de acesso de dados expire o tempo limite.</span><span class="sxs-lookup"><span data-stu-id="6698b-268">If the first connection attempt fails, connection attempts alternate back and forth between the initial partner name and failover partner name until either the client connects to the  principal server or the data access provider times out.</span></span>  
  
> [!NOTE]  
>  [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="6698b-269">O Native Client verifica se ele se conecta a uma instância de servidor principal, mas não se essa instância é o parceiro da instância de servidor especificado no nome de parceiro inicial da cadeia de conexão.</span><span class="sxs-lookup"><span data-stu-id="6698b-269">Native Client verifies that it connects to a principal server instance but not whether this instance is the partner of server instance specified in the initial partner name of the connection string.</span></span>  
  
 <span data-ttu-id="6698b-270">Se as conexões usarem TCP/IP, o algoritmo de nova tentativa de conexão determinará o período de tempo designado para as tentativas de conexão em cada turno.</span><span class="sxs-lookup"><span data-stu-id="6698b-270">If the connections use TCP/IP, the connection retry algorithm determines the amount of time allotted to the connection attempts in each round.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="6698b-271">Se o cliente for desconectado do banco de dados, o provedor de acesso de dados não tentará reconectar.</span><span class="sxs-lookup"><span data-stu-id="6698b-271">If the client gets disconnected from the database, the data access provider does not attempt to reconnect.</span></span> <span data-ttu-id="6698b-272">O cliente deverá emitir uma solicitação de conexão nova.</span><span class="sxs-lookup"><span data-stu-id="6698b-272">The client must issue a new connection request.</span></span> <span data-ttu-id="6698b-273">Também, se um aplicativo desligar ao perder a conexão, perderá os nomes do parceiro em cache.</span><span class="sxs-lookup"><span data-stu-id="6698b-273">Also, if an application shuts down on losing the connection, it will lose the cached partner names.</span></span> <span data-ttu-id="6698b-274">Se a conexão se perder porque o servidor principal ficou indisponível, o único modo pelo qual o aplicativo pode se reconectar ao servidor espelho é fornecendo o nome do parceiro de failover em sua cadeia de conexão.</span><span class="sxs-lookup"><span data-stu-id="6698b-274">If the connection was lost because the principal server became unavailable, the only way that the application can reconnect to the mirror server is by supplying the failover partner name in its connection string.</span></span>  
  
  
### <a name="impact-of-redirection-on-a-client-application"></a><span data-ttu-id="6698b-275">Impacto do redirecionamento em um aplicativo cliente</span><span class="sxs-lookup"><span data-stu-id="6698b-275">Impact of Redirection on a Client Application</span></span>  
 <span data-ttu-id="6698b-276">Depois de um failover, o provedor de acesso a dados redireciona a conexão com a instância do servidor principal atual.</span><span class="sxs-lookup"><span data-stu-id="6698b-276">After a failover, the data access provider redirects the connection to the current principal server instance.</span></span> <span data-ttu-id="6698b-277">Porém, a redireção é transparente aos clientes.</span><span class="sxs-lookup"><span data-stu-id="6698b-277">However, the redirection is transparent to clients.</span></span> <span data-ttu-id="6698b-278">Para um cliente, uma conexão redirecionada parece ser uma conexão com a instância de servidor identificada pelo nome do parceiro inicial.</span><span class="sxs-lookup"><span data-stu-id="6698b-278">To a client, a redirected connection appears to be a connection to the server instance identified by the initial partner name.</span></span> <span data-ttu-id="6698b-279">Quando o parceiro inicial for atualmente o servidor espelho, o cliente poderá parecer estar conectado ao servidor espelho e atualizando o banco de dados espelho.</span><span class="sxs-lookup"><span data-stu-id="6698b-279">When the initial partner is currently the mirror server, the client can appear to be connected to the mirror server and updating the mirror database.</span></span> <span data-ttu-id="6698b-280">Porém, de fato o cliente foi redirecionado ao parceiro de failover que é o banco de dados principal atual e o cliente está atualizando o banco de dados principal novo.</span><span class="sxs-lookup"><span data-stu-id="6698b-280">Actually, however, the client has been redirected to the failover partner, which is the current principal database, and the client is updating the new principal database.</span></span>  
  
 <span data-ttu-id="6698b-281">Depois de ser redirecionado ao parceiro de failover, um cliente pode experimentar resultados inesperados ao usar uma instrução USE [!INCLUDE[tsql](../../includes/tsql-md.md)] para usar um banco de dados diferente.</span><span class="sxs-lookup"><span data-stu-id="6698b-281">After being redirected to the failover partner, a client can experience unexpected results when using a [!INCLUDE[tsql](../../includes/tsql-md.md)] USE statement to use a different database.</span></span> <span data-ttu-id="6698b-282">Isso poderá acontecer se a instância do servidor principal atual (o parceiro de failover) tiver um conjunto de bancos de dados diferente do servidor principal original (o parceiro inicial).</span><span class="sxs-lookup"><span data-stu-id="6698b-282">This can happen if the current principal server instance (the failover partner) has a different set of databases than the original principal server (the initial partner).</span></span>  
  
##  <a name="the-impact-of-a-stale-failover-partner-name"></a><a name="StalePartnerName"></a> <span data-ttu-id="6698b-283">O impacto de um nome de parceiro de failover desatualizado</span><span class="sxs-lookup"><span data-stu-id="6698b-283">The Impact of a Stale Failover Partner Name</span></span>  
 <span data-ttu-id="6698b-284">O administrador do banco de dados pode alterar o parceiro de failover a qualquer momento.</span><span class="sxs-lookup"><span data-stu-id="6698b-284">The database administrator can change the failover partner at any time.</span></span> <span data-ttu-id="6698b-285">Portanto, um nome de parceiro de failover fornecido pelo cliente pode estar desatualizado ou *obsoleto*.</span><span class="sxs-lookup"><span data-stu-id="6698b-285">Therefore, a client-supplied failover partner name might be out of date, or *stale*.</span></span> <span data-ttu-id="6698b-286">Por exemplo, considere um nome de parceiro de failover Partner_B que é substituído por outra instância de servidor, Partner_C.</span><span class="sxs-lookup"><span data-stu-id="6698b-286">For example, consider a failover partner named Partner_B that is replaced by another server instance, Partner_C.</span></span> <span data-ttu-id="6698b-287">Se um cliente fornecer Partner_B como o nome do parceiro de failover, este nome estará desatualizado.</span><span class="sxs-lookup"><span data-stu-id="6698b-287">Now, if a client supplies Partner_B as the failover partner name, that name is stale.</span></span> <span data-ttu-id="6698b-288">Quando o nome do parceiro de failover fornecido pelo cliente está desatualizado, o comportamento do provedor de acesso de dados é equiparado ao caso em que um nome de parceiro de failover não é fornecido pelo cliente.</span><span class="sxs-lookup"><span data-stu-id="6698b-288">When the client-supplied failover partner name is stale, the behavior of the data access provider equates to the case in which a failover partner name is not supplied by the client.</span></span>  
  
 <span data-ttu-id="6698b-289">Por exemplo, considere uma situação em que um cliente usa uma cadeia de conexão para uma série de quatro tentativas de conexão.</span><span class="sxs-lookup"><span data-stu-id="6698b-289">For example, consider situation in which a client uses one connection string for a series of four connection attempts.</span></span> <span data-ttu-id="6698b-290">Na cadeia de conexão, o nome do parceiro inicial é Partner_A e o nome do parceiro de failover é Partner_B:</span><span class="sxs-lookup"><span data-stu-id="6698b-290">In the connection string, the initial partner name is Partner_A, and the failover partner name is Partner_B:</span></span>  
  
```  
"Server=Partner_A; Failover Partner=Partner_B; Database=AdventureWorks"  
```  
  
 <span data-ttu-id="6698b-291">A tabela a seguir mostra quatro configurações de parceiro e indica para cada uma se essa cadeia de conexão funciona para conexão com o cliente pela primeira vez.</span><span class="sxs-lookup"><span data-stu-id="6698b-291">The following table shows four partner configurations and indicates for each whether this connection string works for connecting the client for the first time.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="6698b-292">Um aplicativo pode rastrear alterações de configuração e alterar sua cadeia de conexão.</span><span class="sxs-lookup"><span data-stu-id="6698b-292">An application can track configuration changes and change its connection string accordingly.</span></span> <span data-ttu-id="6698b-293">Isso requer código extra, mas reduz a carga administrativa.</span><span class="sxs-lookup"><span data-stu-id="6698b-293">This requires extra code but reduces the administrative burden.</span></span>  
  
|<span data-ttu-id="6698b-294">Configuração</span><span class="sxs-lookup"><span data-stu-id="6698b-294">Configuration</span></span>|<span data-ttu-id="6698b-295">Servidor principal</span><span class="sxs-lookup"><span data-stu-id="6698b-295">Principal server</span></span>|<span data-ttu-id="6698b-296">Servidor espelho</span><span class="sxs-lookup"><span data-stu-id="6698b-296">Mirror server</span></span>|<span data-ttu-id="6698b-297">Comportamento ao tentar conexão especificando Partner_A e Partner_B</span><span class="sxs-lookup"><span data-stu-id="6698b-297">Behavior when attempting to connect specifying Partner_A and Partner_B</span></span>|  
|-------------------|----------------------|-------------------|------------------------------------------------------------------------------|  
|<span data-ttu-id="6698b-298">Configuração de espelhamento original.</span><span class="sxs-lookup"><span data-stu-id="6698b-298">Original mirroring configuration.</span></span>|<span data-ttu-id="6698b-299">Partner_A</span><span class="sxs-lookup"><span data-stu-id="6698b-299">Partner_A</span></span>|<span data-ttu-id="6698b-300">Partner_B</span><span class="sxs-lookup"><span data-stu-id="6698b-300">Partner_B</span></span>|<span data-ttu-id="6698b-301">O Partner_A é armazenado em cache como o nome do parceiro inicial.</span><span class="sxs-lookup"><span data-stu-id="6698b-301">Partner_A is cached as the initial partner name.</span></span> <span data-ttu-id="6698b-302">O cliente tem sucesso na conexão com o Partner_A.</span><span class="sxs-lookup"><span data-stu-id="6698b-302">The client succeeds in connecting to Partner_A.</span></span> <span data-ttu-id="6698b-303">O cliente baixa o nome do servidor espelho, Partner_B, e o coloca em cache, ignorando o nome do parceiro de failover fornecido pelo cliente.</span><span class="sxs-lookup"><span data-stu-id="6698b-303">The client downloads the name of mirror server, Partner_B, and caches it, ignoring the client-supplied failover partner name.</span></span>|  
|<span data-ttu-id="6698b-304">O Partner_A experimenta um problema de hardware e ocorre failover (desconectando clientes).</span><span class="sxs-lookup"><span data-stu-id="6698b-304">Partner_A experiences a hardware failure, and failover occurs (disconnecting clients).</span></span>|<span data-ttu-id="6698b-305">Partner_B</span><span class="sxs-lookup"><span data-stu-id="6698b-305">Partner_B</span></span>|<span data-ttu-id="6698b-306">none</span><span class="sxs-lookup"><span data-stu-id="6698b-306">none</span></span>|<span data-ttu-id="6698b-307">O Partner_A ainda está no cache como o nome do parceiro inicial, mas o nome do parceiro de failover fornecido pelo cliente, Partner_B, permite que o cliente faça conexão com o servidor principal atual.</span><span class="sxs-lookup"><span data-stu-id="6698b-307">The Partner_A is still cached as the initial partner name, but the client-supplied failover partner name, Partner_B, permits the client to connect to the current principal server.</span></span>|  
|<span data-ttu-id="6698b-308">O administrador do banco de dados interrompe o espelhamento (desconectando os clientes), substitui Partner_A por Partner_C e reinicializa o espelhamento.</span><span class="sxs-lookup"><span data-stu-id="6698b-308">The database administrator stops mirroring (disconnecting clients), replaces Partner_A with Partner_C, and restarts mirroring.</span></span>|<span data-ttu-id="6698b-309">Partner_B</span><span class="sxs-lookup"><span data-stu-id="6698b-309">Partner_B</span></span>|<span data-ttu-id="6698b-310">Partner_C</span><span class="sxs-lookup"><span data-stu-id="6698b-310">Partner_C</span></span>|<span data-ttu-id="6698b-311">O cliente tenta se conectar com o Partner_A e não consegue; então o cliente tenta o Partner_B (o servidor principal atual) e tem sucesso.</span><span class="sxs-lookup"><span data-stu-id="6698b-311">The client attempts to connect to Partner_A and fails; then the client tries Partner_B (the current principal server) and succeeds.</span></span> <span data-ttu-id="6698b-312">O provedor de acesso de dados carrega o nome do servidor espelho atual, Partner_C, e o coloca em cache como o nome do parceiro de failover atual.</span><span class="sxs-lookup"><span data-stu-id="6698b-312">The data access provider downloads the name of the current mirror server, Partner_C, and caches it as the current failover partner name.</span></span>|  
|<span data-ttu-id="6698b-313">O failover do serviço é enviado manualmente para o Partner_C (desconectando os clientes).</span><span class="sxs-lookup"><span data-stu-id="6698b-313">Service is manually failed over to Partner_C (disconnecting clients).</span></span>|<span data-ttu-id="6698b-314">Partner_C</span><span class="sxs-lookup"><span data-stu-id="6698b-314">Partner_C</span></span>|<span data-ttu-id="6698b-315">Partner_B</span><span class="sxs-lookup"><span data-stu-id="6698b-315">Partner_B</span></span>|<span data-ttu-id="6698b-316">O cliente tenta conexão com o Partner_A inicialmente, e depois com o Partner_B.</span><span class="sxs-lookup"><span data-stu-id="6698b-316">Client attempts to connect to Partner_A initially, and then to Partner_B.</span></span> <span data-ttu-id="6698b-317">Os dois nomes falham, e finalmente o tempo limite da solicitação de conexão se esgota e falha.</span><span class="sxs-lookup"><span data-stu-id="6698b-317">Both names fail, and eventually the connection request times out and fails.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="6698b-318">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="6698b-318">See Also</span></span>  
 <span data-ttu-id="6698b-319">[Espelhamento de banco de dados &#40;SQL Server&#41;](database-mirroring-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="6698b-319">[Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md) </span></span>  
 [<span data-ttu-id="6698b-320">Possíveis falhas durante espelhamento de banco de dados</span><span class="sxs-lookup"><span data-stu-id="6698b-320">Possible Failures During Database Mirroring</span></span>](possible-failures-during-database-mirroring.md)  
  
  
