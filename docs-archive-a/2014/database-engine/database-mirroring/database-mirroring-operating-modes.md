---
title: Modos de operação do Espelhamento de Banco de Dados | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- database mirroring [SQL Server], operating modes
ms.assetid: f8a579c2-55d7-4278-8088-f1da1de5b2e6
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: c944b402b8b1ba9b78036d667ec728ccaf561a91
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87570227"
---
# <a name="database-mirroring-operating-modes"></a><span data-ttu-id="96c3a-102">Modos de operação de espelhamento de banco de dados</span><span class="sxs-lookup"><span data-stu-id="96c3a-102">Database Mirroring Operating Modes</span></span>
  <span data-ttu-id="96c3a-103">Este tópico descreve os modos de operação síncronos e assíncronos de sessões de espelhamento de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="96c3a-103">This topic describes the synchronous and asynchronous operating modes for database mirroring sessions.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="96c3a-104">Para obter uma introdução ao espelhamento de banco de dados, consulte [Espelhamento de banco de dados &#40;SQL Server&#41;](database-mirroring-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="96c3a-104">For an introduction to database mirroring, see [Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md).</span></span>  
  
 
  
##  <a name="terms-and-definitions"></a><a name="TermsAndDefinitions"></a> <span data-ttu-id="96c3a-105">Termos e definições</span><span class="sxs-lookup"><span data-stu-id="96c3a-105">Terms and Definitions</span></span>  
 <span data-ttu-id="96c3a-106">Esta seção introduz alguns termos que são essenciais para este tópico.</span><span class="sxs-lookup"><span data-stu-id="96c3a-106">This section introduces a few terms that are central to this topic.</span></span>  
  
 <span data-ttu-id="96c3a-107">Modo de alto desempenho</span><span class="sxs-lookup"><span data-stu-id="96c3a-107">High-performance mode</span></span>  
 <span data-ttu-id="96c3a-108">A sessão de espelhamento de banco de dados opera de forma assíncrona e usa só o servidor principal e o servidor espelho.</span><span class="sxs-lookup"><span data-stu-id="96c3a-108">The database mirroring session operates asynchronously and uses only the principal server and mirror server.</span></span> <span data-ttu-id="96c3a-109">A única forma de troca de função é o serviço forçado (com possível perda de dados).</span><span class="sxs-lookup"><span data-stu-id="96c3a-109">The only form of role switching is forced service (with possible data loss).</span></span>  
  
 <span data-ttu-id="96c3a-110">Modo de alta segurança</span><span class="sxs-lookup"><span data-stu-id="96c3a-110">High-safety mode</span></span>  
 <span data-ttu-id="96c3a-111">A sessão de espelhamento de banco de dados opera de forma síncrona e, opcionalmente, usa uma testemunha, bem como o servidor principal e o servidor espelho.</span><span class="sxs-lookup"><span data-stu-id="96c3a-111">The database mirroring session operates synchronously and, optionally, uses a witness, as well as the principal server and mirror server.</span></span>  
  
 <span data-ttu-id="96c3a-112">Segurança de transação</span><span class="sxs-lookup"><span data-stu-id="96c3a-112">Transaction safety</span></span>  
 <span data-ttu-id="96c3a-113">Uma propriedade de banco de dados específica de espelhamento que determina se uma sessão de espelhamento de banco de dados opera de forma síncrona ou assíncrona.</span><span class="sxs-lookup"><span data-stu-id="96c3a-113">A mirroring-specific database property that determines whether a database mirroring session operates synchronously or asynchronously.</span></span> <span data-ttu-id="96c3a-114">Há dois níveis de segurança: COMPLETO e DESLIGADO.</span><span class="sxs-lookup"><span data-stu-id="96c3a-114">There are two safety levels: FULL and OFF.</span></span>  
  
 <span data-ttu-id="96c3a-115">Witness (testemunha)</span><span class="sxs-lookup"><span data-stu-id="96c3a-115">Witness</span></span>  
 <span data-ttu-id="96c3a-116">Para uso apenas com o modo de alta segurança, uma instância opcional do SQL Server que permite ao servidor espelho reconhecer se um failover automático deve ser iniciado.</span><span class="sxs-lookup"><span data-stu-id="96c3a-116">For use only with high-safety mode, an optional instance of SQL Server that enables the mirror server to recognize whether to initiate an automatic failover.</span></span> <span data-ttu-id="96c3a-117">Ao contrário dos dois parceiros de failover, a testemunha não atende ao banco de dados.</span><span class="sxs-lookup"><span data-stu-id="96c3a-117">Unlike the two failover partners, the witness does not serve the database.</span></span> <span data-ttu-id="96c3a-118">O suporte ao failover automático é a única função da testemunha.</span><span class="sxs-lookup"><span data-stu-id="96c3a-118">Supporting automatic failover is the only role of the witness.</span></span>  
  
##  <a name="asynchronous-database-mirroring-high-performance-mode"></a><a name="VisualElement"></a><span data-ttu-id="96c3a-119">Espelhamento de banco de dados assíncrono (modo de alto desempenho)</span><span class="sxs-lookup"><span data-stu-id="96c3a-119">Asynchronous Database Mirroring (High-Performance Mode)</span></span>  
 <span data-ttu-id="96c3a-120">Esta seção descreve como funciona o espelhamento de banco de dados assíncrono, quando é apropriado usar o modo de alto desempenho e como responder se o servidor principal falhar.</span><span class="sxs-lookup"><span data-stu-id="96c3a-120">This section describes how asynchronous database mirroring works, when it is appropriate to use high-performance mode, and how to respond if the principal server fails.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="96c3a-121">A maioria das edições do [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] só dão suporte ao espelhamento de banco de dados síncrono ("somente segurança completa").</span><span class="sxs-lookup"><span data-stu-id="96c3a-121">Most editions of [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] support only synchronous database mirroring ("Safety Full Only").</span></span> <span data-ttu-id="96c3a-122">Para obter informações sobre edições que dão suporte total ao espelhamento de banco de dados, consulte "alta disponibilidade (AlwaysOn)" em [recursos com suporte nas edições do SQL Server 2014](../../getting-started/features-supported-by-the-editions-of-sql-server-2014.md).</span><span class="sxs-lookup"><span data-stu-id="96c3a-122">For information about editions that fully support database mirroring, see "High Availability (AlwaysOn)" in [Features Supported by the Editions of SQL Server 2014](../../getting-started/features-supported-by-the-editions-of-sql-server-2014.md).</span></span>  
  
 <span data-ttu-id="96c3a-123">Quando a segurança de transação está definida como OFF, a sessão de espelhamento de banco de dados opera de maneira assíncrona.</span><span class="sxs-lookup"><span data-stu-id="96c3a-123">When transaction safety is set to OFF, the database mirroring session operates asynchronously.</span></span> <span data-ttu-id="96c3a-124">A operação assíncrona permite apenas a um modo de operação, o modo de alto desempenho.</span><span class="sxs-lookup"><span data-stu-id="96c3a-124">Asynchronous operation supports only one operating mode-high-performance mode.</span></span> <span data-ttu-id="96c3a-125">Esse modo aumenta desempenho às custas de alta disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="96c3a-125">This mode enhances performance at the expense of high availability.</span></span> <span data-ttu-id="96c3a-126">O modo de alto desempenho usa apenas o servidor principal e o servidor espelho.</span><span class="sxs-lookup"><span data-stu-id="96c3a-126">High-performance mode uses just the principal server and the mirror server.</span></span> <span data-ttu-id="96c3a-127">Problemas no servidor espelho nunca causam impacto no servidor principal.</span><span class="sxs-lookup"><span data-stu-id="96c3a-127">Problems on the mirror server never impact the principal server.</span></span> <span data-ttu-id="96c3a-128">Com a perda do servidor principal, o banco de dados espelho fica marcado como DESCONECTADO, mas está disponível em espera passiva.</span><span class="sxs-lookup"><span data-stu-id="96c3a-128">On the loss of the principal server, the mirror database is marked DISCONNECTED but is available as a warm standby.</span></span>  
  
 <span data-ttu-id="96c3a-129">O modo de alto desempenho oferece suporte apenas a uma forma de troca de função: serviço forçado (com possível perda de dados), que usa o servidor espelho como um servidor em espera passiva.</span><span class="sxs-lookup"><span data-stu-id="96c3a-129">High-performance mode, supports only one form of role switching: forced service (with possible data loss), which uses the mirror server as a warm standby server.</span></span> <span data-ttu-id="96c3a-130">O serviço forçado é uma das possíveis respostas à falha do servidor principal.</span><span class="sxs-lookup"><span data-stu-id="96c3a-130">Forced service is one of the possible responses to the failure of the principal server.</span></span> <span data-ttu-id="96c3a-131">Como a perda de dados é possível, devem ser consideradas outras alternativas antes de forçar serviço ao espelho.</span><span class="sxs-lookup"><span data-stu-id="96c3a-131">Because data loss is possible, you should consider other alternatives before forcing service to the mirror.</span></span> <span data-ttu-id="96c3a-132">Para obter mais informações, consulte [Respondendo à falha do principal](#WhenPrincipalFails), mais adiante neste tópico.</span><span class="sxs-lookup"><span data-stu-id="96c3a-132">For more information, see [Responding to Failure of the Principal](#WhenPrincipalFails), later in this topic.</span></span>  
  
 <span data-ttu-id="96c3a-133">A figura a seguir mostra a configuração de uma sessão que usa modo de alto desempenho.</span><span class="sxs-lookup"><span data-stu-id="96c3a-133">The following figure shows the configuration of a session using high-performance mode.</span></span>  
  
 <span data-ttu-id="96c3a-134">![Configuração apenas para parceiro de uma sessão](../media/dbm-high-performance-mode.gif "Configuração apenas para parceiro de uma sessão")</span><span class="sxs-lookup"><span data-stu-id="96c3a-134">![Partner-only configuration of a session](../media/dbm-high-performance-mode.gif "Partner-only configuration of a session")</span></span>  
  
 <span data-ttu-id="96c3a-135">No modo de alto desempenho, assim que o servidor principal envia o log para uma transação para o servidor espelho, o servidor principal envia uma confirmação para o cliente, sem esperar uma confirmação do servidor espelho.</span><span class="sxs-lookup"><span data-stu-id="96c3a-135">In high-performance mode, as soon as the principal server sends the log for a transaction to the mirror server, the principal server sends a confirmation to the client, without waiting for an acknowledgement from the mirror server.</span></span> <span data-ttu-id="96c3a-136">As transações são confirmadas sem esperar que o servidor espelho grave o log no disco.</span><span class="sxs-lookup"><span data-stu-id="96c3a-136">Transactions commit without waiting for the mirror server to write the log to disk.</span></span> <span data-ttu-id="96c3a-137">A operação assíncrona permite a execução do servidor principal com latência de transação mínima.</span><span class="sxs-lookup"><span data-stu-id="96c3a-137">Asynchronous operation permits the principal server to run with minimum transaction latency.</span></span>  
  
 <span data-ttu-id="96c3a-138">O servidor espelho tenta acompanhar os registros de log enviados pelo servidor principal.</span><span class="sxs-lookup"><span data-stu-id="96c3a-138">The mirror server attempts to keep up with the log records sent by the principal server.</span></span> <span data-ttu-id="96c3a-139">Mas, o banco de dados espelho pode ficar um pouco atrasado em relação ao banco de dados principal, embora normalmente a lacuna entre os bancos de dados seja pequena.</span><span class="sxs-lookup"><span data-stu-id="96c3a-139">But the mirror database might lag somewhat behind the principal database, though typically the gap between the databases is small.</span></span> <span data-ttu-id="96c3a-140">Entretanto, a lacuna pode ser significativa se o servidor principal estiver com grande carga de trabalho ou se o sistema do servidor espelho estiver sobrecarregado.</span><span class="sxs-lookup"><span data-stu-id="96c3a-140">However, the gap can become substantial if the principal server is under a heavy work load or the system of the mirror server is over loaded.</span></span>  
  
 
  
###  <a name="when-is-high-performance-mode-appropriate"></a><a name="WhenUseHighPerf"></a> <span data-ttu-id="96c3a-141">Quando o modo de alto desempenho é apropriado?</span><span class="sxs-lookup"><span data-stu-id="96c3a-141">When Is High-Performance Mode Appropriate?</span></span>  
 <span data-ttu-id="96c3a-142">O modo de alto desempenho pode ser útil em um cenário de recuperação de desastre no qual os servidores principal e espelho estão separados por uma distância significativa e onde você não deseja que erros pequenos causem impacto ao servidor principal.</span><span class="sxs-lookup"><span data-stu-id="96c3a-142">High-performance mode can be useful in a disaster-recovery scenario in which the principal and mirror servers are separated by a significant distance and where you do not want small errors to impact the principal server.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="96c3a-143">O envio de logs pode ser um suplemento ao espelhamento de banco de dados e uma alternativa favorável ao espelhamento de banco de dados assíncrono.</span><span class="sxs-lookup"><span data-stu-id="96c3a-143">Log shipping can be a supplement to database mirroring and is a favorable alternative to asynchronous database mirroring.</span></span> <span data-ttu-id="96c3a-144">Para obter informações sobre as vantagens do envio de log, veja [Soluções de alta disponibilidade &#40;SQL Server&#41;](../../sql-server/failover-clusters/high-availability-solutions-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="96c3a-144">For information about the advantages of log shipping, see [High Availability Solutions &#40;SQL Server&#41;](../../sql-server/failover-clusters/high-availability-solutions-sql-server.md).</span></span> <span data-ttu-id="96c3a-145">Para obter informações sobre como usar o envio de logs com o espelhamento de banco de dados, veja [Espelhamento de banco de dados e envio de logs &#40;SQL Server&#41;](database-mirroring-and-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="96c3a-145">For information on using log shipping with database mirroring, see [Database Mirroring and Log Shipping &#40;SQL Server&#41;](database-mirroring-and-log-shipping-sql-server.md).</span></span>  
  
###  <a name="the-impact-of-a-witness-on-high-performance-mode"></a><a name="WitnessImpactOnHighPerf"></a> <span data-ttu-id="96c3a-146">O impacto de uma testemunha no modo de alto desempenho</span><span class="sxs-lookup"><span data-stu-id="96c3a-146">The Impact of a Witness on High-Performance Mode</span></span>  
 <span data-ttu-id="96c3a-147">Se você usar a Transact-SQL para configurar o modo de alto desempenho, sempre que a propriedade SAFETY for definida como OFF, é altamente recomendável que a propriedade WITNESS também seja definida como OFF.</span><span class="sxs-lookup"><span data-stu-id="96c3a-147">If you use Transact-SQL to configure high-performance mode, whenever the SAFETY property is set to OFF, we strongly recommend that the WITNESS property also be set to OFF.</span></span> <span data-ttu-id="96c3a-148">Uma testemunha pode coexistir com modo de alto desempenho, mas a testemunha não fornece nenhum benefício e representa um risco.</span><span class="sxs-lookup"><span data-stu-id="96c3a-148">A witness can coexist with high-performance mode, but the witness provides no benefit and introduces risk.</span></span>  
  
 <span data-ttu-id="96c3a-149">Se a testemunha estiver desconectada da sessão quando qualquer parceiro abaixar, o banco de dados ficará indisponível.</span><span class="sxs-lookup"><span data-stu-id="96c3a-149">If the witness is disconnected from the session when either partner goes down, the database becomes unavailable.</span></span> <span data-ttu-id="96c3a-150">Isso ocorre por que mesmo com o modo de alto desempenho não exigindo testemunhas, se uma delas é definida, a sessão exige um quorum que consista em duas ou mais instâncias do servidor.</span><span class="sxs-lookup"><span data-stu-id="96c3a-150">This is because, even though high-performance mode does not require a witness, if one is set, the session requires a quorum consisting of two or more server instances.</span></span> <span data-ttu-id="96c3a-151">Se a sessão não tem quorum, não pode servir o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="96c3a-151">If the session losses quorum, it cannot serve the database.</span></span>  
  
 <span data-ttu-id="96c3a-152">Quando uma testemunha é definida em modo de alto desempenho, a aplicação de quorum significa que:</span><span class="sxs-lookup"><span data-stu-id="96c3a-152">When a witness is set in a high-performance mode session, the enforcement of quorum means that:</span></span>  
  
-   <span data-ttu-id="96c3a-153">Se o servidor espelho for perdido, o servidor principal deve ser conectado à testemunha.</span><span class="sxs-lookup"><span data-stu-id="96c3a-153">If the mirror server is lost, the principal server must be connected to the witness.</span></span> <span data-ttu-id="96c3a-154">Caso contrário, o servidor principal deixa seu banco de dados offline até que a testemunha ou o servidor espelho se reúna novamente à sessão.</span><span class="sxs-lookup"><span data-stu-id="96c3a-154">Otherwise, the principal server takes its database offline until either the witness or mirror server rejoins the session.</span></span>  
  
-   <span data-ttu-id="96c3a-155">Se o servidor principal for perdido, forçar o serviço para o servidor espelho exige que o servidor espelho esteja conectado à testemunha.</span><span class="sxs-lookup"><span data-stu-id="96c3a-155">If the principal server is lost, forcing service to the mirror server requires that the mirror server be connected to the witness.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="96c3a-156">Para obter mais informações sobre os tipos de quoruns, veja [Quorum: Como uma testemunha afeta a disponibilidade do banco de dados &#40;Espelhamento de Banco de Dados&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span><span class="sxs-lookup"><span data-stu-id="96c3a-156">For information about the types of quorums, see [Quorum: How a Witness Affects Database Availability &#40;Database Mirroring&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span></span>  
  
###  <a name="responding-to-failure-of-the-principal"></a><a name="WhenPrincipalFails"></a> <span data-ttu-id="96c3a-157">Respondendo à falha do principal</span><span class="sxs-lookup"><span data-stu-id="96c3a-157">Responding to Failure of the Principal</span></span>  
 <span data-ttu-id="96c3a-158">Quando o principal falhar, o proprietário do banco de dados tem várias escolhas, como se segue:</span><span class="sxs-lookup"><span data-stu-id="96c3a-158">When the principal fails, the database owner has several choices, as follows:</span></span>  
  
-   <span data-ttu-id="96c3a-159">Deixar o banco de dados indisponível até que o principal fique disponível novamente.</span><span class="sxs-lookup"><span data-stu-id="96c3a-159">Leave the database unavailable until the principal becomes available again.</span></span>  
  
     <span data-ttu-id="96c3a-160">Se o banco de dados principal e seu log de transações estiverem intactos, essa escolha preserva todas as transações confirmadas às custas da disponibilidade.</span><span class="sxs-lookup"><span data-stu-id="96c3a-160">If the principal database and its transaction log are intact, this choice preserves all of the committed transactions at the expense of availability.</span></span>  
  
-   <span data-ttu-id="96c3a-161">Interrompa a sessão de espelhamento de banco de dados, atualize manualmente o banco de dados e, então, inicie uma nova sessão de espelhamento de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="96c3a-161">Stop the database mirroring session, manually update the database, and then begin a new database mirroring session.</span></span>  
  
     <span data-ttu-id="96c3a-162">Se o banco de dados principal estiver perdido mas o servidor principal ainda estiver sendo executado, tente imediatamente fazer o backup da parte final do log no banco de dados principal.</span><span class="sxs-lookup"><span data-stu-id="96c3a-162">If the principal database is lost but the principal server is still running, immediately attempt to back up the tail of the log on the principal database.</span></span> <span data-ttu-id="96c3a-163">Se o backup da parte final do log for bem-sucedido, a remoção do espelhamento pode ser a melhor alternativa.</span><span class="sxs-lookup"><span data-stu-id="96c3a-163">If the tail-log backup succeeds, removing mirroring may be your best alternative.</span></span> <span data-ttu-id="96c3a-164">Após a remoção do espelhamento, é possível restaurar o log no banco de dados espelho anterior, que preserva todos os dados.</span><span class="sxs-lookup"><span data-stu-id="96c3a-164">After removing mirroring, you can restore the log onto the former mirror database, which preserves all of the data.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="96c3a-165">Se o backup da parte final do log falhar e você não puder esperar pela recuperação do servidor principal, considere forçar o serviço, que tem a vantagem de manter o estado da sessão.</span><span class="sxs-lookup"><span data-stu-id="96c3a-165">If the tail-log backup failed and you cannot wait for the principal server to recover, consider forcing service, which has the advantage of maintaining the session state.</span></span>  
  
-   <span data-ttu-id="96c3a-166">Serviço forçado (com possível perda de dados) no servidor espelho.</span><span class="sxs-lookup"><span data-stu-id="96c3a-166">Force service (with possible data loss) on the mirror server.</span></span>  
  
     <span data-ttu-id="96c3a-167">O serviço forçado é estritamente um método de recuperação de desastres e deve ser usado com moderação.</span><span class="sxs-lookup"><span data-stu-id="96c3a-167">Forced service is strictly a disaster recovery method and should be used sparingly.</span></span> <span data-ttu-id="96c3a-168">Forçar um serviço é possível somente se o servidor principal não estiver conectado, a sessão for assíncrona (a segurança de transação estiver definida como OFF) e quando a sessão não tiver qualquer testemunha (a propriedade WITNESS estiver definida como OFF) ou a testemunha estiver conectada ao servidor espelho (ou seja, quando houver quorum).</span><span class="sxs-lookup"><span data-stu-id="96c3a-168">Forcing service is possible only if the principal server is down, the session is asynchronous (transaction safety is set to OFF), and either the session does not have any witness (the WITNESS property is set to OFF) or the witness is connected to the mirror server (that is, they have quorum).</span></span>  
  
     <span data-ttu-id="96c3a-169">Forçar um serviço leva o servidor espelho a assumir a função de principal e a disponibilizar sua cópia do banco de dados aos clientes.</span><span class="sxs-lookup"><span data-stu-id="96c3a-169">Forcing service causes the mirror server to assume the role of principal and serve its copy of the database for clients.</span></span> <span data-ttu-id="96c3a-170">Quando o serviço é forçado, quaisquer logs de transação que o principal ainda não tiver enviado ao servidor espelho serão perdidos.</span><span class="sxs-lookup"><span data-stu-id="96c3a-170">When service is forced, whatever transaction logs the principal has not yet sent to the mirror server are lost.</span></span> <span data-ttu-id="96c3a-171">Assim, deve-se limitar o serviço forçado a situações onde a possível perda de dados é aceitável e a disponibilidade imediata do banco de dados é crítica.</span><span class="sxs-lookup"><span data-stu-id="96c3a-171">Therefore, you should limit forced service to situations where possible data loss is acceptable and immediate database availability is critical.</span></span> <span data-ttu-id="96c3a-172">Para obter informações sobre como funciona o serviço forçado e as práticas recomendadas para utilizá-lo, veja [Troca de função durante uma sessão de espelhamento de banco de dados &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="96c3a-172">For information on how forced service works and on best practices for using it, see [Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md).</span></span>  
  
##  <a name="synchronous-database-mirroring-high-safety-mode"></a><a name="Sync"></a> <span data-ttu-id="96c3a-173">Espelhamento de banco de dados síncrono (modo de alta segurança)</span><span class="sxs-lookup"><span data-stu-id="96c3a-173">Synchronous Database Mirroring (High-Safety Mode)</span></span>  
 <span data-ttu-id="96c3a-174">Esta seção descreve como funciona o espelhamento de banco de dados síncronos, inclusive os modos de alta segurança alternativa (com failover automático e sem failover automático), e contém informações sobre a função da testemunha no failover automático.</span><span class="sxs-lookup"><span data-stu-id="96c3a-174">This section describes how synchronous database mirroring works, including the alternative high-safety modes (with automatic failover and without automatic failover), and contains information about the role of the witness in automatic failover.</span></span>  
  
 <span data-ttu-id="96c3a-175">Quando a segurança de transação é definida como FULL, a sessão de espelhamento de banco de dados é executada no modo de segurança alta e opera de forma síncrona depois de uma fase de sincronização inicial.</span><span class="sxs-lookup"><span data-stu-id="96c3a-175">When transaction safety is set to FULL, the database mirroring session runs in high-safety mode and operates synchronously after an initial synchronizing phase.</span></span> <span data-ttu-id="96c3a-176">Esta seção descreve os detalhes das sessões de espelhamento de banco de dados configuradas para operação síncrona.</span><span class="sxs-lookup"><span data-stu-id="96c3a-176">This section describes the details of database mirroring sessions that are configured for synchronous operation.</span></span>  
  
 <span data-ttu-id="96c3a-177">Para realizar a operação síncrona de uma sessão, o servidor espelho deve sincronizar o banco de dados espelho com o banco de dados principal.</span><span class="sxs-lookup"><span data-stu-id="96c3a-177">To achieve synchronous operation for a session, the mirror server must synchronize the mirror database with the principal database.</span></span> <span data-ttu-id="96c3a-178">Quando a sessão é iniciada, o servidor principal começa a enviar seu log ativo ao servidor espelho.</span><span class="sxs-lookup"><span data-stu-id="96c3a-178">When the session begins, the principal server begins sending its active log to the mirror server.</span></span> <span data-ttu-id="96c3a-179">O servidor espelho grava todos os registros de log de entrada no disco o mais rápido possível.</span><span class="sxs-lookup"><span data-stu-id="96c3a-179">The mirror server writes all of the incoming log records to disk as quickly as possible.</span></span> <span data-ttu-id="96c3a-180">Assim que todos os registros de log recebidos são gravados no disco, os bancos de dados são sincronizados.</span><span class="sxs-lookup"><span data-stu-id="96c3a-180">As soon as all of the received log records have been written to disk, the databases are synchronized.</span></span> <span data-ttu-id="96c3a-181">Contanto que os parceiros permaneçam em comunicação, os bancos de dados permanecem sincronizados.</span><span class="sxs-lookup"><span data-stu-id="96c3a-181">As long as the partners remain in communication, the databases remain synchronized.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="96c3a-182">Para monitorar alterações de estado em uma sessão de espelhamento de banco de dados, use a classe de evento **Database Mirroring State Change** .</span><span class="sxs-lookup"><span data-stu-id="96c3a-182">To monitor state changes in a database mirroring session, use the **Database Mirroring State Change** event class.</span></span> <span data-ttu-id="96c3a-183">Para obter mais informações, consulte [Database Mirroring State Change Event Class](../../relational-databases/event-classes/database-mirroring-state-change-event-class.md).</span><span class="sxs-lookup"><span data-stu-id="96c3a-183">For more information, see [Database Mirroring State Change Event Class](../../relational-databases/event-classes/database-mirroring-state-change-event-class.md).</span></span>  
  
 <span data-ttu-id="96c3a-184">Depois de concluída a sincronização, toda transação confirmada no banco de dados principal também é confirmada no servidor espelho, garantindo a proteção dos dados.</span><span class="sxs-lookup"><span data-stu-id="96c3a-184">After synchronization finishes, every transaction committed on the principal database is also committed on the mirror server, guaranteeing protection of the data.</span></span> <span data-ttu-id="96c3a-185">Isso é feito esperando a confirmação de uma transação no banco de dados principal, até o servidor principal receber uma mensagem do servidor espelho declarando que intensificou o log da transação no disco.</span><span class="sxs-lookup"><span data-stu-id="96c3a-185">This is achieved by waiting to commit a transaction on the principal database, until the principal server receives a message from the mirror server stating that it has hardened the transaction's log to disk.</span></span> <span data-ttu-id="96c3a-186">Observe que a espera por essa mensagem aumenta a latência da transação.</span><span class="sxs-lookup"><span data-stu-id="96c3a-186">Note the wait for this message increases the latency of the transaction.</span></span>  
  
 <span data-ttu-id="96c3a-187">O tempo necessário para a sincronização depende essencialmente do atraso do banco de dados espelho em relação ao banco de dados principal no início da sessão (medido inicialmente pelo número de registros de log recebido do servidor principal), da carga de trabalho no banco de dados principal e da velocidade do sistema espelho.</span><span class="sxs-lookup"><span data-stu-id="96c3a-187">The time required for synchronization depends essentially on how far the mirror database was behind the principal database at the start of the session (measured by the number of log records initially received from the principal server), the work load on the principal database, and the speed of the mirror system.</span></span> <span data-ttu-id="96c3a-188">Depois que uma sessão é sincronizada, o log intensificado que ainda precisar ser refeito no banco de dados espelho continuará na fila de restauração.</span><span class="sxs-lookup"><span data-stu-id="96c3a-188">After a session is synchronized, the hardened log that has yet to be redone on the mirror database remains in the redo queue.</span></span>  
  
 <span data-ttu-id="96c3a-189">Assim que o banco de dados espelho for sincronizado, o estado de ambas as cópias do banco de dados será alterado para SYNCHRONIZED.</span><span class="sxs-lookup"><span data-stu-id="96c3a-189">As soon as the mirror database becomes synchronized, the state of both the copies of the database changes to SYNCHRONIZED.</span></span>  
  
 <span data-ttu-id="96c3a-190">A operação síncrona é mantida da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="96c3a-190">Synchronous operation is maintained in the following manner:</span></span>  
  
1.  <span data-ttu-id="96c3a-191">Durante o recebimento de uma transação de um cliente, o servidor principal grava o log da transação no log de transações.</span><span class="sxs-lookup"><span data-stu-id="96c3a-191">On receiving a transaction from a client, the principal server writes the log for the transaction to the transaction log.</span></span>  
  
2.  <span data-ttu-id="96c3a-192">O servidor principal grava a transação no banco de dados e, simultaneamente, envia o registro de log ao servidor espelho.</span><span class="sxs-lookup"><span data-stu-id="96c3a-192">The principal server writes the transaction to the database and, concurrently, sends the log record to the mirror server.</span></span> <span data-ttu-id="96c3a-193">O servidor principal espera uma confirmação do servidor espelho antes de confirmar qualquer uma das operações a seguir ao cliente: uma reversão ou uma confirmação de transação.</span><span class="sxs-lookup"><span data-stu-id="96c3a-193">The principal server waits for an acknowledgement from the mirror server before confirming either of the following to the client: a transaction commit or a rollback.</span></span>  
  
3.  <span data-ttu-id="96c3a-194">O servidor espelho intensifica o log do disco e retorna uma confirmação ao servidor principal.</span><span class="sxs-lookup"><span data-stu-id="96c3a-194">The mirror server hardens the log to disk and returns an acknowledgement to the principal server.</span></span>  
  
4.  <span data-ttu-id="96c3a-195">Durante o recebimento da confirmação do servidor espelho, o servidor principal envia uma mensagem de confirmação ao cliente.</span><span class="sxs-lookup"><span data-stu-id="96c3a-195">On receiving the acknowledgement from the mirror server, the principal server sends a confirmation message to the client.</span></span>  
  
 <span data-ttu-id="96c3a-196">O modo de segurança alta protege seus dados exigindo a sincronização dos dados entre dois locais.</span><span class="sxs-lookup"><span data-stu-id="96c3a-196">High-safety mode protects your data by requiring the data to be synchronized between two places.</span></span> <span data-ttu-id="96c3a-197">Todas as transações confirmadas estão garantidas para serem gravadas no disco do servidor espelho.</span><span class="sxs-lookup"><span data-stu-id="96c3a-197">All the committed transactions are guaranteed to be written to disk on the mirror server.</span></span>  
  

  
###  <a name="high-safety-mode-without-automatic-failover"></a><a name="HighSafetyWithOutAutoFailover"></a> <span data-ttu-id="96c3a-198">Modo de segurança alta sem failover automático</span><span class="sxs-lookup"><span data-stu-id="96c3a-198">High-Safety Mode Without Automatic Failover</span></span>  
 <span data-ttu-id="96c3a-199">A figura a seguir mostra a configuração do modo de segurança alta sem failover automático.</span><span class="sxs-lookup"><span data-stu-id="96c3a-199">The following figure shows the configuration of high-safety mode without automatic failover.</span></span> <span data-ttu-id="96c3a-200">A configuração consiste apenas nos dois parceiros.</span><span class="sxs-lookup"><span data-stu-id="96c3a-200">The configuration consists of only the two partners.</span></span>  
  
 <span data-ttu-id="96c3a-201">![Comunicação de parceiros sem uma testemunha](../media/dbm-high-protection-mode.gif "Comunicação de parceiros sem uma testemunha")</span><span class="sxs-lookup"><span data-stu-id="96c3a-201">![Partners communicating without a witness](../media/dbm-high-protection-mode.gif "Partners communicating without a witness")</span></span>  
  
 <span data-ttu-id="96c3a-202">Quando os parceiros estão conectados e o banco de dados já está sincronizado, há suporte ao failover manual.</span><span class="sxs-lookup"><span data-stu-id="96c3a-202">When the partners are connected and the database is already synchronized, manual failover is supported.</span></span> <span data-ttu-id="96c3a-203">Se a instância de servidor espelho diminuir, a instância de servidor principal não será afetada e as execuções serão expostas (ou seja, sem espelhamento dos dados).</span><span class="sxs-lookup"><span data-stu-id="96c3a-203">If the mirror server instance goes down, the principal server instance is unaffected and runs exposed (that is without mirroring the data).</span></span> <span data-ttu-id="96c3a-204">Se o servidor principal estiver perdido, o espelho será suspenso, mas o serviço poderá ser forçado para o servidor espelho (com possível perda de dados).</span><span class="sxs-lookup"><span data-stu-id="96c3a-204">If the principal server is lost, the mirror is suspended, but service can be forced to the mirror server (with possible data loss).</span></span> <span data-ttu-id="96c3a-205">Para obter mais informações, consulte [Troca de função durante uma sessão de espelhamento de banco de dados &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="96c3a-205">For more information, see [Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md).</span></span>  
  
###  <a name="high-safety-mode-with-automatic-failover"></a><a name="HighSafetyWithAutoFailover"></a> <span data-ttu-id="96c3a-206">Modo de segurança alta com failover automático</span><span class="sxs-lookup"><span data-stu-id="96c3a-206">High-Safety Mode with Automatic Failover</span></span>  
 <span data-ttu-id="96c3a-207">O failover automático fornece alta disponibilidade, assegurando que o banco de dados ainda funcione depois da perda de um servidor.</span><span class="sxs-lookup"><span data-stu-id="96c3a-207">Automatic failover provides high availability by ensuring that the database is still served after the loss of one server.</span></span> <span data-ttu-id="96c3a-208">O failover automático exige que a sessão tenha uma terceira instância de servidor, a *testemunha*que, idealmente, reside em um terceiro computador.</span><span class="sxs-lookup"><span data-stu-id="96c3a-208">Automatic failover requires that the session possess a third server instance, the *witness*, which ideally resides on a third computer.</span></span> <span data-ttu-id="96c3a-209">A figura a seguir mostra a configuração da sessão do modo de segurança alta que oferece suporte a failover automático.</span><span class="sxs-lookup"><span data-stu-id="96c3a-209">The following figure shows the configuration of a high-safety mode session that supports automatic failover.</span></span>  
  
 <span data-ttu-id="96c3a-210">![A testemunha e dois parceiros de uma sessão](../media/dbm-high-availability-mode.gif "A testemunha e dois parceiros de uma sessão")</span><span class="sxs-lookup"><span data-stu-id="96c3a-210">![The witness and two partners of a session](../media/dbm-high-availability-mode.gif "The witness and two partners of a session")</span></span>  
  
 <span data-ttu-id="96c3a-211">Ao contrário dos dois parceiros, a testemunha não atende ao banco de dados.</span><span class="sxs-lookup"><span data-stu-id="96c3a-211">Unlike the two partners, the witness does not serve the database.</span></span> <span data-ttu-id="96c3a-212">A testemunha simplesmente oferece suporte a failover automático verificando se o servidor principal está funcionando.</span><span class="sxs-lookup"><span data-stu-id="96c3a-212">The witness simply supports automatic failover by verifying whether the principal server is up and functioning.</span></span> <span data-ttu-id="96c3a-213">O servidor espelho apenas iniciará o failover automático se o espelho e a testemunha permanecerem conectados um ao outro depois de serem desconectados do servidor principal.</span><span class="sxs-lookup"><span data-stu-id="96c3a-213">The mirror server initiates automatic failover only if the mirror and the witness remain connected to each other after both have been disconnected from the principal server.</span></span>  
  
 <span data-ttu-id="96c3a-214">Quando uma testemunha é definida, a sessão exige *quorum* – uma relação entre pelo menos duas instâncias de servidor que permita disponibilizar o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="96c3a-214">When a witness is set, the session requires *quorum*-a relationship between at least two server instances that allows the database to be made available.</span></span> <span data-ttu-id="96c3a-215">Para obter mais informações, veja [Testemunha de espelhamento de banco de dados](database-mirroring-witness.md) e [Quorum: Como uma testemunha afeta a disponibilidade do banco de dados &#40;Espelhamento de Banco de Dados&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span><span class="sxs-lookup"><span data-stu-id="96c3a-215">For more information, see [Database Mirroring Witness](database-mirroring-witness.md) and [Quorum: How a Witness Affects Database Availability &#40;Database Mirroring&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span></span>  
  
 <span data-ttu-id="96c3a-216">O failover automático exige as seguintes condições:</span><span class="sxs-lookup"><span data-stu-id="96c3a-216">Automatic failover requires the following conditions:</span></span>  
  
-   <span data-ttu-id="96c3a-217">O banco de dados já esteja sincronizado.</span><span class="sxs-lookup"><span data-stu-id="96c3a-217">The database is already synchronized.</span></span>  
  
-   <span data-ttu-id="96c3a-218">A falha ocorra quando todas as três instâncias de servidor estejam conectadas, e a testemunha e o servidor espelho permaneçam conectados.</span><span class="sxs-lookup"><span data-stu-id="96c3a-218">The failure occurs while all three server instances are connected, and the witness and mirror server remain connected.</span></span>  
  
 <span data-ttu-id="96c3a-219">A perda de um parceiro tem o seguinte efeito:</span><span class="sxs-lookup"><span data-stu-id="96c3a-219">The loss of a partner has the following effect:</span></span>  
  
-   <span data-ttu-id="96c3a-220">Se o servidor principal ficar indisponível nas condições anteriores, acontecerá o failover automático.</span><span class="sxs-lookup"><span data-stu-id="96c3a-220">If the principal server becomes unavailable under the above conditions, automatic failover occurs.</span></span> <span data-ttu-id="96c3a-221">O servidor espelho é alternado para a função principal e oferece seu banco de dados como banco de dados principal.</span><span class="sxs-lookup"><span data-stu-id="96c3a-221">The mirror server switches to the role of principal, and it offers its database as the principal database.</span></span>  
  
-   <span data-ttu-id="96c3a-222">Se o servidor principal ficar indisponível quando essas condições não forem atendidas, será possível forçar o serviço (com possível perda de dados).</span><span class="sxs-lookup"><span data-stu-id="96c3a-222">If the principal server becomes unavailable when those conditions are not met, forcing service (with possible data loss) might be possible.</span></span> <span data-ttu-id="96c3a-223">Para obter mais informações, consulte [Troca de função durante uma sessão de espelhamento de banco de dados &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="96c3a-223">For more information, see [Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md).</span></span>  
  
-   <span data-ttu-id="96c3a-224">Se apenas o servidor espelho ficar indisponível, o principal e a testemunha continuarão funcionando.</span><span class="sxs-lookup"><span data-stu-id="96c3a-224">If the only mirror server becomes unavailable, the principal and witness continue.</span></span>  
  
 <span data-ttu-id="96c3a-225">Se a sessão perder a testemunha, o quorum exigirá ambos os parceiros.</span><span class="sxs-lookup"><span data-stu-id="96c3a-225">If the session loses its witness, quorum requires both partners.</span></span> <span data-ttu-id="96c3a-226">Se qualquer parceiro perder quorum, ambos os parceiros perderão quorum e o banco de dados ficará indisponível até que o quorum seja restabelecido.</span><span class="sxs-lookup"><span data-stu-id="96c3a-226">If either partner loses quorum, both partners lose quorum, and the database becomes unavailable until quorum is re-established.</span></span> <span data-ttu-id="96c3a-227">Esse requisito de quorum garante que na ausência de uma testemunha o banco de dados nunca será executado *exposto*, ou seja, sem ser espelhado.</span><span class="sxs-lookup"><span data-stu-id="96c3a-227">This quorum requirement makes sure that in the absence of a witness the database never runs *exposed*, that is without being mirrored.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="96c3a-228">Se você espera que a testemunha permaneça desconectada por um tempo significativo, recomendamos que você remova a testemunha da sessão até ela ficar disponível.</span><span class="sxs-lookup"><span data-stu-id="96c3a-228">If you expect the witness to remain disconnected for a significant amount of time, we recommend that you remove the witness from the session until it becomes available.</span></span>  
  
##  <a name="transact-sql-settings-and-database-mirroring-operating-modes"></a><a name="TsqlSettingsAndOpModes"></a> <span data-ttu-id="96c3a-229">Configurações Transact-SQL e modos de operação de espelhamento de banco de dados</span><span class="sxs-lookup"><span data-stu-id="96c3a-229">Transact-SQL Settings and Database Mirroring Operating Modes</span></span>  
 <span data-ttu-id="96c3a-230">Esta seção descreve uma sessão de espelhamento de banco de dados em termos das configurações de ALTER DATABASE e dos estados do banco de dados espelho e da testemunha, se houver.</span><span class="sxs-lookup"><span data-stu-id="96c3a-230">This section describes a database mirroring session in terms of the ALTER DATABASE settings and states of the mirrored database and witness, if any.</span></span> <span data-ttu-id="96c3a-231">A seção destina-se a usuários que administram o espelhamento de banco de dados usando sobretudo ou exclusivamente o [!INCLUDE[tsql](../../includes/tsql-md.md)], em vez de usar o [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span><span class="sxs-lookup"><span data-stu-id="96c3a-231">The section is aimed at users who manage database mirroring primarily or exclusively using [!INCLUDE[tsql](../../includes/tsql-md.md)], rather than using [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="96c3a-232">Como alternativa ao uso do [!INCLUDE[tsql](../../includes/tsql-md.md)], é possível controlar o modo de operação de uma sessão no Pesquisador de Objetos usando a página **Espelhamento** da caixa de diálogo **Propriedades do Banco de Dados** .</span><span class="sxs-lookup"><span data-stu-id="96c3a-232">As an alternative to using [!INCLUDE[tsql](../../includes/tsql-md.md)], you can control the operating mode of a session in Object Explorer using the **Mirroring** page of the **Database Properties** dialog box.</span></span> <span data-ttu-id="96c3a-233">Para obter mais informações, veja [Estabelecer uma sessão de espelhamento de banco de dados usando a Autenticação do Windows &#40;SQL Server Management Studio&#41;](establish-database-mirroring-session-windows-authentication.md).</span><span class="sxs-lookup"><span data-stu-id="96c3a-233">For more information, see [Establish a Database Mirroring Session Using Windows Authentication &#40;SQL Server Management Studio&#41;](establish-database-mirroring-session-windows-authentication.md).</span></span>  
  

  
###  <a name="how-transaction-safety-and-witness-state-affect-the-operating-mode"></a><a name="TxnSafetyAndWitness"></a> <span data-ttu-id="96c3a-234">Como a segurança de transação e estado da testemunha afetam o modo de operação</span><span class="sxs-lookup"><span data-stu-id="96c3a-234">How Transaction Safety and Witness State Affect the Operating Mode</span></span>  
 <span data-ttu-id="96c3a-235">O modo de operação de uma sessão é determinado pela combinação da configuração de sua segurança de transação e do estado da testemunha.</span><span class="sxs-lookup"><span data-stu-id="96c3a-235">The operating mode of a session is determined by the combination of its transaction safety setting and the state of the witness.</span></span> <span data-ttu-id="96c3a-236">A qualquer momento, o proprietário do banco de dados pode alterar o nível de segurança de transação e pode adicionar ou remover a testemunha.</span><span class="sxs-lookup"><span data-stu-id="96c3a-236">At any time, the database owner can change the transaction safety level, and can add or remove the witness.</span></span>  
  

  
####  <a name="transaction-safety"></a><a name="TxnSafety"></a> <span data-ttu-id="96c3a-237">Transaction Safety</span><span class="sxs-lookup"><span data-stu-id="96c3a-237">Transaction Safety</span></span>  
 <span data-ttu-id="96c3a-238">Segurança de transação é uma propriedade de banco de dados específica de espelhamento que determina se uma sessão de espelhamento de banco de dados opera de forma síncrona ou assíncrona.</span><span class="sxs-lookup"><span data-stu-id="96c3a-238">Transaction safety is a mirroring-specific database property that determines whether a database mirroring session operates synchronously or asynchronously.</span></span> <span data-ttu-id="96c3a-239">Há dois níveis de segurança: COMPLETO e DESLIGADO.</span><span class="sxs-lookup"><span data-stu-id="96c3a-239">There are two safety levels: FULL and OFF.</span></span>  
  
-   <span data-ttu-id="96c3a-240">SAFETY FULL</span><span class="sxs-lookup"><span data-stu-id="96c3a-240">SAFETY FULL</span></span>  
  
     <span data-ttu-id="96c3a-241">Segurança de transação completa faz a sessão operar sincronicamente em modo de segurança alta.</span><span class="sxs-lookup"><span data-stu-id="96c3a-241">Full transaction safety causes the session to operate synchronously in high-safety mode.</span></span> <span data-ttu-id="96c3a-242">Se uma testemunha estiver presente, uma sessão oferece suporte a failover automático.</span><span class="sxs-lookup"><span data-stu-id="96c3a-242">If a witness is present, a session supports automatic failover.</span></span>  
  
     <span data-ttu-id="96c3a-243">Quando se estabelece uma sessão utilizando instruções ALTER DATABASE, a sessão começa com a propriedade SAFETY configurada como FULL; ou seja, a sessão começa em modo de alta segurança.</span><span class="sxs-lookup"><span data-stu-id="96c3a-243">When you establish a session using ALTER DATABASE statements, the session begins with the SAFETY property set to FULL; that is, the session begins in high-safety mode.</span></span> <span data-ttu-id="96c3a-244">Após o início da sessão, é possível adicionar uma testemunha.</span><span class="sxs-lookup"><span data-stu-id="96c3a-244">After the session begins, you can add a witness.</span></span>  
  
     <span data-ttu-id="96c3a-245">Para obter mais informações, veja [Espelhamento de banco de dados Síncrono (modo de segurança alta)](#Sync), anteriormente neste tópico.</span><span class="sxs-lookup"><span data-stu-id="96c3a-245">For more information, see [Synchronous Database Mirroring (High-Safety Mode)](#Sync), earlier in this topic.</span></span>  
  
-   <span data-ttu-id="96c3a-246">SAFETY OFF</span><span class="sxs-lookup"><span data-stu-id="96c3a-246">SAFETY OFF</span></span>  
  
     <span data-ttu-id="96c3a-247">A desativação da segurança de transação faz a sessão operar de forma assíncrona, em modo de alto desempenho.</span><span class="sxs-lookup"><span data-stu-id="96c3a-247">Turning off transaction safety causes the session to operate asynchronously, in high-performance mode.</span></span> <span data-ttu-id="96c3a-248">Se a propriedade SAFETY for definida como OFF, a propriedade WITNESS também deve ser definida como OFF (o padrão).</span><span class="sxs-lookup"><span data-stu-id="96c3a-248">If the SAFETY property is set to OFF, the WITNESS property should also be set to OFF (the default).</span></span> <span data-ttu-id="96c3a-249">Para obter informações sobre o impacto da testemunha no modo de alto desempenho, veja [O estado da testemunha](#WitnessState), mais adiante neste tópico.</span><span class="sxs-lookup"><span data-stu-id="96c3a-249">For information about the impact of the witness in high-performance mode, see [The State of the Witness](#WitnessState), later in this topic.</span></span> <span data-ttu-id="96c3a-250">Para obter mais informações sobre como executar com a segurança de transação desligada, veja [Espelhamento de banco de dados Assíncrono (Modo de alto desempenho)](#VisualElement), anteriormente neste tópico.</span><span class="sxs-lookup"><span data-stu-id="96c3a-250">For more information about running with transaction safety turned off, see [Asynchronous Database Mirroring (High-Performance Mode)](#VisualElement), earlier in this topic.</span></span>  
  
 <span data-ttu-id="96c3a-251">A configuração de segurança de transação do banco de dados é registrada em cada parceiro na exibição de catálogo **sys.database_mirroring** nas colunas **mirroring_safety_level** e **mirroring_safety_level_desc**.</span><span class="sxs-lookup"><span data-stu-id="96c3a-251">The transaction safety setting of the database is recorded on each partner in the **sys.database_mirroring** catalog view in the **mirroring_safety_level** and **mirroring_safety_level_desc** columns.</span></span> <span data-ttu-id="96c3a-252">Para obter mais informações, veja [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="96c3a-252">For more information, see [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql).</span></span>  
  
 <span data-ttu-id="96c3a-253">A qualquer momento, o proprietário do banco de dados pode alterar o nível de segurança da transação.</span><span class="sxs-lookup"><span data-stu-id="96c3a-253">The database owner can change the transaction safety level at any time.</span></span>  
  
####  <a name="the-state-of-the-witness"></a><a name="WitnessState"></a> <span data-ttu-id="96c3a-254">O estado da testemunha</span><span class="sxs-lookup"><span data-stu-id="96c3a-254">The State of the Witness</span></span>  
 <span data-ttu-id="96c3a-255">Se uma testemunha tiver sido definida, é necessário quorum, para que o estado da testemunha seja sempre significativo.</span><span class="sxs-lookup"><span data-stu-id="96c3a-255">If a witness has been set, quorum is required, so the state of the witness is always significant.</span></span>  
  
 <span data-ttu-id="96c3a-256">Se existir, a testemunha terá um dos dois estados:</span><span class="sxs-lookup"><span data-stu-id="96c3a-256">If it exists, the witness has one of two states:</span></span>  
  
-   <span data-ttu-id="96c3a-257">Quando a testemunha está conectada a um parceiro, a testemunha está no estado CONNECTED com relação àquele parceiro e tem quorum com aquele parceiro.</span><span class="sxs-lookup"><span data-stu-id="96c3a-257">When the witness is connected to a partner, the witness is in the CONNECTED state relative to that partner and has quorum with that partner.</span></span> <span data-ttu-id="96c3a-258">Nesse caso, o banco de dados pode ser disponibilizado, mesmo se um dos parceiros estiver indisponível.</span><span class="sxs-lookup"><span data-stu-id="96c3a-258">In this case, the database can be made available, even if one of the partners is unavailable.</span></span>  
  
-   <span data-ttu-id="96c3a-259">Quando a testemunha existe mas não está conectada a um parceiro, a testemunha está no estado UNKNOWN com relação àquele parceiro.</span><span class="sxs-lookup"><span data-stu-id="96c3a-259">When the witness exists but is not connected to a partner, the witness is in the UNKOWN or DISCONNECTED state relative to that partner.</span></span> <span data-ttu-id="96c3a-260">Nesse caso, a testemunha não tem quorum com aquele parceiro e se os parceiros não estiverem conectados entre si, o banco de dados fica indisponível.</span><span class="sxs-lookup"><span data-stu-id="96c3a-260">In this case, the witness lacks quorum with that partner, and if the partners are not connected to each other, the database becomes unavailable.</span></span>  
  
 <span data-ttu-id="96c3a-261">Para obter mais informações sobre quorum, veja [Quorum: Como uma testemunha afeta a disponibilidade do banco de dados &#40;Espelhamento de Banco de Dados&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span><span class="sxs-lookup"><span data-stu-id="96c3a-261">For information about quorum, see [Quorum: How a Witness Affects Database Availability &#40;Database Mirroring&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span></span>  
  
 <span data-ttu-id="96c3a-262">O estado de cada testemunha em uma instância do servidor é registrado na exibição de catálogo **sys.database_mirroring** nas colunas **mirroring_witness_state** e **mirroring_witness_state_desc**.</span><span class="sxs-lookup"><span data-stu-id="96c3a-262">The state of each witness on a server instance is recorded in the **sys.database_mirroring** catalog view in the **mirroring_witness_state** and **mirroring_witness_state_desc** columns.</span></span> <span data-ttu-id="96c3a-263">Para obter mais informações, veja [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="96c3a-263">For more information, see [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql).</span></span>  
  
 <span data-ttu-id="96c3a-264">A tabela a seguir apresenta um resumo de como o modo de operação de uma sessão depende da configuração de sua segurança de transação e do estado da testemunha.</span><span class="sxs-lookup"><span data-stu-id="96c3a-264">The following table summarizes how the operating mode of a session depends upon its transaction safety setting and on state of the witness.</span></span>  
  
|<span data-ttu-id="96c3a-265">Modo de operação</span><span class="sxs-lookup"><span data-stu-id="96c3a-265">Operating mode</span></span>|<span data-ttu-id="96c3a-266">Segurança de transação</span><span class="sxs-lookup"><span data-stu-id="96c3a-266">Transaction safety</span></span>|<span data-ttu-id="96c3a-267">Estado de testemunha</span><span class="sxs-lookup"><span data-stu-id="96c3a-267">Witness state</span></span>|  
|--------------------|------------------------|-------------------|  
|<span data-ttu-id="96c3a-268">Modo de alto desempenho</span><span class="sxs-lookup"><span data-stu-id="96c3a-268">High-performance mode</span></span>|<span data-ttu-id="96c3a-269">OFF</span><span class="sxs-lookup"><span data-stu-id="96c3a-269">OFF</span></span>|<span data-ttu-id="96c3a-270">NULL (sem testemunha)<sup>2</sup></span><span class="sxs-lookup"><span data-stu-id="96c3a-270">NULL (no witness)<sup>2</sup></span></span>|  
|<span data-ttu-id="96c3a-271">Modo de segurança alta sem failover automático</span><span class="sxs-lookup"><span data-stu-id="96c3a-271">High-safety mode without automatic failover</span></span>|<span data-ttu-id="96c3a-272">FULL</span><span class="sxs-lookup"><span data-stu-id="96c3a-272">FULL</span></span>|<span data-ttu-id="96c3a-273">NULL (nenhuma testemunha)</span><span class="sxs-lookup"><span data-stu-id="96c3a-273">NULL (no witness)</span></span>|  
|<span data-ttu-id="96c3a-274">Modo de segurança alta com failover automático<sup>1</sup></span><span class="sxs-lookup"><span data-stu-id="96c3a-274">High-safety mode with automatic failover<sup>1</sup></span></span>|<span data-ttu-id="96c3a-275">FULL</span><span class="sxs-lookup"><span data-stu-id="96c3a-275">FULL</span></span>|<span data-ttu-id="96c3a-276">CONNECTED</span><span class="sxs-lookup"><span data-stu-id="96c3a-276">CONNECTED</span></span>|  
  
 <span data-ttu-id="96c3a-277"><sup>1</sup> se a testemunha for desconectada, recomendamos que você defina testemunha desativada até que a instância do servidor testemunha se torne disponível.</span><span class="sxs-lookup"><span data-stu-id="96c3a-277"><sup>1</sup> If the witness becomes disconnected, we recommend that you set WITNESS OFF until the witness server instance becomes available.</span></span>  
  
 <span data-ttu-id="96c3a-278"><sup>2</sup> se uma testemunha estiver presente no modo de alto desempenho, a testemunha não participará da sessão.</span><span class="sxs-lookup"><span data-stu-id="96c3a-278"><sup>2</sup> If a witness is present in high-performance mode, the witness does not participate in the session.</span></span> <span data-ttu-id="96c3a-279">Porém, para tornar o banco de dados disponível, pelo menos duas das instâncias do servidor devem permanecer conectadas.</span><span class="sxs-lookup"><span data-stu-id="96c3a-279">However, to make the database available, at least two of the server instances must remain connected.</span></span> <span data-ttu-id="96c3a-280">Portanto, recomendamos manter a propriedade WITNESS definida como OFF em sessões de modo de desempenho alto.</span><span class="sxs-lookup"><span data-stu-id="96c3a-280">Therefore, we recommend keeping the WITNESS property set to OFF in high-performance mode sessions.</span></span> <span data-ttu-id="96c3a-281">Para obter mais informações, confira [Quorum: Como uma testemunha afeta a disponibilidade do banco de dados &#40;Espelhamento de Banco de Dados&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span><span class="sxs-lookup"><span data-stu-id="96c3a-281">For more information, see [Quorum: How a Witness Affects Database Availability &#40;Database Mirroring&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span></span>  
  
###  <a name="viewing-the-safety-setting-and-state-of-the-witness"></a><a name="ViewWitness"></a> <span data-ttu-id="96c3a-282">Exibindo a configuração de segurança e estado da testemunha</span><span class="sxs-lookup"><span data-stu-id="96c3a-282">Viewing the Safety Setting and State of the Witness</span></span>  
 <span data-ttu-id="96c3a-283">Para exibir a configuração de segurança e o estado da testemunha para um banco de dados, use a exibição de catálogo **sys.database_mirroring** .</span><span class="sxs-lookup"><span data-stu-id="96c3a-283">To view the safety setting and the state of the witness for a database, use the **sys.database_mirroring** catalog view.</span></span> <span data-ttu-id="96c3a-284">As colunas relevantes são as seguintes:</span><span class="sxs-lookup"><span data-stu-id="96c3a-284">The relevant columns are as follows:</span></span>  
  
|<span data-ttu-id="96c3a-285">Fator</span><span class="sxs-lookup"><span data-stu-id="96c3a-285">Factor</span></span>|<span data-ttu-id="96c3a-286">Colunas</span><span class="sxs-lookup"><span data-stu-id="96c3a-286">Columns</span></span>|<span data-ttu-id="96c3a-287">Descrição</span><span class="sxs-lookup"><span data-stu-id="96c3a-287">Description</span></span>|  
|------------|-------------|-----------------|  
|<span data-ttu-id="96c3a-288">Segurança de transação</span><span class="sxs-lookup"><span data-stu-id="96c3a-288">Transaction safety</span></span>|<span data-ttu-id="96c3a-289">**mirroring_safety_level** ou **mirroring_safety_level_desc**</span><span class="sxs-lookup"><span data-stu-id="96c3a-289">**mirroring_safety_level** or **mirroring_safety_level_desc**</span></span>|<span data-ttu-id="96c3a-290">Configuração de segurança de transação para atualizações no banco de dados espelho, um dos seguintes:</span><span class="sxs-lookup"><span data-stu-id="96c3a-290">Transaction safety setting for updates on the mirror database, one of:</span></span><br /><br /> <span data-ttu-id="96c3a-291">DESCONHECIDO</span><span class="sxs-lookup"><span data-stu-id="96c3a-291">UNKNOWN</span></span><br /><br /> <span data-ttu-id="96c3a-292">OFF</span><span class="sxs-lookup"><span data-stu-id="96c3a-292">OFF</span></span><br /><br /> <span data-ttu-id="96c3a-293">FULL</span><span class="sxs-lookup"><span data-stu-id="96c3a-293">FULL</span></span><br /><br /> <span data-ttu-id="96c3a-294">NULL = banco de dados não está online.</span><span class="sxs-lookup"><span data-stu-id="96c3a-294">NULL= database is not online.</span></span>|  
|<span data-ttu-id="96c3a-295">Existe uma testemunha?</span><span class="sxs-lookup"><span data-stu-id="96c3a-295">Does a witness exist?</span></span>|<span data-ttu-id="96c3a-296">**mirroring_witness_name**</span><span class="sxs-lookup"><span data-stu-id="96c3a-296">**mirroring_witness_name**</span></span>|<span data-ttu-id="96c3a-297">Nome do servidor de testemunha de espelhamento de banco de dados ou NULL, indicando que não existe testemunha.</span><span class="sxs-lookup"><span data-stu-id="96c3a-297">Server name of the database mirroring witness or NULL, indicating that no witness exists.</span></span>|  
|<span data-ttu-id="96c3a-298">Estado de testemunha</span><span class="sxs-lookup"><span data-stu-id="96c3a-298">Witness state</span></span>|<span data-ttu-id="96c3a-299">**mirroring_witness_state** ou **mirroring_witness_state_desc**</span><span class="sxs-lookup"><span data-stu-id="96c3a-299">**mirroring_witness_state** or **mirroring_witness_state_desc**</span></span>|<span data-ttu-id="96c3a-300">Estado da testemunha no banco de dados em um determinado parceiro:</span><span class="sxs-lookup"><span data-stu-id="96c3a-300">State of the witness in the database on a given partner:</span></span><br /><br /> <span data-ttu-id="96c3a-301">DESCONHECIDO</span><span class="sxs-lookup"><span data-stu-id="96c3a-301">UNKNOWN</span></span><br /><br /> <span data-ttu-id="96c3a-302">CONNECTED</span><span class="sxs-lookup"><span data-stu-id="96c3a-302">CONNECTED</span></span><br /><br /> <span data-ttu-id="96c3a-303">DISCONNECTED</span><span class="sxs-lookup"><span data-stu-id="96c3a-303">DISCONNECTED</span></span><br /><br /> <span data-ttu-id="96c3a-304">NULL = não existe testemunha ou o banco de dados não está online.</span><span class="sxs-lookup"><span data-stu-id="96c3a-304">NULL = no witness exists or the database is not online.</span></span>|  
  
 <span data-ttu-id="96c3a-305">Por exemplo, no servidor principal ou espelho, digite:</span><span class="sxs-lookup"><span data-stu-id="96c3a-305">For example, on either the principal or mirror server, enter:</span></span>  
  
```  
SELECT mirroring_safety_level_desc, mirroring_witness_name, mirroring_witness_state_desc FROM sys.database_mirroring  
```  
  
 <span data-ttu-id="96c3a-306">Para obter mais informações sobre essa exibição de catálogo, veja [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="96c3a-306">For more information about this catalog view, see [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql).</span></span>  
  
###  <a name="factors-affecting-behavior-on-loss-of-the-principal-server"></a><a name="FactorsOnLossOfPrincipal"></a> <span data-ttu-id="96c3a-307">Fatores que afetam o comportamento na perda do servidor principal</span><span class="sxs-lookup"><span data-stu-id="96c3a-307">Factors Affecting Behavior on Loss of the Principal Server</span></span>  
 <span data-ttu-id="96c3a-308">A tabela a seguir apresenta um resumo do efeito combinado da configuração de segurança de transação, do estado do banco de dados e do estado da testemunha sobre o comportamento de uma sessão de espelhamento na perda do servidor principal.</span><span class="sxs-lookup"><span data-stu-id="96c3a-308">The following table summarizes the combined effect of the transaction safety setting, the state of the database, and the state of the witness on the behavior of a mirroring session on the loss of the principal server.</span></span>  
  
|<span data-ttu-id="96c3a-309">Segurança de transação</span><span class="sxs-lookup"><span data-stu-id="96c3a-309">Transaction safety</span></span>|<span data-ttu-id="96c3a-310">Estado de espelhamento de banco de dados espelho</span><span class="sxs-lookup"><span data-stu-id="96c3a-310">Mirroring state of mirror database</span></span>|<span data-ttu-id="96c3a-311">Estado de testemunha</span><span class="sxs-lookup"><span data-stu-id="96c3a-311">Witness state</span></span>|<span data-ttu-id="96c3a-312">Comportamento quando o principal é perdido</span><span class="sxs-lookup"><span data-stu-id="96c3a-312">Behavior when principal is lost</span></span>|  
|------------------------|----------------------------------------|-------------------|-------------------------------------|  
|<span data-ttu-id="96c3a-313">FULL</span><span class="sxs-lookup"><span data-stu-id="96c3a-313">FULL</span></span>|<span data-ttu-id="96c3a-314">SYNCHRONIZED</span><span class="sxs-lookup"><span data-stu-id="96c3a-314">SYNCHRONIZED</span></span>|<span data-ttu-id="96c3a-315">CONNECTED</span><span class="sxs-lookup"><span data-stu-id="96c3a-315">CONNECTED</span></span>|<span data-ttu-id="96c3a-316">Ocorre failover automático.</span><span class="sxs-lookup"><span data-stu-id="96c3a-316">Automatic failover occurs.</span></span>|  
|<span data-ttu-id="96c3a-317">FULL</span><span class="sxs-lookup"><span data-stu-id="96c3a-317">FULL</span></span>|<span data-ttu-id="96c3a-318">SYNCHRONIZED</span><span class="sxs-lookup"><span data-stu-id="96c3a-318">SYNCHRONIZED</span></span>|<span data-ttu-id="96c3a-319">DISCONNECTED</span><span class="sxs-lookup"><span data-stu-id="96c3a-319">DISCONNECTED</span></span>|<span data-ttu-id="96c3a-320">Paradas de servidor espelho; failover não é possível e o banco de dados não pode ser disponibilizado.</span><span class="sxs-lookup"><span data-stu-id="96c3a-320">Mirror server stops; failover is not possible, and the database cannot be made available.</span></span>|  
|<span data-ttu-id="96c3a-321">OFF</span><span class="sxs-lookup"><span data-stu-id="96c3a-321">OFF</span></span>|<span data-ttu-id="96c3a-322">SUSPENDED ou DISCONNECTED</span><span class="sxs-lookup"><span data-stu-id="96c3a-322">SUSPENDED or DISCONNECTED</span></span>|<span data-ttu-id="96c3a-323">NULL (nenhuma testemunha)</span><span class="sxs-lookup"><span data-stu-id="96c3a-323">NULL (no witness)</span></span>|<span data-ttu-id="96c3a-324">Serviço pode ser forçado ao servidor espelho (com possível perda de dados).</span><span class="sxs-lookup"><span data-stu-id="96c3a-324">Service can be forced to the mirror server (with possible data loss).</span></span>|  
|<span data-ttu-id="96c3a-325">FULL</span><span class="sxs-lookup"><span data-stu-id="96c3a-325">FULL</span></span>|<span data-ttu-id="96c3a-326">SYNCHRONIZING ou SUSPENDED</span><span class="sxs-lookup"><span data-stu-id="96c3a-326">SYNCHRONIZING or SUSPENDED</span></span>|<span data-ttu-id="96c3a-327">NULL (nenhuma testemunha)</span><span class="sxs-lookup"><span data-stu-id="96c3a-327">NULL (no witness)</span></span>|<span data-ttu-id="96c3a-328">Serviço pode ser forçado ao servidor espelho (com possível perda de dados).</span><span class="sxs-lookup"><span data-stu-id="96c3a-328">Service can be forced to the mirror server (with possible data loss).</span></span>|  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="96c3a-329">Tarefas relacionadas</span><span class="sxs-lookup"><span data-stu-id="96c3a-329">Related Tasks</span></span>  
  
-   [<span data-ttu-id="96c3a-330">Adicionar ou substituir uma testemunha de espelhamento de banco de dados &#40;SQL Server Management Studio&#41;</span><span class="sxs-lookup"><span data-stu-id="96c3a-330">Add or Replace a Database Mirroring Witness &#40;SQL Server Management Studio&#41;</span></span>](../database-mirroring/add-or-replace-a-database-mirroring-witness-sql-server-management-studio.md)  
  
-   [<span data-ttu-id="96c3a-331">Estabelecer uma sessão de espelhamento de banco de dados usando a Autenticação do Windows &#40;SQL Server Management Studio&#41;</span><span class="sxs-lookup"><span data-stu-id="96c3a-331">Establish a Database Mirroring Session Using Windows Authentication &#40;SQL Server Management Studio&#41;</span></span>](establish-database-mirroring-session-windows-authentication.md)  
  
-   [<span data-ttu-id="96c3a-332">Adicionar uma testemunha de espelhamento de banco de dados usando a Autenticação do Windows &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="96c3a-332">Add a Database Mirroring Witness Using Windows Authentication &#40;Transact-SQL&#41;</span></span>](add-a-database-mirroring-witness-using-windows-authentication-transact-sql.md)  
  
-   [<span data-ttu-id="96c3a-333">Remover a testemunha de uma sessão de espelhamento de banco de dados &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="96c3a-333">Remove the Witness from a Database Mirroring Session &#40;SQL Server&#41;</span></span>](remove-the-witness-from-a-database-mirroring-session-sql-server.md)  
  
-   [<span data-ttu-id="96c3a-334">Alterar a segurança da transação em uma sessão de espelhamento de banco de dados &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="96c3a-334">Change Transaction Safety in a Database Mirroring Session &#40;Transact-SQL&#41;</span></span>](change-transaction-safety-in-a-database-mirroring-session-transact-sql.md)  
  
## <a name="see-also"></a><span data-ttu-id="96c3a-335">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="96c3a-335">See Also</span></span>  
 <span data-ttu-id="96c3a-336">[Monitorando o espelhamento de banco de dados &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="96c3a-336">[Monitoring Database Mirroring &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md) </span></span>  
 [<span data-ttu-id="96c3a-337">Testemunha de espelhamento de banco de dados</span><span class="sxs-lookup"><span data-stu-id="96c3a-337">Database Mirroring Witness</span></span>](database-mirroring-witness.md)  
