---
title: Estimar a interrupção do serviço durante a troca de função (espelhamento de banco de dados) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- parallel redo [SQL Server]
- role switching [SQL Server]
- database mirroring [SQL Server], queues
- failover [SQL Server], database mirroring
- redo [database mirroring]
- database mirroring [SQL Server], failover
ms.assetid: 586a6f25-672b-491b-bc2f-deab2ccda6e2
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 283c0dfad8d9f91693ab92ed415b4368dd3f0396
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87570207"
---
# <a name="estimate-the-interruption-of-service-during-role-switching-database-mirroring"></a><span data-ttu-id="91757-102">Estime a interrupção do serviço durante troca de função (Espelhamento de Banco de Dados)</span><span class="sxs-lookup"><span data-stu-id="91757-102">Estimate the Interruption of Service During Role Switching (Database Mirroring)</span></span>
  <span data-ttu-id="91757-103">Durante uma troca de função, a quantidade de tempo que o espelhamento de banco de dados fica fora de serviço depende do tipo de função trocada e da causa da troca de função.</span><span class="sxs-lookup"><span data-stu-id="91757-103">During a role switch, the amount of time that database mirroring will be out of service depends on the type of role switching and the cause of the role switch.</span></span>

-   <span data-ttu-id="91757-104">Para failover automático, dois fatores contribuem para a interrupção do serviço de tempo: o tempo necessário para o servidor espelho reconhecer que a instância de servidor principal falhou, ou seja, detecção de erros, mais o tempo necessário para o failover do banco de dados, isto é, tempo de failover.</span><span class="sxs-lookup"><span data-stu-id="91757-104">For automatic failover, two factors contribute to the time service is interrupted: the time required for the mirror server to recognize that the principal server instance has failed, that is error detection, plus the time required to fail over the database, that is failover time.</span></span>

-   <span data-ttu-id="91757-105">Para uma operação de serviço forçado, mesmo ocorrendo uma falha, a sua detecção e a resposta ao erro dependem da reação humana.</span><span class="sxs-lookup"><span data-stu-id="91757-105">For a forced-service operation, though a failure has occurred, detecting and responding to the failure depends on human responsiveness.</span></span> <span data-ttu-id="91757-106">Porém, a estimativa de interrupção potencial de serviço é limitada à estimativa de tempo do servidor espelho para trocar funções depois de emitido o comando de serviço forçado.</span><span class="sxs-lookup"><span data-stu-id="91757-106">However, estimating the potential interruption of service is limited to estimating the time for the mirror server to switch roles after the forced service command is issued.</span></span>

    > [!NOTE]
    >  <span data-ttu-id="91757-107">Para reduzir o tempo exigido para detectar condições específicas, como alguns tipos de erros, você pode definir alertas para essas condições.</span><span class="sxs-lookup"><span data-stu-id="91757-107">To reduce the time required to detect specific conditions such as some types of errors, you can define alerts for those conditions.</span></span>

-   <span data-ttu-id="91757-108">Para um failover manual, apenas o tempo exigido do failover do banco de dados após o comando de failover é emitido.</span><span class="sxs-lookup"><span data-stu-id="91757-108">For a manual failover, only the time required to fail over the database after the failover command is issued.</span></span>

## <a name="error-detection"></a><span data-ttu-id="91757-109">Detecção de erro</span><span class="sxs-lookup"><span data-stu-id="91757-109">Error detection</span></span>
 <span data-ttu-id="91757-110">O tempo para o sistema perceber um erro depende do tipo de erro; por exemplo, um erro de rede é percebido quase instantaneamente, enquanto que perceber que um servidor não está respondendo demora 10 segundos (com o tempo limite padrão).</span><span class="sxs-lookup"><span data-stu-id="91757-110">The time for the system to notice an error depends on the type of error; for example, a network error is noticed almost instantly, while noticing a server that is not responding takes 10 seconds (with the default timeout).</span></span>

 <span data-ttu-id="91757-111">Para obter informações sobre erros que podem causar uma falha durante uma sessão de espelhamento de banco de dados e detecção de tempo limite em modo de segurança alta com failover automático, consulte [Possíveis falhas durante o Espelhamento de Banco de Dados](possible-failures-during-database-mirroring.md)).</span><span class="sxs-lookup"><span data-stu-id="91757-111">For information on errors that can cause a failure during a database mirroring session and timeout detection in high-safety mode with automatic failover, see [Possible Failures During Database Mirroring](possible-failures-during-database-mirroring.md)).</span></span>

## <a name="failover-time"></a><span data-ttu-id="91757-112">Tempo de failover</span><span class="sxs-lookup"><span data-stu-id="91757-112">Failover time</span></span>
 <span data-ttu-id="91757-113">O tempo de failover consiste principalmente no tempo necessário para o servidor espelho anterior efetuar o roll-forward de qualquer log restante na fila de restauração, mais um pequeno tempo adicional (para obter mais informações sobre como o servidor espelho processa registros de log, consulte [Espelhamento de Banco de Dados &#40;SQL Server&#41;](database-mirroring-sql-server.md)).</span><span class="sxs-lookup"><span data-stu-id="91757-113">Failover time consists mainly of the time that the former mirror server requires to roll forward any log remaining in its redo queue, plus a short additional time (for more information about how the mirror server processes log records, see [Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md)).</span></span> <span data-ttu-id="91757-114">Para obter informações sobre como calcular o tempo de failover, consulte Estimando sua taxa do failover a ser refeito, posteriormente neste tópico.</span><span class="sxs-lookup"><span data-stu-id="91757-114">For information on estimating failover time, see Estimating Your Failover Redo Rate, later in this topic.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="91757-115">Se o failover ocorrer durante uma transação na qual um índice ou uma tabela for criada e, depois, for alterada, o failover pode demorar mais tempo que o habitual.</span><span class="sxs-lookup"><span data-stu-id="91757-115">If failover occurs during a transaction in which an index or table is created and then changed, failover might take longer than usual.</span></span>  <span data-ttu-id="91757-116">Por exemplo, o failover durante a série seguinte de operações pode aumentar o tempo de failover: BEGIN TRANSACTION, CREATE INDEX em uma tabela e SELECT INTO tabela.</span><span class="sxs-lookup"><span data-stu-id="91757-116">For example, failing over during the following series of operations might increase failover time:  BEGIN TRANSACTION, CREATE INDEX on a table, and SELECT INTO the table.</span></span> <span data-ttu-id="91757-117">A possibilidade de aumento do tempo de failover durante tal transação permanece até que ele seja concluído com uma instrução COMMIT TRANSACTION ou ROLLBACK TRANSACTION.</span><span class="sxs-lookup"><span data-stu-id="91757-117">The possibility of increased failover time during such a transaction remains until it is completed with either a COMMIT TRANSACTION or ROLLBACK TRANSACTION statement.</span></span>

### <a name="the-redo-queue"></a><span data-ttu-id="91757-118">A Fila de Restauração</span><span class="sxs-lookup"><span data-stu-id="91757-118">The Redo Queue</span></span>
 <span data-ttu-id="91757-119">O avanço do banco de dados envolve a aplicação de quaisquer registros de log que estiverem atualmente na fila de restauração no servidor espelho.</span><span class="sxs-lookup"><span data-stu-id="91757-119">Rolling forward the database involves applying whatever log records are currently in the redo queue on the mirror server.</span></span> <span data-ttu-id="91757-120">A opção *fila de restauração* consiste nos registros de log gravados no disco do servidor espelho, mas que ainda não avançaram para o banco de dados espelho.</span><span class="sxs-lookup"><span data-stu-id="91757-120">The *redo queue* consists of the log records that have been written to disk on the mirror server but not yet rolled forward on the mirror database.</span></span>

 <span data-ttu-id="91757-121">O tempo de failover do banco de dados depende da rapidez com que o servidor espelho consegue efetuar o roll-forward do log na fila de restauração que, por sua vez, é determinada principalmente pelo hardware de sistema e pela carga de trabalho atual.</span><span class="sxs-lookup"><span data-stu-id="91757-121">Failover time for the database depends on how fast the mirror server can roll forward the log in the redo queue, which, in turn, is determined primarily by the system hardware and the current work load.</span></span> <span data-ttu-id="91757-122">Potencialmente, um banco de dados principal pode ficar tão ocupado que o servidor principal envia o log ao servidor espelho muito mais rápido do que consegue avançar o log.</span><span class="sxs-lookup"><span data-stu-id="91757-122">Potentially, a principal database can become so busy that the principal server ships log to the mirror server much faster than it can roll the log forward.</span></span> <span data-ttu-id="91757-123">Nessa situação, o failover poderia levar muito tempo enquanto o servidor espelho avança o log na fila de restauração.</span><span class="sxs-lookup"><span data-stu-id="91757-123">In this situation, failover might take significant time while the mirror server rolls forward the log in the redo queue.</span></span> <span data-ttu-id="91757-124">Para saber o tamanho atual da fila de logs a serem refeitos, use o contador **Fila de Restauração** do objeto de desempenho do espelhamento de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="91757-124">To learn the current size of the redo queue, use the **Redo Queue** counter in the database mirroring performance object.</span></span> <span data-ttu-id="91757-125">Para obter mais informações, consulte [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span><span class="sxs-lookup"><span data-stu-id="91757-125">For more information, see [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span></span>

### <a name="estimating-the-failover-redo-rate"></a><span data-ttu-id="91757-126">Estimando a taxa de failover a ser refeito</span><span class="sxs-lookup"><span data-stu-id="91757-126">Estimating the Failover Redo Rate</span></span>
 <span data-ttu-id="91757-127">Você pode medir o tempo necessário para efetuar o roll-forward de registros de log – a *taxa de restauração*– usando uma cópia de teste do banco de dados de produção.</span><span class="sxs-lookup"><span data-stu-id="91757-127">You can measure the amount of time required to roll forward log records-the *redo rate*-by using a test copy of the production database.</span></span>

 <span data-ttu-id="91757-128">O método para calcular o tempo do roll-forward durante o failover depende do número de threads que o servidor espelho usa durante a fase refazer.</span><span class="sxs-lookup"><span data-stu-id="91757-128">The method for estimating roll forward time during failover depends on the number of threads the mirror server uses during the redo phase.</span></span> <span data-ttu-id="91757-129">O número de threads depende do seguinte:</span><span class="sxs-lookup"><span data-stu-id="91757-129">The number of threads depends on the following:</span></span>

-   <span data-ttu-id="91757-130">No [!INCLUDE[ssStandard](../../includes/ssstandard-md.md)], o servidor espelho sempre usa um único thread para efetuar roll forward do banco de dados.</span><span class="sxs-lookup"><span data-stu-id="91757-130">In [!INCLUDE[ssStandard](../../includes/ssstandard-md.md)], the mirror server always uses a single thread to roll forward the database.</span></span>

-   <span data-ttu-id="91757-131">No [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], os servidores espelho em computadores com menos de cinco CPUs também usam apenas um único thread.</span><span class="sxs-lookup"><span data-stu-id="91757-131">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], mirror servers on computers with fewer than five CPUs also use only a single thread.</span></span> <span data-ttu-id="91757-132">Com cinco ou mais CPUs, um servidor espelho distribui suas operações de roll-forward em vários threads durante um failover (isso é conhecido como *restauração paralela*).</span><span class="sxs-lookup"><span data-stu-id="91757-132">With five or more CPUs, a mirror server distributes its roll forward operations among multiple threads during a failover (this is known as *parallel redo*).</span></span> <span data-ttu-id="91757-133">A opção de restauração paralela é otimizada para usar um thread para todas as quatro CPUs.</span><span class="sxs-lookup"><span data-stu-id="91757-133">Parallel redo is optimized to use one thread for every four CPUs.</span></span>

#### <a name="estimating-the-single-threaded-redo-rate"></a><span data-ttu-id="91757-134">Estimando a taxa do thread único a ser refeito</span><span class="sxs-lookup"><span data-stu-id="91757-134">Estimating the Single-Threaded Redo Rate</span></span>
 <span data-ttu-id="91757-135">Para refazer o thread único, efetue o roll-forward do banco de dados espelho durante o failover demora aproximadamente o mesmo tempo que a restauração de um backup de log leva para efetuar roll-forward da mesma quantidade de log.</span><span class="sxs-lookup"><span data-stu-id="91757-135">For single-threaded redo, roll forward of the mirror database during failover takes approximately the same amount of time as a restore of a log backup takes to roll forward the same amount of log.</span></span> <span data-ttu-id="91757-136">Para calcular o tempo de failover, crie um banco de dados de teste no ambiente no qual você pretende executar o espelhamento.</span><span class="sxs-lookup"><span data-stu-id="91757-136">To estimate failover time, create a test database in the environment under which you intend to run mirroring.</span></span> <span data-ttu-id="91757-137">Depois, pegue um backup de log do banco de dados de produção.</span><span class="sxs-lookup"><span data-stu-id="91757-137">Then take a log backup from the production database.</span></span> <span data-ttu-id="91757-138">Para medir a taxa de restauração daquele backup de log, cronometre quanto tempo você leva para restaurar o backup de log WITH NORECOVERY no banco de dados de teste.</span><span class="sxs-lookup"><span data-stu-id="91757-138">To measure the redo rate for that log backup, time how long it takes you to restore the log backup WITH NORECOVERY onto the test database.</span></span>

 <span data-ttu-id="91757-139">Uma vez conhecida a taxa de restauração de seu servidor espelho, você pode calcular o tempo de failover do banco de dados em um determinado momento, dividindo a quantidade de logs atuais a serem refeitos no espelho (medida pelo contador de desempenho **Fila de Restauração** ) pela taxa de restauração.</span><span class="sxs-lookup"><span data-stu-id="91757-139">Once you know the redo rate of your mirror server, you can estimate the time to fail over the database at a given point in time by dividing the amount of current log to be redone on the mirror (as measured by the **Redo Queue** performance counter) by the redo rate.</span></span> <span data-ttu-id="91757-140">Em condições normais, se o servidor espelho conseguir manter a carga do principal, a **Fila de Restauração** será pequena ou quase zero, e um failover só levará alguns segundos.</span><span class="sxs-lookup"><span data-stu-id="91757-140">Under normal conditions, if the mirror server can keep up with the load from the principal, the **Redo Queue** is small or close to zero, and a failover only takes a few seconds.</span></span>

#### <a name="estimating-the-parallel-redo-rate"></a><span data-ttu-id="91757-141">Estimando a taxa de restauração paralela</span><span class="sxs-lookup"><span data-stu-id="91757-141">Estimating the Parallel Redo Rate</span></span>
 <span data-ttu-id="91757-142">No [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], a opção de restauração paralela é otimizada para usar um thread para todas as quatro CPUs.</span><span class="sxs-lookup"><span data-stu-id="91757-142">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], parallel redo is optimized to use one thread for every four CPUs.</span></span> <span data-ttu-id="91757-143">Para calcular o tempo do roll-forward da opção de restauração paralela, é mais preciso acessar um sistema de teste de execução do que um banco de dados de teste.</span><span class="sxs-lookup"><span data-stu-id="91757-143">To estimate roll forward time for parallel redo, it is more accurate to access a running test system than a test database.</span></span> <span data-ttu-id="91757-144">Enquanto monitora a fila de restauração no servidor espelho, aumente a carga no servidor principal.</span><span class="sxs-lookup"><span data-stu-id="91757-144">While monitoring the redo queue on the mirror server, increase the load on the principal server.</span></span> <span data-ttu-id="91757-145">Em operação normal, a fila de restauração é quase zero.</span><span class="sxs-lookup"><span data-stu-id="91757-145">In normal operation, the redo queue is close to zero.</span></span> <span data-ttu-id="91757-146">Aumente a carga no servidor principal até que a Fila de Restauração comece a crescer continuamente; o sistema atingirá sua taxa máxima de restauração e, nesse momento, o contador de desempenho **Refazer Bytes/s** representará a taxa máxima de restauração.</span><span class="sxs-lookup"><span data-stu-id="91757-146">Increase the load on the principal server until the Redo Queue starts to grow continuously; the system is then at its maximum redo rate, and the **Redo Bytes/sec** performance counter at this point represents the maximum redo rate.</span></span> <span data-ttu-id="91757-147">Para obter mais informações, consulte [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span><span class="sxs-lookup"><span data-stu-id="91757-147">For more information, see [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span></span>

## <a name="estimating-interruption-of-service-during-automatic-failover"></a><span data-ttu-id="91757-148">Estimando a interrupção do serviço durante o failover automático</span><span class="sxs-lookup"><span data-stu-id="91757-148">Estimating Interruption of Service During Automatic Failover</span></span>
 <span data-ttu-id="91757-149">A figura seguinte ilustra como a detecção de erros e o tempo de failover contribuem para o tempo geral necessário para um failover automático ser concluído em **Partner_B**.</span><span class="sxs-lookup"><span data-stu-id="91757-149">The following figure illustrates how error detection and failover time contribute to the overall time required for an automatic failover to complete on **Partner_B**.</span></span> <span data-ttu-id="91757-150">O failover precisa de tempo para efetuar o roll-forward do banco de dados (a fase Refazer) mais uma quantidade pequena de tempo para tornar o banco de dados online.</span><span class="sxs-lookup"><span data-stu-id="91757-150">Failover requires time to roll forward the database (the redo phase) plus a small amount of time to bring the database online.</span></span> <span data-ttu-id="91757-151">A fase Desfazer, que envolve a reversão de qualquer transação não confirmada, acontece depois que o novo banco de dados principal estiver online e continuar depois do failover.</span><span class="sxs-lookup"><span data-stu-id="91757-151">The undo phase, which involves rolling back any uncommitted transactions, occurs after the new principal database goes online and continues after fail over.</span></span> <span data-ttu-id="91757-152">O banco de dados fica disponível durante a fase Desfazer.</span><span class="sxs-lookup"><span data-stu-id="91757-152">The database is available during the undo phase.</span></span>

 <span data-ttu-id="91757-153">![Hora da detecção e failover de erro](../media/dbm-failovauto-time.gif "Hora da detecção e failover de erro")</span><span class="sxs-lookup"><span data-stu-id="91757-153">![Error detection and failover time](../media/dbm-failovauto-time.gif "Error detection and failover time")</span></span>

## <a name="see-also"></a><span data-ttu-id="91757-154">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="91757-154">See Also</span></span>
 <span data-ttu-id="91757-155">[Modo operacional de espelhamento de banco de dados](database-mirroring-operating-modes.md) [troca de função durante uma sessão de espelhamento de banco de dados &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md) [monitoramento de &#40;espelhamento de banco](monitoring-database-mirroring-sql-server.md) de dados SQL Server</span><span class="sxs-lookup"><span data-stu-id="91757-155">[Database Mirroring Operating Modes](database-mirroring-operating-modes.md) [Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md) [Monitoring Database Mirroring &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md)</span></span>


