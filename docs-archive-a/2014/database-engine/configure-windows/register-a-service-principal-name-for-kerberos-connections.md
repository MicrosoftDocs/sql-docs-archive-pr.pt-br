---
title: Registrar um nome da entidade de serviço para conexões Kerberos | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: configuration
ms.topic: conceptual
helpviewer_keywords:
- connections [SQL Server], SPNs
- network connections [SQL Server], SPNs
- registering SPNs
- Server Principal Names
- SPNs [SQL Server]
ms.assetid: e38d5ce4-e538-4ab9-be67-7046e0d9504e
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: f4db1e8b86fca057acbce29491be9c2be91f0748
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87582124"
---
# <a name="register-a-service-principal-name-for-kerberos-connections"></a><span data-ttu-id="c31e1-102">Registrar um nome de entidade de serviço para conexões de Kerberos</span><span class="sxs-lookup"><span data-stu-id="c31e1-102">Register a Service Principal Name for Kerberos Connections</span></span>
  <span data-ttu-id="c31e1-103">Para usar a autenticação Kerberos com o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , é preciso satisfazer estas duas condições:</span><span class="sxs-lookup"><span data-stu-id="c31e1-103">To use Kerberos authentication with [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] requires both the following conditions to be true:</span></span>  
  
-   <span data-ttu-id="c31e1-104">Os computadores cliente e servidor devem fazer parte do mesmo domínio do Windows ou de domínios confiáveis.</span><span class="sxs-lookup"><span data-stu-id="c31e1-104">The client and server computers must be part of the same Windows domain, or in trusted domains.</span></span>  
  
-   <span data-ttu-id="c31e1-105">Um SPN (Nome da Entidade de Serviço) deve ser registrado no Active Directory, o qual assume a função do Centro de Distribuição de Chaves em um domínio Windows.</span><span class="sxs-lookup"><span data-stu-id="c31e1-105">A Service Principal Name (SPN) must be registered with Active Directory, which assumes the role of the Key Distribution Center in a Windows domain.</span></span> <span data-ttu-id="c31e1-106">O SPN, depois de registrado, é mapeado para a conta do Windows que iniciou o serviço da instância do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="c31e1-106">The SPN, after it is registered, maps to the Windows account that started the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance service.</span></span> <span data-ttu-id="c31e1-107">Se o registro do SPN não foi realizado ou falhou, a camada de segurança do Windows não poderá determinar a conta associada ao SPN e a autenticação Kerberos não será utilizada.</span><span class="sxs-lookup"><span data-stu-id="c31e1-107">If the SPN registration has not been performed or fails, the Windows security layer cannot determine the account associated with the SPN, and Kerberos authentication will not be used.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="c31e1-108">Se o servidor não puder registrar automaticamente o SPN, será necessário registrá-lo manualmente.</span><span class="sxs-lookup"><span data-stu-id="c31e1-108">If the server cannot automatically register the SPN, the SPN must be registered manually.</span></span> <span data-ttu-id="c31e1-109">Veja [Registro manual de SPN](#Manual).</span><span class="sxs-lookup"><span data-stu-id="c31e1-109">See [Manual SPN Registration](#Manual).</span></span>  
  
 <span data-ttu-id="c31e1-110">É possível verificar se uma conexão está usando Kerberos consultando a exibição de gerenciamento dinâmico sys.dm_exec_connections.</span><span class="sxs-lookup"><span data-stu-id="c31e1-110">You can verify that a connection is using Kerberos by querying the sys.dm_exec_connections dynamic management view.</span></span> <span data-ttu-id="c31e1-111">Execute a consulta a seguir e verifique o valor da coluna auth_scheme, que será "KERBEROS" se Kerberos estiver habilitado.</span><span class="sxs-lookup"><span data-stu-id="c31e1-111">Run the following query and check the value of the auth_scheme column, which will be "KERBEROS" if Kerberos is enabled.</span></span>  
  
```  
SELECT auth_scheme FROM sys.dm_exec_connections WHERE session_id = @@spid ;  
```  
  
> [!TIP]  
>  <span data-ttu-id="c31e1-112">**[!INCLUDE[msCoName](../../includes/msconame-md.md)] Kerberos Configuration Manager for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]** é uma ferramenta de diagnóstico que ajuda a solucionar problemas de Kerberos relativos à conectividade com [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="c31e1-112">**[!INCLUDE[msCoName](../../includes/msconame-md.md)] Kerberos Configuration Manager for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]** is a diagnostic tool that helps troubleshoot Kerberos related connectivity issues with [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="c31e1-113">Para obter mais informações, consulte [Microsoft Kerberos Configuration Manager for SQL Server](https://www.microsoft.com/download/details.aspx?id=39046).</span><span class="sxs-lookup"><span data-stu-id="c31e1-113">For more information, see [Microsoft Kerberos Configuration Manager for SQL Server](https://www.microsoft.com/download/details.aspx?id=39046).</span></span>  
  
##  <a name="the-role-of-the-spn-in-authentication"></a><a name="Role"></a> <span data-ttu-id="c31e1-114">A função do SPN na autenticação</span><span class="sxs-lookup"><span data-stu-id="c31e1-114">The Role of the SPN in Authentication</span></span>  
 <span data-ttu-id="c31e1-115">Quando um aplicativo abre uma conexão e usa a Autenticação do Windows, o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client passa o nome do computador, o nome da instância e, opcionalmente, um SPN do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="c31e1-115">When an application opens a connection and uses Windows Authentication, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client passes the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] computer name, instance name and, optionally, an SPN.</span></span> <span data-ttu-id="c31e1-116">Se a conexão passar um SPN, ele será usado sem qualquer alteração.</span><span class="sxs-lookup"><span data-stu-id="c31e1-116">If the connection passes an SPN it is used without any changes.</span></span>  
  
 <span data-ttu-id="c31e1-117">Se a conexão não passar um SPN, um SPN padrão será construído a partir do protocolo usado, do nome do servidor e do nome da instância.</span><span class="sxs-lookup"><span data-stu-id="c31e1-117">If the connection does not pass an SPN, a default SPN is constructed based on the protocol used, server name, and the instance name.</span></span>  
  
 <span data-ttu-id="c31e1-118">Em ambos os casos, o SPN é enviado ao centro de distribuição de chave para obter um token de segurança para autenticar a conexão.</span><span class="sxs-lookup"><span data-stu-id="c31e1-118">In both of the preceding scenarios, the SPN is sent to the Key Distribution Center to obtain a security token for authenticating the connection.</span></span> <span data-ttu-id="c31e1-119">Se não for possível obter um token de segurança, a autenticação usará o NTLM.</span><span class="sxs-lookup"><span data-stu-id="c31e1-119">If a security token cannot be obtained, authentication uses NTLM.</span></span>  
  
 <span data-ttu-id="c31e1-120">Um SPN (nome da entidade de serviço) é o nome pelo qual um cliente identifica exclusivamente uma instância de um serviço.</span><span class="sxs-lookup"><span data-stu-id="c31e1-120">A service principal name (SPN) is the name by which a client uniquely identifies an instance of a service.</span></span> <span data-ttu-id="c31e1-121">O serviço de autenticação Kerberos pode usar um SPN para autenticar um serviço.</span><span class="sxs-lookup"><span data-stu-id="c31e1-121">The Kerberos authentication service can use an SPN to authenticate a service.</span></span> <span data-ttu-id="c31e1-122">Quando um cliente deseja se conectar a um serviço, ele localiza uma instância do serviço, compõe um SPN para essa instância, conecta-se ao serviço e apresenta o SPN para autenticação do serviço.</span><span class="sxs-lookup"><span data-stu-id="c31e1-122">When a client wants to connect to a service, it locates an instance of the service, composes an SPN for that instance, connects to the service, and presents the SPN for the service to authenticate.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c31e1-123">As informações fornecidas neste tópico também se aplicam a configurações do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] que usam clustering.</span><span class="sxs-lookup"><span data-stu-id="c31e1-123">The information that is provided in this topic also applies to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] configurations that use clustering.</span></span>  
  
 <span data-ttu-id="c31e1-124">A Autenticação do Windows é o método preferencial de os usuários se autenticarem no SQL Server.</span><span class="sxs-lookup"><span data-stu-id="c31e1-124">Windows Authentication is the preferred method for users to authenticate to SQL Server.</span></span> <span data-ttu-id="c31e1-125">Os clientes que usam a Autenticação do Windows são autenticados usando NTLM ou Kerberos.</span><span class="sxs-lookup"><span data-stu-id="c31e1-125">Clients that use Windows Authentication are authenticated by either using NTLM or Kerberos.</span></span> <span data-ttu-id="c31e1-126">Em um ambiente do Active Directory, a autenticação Kerberos é sempre tentada primeiro.</span><span class="sxs-lookup"><span data-stu-id="c31e1-126">In an Active Directory environment, Kerberos authentication is always attempted first.</span></span> <span data-ttu-id="c31e1-127">A autenticação Kerberos não está disponível para clientes do [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] que usam pipes nomeados.</span><span class="sxs-lookup"><span data-stu-id="c31e1-127">Kerberos authentication is not available for [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] clients using named pipes.</span></span>  
  
##  <a name="permissions"></a><a name="Permissions"></a> <span data-ttu-id="c31e1-128">Permissões</span><span class="sxs-lookup"><span data-stu-id="c31e1-128">Permissions</span></span>  
 <span data-ttu-id="c31e1-129">Quando o serviço do [!INCLUDE[ssDE](../../includes/ssde-md.md)] é iniciado, ele tenta registrar o SPN (Nome da Entidade de Serviço).</span><span class="sxs-lookup"><span data-stu-id="c31e1-129">When the [!INCLUDE[ssDE](../../includes/ssde-md.md)] service starts, it attempts to register the Service Principal Name (SPN).</span></span> <span data-ttu-id="c31e1-130">Se a conta que estiver iniciando o SQL Server não tiver permissão para registrar um SPN nos Active Directory Domain Services, ocorrerá uma falha nessa chamada e uma mensagem de aviso será registrada no log de eventos do aplicativo, bem como no log de erros do SQL Server.</span><span class="sxs-lookup"><span data-stu-id="c31e1-130">If the account starting SQL Server doesn't have permission to register a SPN in Active Directory Domain Services, this call will fail and a warning message will be logged in the Application event log as well as the SQL Server error log.</span></span> <span data-ttu-id="c31e1-131">Para registrar o SPN, é necessário que o [!INCLUDE[ssDE](../../includes/ssde-md.md)] esteja em execução em uma conta interna, como Sistema Local (não recomendado) ou SERVIÇO DE REDE, ou uma conta com permissão para registrar um SPN, como a conta do administrador de domínio.</span><span class="sxs-lookup"><span data-stu-id="c31e1-131">To register the SPN, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] must be running under a built-in account, such as Local System (not recommended), or NETWORK SERVICE, or an account that has permission to register an SPN, such as a domain administrator account.</span></span> <span data-ttu-id="c31e1-132">Quando o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] estiver sendo executado no sistema operacional  [!INCLUDE[win7](../../includes/win7-md.md)] ou  [!INCLUDE[winserver2008r2](../../includes/winserver2008r2-md.md)] , você poderá executar o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] usando uma conta virtual ou uma conta de serviço gerenciada (MSA).</span><span class="sxs-lookup"><span data-stu-id="c31e1-132">When [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is running on the  [!INCLUDE[win7](../../includes/win7-md.md)] or  [!INCLUDE[winserver2008r2](../../includes/winserver2008r2-md.md)] operating system, you can run [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] using a virtual account or a managed service account (MSA).</span></span> <span data-ttu-id="c31e1-133">Tanto contas virtuais quanto MSAs podem registrar um SPN.</span><span class="sxs-lookup"><span data-stu-id="c31e1-133">Both virtual accounts and MSA's can register an SPN.</span></span> <span data-ttu-id="c31e1-134">Se o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] não estiver em execução em uma dessas contas, o SPN não será registrado na inicialização e o administrador do domínio deverá registrar o SPN manualmente.</span><span class="sxs-lookup"><span data-stu-id="c31e1-134">If [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is not running under one of these accounts, the SPN is not registered at startup and the domain administrator must register the SPN manually.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c31e1-135">Quando o domínio do Windows é configurado para execução em um nível inferior ao nível funcional do [!INCLUDE[winserver2008r2](../../includes/winserver2008r2-md.md)] Windows Server 2008 R2, a Conta de Serviço Gerenciada não tem as permissões necessárias para registrar os SPNs do serviço [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="c31e1-135">When the Windows domain is configured to run at less than the [!INCLUDE[winserver2008r2](../../includes/winserver2008r2-md.md)] Windows Server 2008 R2 functional level, then the Managed Service Account will not have the necessary permissions to register the SPNs for the [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] service.</span></span> <span data-ttu-id="c31e1-136">Se a autenticação Kerberos for necessária, o Administrador de Domínio deverá registrar manualmente os SPNs do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] na Conta de Serviço Gerenciada.</span><span class="sxs-lookup"><span data-stu-id="c31e1-136">If Kerberos authentication is required, the Domain Administrator should manually register the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] SPNs on the Managed Service Account.</span></span>  
  
 <span data-ttu-id="c31e1-137">O artigo da Base de Dados de Conhecimento, [Como usar a autenticação Kerberos no SQL Server](https://support.microsoft.com/kb/319723), contém informações sobre como conceder permissões de leitura e gravação a um SPN de uma conta que não seja um Administrador de Domínio.</span><span class="sxs-lookup"><span data-stu-id="c31e1-137">The KB article, [How to use Kerberos authentication in SQL Server](https://support.microsoft.com/kb/319723), contains information about how to grant read or write permission to an SPN for an account that is not a Domain Administrator.</span></span>  
  
 <span data-ttu-id="c31e1-138">Informações adicionais estão disponíveis em [Como implementar a delegação restrita de Kerberos com o SQL Server 2008](https://technet.microsoft.com/library/ee191523.aspx)</span><span class="sxs-lookup"><span data-stu-id="c31e1-138">Additional information is available at [How to Implement Kerberos Constrained Delegation with SQL Server 2008](https://technet.microsoft.com/library/ee191523.aspx)</span></span>  
  
##  <a name="spn-formats"></a><a name="Formats"></a> <span data-ttu-id="c31e1-139">Formatos de SPN</span><span class="sxs-lookup"><span data-stu-id="c31e1-139">SPN Formats</span></span>  
 <span data-ttu-id="c31e1-140">Começando pelo [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], o formato de SPN é alterado para dar suporte à autenticação Kerberos em TCP/IP, pipes nomeados e memória compartilhada.</span><span class="sxs-lookup"><span data-stu-id="c31e1-140">Beginning with [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], the SPN format is changed in order to support Kerberos authentication on TCP/IP, named pipes, and shared memory.</span></span> <span data-ttu-id="c31e1-141">Os formatos de SPN com suporte para instâncias padrão e nomeadas são os seguintes:</span><span class="sxs-lookup"><span data-stu-id="c31e1-141">The supported SPN formats for named and default instances are as follows.</span></span>  
  
 <span data-ttu-id="c31e1-142">**Instância nomeada**</span><span class="sxs-lookup"><span data-stu-id="c31e1-142">**Named instance**</span></span>  
  
-   <span data-ttu-id="c31e1-143">*MSSQLSvc/FQDN*:[_port_**|**_instancename_], em que:</span><span class="sxs-lookup"><span data-stu-id="c31e1-143">*MSSQLSvc/FQDN*:[_port_**|**_instancename_], where:</span></span>  
  
    -   <span data-ttu-id="c31e1-144">*MSSQLSvc* é o serviço que está sendo registrado.</span><span class="sxs-lookup"><span data-stu-id="c31e1-144">*MSSQLSvc* is the service that is being registered.</span></span>  
  
    -   <span data-ttu-id="c31e1-145">*FQDN* é o nome de domínio totalmente qualificado do servidor.</span><span class="sxs-lookup"><span data-stu-id="c31e1-145">*FQDN* is the fully qualified domain name of the server.</span></span>  
  
    -   <span data-ttu-id="c31e1-146">*Port* é o número da porta TCP.</span><span class="sxs-lookup"><span data-stu-id="c31e1-146">*port* is the TCP port number.</span></span>  
  
    -   <span data-ttu-id="c31e1-147">*InstanceName* é o nome da [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instância.</span><span class="sxs-lookup"><span data-stu-id="c31e1-147">*instancename* is the name of the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance.</span></span>  
  
 <span data-ttu-id="c31e1-148">**Instância padrão**</span><span class="sxs-lookup"><span data-stu-id="c31e1-148">**Default instance**</span></span>  
  
-   <span data-ttu-id="c31e1-149">*MSSQLSvc/FQDN*:_porta_ **|** _MSSQLSvc/FQDN_, em que:</span><span class="sxs-lookup"><span data-stu-id="c31e1-149">*MSSQLSvc/FQDN*:_port_**|**_MSSQLSvc/FQDN_, where:</span></span>  
  
    -   <span data-ttu-id="c31e1-150">*MSSQLSvc* é o serviço que está sendo registrado.</span><span class="sxs-lookup"><span data-stu-id="c31e1-150">*MSSQLSvc* is the service that is being registered.</span></span>  
  
    -   <span data-ttu-id="c31e1-151">*FQDN* é o nome de domínio totalmente qualificado do servidor.</span><span class="sxs-lookup"><span data-stu-id="c31e1-151">*FQDN* is the fully qualified domain name of the server.</span></span>  
  
    -   <span data-ttu-id="c31e1-152">*Port* é o número da porta TCP.</span><span class="sxs-lookup"><span data-stu-id="c31e1-152">*port* is the TCP port number.</span></span>  
  
 <span data-ttu-id="c31e1-153">O formato de SPN novo não requer um número de porta.</span><span class="sxs-lookup"><span data-stu-id="c31e1-153">The new SPN format does not require a port number.</span></span> <span data-ttu-id="c31e1-154">Isso significa que um servidor de várias portas ou um protocolo que não usa números de porta pode usar a autenticação Kerberos.</span><span class="sxs-lookup"><span data-stu-id="c31e1-154">This means that a multiple-port server or a protocol that does not use port numbers can use Kerberos authentication.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c31e1-155">No caso de uma conexão TCP/IP, na qual a porta TCP é incluída no SPN, é necessário que o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] habilite o protocolo TCP a um usuário para que ele se conecte usando a autenticação Kerberos.</span><span class="sxs-lookup"><span data-stu-id="c31e1-155">In the case of a TCP/IP connection, where the TCP port is included in the SPN, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] must enable the TCP protocol for a user to connect by using Kerberos authentication.</span></span>  
  
|||  
|-|-|  
|<span data-ttu-id="c31e1-156">MSSQLSvc/*FQDN: porta*</span><span class="sxs-lookup"><span data-stu-id="c31e1-156">MSSQLSvc/*fqdn:port*</span></span>|<span data-ttu-id="c31e1-157">O SPN padrão gerado pelo provedor quando o protocolo TCP é usado.</span><span class="sxs-lookup"><span data-stu-id="c31e1-157">The provider-generated, default SPN when TCP is used.</span></span> <span data-ttu-id="c31e1-158">*port* é um número de porta TCP.</span><span class="sxs-lookup"><span data-stu-id="c31e1-158">*port* is a TCP port number.</span></span>|  
|<span data-ttu-id="c31e1-159">MSSQLSvc/*FQDN*</span><span class="sxs-lookup"><span data-stu-id="c31e1-159">MSSQLSvc/*fqdn*</span></span>|<span data-ttu-id="c31e1-160">O SPN padrão gerado pelo provedor para uma instância padrão quando um protocolo diferente de TCP é usado.</span><span class="sxs-lookup"><span data-stu-id="c31e1-160">The provider-generated, default SPN for a default instance when a protocol other than TCP is used.</span></span> <span data-ttu-id="c31e1-161">*FQDN* é um nome de domínio totalmente qualificado.</span><span class="sxs-lookup"><span data-stu-id="c31e1-161">*fqdn* is a fully-qualified domain name.</span></span>|  
|<span data-ttu-id="c31e1-162">MSSQLSvc/*FQDN: InstanceName*</span><span class="sxs-lookup"><span data-stu-id="c31e1-162">MSSQLSvc/*fqdn:InstanceName*</span></span>|<span data-ttu-id="c31e1-163">O SPN padrão gerado pelo provedor para uma instância nomeada quando um protocolo diferente de TCP é usado.</span><span class="sxs-lookup"><span data-stu-id="c31e1-163">The provider-generated, default SPN for a named instance when a protocol other than TCP is used.</span></span> <span data-ttu-id="c31e1-164">*InstanceName* é o nome de uma instância do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="c31e1-164">*InstanceName* is the name of an instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span>|  
  
##  <a name="automatic-spn-registration"></a><a name="Auto"></a> <span data-ttu-id="c31e1-165">Registro automático de SPN</span><span class="sxs-lookup"><span data-stu-id="c31e1-165">Automatic SPN Registration</span></span>  
 <span data-ttu-id="c31e1-166">Quando uma instância do [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] é iniciada, o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] tenta registrar o SPN para o serviço do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="c31e1-166">When an instance of the [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] starts, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] tries to register the SPN for the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] service.</span></span> <span data-ttu-id="c31e1-167">Quando a instância é interrompida, o [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] tenta cancelar o SPN.</span><span class="sxs-lookup"><span data-stu-id="c31e1-167">When the instance is stopped, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] tries to unregister the SPN.</span></span> <span data-ttu-id="c31e1-168">Para uma conexão TCP/IP, o SPN é registrado no formato *MSSQLSvc/\<FQDN>* : *\<tcpport>* . Tanto as instâncias nomeadas quanto as instâncias padrão são registradas como *MSSQLSvc*, dependendo do valor *\<tcpport>* para fazer a diferenciação entre as instâncias.</span><span class="sxs-lookup"><span data-stu-id="c31e1-168">For a TCP/IP connection the SPN is registered in the format *MSSQLSvc/\<FQDN>*:*\<tcpport>*.Both named instances and the default instance are registered as *MSSQLSvc*, relying on the *\<tcpport>* value to differentiate the instances.</span></span>  
  
 <span data-ttu-id="c31e1-169">Para outras conexões que dão suporte a Kerberos, o SPN é registrado no formato \*MSSQLSvc/ \<FQDN> \*: *\<instancename>* para uma instância nomeada.</span><span class="sxs-lookup"><span data-stu-id="c31e1-169">For other connections that support Kerberos the SPN is registered in the format *MSSQLSvc/\<FQDN>*:*\<instancename>* for a named instance.</span></span> <span data-ttu-id="c31e1-170">O formato para registrar uma instância padrão é *MSSQLSvc/\<FQDN>* .</span><span class="sxs-lookup"><span data-stu-id="c31e1-170">The format for registering the default instance is *MSSQLSvc/\<FQDN>*.</span></span>  
  
 <span data-ttu-id="c31e1-171">Talvez seja necessária a intervenção manual para registrar ou cancelar o SPN se a conta do serviço não tiver as permissões necessárias para essas ações.</span><span class="sxs-lookup"><span data-stu-id="c31e1-171">Manual intervention might be required to register or unregister the SPN if the service account lacks the permissions that are required for these actions.</span></span>  
  
##  <a name="manual-spn-registration"></a><a name="Manual"></a> <span data-ttu-id="c31e1-172">Registro manual de SPN</span><span class="sxs-lookup"><span data-stu-id="c31e1-172">Manual SPN Registration</span></span>  
 <span data-ttu-id="c31e1-173">Para registrar um SPN manualmente, é necessário que o administrador use a ferramenta Setspn.exe fornecida com as Ferramentas de Suporte [!INCLUDE[winxpsvr](../../includes/winxpsvr-md.md)] da Microsoft.</span><span class="sxs-lookup"><span data-stu-id="c31e1-173">To register the SPN manually, the administrator must use the Setspn.exe tool that is provided with the Microsoft [!INCLUDE[winxpsvr](../../includes/winxpsvr-md.md)] Support Tools.</span></span> <span data-ttu-id="c31e1-174">Para obter mais informações, veja o artigo da Base de Dados de Conhecimento sobre [Ferramentas de suporte do Windows Server 2003 Service Pack 1](https://support.microsoft.com/kb/892777) .</span><span class="sxs-lookup"><span data-stu-id="c31e1-174">For more information, see the [Windows Server 2003 Service Pack 1 Support Tools](https://support.microsoft.com/kb/892777) KB article.</span></span>  
  
 <span data-ttu-id="c31e1-175">O Setspn.exe é uma ferramenta de linha de comando que permite ao usuário ler, modificar e excluir a propriedade de diretório SPN (Nome da Entidade de Serviço).</span><span class="sxs-lookup"><span data-stu-id="c31e1-175">Setspn.exe is a command line tool that enables you to read, modify, and delete the Service Principal Names (SPN) directory property.</span></span> <span data-ttu-id="c31e1-176">Essa ferramenta também permite ao usuário exibir os SPNs atuais, redefinir SPNs padrão da conta e adicionar ou excluir SPNs complementares.</span><span class="sxs-lookup"><span data-stu-id="c31e1-176">This tool also enables you to view the current SPNs, reset the account's default SPNs, and add or delete supplemental SPNs.</span></span>  
  
 <span data-ttu-id="c31e1-177">O exemplo a seguir ilustra a sintaxe usada para registrar manualmente um SPN para uma conexão TCP/IP.</span><span class="sxs-lookup"><span data-stu-id="c31e1-177">The following example illustrates the syntax used to register manually register an SPN for a TCP/IP connection.</span></span>  
  
```  
setspn -A MSSQLSvc/myhost.redmond.microsoft.com:1433 accountname  
```  
  
 <span data-ttu-id="c31e1-178">**Observação** Se já houver um SPN, ele deverá ser excluído antes de registrá-lo.</span><span class="sxs-lookup"><span data-stu-id="c31e1-178">**Note** If an SPN already exists, it must be deleted before it can be reregistered.</span></span> <span data-ttu-id="c31e1-179">É possível fazer isso usando o comando `setspn` juntamente com a opção `-D` .</span><span class="sxs-lookup"><span data-stu-id="c31e1-179">You do this by using the `setspn` command together with the `-D` switch.</span></span> <span data-ttu-id="c31e1-180">Os exemplos a seguir ilustram como registrar manualmente um novo SPN com base em instância.</span><span class="sxs-lookup"><span data-stu-id="c31e1-180">The following examples illustrate how to manually register a new instance-based SPN.</span></span> <span data-ttu-id="c31e1-181">Para uma instância padrão, use:</span><span class="sxs-lookup"><span data-stu-id="c31e1-181">For a default instance, use:</span></span>  
  
```  
setspn -A MSSQLSvc/myhost.redmond.microsoft.com accountname  
```  
  
 <span data-ttu-id="c31e1-182">Para uma instância nomeada, use:</span><span class="sxs-lookup"><span data-stu-id="c31e1-182">For a named instance, use:</span></span>  
  
```  
setspn -A MSSQLSvc/myhost.redmond.microsoft.com:instancename accountname  
```  
  
##  <a name="client-connections"></a><a name="Client"></a> <span data-ttu-id="c31e1-183">Conexões cliente</span><span class="sxs-lookup"><span data-stu-id="c31e1-183">Client Connections</span></span>  
 <span data-ttu-id="c31e1-184">Há suporte para SPNs especificados pelo usuário nos drivers cliente.</span><span class="sxs-lookup"><span data-stu-id="c31e1-184">User-specified SPNs are supported in client drivers.</span></span> <span data-ttu-id="c31e1-185">Entretanto, se um SPN não for fornecido, será gerado automaticamente com base no tipo de conexão cliente.</span><span class="sxs-lookup"><span data-stu-id="c31e1-185">However, if an SPN is not provided, it will be generated automatically based on the type of a client connection.</span></span> <span data-ttu-id="c31e1-186">Para uma conexão TCP, um SPN no formato *MSSQLSvc*/*FQDN*:[*port*] é usado tanto para instâncias nomeadas quanto para instâncias padrão.</span><span class="sxs-lookup"><span data-stu-id="c31e1-186">For a TCP connection, an SPN in the format *MSSQLSvc*/*FQDN*:[*port*] is used for both the named and default instances.</span></span>  
  
 <span data-ttu-id="c31e1-187">Para pipes nomeados e conexões de memória compartilhada, um SPN no formato *MSSQLSvc* / *FQDN*:*InstanceName* é usado para uma instância nomeada e o FQDN de *MSSQLSvc* / *FQDN* é usado para a instância padrão.</span><span class="sxs-lookup"><span data-stu-id="c31e1-187">For named pipes and shared memory connections, an SPN in the format *MSSQLSvc*/*FQDN*:*instancename* is used for a named instance and *MSSQLSvc*/*FQDN* is used for the default instance.</span></span>  
  
 <span data-ttu-id="c31e1-188">**Usando uma conta de serviço como um SPN**</span><span class="sxs-lookup"><span data-stu-id="c31e1-188">**Using a service account as an SPN**</span></span>  
  
 <span data-ttu-id="c31e1-189">Contas de serviço podem ser usadas como um SPN.</span><span class="sxs-lookup"><span data-stu-id="c31e1-189">Service accounts can be used as an SPN.</span></span> <span data-ttu-id="c31e1-190">Elas são especificadas pelo atributo de conexão para autenticação de Kerberos e têm os seguintes formatos:</span><span class="sxs-lookup"><span data-stu-id="c31e1-190">They are specified through the connection attribute for the Kerberos authentication and take the following formats:</span></span>  
  
-   <span data-ttu-id="c31e1-191">**username@domain**ou **domínio \ nomedeusuário** para uma conta de usuário de domínio</span><span class="sxs-lookup"><span data-stu-id="c31e1-191">**username@domain** or **domain\username** for a domain user account</span></span>  
  
-   <span data-ttu-id="c31e1-192">**machine$@domain** ou **host\FQDN** de uma conta de domínio de computador, como Sistema Local ou SERVIÇOS DE REDE.</span><span class="sxs-lookup"><span data-stu-id="c31e1-192">**machine$@domain** or **host\FQDN** for a computer domain account such as Local System or NETWORK SERVICES.</span></span>  
  
 <span data-ttu-id="c31e1-193">Para determinar o método de autenticação de uma conexão, execute a seguinte consulta.</span><span class="sxs-lookup"><span data-stu-id="c31e1-193">To determine the authentication method of a connection, execute the following query.</span></span>  
  
```sql  
SELECT net_transport, auth_scheme   
FROM sys.dm_exec_connections   
WHERE session_id = @@SPID;  
```  
  
##  <a name="authentication-defaults"></a><a name="Defaults"></a> <span data-ttu-id="c31e1-194">Padrões de autenticação</span><span class="sxs-lookup"><span data-stu-id="c31e1-194">Authentication Defaults</span></span>  
 <span data-ttu-id="c31e1-195">A tabela a seguir descreve os padrões de autenticação usados com base em cenários de registro de SPN.</span><span class="sxs-lookup"><span data-stu-id="c31e1-195">The following table describes the authentication defaults that are used based on SPN registration scenarios.</span></span>  
  
|<span data-ttu-id="c31e1-196">Cenário</span><span class="sxs-lookup"><span data-stu-id="c31e1-196">Scenario</span></span>|<span data-ttu-id="c31e1-197">Método de autenticação</span><span class="sxs-lookup"><span data-stu-id="c31e1-197">Authentication method</span></span>|  
|--------------|---------------------------|  
|<span data-ttu-id="c31e1-198">O SPN faz o mapeamento para a conta de domínio correta, conta virtual, MSA ou conta interna.</span><span class="sxs-lookup"><span data-stu-id="c31e1-198">The SPN maps to the correct domain account, virtual account, MSA, or built-in account.</span></span> <span data-ttu-id="c31e1-199">Por exemplo, Sistema Local ou SERVIÇO DE REDE.</span><span class="sxs-lookup"><span data-stu-id="c31e1-199">For example, Local System or NETWORK SERVICE.</span></span><br /><br /> <span data-ttu-id="c31e1-200">Observação: correto significa que a conta mapeada pelo SPN registrado é a conta na qual o serviço de SQL Server está sendo executado.</span><span class="sxs-lookup"><span data-stu-id="c31e1-200">Note: Correct means that the account mapped by the registered SPN is the account that the SQL Server service is running under.</span></span>|<span data-ttu-id="c31e1-201">Conexões locais usam NTLM, conexões remotas usam Kerberos.</span><span class="sxs-lookup"><span data-stu-id="c31e1-201">Local connections use NTLM, remote connections use Kerberos.</span></span>|  
|<span data-ttu-id="c31e1-202">O SPN faz o mapeamento para a conta de domínio correta, conta virtual, MSA ou conta interna.</span><span class="sxs-lookup"><span data-stu-id="c31e1-202">The SPN is the correct domain account, virtual account, MSA, or built-in account.</span></span><br /><br /> <span data-ttu-id="c31e1-203">Observação: correto significa que a conta mapeada pelo SPN registrado é a conta na qual o serviço de SQL Server está sendo executado.</span><span class="sxs-lookup"><span data-stu-id="c31e1-203">Note: Correct means that the account mapped by the registered SPN is the account that the SQL Server service is running under.</span></span>|<span data-ttu-id="c31e1-204">Conexões locais usam NTLM, conexões remotas usam Kerberos.</span><span class="sxs-lookup"><span data-stu-id="c31e1-204">Local connections use NTLM, remote connections use Kerberos.</span></span>|  
|<span data-ttu-id="c31e1-205">O SPN faz o mapeamento para a conta de domínio incorreta, conta virtual, MSA ou conta interna.</span><span class="sxs-lookup"><span data-stu-id="c31e1-205">The SPN maps to an incorrect domain account, virtual account, MSA, or built-in account</span></span>|<span data-ttu-id="c31e1-206">A autenticação falha.</span><span class="sxs-lookup"><span data-stu-id="c31e1-206">Authentication fails.</span></span>|  
|<span data-ttu-id="c31e1-207">A pesquisa de SPN falha ou não faz o mapeamento para uma conta de domínio correta, conta virtual, MSA ou conta interna ou não é uma conta de domínio correta, conta virtual, MSA ou conta interna.</span><span class="sxs-lookup"><span data-stu-id="c31e1-207">The SPN lookup fails or does not map to a correct domain account, virtual account, MSA, or built-in account, or is not a correct domain account, virtual account, MSA, or built-in account.</span></span>|<span data-ttu-id="c31e1-208">Conexões locais e remotas usam NTLM.</span><span class="sxs-lookup"><span data-stu-id="c31e1-208">Local and remote connections use NTLM.</span></span>|  
  
##  <a name="comments"></a><a name="Comments"></a> <span data-ttu-id="c31e1-209">Comentários</span><span class="sxs-lookup"><span data-stu-id="c31e1-209">Comments</span></span>  
 <span data-ttu-id="c31e1-210">A DAC (Conexão de Administrador Dedicada) usa um SPN com base no nome da instância.</span><span class="sxs-lookup"><span data-stu-id="c31e1-210">The Dedicated Administrator Connection (DAC) uses an instance name based SPN.</span></span> <span data-ttu-id="c31e1-211">A autenticação Kerberos poderá ser usada com DAC se o SPN tiver sido registrado com êxito.</span><span class="sxs-lookup"><span data-stu-id="c31e1-211">Kerberos authentication can be used with a DAC if that SPN is registered successfully.</span></span> <span data-ttu-id="c31e1-212">Como alternativa, um usuário poderá especificar o nome de conta como um SPN.</span><span class="sxs-lookup"><span data-stu-id="c31e1-212">As an alternative a user can specify the account name as an SPN.</span></span>  
  
 <span data-ttu-id="c31e1-213">Se o registro de SPN falhar durante a inicialização, essa falha será registrada no log de erros do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] e a inicialização continuará.</span><span class="sxs-lookup"><span data-stu-id="c31e1-213">If SPN registration fails during startup, this failure is recorded in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log, and startup continues.</span></span>  
  
 <span data-ttu-id="c31e1-214">Se o cancelamento do SPN falhar durante o desligamento, essa falha será registrada no log de erros do [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] e o desligamento prosseguirá.</span><span class="sxs-lookup"><span data-stu-id="c31e1-214">If SPN de-registration fails during shutdown, this failure is recorded in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log, and shutdown continues.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="c31e1-215">Consulte Também</span><span class="sxs-lookup"><span data-stu-id="c31e1-215">See Also</span></span>  
 <span data-ttu-id="c31e1-216">[Suporte a SPN &#40;Nome da Entidade de Serviço&#41; em conexões com o cliente](../../relational-databases/native-client/features/service-principal-name-spn-support-in-client-connections.md) </span><span class="sxs-lookup"><span data-stu-id="c31e1-216">[Service Principal Name &#40;SPN&#41; Support in Client Connections](../../relational-databases/native-client/features/service-principal-name-spn-support-in-client-connections.md) </span></span>  
 <span data-ttu-id="c31e1-217">[SPNs &#40;Nomes da Entidade de Serviço&#41; em conexões de cliente &#40;OLE DB&#41;](../../relational-databases/native-client/ole-db/service-principal-names-spns-in-client-connections-ole-db.md) </span><span class="sxs-lookup"><span data-stu-id="c31e1-217">[Service Principal Names &#40;SPNs&#41; in Client Connections &#40;OLE DB&#41;](../../relational-databases/native-client/ole-db/service-principal-names-spns-in-client-connections-ole-db.md) </span></span>  
 <span data-ttu-id="c31e1-218">[SPNs &#40;Nomes da Entidade de Serviço&#41; em conexões de cliente &#40;ODBC&#41;](../../relational-databases/native-client/odbc/service-principal-names-spns-in-client-connections-odbc.md) </span><span class="sxs-lookup"><span data-stu-id="c31e1-218">[Service Principal Names &#40;SPNs&#41; in Client Connections &#40;ODBC&#41;](../../relational-databases/native-client/odbc/service-principal-names-spns-in-client-connections-odbc.md) </span></span>  
 <span data-ttu-id="c31e1-219">[Recursos do SQL Server Native Client](../../relational-databases/native-client/features/sql-server-native-client-features.md) </span><span class="sxs-lookup"><span data-stu-id="c31e1-219">[SQL Server Native Client Features](../../relational-databases/native-client/features/sql-server-native-client-features.md) </span></span>  
 [<span data-ttu-id="c31e1-220">Gerenciar problemas de autenticação Kerberos em um ambiente do Reporting Services</span><span class="sxs-lookup"><span data-stu-id="c31e1-220">Manage Kerberos Authentication Issues in a Reporting Services Environment</span></span>](https://technet.microsoft.com/library/ff679930.aspx)  
  
  
